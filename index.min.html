<!DOCTYPE html><html lang="en" translate="no"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="google" content="notranslate"><title>Simplos</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script><script src="https://unpkg.com/@supabase/supabase-js@2.39.7"></script><script src="vocabs.js"></script><style>:root{--primary-dark:#1a1a2e;--primary:#16213e;--secondary:#0f3460;--accent:#1E90FF;--text:#ffffff;--gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32;--success:#4CAF50;--error:#f44336;--gradient:linear-gradient(135deg, var(--secondary), var(--primary-dark));--glass:rgba(255, 255, 255, 0.1);--locked:#808080;--royal-gradient:linear-gradient(135deg, var(--gold), var(--accent));--blue-gradient:linear-gradient(135deg, var(--secondary), var(--accent));--gold-gradient:linear-gradient(135deg, var(--gold), #ffa500)}*{-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;touch-action:manipulation}body,html{overscroll-behavior-y:contain;overflow-x:hidden;max-width:100%;position:relative}.screen{transition:opacity .3s ease-in-out;opacity:0}.screen.visible{opacity:1}.auth-modal-content{background:var(--glass);border:1px solid var(--accent)}.side-panel{background:linear-gradient(135deg,rgba(22,33,62,.95),rgba(15,52,96,.95))}.user-profile-section{background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(30,144,255,.05));border:1px solid rgba(30,144,255,.1)}.status-badge.premium{background:var(--royal-gradient)}.status-badge.pending{background:var(--blue-gradient)}*{margin:0;padding:0;box-sizing:border-box;font-family:Montserrat,sans-serif}body{margin:0;padding:0;min-height:100vh;background:var(--gradient);color:var(--text);overflow-x:hidden}.screen{display:none;min-height:100vh;padding:2rem;position:absolute;top:0;left:0;width:100%;background:radial-gradient(circle at center,var(--secondary) 0,var(--primary-dark) 100%)}.screen.visible{display:flex;flex-direction:column;align-items:center;justify-content:center;animation:fadeIn .5s ease-in-out}.welcome-title{font-size:4rem;font-weight:700;margin-bottom:2rem;background:linear-gradient(to right,var(--gold),var(--accent));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 2px 10px rgba(0,0,0,.2);animation:shimmer 2s infinite;font-size:2.5rem;margin-bottom:1.5rem}@keyframes shareGlow{0%{box-shadow:0 0 5px var(--accent)}50%{box-shadow:0 0 20px var(--accent)}100%{box-shadow:0 0 5px var(--accent)}}.shared-list{animation:shareGlow 2s ease-in-out;border:2px solid transparent;background:linear-gradient(135deg,#00f2fe,#4facfe);background-clip:padding-box}.share-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--glass);backdrop-filter:blur(10px);padding:2rem;border-radius:20px;z-index:1000;width:90%;max-width:500px;animation:fadeIn .3s ease;border:1px solid rgba(255,255,255,.1);box-shadow:0 10px 30px rgba(0,0,0,.3)}.share-modal-header{color:var(--gold);margin-bottom:1.5rem;font-size:1.5rem;text-align:center}.share-modal-description{margin-bottom:1.5rem;opacity:.8;text-align:center}.users-list{max-height:300px;overflow-y:auto;margin:1rem 0}.users-list::-webkit-scrollbar{width:5px}.users-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:5px}.user-item{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;margin:.5rem 0;background:rgba(255,255,255,.1);border-radius:10px;transition:all .3s ease}.user-item:hover{background:rgba(255,255,255,.15);transform:translateY(-2px)}.user-info{display:flex;align-items:center;gap:.75rem}.user-info i{color:var(--gold);opacity:.8}.fade-out{opacity:0;transition:opacity .3s ease}@keyframes fadeIn{from{opacity:0;transform:translate(-50%,-55%)}to{opacity:1;transform:translate(-50%,-50%)}}@media (max-width:768px){.user-item{flex-direction:column;align-items:flex-start;gap:.75rem}.user-item .main-button{width:100%}}.upgrade-modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(5px);z-index:1000}.upgrade-form{width:100%;max-width:500px;padding:2rem;background:var(--glass);backdrop-filter:blur(10px);border-radius:20px;border:1px solid rgba(255,255,255,.1);text-align:right;direction:rtl}.upgrade-form h2{font-size:1.5rem;font-weight:700;text-align:center;margin-bottom:1.5rem;background:linear-gradient(to right,var(--gold),var(--accent));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.form-group{margin-bottom:1rem}.form-group label{display:block;margin-bottom:.5rem;color:var(--text)}.form-group input[type=tel],.form-group select{width:100%;padding:.75rem;border-radius:25px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--text)}.form-group input[type=checkbox]{margin-right:.5rem}.submit-button{width:100%;padding:1rem;border:2px solid var(--accent);background:0 0;color:var(--text);border-radius:25px;font-weight:700;cursor:pointer;transition:all .3s ease;margin-top:1rem}.submit-button:hover{box-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}.upgrade-form p{text-align:center;color:var(--text);margin-top:1rem;font-size:.9rem;opacity:.8}.auth-container{position:fixed;top:20%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.3);backdrop-filter:blur(10px);padding:1rem 2rem;border-radius:1rem;display:flex;gap:1rem;align-items:center;z-index:100;width:90%;max-width:320px}.auth-input:focus{border-color:var(--accent)}.auth-button:hover{background:rgba(233,69,96,.1)}@keyframes pulse-glow{0%,100%{box-shadow:0 0 10px var(--accent),0 0 5px var(--accent);transform:translate(-50%,-50%) scale(1.02)}50%{box-shadow:0 0 20px var(--accent),0 0 10px var(--accent);transform:translate(-50%,-50%) scale(1.05)}}.auth-container.highlight{animation:pulse-glow 1.5s ease-in-out infinite;background:rgba(233,69,96,.1)}.auth-toggle{color:rgba(255,255,255,.6);font-size:.85rem;background:0 0;border:none;cursor:pointer;transition:color .3s ease}.auth-toggle:hover{color:var(--text)}.user-info{position:fixed;top:2rem;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.5rem;z-index:100}#userEmail{font-size:1.5rem;color:var(--gold);margin-bottom:.5rem}.student-mode{color:var(--text);font-size:1rem;opacity:.8;display:block}@media (max-width:768px){.auth-container{flex-direction:column;padding:1rem;width:90%;max-width:320px}.auth-input{width:100%}}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8)}.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--glass);padding:2rem;border-radius:20px;backdrop-filter:blur(10px);text-align:center}#otpInput{padding:1rem;margin:1rem 0;background:rgba(255,255,255,.1);border:none;border-radius:10px;color:#fff;font-size:1.2rem;text-align:center}.leaderboard-entry .name{color:var(--gold)}.leaderboard-entry .words{color:var(--accent)}.leaderboard-entry .coins{color:var(--text)}.stage-selector{margin:2rem 0;text-align:left;width:100%}.stage-checkboxes{display:flex;flex-wrap:wrap;gap:1.5rem;margin:1rem 0;justify-content:center}.stage-checkboxes label{display:flex;align-items:center;gap:.75rem;cursor:pointer;font-size:1.2rem;padding:1rem;background:rgba(255,255,255,.1);border-radius:15px;transition:all .3s ease}.stage-checkboxes label:hover{background:rgba(255,255,255,.2)}.stage-checkboxes input[type=checkbox]{width:24px;height:24px;cursor:pointer}.word-goal{margin:2rem 0;text-align:center}#wordGoal{padding:.75rem;border-radius:10px;background:rgba(255,255,255,.1);color:var(--text);border:1px solid rgba(255,255,255,.2);width:120px;font-size:1.1rem;text-align:center}.navigation-button.initialize-button{background:var(--accent);color:var(--text)}.navigation-button.initialize-button:hover{filter:brightness(1.2)}.moderator .leaderboard-entry{cursor:pointer}.moderator-header{display:flex;flex-direction:column;align-items:center;gap:1rem;margin-bottom:2rem;padding:2rem;background:var(--glass);border-radius:20px;backdrop-filter:blur(10px)}.otp-display{font-size:3rem;color:var(--gold);text-shadow:0 0 10px rgba(255,215,0,.3);letter-spacing:.5rem;margin:1rem 0;font-weight:700}.join-game-button{position:relative;padding:.875rem 2rem;border:2px solid var(--accent);background:0 0;color:var(--text);border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease;margin-top:2rem;animation:pulseGlow 1.5s ease-in-out infinite}@keyframes pulseGlow{0%,100%{box-shadow:0 0 10px var(--accent),0 0 5px var(--accent);transform:scale(1.02)}50%{box-shadow:0 0 20px var(--accent),0 0 10px var(--accent);transform:scale(1.05)}}.game-controls{display:flex;gap:1rem;margin:1rem 0}.end-arcade-button{background:var(--error);color:var(--text);border:none;padding:1rem 2rem;border-radius:50px;font-size:1.2rem;cursor:pointer;transition:all .3s ease;display:none}.end-arcade-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(244,67,54,.4)}.end-arcade-button.visible{display:block;animation:fadeIn .3s ease-in-out}.leaderboard-entry{display:grid;grid-template-columns:1fr 3fr 1fr 1fr;align-items:center;padding:1rem;margin-bottom:.5rem;background:rgba(255,255,255,.05);border-radius:10px;transition:all .3s ease;position:relative}.leaderboard-entry>div{text-align:center;display:flex;align-items:center;justify-content:center}.leaderboard-entry div[data-username]{font-weight:600}.leaderboard-entry div[data-coins],.leaderboard-entry div[data-words]{justify-content:center;transition:color .3s ease}.leaderboard-header{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;padding:1rem;background:rgba(255,255,255,.1);border-radius:10px;margin-bottom:1rem;font-weight:700;text-align:center}.leaderboard-header>div{text-align:center}.leaderboard-entry.waiting .player-name{grid-column:2}.player-status-waiting{grid-column:3/span 2;display:flex;justify-content:center;width:100%}.player-status-waiting .status-text{background:rgba(30,144,255,.1);color:var(--accent);padding:.375rem 1rem;border-radius:12px;font-size:1.2rem;text-transform:uppercase;letter-spacing:1px;text-align:center}.waiting-indicator{position:absolute;right:50px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:9px}.waiting-indicator .dot{width:6px;height:6px;background-color:var(--accent);border-radius:50%;opacity:.7}.waiting-indicator .dot:first-child{animation:dotPulse 1.4s infinite ease-in-out}.waiting-indicator .dot:nth-child(2){animation:dotPulse 1.4s infinite ease-in-out .2s}.waiting-indicator .dot:nth-child(3){animation:dotPulse 1.4s infinite ease-in-out .4s}@keyframes dotPulse{0%,100%,60%{transform:scale(1);opacity:.7}30%{transform:scale(1.5);opacity:1}}.completion-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}.completion-content{background:var(--glass);backdrop-filter:blur(10px);padding:2rem;border-radius:20px;text-align:center}.completion-content h2{color:var(--gold);margin-bottom:1.5rem}.arcade-progress{position:fixed;top:1rem;left:50%;transform:translateX(-50%);background:var(--glass);padding:.5rem 1rem;border-radius:15px;backdrop-filter:blur(5px)}.leaderboard-entry.moving-up{background:rgba(76,175,80,.08);animation:moveUp .8s ease-in-out forwards;z-index:2}.leaderboard-entry.moving-down{background:rgba(244,67,54,.08);animation:moveDown .8s ease-in-out forwards;z-index:1}@keyframes moveUp{0%{transform:translateY(65px)}100%{transform:translateY(0)}}@keyframes moveDown{0%{transform:translateY(-65px)}100%{transform:translateY(0)}}.moderator-container{display:flex;height:100vh;width:100%}.session-info-panel{width:25%;background:var(--glass);padding:2rem;display:flex;flex-direction:column;justify-content:flex-start;backdrop-filter:blur(10px);border-right:1px solid rgba(255,255,255,.1)}.session-details{text-align:center}.session-details h2{color:var(--gold);margin-bottom:1.5rem}.otp-display{font-size:3rem;color:var(--gold);margin:1rem 0;text-shadow:0 0 10px rgba(255,215,0,.3)}.session-metadata{background:rgba(255,255,255,.05);border-radius:10px;padding:1rem;margin:1rem 0;text-align:left}.session-metadata p{margin:.5rem 0;color:var(--text);opacity:.8}.leaderboard-panel{width:75%;overflow-y:auto;background:var(--primary-dark)}.moderator-leaderboard .leaderboard-entry{display:grid;grid-template-columns:0.5fr 2fr 1fr 1fr 1fr;padding:1.5rem;margin:.5rem;background:var(--glass);border-radius:15px;font-size:1.2rem;align-items:center;transition:all .3s ease}.moderator-leaderboard .leaderboard-entry .player-actions{display:flex;gap:.5rem}.moderator-leaderboard .leaderboard-entry .player-actions button{padding:.5rem;border-radius:5px;background:var(--accent);color:#fff;border:none;cursor:pointer}@media (max-width:768px){.moderator-container{flex-direction:column}.leaderboard-panel,.session-info-panel{width:100%}}.arcade-completion-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity .3s ease}.arcade-completion-modal.show{opacity:1}.completion-modal-content{background:var(--glass);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;max-width:500px;width:90%;text-align:center;transform:scale(.7);transition:transform .3s cubic-bezier(.175, .885, .32, 1.275)}.arcade-completion-modal.show .completion-modal-content{transform:scale(1)}.completion-stats{display:flex;justify-content:space-around;margin:2rem 0}.stat-item{display:flex;flex-direction:column;align-items:center}.stat-item i{font-size:2rem;color:var(--gold);margin-bottom:.5rem}.stat-item strong{font-size:1.5rem;color:var(--gold)}.leaderboard-preview{margin:2rem 0;background:rgba(255,255,255,.1);border-radius:15px;padding:1rem}.podium-player{display:flex;justify-content:space-between;padding:.5rem;margin:.5rem 0;background:rgba(255,255,255,.05);border-radius:10px}.podium-player.rank-1{background:linear-gradient(135deg,var(--gold),gold);color:var(--primary-dark)}.podium-player.rank-2{background:linear-gradient(135deg,silver,#a0a0a0);color:var(--primary-dark)}.podium-player.rank-3{background:linear-gradient(135deg,#cd7f32,#b87333);color:var(--primary-dark)}.download-app-button{opacity:.7;font-size:.9rem;margin-top:.5rem}.auth-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all .3s ease}.auth-modal.show{opacity:1;visibility:visible}.auth-modal-content{background:var(--glass);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;width:90%;max-width:400px;transform:scale(.9);transition:transform .3s ease}.auth-modal.show .auth-modal-content{transform:scale(1)}.auth-form{display:flex;flex-direction:column;gap:1rem}.auth-input{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:25px;padding:.75rem 1rem;color:var(--text);width:100%}.auth-input:focus{outline:0;border-color:var(--accent)}.auth-button{background:var(--accent);color:var(--text);border:none;border-radius:25px;padding:.75rem;cursor:pointer;transition:all .3s ease}.auth-toggle{background:0 0;border:none;color:var(--text);opacity:.7;cursor:pointer;transition:opacity .3s ease}.auth-toggle:hover{opacity:1}.hidden{display:none}.side-panel{position:fixed;top:0;right:-100%;width:320px;height:100vh;background:rgba(0,0,0,.85);backdrop-filter:blur(10px);padding:2rem 1.5rem;transition:right .3s cubic-bezier(.4, 0, .2, 1);z-index:1000;display:flex;flex-direction:column;box-shadow:-5px 0 20px rgba(0,0,0,.3)}.side-panel.open{right:0}.side-panel .welcome-buttons{display:flex;flex-direction:column;margin-top:1rem;gap:.5rem;align-items:stretch}.side-panel .nav-link{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;transition:all .3s ease;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;justify-content:flex-start;text-align:left;color:var(--text);text-decoration:none;background:0 0;border-radius:10px;cursor:pointer;opacity:.8}.side-panel .nav-link:hover{background:rgba(255,255,255,.1);opacity:1;transform:translateX(5px)}.side-panel .nav-link i{color:var(--gold);margin-right:.5rem;opacity:.7;transition:all .3s ease}.side-panel .nav-link:hover i{opacity:1;color:var(--accent)}.side-panel .nav-link:hover{opacity:1;color:var(--gold);transform:translateX(10px)}.side-panel .nav-link i{min-width:20px;text-align:center;opacity:.7}.nav-link{display:flex;align-items:center;gap:.75rem;padding:.875rem 1rem;transition:all .3s ease;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;justify-content:flex-start;text-align:left;color:var(--text);text-decoration:none;background:0 0;border-radius:10px;cursor:pointer;opacity:.8}.side-panel .logout-top-button{display:flex;align-items:center;padding:.875rem 1rem;text-align:center;color:var(--text);background:0 0;border-radius:10px;cursor:pointer;opacity:.8}.side-panel .logout-top-button i{min-width:20px;text-align:center;color:#bbff10;opacity:1}.side-panel .logout-top-button:hover i{opacity:1}.side-panel-content{display:flex;flex-direction:column;height:100%;align-items:center}.user-profile-bottom{margin-top:auto;padding:1rem;border-top:1px solid rgba(255,255,255,.1)}.user-profile-section{margin-top:3rem;text-align:center;padding:1.5rem;background:linear-gradient(135deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border-radius:15px;border:1px solid rgba(255,255,255,.1)}.username-display{font-size:1.4rem;color:var(--gold);margin-bottom:.5rem;font-weight:600;text-shadow:0 2px 4px rgba(0,0,0,.3)}.status-badge{display:inline-block;padding:.4rem 1.2rem;border-radius:50px;font-size:.9rem;font-weight:500;margin-top:.5rem;text-transform:uppercase;letter-spacing:1px}.status-badge.premium{background:linear-gradient(135deg,gold,orange);color:#000;box-shadow:0 2px 10px rgba(255,215,0,.3)}.status-badge.pending{background:linear-gradient(135deg,#00bcd4,#03a9f4);color:#fff;animation:pendingPulse 2s infinite}.status-badge.trial{background:linear-gradient(135deg,#9c27b0,#673ab7);color:#fff}@media (max-width:768px){.side-panel{width:85%;padding:1.5rem 1rem}.hamburger-button.open{right:87%}.main-buttons{padding:0 1rem}}@media (max-width:360px){.side-panel{width:90%;padding:1.25rem .75rem}}.user-stats{margin-top:2rem;display:flex;justify-content:space-around;padding:1rem 0;border-top:1px solid rgba(255,255,255,.1);border-bottom:1px solid rgba(255,255,255,.1)}.stat-item{text-align:center}.stat-value{font-size:1.2rem;color:var(--text);font-weight:600;display:flex;align-items:center;gap:.5rem}.game-notification{position:fixed;top:15%;left:50%;transform:translate(-50%,-50%) scale(0);background:var(--glass);padding:1rem 2rem;border-radius:25px;color:var(--text);backdrop-filter:blur(10px);z-index:1000;opacity:0;transition:all .3s cubic-bezier(.4, 0, .2, 1);text-align:center;min-width:200px}.game-notification.blessing{border:2px solid #3498db}.game-notification.curse{border:2px solid #e74c3c}.game-notification.show{transform:translate(-50%,-50%) scale(1);opacity:1}.particle{position:fixed;pointer-events:none;z-index:1000}.particle.blessing{background:#3498db}.particle.curse{background:#e74c3c}.coin-icon{color:var(--gold)}.hamburger-button{position:fixed;top:1rem;right:1rem;width:50px;height:50px;border-radius:50%;background:var(--glass);border:1px solid rgba(255,255,255,.1);cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);transition:all .3s cubic-bezier(.4, 0, .2, 1);z-index:1001}.hamburger-button:hover{transform:scale(1.1);background:rgba(255,255,255,.15)}.hamburger-button.open{right:290px}.hamburger-button i{color:var(--text);font-size:1.25rem;transition:transform .3s ease}.hamburger-button.open i{transform:rotate(90deg)}.main-buttons{display:flex;flex-direction:column;align-items:center;gap:1.25rem;width:100%;max-width:260px;margin:0 auto}.main-button{position:relative;padding:.875rem 2rem;background:0 0;color:var(--text);border:none;border-radius:12px;font-size:1rem;font-weight:500;cursor:pointer;transition:all .3s ease;width:100%;overflow:hidden;background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));backdrop-filter:blur(5px);text-transform:uppercase;letter-spacing:1px}.main-button::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--accent),#ff6b6b);opacity:0;transition:opacity .3s ease;border-radius:inherit;z-index:-1}.main-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(233,69,96,.2)}.main-button:hover::before{opacity:1}@media (max-width:768px){.side-panel{width:85%;padding:1.5rem 1rem}.hamburger-button.open{right:87%}.main-buttons{padding:0 1rem}}@media (max-width:360px){.side-panel{width:90%;padding:1.25rem .75rem}}.leaderboard-entry div[data-coins],.leaderboard-entry div[data-words]{transition:color .3s ease}.leaderboard-entry.moving-up{animation:moveUp .8s ease-in-out forwards;z-index:2}.leaderboard-entry.moving-down{animation:moveDown .8s ease-in-out forwards;z-index:1}@keyframes moveUp{0%{transform:translateY(65px)}100%{transform:translateY(0)}}@keyframes moveDown{0%{transform:translateY(-65px)}100%{transform:translateY(0)}}.arcade-join-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}.arcade-join-modal .modal-content{background:var(--glass);backdrop-filter:blur(10px);padding:2rem;border-radius:20px;width:100%;max-width:400px;text-align:center;position:relative;display:flex;flex-direction:column;gap:1rem}#player-view{width:100%;display:flex;flex-direction:column;align-items:center;gap:1rem}#player-view h2{font-size:1.5rem;margin-bottom:1rem;text-align:center;color:var(--gold)}.input-group{width:100%;margin:0;display:flex;flex-direction:column;gap:1rem}#otpInput,.input-group input{width:100%;padding:1rem;font-size:1rem;background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:15px;color:var(--text);text-align:center;transition:all .3s ease;outline:0}#otpInput:focus,.input-group input:focus{border-color:var(--accent);box-shadow:0 0 15px rgba(233,69,96,.2)}#arcadeUsername{margin-bottom:.5rem}#otpInput{margin:0;letter-spacing:.2em}.join-button{width:100%;padding:1rem;border:none;border-radius:25px;background:var(--accent);color:var(--text);font-size:1rem;cursor:pointer;transition:all .3s ease;margin-top:1rem}.join-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(233,69,96,.4)}@media (max-width:768px){.arcade-join-modal{padding:.5rem}.arcade-join-modal .modal-content{padding:1.5rem;max-width:350px}#player-view h2{font-size:1.3rem;margin-bottom:.75rem}#otpInput,.input-group input{font-size:.95rem;padding:.875rem;min-width:250px;width:100%}#arcadeUsername{font-size:1rem;letter-spacing:-.5px}.join-button{font-size:.95rem;padding:.875rem}}@media (max-width:480px){#otpInput,.input-group input{min-width:220px;font-size:.9rem}#arcadeUsername{font-size:.95rem}}.powerups-container{display:flex;gap:.5rem;padding:5px;justify-content:center;width:100%;margin-bottom:1rem}.powerup-card{position:relative;width:calc(33% - 10px);max-width:100px;height:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:5px;border-radius:8px;text-align:center;font-size:.8em;transition:transform .2s ease}.powerup-card.goodie{border:2px solid #3498db;box-shadow:0 0 15px rgba(52,152,219,.3)}.powerup-card.baddie{border:2px solid #e74c3c;box-shadow:0 0 15px rgba(231,76,60,.3)}.powerup-card:hover{transform:translateY(-2px)}.powerup-icon{font-size:1.5rem;color:var(--text)}.powerup-name{font-size:.8rem;text-align:center;margin:.25rem 0;font-weight:700}.powerup-cost{position:absolute;top:-8px;right:-8px;background:var(--gold);color:var(--primary-dark);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;border:2px solid var(--primary-dark);box-shadow:0 2px 4px rgba(0,0,0,.2)}.powerup-card:disabled{opacity:.5;cursor:not-allowed}@media (max-width:768px){.powerup-card{width:calc(33% - 10px);height:90px;font-size:.7em}.powerup-icon{font-size:1.2rem}.powerup-name{font-size:.7rem;margin:.2rem 0}.powerup-cost{width:20px;height:20px;font-size:.65rem}}.qr-section{background:#fff;padding:1rem;border-radius:15px;margin:1rem 0;display:flex;flex-direction:column;align-items:center;gap:.5rem}.qr-section canvas{width:200px;height:200px}.qr-hint{color:var(--primary-dark);font-size:.9rem;font-weight:600}@media (max-width:768px){.qr-section canvas{width:150px;height:150px}}@media (max-width:768px){.arcade-join-modal{padding:.5rem}.arcade-join-modal .modal-content{padding:1.5rem;max-width:350px}#player-view h2{font-size:1.3rem;margin-bottom:.75rem}#otpInput,.input-group input{font-size:.95rem;padding:.875rem;min-width:250px;width:100%}#arcadeUsername{font-size:1rem;letter-spacing:-.5px}.join-button{font-size:.95rem;padding:.875rem}}@media (max-width:480px){#otpInput,.input-group input{min-width:220px;font-size:.9rem}#arcadeUsername{font-size:.95rem}}#qr-landing{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:var(--gradient);text-align:center;padding:2rem}.qr-landing-content{background:var(--glass);backdrop-filter:blur(10px);padding:2rem;border-radius:20px;width:90%;max-width:400px}.qr-landing-content h2{color:var(--gold);margin-bottom:1.5rem}.game-code-display{font-size:2.5rem;color:var(--text);font-weight:700;padding:1rem;margin:1rem 0;background:rgba(255,255,255,.1);border-radius:15px;letter-spacing:.2em}#qr-landing .join-game-button{width:100%;padding:1rem;margin-top:1.5rem;font-size:1.2rem;animation:pulseGlow 1.5s ease-in-out infinite}.waiting-container{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;position:relative;overflow:hidden}.spinner-container{position:relative;width:100px;height:100px;margin-bottom:2rem}.spinner{position:absolute;width:100%;height:100%;border:4px solid rgba(255,255,255,.1);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite}.waiting-title{font-size:2rem;color:var(--gold);margin-bottom:1rem;text-shadow:0 2px 10px rgba(255,215,0,.3)}.player-count{font-size:1.2rem;color:var(--text);opacity:.8}@keyframes spin{to{transform:rotate(360deg)}}.floating-particles{position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none}.floating-particle{position:absolute;width:10px;height:10px;background:var(--gold);border-radius:50%;opacity:.3;animation:float 3s infinite ease-in-out}.slide-transition{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none;display:flex;justify-content:center;align-items:center;background:0 0}.slide-panel-left,.slide-panel-right{position:absolute;width:50%;height:100%;background:linear-gradient(135deg,var(--primary-dark),var(--secondary));transition:transform .4s cubic-bezier(.4, 0, .2, 1);border:1px solid rgba(255,255,255,.1)}.slide-panel-left{left:0;transform:translateX(-100%);border-right:2px solid var(--gold)}.slide-panel-right{right:0;transform:translateX(100%);border-left:2px solid var(--gold)}.slide-transition.show .slide-panel-left{transform:translateX(0);box-shadow:5px 0 15px rgba(0,0,0,.3)}.slide-transition.show .slide-panel-right{transform:translateX(0);box-shadow:-5px 0 15px rgba(0,0,0,.3)}.level-announcement{position:absolute;z-index:10000;color:var(--text);text-align:center;opacity:0;transition:all .4s cubic-bezier(.4, 0, .2, 1);transform:scale(.9);background:rgba(0,0,0,.3);padding:2rem 3rem;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1);box-shadow:0 10px 30px rgba(0,0,0,.3)}.level-announcement.show{opacity:1;transform:scale(1)}.level-announcement h1{font-size:2.5rem;background:linear-gradient(to right,var(--gold),orange);-webkit-background-clip:text;background-clip:text;color:transparent;margin-bottom:1rem;position:relative;text-transform:uppercase;letter-spacing:2px;font-weight:700}.level-announcement h1::after{content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);width:50px;height:2px;background:var(--gold);box-shadow:0 0 10px var(--gold)}.level-announcement h2{font-size:2rem;color:var(--text);font-weight:500;opacity:.9;letter-spacing:1px}.slide-panel-left::after,.slide-panel-right::after{content:'';position:absolute;top:0;width:2px;height:100%;background:linear-gradient(to bottom,transparent,var(--gold),transparent);opacity:.5}.slide-panel-left::after{right:0}.slide-panel-right::after{left:0}.level-announcement::before{content:'';position:absolute;bottom:10px;left:50%;transform:translateX(-50%);width:80%;height:1px;background:linear-gradient(to right,transparent,var(--gold),transparent);animation:lineWidth 2s ease-in-out infinite}@keyframes lineWidth{0%,100%{width:60%;opacity:.3}50%{width:80%;opacity:.7}}.leaderboard-entry{display:grid;grid-template-columns:1fr 5fr 3fr;align-items:center;padding:1rem;margin-bottom:.5rem;background:rgba(255,255,255,.05);border-radius:10px;transition:background-color .3s ease;position:relative}.leaderboard-entry>div:first-child{text-align:center;font-weight:700;color:var(--gold)}.leaderboard-entry>div:nth-child(2){text-align:center;font-weight:500}.leaderboard-entry div[data-coins],.leaderboard-entry div[data-words]{transition:color .3s ease}.leaderboard-entry.moving-up{background:rgba(76,175,80,.08);animation:moveUp .8s ease-in-out forwards;z-index:2}.leaderboard-entry.moving-down{background:rgba(244,67,54,.08);animation:moveDown .8s ease-in-out forwards;z-index:1}@keyframes moveUp{0%{transform:translateY(65px)}100%{transform:translateY(0)}}@keyframes moveDown{0%{transform:translateY(-65px)}100%{transform:translateY(0)}}.coins-header .coin-icon{color:var(--gold);font-size:1.5rem;filter:drop-shadow(0 0 5px rgba(255, 215, 0, .3))}.coins-header .coin-count{font-size:1.2rem;font-weight:700;color:var(--text)}.coin-count{transition:none}.coin-count.animating{transition:content 1s ease-out}.set-container,.stage-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem;width:100%;max-width:1200px;padding:2rem;z-index:1}.stage-name{font-size:1.2rem;margin-bottom:.5rem;color:var(--text);text-transform:uppercase;letter-spacing:1px;text-shadow:0 2px 4px rgba(0,0,0,.3)}.test-badge{background:rgba(255,255,255,.1);padding:.5rem 1rem;border-radius:15px;margin-top:1rem;font-size:.9rem;animation:pulse 2s infinite}@keyframes rotate{from{transform:translate(-50%,-50%) rotate(0)}to{transform:translate(-50%,-50%) rotate(360deg)}}@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}.level-announcement.test-level h1{color:#4facfe;text-shadow:0 0 10px rgba(79,172,254,.5)}.level-announcement.boss-level{background:linear-gradient(135deg,#ff416c 0,#ff4b2b 100%)}@keyframes switchDirection{0%,100%{transform:scaleX(1)}50%{transform:scaleX(-1)}}.boss-mode{background:linear-gradient(135deg,#1a1a2e 0,#16213e 100%);animation:pulseBg 4s infinite}.boss-word{color:gold;text-shadow:0 0 10px rgba(255,215,0,.5);animation:pulseWord 2s infinite}.boss-word.fading{animation:fadeWord 5s forwards}@keyframes pulseBg{0%,100%{filter:brightness(1)}50%{filter:brightness(1.2)}}@keyframes pulseWord{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}@keyframes fadeWord{0%{opacity:1}100%{opacity:.3}}.perk-disabled{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5em;color:red;pointer-events:none}.level-container{width:100%;max-width:1200px;padding:2rem;display:flex;flex-direction:column;gap:2rem}.level-header{background:var(--glass);backdrop-filter:blur(10px);border-radius:16px;padding:1.5rem;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.1)}.level-title-area{display:flex;align-items:center;gap:1.25rem}.set-icon{width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:1.75rem;background:linear-gradient(135deg,var(--accent),rgba(30,144,255,.7));border-radius:12px;box-shadow:0 5px 15px rgba(30,144,255,.3)}.set-details{display:flex;flex-direction:column;gap:.25rem}.set-name{font-size:1.4rem;font-weight:700;color:var(--text)}.set-desc{opacity:.8;font-size:.9rem}.set-progress{display:flex;align-items:center;gap:.5rem}.progress-bar{width:150px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}.progress-fill{height:100%;background:var(--gold);border-radius:3px;transition:width .3s ease}.progress-text{font-size:.9rem;opacity:.9}.level-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:1rem;background:var(--glass);backdrop-filter:blur(10px);border-radius:16px;padding:1.5rem;border:1px solid rgba(255,255,255,.1)}.level-item{aspect-ratio:1;position:relative;display:flex;align-items:center;justify-content:center;border-radius:12px;font-size:1.2rem;font-weight:600;cursor:pointer;transition:all .3s ease;color:var(--text);overflow:hidden}.level-item.unlocked{background:linear-gradient(135deg,var(--accent),rgba(30,144,255,.7));box-shadow:0 5px 15px rgba(30,144,255,.2)}.level-item.completed{background:linear-gradient(135deg,var(--success),#45b649);border:2px solid var(--gold);box-shadow:0 0 15px rgba(255,215,0,.3)}.level-item.perfect{background:linear-gradient(135deg,var(--gold),orange);box-shadow:0 0 20px rgba(255,215,0,.4)}.level-item.boss{background:linear-gradient(135deg,var(--gold),var(--accent));box-shadow:0 0 25px rgba(255,215,0,.5)}.level-item.locked{background:rgba(128,128,128,.2);cursor:not-allowed}.level-item.locked::before{content:'\f023';font-family:'Font Awesome 6 Free';font-weight:900;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5rem;color:rgba(255,255,255,.5);z-index:1}.level-item.test::after{content:'';position:absolute;top:0;right:0;width:0;height:0;border-style:solid;border-width:0 25px 25px 0;border-color:transparent var(--gold) transparent transparent}.level-item.unlocked:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(30,144,255,.3)}.level-item.completed:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(76,175,80,.3)}.level-item.perfect:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(255,215,0,.5)}.level-type-legend{display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem;justify-content:center}.legend-item{display:flex;align-items:center;gap:.5rem;font-size:.9rem}.legend-color{width:16px;height:16px;border-radius:4px}@media (max-width:768px){.level-header{flex-direction:column;align-items:flex-start;gap:1rem}.set-icon{width:48px;height:48px;font-size:1.4rem}.set-name{font-size:1.2rem}.level-grid{grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:.75rem;padding:1rem}.level-item{font-size:1rem}}@media (max-width:480px){.level-container{padding:1rem}.level-grid{grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:.5rem}.set-progress{flex-direction:column;align-items:flex-start}}.question-screen{display:flex;flex-direction:column;align-items:center;gap:1.5rem;height:100vh;padding:1rem 1rem 2rem;min-height:100vh;height:auto;justify-content:space-between;gap:.5rem;justify-content:space-between;padding:1rem 1rem 2rem;overflow:hidden}.question-word{font-size:4rem;font-weight:700;color:var(--gold);text-shadow:0 2px 10px rgba(255,215,0,.3);animation:float 3s ease-in-out infinite;margin:0;padding:1rem}.progress-circle{width:200px;height:200px;position:relative;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:1rem 0}.progress-circle svg{position:absolute;width:100%;height:100%;transform:rotate(-90deg)}.progress-circle circle{fill:none;stroke-linecap:round}.progress-circle .bg{stroke:rgba(255,255,255,0.1)}.progress-circle .progress{stroke:var(--gold);transition:stroke-dashoffset .5s ease}.progress-circle.completed{animation:pulseGrow .4s ease-in-out infinite}.progress-circle.completed circle.progress{animation:colorShift .4s ease-in-out infinite;transition:stroke .3s linear}@keyframes colorShift{0%,100%{stroke:var(--gold);filter:brightness(1.5)}50%{stroke:#1E90FF;filter:brightness(1.2)}}.progress-circle[data-progress=low] .progress{stroke:var(--gold)}.progress-circle[data-progress=medium] .progress{stroke:#FFA500}.progress-circle[data-progress=high] .progress{stroke:var(--success)}.progress-circle[data-progress=complete] .progress{stroke:#1E90FF}.completion-ripple{position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid var(--gold);animation:rippleOut 1s ease-out forwards}@keyframes rippleOut{0%{transform:scale(1);opacity:1}100%{transform:scale(1.5);opacity:0}}@keyframes pulseGrow{0%,100%{transform:scale(1);filter:brightness(1)}50%{transform:scale(1.05);filter:brightness(1.2)}}.failure-overlay .failure-content{display:flex;flex-direction:column;align-items:center;gap:2rem}.failure-overlay .restart-button{margin:0 auto}.failure-overlay .home-button{display:none}.game-notification{position:fixed;top:20px;left:20px;padding:1rem 2rem;border-radius:10px;color:var(--text);background:var(--glass);backdrop-filter:blur(10px);z-index:1100;transform:translateX(-100%);opacity:0;transition:all .3s ease}.game-notification.show{transform:translateX(0);opacity:1}.game-notification.success{border-left:4px solid var(--success)}.game-notification.error{border-left:4px solid var(--error)}.level.mixed{background:linear-gradient(135deg,var(--accent),var(--gold));position:relative;overflow:hidden}.level.mixed::before{content:'';position:absolute;inset:-50%;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.2) 50%,transparent 70%);animation:shimmerEffect 3s infinite linear}@keyframes shimmerEffect{0%{transform:translate(-100%,-100%) rotate(45deg)}100%{transform:translate(100%,100%) rotate(45deg)}}.list-actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem;width:100%;margin-bottom:1rem}.list-actions button{position:relative;padding:.75rem 1rem;background:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));color:var(--text);border:none;border-radius:12px;font-size:.9rem;font-weight:500;cursor:pointer;transition:all .3s ease;text-transform:uppercase;letter-spacing:1px;backdrop-filter:blur(5px);overflow:hidden}.list-actions button::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--accent),#ff6b6b);opacity:0;transition:opacity .3s ease;border-radius:inherit;z-index:-1}.list-actions button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(233,69,96,.2)}.list-actions button:hover::before{opacity:1}.start-button.share-with-user-btn{padding:.5rem 1rem;font-size:.8rem;background:var(--accent);color:var(--text);border:none;border-radius:20px;transition:all .3s ease;text-transform:uppercase;letter-spacing:.5px}.start-button.share-with-user-btn:hover{transform:translateY(-2px);filter:brightness(1.2);box-shadow:0 5px 15px rgba(233,69,96,.3)}.share-modal .start-button{margin-top:1rem;width:100%;padding:.8rem;font-size:1rem}@media (max-width:768px){.list-actions{grid-template-columns:1fr 1fr}.list-actions button{padding:.6rem .8rem;font-size:.8rem}}@media (max-width:480px){.list-actions{grid-template-columns:1fr}}.main-button.small-button{padding:.5rem 1rem;font-size:.85rem;min-width:0;width:auto}.list-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.75rem;width:100%;margin-bottom:1rem}.list-actions .main-button{width:100%;padding:.75rem 1rem;font-size:.9rem}.word-input-actions{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;justify-content:center}.word-input-actions .main-button{min-width:100px;width:auto;flex:1}.share-modal .modal-close{margin-top:1.5rem;width:100%}.user-item{display:flex;align-items:center;justify-content:space-between;padding:.75rem;margin:.5rem 0;background:rgba(255,255,255,.1);border-radius:10px;transition:all .3s ease}.user-item:hover{background:rgba(255,255,255,.15)}.user-item .main-button{width:auto;margin-left:1rem}@media (max-width:768px){.list-actions{grid-template-columns:repeat(auto-fit,minmax(120px,1fr))}.word-input-actions .main-button{padding:.7rem 1rem;font-size:.85rem}.user-item{flex-direction:column;align-items:stretch;gap:.75rem}.user-item .main-button{width:100%;margin-left:0}}@media (max-width:480px){.list-actions{grid-template-columns:1fr}.word-input-actions{flex-direction:column}.word-input-actions .main-button{width:100%}}.custom-list-dropdown{position:absolute;top:100%;left:0;width:100%;max-height:300px;overflow-y:auto;background:var(--glass);backdrop-filter:blur(10px);border-radius:15px;padding:1rem;margin-top:.5rem;z-index:1000;border:1px solid rgba(255,255,255,.1)}.selected-lists{margin:1rem 0}.list-item{display:flex;align-items:center;padding:.75rem;margin:.5rem 0;background:rgba(255,255,255,.1);border-radius:10px;cursor:pointer;transition:all .3s ease}.list-item:hover{background:rgba(255,255,255,.2);transform:translateY(-2px)}.perks-container{display:flex;gap:1rem;margin:1rem 0;background:var(--glass);padding:.75rem;border-radius:25px;backdrop-filter:blur(10px)}.perk-button{display:flex;flex-direction:column;align-items:center;gap:.25rem;padding:.5rem;border-radius:15px;cursor:pointer;transition:all .3s ease;background:rgba(255,255,255,.1);border:none;color:var(--text)}.perk-button:disabled{opacity:.5;cursor:not-allowed}.perk-button:not(:disabled):hover{background:rgba(255,255,255,.2);transform:translateY(-2px)}.perk-icon{font-size:1.5rem;color:var(--gold)}.perk-count{font-size:.8rem;font-weight:700}.timer-container{position:absolute;visibility:hidden;opacity:0;pointer-events:none;height:0;margin:0}.timer-value{font-size:0;padding:0}.timer-value.warning{color:var(--error);text-shadow:0 0 15px rgba(244,67,54,.5);animation:warningPulse 1s infinite}.buttons{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;max-width:800px;width:100%;margin:1rem auto;margin-bottom:0;padding:0 1rem}.buttons button{padding:1rem 2rem;font-size:1.2rem;font-weight:600;color:var(--primary);background:var(--text);border:none;border-radius:15px;cursor:pointer;transition:all .3s ease;box-shadow:0 5px 15px rgba(0,0,0,.1)}.buttons button:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,.2)}.buttons button.correct{background:var(--success);color:var(--text);animation:correctAnswer .5s ease}.buttons button.wrong{background:var(--error);color:var(--text);animation:wrongAnswer .5s ease}.failure-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;transition:background 1s ease;z-index:1000}.failure-overlay.show{background:rgba(0,0,0,.9)}.failure-content{text-align:center;transform:translateY(50px);opacity:0;transition:all 1s ease}.failure-overlay.show .failure-content{transform:translateY(0);opacity:1}.failure-title{font-size:3rem;color:var(--error);margin-bottom:2rem;text-shadow:0 2px 10px rgba(244,67,54,.3)}.failure-buttons{display:flex;gap:2rem;justify-content:center}.home-button,.restart-button{padding:1rem;width:80px;height:80px;font-size:2rem;color:var(--text);background:var(--accent);border:none;border-radius:50%;cursor:pointer;transition:all .3s ease;box-shadow:0 10px 20px rgba(233,69,96,.3)}.home-button:hover,.restart-button:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(233,69,96,.4)}.coins-container{position:absolute;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2}.coins-container .coin-icon{color:var(--gold);font-size:2rem;filter:drop-shadow(0 0 10px rgba(255, 215, 0, .5))}.coins-container .coin-count{font-size:1.2rem;font-weight:700;color:var(--text);text-shadow:0 2px 4px rgba(0,0,0,.5)}.coin-pulse{animation:coinPulse .5s ease-in-out 3}.skip-button{position:absolute;top:1rem;left:1rem;padding:.5rem 1rem;border:none;background:rgba(255,255,255,.1);color:var(--text);border-radius:20px;cursor:pointer;transition:all .3s ease}.skip-button:hover{background:rgba(255,255,255,.2)}.coins-header{position:fixed;top:2rem;right:2rem;display:flex;align-items:center;gap:.5rem;background:var(--glass);padding:.75rem 1.5rem;border-radius:25px;backdrop-filter:blur(10px);z-index:100}.user-tier{position:relative;top:2rem;display:flex;justify-content:center;align-items:center;z-index:100;min-width:200px;text-align:center;backdrop-filter:blur(10px);padding:0;border-radius:0}.user-info{position:fixed;top:2rem;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.5rem;z-index:100}#userEmail{font-size:1.5rem;color:var(--gold);margin-bottom:.5rem}.tier-text{font-weight:600;font-size:1.1rem}.tier-text.unregistered{color:#f44}.tier-text.trial{color:orange}.tier-text.pending{color:#00bfff;animation:pendingBlink 2s infinite}.tier-text.premium{color:#4caf50}@keyframes pendingBlink{0%,100%{opacity:.7}50%{opacity:1}}.upgrade-confirmation-modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;z-index:2000}.modal-backdrop{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5)}.confirmation-content{background:var(--glass);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;text-align:center;max-width:400px;z-index:2001}.confirmation-content h2{color:var(--gold);margin-bottom:1rem}.continue-button{margin-top:1rem;padding:.75rem 1.5rem;background:var(--accent);color:#fff;border:none;border-radius:25px;cursor:pointer;transition:background .3s ease}.continue-button:hover{background:color-mix(in srgb,var(--accent) 90%,#fff)}.confirmation-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.7);opacity:0;transition:all .3s cubic-bezier(.68, -.55, .265, 1.55);z-index:1001;pointer-events:none;width:90%;max-width:500px;background:var(--primary-dark);padding:2rem;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.5);border:2px solid var(--accent);text-align:center}.confirmation-popup.show{transform:translate(-50%,-50%) scale(1);opacity:1;pointer-events:auto;animation:popupAppear .4s cubic-bezier(.175,.885,.32,1.275)}.confirmation-popup h2{color:var(--gold);margin-bottom:1.5rem}.confirmation-popup p{color:var(--text);margin-bottom:2rem}.confirmation-popup button{position:relative;padding:.875rem 2rem;border:2px solid var(--accent);background:0 0;color:var(--text);border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s ease}.confirmation-popup button:hover{box-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}.level.boss{background:linear-gradient(135deg,var(--gold),var(--accent));border:2px solid var(--gold);box-shadow:0 0 20px var(--gold);position:relative;overflow:hidden}.level.boss::before{content:'ðŸ‘‘';position:absolute;top:-10px;right:-10px;font-size:1.2rem;transform:rotate(45deg)}.user-tier{display:block;text-align:center;margin-top:.5rem}.tier-text{font-weight:600;font-size:1rem;padding:.25rem .5rem;border-radius:15px;background:rgba(255,255,255,.1)}.tier-text.unregistered{color:#f44}.tier-text.trial{color:orange}.tier-text.pending{color:#00bfff;animation:pendingBlink 2s infinite}.tier-text.premium{color:#4caf50}@keyframes pendingBlink{0%,100%{opacity:.7}50%{opacity:1}}.leaderboard-screen{display:flex;flex-direction:column;align-items:center;padding:2rem;min-height:100vh}.leaderboard-container{background:var(--glass);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;width:100%;max-width:800px;margin-top:2rem}#arcade-leaderboard{width:100%;max-width:800px;margin:0 auto;padding:2rem}.leaderboard-header{display:grid;grid-template-columns:0.5fr 2fr 1fr 1fr;padding:1rem 2rem;background:rgba(255,255,255,.1);border-radius:10px;margin-bottom:1rem;font-weight:700;font-size:1.1rem}.leaderboard-header>div{text-align:center}.leaderboard-entry.moving-up{background:rgba(76,175,80,.08);animation:moveUp .8s ease-in-out forwards;z-index:2}.leaderboard-entry.moving-down{background:rgba(244,67,54,.08);animation:moveDown .8s ease-in-out forwards;z-index:1}@keyframes moveUp{0%{transform:translateY(65px)}100%{transform:translateY(0)}}@keyframes moveDown{0%{transform:translateY(-65px)}100%{transform:translateY(0)}}.leaderboard-entry:hover{background:rgba(255,255,255,.1)}.leaderboard-entry.you{background:rgba(6,145,64,.2);border:1px solid var(--gold)}.leaderboard-entry.rank-1{color:var(--gold)}.leaderboard-entry.rank-2{color:var(--silver)}.leaderboard-entry.rank-3{color:var(--bronze)}@media (max-width:768px){.leaderboard-entry,.leaderboard-header{padding:1rem;font-size:.9rem}}.leaderboard-entry,.leaderboard-header{grid-template-columns:0.5fr 2fr 1fr 1fr 1fr;font-size:.9rem;padding:.75rem}.premium-celebration{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(26,26,46,.95),rgba(22,33,62,.95));display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .5s ease}.premium-celebration.show{opacity:1;pointer-events:auto}.celebration-content{text-align:center;transform:translateY(30px);transition:transform .5s ease}.premium-celebration.show .celebration-content{transform:translateY(0)}.celebration-title{font-size:3rem;color:var(--gold);margin-bottom:2rem;text-shadow:0 2px 10px rgba(255,215,0,.3)}.celebration-message{font-size:1.5rem;color:var(--text);margin-bottom:2rem;line-height:1.5}.celebration-button{padding:1rem 2rem;font-size:1.2rem;background:var(--gold);color:var(--primary-dark);border:none;border-radius:50px;cursor:pointer;transition:all .3s ease}.celebration-button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,215,0,.3)}.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:1rem 2rem;border-radius:25px;z-index:1000;color:#fff;font-weight:700;opacity:0;transition:all .3s ease}.toast.success{background-color:#4caf50}.toast.error{background-color:#f44336}.toast.show{opacity:1;transform:translate(-50%,0)}.toast.hide{opacity:0;transform:translate(-50%,-20px)}.shop-container{display:flex;flex-direction:column;gap:2rem;max-width:800px;width:100%;padding:1rem}.shop-title{font-size:3rem;font-weight:700;text-align:center;color:var(--gold);margin-bottom:2rem}.shop-items{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}.shop-item{background:var(--glass);border-radius:20px;padding:2rem;display:flex;flex-direction:column;align-items:center;gap:1.5rem;backdrop-filter:blur(10px);transition:all .3s ease;cursor:pointer;border:1px solid rgba(255,255,255,.1)}.shop-item:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,.2)}.shop-item.disabled{opacity:.5;cursor:not-allowed}.shop-item-title{font-size:1.5rem;font-weight:600;color:var(--text)}.shop-item-icon{font-size:2.5rem;color:var(--gold)}.shop-item-description{color:var(--text);opacity:.8;font-size:.9rem;line-height:1.4}.shop-item-price{display:flex;align-items:center;gap:.5rem;color:var(--gold);font-size:1.2rem;font-weight:600}.shop-item-price i{font-size:1.5rem}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}@keyframes shine{to{transform:rotate(45deg) translate(100%,100%)}}@keyframes pulse{0%{box-shadow:0 0 30px var(--gold)}50%{box-shadow:0 0 50px var(--gold)}100%{box-shadow:0 0 30px var(--gold)}}@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}@keyframes correctAnswer{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}@keyframes wrongAnswer{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-5px)}40%,80%{transform:translateX(5px)}}@keyframes unlockSet{0%{transform:scale(1);background:var(--locked)}50%{transform:scale(1.1);background:var(--gold);box-shadow:0 0 50px var(--gold)}100%{transform:scale(1);background:linear-gradient(135deg,var(--gold),orange)}}@keyframes unlockLevel{0%{transform:scale(1);background:var(--locked)}50%{transform:scale(1.1);background:var(--accent);box-shadow:0 0 50px var(--accent)}100%{transform:scale(1);background:linear-gradient(135deg,var(--accent),#1e90ff)}}@keyframes progressPulsate{0%{transform:scale(1);filter:brightness(1)}50%{transform:scale(1.1);filter:brightness(1.5)}100%{transform:scale(1);filter:brightness(1)}}@keyframes warningPulse{0%{opacity:1;transform:scale(1)}50%{opacity:.8;transform:scale(1.05)}100%{opacity:1;transform:scale(1)}}@keyframes coinPulse{0%{transform:scale(1)}50%{transform:scale(1.2);filter:drop-shadow(0 0 20px var(--gold))}100%{transform:scale(1)}}@media (max-width:768px){.question-screen{padding-top:2rem;gap:1rem}.welcome-title{font-size:3rem}.stage-container{grid-template-columns:repeat(2,1fr);padding:1rem;gap:1rem}.set-container{grid-template-columns:repeat(3,1fr);gap:.75rem;padding:.75rem}.level{max-width:none;aspect-ratio:1;font-size:1.5rem}.question-word{font-size:2.5rem;margin:.5rem 0}.progress-circle{width:150px;height:150px;margin:.5rem 0}.progress-circle .timer-progress.warning{stroke:#f44336;filter:drop-shadow(0 0 5px rgba(244, 67, 54, .5));transition:stroke .3s ease,stroke-dashoffset 1s linear}.timer-value{font-size:2.5rem}.buttons{grid-template-columns:1fr;gap:.75rem}.buttons button{min-height:3.5rem;font-size:1rem;padding:.75rem;line-height:1.2}.coins-header{top:1rem;right:1rem;padding:.5rem 1rem}.perks-container{padding:.5rem;gap:.5rem;margin:.5rem 0}.perk-button{padding:.35rem}.perk-icon{font-size:1.2rem}.perk-count{font-size:.7rem}}@media (max-width:480px){.welcome-title{font-size:2.5rem;text-align:center;padding:0 1rem}.stage-container{grid-template-columns:1fr}.set-container{grid-template-columns:repeat(2,1fr)}.question-word{font-size:2rem}.progress-circle{width:120px;height:120px;margin:.5rem 0}.timer-value{font-size:2rem}}@supports(padding:max(0px)){.screen{padding-left:max(2rem,env(safe-area-inset-left));padding-right:max(2rem,env(safe-area-inset-right));padding-bottom:max(2rem,env(safe-area-inset-bottom))}}.stage-1{background:linear-gradient(135deg,var(--stage1-primary),var(--stage1-secondary))}.stage-1 .set-button.active,.stage-1 .stage-button{background:var(--stage1-accent)}.stage-2{background:linear-gradient(135deg,var(--stage2-primary),var(--stage2-secondary))}.stage-2 .set-button.active,.stage-2 .stage-button{background:var(--stage2-accent)}.stage-3{background:linear-gradient(135deg,var(--stage3-primary),var(--stage3-secondary))}.stage-3 .set-button.active,.stage-3 .stage-button{background:var(--stage3-accent)}.stage-4{background:linear-gradient(135deg,var(--stage4-primary),var(--stage4-secondary))}.stage-4 .set-button.active,.stage-4 .stage-button{background:var(--stage4-accent)}.stage-5{background:linear-gradient(135deg,var(--stage5-primary),var(--stage5-secondary))}.stage-5 .set-button.active,.stage-5 .stage-button{background:var(--stage5-accent)}.screen{padding-left:max(2rem,env(safe-area-inset-left));padding-right:max(2rem,env(safe-area-inset-right));padding-bottom:max(2rem,env(safe-area-inset-bottom))}@keyframes goldGreenPulse{0%,100%{stroke:var(--gold);filter:brightness(1.5)}50%{stroke:#1E90FF;filter:brightness(1.2)}}@keyframes particleBurst{0%{transform:translate(0,0);opacity:1}100%{transform:translate(var(--x),var(--y));opacity:0}}.particle{position:absolute;width:12px;height:12px;border-radius:50%;pointer-events:none;z-index:1000;animation:particleBurst 1.5s cubic-bezier(.25,.46,.45,.94) forwards}@keyframes particleBurst{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--x),var(--y)) scale(.5);opacity:0}}.progress-circle.completed{animation:pulseGrow .4s ease-in-out infinite}.progress-circle.completed circle.progress{animation:colorShift .4s ease-in-out infinite;transition:stroke .3s linear}@keyframes particleBurst{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--x),var(--y)) scale(0);opacity:0}}.particle-container{position:fixed;top:0;left:0;width:100vw;height:100vh;overflow:hidden;pointer-events:none;z-index:0}.letter-particle{position:absolute;font-size:16px;color:rgba(255,255,255,.2);user-select:none;pointer-events:none;opacity:0;font-weight:700;text-shadow:0 0 3px rgba(255,255,255,.1)}@keyframes letterFloat{0%{transform:translate(0,0) rotate(0);opacity:0}10%{opacity:var(--opacity)}90%{opacity:var(--opacity)}100%{transform:translate(var(--moveX),var(--moveY)) rotate(var(--rotate));opacity:0}}.progress-circle .timer-bg{stroke:rgba(255,255,255,0.1);fill:none}.progress-circle .timer-progress{stroke:rgba(255,255,255,0.9);fill:none;transform-origin:center;transform:rotate(-180deg);transition:stroke-dashoffset 1s linear,stroke .3s ease}.progress-circle .timer-progress.warning{stroke:#f44336;filter:drop-shadow(0 0 5px rgba(244, 67, 54, .5))}.progress-circle circle.timer-bg,.progress-circle circle.timer-progress{stroke-linecap:round}.progress-circle.completed circle.timer-progress{animation:none}.progress-circle.completed .timer-bg,.progress-circle.completed .timer-progress{animation:none!important}.back-button i,.home-button i{color:var(--text);font-size:1.5rem}.back-button:hover,.home-button:hover{background:var(--accent);transform:scale(1.1)}.perk-button.disabled{opacity:.3;cursor:not-allowed}.reset-button i{color:var(--text);font-size:1.5rem}.reset-button.warning{animation:blinkRed .2s linear 5}@keyframes blinkRed{0%,100%{background-color:transparent}50%{background-color:var(--error)}}.admin-verification{background:var(--glass);backdrop-filter:blur(10px);border-radius:20px;padding:2rem;width:100%;max-width:800px;margin:2rem auto}.pending-payments{display:flex;flex-direction:column;gap:1rem}.payment-request{background:rgba(255,255,255,.1);border-radius:15px;padding:1.5rem;display:flex;justify-content:space-between;align-items:center}.verification-actions{display:flex;gap:1rem}.verification-actions button{padding:.5rem 1rem;border-radius:25px;border:none;cursor:pointer;transition:all .3s ease}.verification-actions button:not(.reject){background:var(--success);color:#fff}.verification-actions button.reject{background:var(--error);color:#fff}.navigation-container{display:flex;flex-direction:column;gap:.25rem;margin:1rem 0;background:var(--glass);padding:.75rem;border-radius:25px;backdrop-filter:blur(10px);position:fixed;top:1rem;left:1rem;z-index:100}.navigation-button{display:flex;align-items:center;justify-content:center;width:40px;height:40px;padding:0;border-radius:50%;background:rgba(255,255,255,.1);border:none;cursor:pointer;transition:background-color .3s ease;box-shadow:none}.navigation-button:hover{background:0 0!important;box-shadow:none!important;transform:none!important}.navigation-button:hover svg{fill:var(--text)!important;stroke:var(--text)!important}.navigation-icon{font-size:1.5rem;color:var(--text)}.navigation-button.restart-level{color:var(--text);animation:none}.navigation-button.restart-level:hover{background:rgba(255,255,255,.2);transform:translateY(-2px)}.navigation-button.disabled{cursor:pointer;opacity:.3}@keyframes blinkRed{0%,100%{background-color:transparent}50%{background-color:var(--error)}}@keyframes particleBurst{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--x),var(--y)) scale(.5);opacity:0}}.menu-button{position:fixed;top:2rem;right:2rem;width:50px;height:50px;border-radius:50%;background:var(--glass);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);transition:all .3s ease;z-index:100}.menu-button:hover{transform:scale(1.1);background:rgba(255,255,255,.2)}.menu-button .navigation-icon{color:var(--text);font-size:1.5rem}.upgrade-prompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.7);opacity:0;transition:all .3s cubic-bezier(.68, -.55, .265, 1.55);z-index:1000;pointer-events:none;width:90%;max-width:500px;background:var(--glass);backdrop-filter:blur(10px);padding:2rem;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1)}.upgrade-prompt.show{transform:translate(-50%,-50%) scale(1);opacity:1;pointer-events:auto;animation:popupAppear .4s cubic-bezier(.175,.885,.32,1.275)}.upgrade-prompt h2{color:var(--gold);margin-bottom:1.5rem;text-align:center}.upgrade-prompt-buttons{display:flex;gap:1rem;justify-content:center;margin-top:2rem}.lock-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;border-radius:inherit}.lock-overlay i{color:var(--text);font-size:2rem;opacity:.8}@keyframes popupAppear{0%{transform:translate(-50%,-50%) scale(.7) rotate(-5deg);opacity:0}70%{transform:translate(-50%,-50%) scale(1.05) rotate(2deg);opacity:.8}100%{transform:translate(-50%,-50%) scale(1) rotate(0);opacity:1}}.custom-practice-container{display:flex;gap:2rem;max-width:1400px;margin:0 auto;padding:2rem}.practice-section{flex:1;background:0 0;border-radius:20px;padding:2rem;backdrop-filter:none;box-shadow:none;border:1px solid rgba(255,255,255,.1)}.lists-section{flex:1;background:0 0;border-radius:20px;padding:2rem;backdrop-filter:none;box-shadow:none;border:1px solid rgba(255,255,255,.1)}.list-name-section{margin-bottom:1.5rem}.list-name-input{width:100%;padding:.875rem;border-radius:50px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:var(--text);text-align:center;font-size:1rem;transition:all .3s ease}.list-name-input:focus{outline:0;border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.3)}#custom-word-input{width:100%;margin-bottom:1.5rem;padding:1rem;border-radius:15px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:var(--text);min-height:120px;resize:vertical;transition:all .3s ease}#custom-word-input:focus{outline:0;border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.3)}.translation-results{background:rgba(255,255,255,.05);border-radius:15px;padding:1.5rem;margin-top:1.5rem}.word-translation-list{display:table;width:100%;border-spacing:0 0.75rem}.word-translation-item{display:table-row;background:rgba(255,255,255,.05);border-radius:10px;transition:all .3s ease;cursor:grab}.word-translation-item.dragging{opacity:.5;background:rgba(255,255,255,.2);cursor:grabbing}.word-translation-item>*{display:table-cell;padding:.75rem;vertical-align:middle;text-align:center}.drag-handle{width:20px;color:var(--text);opacity:.7;cursor:grab}.drag-handle:hover{opacity:1}.word-translation-item .source-word{padding:.5rem;border-radius:8px;background:rgba(255,255,255,.1);color:var(--text);margin:.5rem;width:200px;min-height:36px;text-align:center;border:1px solid rgba(255,255,255,.2);transition:all .3s ease;display:inline-block;vertical-align:middle}.word-translation-item .target-word{padding:.5rem;border-radius:8px;background:rgba(255,255,255,.1);color:var(--text);margin:.5rem;width:200px;min-height:36px;text-align:center;border:1px solid rgba(255,255,255,.2);transition:all .3s ease;display:inline-block;vertical-align:middle}.word-translation-item .source-word[contenteditable=true]{font-family:inherit;font-size:inherit;appearance:none;-webkit-appearance:none}.word-translation-item .target-word[contenteditable=true]{font-family:inherit;font-size:inherit;appearance:none;-webkit-appearance:none}.word-translation-item .target-word:not([readonly]){font-family:inherit;font-size:inherit;appearance:none;-webkit-appearance:none}.custom-list-item{position:relative;display:flex;flex-direction:column;padding:1.25rem;margin-bottom:1.5rem;background:0 0;border-radius:15px;backdrop-filter:none;border:1px solid rgba(255,255,255,.1)}.custom-list-item h3{margin-bottom:.5rem;color:var(--gold)}.custom-list-item .list-info{margin:1rem 0;color:var(--text);opacity:.8}.list-header{cursor:pointer;display:flex;flex-direction:column;gap:.5rem;order:1}.list-summary{font-size:.9rem;opacity:.8}.list-content{max-height:0;overflow:hidden;transition:max-height .3s ease}.custom-list-item:not(.collapsed) .list-content{max-height:1000px;margin-top:1rem}.list-header{cursor:pointer;display:flex;flex-direction:column;gap:.5rem}.word-preview{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;margin-top:.25rem}@media (max-width:768px){.list-actions{grid-template-columns:repeat(auto-fit,minmax(120px,1fr));width:100%}.add-word-button{width:100%;justify-content:center}}@media (max-width:768px){.custom-practice-container{flex-direction:column;gap:1.5rem;padding:1rem}.practice-section{padding:1rem;width:100%}.lists-section{padding:1rem;width:100%}#custom-word-input{min-height:150px;font-size:16px;padding:1rem}.word-translation-list{display:block}.word-translation-item{display:table-row;background:0 0;border-radius:10px;transition:all .3s ease;cursor:grab;border:1px solid rgba(255,255,255,.1)}.word-translation-item .source-word{width:100%;min-height:44px;font-size:16px;padding:.75rem;margin:0;background:rgba(255,255,255,.1);border-radius:8px}.word-translation-item .target-word{width:100%;min-height:44px;font-size:16px;padding:.75rem;margin:0;background:rgba(255,255,255,.1);border-radius:8px}.list-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem;margin-top:1rem;width:100%}.custom-list-item{padding:1.25rem;margin-bottom:1rem}.custom-list-item h3{font-size:1.25rem;margin-bottom:.75rem}.list-info{font-size:.9rem;margin:.75rem 0}.list-stats{grid-column:1/-1;text-align:center;margin-top:.75rem;font-size:.875rem;opacity:.8}.drag-handle{display:none}.delete-word-btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;margin:0 auto}.word-preview{font-size:.85rem}.custom-list-item:not(.collapsed){padding-bottom:.75rem}}@media (max-width:480px){.custom-practice-container{padding:.5rem}.start-button{width:100%;max-width:250px;font-size:.9rem;padding:.6rem}.edit-mode-button{width:100%;max-width:none;font-size:.9rem;padding:.6rem}.list-actions{grid-template-columns:1fr}.custom-list-item h3{font-size:1.1rem}.list-info{font-size:.85rem}.word-translation-item{padding:.75rem}.word-translation-item .source-word{font-size:.95rem;padding:.6rem}.word-translation-item .target-word{font-size:.95rem;padding:.6rem}}@media (max-width:360px){.custom-practice-container{padding:.25rem}.practice-section{padding:.75rem}.lists-section{padding:.75rem}.custom-list-item{padding:1rem}.custom-list-item h3{font-size:1rem}}.username-display{padding:.75rem;background:rgba(255,255,255,.1);border-radius:15px;margin-bottom:.5rem;color:var(--gold);font-weight:700}.victory-screen{background:rgba(0,0,0,.9)}.victory-screen .completion-modal-content{background:0 0;display:flex;flex-direction:column;align-items:center;max-width:400px;padding:0;border-radius:20px;overflow:hidden}.victory-header{width:100%;text-align:center;padding:1.5rem;color:#fff}.victory-header .rank-emoji{font-size:3rem;display:block;margin-bottom:.5rem}.victory-header h2{font-size:1.5rem;text-transform:uppercase;letter-spacing:2px}.victory-message{padding:1rem;text-align:center;background:rgba(255,255,255,.1);width:100%}.completion-stats{display:flex;justify-content:space-around;width:100%;padding:1.5rem;background:rgba(255,255,255,.05)}.stat-item{display:flex;flex-direction:column;align-items:center;text-align:center}.stat-icon{font-size:2rem;margin-bottom:.5rem}.stat-label{font-size:.8rem;color:rgba(255,255,255,.7);text-transform:uppercase}.stat-value{font-size:1.5rem;font-weight:700;color:#fff}.victory-button{width:100%;padding:1rem;background:var(--accent);color:#fff;border:none;font-size:1rem;text-transform:uppercase;letter-spacing:1px;transition:background .3s ease}.victory-button:hover{background:color-mix(in srgb,var(--accent) 90%,#fff)}.inactivity-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s ease}.inactivity-overlay.visible{opacity:1;pointer-events:auto}.countdown-timer{font-size:8rem;color:var(--gold);margin-bottom:2rem;text-shadow:0 0 20px rgba(255,215,0,.5)}.inactivity-message{font-size:1.5rem;color:var(--text);text-align:center;max-width:80%}.countdown-cancel{margin-top:2rem;padding:1rem 2rem;background:var(--accent);color:#fff;border:none;border-radius:25px;font-size:1rem;cursor:pointer;transition:all .3s ease}.countdown-cancel:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(233,69,96,.4)}.countdown-progress{width:200px;height:5px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:1rem;overflow:hidden}.countdown-bar{height:100%;width:100%;background:var(--gold);transform-origin:left;transition:transform 1s linear}@keyframes celebrationGlow{0%{box-shadow:0 0 15px gold;background:rgba(255,215,0,.2)}25%{box-shadow:0 0 20px #ff1493;background:rgba(255,20,147,.2)}50%{box-shadow:0 0 25px #00bfff;background:rgba(0,191,255,.2)}75%{box-shadow:0 0 20px #7cfc00;background:rgba(124,252,0,.2)}100%{box-shadow:0 0 15px gold;background:rgba(255,215,0,.2)}}@keyframes celebrationGlowIntense{0%{box-shadow:0 0 25px gold;background:rgba(255,215,0,.3)}25%{box-shadow:0 0 35px #ff1493;background:rgba(255,20,147,.3)}50%{box-shadow:0 0 45px #00bfff;background:rgba(0,191,255,.3)}75%{box-shadow:0 0 35px #7cfc00;background:rgba(124,252,0,.3)}100%{box-shadow:0 0 25px gold;background:rgba(255,215,0,.3)}}@keyframes confettiFall{0%{transform:translateY(-20vh) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}@keyframes celebrationEmoji{0%{transform:scale(0) rotate(-30deg);opacity:0}50%{transform:scale(1.2) rotate(5deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}@keyframes gracefulCenterMove{0%{position:absolute;transform:translate(0,0) scale(1);z-index:20}100%{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(3);z-index:100}}@keyframes firstPlaceMove{0%{position:absolute;transform:translate(0,0) scale(1)}100%{position:fixed;top:30vh;left:50%;transform:translate(-50%,0) scale(1.5);z-index:103}}@keyframes secondPlaceMove{0%{position:absolute;transform:translate(0,0) scale(1)}100%{position:fixed;top:50vh;left:50%;transform:translate(-50%,0) scale(1.25);z-index:102}}@keyframes thirdPlaceMove{0%{position:absolute;transform:translate(0,0) scale(1)}100%{position:fixed;top:70vh;left:50%;transform:translate(-50%,0) scale(1);z-index:101}}.winner-entry{position:relative;transition:all .5s ease}.winner-entry.celebrating{border-radius:15px;border:2px solid transparent;overflow:visible!important}.winner-entry.first-place{border:3px solid var(--gold);animation:firstPlaceMove 1.5s forwards,celebrationGlowIntense 2s infinite 1.5s;background:rgba(255,215,0,.2)}.winner-entry.second-place{border:3px solid var(--silver);animation:secondPlaceMove 1.5s forwards,celebrationGlowIntense 2.5s infinite 1.5s;background:rgba(192,192,192,.2)}.winner-entry.third-place{border:3px solid var(--bronze);animation:thirdPlaceMove 1.5s forwards,celebrationGlowIntense 3s infinite 1.5s;background:rgba(205,127,50,.2)}.winner-entry.first-place .player-name,.winner-entry.second-place .player-name,.winner-entry.third-place .player-name{font-size:1.8rem;transition:all .5s ease;text-shadow:0 0 5px rgba(255,255,255,.3)}.winner-entry.first-place .coins,.winner-entry.first-place .words,.winner-entry.second-place .coins,.winner-entry.second-place .words,.winner-entry.third-place .coins,.winner-entry.third-place .words{font-size:1.4rem;transition:all .5s ease}.winner-entry.first-place.centered .player-name{font-size:3.2rem;font-weight:800;color:#fff;text-shadow:0 0 10px var(--gold),0 0 20px var(--gold);letter-spacing:1px}.winner-entry.first-place.centered .coins,.winner-entry.first-place.centered .words{font-size:2.4rem;font-weight:700;text-shadow:0 0 8px rgba(255,215,0,.6)}.winner-entry.second-place.centered .player-name{font-size:2.8rem;font-weight:700;color:#fff;text-shadow:0 0 10px var(--silver),0 0 20px var(--silver)}.winner-entry.second-place.centered .coins,.winner-entry.second-place.centered .words{font-size:2.2rem;font-weight:600;text-shadow:0 0 8px rgba(192,192,192,.6)}.winner-entry.third-place.centered .player-name{font-size:2.4rem;font-weight:600;color:#fff;text-shadow:0 0 10px var(--bronze),0 0 20px var(--bronze)}.winner-entry.third-place.centered .coins,.winner-entry.third-place.centered .words{font-size:2rem;font-weight:600;text-shadow:0 0 8px rgba(205,127,50,.6)}.laurel-wreath{pointer-events:none}.winner-label{position:absolute;top:-70px;left:50%;transform:translateX(-50%);font-size:2.2rem;font-weight:700;color:var(--gold);background:rgba(0,0,0,.7);padding:5px 20px;border:2px solid rgba(255,215,0,.3);border-radius:30px;text-shadow:0 0 15px rgba(255,215,0,.8);white-space:nowrap;opacity:0;transition:opacity .5s ease 1.5s;z-index:250;letter-spacing:1px}.winner-entry.first-place.centered .winner-label{opacity:1;box-shadow:0 0 20px rgba(255,215,0,.4)}.celebration-emoji{position:fixed;opacity:0;transform:scale(0);animation:emojiAppear .6s forwards;filter:drop-shadow(0 0 10px rgba(0,0,0,.5));z-index:300}@keyframes emojiAppear{0%{opacity:0;transform:scale(0) rotate(-30deg)}70%{opacity:1;transform:scale(1.2) rotate(10deg)}100%{opacity:1;transform:scale(1) rotate(0)}}.confetti{position:fixed;width:10px;height:10px;top:-20px;z-index:5;border-radius:0;animation:confettiFall 4s linear forwards}.celebration-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:1;opacity:0;transition:opacity 1s ease;pointer-events:none}.celebration-overlay.visible{opacity:1}.home-button-container{position:fixed;bottom:5vh;left:50%;transform:translateX(-50%);z-index:200;opacity:0;transition:opacity 1s ease 2s}.home-button-container.visible{opacity:1}.winner-label{position:absolute;top:-55px;left:50%;transform:translateX(-50%);font-size:1.8rem;font-weight:700;color:var(--gold);background-color:rgba(0,0,0,.7);padding:5px 15px;border-radius:20px;text-shadow:0 0 10px rgba(255,215,0,.5);white-space:nowrap;opacity:0;transition:opacity .5s ease 1.5s;z-index:105}.winner-entry.centered .winner-label{opacity:1}.slider-container{width:100%;max-width:500px;margin:1rem auto;position:relative}.word-goal-slider{-webkit-appearance:none;width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,.2);outline:0;direction:ltr}.word-goal-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 0 10px rgba(255,215,0,.5);transition:all .2s ease}.word-goal-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 0 10px rgba(255,215,0,.5);transition:all .2s ease}.word-goal-slider::-webkit-slider-thumb:hover{transform:scale(1.2);box-shadow:0 0 15px rgba(255,215,0,.7)}.slider-stops{display:flex;justify-content:space-between;margin-top:.5rem;padding:0 10px}.slider-stop{position:relative;cursor:pointer;font-size:.9rem;color:var(--text);transition:all .2s ease}.slider-stop:hover{color:var(--gold);transform:translateY(-2px)}.slider-stop::before{content:'';position:absolute;top:-15px;left:50%;transform:translateX(-50%);width:2px;height:10px;background-color:rgba(255,255,255,.5)}.word-goal-input{width:80px;padding:.5rem;text-align:center;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:25px;color:var(--text);margin-top:1rem;font-size:1rem}.word-goal-input:focus{outline:0;border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.3)}.stage-checkboxes label{display:flex;align-items:center;gap:.75rem;cursor:pointer;font-size:1.4rem;padding:1.25rem;background:rgba(255,255,255,.1);border-radius:15px;transition:all .3s ease;min-width:120px;justify-content:center}.stage-checkboxes input[type=checkbox]{width:28px;height:28px;cursor:pointer;accent-color:var(--gold)}.slider-stops{display:flex;justify-content:space-between;margin-top:.75rem;padding:0 10px;width:100%}.slider-stop{position:relative;cursor:pointer;font-size:1rem;color:var(--text);transition:all .3s ease;padding:.5rem;background:rgba(255,255,255,.05);border-radius:12px;min-width:40px;text-align:center}.slider-stop:hover{color:var(--gold);transform:translateY(-3px);background:rgba(255,255,255,.1)}.slider-stop::before{content:'';position:absolute;top:-15px;left:50%;transform:translateX(-50%);width:3px;height:12px;background-color:rgba(255,255,255,.6)}.word-goal-slider{height:8px;border-radius:4px;margin:1.5rem 0 .5rem}.word-goal-slider::-webkit-slider-thumb{width:24px;height:24px}.word-goal-slider::-moz-range-thumb{width:24px;height:24px}.revive-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;transition:opacity .5s ease}.revive-overlay.show{opacity:1}.revive-content{text-align:center;transform:translateY(30px);transition:transform .5s ease}.revive-overlay.show .revive-content{transform:translateY(0)}.ankh-symbol{font-size:8rem;color:var(--gold);margin-bottom:1rem;text-shadow:0 0 30px rgba(255,215,0,.5);animation:ankhPulse 2s infinite}@keyframes ankhPulse{0%,100%{transform:scale(1);text-shadow:0 0 30px rgba(255,215,0,.5)}50%{transform:scale(1.1);text-shadow:0 0 50px rgba(255,215,0,.8)}}.revive-title{font-size:3rem;color:var(--text);margin-bottom:2rem}.revive-timer{font-size:5rem;color:var(--gold);font-weight:700;margin-bottom:2rem;text-shadow:0 0 20px rgba(255,215,0,.3)}.revive-button{padding:1rem 3rem;font-size:1.5rem;background:var(--accent);color:var(--text);border:none;border-radius:50px;cursor:pointer;transition:all .3s ease;box-shadow:0 0 20px var(--accent);animation:buttonGlow 1.5s infinite}.revive-button:hover{transform:translateY(-3px);box-shadow:0 0 30px var(--accent)}@keyframes buttonGlow{0%,100%{box-shadow:0 0 20px var(--accent)}50%{box-shadow:0 0 30px var(--accent)}}.resurrection-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:2000;opacity:0;transition:opacity .5s ease}.resurrection-overlay.show{opacity:1}.revive-container{text-align:center;position:relative;width:200px;height:200px;display:flex;align-items:center;justify-content:center;flex-direction:column;margin-bottom:1rem}.ankh-symbol{position:absolute;font-size:5rem;color:var(--gold);z-index:10;animation:ankhPulse 2s infinite}.revive-title{color:var(--text);font-size:1.8rem;margin-bottom:1rem}.revive-timer{color:var(--gold);font-size:4rem;font-weight:700;margin-bottom:1rem}.revive-button{padding:1rem 3rem;font-size:1.5rem;background:var(--accent);color:var(--text);border:none;border-radius:50px;cursor:pointer;transition:all .3s ease;box-shadow:0 0 20px var(--accent);animation:buttonGlow 1.5s infinite}.revive-button:hover{transform:translateY(-3px);box-shadow:0 0 30px var(--accent)}.resurrection-progress circle{transition:stroke-dashoffset 2s cubic-bezier(.4, 0, .2, 1)}.resurrection-fill{stroke:var(--gold);filter:drop-shadow(0 0 5px var(--gold))}@keyframes ankhPulse{0%,100%{transform:scale(1);text-shadow:0 0 30px rgba(255,215,0,.5)}50%{transform:scale(1.1);text-shadow:0 0 50px rgba(255,215,0,.8)}}@keyframes buttonGlow{0%,100%{box-shadow:0 0 20px var(--accent)}50%{box-shadow:0 0 30px var(--accent)}}.stages-container{width:100%;max-width:800px;display:flex;flex-direction:column;gap:1.5rem;padding:1rem;margin:0 auto;margin-top:3rem}.stage-wrapper{width:100%}.stage-wrapper .stage-button{width:100%;padding:1.25rem;border-radius:16px;background:var(--glass);backdrop-filter:blur(10px);cursor:pointer;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.1);transition:all .3s ease;position:relative;overflow:hidden}.stage-wrapper .stage-button::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.15) 0,transparent 70%);opacity:0;transition:opacity .3s ease}.stage-wrapper .stage-button:hover::before{opacity:1}.stage-wrapper .stage-button:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,.2)}.stage-info{display:flex;align-items:center;gap:1.25rem}.stage-icon{width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:1.75rem;background:linear-gradient(135deg,var(--accent),rgba(30,144,255,.7));border-radius:12px;box-shadow:0 5px 15px rgba(30,144,255,.3)}.stage-text{display:flex;flex-direction:column;gap:.25rem}.stage-wrapper .stage-name{font-size:1.2rem;font-weight:700;color:var(--text)}.stage-desc{font-size:.9rem;opacity:.8}.stage-status{font-size:.85rem;padding:.25rem .75rem;border-radius:50px;background:rgba(255,255,255,.1)}.stage-toggle{font-size:1.25rem;transition:transform .4s cubic-bezier(.68, -.55, .27, 1.55)}.stage-wrapper.open .stage-toggle{transform:rotate(180deg)}.sets-container{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4, 0, .2, 1);background:rgba(0,0,0,.2);border-radius:0 0 16px 16px;margin-top:2px;border:1px solid rgba(255,255,255,.05);border-top:none}.stage-wrapper.open .sets-container{max-height:800px}.sets-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;padding:1.5rem}.sets-grid .set-button{aspect-ratio:16/9;position:relative;display:flex;align-items:center;justify-content:center;padding:1rem;border-radius:12px;background:rgba(255,255,255,.05);backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:all .3s ease;font-weight:600;overflow:hidden}.sets-grid .set-button.active{background:linear-gradient(135deg,var(--accent),rgba(30,144,255,.7));border:1px solid rgba(255,255,255,.3);box-shadow:0 5px 15px rgba(30,144,255,.2)}.sets-grid .set-button.locked{background:rgba(128,128,128,.2);cursor:not-allowed}.sets-grid .set-button:not(.locked):hover{transform:translateY(-3px) scale(1.03);box-shadow:0 8px 15px rgba(0,0,0,.2)}.sets-grid .set-button::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(255,255,255,.1) 0,transparent 80%);opacity:0;transition:opacity .3s ease}.sets-grid .set-button:not(.locked):hover::before{opacity:1}.lock-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5rem;color:rgba(255,255,255,.5)}.completed-indicator{position:absolute;top:.5rem;right:.5rem;font-size:.75rem;color:var(--gold)}.stage-wrapper.closed .sets-container{max-height:0}.stage-wrapper.open .stage-button{border-radius:16px 16px 0 0;transform:translateY(0);box-shadow:none}.stage-wrapper[data-stage="1"] .stage-icon{background:linear-gradient(135deg,#ff416c,#ff4b2b)}.stage-wrapper[data-stage="2"] .stage-icon{background:linear-gradient(135deg,#4facfe,#00f2fe)}.stage-wrapper[data-stage="3"] .stage-icon{background:linear-gradient(135deg,#a18cd1,#fbc2eb)}.stage-wrapper[data-stage="4"] .stage-icon{background:linear-gradient(135deg,#84fab0,#8fd3f4)}.stage-wrapper[data-stage="5"] .stage-icon{background:linear-gradient(135deg,#fad0c4,#ffd1ff)}@media (max-width:768px){.stages-container{max-width:100%;padding:.5rem}.stage-icon{width:48px;height:48px;font-size:1.4rem}.stage-wrapper .stage-name{font-size:1rem}.stage-desc{font-size:.8rem}.sets-grid{grid-template-columns:repeat(auto-fit,minmax(100px,1fr));padding:1rem;gap:.75rem}}.accessibility-toggle{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--primary);border:2px solid var(--accent);color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,.3);transition:all .3s ease}.accessibility-toggle:hover{transform:scale(1.1);box-shadow:0 5px 15px rgba(0,0,0,.4)}.accessibility-toggle i{font-size:24px}.accessibility-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all .3s ease}.accessibility-modal.show{opacity:1;visibility:visible}.accessibility-content{width:90%;max-width:600px;max-height:90vh;overflow-y:auto;background:var(--primary-dark);border-radius:20px;padding:2rem;color:var(--text);border:1px solid var(--accent)}.accessibility-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,.1)}.accessibility-header h2{margin:0;color:var(--gold);font-size:1.8rem}.close-accessibility{background:0 0;border:none;color:var(--text);font-size:1.5rem;cursor:pointer;opacity:.8;transition:opacity .3s ease}.close-accessibility:hover{opacity:1}.accessibility-options{display:flex;flex-direction:column;gap:1.5rem}.accessibility-section{margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,.1)}.accessibility-section h3{margin-top:0;margin-bottom:1rem;color:var(--accent);font-size:1.3rem}.option-group{margin-bottom:1rem;display:flex;flex-direction:column;gap:.5rem}.option-group label{font-size:1rem;color:var(--text);opacity:.9}.controls{display:flex;flex-wrap:wrap;gap:.5rem}.accessibility-button{padding:.5rem 1rem;border-radius:8px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:var(--text);cursor:pointer;transition:all .3s ease;font-size:.9rem}.accessibility-button:hover{background:rgba(255,255,255,.2)}.accessibility-button.active{background:var(--accent);border-color:var(--accent);color:var(--primary-dark);box-shadow:0 0 10px rgba(30,144,255,.5)}.accessibility-footer{margin-top:1.5rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,.1);text-align:center}.reset-all{width:100%;padding:.75rem!important;background:rgba(244,67,54,.2)!important;border:1px solid rgba(244,67,54,.4)!important;color:#f44336!important}.reset-all:hover{background:rgba(244,67,54,.3)!important}body.high-contrast{--primary-dark:#000000;--primary:#000000;--secondary:#000000;--text:#ffffff;--accent:#ffff00}body.inverted-colors{filter:invert(1) hue-rotate(180deg)}body.grayscale{filter:grayscale(1)}body.large-font{--font-scale:1.2;font-size:calc(1rem * var(--font-scale))}body.larger-font{--font-scale:1.4;font-size:calc(1rem * var(--font-scale))}body.largest-font{--font-scale:1.6;font-size:calc(1rem * var(--font-scale))}body.dyslexic-font{font-family:OpenDyslexic,'Comic Sans MS',sans-serif}body.increased-letter-spacing{letter-spacing:.1em}body.no-animations *{animation:none!important;transition:none!important}body.reduced-animations *{animation-duration:1ms!important;transition-duration:1ms!important}body.high-focus :focus{outline:3px solid var(--accent)!important;outline-offset:3px!important;box-shadow:0 0 0 3px var(--accent)!important}body.large-buttons .main-button,body.large-buttons .nav-link,body.large-buttons button,body.large-buttons input[type=submit]{padding:calc(.75rem * 1.3) calc(1.5rem * 1.3)!important;font-size:calc(1rem * 1.3)!important;min-height:44px!important}body.large-cursor,body.large-cursor *{cursor:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='white' stroke='black' stroke-width='2'/%3E%3C/svg%3E") 16 16,auto!important}body.light-theme{--primary-dark:#ffffff;--primary:#f5f5f5;--secondary:#e0e0e0;--text:#333333;--accent:#1E90FF;--gradient:linear-gradient(135deg, #f5f5f5, #e0e0e0)}body.dark-theme{--primary-dark:#1a1a2e;--primary:#16213e;--secondary:#0f3460;--text:#ffffff;--accent:#1E90FF;--gradient:linear-gradient(135deg, var(--secondary), var(--primary-dark))}@font-face{font-family:OpenDyslexic;src:url('https://cdn.jsdelivr.net/npm/open-dyslexic@1.0.3/woff/OpenDyslexic-Regular.woff') format('woff');font-weight:400;font-style:normal}@media (max-width:768px){.accessibility-content{width:95%;padding:1.5rem}.accessibility-toggle{bottom:15px;right:15px;width:45px;height:45px}.accessibility-button{padding:.5rem .75rem;font-size:.85rem}}.boss-mode{background:linear-gradient(135deg,maroon,#3a0000)!important}.boss-orb{font-size:28px;animation:pulseOrb 1.5s infinite}@keyframes pulseOrb{0%,100%{transform:scale(1);opacity:.8;text-shadow:0 0 15px #f33}50%{transform:scale(1.2);opacity:1;text-shadow:0 0 25px #f33,0 0 35px #f33}}.boss-health.warning{animation:bossHealthWarning .5s infinite alternate}@keyframes bossHealthWarning{from{stroke:#ff3333}to{stroke:#ffffff}}.boss-hit{animation:bossHitEffect .2s}@keyframes bossHitEffect{0%{transform:scale(1)}50%{transform:scale(1.02);background-color:rgba(255,0,0,.2)}100%{transform:scale(1)}}.perk-disabled{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.5em;color:red;pointer-events:none}</style></head><body><div id="qr-landing" class="screen" style="display:none"><div class="qr-landing-content"><h2>Welcome to Simplos Arcade!</h2><p>Your game code is:</p><div class="game-code-display"></div><button class="join-game-button" onclick="proceedToGame()">Join Game</button></div></div><div id="welcome-screen" class="screen visible"><div class="particle-container" id="particleContainer"></div><h1 class="welcome-title">Simplos</h1><div class="main-buttons"><button class="main-button primary" onclick="showAuthModal()">Login / Sign Up</button> <button class="main-button guest-play-button" onclick="startGame()">Play as Guest</button> <button class="main-button arcade-button" onclick="showArcadeModal()">Arcade</button> <button class="main-button" onclick="showCustomListsManager()">My Lists</button> <button class="main-button stages-button" onclick="showStageCascadeScreen()">Stages</button> <button class="main-button" disabled="disabled">Download the App</button></div><div id="authModal" class="auth-modal"><div class="auth-modal-content"><div id="loginForm" class="auth-form"><h2>Login</h2><input type="text" class="auth-input" placeholder="Username or Email" id="loginUsername"> <input type="password" class="auth-input" placeholder="Password" id="loginPassword"> <button class="auth-button" onclick="handleLogin()">Login</button> <button class="auth-toggle" onclick="toggleAuthMode()">New? Register here</button></div><div id="signupForm" class="auth-form hidden"><h2>Sign Up</h2><input type="email" class="auth-input" placeholder="Email" id="signupEmail"> <input type="text" class="auth-input" placeholder="Username" id="signupUsername"> <input type="password" class="auth-input" placeholder="Password" id="signupPassword"> <button class="auth-button" onclick="handleSignup()">Sign Up</button> <button class="auth-toggle" onclick="toggleAuthMode()">Already have an account?</button></div></div></div><button class="hamburger-button" onclick="toggleSidePanel()"><i class="fas fa-bars"></i></button><div class="side-panel"><div class="side-panel-content"><button class="logout-button logout-top-button"><i class="fas fa-sign-out-alt"></i> Logout</button><div class="welcome-buttons"><a href="#" class="nav-link" onclick='return showScreen("stage-screen"),!1'><i class="fas fa-map-marked-alt"></i> Level Map </a><a href="#" class="nav-link" onclick="return showCustomListsManager(),!1"><i class="fas fa-list"></i> My Lists </a><a href="#" class="nav-link" onclick="return showLeaderboard(),!1"><i class="fas fa-trophy"></i> Speedboard </a><a href="#" class="nav-link" onclick="return showPricesScreen(),!1"><i class="fas fa-dollar-sign"></i> Prices </a><a href="#" class="nav-link" onclick="return showRightsAndPolicies(),!1"><i class="fas fa-balance-scale"></i> Rights & Policies </a><a href="#" class="nav-link" onclick="return showAboutPage(),!1"><i class="fas fa-info-circle"></i> About </a><a href="#" class="nav-link" onclick="return showContactUs(),!1"><i class="fas fa-envelope"></i> Contact Us</a></div><div class="user-profile-section user-profile-bottom"><div class="username-display" id="userEmail"></div><div class="status-badge" id="userTierText"></div><div class="user-stats"><div class="stat-item"><div class="stat-label">Words</div><div class="stat-value" id="totalWords">0</div></div><div class="stat-item"><div class="stat-label">Coins</div><div class="stat-value"><i class="fas fa-coins coin-icon"></i> <span id="totalCoins">0</span></div></div></div></div></div></div></div><div id="stage-cascade-screen" class="screen"><div class="particle-container"></div><div class="navigation-container" style="position:fixed;top:1rem;left:50%;transform:translateX(-50%);flex-direction:row;gap:.75rem;background:0 0;margin:0"><button class="navigation-button home-button" onclick="navigateHome()"><i class="fas fa-home navigation-icon"></i></button> <button class="navigation-button reset-button" onclick="handleResetProgress()"><i class="fas fa-trash-alt navigation-icon"></i></button> <button class="navigation-button fullscreen-button" onclick="toggleFullScreen()"><i class="fas fa-expand navigation-icon"></i></button></div><div class="stages-container"></div></div><div id="level-screen" class="screen"><div class="particle-container"></div><div class="navigation-container"><button class="navigation-button home-button" onclick='showScreen("stage-cascade-screen")'><i class="fas fa-arrow-left navigation-icon"></i></button> <button class="navigation-button fullscreen-button" onclick="toggleFullScreen()"><i class="fas fa-expand navigation-icon"></i></button></div><div class="level-container" id="level-container"></div></div><div id="question-screen" class="screen"><div class="particle-container"></div><div class="navigation-container"><button class="navigation-button home-button" onclick='showScreen("welcome-screen")'><i class="fas fa-home navigation-icon"></i></button></div><div class="question-word" id="question-word"></div><div class="progress-circle"><svg width="100%" height="100%" viewBox="0 0 120 120"><circle class="bg" cx="60" cy="60" r="54" stroke-width="8"/><circle class="progress" cx="60" cy="60" r="54" stroke-width="8"/><circle class="timer-bg" cx="60" cy="60" r="40" stroke-width="4"/><circle class="timer-progress" cx="60" cy="60" r="40" stroke-width="4"/></svg><div class="coins-container"><i class="fas fa-coins coin-icon"></i> <span class="coin-count">0</span></div></div><div class="perks-container"><button class="perk-button" id="timeFreezePerk"><i class="fas fa-clock perk-icon"></i> <span class="perk-count">0</span></button> <button class="perk-button" id="skipPerk"><i class="fas fa-forward perk-icon"></i> <span class="perk-count">0</span></button> <button class="perk-button" id="cluePerk"><i class="fas fa-lightbulb perk-icon"></i> <span class="perk-count">0</span></button> <button class="perk-button" id="revealPerk"><i class="fas fa-eye perk-icon"></i> <span class="perk-count">0</span></button></div><div class="powerups-container"><div class="powerup-card goodie" id="highFiveCard"><i class="fas fa-hand-paper powerup-icon"></i><div class="powerup-name">High Five</div><div class="powerup-cost">30</div></div><div class="powerup-card goodie" id="fistBumpCard"><i class="fas fa-fist-raised powerup-icon"></i><div class="powerup-name">Fist Bump</div><div class="powerup-cost">40</div></div><div class="powerup-card goodie" id="energyBoostCard"><i class="fas fa-bolt powerup-icon"></i><div class="powerup-name">Energy Boost</div><div class="powerup-cost">45</div></div><div class="powerup-card baddie" id="freezeCard"><i class="fas fa-snowflake powerup-icon"></i><div class="powerup-name">Freeze</div><div class="powerup-cost">150</div></div><div class="powerup-card baddie" id="coinStormCard"><i class="fas fa-cloud-showers-heavy powerup-icon"></i><div class="powerup-name">Coin Storm</div><div class="powerup-cost">160</div></div><div class="powerup-card baddie" id="screenShakeCard"><i class="fas fa-shake powerup-icon"></i><div class="powerup-name">Screen Shake</div><div class="powerup-cost">130</div></div></div><div class="timer-container"><div class="timer-value">00:00</div></div><div class="buttons" id="buttons"></div></div><div class="failure-overlay" style="display:none"><div class="failure-content"><h2 class="failure-title">Time's Up!</h2><div class="failure-buttons"><button class="restart-button"><i class="fas fa-redo"></i></button> <button class="home-button"><i class="fas fa-home"></i></button></div></div></div><div id="custom-practice-screen" class="screen"><div class="navigation-container"><button class="navigation-button home-button" onclick='showScreen("welcome-screen")'><i class="fas fa-home navigation-icon"></i></button></div><div class="custom-practice-container"><div class="lists-section"><h2 class="welcome-title">My Word Lists</h2><div id="custom-lists-container" class="custom-lists-container"></div></div><div class="practice-section"><h2 class="welcome-title">Create Custom Word List</h2><div class="list-name-section"><input type="text" id="custom-list-name" class="list-name-input" placeholder="List Name"></div><textarea id="custom-word-input" placeholder="Enter words, separated by commas or newlines"></textarea><div class="word-input-actions"><button onclick="processCustomWords()" class="main-button"><i class="fas fa-magic"></i> Make</button> <button onclick="saveCurrentList()" class="main-button"><i class="fas fa-save"></i> Save</button> <button onclick="addNewWord()" class="main-button"><i class="fas fa-plus"></i> Add Word</button></div><div class="translation-results" id="translation-results"><div class="word-translation-list" id="word-translation-list"></div></div></div></div></div><div id="upgrade-screen" class="screen"><div class="upgrade-modal"><div class="upgrade-form"><h2>×©×“×¨×•×’ ×œ×¤×¨×™×ž×™×•×</h2><form id="upgradeForm" onsubmit="handleUpgradeSubmit(event)"><div class="form-group"><label><input type="checkbox" id="isAdult" onchange="toggleParentFields()" name="isAdult"> ×× ×™ ×ž×¢×œ ×’×™×œ 18</label></div><div id="parentInfoSection"><div class="form-group"><label>×©× ×ž×œ× ×©×œ ×”×•×¨×”</label> <input type="text" id="parentName" name="parentName"></div><div class="form-group"><label>×ž×¡×¤×¨ ×˜×œ×¤×•×Ÿ ×©×œ ×”×•×¨×”</label> <input type="tel" id="parentPhone" name="parentPhone" pattern="[0-9]{10}" placeholder="×”×–×Ÿ ×ž×¡×¤×¨ ×˜×œ×¤×•×Ÿ ×©×œ ×”×•×¨×”"></div></div><div id="adultInfoSection" style="display:none"><div class="form-group"><label>×©× ×ž×œ×</label> <input type="text" id="fullName" name="fullName"></div><div class="form-group"><label>×ž×¡×¤×¨ ×˜×œ×¤×•×Ÿ</label> <input type="tel" id="phone" name="phone" pattern="[0-9]{10}" placeholder="×”×–×Ÿ ×ž×¡×¤×¨ ×˜×œ×¤×•×Ÿ"></div></div><div class="form-group"><label>××™×š ×©×ž×¢×ª ×¢×œ×™× ×•?</label> <select id="referralSource" name="referralSource"><option value="friend">×—×‘×¨/×”</option><option value="teacher">×ž×•×¨×”</option><option value="social">×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª</option><option value="other">××—×¨</option></select></div><button type="submit" class="submit-button">×©×œ×—/×™ ×‘×§×©×”</button> <button type="button" class="skip-button" onclick="skipUpgrade()">×“×œ×’</button></form><p>×œ××—×¨ ×©×œ×™×—×ª ×”×‘×§×©×” × ×™×¦×•×¨ ××™×ª×š ×§×©×¨ ×‘×•×•×˜×¡××¤</p></div></div></div><div id="leaderboard-screen" class="screen"><div class="navigation-container"><button class="navigation-button home-button" onclick='showScreen("welcome-screen")'><i class="fas fa-home navigation-icon"></i></button></div><h1 class="welcome-title">Speedboard</h1><div class="leaderboard-header"><div>Rank</div><div>Player</div><div>Status</div></div><div id="leaderboard-entries"></div></div><div id="arcade-modal" class="modal"><div class="modal-content"><div id="teacher-view" style="display:none"><h2>Your OTP: <span id="otp"></span></h2><p>Players: <span id="player-count">0</span></p><div class="stage-selector"><h3>Select Word Pools:</h3><div class="stage-checkboxes"><label><input type="checkbox" value="1"> Stage 1</label> <label><input type="checkbox" value="2"> Stage 2</label> <label><input type="checkbox" value="3"> Stage 3</label> <label><input type="checkbox" value="4"> Stage 4</label> <label><input type="checkbox" value="5"> Stage 5</label></div><p class="stage-warning" style="display:none;color:var(--error)">Please select at least one stage</p></div><div class="word-goal"><h3>Word Goal: <span id="wordGoalDisplay">50</span> words</h3><div class="slider-container"><input type="range" min="1" max="200" value="50" class="word-goal-slider" id="wordGoalSlider"><div class="slider-stops"><span class="slider-stop" data-value="0">0</span> <span class="slider-stop" data-value="50">50</span> <span class="slider-stop" data-value="100">100</span> <span class="slider-stop" data-value="150">150</span> <span class="slider-stop" data-value="200">200</span></div></div><input type="number" id="wordGoalInput" min="1" max="200" value="50" class="word-goal-input"></div><button class="start-button" onclick="startArcade()">Start</button></div><div id="player-view" style="display:none"><h2>Join Arcade</h2><div class="input-group"><input type="text" id="arcadeUsername" placeholder="Choose your username" maxlength="15"> <input type="text" id="otpInput" placeholder="Enter 4-digit Game Code" maxlength="4" pattern="[0-9]{4}" inputmode="numeric"></div><button class="join-button" onclick="joinArcadeWithUsername()">Join Game</button></div></div></div><div id="waiting-screen" class="screen"><div class="waiting-container"><div class="spinner-container"><div class="spinner"></div></div><h2 class="waiting-title">Waiting for Game to Start...</h2><div class="floating-particles"></div></div></div><div id="moderator-screen" class="screen"><div class="moderator-container"><div class="session-info-panel"><div class="session-details"><h2>Arcade Session</h2><div class="otp-display" id="moderatorOtp"></div><div class="qr-section"><canvas id="qrCode"></canvas><p class="qr-hint">Scan to join game</p></div><div class="session-metadata"><p>Date: <span id="sessionDate"></span></p><p>Start Time: <span id="sessionStartTime"></span></p><p>Word Goal: <span id="sessionWordGoal"></span></p><p>Active Participants: <span id="activeParticipantCount">0</span></p></div><div class="game-controls"><button class="start-button initialize-button" onclick="initializeArcade()">Initialize Arcade</button> <button class="end-arcade-button" onclick="endArcade()">End Arcade</button></div></div></div><div class="leaderboard-panel"><div id="arcade-leaderboard" class="moderator-leaderboard"><div class="leaderboard-header"><div>Rank</div><div>Player</div><div>Words</div><div>Coins</div><div>Actions</div></div></div></div></div></div><div id="remove-player-modal" class="modal"><div class="modal-content"><h3>Remove Player</h3><p>Remove <span id="player-to-remove"></span> from the game?</p><div class="modal-buttons"><button class="start-button" onclick="confirmRemovePlayer()">Remove</button> <button class="start-button secondary" onclick="closeRemoveModal()">Cancel</button></div></div></div><button class="accessibility-toggle" aria-label="Open accessibility menu"><i class="fas fa-universal-access"></i></button><div class="accessibility-modal"><div class="accessibility-content"><div class="accessibility-header"><h2>Accessibility Options</h2><button class="close-accessibility" aria-label="Close accessibility menu"><i class="fas fa-times"></i></button></div><div class="accessibility-options"><div class="accessibility-section"><h3>Display</h3><div class="option-group"><label for="contrast-setting">Contrast</label><div class="controls"><button class="accessibility-button" data-action="contrast" data-value="normal">Normal</button> <button class="accessibility-button" data-action="contrast" data-value="high">High</button> <button class="accessibility-button" data-action="contrast" data-value="inverted">Inverted</button></div></div><div class="option-group"><label>Theme</label><div class="controls"><button class="accessibility-button" data-action="theme" data-value="default">Default</button> <button class="accessibility-button" data-action="theme" data-value="light">Light</button> <button class="accessibility-button" data-action="theme" data-value="dark">Dark</button></div></div><div class="option-group"><label>Saturation</label><div class="controls"><button class="accessibility-button" data-action="saturation" data-value="normal">Normal</button> <button class="accessibility-button" data-action="saturation" data-value="grayscale">Grayscale</button></div></div></div><div class="accessibility-section"><h3>Text</h3><div class="option-group"><label>Font Size</label><div class="controls"><button class="accessibility-button" data-action="fontSize" data-value="decrease"><i class="fas fa-minus"></i></button> <button class="accessibility-button" data-action="fontSize" data-value="reset">Reset</button> <button class="accessibility-button" data-action="fontSize" data-value="increase"><i class="fas fa-plus"></i></button></div></div><div class="option-group"><label>Font Type</label><div class="controls"><button class="accessibility-button" data-action="fontFamily" data-value="default">Default</button> <button class="accessibility-button" data-action="fontFamily" data-value="dyslexic">Dyslexia Friendly</button></div></div><div class="option-group"><label>Letter Spacing</label><div class="controls"><button class="accessibility-button" data-action="letterSpacing" data-value="normal">Normal</button> <button class="accessibility-button" data-action="letterSpacing" data-value="increased">Increased</button></div></div></div><div class="accessibility-section"><h3>Motion & Navigation</h3><div class="option-group"><label>Animations</label><div class="controls"><button class="accessibility-button" data-action="animations" data-value="enabled">Enabled</button> <button class="accessibility-button" data-action="animations" data-value="reduced">Reduced</button> <button class="accessibility-button" data-action="animations" data-value="disabled">Disabled</button></div></div><div class="option-group"><label>Focus Indicator</label><div class="controls"><button class="accessibility-button" data-action="focus" data-value="normal">Normal</button> <button class="accessibility-button" data-action="focus" data-value="high">Enhanced</button></div></div></div><div class="accessibility-section"><h3>Interface</h3><div class="option-group"><label>Button Size</label><div class="controls"><button class="accessibility-button" data-action="buttonSize" data-value="normal">Normal</button> <button class="accessibility-button" data-action="buttonSize" data-value="large">Large</button></div></div><div class="option-group"><label>Cursor Size</label><div class="controls"><button class="accessibility-button" data-action="cursorSize" data-value="normal">Normal</button> <button class="accessibility-button" data-action="cursorSize" data-value="large">Large</button></div></div></div></div><div class="accessibility-footer"><button class="accessibility-button reset-all" data-action="reset" data-value="all">Reset All Settings</button></div></div></div><script>document.addEventListener("progressSaved",(e=>{const t=document.getElementById("stage-cascade-screen");t&&t.classList.contains("visible")&&(console.log("Refreshing stage cascade screen after progress save"),renderStageCascadeScreen())})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".logout-button");e&&e.addEventListener("click",handleLogout)})),document.addEventListener("click",(e=>{const t=document.querySelector(".side-panel"),n=document.querySelector(".hamburger-button");!t.classList.contains("open")||t.contains(e.target)||n.contains(e.target)||toggleSidePanel()})),document.addEventListener("DOMContentLoaded",(()=>{new Set}));const ParticleSystem={particlePool:[],maxParticles:20,init(){for(let e=0;e<this.maxParticles;e++){const e=document.createElement("div");e.className="particle mobile-particle",this.particlePool.push(e)}},createParticle(e,t){if(window.innerWidth<=768)return;const n=this.particlePool.pop();n&&(n.style.left=`${e}px`,n.style.top=`${t}px`,setTimeout((()=>{this.particlePool.push(n)}),500))}},CustomListsManager={lists:[],async initialize(){try{currentUser?await this.loadFromSupabase():this.loadFromLocalStorage(),this.lists&&0!==this.lists.length||(console.log("No lists found, initializing empty array"),this.lists=[])}catch(e){console.error("Custom Lists Initialization Error:",e),this.lists=[]}},async loadFromSupabase(){try{const{data:e,error:t}=await supabaseClient.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`);if(t)throw t;this.lists=e.map((e=>({id:e.id,name:e.name,words:e.words||[],translations:e.translations||[],isShared:e.is_shared,sharedBy:e.shared_by,userId:e.user_id,createdAt:e.created_at})))}catch(e){console.error("Error loading lists from Supabase:",e),this.lists=[]}},loadFromLocalStorage(){try{const e=localStorage.getItem("simploxCustomLists");this.lists=e?JSON.parse(e):[],console.log("Loaded lists from localStorage:",this.lists.length)}catch(e){console.error("Error loading lists from localStorage:",e),this.lists=[]}},async save(e){return e?currentUser?await this.saveToSupabase(e):this.saveToLocalStorage(e):null},async saveToSupabase(e){try{const t={name:e.name,words:e.words||[],translations:e.translations||[],user_id:currentUser.id};if(e.id&&"string"==typeof e.id&&36===e.id.length){const{data:n,error:r}=await supabaseClient.from("custom_lists").update(t).eq("id",e.id).select().single();if(r)throw r;return n}{const{data:n,error:r}=await supabaseClient.from("custom_lists").insert(t).select().single();if(r)throw r;const s=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==s?this.lists[s]={...n,words:n.words||[],translations:n.translations||[]}:this.lists.push({...n,words:n.words||[],translations:n.translations||[]}),n}}catch(e){return console.error("Error saving list to Supabase:",e),null}},saveToLocalStorage(e){try{const t={...e,id:e.id||Date.now(),tempId:e.tempId||Date.now()},n=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==n?this.lists[n]=t:this.lists.push(t),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),t}catch(e){return console.error("Error saving list to localStorage:",e),null}},async delete(e){if(!currentUser)return this.lists=this.lists.filter((t=>t.id!==e)),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),!0;try{if("string"==typeof e&&36===e.length){const{error:t}=await supabaseClient.from("custom_lists").delete().eq("id",e);if(t)throw t}return this.lists=this.lists.filter((t=>t.id!==e)),!0}catch(e){return console.error("Error deleting list from Supabase:",e),!1}},async share(e,t){if(!currentUser)return!1;try{const n=String(e),r=this.lists.find((e=>String(e.id)===n));if(!r)return console.error("List not found for sharing:",n),!1;console.log("Sharing list:",r.name);const{data:s,error:o}=await supabaseClient.rpc("insert_shared_list",{p_user_id:t,p_name:`${r.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,p_words:r.words||[],p_translations:r.translations||[],p_is_shared:!0,p_local_id:Date.now(),p_shared_with:[t],p_shared_by:currentUser.id});return o?(console.error("Error sharing list via RPC:",o),!1):(console.log("List shared successfully:",s),!0)}catch(e){return console.error("Error in share method:",e),!1}},getListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"};switch(currentUser.status||"free"){case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"âˆž"};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"âˆž"};case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1,playDisplay:"10"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"}}},canCreateMoreLists(){const e=this.getListLimits();return this.lists.length<e.maxLists},validateListForPractice:e=>e&&e.words&&e.translations?e.words.length<6?{valid:!1,message:"Lists need at least 6 words to practice"}:{valid:!0}:{valid:!1,message:"Invalid list format"}},customGameState={isCustomPractice:!1,currentList:null,currentLevel:1,levelData:null,words:[],translations:[],wordsCompleted:0,correctStreak:0,wrongStreak:0,startCoins:0,completedLevels:new Set,reset(){this.isCustomPractice=!1,this.currentList=null,this.currentLevel=1,this.levelData=null,this.words=[],this.translations=[],this.wordsCompleted=0,this.correctStreak=0,this.wrongStreak=0,this.startCoins=0,this.completedLevels=new Set},initializeFromList(e){return e&&e.words&&e.translations?(this.reset(),this.isCustomPractice=!0,this.currentList=e,this.words=[...e.words],this.translations=[...e.translations],this.startCoins=gameState.coins,this.currentLevel=1,!0):(console.error("Invalid list provided to custom game:",e),!1)},getWordsForLevel(e){if(!this.words.length)return null;const t=this.words.length>=12?9:this.words.length>=9?6:3;if(e>t)return null;const n={1:{start:0,count:Math.min(3,this.words.length),isTest:!1},2:{start:3,count:Math.min(3,Math.max(0,this.words.length-3)),isTest:!1},3:{start:0,count:Math.min(6,this.words.length),isTest:!0},4:{start:6,count:Math.min(3,Math.max(0,this.words.length-6)),isTest:!1},5:{start:9,count:Math.min(3,Math.max(0,this.words.length-9)),isTest:!1},6:{start:6,count:Math.min(6,Math.max(0,this.words.length-6)),isTest:!0},7:{start:12,count:Math.min(4,Math.max(0,this.words.length-12)),isTest:!1},8:{start:16,count:Math.min(4,Math.max(0,this.words.length-16)),isTest:!1},9:{start:12,count:Math.min(8,Math.max(0,this.words.length-12)),isTest:!0}},r=n[e]||n[1];return r.count<=0?this.getWordsForLevel(e+1):(this.levelData={words:this.words.slice(r.start,r.start+r.count),translations:this.translations.slice(r.start,r.start+r.count),isTest:r.isTest,isFinal:e===t},this.levelData)}},currentArcadeSessionStructure={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],startTime:null,endTime:null,podiumRanks:{},playerName:null,winnerScreenShown:!1};function updateUI(){requestAnimationFrame((()=>{const e=document.createDocumentFragment();document.body.appendChild(e)}))}document.addEventListener("click",(e=>{const t=e.target;t.matches(".game-btn")?handleButtonClick(t):t.matches(".level")&&handleLevelClick(t)}));const CoinsManager={displayElements:new Set,initialize(){this.displayElements.clear(),document.querySelectorAll(".coin-count").forEach((e=>{this.displayElements.add(e)}))},async loadUserCoins(){if(!currentUser)return parseInt(localStorage.getItem("simploxCustomCoins")||"0");try{const{data:e,error:t}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();if(t)throw t;return e.coins||0}catch(e){return console.error("Error loading coins:",e),0}},async updateCoins(e){try{const t=gameState.coins,n=t+e;if(gameState.coins=n,this.displayElements.forEach((r=>{let s=t;const o=performance.now();requestAnimationFrame((function a(i){const c=i-o,l=Math.min(c/1e3,1);s=t+(n-t)*l,r.textContent=Math.round(s),e>0?r.style.color="var(--success)":e<0&&(r.style.color="var(--error)"),l<1?requestAnimationFrame(a):(r.textContent=n,setTimeout((()=>{r.style.color="var(--text)"}),300))}))})),currentUser){const{error:e}=await supabaseClient.from("game_progress").update({coins:n}).eq("user_id",currentUser.id);if(e)throw e}else localStorage.setItem("simploxCustomCoins",n.toString());return updatePerkButtons(),!0}catch(t){return console.error("Failed to update coins:",t),this.displayElements.forEach((t=>{t.textContent=gameState.coins-e})),updatePerkButtons(),!1}},updateDisplays(){this.displayElements.forEach((e=>{e.textContent=gameState.coins})),updatePerkButtons()}},WordsManager={displayElements:new Set,initialize(){this.displayElements.clear(),document.querySelectorAll("#totalWords").forEach((e=>{this.displayElements.add(e)}))},async loadUserWords(){if(!currentUser)return 0;try{const{data:e,error:t}=await supabaseClient.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();if(t)throw t;return e?.unique_words_practiced||0}catch(e){return console.error("Error loading words:",e),0}},async updateWords(e){try{const t=parseInt(document.getElementById("totalWords").textContent)||0,n=t+e;if(this.displayElements.forEach((e=>{let r=t;const s=performance.now();requestAnimationFrame((function o(a){const i=a-s,c=Math.min(i/1e3,1);r=t+(n-t)*c,e.textContent=Math.round(r),c<1?requestAnimationFrame(o):e.textContent=n}))})),currentUser&&"premium"===currentUser.status){const{error:e}=await supabaseClient.from("player_stats").update({unique_words_practiced:n}).eq("user_id",currentUser.id);if(e)throw e}return!0}catch(e){return console.error("Failed to update words:",e),!1}},updateDisplays(e){this.displayElements.forEach((t=>{t.textContent=e}))}},perkButtons={timeFreeze:document.getElementById("timeFreezePerk"),skip:document.getElementById("skipPerk"),clue:document.getElementById("cluePerk"),reveal:document.getElementById("revealPerk")};Object.entries(perkButtons).forEach((([e,t])=>{t&&(t.onclick=()=>buyPerk(e))}));const GameTimer={lastTick:0,update(e){this.lastTick||(this.lastTick=e);e-this.lastTick>=1e3&&(this.updateTimer(),this.lastTick=e),requestAnimationFrame(this.update.bind(this))}};function cleanupLevel(){document.querySelectorAll(".buttons button").forEach((e=>{e.onclick=null})),ParticleSystem.clear(),clearTimeout(levelTimeout)}async function transitionScreen(e){const t=document.querySelector(".screen.visible");t&&(t.style.opacity=0,await new Promise((e=>setTimeout(e,300))),t.style.display="none");const n=document.getElementById(`${e}-screen`);n.style.display="flex",requestAnimationFrame((()=>{n.style.opacity=1}))}const GameCache={words:new Map,async getWords(e){if(this.words.has(e))return this.words.get(e);const t=await loadWords(e);return this.words.set(e,t),t}},gameInit={async init(){if(console.log("Game initialization starting"),await checkExistingSession(),currentUser){console.log("User is logged in, checking database schema");await ensureCorrectSchema()?(console.log("Schema is OK, loading progress from database"),await loadUserGameProgress(currentUser.id)):(console.log("Schema issues detected, loading from localStorage and initializing defaults"),initializeGame())}else console.log("No user logged in, initializing local game state"),initializeGame();updatePerkButtons(),initializeParticles(document.getElementById("welcome-screen")),await loadCustomLists(),setupAutoSave(),console.log("Game initialization complete. Game state:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel,unlockedSets:Object.keys(gameState.unlockedSets||{}),unlockedLevels:Object.keys(gameState.unlockedLevels||{})})}};document.addEventListener("DOMContentLoaded",(()=>{gameInit.init()}));const{createClient:createClient}=supabase,supabaseClient=createClient("https://mczfgzffyyyacisrccqb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jemZnemZmeXl5YWNpc3JjY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzODYyMDQsImV4cCI6MjA1Mzk2MjIwNH0.rLga_B29Coz1LMeJzFTGLIhckdcojGXnD1ae1bw-QAI",{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0});function showJoinModal(e=""){console.log("Opening join modal with OTP:",e);const t=document.getElementById("arcade-modal"),n=document.getElementById("teacher-view"),r=document.getElementById("player-view"),s=document.getElementById("otpInput");if(t&&(t.style.display="block",n&&(n.style.display="none"),r&&(r.style.display="block"),s&&e)){s.value=e;const t=document.getElementById("arcadeUsername");t&&setTimeout((()=>t.focus()),300)}}async function handleSignup(){const e=document.getElementById("signupEmail").value,t=document.getElementById("signupUsername").value,n=document.getElementById("signupPassword").value;if(e&&t&&n)try{const{data:r,error:s}=await supabaseClient.auth.signUp({email:e,password:n,options:{data:{username:t,full_name:t}}});if(s)throw s;const{error:o}=await supabaseClient.from("user_profiles").upsert({id:r.user.id,username:t,email:e,status:"free",role:"student"},{onConflict:"id"});o&&console.error("Profile upsert error:",o);const a={user_id:r.user.id,stage:1,set_number:1,level:1,coins:0},{error:i}=await supabaseClient.from("game_progress").insert([a]);i&&console.error("Progress initialization error:",i);const{data:c,error:l}=await supabaseClient.auth.signInWithPassword({email:e,password:n});if(l)throw l;hideAuthModal(),currentUser=c.user,gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.perks={},gameState.unlockedSets={1:new Set([1])},gameState.unlockedLevels={"1_1":new Set([1])},gameState.perfectLevels=new Set,gameState.completedLevels=new Set,updateAuthUI(),showScreen("welcome-screen")}catch(e){console.error("Detailed signup error:",e),e.message&&e.message.includes("duplicate key")?alert("This username or email is already taken. Please try another."):alert("Signup error: "+e.message)}else alert("All fields are required")}async function updateUserCoins(e){const t=gameState.coins;if(gameState.coins+=e,updateAllCoinDisplays(),updatePerkButtons(),currentUser)try{const{error:e}=await supabaseClient.from("game_progress").update({coins:gameState.coins}).eq("user_id",currentUser.id);if(e)return console.error("Failed to update coins in database:",e),gameState.coins=t,updateAllCoinDisplays(),updatePerkButtons(),!1}catch(e){return console.error("Error updating coins:",e),gameState.coins=t,updateAllCoinDisplays(),updatePerkButtons(),!1}const n=JSON.parse(localStorage.getItem("simploxProgress")||"{}");return n.coins=gameState.coins,localStorage.setItem("simploxProgress",JSON.stringify(n)),!0}async function checkAndFixDatabaseSchema(){if(!currentUser)return!1;try{const{data:e,error:t}=await supabaseClient.from("game_progress").select("*").eq("user_id",currentUser.id).single();if(t)return console.error("Error checking database schema:",t),!1;const n=!("completed_levels"in e),r=!("perfect_levels"in e);if(!n&&!r)return console.log("Database schema is up to date"),!0;console.log("Adding missing columns to database schema");const s={user_id:currentUser.id,stage:e.stage||1,set_number:e.set_number||1,level:e.level||1};"coins"in e&&(s.coins=e.coins||0),"unlocked_sets"in e&&(s.unlocked_sets=e.unlocked_sets||{}),"unlocked_levels"in e&&(s.unlocked_levels=e.unlocked_levels||{}),n&&(s.completed_levels=[]),r&&(s.perfect_levels=[]);const{error:o}=await supabaseClient.from("game_progress").update(s).eq("user_id",currentUser.id);return o?(console.error("Failed to update database schema:",o),!1):(console.log("Database schema successfully updated"),!0)}catch(e){return console.error("Error fixing database schema:",e),!1}}async function initializeGameProgressForUser(e){const{error:t}=await supabaseClient.from("game_progress").insert({user_id:e,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]});t&&console.error("Error initializing game progress:",t)}async function handleLogin(){const e=document.getElementById("loginUsername").value,t=document.getElementById("loginPassword").value;if(e&&t)try{let n;if(e.includes("@"))n=supabaseClient.auth.signInWithPassword({email:e,password:t});else{const{data:r,error:s}=await supabaseClient.from("user_profiles").select("email").eq("username",e).single();if(s||!r)return void alert("Username not found");n=supabaseClient.auth.signInWithPassword({email:r.email,password:t})}const{data:r,error:s}=await n;if(s)return console.error("Login Error:",s),void alert(s.message);if(r.user){currentUser=r.user,hideAuthModal();const{data:e}=await supabaseClient.from("user_profiles").select("status").eq("id",currentUser.id).single();e&&(currentUser.status=e.status,updateUserStatusDisplay(e.status)),await Promise.all([loadCustomLists(),loadUserGameProgress(currentUser.id)]),updateAuthUI(),updateGuestPlayButton(),showScreen("welcome-screen")}}catch(e){console.error("Unexpected Login Error:",e),alert("An unexpected error occurred during login")}else alert("Please enter both username/email and password")}function initializeGame(){console.log("Initializing game state"),gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.perks={},gameState.unlockedSets={},gameState.unlockedLevels={},gameState.perfectLevels=new Set,gameState.completedLevels=new Set;const e=localStorage.getItem("simploxProgress");if(e)try{console.log("Found saved progress in localStorage");const t=JSON.parse(e);t.stage&&(gameState.currentStage=t.stage),t.set_number&&(gameState.currentSet=t.set_number),t.level&&(gameState.currentLevel=t.level),t.coins&&(gameState.coins=t.coins),t.perks&&(gameState.perks=t.perks),t.unlocked_sets&&Object.entries(t.unlocked_sets).forEach((([e,t])=>{gameState.unlockedSets[e]=new Set(Array.isArray(t)?t:[])})),t.unlocked_levels&&Object.entries(t.unlocked_levels).forEach((([e,t])=>{gameState.unlockedLevels[e]=new Set(Array.isArray(t)?t:[])})),t.perfect_levels&&(gameState.perfectLevels=new Set(t.perfect_levels)),t.completed_levels&&(gameState.completedLevels=new Set(t.completed_levels)),console.log("Loaded progress from localStorage:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel})}catch(e){console.error("Error parsing saved progress:",e)}const t=localStorage.getItem("gameContext");if(t)try{const e=JSON.parse(t);Date.now()-(e.timestamp||0)<864e5&&(console.log("Found recent game context, updating current location:",e),e.stage&&(gameState.currentStage=e.stage),e.set&&(gameState.currentSet=e.set),e.level&&(gameState.currentLevel=e.level))}catch(e){console.error("Error parsing saved context:",e)}setupDefaultUnlocks(),updateAllCoinDisplays(),updatePerkButtons(),console.log("Game initialized with state:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel})}function setupDefaultUnlocks(){gameState.unlockedSets[1]||(gameState.unlockedSets[1]=new Set);for(let e=1;e<=9;e++){gameState.unlockedSets[1].add(e);const t=`1_${e}`;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set([1]))}for(let e=2;e<=5;e++){gameState.unlockedSets[e]||(gameState.unlockedSets[e]=new Set([1]));const t=`${e}_1`;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set([1]))}}async function loadUserGameProgress(e){console.log("Loading game progress for user:",e);try{gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.perks={},gameState.unlockedSets={1:new Set([1])},gameState.unlockedLevels={"1_1":new Set([1])},gameState.perfectLevels=new Set,gameState.completedLevels=new Set;const t=localStorage.getItem("simploxProgress");if(t)try{const e=JSON.parse(t);console.log("Found progress in localStorage:",e),e.stage&&(gameState.currentStage=e.stage),e.set_number&&(gameState.currentSet=e.set_number),e.level&&(gameState.currentLevel=e.level),e.coins&&(gameState.coins=e.coins),e.perks&&(gameState.perks=e.perks),e.unlocked_sets&&(gameState.unlockedSets={},Object.entries(e.unlocked_sets).forEach((([e,t])=>{gameState.unlockedSets[e]=new Set(t)}))),e.unlocked_levels&&(gameState.unlockedLevels={},Object.entries(e.unlocked_levels).forEach((([e,t])=>{gameState.unlockedLevels[e]=new Set(t)}))),e.perfect_levels&&(gameState.perfectLevels=new Set(e.perfect_levels)),e.completed_levels&&(gameState.completedLevels=new Set(e.completed_levels))}catch(e){console.error("Error parsing localStorage progress:",e)}const{data:n,error:r}=await supabaseClient.from("game_progress").select("*").eq("user_id",e).single();if(r)if("PGRST116"===r.code){console.log("No progress record found, creating initial progress");const t={user_id:e,stage:gameState.currentStage,set_number:gameState.currentSet,level:gameState.currentLevel,coins:gameState.coins},{error:n}=await supabaseClient.from("game_progress").insert([t]);n&&console.error("Error creating initial game progress:",n)}else console.error("Error loading game progress:",r);else if(n){console.log("Game progress loaded from database:",n),gameState.currentStage=n.stage||gameState.currentStage,gameState.currentSet=n.set_number||gameState.currentSet,gameState.currentLevel=n.level||gameState.currentLevel,gameState.coins=n.coins||gameState.coins;try{n.perks&&Object.keys(n.perks).length>0&&(gameState.perks=n.perks),n.unlocked_sets&&Object.keys(n.unlocked_sets).length>0&&(gameState.unlockedSets={},Object.entries(n.unlocked_sets).forEach((([e,t])=>{gameState.unlockedSets[e]=new Set(t)}))),n.unlocked_levels&&Object.keys(n.unlocked_levels).length>0&&(gameState.unlockedLevels={},Object.entries(n.unlocked_levels).forEach((([e,t])=>{gameState.unlockedLevels[e]=new Set(t)}))),n.perfect_levels&&n.perfect_levels.length>0&&(gameState.perfectLevels=new Set(n.perfect_levels)),n.completed_levels&&n.completed_levels.length>0&&(gameState.completedLevels=new Set(n.completed_levels))}catch(e){console.error("Error loading extended fields from database:",e)}}return setupDefaultUnlocks(),console.log("Game state after loading progress:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel}),updateAllCoinDisplays(),!0}catch(e){return console.error("Unexpected error in loadUserGameProgress:",e),!1}}function debugUnlockState(){console.group("Current Game State"),console.log("Current Stage:",gameState.currentStage),console.log("Current Set:",gameState.currentSet),console.log("Current Level:",gameState.currentLevel),console.group("Unlocked Sets"),Object.entries(gameState.unlockedSets).forEach((([e,t])=>{console.log(`Stage ${e}:`,Array.from(t).sort(((e,t)=>e-t)))})),console.groupEnd(),console.group("Unlocked Levels"),Object.entries(gameState.unlockedLevels).forEach((([e,t])=>{console.log(`Set ${e}:`,Array.from(t).sort(((e,t)=>e-t)))})),console.groupEnd(),console.log("Completed Levels:",Array.from(gameState.completedLevels)),console.log("Perfect Levels:",Array.from(gameState.perfectLevels)),console.groupEnd()}async function handleLogout(){try{const{error:e}=await supabaseClient.auth.signOut();e&&console.error("Supabase logout error:",e.message),gameState.coins=0,gameState.unlockedSets={},gameState.unlockedLevels={},gameState.perfectLevels=new Set,gameState.completedLevels=new Set,clearCustomPracticeUI(),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),showScreen("welcome-screen")}catch(e){console.error("Unexpected error during logout:",e),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),showScreen("welcome-screen")}}function clearCustomPracticeUI(){const e=document.getElementById("custom-list-name");e&&(e.value="");const t=document.getElementById("custom-word-input");t&&(t.value="");const n=document.getElementById("translation-results");n&&(n.style.display="none");const r=document.getElementById("word-translation-list");r&&(r.innerHTML=""),customPracticeLists.currentList=null,customPracticeLists.lists=[]}function saveProgress(){if(console.log("Saving game progress"),!gameState.currentStage)return void console.log("No game state to save");const e={stage:gameState.currentStage||1,set_number:gameState.currentSet||1,level:gameState.currentLevel||1,coins:gameState.coins||0},t={perks:gameState.perks||{},unlocked_sets:Object.fromEntries(Object.entries(gameState.unlockedSets||{}).map((([e,t])=>[e,Array.from(t||[])]))),unlocked_levels:Object.fromEntries(Object.entries(gameState.unlockedLevels||{}).map((([e,t])=>[e,Array.from(t||[])]))),perfect_levels:Array.from(gameState.perfectLevels||[]),completed_levels:Array.from(gameState.completedLevels||[])};localStorage.setItem("simploxProgress",JSON.stringify({...e,...t}));const n={stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(n)),currentUser&&(console.log("Saving progress to Supabase for user:",currentUser.id),supabaseClient.from("game_progress").upsert({user_id:currentUser.id,...e}).then((({error:e})=>{if(e)console.error("Error saving core progress:",e);else{console.log("Core progress saved successfully");const e=(e,t)=>{const n={[e]:t};supabaseClient.from("game_progress").update(n).eq("user_id",currentUser.id).then((({error:t})=>{t?console.warn(`Error saving ${e}:`,t):console.log(`${e} saved successfully`)}))};Object.entries(t).forEach((([t,n])=>{e(t,n)}))}})))}async function ensureCorrectSchema(){if(!currentUser)return!1;console.log("Checking database schema for user:",currentUser.id);try{const{data:e,error:t}=await supabaseClient.from("game_progress").select("*").eq("user_id",currentUser.id).single();if(t){if("PGRST116"===t.code){console.log("Creating game progress record for user");const e={user_id:currentUser.id,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]},{error:t}=await supabaseClient.from("game_progress").insert([e]);return!t||(console.error("Error creating game progress record:",t),!1)}return console.error("Error checking game progress record:",t),!1}let n=!1;const r={...e},s=[{name:"unlocked_sets",defaultValue:{1:[1]}},{name:"unlocked_levels",defaultValue:{"1_1":[1]}},{name:"perfect_levels",defaultValue:[]},{name:"completed_levels",defaultValue:[]}];for(const t of s)t.name in e&&null!==e[t.name]||(r[t.name]=t.defaultValue,n=!0,console.log(`Field "${t.name}" missing, will add it`));if(n){console.log("Updating record with missing fields");const{error:e}=await supabaseClient.from("game_progress").update(r).eq("user_id",currentUser.id);if(e)return console.error("Error updating game progress record:",e),!1}return!0}catch(e){return console.error("Unexpected error in ensureCorrectSchema:",e),!1}}async function saveCustomList(){const e=document.getElementById("custom-list-name").value.trim()||`List ${customPracticeLists.lists.length+1}`,t=document.querySelectorAll(".word-translation-item"),n=[],r=[];t.forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),s=e.querySelector(".target-word").value.trim();t&&s&&(n.push(t),r.push(s))}));const s={id:customPracticeLists.currentList?customPracticeLists.currentList.id:Date.now(),name:e,words:n,translations:r};if(customPracticeLists.currentList){const e=customPracticeLists.lists.findIndex((e=>e.id===customPracticeLists.currentList.id));-1!==e?customPracticeLists.lists[e]=s:customPracticeLists.lists.push(s)}else customPracticeLists.lists.push(s);customPracticeLists.currentList=null,currentUser?await saveCustomListToSupabase(s):localStorage.setItem("simploxCustomLists",JSON.stringify(customPracticeLists.lists)),showCustomListsManager()}async function loadCustomLists(){try{currentUser?await CustomListsManager.loadFromSupabase():CustomListsManager.loadFromLocalStorage(),updateListsDisplay()}catch(e){console.error("Error loading custom lists:",e)}}function switchAuthTab(e){const t=document.querySelector(".auth-tab[onclick=\"switchAuthTab('login')\"]"),n=document.querySelector(".auth-tab[onclick=\"switchAuthTab('signup')\"]"),r=document.getElementById("loginForm"),s=document.getElementById("signupForm");"login"===e?(t.classList.add("active"),n.classList.remove("active"),r.classList.remove("hidden"),s.classList.add("hidden")):(t.classList.remove("active"),n.classList.add("active"),r.classList.add("hidden"),s.classList.remove("hidden"))}function updateAuthUI(){const e=document.getElementById("authBox"),t=document.getElementById("userInfo"),n=document.getElementById("userEmail"),r=document.querySelector(".logout-button");currentUser?(e.classList.add("hidden"),t.classList.remove("hidden"),r.classList.remove("hidden"),n.textContent=currentUser.user_metadata?.username||currentUser.email,supabaseClient.from("user_profiles").select("status, username").eq("id",currentUser.id).single().then((({data:e})=>{e&&(e.username&&(n.textContent=e.username),updateUserStatusDisplay(e.status))})).catch((e=>console.error("Error fetching user status:",e)))):(e.classList.remove("hidden"),t.classList.add("hidden"),r.classList.add("hidden"),n.textContent="")}document.addEventListener("DOMContentLoaded",(async()=>{try{if(window.CustomListsManager||(window.CustomListsManager={lists:[],async initialize(){currentUser?await this.loadFromSupabase():this.loadFromLocalStorage()},async loadFromSupabase(){try{const{data:e,error:t}=await supabaseClient.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`);if(t)throw t;this.lists=e.map((e=>({id:e.id,name:e.name,words:e.words||[],translations:e.translations||[],isShared:e.is_shared,sharedBy:e.shared_by,userId:e.user_id,createdAt:e.created_at}))),console.log("Loaded lists from Supabase:",this.lists.length)}catch(e){console.error("Error loading lists from Supabase:",e),this.lists=[]}},loadFromLocalStorage(){try{const e=localStorage.getItem("simploxCustomLists");this.lists=e?JSON.parse(e):[],console.log("Loaded lists from localStorage:",this.lists.length)}catch(e){console.error("Error loading lists from localStorage:",e),this.lists=[]}},async save(e){return e?currentUser?await this.saveToSupabase(e):this.saveToLocalStorage(e):null},async saveToSupabase(e){try{const t={name:e.name,words:e.words||[],translations:e.translations||[],user_id:currentUser.id};if(e.id&&"string"==typeof e.id&&36===e.id.length){const{data:n,error:r}=await supabaseClient.from("custom_lists").update(t).eq("id",e.id).select().single();if(r)throw r;return n}{const{data:n,error:r}=await supabaseClient.from("custom_lists").insert(t).select().single();if(r)throw r;const s=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==s?this.lists[s]={...n,words:n.words||[],translations:n.translations||[]}:this.lists.push({...n,words:n.words||[],translations:n.translations||[]}),n}}catch(e){return console.error("Error saving list to Supabase:",e),null}},saveToLocalStorage(e){try{const t={...e,id:e.id||Date.now(),tempId:e.tempId||Date.now()},n=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==n?this.lists[n]=t:this.lists.push(t),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),t}catch(e){return console.error("Error saving list to localStorage:",e),null}},async delete(e){if(!currentUser)return this.lists=this.lists.filter((t=>t.id!==e)),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),!0;try{if("string"==typeof e&&36===e.length){const{error:t}=await supabaseClient.from("custom_lists").delete().eq("id",e);if(t)throw t}return this.lists=this.lists.filter((t=>t.id!==e)),!0}catch(e){return console.error("Error deleting list from Supabase:",e),!1}},async share(e,t){if(!currentUser)return!1;try{const n=this.lists.find((t=>t.id===e));if(!n)return!1;return!(await supabaseClient.rpc("insert_shared_list",{p_user_id:t,p_name:`${n.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,p_words:n.words||[],p_translations:n.translations||[],p_is_shared:!0,p_local_id:Date.now(),p_shared_with:[t],p_shared_by:currentUser.id})).error}catch(e){return console.error("Error sharing list:",e),!1}},getListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"};switch(currentUser.status||"free"){case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"âˆž"};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"âˆž"};case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1,playDisplay:"10"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"}}},canCreateMoreLists(){const e=this.getListLimits();return this.lists.length<e.maxLists}}),await checkExistingSession(),initializeGame(),updatePerkButtons(),updateGuestPlayButton(),CoinsManager.initialize(),WordsManager.initialize(),await CustomListsManager.initialize(),currentUser){gameState.coins=await CoinsManager.loadUserCoins(),CoinsManager.updateDisplays();const e=await WordsManager.loadUserWords();WordsManager.updateDisplays(e)}if(window.addEventListener("hashchange",handleHashChange),window.addEventListener("load",handleHashChange),window.location.hash.startsWith("#join=")){console.log("Initial join hash detected");const e=window.location.hash.replace("#join=","");history.pushState("",document.title,window.location.pathname),showJoinModal(e)}initializeParticles(document.getElementById("welcome-screen")),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(document.addEventListener("touchstart",(function e(){requestFullscreenMode(),document.removeEventListener("touchstart",e)}),{once:!0}),document.addEventListener("click",(function(e){"BUTTON"===e.target.tagName&&requestFullscreenMode()})),screen.orientation&&screen.orientation.lock("portrait").catch((e=>console.log("Failed to lock orientation:",e))));const e=document.getElementById("otpInput");e&&e.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),this.value.length>4&&(this.value=this.value.slice(0,4))})),currentUser&&(setupUserStatusSubscription(),initializeStatusCheck())}catch(e){console.error("Initialization error:",e)}})),document.addEventListener("DOMContentLoaded",(function(){currentUser=null,checkExistingSession().then((()=>{initializeGame(),updatePerkButtons()}))})),document.addEventListener("DOMContentLoaded",(()=>{(async()=>{if(await checkExistingSession(),initializeGame(),updatePerkButtons(),updateGuestPlayButton(),CoinsManager.initialize(),WordsManager.initialize(),currentUser){const[e,t]=await Promise.all([CoinsManager.loadUserCoins(),WordsManager.loadUserWords()]);gameState.coins=e,CoinsManager.updateDisplays(),WordsManager.updateDisplays(t)}if(window.location.hash.startsWith("#join=")){console.log("Initial join hash detected");const e=window.location.hash.replace("#join=","");history.pushState("",document.title,window.location.pathname),showJoinModal(e)}initializeParticles(document.getElementById("welcome-screen")),await loadCustomLists(),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(document.addEventListener("touchstart",(function e(){requestFullscreenMode(),document.removeEventListener("touchstart",e)}),{once:!0}),document.addEventListener("click",(function(e){"BUTTON"===e.target.tagName&&requestFullscreenMode()})),screen.orientation&&screen.orientation.lock("portrait").catch((e=>console.log("Failed to lock orientation:",e)))),currentUser&&(setupUserStatusSubscription(),initializeStatusCheck())})().catch((e=>{console.error("Initialization error:",e)}))}));const gameStructure={stages:[{id:1,numSets:9,levelsPerSet:21,bossLevel:21},{id:2,numSets:10,levelsPerSet:21,bossLevel:21},{id:3,numSets:12,levelsPerSet:21,bossLevel:21},{id:4,numSets:30,levelsPerSet:21,bossLevel:21},{id:5,numSets:14,levelsPerSet:21,bossLevel:21}],levelTypes:{normal:"normal",boss:"boss"}},gameState={currentStage:null,currentSet:null,currentLevel:null,unlockedSets:{},unlockedLevels:{},levelScores:{},completedLevels:new Set,perfectLevels:new Set,coins:0},PERK_CONFIG={timeFreeze:{name:"Time Freeze",description:"Pause the timer for 5 seconds",cost:15,icon:"fa-clock",duration:5e3},skip:{name:"Skip Question",description:"Skip the current word without penalty",cost:1,icon:"fa-forward"},clue:{name:"Eliminate Wrong Answer",description:"Remove one incorrect answer",cost:35,icon:"fa-lightbulb"},reveal:{name:"Reveal Correct Answer",description:"Show the correct translation",cost:50,icon:"fa-eye"}};function buyPerk(e){const t=PERK_CONFIG[e];if(t)if(gameState.coins<t.cost)showNotification(`Need ${t.cost} coins!`,"error");else{switch(gameState.coins-=t.cost,updateAllCoinDisplays(),e){case"timeFreeze":isFrozen=!0,setTimeout((()=>{isFrozen=!1}),t.duration);break;case"skip":handleAnswer(!0,!0);break;case"clue":const e=document.querySelectorAll(".buttons button"),n=currentGame.isHebrewToEnglish?currentGame.words[currentGame.currentIndex]:currentGame.translations[currentGame.currentIndex],r=Array.from(e).filter((e=>e.textContent!==n));if(r.length>0){const e=r[Math.floor(Math.random()*r.length)];e.disabled=!0,e.style.opacity="0.5"}break;case"reveal":const s=currentGame.isHebrewToEnglish?currentGame.words[currentGame.currentIndex]:currentGame.translations[currentGame.currentIndex];document.querySelectorAll(".buttons button").forEach((e=>{if(e.textContent===s){e.classList.add("correct");const t=e.style.background;e.style.background="var(--success)",setTimeout((()=>{e.classList.remove("correct"),e.style.background=t}),5e3)}}))}saveProgress()}}function updatePerkButtons(){Object.entries(PERK_CONFIG).forEach((([e,t])=>{const n=document.getElementById(`${e}Perk`);if(n){const e=Math.floor(gameState.coins/t.cost),r=e>0;n.disabled=!r,n.classList.toggle("disabled",!r);const s=n.querySelector(".perk-count");s&&(s.textContent=r?e.toString():"0")}}))}updatePerkButtons();let currentGame={words:[],translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,startTime:0,levelStartTime:0,timeBonus:0,streakBonus:!0,questionStartTime:0,wrongStreak:0,progressLost:0},timer=null,timeRemaining=0,isFrozen=!1,resetProgressTimeout=null,isFirstResetAttempt=!0;function saveProgress(){if(currentUser){const e={stage:gameState.currentStage,set_number:gameState.currentSet,level:gameState.currentLevel,coins:gameState.coins,perks:gameState.perks,unlocked_sets:Object.fromEntries(Object.entries(gameState.unlockedSets).map((([e,t])=>[e,Array.from(t)]))),unlocked_levels:Object.fromEntries(Object.entries(gameState.unlockedLevels).map((([e,t])=>[e,Array.from(t)]))),perfect_levels:Array.from(gameState.perfectLevels),completed_levels:Array.from(gameState.completedLevels)};supabaseClient.from("game_progress").update(e).eq("user_id",currentUser.id).then((({error:e})=>{e&&console.error("Error saving game progress:",e)}))}else localStorage.setItem("simploxProgress",JSON.stringify({unlockedSets:Object.fromEntries(Object.entries(gameState.unlockedSets).map((([e,t])=>[e,Array.from(t)]))),unlockedLevels:Object.fromEntries(Object.entries(gameState.unlockedLevels).map((([e,t])=>[e,Array.from(t)]))),perfectLevels:Array.from(gameState.perfectLevels),completedLevels:Array.from(gameState.completedLevels),coins:gameState.coins,perks:gameState.perks}))}function loadProgress(){const e=localStorage.getItem("simploxProgress");if(e){const t=JSON.parse(e);gameState.unlockedSets=Object.fromEntries(Object.entries(t.unlockedSets).map((([e,t])=>[e,new Set(t)]))),gameState.unlockedLevels=Object.fromEntries(Object.entries(t.unlockedLevels).map((([e,t])=>[e,new Set(t)]))),gameState.perfectLevels=new Set(t.perfectLevels),gameState.completedLevels=new Set(t.completedLevels||[]),gameState.coins=t.coins,gameState.perks=t.perks||{timeFreeze:0,skip:0,clue:0,reveal:0}}const t=localStorage.getItem("simploxCustomCoins");t&&(gameState.coins=parseInt(t))}async function handleLogout(){try{const{error:e}=await supabaseClient.auth.signOut();e&&console.error("Supabase logout error:",e.message),currentUser=null,updateAuthUI(),showScreen("welcome-screen"),initializeGame()}catch(e){console.error("Unexpected error during logout:",e)}}function startTimer(e){clearTimer(),currentGame.currentIndex>=currentGame.words.length||(currentGame.initialTimeRemaining?timeRemaining=currentGame.initialTimeRemaining:(currentGame.initialTimeRemaining=10*currentGame.words.length,timeRemaining=currentGame.initialTimeRemaining,currentGame.totalTime=timeRemaining),console.log("Starting timer with:",timeRemaining,"seconds"),currentGame.questionStartTime=Date.now(),updateTimerDisplay(),updateTimerCircle(timeRemaining,currentGame.totalTime),timer=setInterval((()=>{isFrozen||(timeRemaining=Math.max(0,timeRemaining-1),updateTimerDisplay(),updateTimerCircle(timeRemaining,currentGame.totalTime),currentGame.initialTimeRemaining=timeRemaining,timeRemaining<=10&&document.querySelector(".timer-value").classList.add("warning"),timeRemaining<=0&&handleTimeUp())}),1e3))}function updateTimerDisplay(){const e=Math.floor(timeRemaining/60),t=timeRemaining%60,n=document.querySelector(".timer-value");n.textContent=`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`,timeRemaining<=10?n.classList.add("warning"):n.classList.remove("warning")}function clearTimer(){timer&&(clearInterval(timer),timer=null),timeRemaining=0,isFrozen=!1;const e=document.querySelector(".timer-progress");e&&e.classList.remove("warning"),updateTimerCircle(0,1)}function createParticles(e,t){const n=window.matchMedia("(max-width: 768px)").matches?{count:10,size:6,distance:50,opacity:.7,duration:1e3}:{count:40,size:10,distance:150,opacity:1,duration:1500},r=["#ffd700","#FFA500","#4CAF50","#FFD700"],s=document.body;for(let o=0;o<n.count;o++){const o=document.createElement("div");o.className="particle",o.style.backgroundColor=r[Math.floor(Math.random()*r.length)],o.style.position="fixed",o.style.left=`${e}px`,o.style.top=`${t}px`;const a=Math.random()*Math.PI*2,i=n.distance+50*Math.random();o.style.width=`${n.size}px`,o.style.height=`${n.size}px`,o.style.opacity=`${n.opacity}`,o.style.setProperty("--x",Math.cos(a)*i+"px"),o.style.setProperty("--y",Math.sin(a)*i+"px"),o.style.animation=`particleBurst ${n.duration/1e3}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`,s.appendChild(o),setTimeout((()=>{s.removeChild(o)}),n.duration)}}function animateCoinsChange(e,t,n){if(!e)return;const r=1e3/(1e3/60),s=(n-t)/r;let o=0,a=t;!function t(){o++,a+=s,o<=r?(e.textContent=Math.round(a),s>0?e.style.color="var(--success)":s<0&&(e.style.color="var(--error)"),requestAnimationFrame(t)):(e.textContent=n,setTimeout((()=>{e.style.color="var(--text)"}),300))}()}function updatePlayerProgress(e){const t=currentArcadeSession.participants.findIndex((t=>t.username===e.username)),n={},r={};document.querySelectorAll(".leaderboard-entry").forEach((e=>{const t=e.querySelector("[data-username]").dataset.username;n[t]=e.getBoundingClientRect();const s=e.querySelector("[data-words]"),o=e.querySelector("[data-coins]");s&&(r[t]={words:parseInt(s.textContent),coins:parseInt(o.textContent)})})),-1!==t?currentArcadeSession.participants[t]={...currentArcadeSession.participants[t],...e}:currentArcadeSession.participants.push({username:e.username,wordsCompleted:e.wordsCompleted||0,coins:e.coins||0});const s=[...currentArcadeSession.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)).map(((e,t)=>`\n        <div class="leaderboard-entry ${t<3?`rank-${t+1}`:""}"\n             data-rank="${t+1}">\n            <div>${t+1}</div>\n            <div data-username="${e.username}">${e.username}</div>\n            <div data-words="${e.wordsCompleted}">${e.wordsCompleted||0}</div>\n            <div data-coins="${e.coins}">${e.coins||0}</div>\n        </div>\n    `)).join(""),o=document.getElementById("arcade-leaderboard");o.innerHTML=o.querySelector(".leaderboard-header").outerHTML+s;o.querySelectorAll(".leaderboard-entry").forEach((e=>{const t=e.querySelector("[data-username]").dataset.username;if(n[t]){const s=n[t],o=e.getBoundingClientRect(),a=s.top-o.top;if(a>0?e.classList.add("moving-up"):a<0&&e.classList.add("moving-down"),r[t]){const n=e.querySelector("[data-words]"),s=e.querySelector("[data-coins]");animateCoinsChange(n,r[t].words,parseInt(n.textContent)),animateCoinsChange(s,r[t].coins,parseInt(s.textContent))}e.addEventListener("animationend",(()=>{e.classList.remove("moving-up","moving-down")}),{once:!0})}}))}function handleTimeUp(){currentGame.currentIndex>=currentGame.words.length||(clearTimer(),showReviveOverlay())}function showScreen(e,t=!1){"welcome-screen"===e&&(console.log("Returning to welcome screen, clearing game context"),localStorage.removeItem("gameContext")),console.log("showScreen called with:",{screenId:e,forceRefresh:t,currentUser:currentUser?currentUser.id:"No user"}),"leaderboard-screen"===document.querySelector(".screen.visible")?.id&&cleanupLeaderboard();const n=document.querySelector(".screen.visible");if(n&&"question-screen"===n.id&&(clearTimer(),isFrozen=!1),t&&"welcome-screen"===e)return console.log("Initiating full page reload"),saveProgress(),void window.location.reload(!0);document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible");const t=e.querySelector(".particle-container");t&&t.remove()}));const r=document.getElementById(e);if(r){switch(r.classList.add("visible"),initializeParticles(r),updateAllCoinDisplays(),e){case"question-screen":updatePerkButtons(),console.log("Question screen shown, checking for admin button"),setTimeout((()=>{addAdminTestButton()}),100);break;case"welcome-screen":restoreGameContext()&&startGame();break;case"stage-cascade-screen":return showStageCascadeScreen()}console.log(`Switched to screen: ${e}`)}else console.error(`Screen with id ${e} not found`)}function showLevelScreen(e){gameState.currentSet=e,debugUnlockState();const t=document.getElementById("level-container");if(!t)return;t.innerHTML="";const n=gameStructure.stages[gameState.currentStage-1];if(!n)return;const r=document.createElement("div");r.className="level-header";const s=n.levelsPerSet;let o=0;for(let t=1;t<=s;t++){const n=`${gameState.currentStage}_${e}_${t}`;gameState.perfectLevels.has(n)?o++:gameState.completedLevels.has(n)&&o++}const a=Math.round(o/s*100),i=getSetIcon(gameState.currentStage,e),c=getSetDescription(gameState.currentStage,e);r.innerHTML=`\n        <div class="level-title-area">\n            <div class="set-icon">\n                <i class="${i}"></i>\n            </div>\n            <div class="set-details">\n                <div class="set-name">Stage ${gameState.currentStage} - Set ${e}</div>\n                <div class="set-desc">${c}</div>\n            </div>\n        </div>\n        <div class="set-progress">\n            <div class="progress-bar">\n                <div class="progress-fill" style="width: ${a}%"></div>\n            </div>\n            <div class="progress-text">${o}/${s} levels</div>\n        </div>\n    `,t.appendChild(r);const l=document.createElement("div");l.className="level-grid";const d=[3,6,9,10,13,16,19,20],u=`${gameState.currentStage}_${e}`;gameState.unlockedLevels[u]||(gameState.unlockedLevels[u]=new Set([1])),console.log(`Rendering levels for ${u}. Unlocked levels:`,Array.from(gameState.unlockedLevels[u]||[]));for(let t=1;t<=n.levelsPerSet;t++){const r=document.createElement("div"),s=`${gameState.currentStage}_${e}_${t}`,o=gameState.unlockedLevels[u]?.has(t);console.log(`Level ${t} unlocked:`,o);const a=gameState.perfectLevels.has(s),i=gameState.completedLevels.has(s),c=t===n.bossLevel,m=d.includes(t);r.className="level-item",o&&r.classList.add("unlocked"),a?r.classList.add("perfect"):i&&r.classList.add("completed"),c&&r.classList.add("boss"),m&&r.classList.add("test"),o||r.classList.add("locked"),r.textContent=t,o&&(r.onclick=()=>startLevel(t)),l.appendChild(r)}t.appendChild(l);const m=document.createElement("div");m.className="level-type-legend",m.innerHTML='\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--accent), rgba(30, 144, 255, 0.7));"></div>\n            <span>Normal</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--success), #45b649);"></div>\n            <span>Completed</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--gold), #FFA500);"></div>\n            <span>Perfect</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--gold), var(--accent));"></div>\n            <span>Boss</span>\n        </div>\n    ',t.appendChild(m),showScreen("level-screen")}function getSetIcon(e,t){const n=["fas fa-book-open","fas fa-book-reader","fas fa-bookmark","fas fa-pencil-alt","fas fa-pen"];return 1===t?{1:"fas fa-book",2:"fas fa-graduation-cap",3:"fas fa-school",4:"fas fa-university",5:"fas fa-brain"}[e]||"fas fa-star":n[(t-2)%n.length]||"fas fa-star"}function getSetDescription(e,t){return`${{1:"Beginner",2:"Elementary",3:"Intermediate",4:"Advanced",5:"Expert"}[e]||"Advanced"} vocabulary - Group ${t}`}function calculateWordsForLevel(e,t){const n=t.words.length,r=n-50;if(!t.randomIndices){t.randomIndices=Array.from({length:n},((e,t)=>t));for(let e=t.randomIndices.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t.randomIndices[e],t.randomIndices[n]]=[t.randomIndices[n],t.randomIndices[e]]}console.log("Created randomized word indices:",t.randomIndices)}if(21===e)return{startIndex:0,count:n,isBossLevel:!0,speedChallenge:!0,mixed:!0,isTestLevel:!0,isHebrewToEnglish:Math.random()<.5,testLevels:[],randomIndices:t.randomIndices};if(1===e||2===e){const n=3*(e-1);return{startIndex:n,count:3,testLevels:[3,10,21],randomIndices:t.randomIndices.slice(n,n+3)}}if(3===e)return{startIndex:0,count:6,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(0,6)};if(4===e||5===e){const n=6+3*(e-4);return{startIndex:n,count:3,testLevels:[6,10,21],randomIndices:t.randomIndices.slice(n,n+3)}}if(6===e)return{startIndex:6,count:6,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(6,12)};if(7===e||8===e){const n=12+4*(e-7);return{startIndex:n,count:4,testLevels:[9,10,21],randomIndices:t.randomIndices.slice(n,n+4)}}if(9===e)return{startIndex:12,count:8,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(12,20)};if(10===e)return{startIndex:0,count:20,isTestLevel:!0,speedChallenge:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(0,20)};if(11===e||12===e){const n=20+4*(e-11);return{startIndex:n,count:4,testLevels:[13,20,21],randomIndices:t.randomIndices.slice(n,n+4)}}if(13===e)return{startIndex:20,count:8,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(20,28)};if(14===e||15===e){const n=14===e?5:6,r=28+(14===e?0:5);return{startIndex:r,count:n,testLevels:[16,20,21],randomIndices:t.randomIndices.slice(r,r+n)}}if(16===e)return{startIndex:28,count:11,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(28,39)};if(17===e||18===e){const n=17===e?5:6,s=n+(r>0?r:0),o=39+(17===e?0:n);return{startIndex:o,count:s,testLevels:[19,20,21],randomIndices:t.randomIndices.slice(o,o+s)}}return 19===e?{startIndex:39,count:11,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(39,50)}:20===e?{startIndex:20,count:30,isTestLevel:!0,speedChallenge:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(20,50)}:void 0}function getUnusedWords(e){return gameState.usedWords||(gameState.usedWords=new Set),e.words.map(((e,t)=>t)).filter((e=>!gameState.usedWords.has(e)))}function selectRandomWords(e,t){const n=new Set;for(;n.size<t&&e.length>n.size;){const t=Math.floor(Math.random()*e.length);n.add(e[t]),gameState.usedWords.add(e[t])}return Array.from(n)}function generateAnswerChoices(e,t){const n=new Set([e]),r=t.translations;for(;n.size<3;){const e=r[Math.floor(Math.random()*r.length)];n.add(e)}return Array.from(n).sort((()=>Math.random()-.5))}function startLevel(e){gameState.currentLevel=e;const t={stage:gameState.currentStage,set:gameState.currentSet,level:e,timestamp:Date.now()};console.log("Setting game context at level start:",t),localStorage.setItem("gameContext",JSON.stringify(t)),currentGame.wrongStreak=0,currentGame.correctAnswers=0,currentGame.levelStartTime=Date.now(),currentGame.firstAttempt=!0,currentGame.streakBonus=!0,updatePerkButtons(),console.log("Current unlocked levels:",gameState.unlockedLevels);const n=`${gameState.currentStage}_${gameState.currentSet}`;console.log(`Current set key: ${n}, unlocked levels in set:`,gameState.unlockedLevels[n]?Array.from(gameState.unlockedLevels[n]):"none");const r=document.querySelector(".perks-container"),s=document.querySelector(".powerups-container");r&&(r.style.display="flex"),s&&(s.style.display="none");const o=document.querySelector(".coin-count");o&&(o.textContent=gameState.coins||0);const a=document.querySelector(".coins-container");a&&(a.style.display="flex"),gameState.currentStage=gameState.currentStage||1,gameState.currentSet=gameState.currentSet||1,gameState.currentLevel=e,console.log(`Starting level: Stage ${gameState.currentStage}, Set ${gameState.currentSet}, Level ${e}`),addAdminTestButton();const i=currentUser?currentUser.status:"unregistered";if([2,7,11,15,20].includes(e)&&"premium"!==i){const t=e;if(!currentUser)return showUnregisteredWarning((()=>{proceedWithLevel(t)}));if(!localStorage.getItem(`upgradeRequested_${currentUser.id}`))return showUpgradePrompt((()=>{proceedWithLevel(t)}))}21===e?(currentGame.isBossLevel=!0,console.log("Boss level detected"),setTimeout(applyBossLevelStyles,100),setTimeout(applyBossLevelStyles,500)):currentGame.isBossLevel=!1,proceedWithLevel(e)}function addAdminTestButton(){console.log("Checking for admin user...");const e=document.getElementById("admin-test-button");if(e&&e.remove(),console.log("Current user:",currentUser?currentUser.email:"No user"),!currentUser||"admin123@gmail.com"!==currentUser.email&&!currentUser.email?.includes("admin123"))return void console.log("Not admin user, not adding button");console.log("Admin user detected, adding test button");const t=document.createElement("button");t.id="admin-test-button",t.textContent="Jump to Level 20",t.style.cssText="\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: #ff5722;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 2000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    font-weight: bold;\n  ",t.onclick=function(){console.log("Admin button clicked, jumping to level 20"),gameState.currentLevel=21,startLevel(21)},document.body.appendChild(t),console.log("Admin test button added to body")}function findFurthestProgression(){console.log("Finding furthest progression");const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);if(t.stage&&t.set&&t.level)return console.log("Found saved game context:",t),{stage:t.stage,set:t.set,level:t.level}}catch(e){console.error("Error parsing saved game context:",e)}return console.log("Current game state:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel,unlockedSets:Object.fromEntries(Object.entries(gameState.unlockedSets||{}).map((([e,t])=>[e,Array.from(t||[])]))),unlockedLevels:Object.fromEntries(Object.entries(gameState.unlockedLevels||{}).map((([e,t])=>[e,Array.from(t||[])]))),perfectLevels:Array.from(gameState.perfectLevels||[]),completedLevels:Array.from(gameState.completedLevels||[])}),gameState.currentStage&&gameState.currentSet&&gameState.currentLevel?(console.log(`Using current game state: Stage ${gameState.currentStage}, Set ${gameState.currentSet}, Level ${gameState.currentLevel}`),{stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel}):(console.log("No progression found, defaulting to beginning"),{stage:1,set:1,level:1})}function proceedWithLevel(e){currentGame.restartsRemaining=currentGame.restartsRemaining||2,gameState.currentLevel=e;const t=`${gameState.currentStage}_${gameState.currentSet}`,n=vocabularySets[t],r=document.querySelector(".coin-count");r&&(r.textContent=gameState.coins||0,r.style.display="block"),currentGame.startingCoins=gameState.coins,currentGame.startingPerks={...gameState.perks},currentGame.timeBonus=0,currentGame.initialTimeRemaining=null,currentGame.streakBonus=!0,currentGame.levelStartTime=Date.now(),showLevelIntro(e,(()=>{setupGameState(calculateWordsForLevel(e,n),n),showScreen("question-screen"),addAdminTestButton(),21===e?(console.log("Initializing boss level in proceedWithLevel"),initializeBossLevel(),setTimeout(applyBossLevelStyles,200),loadNextBossQuestion()):(updateProgressCircle(),loadNextQuestion()),setTimeout((()=>{startTimer(currentGame.words.length)}),200)}))}function proceedWithLevel(e){currentGame.restartsRemaining||(currentGame.restartsRemaining=2),gameState.currentLevel=e;const t=`${gameState.currentStage}_${gameState.currentSet}`,n=vocabularySets[t],r=document.querySelector(".coin-count");r&&(r.textContent=gameState.coins||0,r.style.display="block"),currentGame.startingCoins=gameState.coins,currentGame.startingPerks={...gameState.perks},currentGame.timeBonus=0,currentGame.initialTimeRemaining=null,currentGame.streakBonus=!0,currentGame.levelStartTime=Date.now(),showLevelIntro(e,(()=>{setupGameState(calculateWordsForLevel(e,n),n),showScreen("question-screen"),updateProgressCircle(),loadNextQuestion(),setTimeout((()=>{startTimer(currentGame.words.length)}),200)}))}function setupGameState(e,t){if("object"==typeof e)if(e.randomIndices){const n=e.randomIndices.map((e=>t.words[e])),r=e.randomIndices.map((e=>t.translations[e]));Object.assign(currentGame,{words:n,translations:r,currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:e.isHebrewToEnglish||!1,mixed:e.mixed||!1,speedChallenge:e.speedChallenge||!1,isBossLevel:e.isBossLevel||!1})}else{const{startIndex:n,count:r,isHebrewToEnglish:s,mixed:o,speedChallenge:a,isBossLevel:i}=e;Object.assign(currentGame,{words:t.words.slice(n,n+r),translations:t.translations.slice(n,n+r),currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:s||!1,mixed:o||!1,speedChallenge:a||!1,isBossLevel:i||!1})}else Object.assign(currentGame,{words:t.words.slice(0,e),translations:t.translations.slice(0,e),currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,isBossLevel:!1})}function handleLevelProgression(){const e=gameStructure.stages[gameState.currentStage-1],t=gameState.currentLevel===e.levelsPerSet,n=gameState.currentSet===e.numSets;t?n?gameState.currentStage<5?(gameState.currentStage++,gameState.currentSet=1,startLevel(1)):showScreen("stage-screen"):(gameState.currentSet++,startLevel(1)):startLevel(gameState.currentLevel+1)}function updateNavigationIcons(e){if(["stage-screen","set-screen","level-screen","question-screen"].includes(e)){const t=document.createElement("div");t.className="screen-nav";const n=document.createElement("button");if(n.className="home-button",n.innerHTML='<i class="fas fa-home"></i>',n.onclick=()=>showScreen("welcome-screen"),t.appendChild(n),"stage-screen"!==e){const n=document.createElement("button");switch(n.className="back-button",n.innerHTML='<i class="fas fa-arrow-left"></i>',e){case"set-screen":n.onclick=()=>showScreen("stage-screen");break;case"level-screen":n.onclick=()=>showSetScreen(gameState.currentStage);break;case"question-screen":n.onclick=()=>stopLevelAndGoBack()}t.appendChild(n)}document.getElementById(e).appendChild(t)}}function updateProgressCircle(){const e=document.querySelector(".progress-circle .progress"),t=(document.querySelector(".progress-circle"),2*Math.PI*54),n=currentGame.currentIndex/currentGame.words.length;let r,s,o;if(e.style.strokeDasharray=`${t} ${t}`,e.style.strokeDashoffset=t*(1-n),n<=.2)r=0,s=100,o=20;else if(n<=.4)r=0,s=100,o=50;else if(n<=.6)r=30,s=100,o=50;else if(n<=.8)r=120,s=100,o=40;else{const e=5*(n-.8);r=120*(1-e)+60*e,s=100,o=40+20*e}e.style.stroke=`hsl(${r}, ${s}%, ${o}%)`}function loadNextQuestion(){if(currentGame.currentIndex>=currentGame.words.length)return void handleLevelCompletion();const e=!![3,6,9,10,13,16,19,20,21].includes(gameState.currentLevel)&&Math.random()<.5,t=currentGame.currentIndex,n=e?currentGame.translations[t]:currentGame.words[t];document.getElementById("question-word").textContent=n;const r=e?currentGame.words[t]:currentGame.translations[t],s=e?currentGame.words:currentGame.translations,o=new Set([r]);for(;o.size<3;){const e=s[Math.floor(Math.random()*s.length)];e!==r&&o.add(e)}const a=document.getElementById("buttons");a.innerHTML="",Array.from(o).sort((()=>Math.random()-.5)).forEach((e=>{const t=document.createElement("button");t.textContent=e,t.onclick=()=>handleAnswer(e===r),a.appendChild(t)}))}async function handleAnswer(e,t=!1){const n=Date.now();if(n-(currentGame.lastAnswerTime||0)<1e3)console.warn("Answer too quickly. Please wait a moment.");else if(!currentGame||!currentGame.words||0===currentGame.words.length||currentGame.currentIndex>=currentGame.words.length)console.error("Invalid game state or index");else{currentGame.lastAnswerTime=n,currentGame.perks=currentGame.perks||{clue:0,skip:0,timeFreeze:0,reveal:0};try{if(e){if(currentGame.currentIndex++,currentGame.isBossLevel){const e=document.querySelector(".boss-orb-inner");if(e){const t=["yellow","purple","turquoise","darkgreen","brown"],n=t[Math.floor(Math.random()*t.length)],r=e.style.background;e.style.background=`radial-gradient(circle at 30% 30%, ${n}, #990000)`,e.style.transform="scale(1.3)",e.style.filter="brightness(1.5)",setTimeout((()=>{e.style.transform="",e.style.filter="",e.style.background=r}),300)}if(updateBossHealthBar(),currentGame.currentIndex>=currentGame.words.length)return console.log("Boss defeated!"),void CoinsManager.updateCoins(100).then((()=>{showBossDefeatEffect()}))}else updateProgressCircle();if(!t){let e=0;const t=awardTimeBonus();t>0&&(e+=t,pulseCoins(t)),currentGame.firstAttempt?(e+=3,pulseCoins(3)):(e+=1,pulseCoins(1));try{await CoinsManager.updateCoins(e),updatePerkButtons()}catch(e){console.error("Error updating total coins:",e)}currentGame.correctAnswers++}}else{currentGame.firstAttempt=!1,currentGame.streakBonus=!1,currentGame.wrongStreak++;try{await CoinsManager.updateCoins(-3),updatePerkButtons()}catch(e){console.error("Error updating coins:",e)}if(currentGame.currentIndex>0&&(currentGame.progressLost++,currentGame.currentIndex=Math.max(0,currentGame.currentIndex-1),currentGame.isBossLevel&&updateBossHealthBar()),currentGame.wrongStreak>=3)return void showGameOverOverlay()}const n=currentGame.isHebrewToEnglish?currentGame.words[currentGame.currentIndex]:currentGame.translations[currentGame.currentIndex];document.querySelectorAll(".buttons button").forEach((t=>{t.textContent===n?t.classList.add("correct"):!e&&event&&event.target&&t.textContent===event.target.textContent&&t.classList.add("wrong")})),saveProgress(),setTimeout((()=>{currentGame.currentIndex<currentGame.words.length?(startTimer(currentGame.words.length-currentGame.currentIndex),currentGame.isBossLevel?loadNextBossQuestion():loadNextQuestion(),updatePerkButtons()):currentGame.isBossLevel||handleLevelCompletion()}),500)}catch(e){console.error("Unexpected error in handleAnswer:",e),console.error("Error details:",e.stack);try{currentGame.currentIndex<currentGame.words.length?loadNextQuestion():showScreen("welcome-screen")}catch(e){console.error("Failed to recover from error:",e),showScreen("welcome-screen")}}}}function showBossVictoryScreen(){console.log("Boss victory screen function called - redirecting to new implementation"),showBossDefeatEffect()}function addAdminTestingButton(){if(!currentUser||"admin123@gmail.com"!==currentUser.email)return;const e=document.getElementById("question-screen");if(document.getElementById("admin-test-button"))return;const t=document.createElement("button");t.id="admin-test-button",t.innerHTML="Jump to Level 20",t.style.cssText="\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: #ff5722;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 1000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n  ",t.onclick=function(){gameState.currentLevel=20,startLevel(20)},e.appendChild(t)}function awardTimeBonus(){const e=(Date.now()-currentGame.questionStartTime)/1e3;if(e<10){const t=Math.floor(10-e);return currentGame.timeBonus+=t,t}return 0}function pulseCoins(e=1){document.querySelectorAll(".coin-icon").forEach((t=>{let n=0;const r=()=>{t.classList.add("coin-pulse"),setTimeout((()=>{t.classList.remove("coin-pulse"),n++,n<e&&setTimeout(r,100)}),500)};r()}))}function updateAllCoinDisplays(){document.querySelectorAll(".coin-count").forEach((e=>{const t=parseInt(e.textContent)||0;let n;n=window.location.pathname.includes("arcade")?currentGame.coins||0:gameState.coins||0;animateNumber(e,Number(t),Number(n))}))}function eliminateWrongAnswer(){const e=document.querySelectorAll(".buttons button"),t=currentGame.isHebrewToEnglish?currentGame.words[currentGame.currentIndex]:currentGame.translations[currentGame.currentIndex],n=Array.from(e).filter((e=>e.textContent!==t));if(n.length>0){const e=n[Math.floor(Math.random()*n.length)];e.disabled=!0,e.style.opacity="0.5"}}function revealCorrectAnswer(){const e=currentGame.isHebrewToEnglish?currentGame.words[currentGame.currentIndex]:currentGame.translations[currentGame.currentIndex];document.querySelectorAll(".buttons button").forEach((t=>{t.textContent===e?(t.classList.add("correct"),setTimeout((()=>{currentGame.correctAnswers++,currentGame.currentIndex++,loadNextQuestion()}),1e3)):(t.disabled=!0,t.style.opacity="0.5")}))}function buyPerk(e){const t=PERK_CONFIG[e],n=document.getElementById(`${e}Perk`);if(!t)return void console.error("Invalid perk type:",e);if(gameState.coins<t.cost)return void showNotification(`Need ${t.cost} coins for ${t.name}!`,"error");gameState.coins-=t.cost;const r=n.querySelector(".perk-count"),s=parseInt(r.textContent)||0;switch(animateNumberChange(r,s,s-1),e){case"timeFreeze":isFrozen=!0,n.disabled=!0,setTimeout((()=>{isFrozen=!1,n.disabled=!1}),t.duration);break;case"skip":handleAnswer(!0,!0);break;case"clue":eliminateWrongAnswer();break;case"reveal":revealCorrectAnswer()}updateAllCoinDisplays(),n&&(n.disabled=gameState.coins<t.cost,n.classList.toggle("disabled",gameState.coins<t.cost)),saveProgress()}function animateNumberChange(e,t,n){if(!e)return;const r=(n-t)/20;let s=0,o=t;requestAnimationFrame((function t(){s++,o+=r,s<=20?(e.textContent=Math.round(o),requestAnimationFrame(t)):e.textContent=n}))}function startCustomListPractice(e){const t=customPracticeLists.lists.find((t=>t.id===e));t&&(updatePerkButtons(),currentGame={words:Array.isArray(t.words)?t.words:[],translations:Array.isArray(t.translations)?t.translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isCustomPractice:!0,startingCoins:gameState.coins,startingPerks:{...gameState.perks},practiceState:{currentLevel:1,words:Array.isArray(t.words)?t.words:[],translations:Array.isArray(t.translations)?t.translations:[],unlockedLevels:new Set([1]),progress:{},maxLevel:10,listId:e}},startCustomLevel(1,currentGame.practiceState))}function handleLevelCompletion(){if(clearTimer(),currentGame.isBossLevel)return restoreFromBossLevel(),void CoinsManager.updateCoins(100).then((()=>{showBossDefeatEffect();const e=document.createElement("div");e.className="boss-victory-message",e.style.cssText="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: linear-gradient(135deg, #4CAF50, #2E7D32);\n        color: white;\n        padding: 2rem;\n        border-radius: 20px;\n        text-align: center;\n        z-index: 1000;\n        max-width: 80%;\n        box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);\n      ",e.innerHTML='\n        <h2 style="font-size: 2rem; margin-bottom: 1rem;">Boss Defeated!</h2>\n        <p style="font-size: 1.2rem; margin-bottom: 2rem;">You\'ve earned 100 coins for defeating the boss!</p>\n        <div style="display: flex; justify-content: center; gap: 1rem;">\n          <button class="continue-button" style="\n            background: white;\n            color: #2E7D32;\n            border: none;\n            padding: 1rem 2rem;\n            border-radius: 50px;\n            font-size: 1.2rem;\n            font-weight: bold;\n            cursor: pointer;\n            transition: all 0.3s ease;\n          ">Continue to Next Set</button>\n          <button class="home-button" style="\n            background: transparent;\n            color: white;\n            border: 2px solid white;\n            padding: 1rem 2rem;\n            border-radius: 50px;\n            font-size: 1.2rem;\n            font-weight: bold;\n            cursor: pointer;\n            transition: all 0.3s ease;\n          ">Return Home</button>\n        </div>\n      ',document.body.appendChild(e);const t=e.querySelector(".continue-button");t&&t.addEventListener("click",(()=>{e.remove(),unlockNextSet();const t=gameState.currentSet+1;gameState.currentSet=t,gameState.currentLevel=1,startLevel(1)}));const n=e.querySelector(".home-button");n&&n.addEventListener("click",(()=>{e.remove(),unlockNextSet(),showScreen("welcome-screen")}))}));const e=`${gameState.currentStage}_${gameState.currentSet}_${gameState.currentLevel}`;console.log(`Completing level: ${e}`);const t=gameState.perfectLevels.has(e)||gameState.completedLevels.has(e);console.log(`Level was previously completed: ${t}`);const n=currentGame.streakBonus&&currentGame.correctAnswers===currentGame.words.length;if(!t&&n){const e=5;CoinsManager.updateCoins(e).then((()=>{updateLevelProgress(gameState.currentStage,gameState.currentSet,gameState.currentLevel,!0,!0);const e=document.getElementById("question-screen").getBoundingClientRect();createParticles(e.left+e.width/2,e.top+e.height/2)}))}else t||updateLevelProgress(gameState.currentStage,gameState.currentSet,gameState.currentLevel,!0,!1);pulseCoins(5),updatePerkButtons();const r=gameStructure.stages[gameState.currentStage-1],s=gameState.currentLevel===r.levelsPerSet,o=gameState.currentSet===r.numSets,a=currentUser?currentUser.status:"unregistered";s?(checkSetCompletion(gameState.currentStage,gameState.currentSet),o?"premium"===a&&gameState.currentStage<5?setTimeout((()=>{gameState.currentStage++,gameState.currentSet=1,gameState.currentLevel=1,startLevel(1)}),1500):setTimeout((()=>showScreen("stage-cascade-screen")),1500):setTimeout((()=>{gameState.currentSet++,gameState.currentLevel=1,startLevel(1)}),1500)):setTimeout((()=>{gameState.currentLevel++,startLevel(gameState.currentLevel)}),1500)}function checkSetCompletion(e,t){const n=gameStructure.stages[e-1].levelsPerSet;let r=0;for(let s=1;s<=n;s++){const n=`${e}_${t}_${s}`;(gameState.completedLevels.has(n)||gameState.perfectLevels.has(n))&&r++}console.log(`Set ${e}-${t} completion: ${r}/${n}`),r===n&&(console.log(`Set ${e}-${t} is complete. Unlocking next set.`),unlockNextSet())}function handleProgression(e){const t=`${gameState.currentStage}_${gameState.currentSet}`;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set),gameState.unlockedLevels[t].add(gameState.currentLevel);const n=gameStructure.stages[gameState.currentStage-1],r=gameState.currentLevel===n.levelsPerSet,s=gameState.currentSet===n.numSets;r?s?gameState.currentStage<5&&unlockNextStage():unlockNextSet():gameState.unlockedLevels[t].add(gameState.currentLevel+1),saveProgress(),updateAllCoinDisplays(),setTimeout((()=>{r?s?gameState.currentStage<5?(gameState.currentStage++,gameState.currentSet=1,startLevel(1)):showScreen("stage-screen"):(gameState.currentSet++,startLevel(1)):startLevel(gameState.currentLevel+1)}),1500)}function createCompletionParticles(){const e=document.getElementById("question-screen").getBoundingClientRect(),t=e.left+e.width/2,n=e.top+e.height/2;for(let e=0;e<5;e++)setTimeout((()=>createParticles(t,n)),300*e)}function activatePerk(e,t){const n=powerupCooldowns.get(e)||0,r=Date.now();r-n<5e3?showNotification("Perk is on cooldown","warning"):CoinsManager.updateCoins(-t).then((t=>{t?(gameState.perks[e]++,saveProgress(),updatePerkButtons(),usePerk(e),powerupCooldowns.set(e,r),showNotification(`${e} activated!`,"success")):showNotification("Not enough coins","error")})).catch((e=>{console.error("Perk activation failed:",e),showNotification("Failed to activate perk","error")}))}function initializeParticles(e=document.body){e instanceof HTMLElement||(e=document.body);let t=e.querySelector(".particle-container");t||(t=document.createElement("div"),t.classList.add("particle-container"),e.appendChild(t));const n=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",..."Î‘Î’Î“Î”Î•Î–Î—Î˜Î™ÎšÎ›ÎœÎÎžÎŸÎ Î¡Î£Î¤Î¥Î¦Î§Î¨Î©Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰",..."××‘×’×“×”×•×–×—×˜×™×›×œ×ž× ×¡×¢×¤×¦×§×¨×©×ª"];function r(){const r=document.createElement("div");r.classList.add("letter-particle"),r.textContent=n[Math.floor(Math.random()*n.length)];const s=Math.random()*e.clientWidth,o=Math.random()*e.clientHeight,a=200*Math.random()-100,i=200*Math.random()-100,c=12+16*Math.random(),l=.2+.3*Math.random(),d=180*Math.random(),u=8+10*Math.random();r.style.cssText=`\n            position: absolute;\n            left: ${s}px;\n            top: ${o}px;\n            font-size: ${c}px;\n            animation: letterFloat ${u}s ease-in-out forwards;\n            --moveX: ${a}px;\n            --moveY: ${i}px;\n            --opacity: ${l};\n            --rotate: ${d}deg;\n            pointer-events: none;\n        `,t.appendChild(r),setTimeout((()=>{t.removeChild(r)}),1e3*u)}for(let e=0;e<50;e++)r();const s=setInterval(r,1e3);t.dataset.intervalId=s}function stopLevelAndGoBack(){clearTimer(),isFrozen=!1,currentGame={words:[],translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,timeBonus:0,initialTimeRemaining:null,streakBonus:!0,restartsRemaining:null},showScreen("welcome-screen")}function showGameOverOverlay(){clearTimer();const e=document.querySelector(".failure-overlay");e.querySelector(".failure-title").textContent="Game Over!",e.style.display="flex",setTimeout((()=>{e.classList.add("show")}),100),document.querySelector(".restart-button").onclick=()=>{e.classList.remove("show"),setTimeout((()=>{e.style.display="none",currentGame.isCustomPractice?startCustomLevel(currentGame.practiceState.currentLevel,currentGame.practiceState):startLevel(gameState.currentLevel)}),1e3)},document.querySelector(".home-button").onclick=()=>{e.classList.remove("show"),setTimeout((()=>{e.style.display="none",showScreen("welcome-screen")}),1e3)}}function updateTimerCircle(e,t){const n=document.querySelector(".timer-progress");if(!n)return;const r=2*Math.PI*40;n.style.strokeDasharray=`${r} ${r}`;const s=r*(1-e/t);n.style.strokeDashoffset=s,e<=10?n.classList.add("warning"):n.classList.remove("warning")}function handleResetProgress(){if(!isFirstResetAttempt)return gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.unlockedSets={1:new Set([1])},gameState.unlockedLevels={"1_1":new Set([1])},gameState.perfectLevels=new Set,gameState.completedLevels=new Set,localStorage.removeItem("simploxProgress"),localStorage.removeItem("simploxCustomCoins"),updatePerkButtons(),updateAllCoinDisplays(),showScreen("welcome-screen"),void(isFirstResetAttempt=!0);const e=document.querySelector(".reset-button");e.classList.add("warning"),isFirstResetAttempt=!1,setTimeout((()=>{e.classList.remove("warning")}),1e3),resetProgressTimeout&&clearTimeout(resetProgressTimeout),resetProgressTimeout=setTimeout((()=>{isFirstResetAttempt=!0}),1e4)}function toggleFullScreen(){const e=document.querySelector(".fullscreen-button i");document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().then((()=>{e.classList.remove("fa-compress"),e.classList.add("fa-expand")})).catch((e=>{console.log(`Error attempting to exit fullscreen: ${e.message}`)})):document.documentElement.requestFullscreen().then((()=>{e.classList.remove("fa-expand"),e.classList.add("fa-compress")})).catch((e=>{console.log(`Error attempting to enable fullscreen: ${e.message}`)}))}async function handleLogout(){try{const{error:e}=await supabaseClient.auth.signOut();e&&console.error("Supabase logout error:",e.message),currentUser=null,updateAuthUI(),showScreen("welcome-screen"),initializeGame()}catch(e){console.error("Unexpected error during logout:",e)}}function handleRestartLevel(){if(currentGame.restartsRemaining<=0)return;const e=document.querySelector(".navigation-button.restart-level");currentGame.restartsRemaining--,1===currentGame.restartsRemaining?e.style.opacity="0.7":0===currentGame.restartsRemaining&&(e.classList.add("disabled"),e.onclick=null,e.disabled=!0),gameState.coins=currentGame.startingCoins,gameState.perks={...currentGame.startingPerks},updatePerkButtons(),updateAllCoinDisplays(),saveProgress(),startLevel(gameState.currentLevel)}function showStagesFromMenu(){showScreen("stage-screen")}function findFurthestProgression(){const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);if(t.stage&&t.set&&t.level)return console.log("Resuming from saved context:",t),{stage:t.stage,set:t.set,level:t.level}}catch(e){console.error("Error parsing saved context:",e)}const t=parseInt(localStorage.getItem("preferredStage"));console.log("Finding furthest progression"),console.log("Current unlocked sets:",gameState.unlockedSets),console.log("Current unlocked levels:",gameState.unlockedLevels),console.log("Completed levels:",Array.from(gameState.completedLevels)),console.log("Perfect levels:",Array.from(gameState.perfectLevels));let n=null,r=-1;const s=(e,t,n)=>{const r=`${e}_${t}_${n}`,s=`${e}_${t}`,o=gameState.unlockedLevels[s]?.has(n),a=!gameState.completedLevels.has(r)&&!gameState.perfectLevels.has(r);return o&&a},o=(e,t,n)=>1e4*e+100*t+n;if(t&&t>=1&&t<=5){console.log(`Checking preferred stage: ${t}`);for(let e=1;e<=gameStructure.stages[t-1].numSets;e++){const a=`${t}_${e}`;if(!gameState.unlockedLevels[a])continue;const i=Array.from(gameState.unlockedLevels[a]).sort(((e,t)=>t-e));console.log(`Checking set ${a}, unlocked levels:`,i);for(let a of i)if(s(t,e,a)){const s=o(t,e,a);s>r&&(r=s,n={stage:t,set:e,level:a},console.log(`Found candidate in preferred stage: ${t}-${e}-${a}`))}}}if(!n)for(let e=1;e<=5;e++){if(!gameState.unlockedSets[e])continue;const t=Array.from(gameState.unlockedSets[e]).sort(((e,t)=>t-e));for(let a of t){const t=`${e}_${a}`;if(!gameState.unlockedLevels[t])continue;const i=Array.from(gameState.unlockedLevels[t]).sort(((e,t)=>t-e));for(let t of i)if(s(e,a,t)){const s=o(e,a,t);s>r&&(r=s,n={stage:e,set:a,level:t},console.log(`Found candidate: ${e}-${a}-${t}`))}}}return n?(console.log("Found furthest progress:",n),n):t&&t>=1&&t<=5?{stage:t,set:1,level:1}:{stage:1,set:1,level:1}}function startGame(){if(console.log("Starting game"),!hasExistingProgress())return console.log("No existing progress found, showing grade selector"),void showGradeLevelSelector();const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);if(t.stage&&t.set&&t.level)return console.log("Found saved game context:",t),gameState.currentStage=t.stage,gameState.currentSet=t.set,gameState.currentLevel=t.level,void startLevel(gameState.currentLevel)}catch(e){console.error("Error parsing game context:",e)}console.log("Using current game state:",{stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel}),startLevel(gameState.currentLevel)}function updateLevelProgress(e,t,n,r,s){const o=`${e}_${t}_${n}`;s?(gameState.perfectLevels.add(o),gameState.completedLevels.add(o)):r&&gameState.completedLevels.add(o);const a=`${e}_${t}`;gameState.unlockedLevels[a]||(gameState.unlockedLevels[a]=new Set),gameState.unlockedLevels[a].add(n);const i=n+1,c=n===gameStructure.stages[e-1].levelsPerSet;c||(gameState.unlockedLevels[a].add(i),console.log(`Unlocked next level: ${i} in set ${a}`)),c&&r&&checkSetCompletion(e,t),saveProgress()}function checkSetCompletion(e,t){const n=gameStructure.stages[e-1].levelsPerSet;let r=0;for(let s=1;s<=n;s++){const n=`${e}_${t}_${s}`;(gameState.completedLevels.has(n)||gameState.perfectLevels.has(n))&&r++}console.log(`Set ${e}-${t} completion: ${r}/${n}`),r===n&&(console.log(`Set ${e}-${t} is complete. Unlocking next set.`),unlockNextSet())}function unlockNextSet(){const e=gameState.currentStage,t=gameState.currentSet,n=gameStructure.stages[e-1];if(n)if(t<n.numSets){const n=t+1;gameState.unlockedSets[e]||(gameState.unlockedSets[e]=new Set),gameState.unlockedSets[e].add(n);const r=`${e}_${n}`;gameState.unlockedLevels[r]||(gameState.unlockedLevels[r]=new Set),gameState.unlockedLevels[r].add(1),console.log(`Unlocked set ${e}-${n} and its first level`),saveProgress()}else e<5&&unlockNextStage();else console.error(`Invalid stage: ${e}`)}function unlockNextStage(){const e=gameState.currentStage;if(e<5){const t=e+1;gameState.unlockedSets[t]||(gameState.unlockedSets[t]=new Set),gameState.unlockedSets[t].add(1);const n=`${t}_1`;gameState.unlockedLevels[n]||(gameState.unlockedLevels[n]=new Set),gameState.unlockedLevels[n].add(1),console.log(`Unlocked stage ${t}, set 1, level 1`),saveProgress()}}function showLevelIntro(e,t){if(currentGame.isCustomPractice)return void t();const n=document.createElement("div");n.className="slide-transition";const r=[3,6,9,10,13,16,19,20].includes(e),s=21===e;let o="normal-level";r&&(o="test-level"),s&&(o="boss-level"),n.innerHTML=`\n    <div class="slide-panel-left"></div>\n    <div class="slide-panel-right"></div>\n    <div class="level-announcement ${o}">\n      <h1>${s?"BOSS FIGHT!":`Stage ${gameState.currentStage}`}</h1>\n      <h2>${s?"FINAL CHALLENGE":`Level ${gameState.currentSet}-${e}`}</h2>\n      ${r?'<div class="test-badge">Review Challenge</div>':""}\n      ${s?'<div class="boss-badge">DANGER ZONE</div>':""}\n    </div>\n  `,document.body.appendChild(n);const a=n.querySelector(".level-announcement");if(n.offsetHeight,n.classList.add("show"),a.classList.add("show"),s){const e=n.querySelector(".level-announcement");if(e){e.style.background="linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)",e.style.boxShadow="0 0 30px rgba(255, 0, 0, 0.5)";const t=e.querySelector("h1");t&&(t.style.color="#ffffff",t.style.textShadow="0 0 20px rgba(255, 0, 0, 0.8)")}}setTimeout((()=>{t(),n.classList.remove("show"),a.classList.remove("show"),setTimeout((()=>{document.body.removeChild(n)}),400)}),1500)}document.addEventListener("DOMContentLoaded",(function(){document.getElementById("question-screen").classList.contains("visible")&&(console.log("Question screen is visible on load, adding admin button"),addAdminTestButton()),setTimeout((()=>{currentUser&&"admin123@gmail.com"===currentUser.email&&(console.log("Admin user detected on page load"),addAdminTestButton())}),2e3)})),document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".home-button").forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),showScreen("welcome-screen",!0)}))}))})),document.addEventListener("fullscreenchange",(function(){document.fullscreenElement||console.log("Exited full-screen")})),document.querySelector(".perks-container").innerHTML=`\n    ${Object.entries(PERK_CONFIG).map((([e,t])=>`\n        <button class="perk-button" id="${e}Perk" onclick="buyPerk('${e}')">\n            <i class="fas ${t.icon} perk-icon"></i>\n            <span class="perk-count">0</span>\n        </button>\n    `)).join("")}\n`,window.onload=async()=>{await checkExistingSession(),initializeGame(),updatePerkButtons();initializeParticles(document.getElementById("welcome-screen")),await loadCustomLists()};const customPracticeLists={lists:[],currentList:null,maxLists:5};function addCustomWordList(e=null){if(customPracticeLists.lists.length>=customPracticeLists.maxLists)return alert(`You can only create up to ${customPracticeLists.maxLists} custom lists.`),null;e||(e=`List ${customPracticeLists.lists.length+1}`);const t={id:Date.now(),name:e,words:[],translations:[]};return customPracticeLists.lists.push(t),saveCustomLists(),t}function translateWord(e){const t=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(e)}&langpair=en|he`;return fetch(t).then((e=>e.json())).then((t=>t.responseData.translatedText||e)).catch((()=>e))}function trackListPlay(e){const t=`listPlays_${e}`;let n=parseInt(localStorage.getItem(t)||"0");n++;const r=getUserListLimits();return localStorage.setItem(t,n),n>=r.maxPlays?(deleteCustomList(e),!1):r.maxPlays-n}function deleteWord(e){if(!e)return;const t=e.closest(".word-translation-item");t&&t.remove()}function addNewWord(){const e=document.getElementById("word-translation-list");if(!e)return;const t=document.createElement("div");t.className="word-translation-item",t.draggable=!0,t.innerHTML='\n        <div class="drag-handle">\n            <i class="fas fa-grip-vertical"></i>\n        </div>\n        <span class="source-word" contenteditable="true"></span>\n        <input type="text" class="target-word" placeholder="Hebrew translation">\n        <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n    ';const n=e.appendChild(t);initializeDragAndDrop(n);n.querySelector(".source-word").focus(),1===e.children.length&&makeWordListDraggable()}function initializeDragAndDrop(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),(e=t).setAttribute("draggable","true"),e.addEventListener("dragstart",(t=>{t.stopPropagation(),e.classList.add("dragging"),t.dataTransfer.setData("text/plain","")})),e.addEventListener("dragend",(t=>{t.stopPropagation(),e.classList.remove("dragging")}));const n=e.querySelector(".delete-word-btn");return n&&(n.onclick=()=>deleteWord(n)),e}function makeWordListDraggable(e){const t=document.getElementById("word-translation-list");if(!t)return;t.addEventListener("dragover",(e=>{e.preventDefault();const n=t.querySelector(".dragging");if(!n)return;const r=getDragAfterElement(t,e.clientY);r?t.insertBefore(n,r):t.appendChild(n)}));t.querySelectorAll(".word-translation-item").forEach((e=>initializeDragAndDrop(e)))}function createWordItem(e,t){const n=document.createElement("div");return n.className="word-translation-item",n.draggable=!0,n.innerHTML=`\n        <div class="drag-handle">\n            <i class="fas fa-grip-vertical"></i>\n        </div>\n        <span class="source-word" contenteditable="true">${e}</span>\n        <input type="text" class="target-word" value="${t}" placeholder="Hebrew translation">\n        <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n    `,n}function createWordTranslationItem(e="",t="",n=!1){const r=document.getElementById("word-translation-list"),s=document.createElement("div");s.className="word-translation-item",s.draggable=!0,s.innerHTML=`\n        <div class="drag-handle">\n            <i class="fas fa-grip-vertical"></i>\n        </div>\n        <span class="source-word ${n?"editable":""}" \n              contenteditable="${n}">${e}</span>\n        <input \n            type="text" \n            class="target-word ${n?"editable":""}"\n            value="${t}" \n            data-original="${t}"\n            ${n?"":"readonly"}\n            placeholder="Hebrew translation"\n        >\n        <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n    `,r.appendChild(s)}async function saveCustomListToSupabase(e){if(currentUser&&e)try{const{data:t,error:n}=await supabaseClient.from("custom_lists").upsert({user_id:currentUser.id,name:e.name,words:e.words,translations:e.translations,status:e.status||currentUser.status},{onConflict:"id"});if(n)throw n}catch(e){console.error("Error saving list to Supabase:",e),showNotification("Failed to save list","error")}}function saveCustomLists(){localStorage.setItem("simploxCustomLists",JSON.stringify(customPracticeLists.lists)),currentUser&&customPracticeLists.lists.forEach((e=>{saveCustomListToSupabase(e)}))}function processCustomWords(){const e=document.getElementById("custom-word-input"),t=document.getElementById("translation-results"),n=document.getElementById("word-translation-list"),r=getUserListLimits(),s=e.value.trim();if(!s)return void showNotification("Please enter at least one word.","error");let o=s.includes(",")?s.split(",").map((e=>e.trim())):s.split(/\s+/).filter((e=>e.length>0));o=o.map((e=>e.includes(" ")?[e]:e.split(/\s+/))).flat();const a=currentUser?r.maxWords:10;o.length>a&&(showNotification(`Maximum ${a} words allowed.`,"error"),o=o.slice(0,a)),n.innerHTML="",t.style.display="block",o.forEach((e=>{const t=createWordItem(e,findTranslation(e));n.appendChild(t),initializeDragAndDrop(t)})),makeWordListDraggable()}function findTranslation(e){for(const t in vocabularySets){const n=vocabularySets[t].words.indexOf(e.toLowerCase());if(-1!==n)return vocabularySets[t].translations[n]}return""}function makeWordListDraggable(){const e=document.getElementById("word-translation-list");if(!e)return;const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e);const n=document.getElementById("word-translation-list");n.addEventListener("dragover",(e=>{e.preventDefault();const t=n.querySelector(".dragging");if(!t)return;const r=getDragAfterElement(n,e.clientY);r?n.insertBefore(t,r):n.appendChild(t)})),n.addEventListener("drop",(e=>{e.preventDefault();const t=document.querySelector(".dragging");t&&(t.style.opacity="1",t.classList.remove("dragging"))}));n.querySelectorAll(".word-translation-item").forEach((e=>initializeDragAndDrop(e)))}function setupWordListKeyNavigation(){const e=document.getElementById("word-translation-list");e&&e.addEventListener("keydown",(e=>{const t=document.activeElement.closest(".word-translation-item");if(!t)return;let n;switch(e.key){case"ArrowUp":e.preventDefault(),n=t.previousElementSibling?.querySelector(".source-word");break;case"ArrowDown":e.preventDefault(),n=t.nextElementSibling?.querySelector(".source-word");break;case"ArrowRight":e.preventDefault(),n=t.querySelector(".target-word");break;case"ArrowLeft":e.preventDefault(),n=t.querySelector(".source-word")}n&&n.focus()}))}function editCustomList(e){const t=CustomListsManager.lists.find((t=>t.id===e));if(!t)return void showNotification("List not found","error");showScreen("custom-practice-screen");document.getElementById("custom-list-name").value=t.name;const n=document.getElementById("translation-results"),r=document.getElementById("word-translation-list");r.innerHTML="",(t.words||[]).forEach(((e,n)=>{const s=t.translations?.[n]||"",o=document.createElement("div");o.className="word-translation-item",o.draggable=!0,o.innerHTML=`\n            <div class="drag-handle">\n                <i class="fas fa-grip-vertical"></i>\n            </div>\n            <span class="source-word" contenteditable="true">${e}</span>\n            <input type="text" class="target-word" value="${s}" placeholder="Hebrew translation">\n            <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n        `,r.appendChild(o),initializeDragAndDrop(o)})),n.style.display="block",customPracticeLists.currentList=t,makeWordListDraggable()}function saveCurrentList(){const e=customPracticeLists.currentList,t=document.getElementById("custom-list-name"),n=document.getElementById("word-translation-list"),r=t.value.trim()||(e?e.name:`List ${customPracticeLists.lists.length+1}`),s=[],o=[];if(n.querySelectorAll(".word-translation-item").forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),n=e.querySelector(".target-word").value.trim();t&&n&&(s.push(t),o.push(n))})),e){const t=customPracticeLists.lists.findIndex((t=>t.id===e.id));-1!==t&&(customPracticeLists.lists[t]={...e,name:r,words:s,translations:o}),customPracticeLists.currentList=null}else{if(!canCreateMoreLists())return void showNotification("Maximum lists limit reached","error");customPracticeLists.lists.push({id:Date.now(),name:r,words:s,translations:o})}saveCustomLists(),showCustomListsManager()}function canCreateMoreLists(){const e=getUserListLimits();return customPracticeLists.lists.length<e.maxLists}function saveCurrentList(){if(!canCreateMoreLists())return void alert(`You can only create ${getUserListLimits().maxLists} custom lists.`);const e=document.getElementById("custom-list-name"),t=document.getElementById("custom-word-input"),n=document.getElementById("word-translation-list"),r=document.getElementById("translation-results"),s=e.value.trim()||`List ${customPracticeLists.lists.length+1}`,o=[],a=[];n.querySelectorAll(".word-translation-item").forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),n=e.querySelector(".target-word").value.trim();t&&n&&(o.push(t),a.push(n))}));const i=getUserListLimits();if(o.length>i.maxWords)return void alert(`You can only create lists with up to ${i.maxWords} words.`);const c={id:Date.now(),name:s,words:o,translations:a};customPracticeLists.lists.push(c),localStorage.setItem("simploxCustomLists",JSON.stringify(customPracticeLists.lists)),e.value="",t.value="",n.innerHTML="",r.style.display="none",showCustomListsManager()}function updateListsDisplay(){const e=document.getElementById("custom-lists-container");if(!e)return;const t=CustomListsManager.getListLimits();if(e.innerHTML="",!CustomListsManager.lists||!Array.isArray(CustomListsManager.lists)||0===CustomListsManager.lists.length)return void(e.innerHTML='<p style="color: white; text-align: center;">No custom lists created yet. Create your first list!</p>');let n=!1;currentUser&&(n="teacher"===currentUser.role,currentUser.role||supabaseClient.from("user_profiles").select("role").eq("id",currentUser.id).single().then((({data:e})=>{e&&"teacher"===e.role&&(currentUser.role="teacher",updateListsDisplay())})).catch((e=>console.error("Error checking user role:",e)))),CustomListsManager.lists.forEach((r=>{if(!r||!r.id)return;const s=updateCustomListSchema(r),o=s.words?.length||0,a=o>=6,i=document.createElement("div");i.className="custom-list-item collapsed "+(r.isShared?"shared-list":""),i.dataset.listId=r.id;const c=currentUser&&r.userId===currentUser.id;let l=`\n            <button class="main-button practice-button" ${a?"":"disabled"}>\n                ${a?"Practice":`Need ${6-o} more`}\n            </button>\n            <button class="main-button edit-button">Edit</button>\n            <button class="main-button delete-button">Delete</button>\n        `;n&&c&&(l+='\n                <button class="main-button share-button">\n                    <i class="fas fa-share-alt"></i> Share\n                </button>\n            '),i.innerHTML=`\n           <div class="list-actions">\n               ${l}\n           </div>\n           <div class="list-header">\n               <h3>${r.name||"Unnamed List"}</h3>\n               <div class="list-summary">\n                   <span class="word-count ${a?"":"insufficient"}">${o} words</span>\n                   ${a?"":'<span class="warning-text">(Minimum 6 needed)</span>'}\n                   <span style="margin-left: 1rem;">${t.playDisplay} plays available</span>\n                   ${s.max_levels>0?`<span class="level-info">Supports ${s.max_levels} levels</span>`:""}\n                   <p class="word-preview">${Array.isArray(r.words)?r.words.slice(0,5).join(", "):""}${r.words&&r.words.length>5?"...":""}</p>\n               </div>\n           </div>\n       `,e.appendChild(i);const d=i.querySelector(".practice-button");d&&(a?d.onclick=function(){startCustomListPractice(r.id)}:(d.style.opacity="0.6",d.style.cursor="not-allowed"));const u=i.querySelector(".edit-button");u&&(u.onclick=function(){console.log("Edit button clicked for list:",r.id),editCustomList(r.id)});const m=i.querySelector(".delete-button");m&&(m.onclick=function(){console.log("Delete button clicked for list:",r.id),deleteCustomList(r.id)});const g=i.querySelector(".share-button");g&&(g.onclick=function(){showShareModal(r.id)});const p=i.querySelector(".list-header");p&&(p.onclick=function(){toggleListCollapse(r.id)})}))}function startCustomListPractice(e){const t=customPracticeLists.lists.find((t=>t.id===e));if(!t)return;const n=`listPlays_${e}`;let r=parseInt(localStorage.getItem(n)||"0");if(r>=getUserListLimits().maxPlays)return deleteCustomList(e),void showCustomListsManager();r++,localStorage.setItem(n,r),currentGame={words:t.words,translations:t.translations,currentIndex:0,correctAnswers:0,firstAttempt:!0,isCustomPractice:!0,startingCoins:gameState.coins,startingPerks:{...gameState.perks},practiceState:{currentLevel:1,words:t.words,translations:t.translations,unlockedLevels:new Set([1]),progress:{},maxLevel:10,listId:e,playsUsed:r}},startCustomLevel(1,currentGame.practiceState)}function calculateCustomLevelWords(e,t){const{words:n,translations:r}=t,s={1:{start:0,count:3,isTest:!1},2:{start:3,count:3,isTest:!1},3:{start:0,count:6,isTest:!0},4:{start:6,count:3,isTest:!1},5:{start:9,count:3,isTest:!1},6:{start:6,count:6,isTest:!0},7:{start:12,count:4,isTest:!1},8:{start:16,count:4,isTest:!1},9:{start:12,count:8,isTest:!0},10:{start:0,count:20,isTest:!0,isFinal:!0}}[e];return s?{words:n.slice(s.start,s.start+s.count),translations:r.slice(s.start,s.start+s.count),isTest:s.isTest,isFinal:s.isFinal}:null}function startCustomLevel(e){const t=document.querySelector(".powerups-container");t&&(t.style.display="none");const n=customGameState.getWordsForLevel(e);if(!n||!n.words.length)return showNotification("Practice completed!","success"),void showScreen("custom-practice-screen");customGameState.currentLevel=e,currentGame={words:n.words,translations:n.translations,currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!!n.isTest&&Math.random()<.5,mixed:n.isTest,speedChallenge:!1,isCustomPractice:!0,startingCoins:gameState.coins,startingPerks:{...gameState.perks},timeBonus:0,initialTimeRemaining:null,streakBonus:!0,levelStartTime:Date.now(),questionStartTime:0,wrongStreak:0,progressLost:0,customList:customGameState.currentList,customLevel:e,isFinalLevel:n.isFinal},showLevelIntro(e,(()=>{showScreen("question-screen"),updateProgressCircle(),loadNextQuestion(),startTimer(10*currentGame.words.length)}))}function showCustomListsManager(){showScreen("custom-practice-screen"),Promise.resolve(CustomListsManager.initialize()).then((()=>{const e=document.getElementById("custom-lists-container");if(!e)return;const t=getUserListLimits(),n=currentUser?.status||"unregistered";e.innerHTML="";const r=CustomListsManager.lists||[];0!==r.length?r.forEach((r=>{const s=`listPlays_${r.id}`,o=parseInt(localStorage.getItem(s)||"0"),a=t.maxPlays-o;if(a<=0)return;const i=document.createElement("div");i.className="custom-list-item collapsed "+(r.is_shared?"shared-list":""),i.dataset.listId=r.id,i.innerHTML=`\n                    <div class="list-actions">\n                        <button class="start-button practice-button">Practice</button>\n                        <button class="edit-button" data-list-id="${r.id}">Edit</button>\n                        <button class="start-button delete-button">Delete</button>\n                        ${"premium"===n?`\n                            <button class="share-button" onclick="showShareModal(${r.id})">\n                                <i class="fas fa-share-alt"></i> Share\n                            </button>\n                        `:""}\n                    </div>\n                    <div class="list-header">\n                        <h3>${r.name}</h3>\n                        <div class="list-summary">\n                            <span>${r.words?.length||0} words</span>\n                            <span style="color: ${a<=2?"#ff4444":"#ffffff"}; margin-left: 1rem;">\n                                ${t.playDisplay}\n                            </span>\n                            <p class="word-preview">${(r.words||[]).slice(0,5).join(", ")}${r.words?.length>5?"...":""}</p>\n                        </div>\n                    </div>\n                `;i.querySelector(".practice-button").addEventListener("click",(()=>startCustomListPractice(r.id)));i.querySelector(".edit-button").addEventListener("click",(()=>{console.log("Edit button clicked for list:",r.id),editCustomList(r.id)}));i.querySelector(".delete-button").addEventListener("click",(()=>{console.log("Delete button clicked for list:",r.id),deleteCustomList(r.id)}));i.querySelector(".list-header").addEventListener("click",(()=>toggleListCollapse(r.id))),e.appendChild(i)})):e.innerHTML='<p style="color: white; text-align: center;">No custom lists created yet. Create your first list!</p>'})).catch((e=>{console.error("Failed to initialize custom lists:",e),showNotification("Error loading lists","error")}))}function getUserListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1};switch(currentUser.status||"unregistered"){case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"âˆž"};case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"âˆž"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1}}}function toggleListCollapse(e){const t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);"Save"!==t.querySelector(".edit-button").textContent&&t.classList.toggle("collapsed")}function toggleEditMode(e){e="string"==typeof e?parseInt(e):e;const t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);if(!t)return;const n=t.querySelector(".edit-button");if(!n)return;const r=document.getElementById(`list-${e}`);if("Edit"===n.textContent){n.textContent="Save",t.classList.remove("collapsed"),t.setAttribute("data-in-edit-mode","true");const s=customPracticeLists.lists.find((t=>t.id===e));if(!s)return;r.innerHTML="",s.words.forEach(((e,t)=>{const n=document.createElement("div");n.className="word-translation-item",n.draggable=!0,n.innerHTML=`\n                <div class="drag-handle">\n                    <i class="fas fa-grip-vertical"></i>\n                </div>\n                <span class="source-word" contenteditable="true">${e}</span>\n                <input type="text" class="target-word" value="${s.translations[t]}" placeholder="Hebrew translation">\n                <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n            `,r.appendChild(n),initializeDragAndDrop(n)})),makeWordListDraggable(e)}else saveListChanges(e,r,t)}function editCustomList(e){const t=CustomListsManager.lists.find((t=>t.id===e));if(!t)return void showNotification("List not found","error");showScreen("custom-practice-screen");const n=document.getElementById("custom-list-name");n&&(n.value=t.name||"");const r=document.getElementById("translation-results"),s=document.getElementById("word-translation-list");s?(s.innerHTML="",Array.isArray(t.words)&&t.words.forEach(((e,n)=>{const r=t.translations&&n<t.translations.length?t.translations[n]:"",o=document.createElement("div");o.className="word-translation-item",o.draggable=!0,o.innerHTML=`\n                <div class="drag-handle">\n                    <i class="fas fa-grip-vertical"></i>\n                </div>\n                <span class="source-word" contenteditable="true">${e}</span>\n                <input type="text" class="target-word" value="${r}" placeholder="Hebrew translation">\n                <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n            `,s.appendChild(o);const a=o.querySelector(".delete-word-btn");a&&(a.onclick=function(){deleteWord(this)}),initializeDragAndDrop(o)})),r&&(r.style.display="block"),customPracticeLists.currentList=t,makeWordListDraggable()):console.error("Word translation list element not found")}function loadCustomList(e){const t=customPracticeLists.lists.find((t=>t.id===e));if(!t)return;customPracticeLists.currentList=t;document.getElementById("custom-word-input").value=t.words.join(", ");document.getElementById("custom-list-name").value=t.name,processCustomWords(),showScreen("custom-practice-screen")}function deleteCustomList(e){e="string"==typeof e?parseInt(e):e,customPracticeLists.lists=customPracticeLists.lists.filter((t=>t.id!==e)),localStorage.removeItem(`listPlays_${e}`),localStorage.setItem("simploxCustomLists",JSON.stringify(customPracticeLists.lists)),showCustomListsManager()}function addWordToList(e){const t=document.getElementById(`list-${e}`);if("Save"!==document.querySelector(`.custom-list-item:has([data-list-id="${e}"])`).querySelector(".edit-button").textContent)return;const n=document.createElement("div");n.className="word-translation-item",n.draggable=!0,n.innerHTML='\n        <div class="drag-handle">\n            <i class="fas fa-grip-vertical"></i>\n        </div>\n        <span class="source-word" contenteditable="true"></span>\n        <input type="text" class="target-word" placeholder="Hebrew translation">\n        <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n    ',t.firstChild?t.insertBefore(n,t.firstChild):t.appendChild(n),initializeDragAndDrop(n);n.querySelector(".source-word").focus()}function makeWordListDraggable(e){const t=document.getElementById(`list-${e}`);if(!t)return;t.addEventListener("dragover",(e=>{e.preventDefault();const n=t.querySelector(".dragging");if(!n)return;const r=getDragAfterElement(t,e.clientY);r?t.insertBefore(n,r):t.appendChild(n)})),t.addEventListener("drop",(e=>{e.preventDefault();const t=document.querySelector(".dragging");t&&(t.style.opacity="1",t.classList.remove("dragging"))}));t.querySelectorAll(".word-translation-item").forEach((e=>initializeDragAndDrop(e)))}function getDragAfterElement(e,t){if(!e)return null;const n=[...e.querySelectorAll(".word-translation-item:not(.dragging)")];return n.length?n.reduce(((e,n)=>{const r=n.getBoundingClientRect(),s=t-r.top-r.height/2;return s<0&&s>e.offset?{offset:s,element:n}:e}),{offset:Number.NEGATIVE_INFINITY}).element:null}function toggleEditMode(e){const t=document.querySelector(`.custom-list-item:has([data-list-id="${e}"])`),n=t.querySelector(".edit-button"),r=document.getElementById(`list-${e}`);if("Edit"===n.textContent){n.textContent="Save",t.classList.remove("collapsed");const s=customPracticeLists.lists.find((t=>t.id===e));r.innerHTML="",s.words.forEach(((e,t)=>{const n=document.createElement("div");n.className="word-translation-item",n.draggable=!0,n.innerHTML=`\n                <div class="drag-handle">\n                    <i class="fas fa-grip-vertical"></i>\n                </div>\n                <span class="source-word" contenteditable="true">${e}</span>\n                <input type="text" class="target-word" value="${s.translations[t]}" placeholder="Hebrew translation">\n                <button class="delete-word-btn" onclick="deleteWord(this)">âŒ</button>\n            `,r.appendChild(n)})),makeWordListDraggable(e)}else saveListChanges(e,r,t)}function saveListChanges(e,t,n){const r=customPracticeLists.lists.find((t=>t.id===parseInt(e))),s=n.querySelector(".edit-button"),o=t.querySelectorAll(".word-translation-item"),a=[],i=[];o.forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),n=e.querySelector(".target-word").value.trim();t&&n&&(a.push(t),i.push(n))})),r.words=a,r.translations=i,saveCustomLists(),s.textContent="Edit",n.removeAttribute("data-in-edit-mode"),n.classList.add("collapsed");n.querySelector(".list-summary").innerHTML=`\n        <span>${a.length} words</span>\n        <p class="word-preview">${a.slice(0,5).join(", ")}${a.length>5?"...":""}</p>\n    `}function toggleAuthMode(){const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function updateLocalSharedLists(e){currentUser&&(customPracticeLists.lists.push({id:e.local_id,supabaseId:e.id,name:e.name,words:e.words,translations:e.translations,is_shared:!0,shared_by:e.shared_by}),saveCustomLists())}async function debugShareList(e,t){try{console.log("Debug share function called with:",{listId:e,recipientId:t});if(!CustomListsManager.lists.find((t=>String(t.id)===String(e))))return console.error("List not found for debug sharing"),!1;const{data:n,error:r}=await supabaseClient.from("custom_lists").insert({user_id:t,name:"Shared list",words:["test"],translations:["test"],is_shared:!0});if(r){console.error("Debug share error:",r);const{data:e,error:t}=await supabaseClient.from("information_schema.tables").select("table_name").eq("table_schema","public");return t?console.error("Error fetching tables:",t):console.log("Available tables:",e),!1}return console.log("Debug share success:",n),!0}catch(e){return console.error("Debug share exception:",e),!1}}async function shareListWithUser(e,t){try{if(!currentUser)return!1;if("teacher"!==currentUser.role)return showNotification("Only teachers can share lists","error"),!1;console.log("Sharing list:",e,"with user:",t);const n=CustomListsManager.lists.find((t=>String(t.id)===String(e)));if(!n)return console.error("List not found for sharing:",e),!1;console.log("Found list to share:",n.name);const{data:r,error:s}=await supabaseClient.from("custom_lists").insert({user_id:t,name:`${n.name} (Shared by ${currentUser.user_metadata?.username||"Teacher"})`,words:n.words||[],translations:n.translations||[],is_shared:!0,shared_with:[t],shared_by:currentUser.id,created_at:(new Date).toISOString(),status:"active"});return s?(console.error("Error sharing list:",s),!1):(console.log("List shared successfully"),showNotification("List shared successfully!","success"),closeShareModal(),!0)}catch(e){return console.error("Error in shareListWithUser:",e),showNotification("Error sharing list","error"),!1}}function showSuccessToast(e){const t=document.createElement("div");t.className="toast success",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("hide"),setTimeout((()=>document.body.removeChild(t)),600)}),3e3)}function showErrorToast(e){const t=document.createElement("div");t.className="toast error",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("hide"),setTimeout((()=>document.body.removeChild(t)),600)}),3e3)}function closeShareModal(){const e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}async function loadSharedLists(){if(!currentUser)return[];const{data:e,error:t}=await supabaseClient.from("custom_lists").select("*").or(`shared_with.cs.{${currentUser.id}},is_shared.eq.true`);return t?(console.error("Error loading shared lists:",t),[]):e.map((e=>({...e,isShared:!0})))}function showShareModal(e){if(console.log("Opening share modal for list:",e),"teacher"!==currentUser?.role)return void showNotification("Only teachers can share lists","error");const t=document.querySelector(".share-modal"),n=document.querySelector(".modal-backdrop");t&&t.remove(),n&&n.remove();const r=document.createElement("div");r.className="modal-backdrop",r.onclick=closeShareModal,document.body.appendChild(r);const s=document.createElement("div");s.className="share-modal",s.innerHTML='\n        <h3 class="share-modal-header">Share List</h3>\n        <p class="share-modal-description">Choose students to share this list with:</p>\n        <div class="users-list">Loading students...</div>\n        <button class="main-button modal-close" onclick="closeShareModal()">Cancel</button>\n    ',document.body.appendChild(s);const o=s.querySelector(".users-list");supabaseClient.from("user_profiles").select("id, username, role").eq("role","student").neq("id",currentUser.id).then((({data:t,error:n})=>{if(n)return console.error("Error fetching users:",n),void(o.innerHTML='<div class="user-item"><span>Error loading users</span></div>');t&&0!==t.length?(o.innerHTML=t.map((e=>`\n                <div class="user-item">\n                    <div class="user-info">\n                        <i class="fas fa-user"></i>\n                        <span>${e.username||"Student"}</span>\n                    </div>\n                    <button class="main-button small-button" data-user-id="${e.id}">\n                        <i class="fas fa-share-alt"></i> Share\n                    </button>\n                </div>\n            `)).join(""),s.querySelectorAll(".user-item button").forEach((t=>{t.onclick=async()=>{const n=t.getAttribute("data-user-id");t.disabled=!0;const r=t.innerHTML;t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sharing...';await shareListWithUser(e,n)?(t.innerHTML='<i class="fas fa-check"></i> Shared',t.style.background="linear-gradient(135deg, var(--success), #45b649)"):(t.disabled=!1,t.innerHTML=r)}}))):o.innerHTML='<div class="user-item"><span>No students available</span></div>'}))}function closeShareModal(){const e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&(e.classList.add("fade-out"),setTimeout((()=>e.remove()),300)),t&&(t.classList.add("fade-out"),setTimeout((()=>t.remove()),300))}function handleProgressionAfterCompletion(e){if(!e&&currentGame.streakBonus){gameState.coins+=5,pulseCoins(5);const e=`${gameState.currentStage}_${gameState.currentSet}`;gameState.unlockedLevels[e]||(gameState.unlockedLevels[e]=new Set),gameState.unlockedLevels[e].add(gameState.currentLevel);const t=gameStructure.stages[gameState.currentStage-1],n=gameState.currentLevel===t.levelsPerSet,r=gameState.currentSet===t.numSets;n?r?showScreen("stage-screen"):(gameState.currentSet++,startLevel(1)):startLevel(gameState.currentLevel+1),saveProgress()}else startLevel(gameState.currentLevel)}function hideUpgradePrompt(){const e=document.querySelector(".upgrade-prompt");e&&(e.classList.remove("show"),setTimeout((()=>e.remove()),300))}function showUpgradePrompt(e){const t={screen:document.querySelector(".screen.visible")?.id,stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel};t.screen&&localStorage.setItem("gameContext",JSON.stringify(t)),currentUser?checkUpgradeStatus()?e&&e():showUpgradeScreen():showUnregisteredWarning((()=>{e&&e()}))}function hideUpgradePromptAndContinue(){const e=document.getElementById("upgrade-screen");e&&e.classList.remove("visible"),isFrozen=!1,clearTimer(),gameState.currentLevel?proceedWithLevel(gameState.currentLevel):showScreen("welcome-screen")}function handleUpgradeClick(){hideUpgradePrompt(),showPaymentScreen()}async function checkUserAccess(){if(!currentUser)return{fullAccess:!1,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}};const{data:e,error:t}=await supabaseClient.from("user_profiles").select("status, payment_pending").eq("id",currentUser.id).single();return t?null:e.payment_pending||"free"===e.status||"pending"===e.status?{fullAccess:!1,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}:"premium"===e.status?{fullAccess:!0,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}:void 0}function toggleAuthMode(){const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function showSetScreen(e){gameState.currentStage=e,showStageCascadeScreen(),setTimeout((()=>{const t=document.querySelector(`.stage-wrapper[data-stage="${e}"]`);t&&!t.classList.contains("open")&&t.classList.add("open")}),100)}function showUnregisteredWarning(e){if(window.unregisteredWarningShown)return void(e&&e());window.unregisteredWarningShown=!0;const t=document.createElement("div");t.className="fullscreen-signup-page",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: var(--gradient);\n        z-index: 2000;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: space-between;\n        padding: 2rem;\n        animation: fadeIn 0.3s ease-in-out;\n    ",t.innerHTML='\n        <div class="signup-header" style="width: 100%; display: flex; justify-content: flex-start; margin-bottom: 2rem;">\n            <button class="skip-signup-button" style="\n                background: rgba(255,255,255,0.15);\n                border: none;\n                color: var(--text);\n                padding: 0.75rem 1.5rem;\n                border-radius: 50px;\n                font-size: 0.9rem;\n                cursor: pointer;\n                transition: all 0.3s ease;\n            ">\n                Skip\n            </button>\n        </div>\n        \n        <div class="signup-content" style="\n            text-align: center;\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            max-width: 600px;\n            width: 100%;\n        ">\n            <h2 style="\n                font-size: 2rem;\n                color: var(--gold);\n                margin-bottom: 1.5rem;\n                animation: floatAnimation 3s ease-in-out infinite;\n            ">Save Your Progress!</h2>\n            \n            <p style="\n                font-size: 1.2rem;\n                line-height: 1.6;\n                margin-bottom: 2rem;\n                color: var(--text);\n            ">Create a free account to track your vocabulary progress, earn rewards, and unlock more advanced content</p>\n            \n            <div class="features-list" style="\n                display: flex;\n                flex-direction: column;\n                gap: 1rem;\n                margin-bottom: 3rem;\n                text-align: left;\n            ">\n                <div class="feature-item" style="\n                    display: flex;\n                    align-items: center;\n                    gap: 1rem;\n                ">\n                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>\n                    <span>Track your learning progress</span>\n                </div>\n                <div class="feature-item" style="\n                    display: flex;\n                    align-items: center;\n                    gap: 1rem;\n                ">\n                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>\n                    <span>Practice custom word lists</span>\n                </div>\n                <div class="feature-item" style="\n                    display: flex;\n                    align-items: center;\n                    gap: 1rem;\n                ">\n                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>\n                    <span>Earn coins for premium content</span>\n                </div>\n            </div>\n        </div>\n        \n        <div class="signup-footer" style="\n            width: 100%;\n            display: flex;\n            justify-content: center;\n            padding-bottom: 2rem;\n        ">\n            <button class="signup-now-button" style="\n                background: var(--gold);\n                color: var(--primary-dark);\n                border: none;\n                padding: 1.25rem 3rem;\n                border-radius: 50px;\n                font-size: 1.2rem;\n                font-weight: bold;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);\n                animation: pulseAnimation 1.5s infinite ease-in-out;\n            ">\n                Sign Up Now\n            </button>\n        </div>\n    ',document.body.appendChild(t);const n=document.createElement("style");n.textContent="\n        @keyframes fadeIn {\n            from { opacity: 0; }\n            to { opacity: 1; }\n        }\n        \n        @keyframes floatAnimation {\n            0%, 100% { transform: translateY(0); }\n            50% { transform: translateY(-10px); }\n        }\n        \n        @keyframes pulseAnimation {\n            0%, 100% { transform: scale(1); box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2); }\n            50% { transform: scale(1.05); box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4); }\n        }\n    ",document.head.appendChild(n);const r=t.querySelector(".skip-signup-button"),s=t.querySelector(".signup-now-button");r.addEventListener("click",(function(){document.body.removeChild(t),n.parentNode&&n.parentNode.removeChild(n),e&&e()})),s.addEventListener("click",(function(){document.body.removeChild(t),n.parentNode&&n.parentNode.removeChild(n),showScreen("welcome-screen"),setTimeout((function(){const e=document.getElementById("authModal");if(e){e.classList.add("show");const t=document.getElementById("signupForm"),n=document.getElementById("loginForm");t&&n&&(t.classList.remove("hidden"),n.classList.add("hidden"))}}),100)}))}function handleCustomPracticeCompletion(){if(currentGame.streakBonus&&currentGame.correctAnswers===currentGame.words.length){currentGame.firstAttempt?(gameState.coins+=3,pulseCoins(3)):(gameState.coins+=1,pulseCoins(1)),gameState.coins+=5,pulseCoins(5),updateAllCoinDisplays(),saveProgress();const e=currentGame.currentCustomLevel+1;e<=10?(currentGame.practiceState.unlockedLevels.add(e),currentGame.practiceState.progress[currentGame.currentCustomLevel]=!0,showLevelIntro(e,(()=>{startCustomLevel(e,currentGame.practiceState)}))):(showScreen("custom-practice-screen"),alert("Congratulations! Practice set completed!"))}else startCustomLevel(currentGame.currentCustomLevel,currentGame.practiceState)}async function processPayment(e){const t={monthly:{amount:9.99,interval:"month"},yearly:{amount:99.99,interval:"year"},lifetime:{amount:299.99,interval:"once"}},{data:n,error:r}=await supabaseClient.from("payment_requests").insert({user_id:currentUser.id,plan_type:e,amount:t[e].amount,status:"pending"}).select().single();r?console.error("Payment error:",r):showPaymentMethods(t[e].amount,n.id)}async function processPayment(e){const t={bit:299.99,paybox:299.99,kashkash:299.99,bank:299.99},n=generateReferenceCode();try{const{data:r,error:s}=await supabaseClient.from("payment_requests").insert({user_id:currentUser.id,payment_method:e,amount:t[e],reference_code:n,status:"pending",submission_time:new Date}).select();if(s)throw s;showPaymentDetails(e,n)}catch(e){console.error("Payment error:",e)}}function showPaymentDetails(e,t){const n={bit:{recipient:"050-1234567",label:"Phone Number"},paybox:{recipient:"050-7654321",label:"Payment Link"},kashkash:{recipient:"KASHKASH-123",label:"ID"},bank:{bank:"Leumi",branch:"123",account:"45678",label:"Bank Details"}}[e];document.querySelector(".payment-container").innerHTML=`\n       <h2 class="welcome-title">Payment Details</h2>\n       <div class="payment-info">\n           <p class="reference">Reference Code: <strong>${t}</strong></p>\n           <p>Amount: â‚ª299.99</p>\n           ${"bank"===e?`\n               <p>Bank: ${n.bank}</p>\n               <p>Branch: ${n.branch}</p>\n               <p>Account: ${n.account}</p>\n           `:`\n               <p>${n.label}: ${n.recipient}</p>\n           `}\n           <p>Please save your reference code and send payment confirmation via WhatsApp</p>\n           <button class="start-button" onclick="openWhatsApp('${t}')">\n               <i class="fab fa-whatsapp"></i> Send Via WhatsApp\n           </button>\n           <button class="back-button" onclick="showPaymentScreen()">\n               <i class="fas fa-arrow-left"></i> Back\n           </button>\n       </div>\n   `}function openWhatsApp(e){const t=encodeURIComponent(`Payment confirmation for reference: ${e}\nEmail: ${currentUser.email}`);window.open(`https://wa.me/972545996417?text=${t}`)}function createAdminVerificationInterface(){return'\n        <div class="admin-verification">\n            <h2>Payment Verification Dashboard</h2>\n            <div class="pending-payments"></div>\n        </div>\n    '}async function loadPendingPayments(){const{data:e,error:t}=await supabaseClient.from("payment_requests").select("\n            id,\n            user_id,\n            payment_method,\n            amount,\n            reference_code,\n            created_at,\n            user_profiles (\n                username,\n                email\n            )\n        ").eq("status","pending").order("created_at",{ascending:!1});if(t)return void console.error("Error loading payments:",t);document.querySelector(".pending-payments").innerHTML=e.map((e=>`\n        <div class="payment-request" data-id="${e.id}">\n            <div class="payment-info">\n                <p>Reference: ${e.reference_code}</p>\n                <p>User: ${e.user_profiles.username}</p>\n                <p>Amount: $${e.amount}</p>\n                <p>Method: ${e.payment_method}</p>\n                <p>Date: ${new Date(e.created_at).toLocaleString()}</p>\n            </div>\n            <div class="verification-actions">\n                <button onclick="verifyPayment('${e.id}', '${e.user_id}')">\n                    Verify Payment\n                </button>\n                <button onclick="rejectPayment('${e.id}')" class="reject">\n                    Reject\n                </button>\n            </div>\n        </div>\n    `)).join("")}async function verifyPayment(e,t){const{error:n}=await supabaseClient.from("payment_requests").update({status:"verified",verification_time:new Date,admin_verified_by:currentUser.id}).eq("id",e);if(n)return void console.error("Error updating payment:",n);const{error:r}=await supabaseClient.from("user_profiles").update({status:"premium",payment_pending:!1}).eq("id",t);r?console.error("Error updating user profile:",r):loadPendingPayments()}async function rejectPayment(e){const{error:t}=await supabaseClient.from("payment_requests").update({status:"rejected",verification_time:new Date,admin_verified_by:currentUser.id}).eq("id",e);t?console.error("Error rejecting payment:",t):loadPendingPayments()}function toggleParentPhone(){const e=document.getElementById("isAdult").checked,t=document.getElementById("parentPhoneGroup"),n=document.getElementById("parentPhone");t.style.display=e?"none":"block",n.required=!e}function showUpgradeScreen(){localStorage.getItem(`upgradeRequested_${currentUser.id}`)?hideUpgradePromptAndContinue():showScreen("upgrade-screen")}setupWordListKeyNavigation();class RateLimiter{constructor(e=100,t=6e4){this.requests=new Map}checkLimit(e){const t=Date.now(),n=(this.requests.get(e)||[]).filter((e=>t-e<this.timeWindow));return!(n.length>=this.maxRequests)&&(n.push(t),this.requests.set(e,n),!0)}}function sanitizeInput(e){return e.replace(/[<>]/g,"").trim().slice(0,500)}const SessionManager={maxInactiveTime:18e5,lastActivity:Date.now(),init(){document.addEventListener("click",(()=>this.updateActivity())),document.addEventListener("keypress",(()=>this.updateActivity())),setInterval((()=>this.checkSession()),6e4)},updateActivity(){this.lastActivity=Date.now()},async checkSession(){Date.now()-this.lastActivity>this.maxInactiveTime&&(await handleLogout(),modalSystem.show("timeout",{title:"Session Expired",message:"Please log in again"}))}},DataValidator={validateGameProgress:e=>({...e,coins:Math.min(e.coins,1e5),perks:Object.fromEntries(Object.entries(e.perks).map((([e,t])=>[e,Math.min(t,100)])))}),validateCustomList:e=>({...e,words:e.words.slice(0,1e3).map(sanitizeInput),translations:e.translations.slice(0,1e3).map(sanitizeInput)})};function escapeHTML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function createListItem(e){return`\n        <div class="list-item">\n            <h3>${escapeHTML(e.name)}</h3>\n            <p>${escapeHTML(e.description)}</p>\n        </div>\n    `}const ErrorHandler={async logError(e,t){currentUser&&await supabaseClient.from("error_logs").insert([{user_id:currentUser.id,error:e.message,stack:e.stack,context:t,timestamp:new Date}]),console.error(`${t}:`,e)},handleError(e,t){this.logError(e,t),modalSystem.show("error",{title:"Oops!",message:"Something went wrong. Please try again."})}};function toggleParentFields(){const e=document.getElementById("isAdult").checked,t=document.getElementById("parentInfoSection"),n=document.getElementById("adultInfoSection"),r=t.querySelectorAll("input"),s=n.querySelectorAll("input");e?(t.style.display="none",n.style.display="block",r.forEach((e=>e.required=!1)),s.forEach((e=>e.required=!0))):(t.style.display="block",n.style.display="none",r.forEach((e=>e.required=!0)),s.forEach((e=>e.required=!1)))}async function handleUpgradeSubmit(e){e.preventDefault();const t=document.getElementById("isAdult").checked;try{const{data:e}=await supabaseClient.from("user_profiles").select("username, created_at").eq("id",currentUser.id).single();let n={user_id:currentUser.id,is_adult:t,full_name:t?document.getElementById("fullName").value:document.getElementById("parentName").value,phone:t?document.getElementById("phone").value:document.getElementById("parentPhone").value,parent_name:t?null:document.getElementById("parentName").value,parent_phone:t?null:document.getElementById("parentPhone").value,referral_source:document.getElementById("referralSource").value};if(!validateForm(t))return void alert("Please fill in all required fields");const{data:r,error:s}=await supabaseClient.from("upgrade_requests").insert([n]).select();if(s)throw s;const{error:o}=await supabaseClient.from("user_profiles").update({status:"pending"}).eq("id",currentUser.id);if(o)throw o;localStorage.setItem(`upgradeRequested_${currentUser.id}`,"true");const a=document.createElement("div");a.className="confirmation-popup",a.innerHTML="\n            <h2>Thank You!</h2>\n            <p>We've received your upgrade request. We'll contact you soon with payment details.</p>\n            <button onclick=\"continueAfterUpgrade()\">Continue Playing</button>\n        ",document.body.appendChild(a),setTimeout((()=>a.classList.add("show")),100)}catch(e){console.error("Upgrade Request Error:",e),alert("Error processing request. Please try again.")}}function continueAfterUpgrade(){const e=document.querySelector(".confirmation-popup");e&&(e.classList.remove("show"),setTimeout((()=>e.remove()),300));const t=document.getElementById("upgrade-screen");t&&t.classList.remove("visible");const n=document.getElementById("upgradeForm");n&&n.reset(),currentUser&&updateUserStatusDisplay("pending"),hideUpgradePromptAndContinue()}function validateForm(e){return e?document.getElementById("fullName").value&&document.getElementById("phone").value:document.getElementById("parentName").value&&document.getElementById("parentPhone").value}function skipUpgrade(){hideUpgradePromptAndContinue()}function updateUserStatusDisplay(e){const t=document.querySelector(".user-profile-section"),n=document.getElementById("userTierText");if(t&&n){if(n.className="status-badge",currentUser)switch(t.style.display="block",e){case"free":default:n.classList.add("trial"),n.textContent="Trial Account";break;case"pending":n.classList.add("pending"),n.textContent="Premium Pending";break;case"premium":n.classList.add("premium"),n.textContent="Premium"}else n.classList.add("unregistered"),n.textContent="Unregistered",t.style.display="none";currentUser&&updateUserStats()}else console.warn("User profile elements not found")}async function updateUserStats(){try{const{data:e}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single(),{data:t}=await supabaseClient.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();e&&(document.getElementById("totalCoins").textContent=e.coins||0),t&&(document.getElementById("totalWords").textContent=t.unique_words_practiced||0)}catch(e){console.error("Error updating user stats:",e)}}function setupUserStatusSubscription(){if(!currentUser)return;return supabaseClient.channel("user-status-"+currentUser.id).on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_profiles",filter:`id=eq.${currentUser.id}`},(e=>{console.log("Profile update received:",e.new),e.new&&e.new.status&&(updateUserStatusDisplay(e.new.status),"premium"===e.new.status&&showPremiumCelebration())})).subscribe((e=>{console.log("Subscription status:",e)}))}function restoreGameContext(){const e=localStorage.getItem("gameContext");if(e){const t=JSON.parse(e);return gameState.currentStage=t.stage||1,gameState.currentSet=t.set||1,gameState.currentLevel=t.level,localStorage.removeItem("gameContext"),!0}return!1}function checkUpgradeStatus(){if(!currentUser)return!1;const e=localStorage.getItem(`upgradeRequested_${currentUser.id}`),t="premium"===currentUser.status,n="pending"===currentUser.status;return e||t||n}function navigateHome(){console.log("Navigating home with full refresh"),saveProgress(),window.location.reload(!0)}function forceReload(){console.log("Force Reload Initiated"),window.location&&(window.location.href=window.location.href),window.location.reload&&window.location.reload(!0),window.location.replace(window.location.pathname)}async function showLeaderboard(){showScreen("leaderboard-screen");const e=document.getElementById("leaderboard-entries");try{async function t(){const{data:t,error:n}=await supabaseClient.from("player_leaderboard").select("*");if(n)return void console.error("Leaderboard fetch error:",n);const r=e.children,s={};Array.from(r).forEach((e=>{const t=e.querySelector("[data-username]").dataset.username;s[t]=e.getBoundingClientRect()})),e.innerHTML=t.map(((e,t)=>`\n                <div class="leaderboard-entry ${e.username===currentUser?.user_metadata?.username?"you":""} ${t<3?`rank-${t+1}`:""}"\n                     data-rank="${t+1}">\n                    <div>${e.player_rank}</div>\n                    <div data-username="${e.username}">${e.username||"Anonymous"}</div>\n                    <div>${e.total_levels_completed}</div>\n                    <div>${e.total_words_learned}</div>\n                </div>\n            `)).join("");const o=e.children;Array.from(o).forEach((e=>{const t=e.querySelector("[data-username]").dataset.username;if(s[t]){const n=s[t],r=e.getBoundingClientRect(),o=n.top-r.top;o>0?e.classList.add("moving-up"):o<0&&e.classList.add("moving-down"),e.addEventListener("animationend",(()=>{e.classList.remove("moving-up","moving-down")}),{once:!0})}}))}await t();const n=setInterval(t,1e4),r=document.getElementById("leaderboard-screen");r&&(r.dataset.pollInterval&&clearInterval(parseInt(r.dataset.pollInterval)),r.dataset.pollInterval=n)}catch(s){console.error("Detailed leaderboard error:",s),e.innerHTML=`<p>Error loading leaderboard: ${s.message}</p>`}}function cleanupLeaderboard(){const e=document.getElementById("leaderboard-screen");e&&(e.dataset.channel&&(supabaseClient.removeChannel(e.dataset.channel),delete e.dataset.channel),e.dataset.pollInterval&&(clearInterval(parseInt(e.dataset.pollInterval)),delete e.dataset.pollInterval))}async function updatePlayerStats(e,t,n){if(currentUser&&"premium"===currentUser.status)try{const{data:e,error:t}=await supabaseClient.from("player_stats").select("*").eq("user_id",currentUser.id).single();if(t&&"PGRST116"!==t.code)throw t;const n=[...new Set(currentGame.words)].length,r={user_id:currentUser.id,total_levels_completed:(e?.total_levels_completed||0)+1,unique_words_practiced:(e?.unique_words_practiced||0)+n,last_updated:(new Date).toISOString()},{error:s}=await supabaseClient.from("player_stats").upsert(r,{onConflict:"user_id",returning:"minimal"});if(s)throw s;await WordsManager.updateWords(n)}catch(e){console.error("Error updating player stats:",e)}}async function checkExistingSession(){console.log("Checking for existing user session");try{const{data:{session:e}}=await supabaseClient.auth.getSession();if(e){console.log("Found existing session for user:",e.user.id),currentUser=e.user;const{data:t}=await supabaseClient.from("user_profiles").select("status, role").eq("id",currentUser.id).single();return t&&(currentUser.status=t.status,currentUser.role=t.role,updateUserStatusDisplay(t.status)),initializeStatusCheck(),updateAuthUI(),updateGuestPlayButton(),!0}return console.log("No active session found"),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),!1}catch(e){return console.error("Session check error:",e),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),!1}}function setupAutoSave(){const e=setInterval((()=>{gameState.currentStage&&gameState.currentSet&&gameState.currentLevel&&(console.log("Auto-saving game progress"),saveProgress())}),3e4);return window.addEventListener("beforeunload",(()=>{gameState.currentStage&&gameState.currentSet&&gameState.currentLevel&&(console.log("Saving progress before page unload"),saveProgress())})),e}function showPremiumCelebration(){const e=document.createElement("div");e.className="premium-celebration",e.innerHTML='\n        <div class="celebration-content">\n            <h1 class="celebration-title">Congratulations!</h1>\n            <p class="celebration-message">You\'ve unlocked Premium Access!</p>\n            <button class="celebration-button" onclick="handlePremiumCelebrationComplete()">\n                Continue\n            </button>\n        </div>\n    ',document.body.appendChild(e),setTimeout((()=>{e.classList.add("show")}),100)}function handlePremiumCelebrationComplete(){const e=document.querySelector(".premium-celebration");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),showScreen("welcome-screen")}),500))}function handlePremiumCelebrationComplete(){const e=document.querySelector(".premium-celebration");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),showScreen("welcome-screen")}),500))}function initializeStatusCheck(){if(window.statusCheckInterval&&clearInterval(window.statusCheckInterval),currentUser){const e=setInterval((async()=>{try{if(!currentUser||!currentUser.id)return void clearInterval(window.statusCheckInterval);const{data:e,error:t}=await supabaseClient.from("user_profiles").select("status").eq("id",currentUser.id).single();if(t||!e)return clearInterval(window.statusCheckInterval),currentUser=null,void updateAuthUI();updateUserStatusDisplay(e.status),"premium"===e.status&&"premium"!==currentUser.status&&(currentUser.status="premium",showPremiumCelebration())}catch(e){console.error("Status check error:",e),clearInterval(window.statusCheckInterval),currentUser=null,updateAuthUI()}}),3e3);window.statusCheckInterval=e}}document.querySelectorAll(".home-button").forEach((e=>{e.onclick=function(){console.log("Home button clicked"),forceReload()}})),document.addEventListener("DOMContentLoaded",(function(){console.log("DOM fully loaded, initializing game"),gameInit.init().then((()=>{console.log("Game initialization completed");const e=localStorage.getItem("gameContext");if(e&&!window.location.hash)try{const t=JSON.parse(e);Date.now()-(t.timestamp||0)<864e5&&(console.log("Found recent game context, updating game state:",t),gameState.currentStage=t.stage||gameState.currentStage,gameState.currentSet=t.set||gameState.currentSet,gameState.currentLevel=t.level||gameState.currentLevel)}catch(e){console.error("Error parsing saved context:",e)}}))})),document.addEventListener("DOMContentLoaded",(function(){setupAutoSave()})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("otpInput");e&&e.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),this.value.length>4&&(this.value=this.value.slice(0,4))}))}));let currentArcadeSession={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],playerRank:null,winnerScreenShown:!1,startTime:null,endTime:null};async function showArcadeModal(){const e=document.getElementById("arcade-modal"),t=document.getElementById("teacher-view"),n=document.getElementById("player-view"),r=document.getElementById("arcadeUsername"),s=r?r.closest(".input-group"):null;try{if(currentUser){const{data:e}=await supabaseClient.from("user_profiles").select("role").eq("id",currentUser.id).single();if("teacher"===e?.role){const e=Math.floor(1e3+9e3*Math.random()).toString();currentArcadeSession.otp=e,currentArcadeSession.teacherId=currentUser.id,currentArcadeSession.participants=[],currentArcadeSession.isInitialized=!1,window.arcadeChannel=supabaseClient.channel(`arcade:${e}`,{config:{broadcast:{self:!0}}}),window.arcadeChannel.on("broadcast",{event:"player_join"},(({payload:e})=>{if(console.log("Player join event received:",e),!currentArcadeSession.participants.find((t=>t.username===e.username))){currentArcadeSession.participants.push({username:e.username,wordsCompleted:0,coins:0}),document.getElementById("player-count").textContent=currentArcadeSession.participants.length;const t=document.getElementById("arcade-leaderboard");t&&null!==t.offsetParent&&updateAllPlayersProgress()}})).subscribe();window.location.origin,window.location.pathname;generateQRCode(e),document.getElementById("otp").textContent=e,t.style.display="block",n.style.display="none",initializeWordGoalSlider()}else if(t.style.display="none",n.style.display="block",r&&s){const e=currentUser.user_metadata?.username||currentUser.email.split("@")[0];r.value=e,r.readOnly=!0,r.style.display="none";const t=document.createElement("div");t.className="username-display",t.textContent=`Joining as: ${e}`,s.insertBefore(t,r)}}else if(t.style.display="none",n.style.display="block",r){r.readOnly=!1,r.style.display="block";const e=s?.querySelector(".username-display");e&&e.remove()}e.style.display="block"}catch(e){console.error("Arcade setup error:",e),alert("Failed to initialize arcade")}}function initializeWordGoalSlider(){const e=document.getElementById("wordGoalSlider"),t=document.getElementById("wordGoalDisplay"),n=document.getElementById("wordGoalInput"),r=document.querySelectorAll(".slider-stop");e&&t&&n&&(e.min=0,e.max=200,e.value=50,t.textContent=50,n.value=50,e.addEventListener("input",(function(){const e=parseInt(this.value);t.textContent=e,n.value=e})),n.addEventListener("input",(function(){let n=parseInt(this.value)||0;n=Math.max(0,Math.min(200,n)),e.value=n,t.textContent=n,this.value=n})),r.forEach((r=>{r.addEventListener("click",(function(){const r=parseInt(this.dataset.value);e.value=r,t.textContent=r,n.value=r}))})))}function showCustomListDropdown(){console.log("Current user:",currentUser),console.log("All custom lists:",customPracticeLists.lists);const e=customPracticeLists.lists.filter((e=>e.user_id===currentUser.id||e.shared_with&&e.shared_with.includes(currentUser.id)));console.log("Filtered lists for teacher:",e),supabaseClient.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`).then((({data:e,error:t})=>{if(t)return void console.error("Error fetching lists:",t);console.log("Lists from database:",e);showListsDropdown(e||[])}))}function showListsDropdown(e){const t=document.querySelector(".custom-list-dropdown");t&&t.remove();const n=document.createElement("div");n.className="custom-list-dropdown",e&&0!==e.length?n.innerHTML=`\n            <div class="dropdown-content">\n                ${e.map((e=>`\n                    <div class="list-item" data-id="${e.id}">\n                        <span>${e.name}</span>\n                        <span class="word-count">(${Array.isArray(e.words)?e.words.length:0} words)</span>\n                    </div>\n                `)).join("")}\n            </div>\n        `:n.innerHTML='\n            <div class="list-item">\n                <span>No custom lists available</span>\n            </div>\n        ';document.querySelector(".custom-lists-selector").appendChild(n),n.querySelectorAll(".list-item[data-id]").forEach((t=>{t.onclick=r=>{r.stopPropagation();const s=t.dataset.id,o=e.find((e=>e.id==s));o&&(addSelectedList(o),n.remove())}}))}function addSelectedList(e){const t=document.querySelector(".selected-lists"),n=document.createElement("div");n.className="selected-list",n.dataset.id=e.id,n.innerHTML=`\n        <span>${e.name} (${e.words.length} words)</span>\n        <button class="remove-list" onclick="this.parentElement.remove()">Ã—</button>\n    `,t.appendChild(n)}function startPlayerCounting(e){async function t(){try{const{data:t}=await supabaseClient.from("game_progress").select("arcade_session").eq("user_id",e).single();t?.arcade_session?.participants&&(document.getElementById("player-count").textContent=t.arcade_session.participants.length)}catch(e){console.error("Count update error:",e)}}window.countInterval&&clearInterval(window.countInterval),t(),window.countInterval=setInterval(t,2e3)}async function joinArcade(){const e=document.getElementById("otpInput").value.trim().toUpperCase();try{window.arcadeChannel=supabaseClient.channel(`arcade:${e}`);const t=currentUser?currentUser.user_metadata?.username:getRandomSimploName();let n;currentArcadeSession.playerName=t,window.arcadeChannel.on("broadcast",{event:"game_end"},(({payload:e})=>{handleGameEnd(e),currentArcadeSession.state=e.state,"active"===e.state&&(currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,startArcadeGame(),n&&clearInterval(n))})).on("broadcast",{event:"game_playing"},(({payload:e})=>{"active"===e.state&&(currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,startArcadeGame(),n&&clearInterval(n))})).subscribe(),await window.arcadeChannel.send({type:"broadcast",event:"player_join",payload:{username:t,joinedAt:(new Date).toISOString()}}),document.getElementById("arcade-modal").style.display="none",showWaitingScreen(),n=setInterval((async()=>{await window.arcadeChannel.send({type:"broadcast",event:"check_game_status"})}),2e3),setTimeout((()=>{n&&clearInterval(n)}),3e5)}catch(e){console.error("Join error:",e),alert("Failed to join arcade")}}function showJoinButton(){const e=document.getElementById("joinGameButton");e&&(e.style.display="block",e.textContent="Join Active Game")}async function getCurrentCoins(){if(!currentUser)return 0;const{data:e}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();return e?.coins||0}function getRandomSimploName(){const e=["Simplosaurus","Simplodian","Simpleton","Simplonius","Simplomancer","Simplonaut","Simplobot","Simplozilla","Simplopedia","Simplotron","Simplodex","Simplomatic","Simplomobile","Simplocopter","Simplonium","Simplotastic","Simplominator","Simploverse","Simplonado","Simplophant","Simplowizard","Simplodragon","Simplosapien","Simploninja","Simplowarrior"];return e[Math.floor(Math.random()*e.length)]}function showWaitingScreen(){if("active"===currentArcadeSession.state)return void startArcadeGame();document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")}));const e=document.getElementById("waiting-screen");e.classList.add("visible");const t=document.getElementById("joinGameButton");t&&(t.style.display="active"===currentArcadeSession.state?"block":"none");const n=setInterval((()=>{if(window.arcadeChannel)try{window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:currentArcadeSession.playerName,requestType:"waitingCheck"}})}catch(e){console.error("Error checking game status:",e)}}),2e3),r=document.getElementById("waiting-player-count");r&&(r.parentElement.style.display="none"),e.dataset.pollInterval=n,setTimeout((()=>{n&&clearInterval(n)}),3e5)}async function initializeArcade(){try{const e=document.querySelector(".initialize-button"),t=document.querySelector(".end-arcade-button");e.style.display="none",t.classList.add("visible"),currentArcadeSession.state="active",currentArcadeSession.isInitialized=!0,currentArcadeSession.participants=currentArcadeSession.participants.map((e=>({...e,wordsCompleted:0,coins:e.coins||0}))),updateAllPlayersProgress(),initializeModeratorInactivityTimer(),await window.arcadeChannel.send({type:"broadcast",event:"game_playing",payload:{wordPool:currentArcadeSession.wordPool,wordGoal:currentArcadeSession.wordGoal,state:"active",timestamp:Date.now()}})}catch(e){console.error("Initialize error:",e),alert("Failed to start game")}}function showModeratorScreen(){document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")}));document.getElementById("moderator-screen").classList.add("visible");const e=document.getElementById("moderatorOtp");if(e&&currentArcadeSession.otp){e.textContent=currentArcadeSession.otp;const t=`${window.location.origin+window.location.pathname}#join=${currentArcadeSession.otp}`;console.log("QR URL generated:",t),new QRious({element:document.getElementById("qrCode"),value:t,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"});const n=new Date,r={sessionDate:n.toLocaleDateString(),sessionStartTime:n.toLocaleTimeString(),sessionWordGoal:currentArcadeSession.wordGoal,activeParticipantCount:currentArcadeSession.participants.length};Object.entries(r).forEach((([e,t])=>{const n=document.getElementById(e);n&&(n.textContent=t)}))}initializeLeaderboard(),initializeModeratorInactivityTimer()}function initializeLeaderboard(){document.getElementById("arcade-leaderboard").innerHTML='\n        <div class="leaderboard-header">\n            <div>Rank</div>\n            <div>Player</div>\n            <div>Words</div>\n            <div>Coins</div>\n        </div>\n    ',currentArcadeSession.participants.length>0&&updateAllPlayersProgress()}const readyPhrases=["Born Ready!","Ready to Roll!","All Set!","Locked & Loaded!","Ready Player!","Game Face On!","In Position!","Ready to Rock!","Standing By!","Powered Up!","Challenge Ready!","Mission Ready!","Ready to Shine!","Bring it On!","Ready to Rumble!","Set for Success!","Level Ready!","Shields Up!","Word Warrior Ready!","Let's Do This!"],shineColors=["#1E90FF","#FF1493","#00CED1","#9370DB","#FFD700","#FF4500","#32CD32","#FF69B4","#4169E1","#8A2BE2"];function updateAllPlayersProgress(){const e=[...currentArcadeSession.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)),t=`\n        <div class="leaderboard-header">\n            <div>Rank</div>\n            <div>Player</div>\n            <div>Words</div>\n            <div>Coins</div>\n        </div>\n        ${e.map(((e,t)=>"active"===currentArcadeSession.state&&e.username?`\n                <div class="leaderboard-entry ${t<3?`rank-${t+1}`:""}"\n                     data-rank="${t+1}">\n                    <div class="rank">${t+1}</div>\n                    <div data-username="${e.username}" class="player-name">${e.username}</div>\n                    <div data-words="${e.wordsCompleted||0}" class="words">${e.wordsCompleted||0}</div>\n                    <div data-coins="${e.coins||0}" class="coins">${e.coins||0}</div>\n                </div>\n            `:`\n                <div class="leaderboard-entry waiting ${t<3?`rank-${t+1}`:""}"\n                     data-rank="${t+1}">\n                    <div class="rank">${t+1}</div>\n                    <div data-username="${e.username}" class="player-name">${e.username}</div>\n                    <div class="player-status-waiting">\n                        <span class="status-text" style="color: ${shineColors[Math.floor(Math.random()*shineColors.length)]}">${readyPhrases[Math.floor(Math.random()*readyPhrases.length)]}</span>\n                    </div>\n                    <div class="waiting-indicator">\n                        <span class="dot"></span>\n                        <span class="dot"></span>\n                        <span class="dot"></span>\n                    </div>\n                </div>\n            `)).join("")}\n    `;document.getElementById("arcade-leaderboard").innerHTML=t,document.getElementById("activeParticipantCount").textContent=e.length,document.getElementById("sessionDate").textContent=(new Date).toLocaleDateString(),document.getElementById("sessionStartTime").textContent=(new Date).toLocaleTimeString(),document.getElementById("sessionWordGoal").textContent=currentArcadeSession.wordGoal}async function startArcade(){const e=Array.from(document.querySelectorAll(".stage-checkboxes input:checked")).map((e=>parseInt(e.value))),t=document.querySelector(".stage-warning");if(0===e.length)return t&&(t.style.display="block"),void console.error("No stages selected");t&&(t.style.display="none"),currentArcadeSession.wordPool=generateWordPool(e);const n=document.getElementById("wordGoal")||document.getElementById("wordGoalSlider");if(n){const e=parseInt(n.value);currentArcadeSession.wordGoal=isNaN(e)?50:e,console.log("Selected word goal:",currentArcadeSession.wordGoal)}else console.error("Word goal slider element not found. Available elements:",document.querySelectorAll('select, input[type="range"]')),currentArcadeSession.wordGoal=50,console.warn("Defaulting to word goal of 50");currentArcadeSession.state="started",currentArcadeSession.participants=[],window.arcadeChannel.on("broadcast",{event:"progress_update"},(({payload:e})=>{updatePlayerProgress(e),checkGameEnd()})).on("broadcast",{event:"check_game_status"},(async({payload:e})=>{if(console.log("Received game status check:",e),await window.arcadeChannel.send({type:"broadcast",event:"game_state_response",payload:{state:currentArcadeSession.state,wordPool:currentArcadeSession.wordPool,wordGoal:currentArcadeSession.wordGoal,requestType:e?.requestType||"standard"}}),"lateJoin"===e?.requestType&&"active"===currentArcadeSession.state&&e.username&&!currentArcadeSession.participants.find((t=>t.username===e.username))){currentArcadeSession.participants.push({username:e.username,wordsCompleted:0,coins:0,lateJoin:!0});const t=document.getElementById("activeParticipantCount");t&&(t.textContent=currentArcadeSession.participants.length),updateAllPlayersProgress()}}));const r=document.getElementById("arcade-modal");if(r&&(r.style.display="none"),showModeratorScreen(),currentUser?.id===currentArcadeSession.teacherId){const e=initializeModeratorIdleDetection();currentArcadeSession.idleDetection=e}}function generateWordPool(e){let t=[];return e.forEach((e=>{Object.keys(vocabularySets).forEach((n=>{if(n.startsWith(`${e}_`)){const e=vocabularySets[n];e.words.forEach(((n,r)=>{t.push({word:n,translation:e.translations[r]})}))}}))})),t.sort((()=>Math.random()-.5))}function cleanupModeratorScreen(){const e=document.getElementById("moderator-screen");e&&e.dataset.channelSubscription&&(supabaseClient.removeChannel(e.dataset.channelSubscription),delete e.dataset.channelSubscription)}async function startArcadeGame(){const e=document.getElementById("waiting-screen");e&&e.dataset.pollInterval&&(clearInterval(parseInt(e.dataset.pollInterval)),delete e.dataset.pollInterval);document.getElementById("question-screen").classList.add("visible"),document.getElementById("waiting-screen").classList.remove("visible");const t=currentArcadeSession.playerName||currentUser?.user_metadata?.username||getRandomSimploName();document.querySelectorAll(".coin-count").forEach((e=>{e.textContent=currentGame.coins||0,e.style.display="flex"})),document.querySelectorAll(".coins-container").forEach((e=>{e.style.display="flex"}));const n=document.querySelector(".perks-container"),r=document.querySelector(".powerups-container");n.style.display="none",r.style.display="flex";let s=0;if(currentUser&&"premium"===currentUser.status)try{const{data:e,error:n}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();!n&&e&&(s=e.coins,console.log("Loaded initial coins:",s),currentGame.coins=s,updateAllCoinDisplays(),currentArcadeSession.initialCoins=s,await window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:t,wordsCompleted:0,coins:s,timestamp:Date.now()}}))}catch(e){console.error("Failed to load coins:",e)}if(currentArcadeSession.startTime=Date.now(),currentGame={currentIndex:0,correctStreak:0,wrongStreak:0,words:currentArcadeSession.wordPool||[],wordsCompleted:0,coins:s,lastBroadcast:Date.now(),initialCoinsLoaded:!0,playerUsername:t},!currentGame.words||0===currentGame.words.length){if(console.error("Empty word pool detected. Trying to fetch from currentArcadeSession"),!(currentArcadeSession.wordPool&&currentArcadeSession.wordPool.length>0))return showErrorToast("Failed to join game: No words available"),void showScreen("welcome-screen");currentGame.words=currentArcadeSession.wordPool}try{await window.arcadeChannel.send({type:"broadcast",event:"player_initialized",payload:{username:t,initialCoins:s,wordsCompleted:0,timestamp:Date.now(),lateJoin:"active"===currentArcadeSession.state}})}catch(e){console.error("Initialization broadcast failed:",e)}initializePowerups();const o=supabaseClient.channel("arcade_leaderboard").on("postgres_changes",{event:"*",schema:"public",table:"arcade_participants"},(e=>{console.log("Direct DB Change:",e),updateAllPlayersProgress()})).subscribe();currentArcadeSession.leaderboardChannel=o,window.arcadeChannel.on("broadcast",{event:"player_initialized"},(({payload:e})=>{console.log("Player Initialization Received:",e);const t=currentArcadeSession.participants.findIndex((t=>t.username===e.username)),n={username:e.username,wordsCompleted:0,coins:e.initialCoins||0,lateJoin:e.lateJoin||!1};-1===t?currentArcadeSession.participants.push(n):currentArcadeSession.participants[t]=n,updateAllPlayersProgress(),updateArcadeProgress()})).on("broadcast",{event:"progress_update"},(({payload:e})=>{if(console.log("Progress update received:",e),e.username!==currentArcadeSession.playerName){const t=currentArcadeSession.participants.findIndex((t=>t.username===e.username));-1!==t?currentArcadeSession.participants[t]={...currentArcadeSession.participants[t],...e}:currentArcadeSession.participants.push({username:e.username,wordsCompleted:e.wordsCompleted||0,coins:e.coins||0}),updatePlayerProgress({username:e.username,wordsCompleted:e.wordsCompleted,coins:e.coins})}})).on("broadcast",{event:"player_completed"},(({payload:e})=>{console.log("Player completed event:",e),currentArcadeSession.completedPlayers.includes(e.username)||currentArcadeSession.completedPlayers.push(e.username),updatePlayerProgress(e),currentArcadeSession.completedPlayers.length>=3&&endArcadeForAll()})).on("broadcast",{event:"powerup_effect"},(({payload:e})=>{if(e.targetUser===currentArcadeSession.playerName){const t=e.powerup;switch(showNotification(`${e.fromUser} ${t.message} you!`,t.type),t.name){case"High Five":case"Fist Bump":const e=currentGame.coins;currentGame.coins+=t.effect,document.querySelectorAll(".coin-count").forEach((t=>{animateNumber(t,e,currentGame.coins)}));break;case"Energy Boost":currentGame.coinMultiplier=2,currentGame.boostedAnswersLeft=3;break;case"Freeze":const n=document.querySelectorAll(".buttons button");n.forEach((e=>e.disabled=!0)),setTimeout((()=>{n.forEach((e=>e.disabled=!1))}),t.duration);break;case"Coin Storm":currentGame.coinBlockedAnswers=3;break;case"Screen Shake":const r=document.getElementById("question-screen");r.classList.add("screen-shake"),setTimeout((()=>{r.classList.remove("screen-shake")}),t.duration)}updatePlayerProgress({username:currentArcadeSession.playerName,coins:currentGame.coins,wordsCompleted:currentGame.wordsCompleted})}})).on("broadcast",{event:"coin_effect"},(({payload:e})=>{if(e.targetUser===currentArcadeSession.playerName){const t=currentGame.coins;currentGame.coins+=e.amount,document.querySelectorAll(".coin-count").forEach((e=>{animateNumber(e,t,currentGame.coins)}));const n=currentArcadeSession.participants.findIndex((e=>e.username===currentArcadeSession.playerName));-1!==n&&(currentArcadeSession.participants[n].coins=currentGame.coins,updateModeratorLeaderboard()),"blessing"===e.type?showNotification(`${e.fromUser} high-fived you!`,"blessing"):"curse"===e.type&&showNotification(`${e.fromUser} poisoned you!`,"curse"),updatePlayerProgress({username:currentArcadeSession.playerName,coins:currentGame.coins,wordsCompleted:currentGame.wordsCompleted})}})).on("broadcast",{event:"game_end"},(({payload:e})=>{handleGameEnd(e)})),updateAllCoinDisplays(),loadNextArcadeQuestion(),window.arcadeTimeouts=[],window.arcadeIntervals=[]}async function updateArcadeCoins(e){const t=currentGame.coins;if(currentGame.coins+=e,currentUser)try{const{error:e}=await supabaseClient.from("game_progress").update({coins:currentGame.coins}).eq("user_id",currentUser.id);if(e)throw e}catch(e){console.error("Failed to update coins in database:",e),currentGame.coins=t}return document.querySelectorAll(".coin-count").forEach((e=>{animateCoinsChange(e,t,currentGame.coins)})),currentGame.coins}async function getCurrentCoinsForArcade(){if(!currentUser)return parseInt(localStorage.getItem("simploxCustomCoins")||"0");try{const{data:e,error:t}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();return t&&console.error("Coin retrieval error:",t),e?.coins||0}catch(e){return console.error("Unexpected coin retrieval error:",e),0}}function loadNextArcadeQuestion(){if(!currentGame.words.length)return;const e=document.getElementById("question-word"),t=document.getElementById("buttons"),n=Math.floor(Math.random()*currentGame.words.length),r=currentGame.words[n],s=Math.random()<.5;e.textContent=s?r.translation:r.word;let o=[s?r.word:r.translation];for(;o.length<3;){const e=currentGame.words[Math.floor(Math.random()*currentGame.words.length)],t=s?e.word:e.translation;o.includes(t)||o.push(t)}o=o.sort((()=>Math.random()-.5)),t.innerHTML="",o.forEach((e=>{const n=document.createElement("button");n.textContent=e,n.onclick=()=>handleArcadeAnswer(e===(s?r.word:r.translation)),t.appendChild(n)})),currentGame.words.splice(n,1)}function updateArcadeProgress(){const e=document.querySelector(".progress-circle .progress"),t=2*Math.PI*54,n=currentGame.wordsCompleted?currentGame.wordsCompleted/currentArcadeSession.wordGoal:0;e.style.strokeDasharray=`${t} ${t}`,e.style.strokeDashoffset=t*(1-n)}function showArcadeCompletionScreen(e){const t=document.createElement("div");t.className="arcade-completion-modal",t.innerHTML=`\n        <div class="completion-modal-content">\n            <h2>Arcade Complete!</h2>\n            <div class="completion-stats">\n                <div class="stat-item">\n                    <i class="fas fa-book"></i>\n                    <span>Words: ${e.wordsCompleted}</span>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-coins"></i>\n                    <span>Coins: ${e.coins}</span>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-trophy"></i>\n                    <span>Rank: ${e.rank}</span>\n                </div>\n            </div>\n            <button onclick="exitArcade()" class="start-button">Exit</button>\n        </div>\n    `,document.body.appendChild(t),requestAnimationFrame((()=>t.classList.add("show")))}function exitArcadeCompletion(){const e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),showScreen("welcome-screen")}),300))}function exitArcade(){window.arcadeChannel&&window.arcadeChannel.unsubscribe(),currentArcadeSession={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50},showScreen("welcome-screen"),document.querySelector(".completion-overlay")?.remove()}async function handleArcadeAnswer(e){const t=Date.now();if(t-(currentGame.lastAnswerTime||0)<1e3)return;currentGame.lastAnswerTime=t;const n=currentArcadeSession.playerName||currentUser?.user_metadata?.username||getRandomSimploName();if(e){if(currentGame.wordsCompleted++,currentGame.correctStreak++,currentGame.wrongStreak=0,currentUser&&"premium"===currentUser.status){const e=Math.floor(Math.random()*currentGame.words.length),t=currentGame.words[e],r=t.word||t;await trackWordEncounter(r,"arcade");window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:n,wordsCompleted:currentGame.wordsCompleted,coins:gameState.coins||currentGame.coins||0,timestamp:Date.now()}})}else{let e=5;currentGame.correctStreak>=3&&(e+=5),CoinsManager.updateCoins(e).then((()=>{window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:n,wordsCompleted:currentGame.wordsCompleted,coins:gameState.coins,timestamp:Date.now()}})}))}updateArcadeProgress(),currentGame.wordsCompleted>=currentArcadeSession.wordGoal&&handlePlayerCompletedGoal(n)}else{currentGame.wrongStreak++,currentGame.correctStreak=0;let e=2;currentGame.wrongStreak>=3&&(e+=3),CoinsManager.updateCoins(-e).then((()=>{window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:n,wordsCompleted:currentGame.wordsCompleted,coins:gameState.coins,timestamp:Date.now()}})}))}loadNextArcadeQuestion()}function checkGameEnd(){currentArcadeSession.participants.filter((e=>e.wordsCompleted>=currentArcadeSession.wordGoal)).length>=3&&window.arcadeChannel.send({type:"broadcast",event:"game_end"})}function handleGameEnd(e){if(console.log("Game End Payload:",e),!e)return;let t=e.podiumPlayers||[];if(0===t.length)return console.warn("No player data found in game end payload"),void showScreen("welcome-screen");for(t=t.filter((e=>e.rank&&e.rank<=3)).sort(((e,t)=>e.rank-t.rank));t.length<3;)t.push({username:"---",wordsCompleted:0,coins:0,rank:t.length+1});e.forcedEnd?showScreen("welcome-screen"):currentUser?.id!==e.teacherId?showFinalResultsForPlayer(t):showModeratorVictoryScreen(t)}function showPodiumPlayerResults(e){const t=currentArcadeSession.playerName,n=currentArcadeSession.podiumRanks[t].rank,r=currentArcadeSession.initialCoins||0,s=(gameState.coins||currentGame.coins||0)-r,o=currentGame.wordsCompleted||0,a=document.createElement("div");a.className="arcade-completion-modal",a.innerHTML=`\n        <div class="completion-modal-content">\n            <h2>Congratulations!</h2>\n            <p class="personal-result">You finished in ${getOrdinal(n)} place!</p>\n            \n            <div class="your-stats">\n                <h3>Your Results</h3>\n                <div class="completion-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0;">\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-language" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Words Learned</span>\n                        <strong style="font-size: 1.5rem;">${o}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Coins Earned</span>\n                        <strong style="font-size: 1.5rem;">${s}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Your Rank</span>\n                        <strong style="font-size: 1.5rem;">${n}</strong>\n                    </div>\n                </div>\n            </div>\n            \n            <button onclick="exitArcadeCompletion()" class="start-button">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(a),requestAnimationFrame((()=>a.classList.add("show")))}function showConsolationScreen(){const e=document.createElement("div");e.className="arcade-completion-modal";const t=["ðŸŒŸ","ðŸŽ®","ðŸš€","ðŸ’ª","ðŸ†","ðŸ”¥","ðŸ‘","âœ¨"],n=t[Math.floor(Math.random()*t.length)];e.innerHTML=`\n        <div class="completion-modal-content">\n            <h2 style="font-size: 3rem; margin-bottom: 1rem;">${n}</h2>\n            <h2>Game Complete!</h2>\n            <p style="font-size: 1.2rem; margin: 1.5rem 0; line-height: 1.5;">\n                Great effort! You did your best and gained valuable practice.\n                <br><br>\n                Keep playing to improve your skills and speed!\n            </p>\n            <button onclick="exitArcadeCompletion()" class="start-button" style="margin-top: 1.5rem;">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(e),requestAnimationFrame((()=>e.classList.add("show")))}function showFinalResultsForPlayer(e){const t=currentArcadeSession.playerName;if(currentArcadeSession.winnerScreenShown&&currentArcadeSession.podiumRanks&&currentArcadeSession.podiumRanks[t])return;currentArcadeSession.podiumRanks&&currentArcadeSession.podiumRanks[t]?showPodiumPlayerResults(e):showConsolationScreen()}function showPersonalVictoryScreen(e){if(currentArcadeSession.winnerScreenShown)return;currentArcadeSession.winnerScreenShown=!0,console.log(`Showing personal victory screen with rank: ${e}`);const t=document.createElement("div");t.className="arcade-completion-modal";const n={1:{title:"ðŸ† FIRST PLACE! ðŸ†",message:"Incredible! You've claimed the top spot!",color:"var(--gold)"},2:{title:"ðŸ¥ˆ SECOND PLACE! ðŸ¥ˆ",message:"Amazing job! You've secured second place!",color:"var(--silver)"},3:{title:"ðŸ¥‰ THIRD PLACE! ðŸ¥‰",message:"Well done! You've earned third place!",color:"var(--bronze)"}}[e]||{title:"Game Complete!",message:"You've reached the word goal!",color:"var(--accent)"},r=currentArcadeSession.initialCoins||0,s=(gameState.coins||currentGame.coins||0)-r;t.innerHTML=`\n        <div class="completion-modal-content">\n            <h2 style="color: ${n.color}">${n.title}</h2>\n            <p>${n.message}</p>\n            <div class="completion-stats">\n                <div class="stat-item">\n                    <i class="fas fa-language"></i>\n                    <span>Words Learned</span>\n                    <strong>${currentGame.wordsCompleted}</strong>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-coins"></i>\n                    <span>Coins Earned</span>\n                    <strong>${s}</strong>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-trophy"></i>\n                    <span>Your Rank</span>\n                    <strong>${e}</strong>\n                </div>\n            </div>\n            <button onclick="exitArcadeCompletion()" class="start-button">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(t),requestAnimationFrame((()=>t.classList.add("show")))}function showModeratorVictoryScreen(e){moderatorActivityTimer&&clearTimeout(moderatorActivityTimer),countdownTimer&&clearInterval(countdownTimer);const t=document.querySelector(".inactivity-overlay");t&&t.remove(),startLeaderboardCelebration(e)}function showPlayerFinalResults(e){const t=currentArcadeSession.playerName,n=e.find((e=>e.username===t)),r=n?.rank||e.findIndex((e=>e.username===t))+1;if(currentArcadeSession.winnerScreenShown&&r<=3)return;const s=document.createElement("div");s.className="arcade-completion-modal";const o=e.filter((e=>e.rank<=3)).sort(((e,t)=>e.rank-t.rank)),a=currentArcadeSession.initialCoins||0,i=(gameState.coins||currentGame.coins||0)-a;s.innerHTML=`\n        <div class="completion-modal-content">\n            <h2>Arcade Game Complete!</h2>\n            ${r<=3?`<p class="personal-result">Congratulations! You finished in ${getOrdinal(r)} place!</p>`:`<p class="personal-result">You earned ${getOrdinal(r)} place. Better luck next time!</p>`}\n            <div class="leaderboard-preview">\n                <h3>Top Players</h3>\n                ${o.map((e=>`\n                    <div class="podium-player rank-${e.rank} ${e.username===t?"current-player":""}"\n                         style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.5rem 0; \n                                background: ${function(e,t){const n={1:"linear-gradient(135deg, #FFD700 0%, #FFC800 100%)",2:"linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%)",3:"linear-gradient(135deg, #CD7F32 0%, #B87333 100%)"};if(t)return(n[e]||"rgba(255,255,255,0.1)")+"; border: 2px solid white; box-shadow: 0 0 15px rgba(255,255,255,0.5)";return n[e]||"rgba(255,255,255,0.1)"}(e.rank,e.username===t)};\n                                border-radius: 10px; color: ${1===e.rank?"#000":"#fff"};">\n                        <div class="player-rank">${e.rank}</div>\n                        <div class="player-name">${e.username}</div>\n                        <div class="player-stats">\n                            <span class="player-words">${e.wordsCompleted||0} words</span>\n                            <span class="player-coins">${e.coins||0} coins</span>\n                        </div>\n                    </div>\n                `)).join("")}\n                \n                ${r>3?`\n                    <div class="divider" style="border-top: 1px dashed rgba(255,255,255,0.2); margin: 1rem 0;"></div>\n                    <div class="current-player-row podium-player"\n                         style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.5rem 0; \n                                background: rgba(255,255,255,0.1); border: 1px solid var(--accent);\n                                border-radius: 10px; color: var(--text);">\n                        <div class="player-rank">${r}</div>\n                        <div class="player-name">${t}</div>\n                        <div class="player-stats">\n                            <span class="player-words">${n?.wordsCompleted||0} words</span>\n                            <span class="player-coins">${n?.coins||0} coins</span>\n                        </div>\n                    </div>\n                `:""}\n            </div>\n            <div class="your-stats">\n                <h3>Your Results</h3>\n                <div class="completion-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0;">\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-language" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Words Learned</span>\n                        <strong style="font-size: 1.5rem;">${n?.wordsCompleted||0}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Coins Earned</span>\n                        <strong style="font-size: 1.5rem;">${i}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Your Rank</span>\n                        <strong style="font-size: 1.5rem;">${r}</strong>\n                    </div>\n                </div>\n            </div>\n            <button onclick="exitArcadeCompletion()" class="start-button">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(s),requestAnimationFrame((()=>s.classList.add("show")))}function removePlayer(e){currentArcadeSession.participants=currentArcadeSession.participants.filter((t=>t.username!==e)),window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"player_removed",payload:{username:e}}),updateAllPlayersProgress()}function toggleSidePanel(){const e=document.querySelector(".side-panel"),t=document.querySelector(".hamburger-button"),n=document.querySelector(".modal-overlay");e.classList.contains("open")?(e.classList.remove("open"),t.classList.remove("open"),n&&n.classList.remove("open")):(e.classList.add("open"),t.classList.add("open"),n&&n.classList.add("open"))}function showAuthModal(){const e=document.getElementById("authModal");e&&e.classList.add("open")}function hideAuthModal(){const e=document.getElementById("authModal");e&&e.classList.remove("open")}function updateAuthUI(){document.querySelector(".side-panel");const e=document.querySelector(".user-profile-section"),t=document.getElementById("userEmail"),n=document.querySelector(".logout-button"),r=document.querySelector(".main-button");currentUser?(e&&(e.style.display="block"),n&&(n.style.display="block"),t&&(t.textContent=currentUser.user_metadata?.username||currentUser.email),r&&(r.style.display="none"),updateUserStats()):(e&&(e.style.display="none"),n&&(n.style.display="none"),r&&(r.style.display="block"))}function showAuthModal(){const e=document.getElementById("authModal");e&&e.classList.add("show")}function hideAuthModal(){const e=document.getElementById("authModal");e&&e.classList.remove("show")}function toggleAuthMode(){const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function updateGuestPlayButton(){const e=document.querySelector(".guest-play-button");!currentUser||currentUser&&"unregistered"===currentUser.status?e.textContent="Play as Guest":e.textContent="Start Game"}function showPricesScreen(){alert("Prices screen coming soon!")}function showRightsAndPolicies(){alert("Rights & Policies page coming soon!")}function showAboutPage(){alert("About page coming soon!")}function showContactUs(){alert("Contact Us page coming soon!")}function animateNumber(e,t,n,r=500){if((t=Number(t))===(n=Number(n)))return void(e.textContent=n);const s=(n-t)/30;let o=t,a=0;requestAnimationFrame((function t(){o+=s,a++,a>=30||s>0&&o>=n||s<0&&o<=n?e.textContent=Math.round(n):(e.textContent=Math.round(o),requestAnimationFrame(t))}))}function showNotification(e,t){const n=document.createElement("div");n.className=`game-notification ${t}`,n.textContent=e,document.body.appendChild(n),setTimeout((()=>n.classList.add("show")),10),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>n.remove()),300)}),2e3)}function createParticles(e,t,n){const r="blessing"===n?["#3498db","#2980b9","#1abc9c"]:["#e74c3c","#c0392b","#d35400"];for(let s=0;s<15;s++){const s=document.createElement("div");s.className=`particle ${n}`;const o=8*Math.random()+4,a=Math.random()*Math.PI*2,i=100*Math.random()+50;s.style.width=`${o}px`,s.style.height=`${o}px`,s.style.borderRadius="50%",s.style.backgroundColor=r[Math.floor(Math.random()*r.length)],s.style.position="fixed",s.style.left=`${e}px`,s.style.top=`${t}px`,document.body.appendChild(s);const c=e+Math.cos(a)*i,l=t+Math.sin(a)*i;s.animate([{transform:"translate(0, 0) scale(1)",opacity:1},{transform:`translate(${c-e}px, ${l-t}px) scale(0)`,opacity:0}],{duration:1e3,easing:"cubic-bezier(0.4, 0, 0.2, 1)"}).onfinish=()=>s.remove()}}async function joinArcadeWithUsername(){const e=document.getElementById("arcadeUsername"),t=document.getElementById("otpInput");let n;if(currentUser)n=currentUser.user_metadata?.username||currentUser.email.split("@")[0];else{if(n=e.value.trim(),!n||n.length<2||n.length>15)return showErrorToast("Username must be between 2 and 15 characters"),void e.focus();if(!/^[a-zA-Z0-9\u0590-\u05FF\s._-]+$/.test(n))return showErrorToast("Username can contain letters, numbers, spaces, periods, underscores, and hyphens"),void e.focus()}const r=t.value.trim();if(!r||4!==r.length||!/^\d+$/.test(r))return showErrorToast("Please enter a valid 4-digit game code"),void t.focus();try{let e=0;if(currentUser)try{const{data:t,error:n}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();!n&&t&&(e=t.coins,console.log("Retrieved initial coins:",e))}catch(e){console.error("Failed to load initial coins:",e)}window.arcadeChannel=supabaseClient.channel(`arcade:${r}`),currentArcadeSession.playerName=n,currentArcadeSession.initialCoins=e,currentArcadeSession.otp=r,await window.arcadeChannel.subscribe(),setupCelebrationHandler(),window.arcadeChannel.on("broadcast",{event:"game_end"},(({payload:e})=>{handleGameEnd(e),currentArcadeSession.state="ended"})).on("broadcast",{event:"game_playing"},(({payload:e})=>{"active"===e.state&&(currentArcadeSession.state="active",currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,startArcadeGame())})).on("broadcast",{event:"player_join"},(({payload:e})=>{if(console.log("Player join event received:",e),!currentArcadeSession.participants.find((t=>t.username===e.username))){currentArcadeSession.participants.push({username:e.username,wordsCompleted:0,coins:0});const t=document.getElementById("player-count");t&&(t.textContent=currentArcadeSession.participants.length);const n=document.getElementById("arcade-leaderboard");n&&null!==n.offsetParent&&updateAllPlayersProgress()}})),window.arcadeChannel.on("broadcast",{event:"game_state_response"},(({payload:e})=>{console.log("Received game state response:",e),e&&"active"===e.state&&(currentArcadeSession.state="active",currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,currentArcadeSession.joinEventSent&&(document.getElementById("arcade-modal").style.display="none",startArcadeGame()))})),await window.arcadeChannel.send({type:"broadcast",event:"player_join",payload:{username:n,type:"initialJoin",coins:e,joinedAt:(new Date).toISOString()}}),currentArcadeSession.joinEventSent=!0,await window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:n,requestType:"lateJoin",timestamp:Date.now()}}),document.getElementById("arcade-modal").style.display="none",setTimeout((()=>{"active"!==currentArcadeSession.state&&showWaitingScreen()}),500)}catch(e){console.error("Join arcade error:",e),showErrorToast("Failed to join arcade. Please try again.")}}document.addEventListener("click",(e=>{const t=document.getElementById("authModal"),n=t?.querySelector(".auth-modal-content"),r=document.getElementById("arcade-modal"),s=r?.querySelector(".modal-content");!t?.classList.contains("show")||n.contains(e.target)||e.target.matches(".main-button")||hideAuthModal(),"block"!==r?.style.display||s.contains(e.target)||e.target.matches(".arcade-button")||(r.style.display="none")}));const powerupPool={highFive:{id:"highFiveCard",cost:30,effect:50,type:"goodie",icon:"fa-hand-paper",name:"High Five",message:"high-fived"},fistBump:{id:"fistBumpCard",cost:40,effect:75,type:"goodie",icon:"fa-fist-raised",name:"Fist Bump",message:"fist-bumped"},energyBoost:{id:"energyBoostCard",cost:45,type:"goodie",icon:"fa-bolt",name:"Energy Boost",message:"boosted"},freeze:{id:"freezeCard",cost:150,duration:1e4,type:"baddie",icon:"fa-snowflake",name:"Freeze",message:"froze"},coinStorm:{id:"coinStormCard",cost:160,duration:3,type:"baddie",icon:"fa-cloud-showers-heavy",name:"Coin Storm",message:"cast a coin storm on"},screenShake:{id:"screenShakeCard",cost:130,duration:5e3,type:"baddie",icon:"fa-shake",name:"Screen Shake",message:"shook"}};function initializePowerups(){const e={highFive:{id:"highFiveCard",cost:30,effect:50,type:"goodie",icon:"fa-hand-paper",name:"High Five",message:"high-fived"},fistBump:{id:"fistBumpCard",cost:40,effect:75,type:"goodie",icon:"fa-fist-raised",name:"Fist Bump",message:"fist-bumped"},energyBoost:{id:"energyBoostCard",cost:45,type:"goodie",icon:"fa-bolt",name:"Energy Boost",message:"boosted"},freeze:{id:"freezeCard",cost:150,duration:1e4,type:"baddie",icon:"fa-snowflake",name:"Freeze",message:"froze"},coinStorm:{id:"coinStormCard",cost:160,type:"baddie",icon:"fa-cloud-showers-heavy",name:"Coin Storm",message:"cast a coin storm on"},screenShake:{id:"screenShakeCard",cost:130,duration:5e3,type:"baddie",icon:"fa-shake",name:"Screen Shake",message:"shook"}};function t(){document.querySelectorAll(".powerup-card").forEach((e=>{const t=e.querySelector(".powerup-cost");if(!t)return;const n=parseInt(t.textContent),r=currentGame.coins>=n;e.classList.toggle("disabled",!r),e.style.cursor=r?"pointer":"not-allowed",e.style.opacity=r?"1":"0.5"}))}!function n(){const r=document.querySelector(".powerups-container");if(!r)return;r.innerHTML="",function(t=3){const n=Object.keys(e),r=[];for(;r.length<t&&n.length>0;){const e=Math.floor(Math.random()*n.length);r.push(n.splice(e,1)[0])}return r}(3).forEach((t=>{const s=e[t],o=document.createElement("div");o.className=`powerup-card ${s.type}`,o.id=s.id,o.innerHTML=`\n                <i class="fas ${s.icon} powerup-icon"></i>\n                <div class="powerup-name">${s.name}</div>\n                <div class="powerup-cost">${s.cost}</div>\n            `,o.onclick=async()=>{if(console.log("Powerup clicked:",s.name),currentGame.coins<s.cost)return void showNotification("Not enough coins!","error");const e=currentArcadeSession.participants.filter((e=>e.username!==currentArcadeSession.playerName&&void 0!==e.username&&null!==e.username));if(0===e.length)return void showNotification("Waiting for other players to join...","info");const r=e[Math.floor(Math.random()*e.length)],o=currentGame.coins;currentGame.coins-=s.cost,document.querySelectorAll(".coin-count").forEach((e=>{e.textContent=currentGame.coins}));try{await window.arcadeChannel.send({type:"broadcast",event:"powerup_effect",payload:{powerupKey:t,targetUser:r.username,fromUser:currentArcadeSession.playerName,powerup:s}}),showNotification(`Used ${s.name} on ${r.username}!`,s.type),await window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:currentArcadeSession.playerName,wordsCompleted:currentGame.wordsCompleted,coins:currentGame.coins,timestamp:Date.now()}}),n()}catch(e){console.error("Powerup use error:",e),currentGame.coins=o,document.querySelectorAll(".coin-count").forEach((e=>{e.textContent=o})),showNotification("Failed to use powerup!","error")}},r.appendChild(o)})),t()}();const n=document.querySelector(".coin-count");n&&new MutationObserver((()=>{t()})).observe(n,{childList:!0,characterData:!0,subtree:!0}),t()}function requestFullscreenMode(){const e=document.documentElement;/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(e.requestFullscreen?e.requestFullscreen().catch((e=>console.log("Fullscreen request failed:",e))):e.webkitRequestFullscreen?e.webkitRequestFullscreen().catch((e=>console.log("Fullscreen request failed:",e))):e.msRequestFullscreen&&e.msRequestFullscreen().catch((e=>console.log("Fullscreen request failed:",e))))}function generateQRCode(e){const t=`${window.location.origin+window.location.pathname}#join=${e}`;console.log("Generating QR code with URL:",t),new QRious({element:document.getElementById("qrCode"),value:t,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"})}function handleHashChange(){if(console.log("Hash change detected:",window.location.hash),window.location.hash.startsWith("#join=")){const e=window.location.hash.replace("#join=","");if(console.log("Join OTP detected:",e),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const t=document.getElementById("qr-landing"),n=t.querySelector(".game-code-display");document.querySelectorAll(".screen").forEach((e=>{e.style.display="none"})),t.style.display="flex",n.textContent=e,t.dataset.otp=e}else history.pushState("",document.title,window.location.pathname),showJoinModal(e)}}function proceedToGame(){const e=document.getElementById("qr-landing"),t=e.dataset.otp;e.style.display="none",showJoinModal(t)}function showJoinModal(e=""){console.log("Showing join modal with OTP:",e);const t=document.getElementById("arcade-modal"),n=document.getElementById("teacher-view"),r=document.getElementById("player-view"),s=document.getElementById("otpInput");if(t&&(t.style.display="block",n&&(n.style.display="none"),r&&(r.style.display="block"),s&&e)){s.value=e;const t=document.getElementById("arcadeUsername");t&&t.focus()}}function showNotification(e,t="info"){const n=document.createElement("div");n.className=`game-notification ${t}`,n.textContent=e,document.body.appendChild(n),requestAnimationFrame((()=>n.classList.add("show"))),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>n.remove()),300)}),3e3)}function switchAuthForm(e){const t=document.getElementById("loginForm"),n=document.getElementById("signupForm");"signup"===e?(t.classList.add("hidden"),n.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden"))}async function combineCustomLists(e){if("teacher"===!currentUser?.role)return;const t={id:Date.now(),name:"Combined List",words:[],translations:[],isTeacherList:!0};for(const n of e){const e=customPracticeLists.lists.find((e=>e.id===n));e&&(t.words.push(...e.words),t.translations.push(...e.translations))}return t}async function convertListToArcade(e){if("teacher"===!currentUser?.role)return;const t=customPracticeLists.lists.find((t=>t.id===e));if(!t)return;return{wordPool:t.words.map(((e,n)=>({word:e,translation:t.translations[n]}))),isCustomArcade:!0,teacherId:currentUser.id,listId:e}}function initializeBossLevel(){console.log("Initializing boss level");const{container:e,display:t}=createBossTimer();document.getElementById("question-screen").appendChild(e),currentGame.bossFirstHealthRestored=!1,currentGame.bossSecondHealthRestored=!1,applyBossLevelStyles(),document.querySelectorAll(".perk-button").forEach((e=>{if(e){e.disabled=!0,e.style.opacity="0.3";const t=document.createElement("div");t.className="perk-disabled",t.innerHTML="âŒ",t.style.cssText="\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 1.5em;\n                color: red;\n                pointer-events: none;\n            ",e.style.position="relative",e.appendChild(t)}}));const n=document.querySelector(".progress-circle");if(n){const e=n.querySelector(".progress");e&&(e.style.stroke="#4CAF50")}currentGame.updateBossTimer=e=>{updateBossTimer(document.querySelector("#boss-timer div"),e)},setTimeout(applyBossLevelStyles,100),setTimeout(applyBossLevelStyles,500),console.log("Boss level initialization complete")}function replaceCoinWithBossOrb(){const e=document.querySelector(".coins-container");if(!e)return void console.error("Coins container not found");const t=document.createElement("div");t.className="boss-orb",t.innerHTML='<div class="boss-orb-inner"></div>',t.style.cssText="\n    position: absolute;\n    width: 60px;\n    height: 60px;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10;\n  ",t.querySelector(".boss-orb-inner").style.cssText="\n    width: 50px;\n    height: 50px;\n    background: radial-gradient(circle at 30% 30%, #ff3333, #990000);\n    border-radius: 50%;\n    box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);\n    animation: pulseOrb 2s infinite;\n  ";const n=document.createElement("style");n.innerHTML="\n    @keyframes pulseOrb {\n      0%, 100% { transform: scale(1); filter: brightness(1); }\n      50% { transform: scale(1.1); filter: brightness(1.2); }\n    }\n  ",document.head.appendChild(n),e.innerHTML="",e.appendChild(t)}function initializeBossHealthBar(){const e=document.querySelector(".progress-circle");if(!e)return;const t=e.querySelector(".progress");if(!t)return;t.style.stroke="#4CAF50";const n=document.createElement("style");n.innerHTML="\n    .progress.warning {\n      animation: healthWarning 0.8s infinite alternate;\n    }\n    @keyframes healthWarning {\n      from { stroke: #ff3333; }\n      to { stroke: #ffffff; }\n    }\n  ",document.head.appendChild(n)}function addBossLevelStyles(){const e=document.getElementById("boss-level-style");e&&e.remove();const t=document.createElement("style");t.id="boss-level-style",t.innerHTML="\n    .boss-mode {\n      background: linear-gradient(135deg, #800000, #3a0000) !important;\n    }\n    \n    @keyframes pulseBg {\n      0%, 100% { filter: brightness(1); }\n      50% { filter: brightness(1.2); }\n    }\n    \n    .boss-orb {\n      position: relative;\n      width: 60px;\n      height: 60px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    \n    .boss-orb-inner {\n      width: 50px;\n      height: 50px;\n      background: radial-gradient(circle at 30% 30%, #ff3333, #990000);\n      border-radius: 50%;\n      position: relative;\n      box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);\n      animation: pulseOrb 2s infinite;\n    }\n    \n    .boss-orb-glow {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 70%);\n      animation: rotateGlow 3s linear infinite;\n    }\n    \n    @keyframes pulseOrb {\n      0%, 100% { transform: scale(1); filter: brightness(1); }\n      50% { transform: scale(1.1); filter: brightness(1.2); }\n    }\n    \n    @keyframes rotateGlow {\n      0% { transform: rotate(0deg); }\n      100% { transform: rotate(360deg); }\n    }\n    \n    .boss-health {\n      transition: stroke 0.3s ease, stroke-dashoffset 0.5s ease;\n    }\n    \n    .boss-health.warning {\n      animation: healthWarning 0.8s infinite alternate;\n    }\n    \n    @keyframes healthWarning {\n      from { stroke: #ff3333; }\n      to { stroke: #ffffff; }\n    }\n    \n    .boss-word {\n      color: #ff3333;\n      text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);\n      animation: pulseWord 2s infinite;\n    }\n    \n    @keyframes pulseWord {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.05); }\n    }\n    \n    .boss-hit {\n      animation: bossHitEffect 0.3s;\n    }\n    \n    @keyframes bossHitEffect {\n      0% { transform: scale(1); }\n      50% { transform: scale(1.02); filter: brightness(1.3); }\n      100% { transform: scale(1); }\n    }\n    \n    .boss-orb-hit {\n      animation: bossOrbHit 0.3s;\n    }\n    \n    @keyframes bossOrbHit {\n      0% { transform: scale(1); }\n      50% { transform: scale(1.3); filter: brightness(1.5); }\n      100% { transform: scale(1); }\n    }\n    \n    .boss-restore-health {\n      animation: bossRestoreHealth 1s;\n    }\n    \n    @keyframes bossRestoreHealth {\n      0% { filter: brightness(1); }\n      50% { filter: brightness(2); }\n      100% { filter: brightness(1); }\n    }\n    \n    .boss-defeated {\n      animation: bossDefeated 2s forwards;\n    }\n    \n    @keyframes bossDefeated {\n      0% { transform: scale(1); opacity: 1; }\n      50% { transform: scale(1.5); opacity: 0.7; filter: brightness(2); }\n      100% { transform: scale(0); opacity: 0; }\n    }\n    \n    .raining-letter {\n      position: absolute;\n      color: rgba(255, 0, 0, 0.3);\n      font-size: 16px;\n      animation: letterRain linear forwards;\n      z-index: 1;\n    }\n    \n    @keyframes letterRain {\n      0% { transform: translateY(-20px); opacity: 0; }\n      10% { opacity: 0.7; }\n      90% { opacity: 0.7; }\n      100% { transform: translateY(100vh); opacity: 0; }\n    }\n    \n    .boss-victory {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: linear-gradient(135deg, #00c6ff, #0072ff);\n      padding: 2rem;\n      border-radius: 20px;\n      text-align: center;\n      box-shadow: 0 0 30px rgba(0, 198, 255, 0.5);\n      z-index: 1000;\n      max-width: 500px;\n      width: 90%;\n    }\n    \n    .boss-victory h2 {\n      font-size: 2rem;\n      color: white;\n      margin-bottom: 1rem;\n    }\n    \n    .boss-victory p {\n      font-size: 1.2rem;\n      color: rgba(255, 255, 255, 0.9);\n      margin-bottom: 2rem;\n    }\n    \n    .victory-buttons {\n      display: flex;\n      justify-content: center;\n      gap: 1rem;\n    }\n    \n    .victory-button {\n      padding: 1rem 2rem;\n      border: none;\n      border-radius: 50px;\n      font-size: 1rem;\n      font-weight: bold;\n      cursor: pointer;\n      transition: all 0.3s ease;\n    }\n    \n    .victory-button.continue {\n      background: #4CAF50;\n      color: white;\n    }\n    \n    .victory-button.home {\n      background: rgba(255, 255, 255, 0.2);\n      color: white;\n      border: 2px solid white;\n    }\n    \n    .victory-button:hover {\n      transform: translateY(-5px);\n      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);\n    }\n    \n    .incineration-effect {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: radial-gradient(circle, #ff9900, #ff3300);\n      opacity: 0;\n      transform: scale(0);\n      animation: incinerateEffect 2s forwards;\n    }\n    \n    @keyframes incinerateEffect {\n      0% { transform: scale(0); opacity: 0; }\n      10% { transform: scale(0.5); opacity: 0.8; }\n      50% { transform: scale(1.5); opacity: 1; }\n      100% { transform: scale(3); opacity: 0; }\n    }\n  ",document.head.appendChild(t)}function updateBossHealthBar(){if(!currentGame.isBossLevel)return;console.log("Updating boss health bar");const e=document.querySelector(".progress-circle");if(!e)return void console.error("Progress circle not found");const t=e.querySelector(".progress");if(!t)return void console.error("Progress element not found");const n=currentGame.words.length,r=currentGame.currentIndex||0,s=Math.max(0,n-r),o=s/n;console.log(`Boss health: ${(100*o).toFixed(2)}% (${s}/${n})`);const a=2*Math.PI*54;t.style.strokeDashoffset=a*(1-o);const i=document.querySelector(".boss-orb-inner");if(i){const e=5,t=50,n=Math.max(e,t*o);i.style.width=`${n}px`,i.style.height=`${n}px`,i.style.left=50-n/2+"%",i.style.top=50-n/2+"%"}if(o>.66)t.style.stroke="#4CAF50",t.classList.remove("warning");else if(o>.33){if(t.style.stroke="#FFA500",t.classList.remove("warning"),o<=.66&&!currentGame.bossFirstHealthRestored){currentGame.bossFirstHealthRestored=!0,console.log("First boss health restoration"),i&&(i.style.background="radial-gradient(circle at 30% 30%, white, #FFEB3B)",i.style.transform="scale(1.3)",i.style.filter="brightness(1.8)",setTimeout((()=>{i.style.transform="",i.style.filter="",i.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3));const e=Math.floor(.25*n);currentGame.currentIndex=e,setTimeout((()=>updateBossHealthBar()),100)}}else if(t.style.stroke="#FF3333",t.classList.add("warning"),o<=.33&&!currentGame.bossSecondHealthRestored){currentGame.bossSecondHealthRestored=!0,console.log("Second boss health restoration"),i&&(i.style.background="radial-gradient(circle at 30% 30%, white, #4CAF50)",i.style.transform="scale(1.3)",i.style.filter="brightness(1.8)",setTimeout((()=>{i.style.transform="",i.style.filter="",i.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3));const e=Math.floor(.5*n);currentGame.currentIndex=e,setTimeout((()=>updateBossHealthBar()),100)}o<=0&&(console.log("Boss defeated!"),showBossDefeatEffect())}function startBossLevel(){showLevelIntro(21,(()=>{initializeBossLevel(),startTimer(8*currentGame.words.length),loadNextBossQuestion()}))}function loadNextBossQuestion(){console.log("Loading next boss question"),setTimeout(applyBossLevelStyles,100),createLightningEffect(),createBossRainingLetters();const e=document.getElementById("question-word");e&&(e.style.setProperty("color","#ff3333","important"),e.style.setProperty("text-shadow","0 0 10px rgba(255, 0, 0, 0.5)","important"),e.style.setProperty("animation","pulseWord 2s infinite","important"));try{loadNextQuestion(),setTimeout((()=>{updateBossHealthBar()}),50);const e=document.getElementById("buttons");if(e&&Math.random()<.3){const t=Array.from(e.children);t.sort((()=>Math.random()-.5)).forEach((t=>{e.appendChild(t)}))}}catch(e){console.error("Error loading boss question:",e)}}function restoreFromBossLevel(){const e=document.getElementById("question-screen");e&&(e.removeAttribute("style"),e.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)");const t=document.getElementById("question-word");if(t&&t.removeAttribute("style"),window.originalCoinsHTML){const e=document.querySelector(".coins-container");e&&(e.innerHTML=window.originalCoinsHTML)}"function"==typeof stopBossRainingLetters&&stopBossRainingLetters()}function initializeArcadeParticipation(){let e=Date.now();setInterval((()=>{Date.now()-e>6e4&&removeInactivePlayer()}),1e4),["mousemove","keypress","click"].forEach((t=>{document.addEventListener(t,(()=>{e=Date.now()}))})),window.addEventListener("beforeunload",(()=>{window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"player_left",payload:{username:currentArcadeSession.playerName}})}))}function removeInactivePlayer(){window.arcadeChannel.send({type:"broadcast",event:"player_inactive",payload:{username:currentArcadeSession.playerName}})}function handleArcadeCompletion(e){const t=currentArcadeSession.participants.sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).findIndex((t=>t.username===e.username))+1;t<=3&&(showPersonalizedCompletion(t),3===t&&window.arcadeChannel.send({type:"broadcast",event:"game_complete",payload:{topThree:currentArcadeSession.participants.sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).slice(0,3)}}))}async function handlePlayerCompletedGoal(e){if(currentArcadeSession.completedPlayers.includes(e))return;const t=Date.now();currentArcadeSession.completedPlayers.push(e);let n=0;const r=currentArcadeSession.completedPlayers.indexOf(e);r<3&&(n=r+1,currentArcadeSession.podiumRanks||(currentArcadeSession.podiumRanks={}),currentArcadeSession.podiumRanks[e]={rank:n,completionTime:t},console.log(`Player ${e} earned podium rank ${n}`));const s=currentArcadeSession.participants.find((t=>t.username===e));s&&(n>0&&(s.rank=n,s.completionTime=t),s.wordsCompleted=currentGame.wordsCompleted,s.coins=gameState.coins||currentGame.coins||0,s.completed=!0),await window.arcadeChannel.send({type:"broadcast",event:"player_completed",payload:{username:e,rank:n,wordsCompleted:currentGame.wordsCompleted,coins:gameState.coins||currentGame.coins||0,timestamp:t,completed:!0}}),e===currentArcadeSession.playerName&&n>0&&showPersonalVictoryScreen(n),3===currentArcadeSession.completedPlayers.length&&await endArcadeForAll()}function endArcade(){if(moderatorInactivity.isGameActive=!1,currentArcadeSession.celebrationTriggered=!0,currentArcadeSession.state="ended",currentArcadeSession.endTime=Date.now(),currentArcadeSession.participants.length>=3){const e=[...currentArcadeSession.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)).slice(0,3).map(((e,t)=>({...e,rank:t+1,completionTime:Date.now()-1e3*t})));window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",podiumPlayers:e,teacherId:currentArcadeSession.teacherId,forcedEnd:!1,duration:currentArcadeSession.endTime-(currentArcadeSession.startTime||currentArcadeSession.endTime)}}),startLeaderboardCelebration(e)}else window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",forcedEnd:!0,teacherId:currentArcadeSession.teacherId}}),showScreen("welcome-screen");window.arcadeChannel&&window.arcadeChannel.unsubscribe()}function handleGameEnd(e){if(console.log("Game End Payload:",e),e)if(e.forcedEnd)showScreen("welcome-screen");else if(currentUser?.id!==e.teacherId)showFinalResultsForPlayer(e.podiumPlayers||[]);else{showModeratorVictoryScreen(e.podiumPlayers||[])}}function hidePersonalVictoryScreen(){const e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout((()=>{document.body.removeChild(e)}),300))}async function endArcadeForAll(){currentArcadeSession.state="ended",currentArcadeSession.endTime=Date.now();const e=[];for(currentArcadeSession.podiumRanks&&Object.entries(currentArcadeSession.podiumRanks).forEach((([t,n])=>{const r=currentArcadeSession.participants.find((e=>e.username===t));r&&e.push({...r,rank:n.rank,completionTime:n.completionTime})})),e.sort(((e,t)=>e.rank-t.rank));e.length<3;){const t=e.length+1;e.push({username:"---",wordsCompleted:0,coins:0,rank:t})}console.log("Final podium players:",e.map((e=>({username:e.username,rank:e.rank,wordsCompleted:e.wordsCompleted})))),await window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",podiumPlayers:e,teacherId:currentArcadeSession.teacherId,duration:currentArcadeSession.endTime-(currentArcadeSession.startTime||currentArcadeSession.endTime)}}),currentUser?.id===currentArcadeSession.teacherId?showModeratorVictoryScreen(e):showFinalResultsForPlayer(e)}function showFinalResults(e){currentUser?.id===currentArcadeSession.teacherId?showModeratorVictoryScreen(e):showPlayerFinalResults(e)}function getOrdinal(e){const t=["th","st","nd","rd"],n=e%100;return e+(t[(n-20)%10]||t[n]||t[0])}function initializeModeratorIdleDetection(){let e=Date.now(),t=!1,n=null,r=null;function s(){e=Date.now(),t&&a()}const o=setInterval((()=>{if("active"!==currentArcadeSession.state||currentUser?.id!==currentArcadeSession.teacherId)return void clearInterval(o);Date.now()-e>5e3&&!t&&function(){t=!0;let e=5;r=document.createElement("div"),r.className="idle-timer-overlay",r.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.7);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 2000;\n            pointer-events: none;\n        ";const s=document.createElement("div");s.style.cssText="\n            background: var(--primary-dark);\n            padding: 2rem;\n            border-radius: 20px;\n            border: 2px solid var(--gold);\n            text-align: center;\n        ";const o=document.createElement("h2");o.textContent="Game Inactive",o.style.color="var(--gold)";const i=document.createElement("div");i.className="countdown-timer",i.textContent=e,i.style.cssText="\n            font-size: 5rem;\n            color: var(--gold);\n            margin: 1rem 0;\n            font-weight: bold;\n        ";const c=document.createElement("p");c.textContent="No activity detected. Returning to welcome screen...",s.appendChild(o),s.appendChild(i),s.appendChild(c),r.appendChild(s),document.body.appendChild(r),n=setInterval((()=>{e--,i.textContent=e,e<=0&&function(){a();const e=currentArcadeSession.participants.filter((e=>e.wordsCompleted>=currentArcadeSession.wordGoal));if(e.length>=3){const t=[...e].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)).slice(0,3).map(((e,t)=>({...e,rank:t+1})));currentArcadeSession.state="ended",showModeratorVictoryScreen(t)}else showScreen("welcome-screen")}()}),1e3)}()}),1e3);function a(){t=!1,n&&(clearInterval(n),n=null),r&&(document.body.removeChild(r),r=null)}return function(){const e=new MutationObserver((()=>{s()})),t=document.getElementById("arcade-leaderboard");t&&e.observe(t,{childList:!0,subtree:!0,attributes:!0,characterData:!0}),window.arcadeChannel.on("broadcast",{event:"progress_update"},(()=>{s()}))}(),{clearIdleTimer:a,idleCheckInterval:o}}let moderatorActivityTimer=null,countdownTimer=null,lastLeaderboardUpdate=Date.now(),isCountingDown=!1;function initializeModeratorInactivityTimer(){moderatorActivityTimer&&clearTimeout(moderatorActivityTimer),countdownTimer&&clearInterval(countdownTimer),lastLeaderboardUpdate=Date.now(),isCountingDown=!1,createInactivityOverlay(),startInactivityMonitoring(),trackLeaderboardUpdates()}function createInactivityOverlay(){const e=document.querySelector(".inactivity-overlay");e&&e.remove();const t=document.createElement("div");t.className="inactivity-overlay",t.innerHTML='\n        <div class="countdown-timer">5</div>\n        <div class="inactivity-message">No activity detected. Redirecting...</div>\n        <div class="countdown-progress">\n            <div class="countdown-bar"></div>\n        </div>\n        <button class="countdown-cancel">Cancel</button>\n    ',t.querySelector(".countdown-cancel").addEventListener("click",cancelCountdown),document.body.appendChild(t)}function startInactivityMonitoring(){const e=document.getElementById("moderator-screen");["mousemove","mousedown","keypress","scroll","touchstart"].forEach((t=>{e.addEventListener(t,resetInactivityTimer)})),resetInactivityTimer()}function resetInactivityTimer(){isCountingDown||(moderatorActivityTimer&&clearTimeout(moderatorActivityTimer),moderatorActivityTimer=setTimeout((()=>{Date.now()-lastLeaderboardUpdate>5e3&&startCountdown()}),3e3))}function trackLeaderboardUpdates(){const e=document.getElementById("arcade-leaderboard");if(!e)return;new MutationObserver((()=>{lastLeaderboardUpdate=Date.now(),isCountingDown&&cancelCountdown()})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}function startCountdown(){isCountingDown=!0;const e=document.querySelector(".inactivity-overlay");e&&e.classList.add("visible");let t=5;const n=e.querySelector(".countdown-timer"),r=e.querySelector(".countdown-bar");n.textContent=t,r.style.transform="scaleX(1)",countdownTimer=setInterval((()=>{t--,n.textContent=t,r.style.transform=`scaleX(${t/5})`,t<=0&&(clearInterval(countdownTimer),handleCountdownComplete())}),1e3)}function cancelCountdown(){const e=document.querySelector(".inactivity-overlay");e&&e.classList.remove("visible"),isCountingDown=!1,countdownTimer&&clearInterval(countdownTimer),resetInactivityTimer()}function handleCountdownComplete(){if(currentArcadeSession.completedPlayers&&currentArcadeSession.completedPlayers.length>=3){const e=[];if(currentArcadeSession.podiumRanks)Object.entries(currentArcadeSession.podiumRanks).forEach((([t,n])=>{const r=currentArcadeSession.participants.find((e=>e.username===t));r&&e.push({username:r.username,wordsCompleted:r.wordsCompleted||0,coins:r.coins||0,rank:n.rank})})),e.sort(((e,t)=>e.rank-t.rank));else{[...currentArcadeSession.participants].sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).slice(0,3).forEach(((t,n)=>{e.push({...t,rank:n+1})}))}showModeratorVictoryScreen(e)}else showScreen("welcome-screen")}const moderatorInactivity={activityTimer:null,countdownTimer:null,lastLeaderboardUpdate:Date.now(),isCountingDown:!1,isInitialized:!1,isGameActive:!1};function initializeModeratorInactivityTimer(){isModeratorScreenActive()&&currentArcadeSession.isInitialized&&(moderatorInactivity.isGameActive=!0,clearModeratorTimers(),moderatorInactivity.lastLeaderboardUpdate=Date.now(),moderatorInactivity.isCountingDown=!1,moderatorInactivity.isInitialized=!0,createModeratorInactivityOverlay(),startModeratorInactivityMonitoring(),trackModeratorLeaderboardUpdates(),console.log("Moderator inactivity timer initialized"))}function isModeratorScreenActive(){const e=document.getElementById("moderator-screen");return e&&e.classList.contains("visible")}function clearModeratorTimers(){moderatorInactivity.activityTimer&&(clearTimeout(moderatorInactivity.activityTimer),moderatorInactivity.activityTimer=null),moderatorInactivity.countdownTimer&&(clearInterval(moderatorInactivity.countdownTimer),moderatorInactivity.countdownTimer=null)}function createModeratorInactivityOverlay(){const e=document.querySelector(".moderator-inactivity-overlay");e&&e.remove();const t=document.createElement("div");t.className="moderator-inactivity-overlay",t.innerHTML='\n        <div class="moderator-countdown-timer">5</div>\n        <div class="moderator-inactivity-message">No leaderboard activity detected. Redirecting...</div>\n        <div class="moderator-countdown-progress">\n            <div class="moderator-countdown-bar"></div>\n        </div>\n        <button class="moderator-countdown-cancel">Cancel</button>\n    ',t.querySelector(".moderator-countdown-cancel").addEventListener("click",cancelModeratorCountdown);const n=document.getElementById("moderator-screen");n&&n.appendChild(t)}function startModeratorInactivityMonitoring(){const e=document.getElementById("moderator-screen");if(!e)return;["mousemove","mousedown","keypress","scroll","touchstart"].forEach((t=>{e.addEventListener(t,resetModeratorInactivityTimer)})),document.addEventListener("visibilitychange",(()=>{document.hidden||!isModeratorScreenActive()?clearModeratorTimers():moderatorInactivity.isGameActive&&isModeratorScreenActive()&&resetModeratorInactivityTimer()})),resetModeratorInactivityTimer()}function resetModeratorInactivityTimer(){isModeratorScreenActive()&&moderatorInactivity.isGameActive&&!moderatorInactivity.isCountingDown&&(moderatorInactivity.activityTimer&&clearTimeout(moderatorInactivity.activityTimer),moderatorInactivity.activityTimer=setTimeout((()=>{Date.now()-moderatorInactivity.lastLeaderboardUpdate>5e3&&isModeratorScreenActive()&&startModeratorCountdown()}),3e3))}function trackModeratorLeaderboardUpdates(){const e=document.getElementById("arcade-leaderboard");if(!e)return;new MutationObserver((()=>{isModeratorScreenActive()&&moderatorInactivity.isGameActive&&(moderatorInactivity.lastLeaderboardUpdate=Date.now(),moderatorInactivity.isCountingDown&&cancelModeratorCountdown())})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}function startModeratorCountdown(){if(!isModeratorScreenActive()||!moderatorInactivity.isGameActive)return;moderatorInactivity.isCountingDown=!0;const e=document.querySelector(".moderator-inactivity-overlay");e&&e.classList.add("visible");let t=5;const n=e.querySelector(".moderator-countdown-timer"),r=e.querySelector(".moderator-countdown-bar");n.textContent=t,r.style.transform="scaleX(1)",moderatorInactivity.countdownTimer=setInterval((()=>{isModeratorScreenActive()?(t--,n.textContent=t,r.style.transform=`scaleX(${t/5})`,t<=0&&(clearInterval(moderatorInactivity.countdownTimer),handleModeratorCountdownComplete())):cancelModeratorCountdown()}),1e3)}function cancelModeratorCountdown(){const e=document.querySelector(".moderator-inactivity-overlay");e&&e.classList.remove("visible"),moderatorInactivity.isCountingDown=!1,moderatorInactivity.countdownTimer&&(clearInterval(moderatorInactivity.countdownTimer),moderatorInactivity.countdownTimer=null),isModeratorScreenActive()&&moderatorInactivity.isGameActive&&resetModeratorInactivityTimer()}function handleModeratorCountdownComplete(){if(currentArcadeSession.celebrationTriggered)return;const e=currentArcadeSession.participants.filter((e=>e.wordsCompleted>=currentArcadeSession.wordGoal)),t=e&&e.length>=3;if(currentArcadeSession.celebrationTriggered=!0,t){const e=[];if(currentArcadeSession.podiumRanks)Object.entries(currentArcadeSession.podiumRanks).forEach((([t,n])=>{const r=currentArcadeSession.participants.find((e=>e.username===t));r&&e.push({username:r.username,wordsCompleted:r.wordsCompleted||0,coins:r.coins||0,rank:n.rank})})),e.sort(((e,t)=>e.rank-t.rank));else{[...currentArcadeSession.participants].sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).slice(0,3).forEach(((t,n)=>{e.push({...t,rank:n+1})}))}startLeaderboardCelebration(e)}else showScreen("welcome-screen")}function cleanupModeratorInactivityMonitoring(){clearModeratorTimers(),moderatorInactivity.isGameActive=!1,moderatorInactivity.isInitialized=!1,moderatorInactivity.isCountingDown=!1;const e=document.querySelector(".moderator-inactivity-overlay");e&&e.remove()}function startLeaderboardCelebration(e){const t=document.querySelector(".moderator-inactivity-overlay");t&&t.classList.remove("visible");const n=document.createElement("div");n.className="celebration-overlay",document.body.appendChild(n),setTimeout((()=>n.classList.add("visible")),10);const r=document.getElementById("arcade-leaderboard").querySelectorAll(".leaderboard-entry"),s=new Map;e.forEach((e=>{r.forEach((t=>{const n=t.querySelector("[data-username]");if(!n)return;const r=n.dataset.username;if(r===e.username){const n=t.getBoundingClientRect();s.set(r,{left:n.left,top:n.top,width:n.width,height:n.height});const o=t.cloneNode(!0);if(o.classList.add("winner-entry","celebrating"),1===e.rank){o.classList.add("first-place");const t=document.createElement("div");t.className="winner-label",t.textContent="CHAMPION",o.appendChild(t),addWinnerEmojis(o,["ðŸ‘‘","ðŸ†","ðŸŒŸ"],e.rank)}else if(2===e.rank){o.classList.add("second-place");const t=document.createElement("div");t.className="winner-label",t.textContent="RUNNER-UP",o.appendChild(t),addWinnerEmojis(o,["ðŸ¥ˆ","âœ¨"],e.rank)}else if(3===e.rank){o.classList.add("third-place");const t=document.createElement("div");t.className="winner-label",t.textContent="BRONZE MEDAL",o.appendChild(t),addWinnerEmojis(o,["ðŸ¥‰","ðŸŽ‰"],e.rank)}o.style.position="fixed",o.style.left=`${n.left}px`,o.style.top=`${n.top}px`,o.style.width=`${n.width}px`,o.style.height=`${n.height}px`,o.style.zIndex=3-e.rank+100;const a=o.querySelector(".rank"),i=o.querySelector("[data-username]"),c=o.querySelector("[data-words]"),l=o.querySelector("[data-coins]");a&&(a.style.fontSize="3rem"),i&&(i.style.fontSize="3rem"),c&&(c.style.fontSize="2.5rem"),l&&(l.style.fontSize="2.5rem"),document.body.appendChild(o),setTimeout((()=>{o.classList.add("centered")}),50)}}))})),setTimeout((()=>{startConfettiShower(),window.arcadeChannel.send({type:"broadcast",event:"celebration",payload:{winners:e.map((e=>({username:e.username,rank:e.rank,wordsCompleted:e.wordsCompleted,coins:e.coins})))}})}),1500);const o=document.createElement("div");o.className="home-button-container",o.innerHTML='\n       <button class="start-button" onclick="finishCelebrationAndGoHome()">\n           Return to Home\n       </button>\n   ',document.body.appendChild(o),setTimeout((()=>o.classList.add("visible")),2500)}function addWinnerEmojis(e,t,n){setTimeout((()=>{t.forEach(((e,t)=>{const r=document.createElement("div");let s,o,a;r.className="celebration-emoji",r.textContent=e;1===n?(a=3,t%2==0?(s=5+3*t+"%",o=5+2*t+"%"):(s=95-3*t+"%",o=5+2*t+"%")):2===n?(a=2.5,t%2==0?(s="5%",o=40+5*t+"%"):(s="95%",o=40+5*t+"%")):(a=2,t%2==0?(s=15+5*t+"%",o="90%"):(s=85-5*t+"%",o="90%")),r.style.fontSize=`${a}rem`,r.style.left=s,r.style.top=o,r.style.zIndex=300,r.style.animationDelay=1.8+.3*t+"s",document.body.appendChild(r)}))}),1800)}function startConfettiShower(){const e=["#FFD700","#FF1493","#00BFFF","#7CFC00","#FF4500","#9400D3","#FF8C00","#1E90FF","#32CD32","#FF69B4"];n();const t=setInterval(n,800);function n(){for(let t=0;t<60;t++){const t=document.createElement("div");t.className="confetti";const n=5+15*Math.random(),r=e[Math.floor(Math.random()*e.length)],s=100*Math.random(),o=3*Math.random(),a=3+4*Math.random(),i=Math.random()>.5;t.style.width=`${n}px`,t.style.height=`${n}px`,t.style.backgroundColor=r,t.style.left=`${s}vw`,t.style.animationDuration=`${a}s`,t.style.animationDelay=`${o}s`,t.style.borderRadius=i?"0":"50%",document.body.appendChild(t),setTimeout((()=>{t.remove()}),1e3*(a+o))}}window.celebrationConfettiInterval=t}function finishCelebrationAndGoHome(){document.querySelector(".celebration-overlay")?.remove(),document.querySelector(".home-button-container")?.remove(),window.celebrationConfettiInterval&&clearInterval(window.celebrationConfettiInterval),document.querySelectorAll(".confetti, .celebration-emoji, .winner-entry.celebrating").forEach((e=>e.remove())),cleanupModeratorInactivityMonitoring(),currentArcadeSession={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],playerRank:null,winnerScreenShown:!1,startTime:null,endTime:null,celebrationTriggered:!1},showScreen("welcome-screen")}function setupCelebrationHandler(){window.arcadeChannel&&window.arcadeChannel.on("broadcast",{event:"celebration"},(({payload:e})=>{if(e.winners&&currentArcadeSession.playerName){const t=e.winners.find((e=>e.username===currentArcadeSession.playerName));t&&showPersonalVictoryCelebration(t.rank)}}))}function showPersonalVictoryCelebration(e){if(currentArcadeSession.winnerScreenShown)return;currentArcadeSession.winnerScreenShown=!0;const t=document.createElement("div");t.className="personal-victory-overlay",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.8);\n        z-index: 2000;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        transition: opacity 0.5s ease;\n    ";const n={1:{title:"ðŸ† CHAMPION! ðŸ†",message:"Incredible! You've claimed the top spot!",emoji:"ðŸ‘‘",color:"var(--gold)"},2:{title:"ðŸ¥ˆ RUNNER UP! ðŸ¥ˆ",message:"Amazing job! You've secured second place!",emoji:"â­",color:"var(--silver)"},3:{title:"ðŸ¥‰ BRONZE MEDALIST! ðŸ¥‰",message:"Well done! You've earned third place!",emoji:"ðŸŒŸ",color:"var(--bronze)"}}[e]||{title:"GREAT PERFORMANCE!",message:"You've completed the challenge!",emoji:"ðŸŽ‰",color:"var(--accent)"};t.innerHTML=`\n        <div style="font-size: 8rem; margin-bottom: 1rem;">${n.emoji}</div>\n        <h1 style="color: ${n.color}; font-size: 3rem; margin-bottom: 1rem;">${n.title}</h1>\n        <p style="font-size: 1.5rem; margin-bottom: 2rem; text-align: center; max-width: 80%;">\n            ${n.message}\n        </p>\n        <div style="margin: 2rem 0; display: flex; gap: 2rem;">\n            <div style="text-align: center;">\n                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">YOUR RANK</div>\n                <div style="font-size: 3rem; color: ${n.color};">${e}</div>\n            </div>\n            <div style="text-align: center;">\n                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">WORDS COMPLETED</div>\n                <div style="font-size: 3rem; color: var(--text);">${currentGame.wordsCompleted||0}</div>\n            </div>\n            <div style="text-align: center;">\n                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">COINS EARNED</div>\n                <div style="font-size: 3rem; color: var(--gold);">${currentGame.coins||0}</div>\n            </div>\n        </div>\n        <button class="start-button" style="margin-top: 2rem; padding: 1rem 2rem;" onclick="closePersonalVictory()">\n            Continue\n        </button>\n    `,document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",startPlayerConfetti()}),100)}function startPlayerConfetti(){const e=["#FFD700","#FF1493","#00BFFF","#7CFC00","#FF4500","#9400D3","#FF8C00","#1E90FF","#32CD32","#FF69B4"];function t(){for(let t=0;t<40;t++){const t=document.createElement("div");t.className="player-confetti",t.style.cssText=`\n                position: fixed;\n                width: ${5+10*Math.random()}px;\n                height: ${5+10*Math.random()}px;\n                background-color: ${e[Math.floor(Math.random()*e.length)]};\n                top: -20px;\n                left: ${100*Math.random()}vw;\n                opacity: 1;\n                z-index: 2001;\n                border-radius: ${Math.random()>.5?"0":"50%"};\n                animation: confettiFall ${3+3*Math.random()}s linear ${2*Math.random()}s forwards;\n            `,document.body.appendChild(t),setTimeout((()=>{t.remove()}),5e3)}}t();const n=setInterval(t,1e3);window.playerConfettiInterval=n,setTimeout((()=>{clearInterval(n)}),1e4)}function closePersonalVictory(){window.playerConfettiInterval&&clearInterval(window.playerConfettiInterval),document.querySelectorAll(".player-confetti").forEach((e=>e.remove()));const e=document.querySelector(".personal-victory-overlay");e&&(e.style.opacity="0",setTimeout((()=>{e.remove(),showScreen("welcome-screen")}),500))}function startCustomListPractice(e){const t=CustomListsManager.lists.find((t=>t.id===e));if(!t)return void showNotification("List not found","error");const n=CustomListsManager.validateListForPractice(t);if(!n.valid)return void showNotification(n.message,"error");customGameState.initializeFromList(t)?startCustomLevel(1):showNotification("Failed to initialize practice","error")}function handleCustomLevelCompletion(){const e=currentGame.streakBonus&&currentGame.correctAnswers===currentGame.words.length;if(clearTimer(),e){const e=currentGame.firstAttempt?5:3;CoinsManager.updateCoins(e).then((()=>{pulseCoins(e),customGameState.wordsCompleted+=currentGame.words.length,customGameState.completedLevels.add(customGameState.currentLevel);const t=customGameState.currentLevel+1,n=document.getElementById("question-screen").getBoundingClientRect();createParticles(n.left+n.width/2,n.top+n.height/2);const r=customGameState.getWordsForLevel(t);!r||0===r.words.length||currentGame.isFinalLevel?setTimeout((()=>showCustomCompletionScreen()),1500):setTimeout((()=>startCustomLevel(t)),1500)}))}else setTimeout((()=>startCustomLevel(customGameState.currentLevel)),1500);saveProgress()}function showCustomCompletionScreen(){const e=document.createElement("div");e.className="completion-overlay";const t=gameState.coins-customGameState.startCoins;e.innerHTML=`\n        <div class="completion-content">\n            <h2>Practice Complete!</h2>\n            <div class="completion-stats">\n                <div class="stat-item">\n                    <i class="fas fa-book"></i>\n                    <span>Words Practiced: ${customGameState.wordsCompleted}</span>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-coins"></i>\n                    <span>Coins Earned: ${t}</span>\n                </div>\n            </div>\n            <button onclick="exitCustomPractice()" class="start-button">Continue</button>\n        </div>\n    `,document.body.appendChild(e)}function exitCustomPractice(){customGameState.reset();const e=document.querySelector(".completion-overlay");e&&e.remove(),showScreen("custom-practice-screen")}async function handleCustomPracticeAnswer(e,t=!1){if(e){if(e&&!t){let t=0;const n=awardTimeBonus();n>0&&(t+=n,pulseCoins(n)),currentGame.firstAttempt?(t+=3,pulseCoins(3)):(t+=1,pulseCoins(1));try{await CoinsManager.updateCoins(t),updatePerkButtons()}catch(e){console.error("Error updating total coins:",e)}if(currentGame.correctAnswers++,currentUser&&"premium"===currentUser.status){const e=currentGame.currentIndex,t=currentGame.isHebrewToEnglish?currentGame.words[e]:currentGame.translations[e];await trackWordEncounter(t,"custom")}}}else{currentGame.firstAttempt=!1,currentGame.streakBonus=!1,currentGame.wrongStreak++;try{await CoinsManager.updateCoins(-3),updatePerkButtons()}catch(e){console.error("Error updating coins:",e)}if(currentGame.currentIndex>0&&(currentGame.progressLost++,currentGame.currentIndex=Math.max(0,currentGame.currentIndex-1)),currentGame.wrongStreak>=3)return showGameOverOverlay(),void(document.querySelector(".restart-button").onclick=()=>{document.querySelector(".failure-overlay").style.display="none",startCustomLevel(currentGame.customLevel)})}const n=currentGame.isHebrewToEnglish?currentGame.words[currentGame.currentIndex]:currentGame.translations[currentGame.currentIndex];document.querySelectorAll(".buttons button").forEach((t=>{t.textContent===n?t.classList.add("correct"):e||t.textContent!==event.target.textContent||t.classList.add("wrong")})),e&&currentGame.currentIndex++,updateProgressCircle(),saveProgress(),setTimeout((()=>{currentGame.currentIndex<currentGame.words.length?(loadNextQuestion(),updatePerkButtons()):handleCustomLevelCompletion()}),333)}async function saveCurrentList(){const e=document.getElementById("custom-list-name"),t=document.getElementById("word-translation-list"),n=e.value.trim()||(customPracticeLists.currentList?customPracticeLists.currentList.name:`List ${CustomListsManager.lists.length+1}`),r=[],s=[];t.querySelectorAll(".word-translation-item").forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),n=e.querySelector(".target-word").value.trim();t&&n&&(r.push(t),s.push(n))}));const o=CustomListsManager.getListLimits();if(r.length>o.maxWords)return void showNotification(`You can only create lists with up to ${o.maxWords} words`,"error");let a;const i=null!==customPracticeLists.currentList;if(!i&&!CustomListsManager.canCreateMoreLists())return void showNotification(`You can only create ${CustomListsManager.getListLimits().maxLists} custom lists`,"error");a=i?{...customPracticeLists.currentList,name:n,words:r,translations:s}:{tempId:Date.now(),name:n,words:r,translations:s};await CustomListsManager.save(a)?(e.value="",t.innerHTML="",document.getElementById("translation-results").style.display="none",customPracticeLists.currentList=null,currentUser?await CustomListsManager.loadFromSupabase():CustomListsManager.loadFromLocalStorage(),showNotification("List saved successfully","success"),showScreen("custom-practice-screen"),updateListsDisplay()):showNotification("Failed to save list","error")}async function deleteCustomList(e){await CustomListsManager.delete(e)?(showNotification("List deleted successfully","success"),updateListsDisplay()):showNotification("Failed to delete list","error")}function showReviveOverlay(){const e=document.createElement("div");e.className="resurrection-overlay";const t=document.querySelector(".progress-circle").cloneNode(!0),n=document.createElement("div");n.className="revive-container";const r=document.createElement("div");r.className="ankh-symbol",r.textContent="â˜¥",n.appendChild(r),t.style.position="absolute",t.style.top="0",t.style.left="0";t.querySelector("svg");t.querySelectorAll("circle").forEach((e=>{e.style.transition="none",e.style.strokeDashoffset="339.29",e.classList.contains("progress")&&(e.classList.add("resurrection-fill"),e.style.stroke="var(--gold)")}));const s=t.querySelector(".coins-container");s&&t.removeChild(s),n.appendChild(t),e.appendChild(n);const o=document.createElement("div");o.className="revive-content";const a=document.createElement("h2");a.className="revive-title",a.textContent="Revive?";const i=document.createElement("div");i.className="revive-timer",i.textContent="5";const c=document.createElement("button");c.className="revive-button",c.textContent="Revive",o.appendChild(a),o.appendChild(i),o.appendChild(c),e.appendChild(o),document.body.appendChild(e),requestAnimationFrame((()=>{e.classList.add("show")}));let l=5;const d=setInterval((()=>{l--,i.textContent=l,l<=0&&(clearInterval(d),handleReviveTimeout())}),1e3);c.onclick=()=>{clearInterval(d),handleRevive()},e.dataset.intervalId=d}function handleReviveTimeout(){const e=document.querySelector(".resurrection-overlay");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),showScreen("welcome-screen")}),500))}function handleRevive(){const e=document.querySelector(".resurrection-overlay");if(!e)return;const t=e.querySelector(".progress-circle");if(!t)return;const n=e.querySelector(".revive-content");n&&(n.style.opacity="0");const r=document.createElement("div");r.className="revive-title",r.textContent="Resurrecting...",r.style.opacity="0",n&&(e.replaceChild(r,n),setTimeout((()=>{r.style.transition="opacity 0.5s ease",r.style.opacity="1"}),100));const s=t.querySelector("circle.progress");if(s){const e=2*Math.PI*54;s.style.strokeDasharray=`${e} ${e}`,s.style.strokeDashoffset=e,setTimeout((()=>{s.style.transition="stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1)",s.style.strokeDashoffset="0"}),300)}setTimeout((()=>{e.classList.remove("show"),setTimeout((()=>{e.remove(),currentGame.wrongStreak=0,timeRemaining=currentGame.initialTimeRemaining,currentGame.isCustomPractice?startCustomLevel(currentGame.customLevel):startLevel(gameState.currentLevel)}),500)}),2500)}function createResurrectionParticles(){const e=document.querySelector(".resurrection-animation");if(!e)return;const t=e.getBoundingClientRect(),n=t.left+t.width/2,r=t.top+t.height/2;for(let e=0;e<40;e++){const e=document.createElement("div");e.className="resurrection-particle";const t=Math.random()*Math.PI*2,s=100+150*Math.random(),o=1+1.5*Math.random(),a=.5*Math.random(),i=3+7*Math.random(),c=Math.cos(t)*s,l=Math.sin(t)*s;e.style.cssText=`\n            position: fixed;\n            left: ${n}px;\n            top: ${r}px;\n            width: ${i}px;\n            height: ${i}px;\n            background: #FFD700;\n            border-radius: 50%;\n            opacity: 0;\n            z-index: 1001;\n            box-shadow: 0 0 ${i}px #FFD700;\n            transform: translate(-50%, -50%);\n            animation: particleFlow ${o}s ease-out ${a}s forwards;\n        `,e.style.setProperty("--end-x",`${c}px`),e.style.setProperty("--end-y",`${l}px`),document.body.appendChild(e),setTimeout((()=>{e.remove()}),1e3*(o+a)+100)}}function updateSidePanelLink(){const e=document.querySelector('.nav-link[onclick*="stage-screen"]');e&&e.setAttribute("onclick","showScreen('stage-cascade-screen'); return false;")}function renderStageCascadeScreen(){const e=document.querySelector(".stages-container");if(!e)return;if(e.innerHTML="",console.log("Current unlocked sets:",gameState.unlockedSets),gameStructure.stages.forEach((t=>{const n=document.createElement("div");n.className="stage-wrapper",n.dataset.stage=t.id;const r=t.numSets,s=gameState.unlockedSets[t.id]||new Set,o=s.size;let a=0;o>0&&s.forEach((e=>{isSetCompleted(t.id,e)&&a++}));const i=getStageIcon(t.id),c=getStageHebrewName(t.id),l=getStageDescription(t.id),d=getStageStatus(t.id,a,r);n.innerHTML=`\n      <div class="stage-button">\n        <div class="stage-info">\n          <div class="stage-icon">\n            <i class="${i}"></i>\n          </div>\n          <div class="stage-text">\n            <div class="stage-name">${c} - Stage ${t.id}</div>\n            <div class="stage-desc">${l}</div>\n          </div>\n        </div>\n        <div class="stage-status">${d}</div>\n        <div class="stage-toggle">\n          <i class="fas fa-chevron-down"></i>\n        </div>\n      </div>\n      \n      <div class="sets-container">\n        <div class="sets-grid" id="sets-grid-${t.id}"></div>\n      </div>\n    `,e.appendChild(n),populateSetsGrid(t.id)})),addStageToggleListeners(),gameState.currentStage){const e=document.querySelector(`.stage-wrapper[data-stage="${gameState.currentStage}"]`);e&&e.classList.add("open")}const t=document.getElementById("stage-cascade-screen");t&&(document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")})),t.classList.add("visible"))}function showStageCascadeScreen(){if(currentUser){const e=localStorage.getItem("simploxProgress");if(e)try{updateGameStateFromProgress(JSON.parse(e))}catch(e){console.error("Error parsing local progress:",e)}}console.log("Showing stage cascade screen, current game state:",{currentStage:gameState.currentStage,unlockedSets:gameState.unlockedSets,completedLevels:gameState.completedLevels?Array.from(gameState.completedLevels).length:0});const e=document.querySelector(".stages-container");if(!e)return;if(e.innerHTML="",gameStructure.stages.forEach((t=>{const n=document.createElement("div");n.className="stage-wrapper",n.dataset.stage=t.id;const r=t.numSets,s=gameState.unlockedSets[t.id]||new Set;console.log(`Stage ${t.id} unlocked sets:`,Array.from(s));s.size;let o=0;s.size>0&&s.forEach((e=>{t.id;const n=gameStructure.stages[t.id-1].levelsPerSet,r=new Set;for(let s=1;s<=n;s++){const n=`${t.id}_${e}_${s}`;(gameState.completedLevels.has(n)||gameState.perfectLevels.has(n))&&r.add(s)}r.size===n&&(o++,console.log(`Set ${t.id}-${e} is fully completed`))}));const a=getStageIcon(t.id),i=getStageHebrewName(t.id),c=getStageDescription(t.id),l=getStageStatus(t.id,o,r);n.innerHTML=`\n            <div class="stage-button">\n                <div class="stage-info">\n                    <div class="stage-icon">\n                        <i class="${a}"></i>\n                    </div>\n                    <div class="stage-text">\n                        <div class="stage-name">${i} - Stage ${t.id}</div>\n                        <div class="stage-desc">${c}</div>\n                    </div>\n                </div>\n                <div class="stage-status">${l}</div>\n                <div class="stage-toggle">\n                    <i class="fas fa-chevron-down"></i>\n                </div>\n            </div>\n            \n            <div class="sets-container">\n                <div class="sets-grid" id="sets-grid-${t.id}"></div>\n            </div>\n        `,e.appendChild(n),populateSetsGrid(t.id)})),addStageToggleListeners(),gameState.currentStage){const e=document.querySelector(`.stage-wrapper[data-stage="${gameState.currentStage}"]`);e&&e.classList.add("open")}const t=document.getElementById("stage-cascade-screen");t&&(document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")})),t.classList.add("visible"))}function updateGameStateFromProgress(e){console.log("Updating game state from saved progress"),e.unlocked_sets&&(console.log("Updating unlocked sets from:",e.unlocked_sets),gameState.unlockedSets={},Object.entries(e.unlocked_sets).forEach((([e,t])=>{gameState.unlockedSets[e]=new Set(Array.isArray(t)?t:[])}))),e.unlocked_levels&&(console.log("Updating unlocked levels from saved data"),gameState.unlockedLevels={},Object.entries(e.unlocked_levels).forEach((([e,t])=>{gameState.unlockedLevels[e]=new Set(Array.isArray(t)?t:[])}))),e.completed_levels&&(console.log("Updating completed levels from saved data"),gameState.completedLevels=new Set(e.completed_levels)),e.perfect_levels&&(console.log("Updating perfect levels from saved data"),gameState.perfectLevels=new Set(e.perfect_levels))}function getStageIcon(e){return{1:"fas fa-book",2:"fas fa-graduation-cap",3:"fas fa-school",4:"fas fa-university",5:"fas fa-brain"}[e]||"fas fa-star"}function getStageHebrewName(e){return{1:"×ž×ª×—×™×œ×™×",2:"×™×¡×•×“×™",3:"×—×˜×™×‘×ª ×‘×™× ×™×™×",4:"×ª×™×›×•×Ÿ",5:"××•× ×™×‘×¨×¡×™×˜×”"}[e]||`Stage ${e}`}function getStageDescription(e){return{1:"Beginner level words and simple phrases",2:"Elementary level vocabulary and structures",3:"Middle school level vocabulary",4:"High school level vocabulary",5:"University level vocabulary"}[e]||"Advanced vocabulary"}function getStageStatus(e,t,n){return e>2&&(!currentUser||"premium"!==currentUser.status)?"Premium Feature":`${t}/${n} Sets Completed`}function populateSetsGrid(e){const t=document.getElementById(`sets-grid-${e}`);if(!t)return;console.log(`Populating sets grid for stage ${e}`),console.log("Unlocked sets:",gameState.unlockedSets);const n=gameStructure.stages[e-1],r=gameState.unlockedSets[e]||new Set,s=currentUser?currentUser.status:"unregistered";console.log(`Stage ${e} unlocked sets:`,Array.from(r)),t.innerHTML="";for(let o=1;o<=n.numSets;o++){const n=document.createElement("div"),a=r.has(o);let i=!1;e>=2&&o>1&&"premium"!==s&&(i=!0),n.className="set-button",a&&!i?n.classList.add("active"):n.classList.add("locked");const c=isSetCompleted(e,o);n.innerHTML=`\n      <span>Set ${o}</span>\n      ${c?'\n      <div class="completed-indicator">\n        <i class="fas fa-check-circle"></i>\n      </div>':""}\n      ${!a||i?`\n      <div class="lock-icon">\n        <i class="fas ${i?"fa-crown":"fa-lock"}"></i>\n      </div>`:""}\n    `,a&&!i?n.onclick=()=>{gameState.currentStage=e,gameState.currentSet=o,showLevelScreen(o)}:i&&(n.onclick=()=>showUpgradePrompt()),t.appendChild(n)}}function isSetCompleted(e,t){const n=gameStructure.stages;if(!n||!n[e-1])return console.warn(`Invalid stage ${e} in isSetCompleted`),!1;const r=n[e-1].levelsPerSet;let s=0;console.log(`Checking if set ${e}-${t} is completed. Total levels: ${r}`);for(let n=1;n<=r;n++){const r=`${e}_${t}_${n}`;(gameState.completedLevels.has(r)||gameState.perfectLevels.has(r))&&(s++,console.log(`Level ${r} is completed`))}const o=s===r;return console.log(`Set ${e}-${t} completion check: ${s}/${r} = ${o}`),o}function addStageToggleListeners(){document.querySelectorAll(".stage-wrapper .stage-button").forEach((e=>{e.addEventListener("click",(t=>{e.closest(".stage-wrapper").classList.toggle("open"),t.stopPropagation()}))}))}function ensureScreenExists(e){if(!document.getElementById(e)){console.warn(`Screen ${e} doesn't exist. Creating it.`);const t=document.createElement("div");t.id=e,t.className="screen",document.body.appendChild(t)}}function safeShowScreen(e,t=!1){ensureScreenExists(e),showScreen(e,t)}function updateSidePanelLinks(){const e=document.querySelector('.nav-link[onclick*="stage-screen"]');e&&e.setAttribute("onclick","safeShowScreen('stage-cascade-screen'); return false;"),document.querySelectorAll('button[onclick*="stage-screen"]').forEach((e=>{const t=e.getAttribute("onclick");t&&t.includes("stage-screen")&&e.setAttribute("onclick",t.replace("stage-screen","stage-cascade-screen"))}))}function initializeStageCascadeScreen(){const e=document.getElementById("stage-cascade-screen");if(!e.querySelector(".stages-container")){const t=document.createElement("div");t.className="stages-container",e.appendChild(t)}}function toggleSidePanel(){const e=document.querySelector(".side-panel"),t=document.querySelector(".hamburger-button"),n=document.querySelector(".modal-overlay");e.classList.contains("open")?(e.classList.remove("open"),t.classList.remove("open"),n&&n.classList.remove("open")):(e.classList.add("open"),t.classList.add("open"),n&&n.classList.add("open"))}function hasExistingProgress(){if(gameState.completedLevels.size>0||gameState.perfectLevels.size>0)return!0;for(let e=1;e<=5;e++){const t=gameState.unlockedSets[e];if((1!==e||!t||9!==t.size)&&(t&&t.size>1))return!0}const e=localStorage.getItem("simploxProgress");if(e){const t=JSON.parse(e);if(t.completedLevels&&t.completedLevels.length>0)return!0;if(t.perfectLevels&&t.perfectLevels.length>0)return!0}return!1}function findFurthestLevelInStage(e){if(!gameState.unlockedSets[e])return null;const t=Array.from(gameState.unlockedSets[e]).sort(((e,t)=>t-e));for(const n of t){const t=`${e}_${n}`;if(!gameState.unlockedLevels[t])continue;const r=Array.from(gameState.unlockedLevels[t]).sort(((e,t)=>t-e));for(const t of r){const r=`${e}_${n}_${t}`;if(!gameState.perfectLevels.has(r)&&!gameState.completedLevels.has(r))return{stage:e,set:n,level:t}}}const n=gameStructure.stages[e-1],r=t[0];return r<n.numSets?{stage:e,set:r+1,level:1}:e<5?{stage:e+1,set:1,level:1}:{stage:e,set:t[0],level:1}}function showGradeLevelSelector(){const e=document.createElement("div");e.className="modal-backdrop",e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        backdrop-filter: blur(5px);\n        z-index: 1000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const t=document.createElement("div");t.className="grade-level-modal",t.style.cssText="\n        background: var(--glass);\n        backdrop-filter: blur(10px);\n        border-radius: 20px;\n        padding: 2rem;\n        max-width: 500px;\n        width: 90%;\n        text-align: center;\n        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n    ",t.innerHTML='\n        <h2 style="color: var(--gold); margin-bottom: 1.5rem;">What grade level are you?</h2>\n        <p style="margin-bottom: 2rem; opacity: 0.9;">Choose your education level for the best learning experience:</p>\n        <div class="grade-options" style="display: flex; flex-direction: column; gap: 1rem;">\n            <button class="grade-option" data-stage="2" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-school" style="margin-right: 0.5rem;"></i> Elementary School\n            </button>\n            <button class="grade-option" data-stage="3" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-graduation-cap" style="margin-right: 0.5rem;"></i> Junior High School\n            </button>\n            <button class="grade-option" data-stage="4" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-user-graduate" style="margin-right: 0.5rem;"></i> High School\n            </button>\n            <button class="grade-option" data-stage="5" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-university" style="margin-right: 0.5rem;"></i> University\n            </button>\n        </div>\n    ',document.body.appendChild(e),e.appendChild(t);t.querySelectorAll(".grade-option").forEach((t=>{t.addEventListener("mouseover",(()=>{t.style.background="rgba(255,255,255,0.2)",t.style.transform="translateY(-2px)"})),t.addEventListener("mouseout",(()=>{t.style.background="rgba(255,255,255,0.1)",t.style.transform="translateY(0)"})),t.addEventListener("click",(()=>{const n=parseInt(t.dataset.stage);localStorage.setItem("preferredStage",n),e.remove(),gameState.currentStage=n,gameState.currentSet=1,startLevel(1)}))}))}function setupDefaultUnlocks(){console.log("Setting up default unlocks..."),console.log("Before setup:",gameState.unlockedSets,gameState.unlockedLevels),gameState.unlockedSets[1]||(gameState.unlockedSets[1]=new Set);for(let e=1;e<=9;e++){gameState.unlockedSets[1].add(e);const t=`1_${e}`;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set([1]))}for(let e=2;e<=5;e++){gameState.unlockedSets[e]||(gameState.unlockedSets[e]=new Set([1]));const t=`${e}_1`;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set([1]))}Object.entries(gameState.unlockedLevels).forEach((([e,t])=>{const n=Math.max(...Array.from(t));for(let e=1;e<n;e++)t.add(e)})),console.log("After setup:",gameState.unlockedSets,gameState.unlockedLevels)}function saveProgress(){console.log("Saving game progress");const e={stage:gameState.currentStage||1,set_number:gameState.currentSet||1,level:gameState.currentLevel||1,coins:gameState.coins||0,perks:gameState.perks||{}};gameState.unlockedSets&&(e.unlocked_sets={},Object.entries(gameState.unlockedSets).forEach((([t,n])=>{e.unlocked_sets[t]=Array.from(n||[])}))),gameState.unlockedLevels&&(e.unlocked_levels={},Object.entries(gameState.unlockedLevels).forEach((([t,n])=>{e.unlocked_levels[t]=Array.from(n||[])}))),gameState.completedLevels&&gameState.completedLevels.size>0&&(e.completed_levels=Array.from(gameState.completedLevels)),gameState.perfectLevels&&gameState.perfectLevels.size>0&&(e.perfect_levels=Array.from(gameState.perfectLevels)),console.log("Progress data to save:",e),currentUser?(console.log("Saving progress to Supabase for user:",currentUser.id),supabaseClient.from("game_progress").select("*").eq("user_id",currentUser.id).single().then((({data:t,error:n})=>{if(n)return console.error("Error checking progress schema:",n),void saveProgressToLocalStorage(e);const r="perfect_levels"in t;"completed_levels"in t||(delete e.completed_levels,console.warn("Database schema missing completed_levels column, removing from save data")),r||(delete e.perfect_levels,console.warn("Database schema missing perfect_levels column, removing from save data")),supabaseClient.from("game_progress").update(e).eq("user_id",currentUser.id).then((({data:t,error:n})=>{n?(console.error("Failed to save to database, using localStorage:",n),saveProgressToLocalStorage(e)):(console.log("Progress successfully saved to database"),saveProgressToLocalStorage(e),document.dispatchEvent(new CustomEvent("progressSaved",{detail:{gameState:gameState}})))}))}))):(console.log("Saving progress to localStorage (guest user)"),saveProgressToLocalStorage(e));const t={stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(t)),console.log("Game context saved:",t)}function saveProgressToLocalStorage(e){localStorage.setItem("simploxProgress",JSON.stringify(e))}function debugGameProgress(){console.group("Game Progress Debug"),console.log("Current Stage:",gameState.currentStage),console.log("Current Set:",gameState.currentSet),console.log("Current Level:",gameState.currentLevel),console.log("Unlocked Sets:"),Object.entries(gameState.unlockedSets).forEach((([e,t])=>{console.log(`Stage ${e}:`,Array.from(t).sort(((e,t)=>e-t)))})),console.log("Unlocked Levels:"),Object.entries(gameState.unlockedLevels).forEach((([e,t])=>{console.log(`Set ${e}:`,Array.from(t).sort(((e,t)=>e-t)))})),console.log("Completed Levels:",Array.from(gameState.completedLevels).sort()),console.log("Perfect Levels:",Array.from(gameState.perfectLevels).sort()),console.groupEnd()}function optimizeMobileRendering(){ParticleSystem.maxParticles=20;debounce(showScreen,200);/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),document.head.insertAdjacentHTML("beforeend","\n            <style>\n                @media (max-width: 768px) {\n                    .confetti, .particle {\n                        display: none;\n                    }\n                }\n            </style>\n        "))}function debounce(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...r)}),t)}}function optimizeMobileEvents(){document.addEventListener("touchstart",(()=>{}),{passive:!0}),document.addEventListener("touchmove",(()=>{}),{passive:!0})}function validateListForPractice(e){return e&&e.words&&e.translations?e.words.length<6?{valid:!1,message:"Lists need at least 6 words to practice"}:{valid:!0}:{valid:!1,message:"Invalid list format"}}function updateCustomListSchema(e){if(!e)return e;const t=e.words?.length||0;let n=0;return t>=6&&(n=t>=12?9:t>=9?6:3),{...e,min_words:6,max_levels:n}}function initAccessibilityMenu(){const e=document.querySelector(".accessibility-toggle"),t=document.querySelector(".accessibility-modal"),n=document.querySelector(".close-accessibility");loadAccessibilitySettings(),e&&t&&e.addEventListener("click",(function(){t.classList.add("show")})),n&&t&&(n.addEventListener("click",(function(){t.classList.remove("show")})),t.addEventListener("click",(function(e){e.target===t&&t.classList.remove("show")})));document.querySelectorAll(".accessibility-button").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-action");if(applyAccessibilitySetting(e,this.getAttribute("data-value")),"fontSize"!==e&&"reset"!==e){document.querySelectorAll(`[data-action="${e}"]`).forEach((e=>e.classList.remove("active"))),this.classList.add("active")}}))}))}function applyAccessibilitySetting(e,t){const n=document.body;switch(e){case"contrast":n.classList.remove("high-contrast","inverted-colors"),"high"===t&&n.classList.add("high-contrast"),"inverted"===t&&n.classList.add("inverted-colors");break;case"theme":n.classList.remove("light-theme","dark-theme"),"light"===t&&n.classList.add("light-theme"),"dark"===t&&n.classList.add("dark-theme");break;case"saturation":n.classList.remove("grayscale"),"grayscale"===t&&n.classList.add("grayscale");break;case"fontSize":let e=parseFloat(getComputedStyle(n).getPropertyValue("--font-scale")||1);"increase"===t?(e=Math.min(e+.1,1.8),n.style.setProperty("--font-scale",e),n.style.fontSize=`calc(1rem * ${e})`):"decrease"===t?(e=Math.max(e-.1,.8),n.style.setProperty("--font-scale",e),n.style.fontSize=`calc(1rem * ${e})`):"reset"===t&&(n.style.removeProperty("--font-scale"),n.style.fontSize="");break;case"fontFamily":n.classList.remove("dyslexic-font"),"dyslexic"===t&&n.classList.add("dyslexic-font");break;case"letterSpacing":n.classList.remove("increased-letter-spacing"),"increased"===t&&n.classList.add("increased-letter-spacing");break;case"animations":n.classList.remove("no-animations","reduced-animations"),"disabled"===t&&n.classList.add("no-animations"),"reduced"===t&&n.classList.add("reduced-animations");break;case"focus":n.classList.remove("high-focus"),"high"===t&&n.classList.add("high-focus");break;case"buttonSize":n.classList.remove("large-buttons"),"large"===t&&n.classList.add("large-buttons");break;case"cursorSize":n.classList.remove("large-cursor"),"large"===t&&n.classList.add("large-cursor");break;case"reset":"all"===t&&resetAllAccessibilitySettings()}saveAccessibilitySettings()}function saveAccessibilitySettings(){const e=document.body,t={classNames:e.className,fontSize:e.style.fontSize,fontScale:e.style.getPropertyValue("--font-scale")};localStorage.setItem("accessibilitySettings",JSON.stringify(t))}function loadAccessibilitySettings(){const e=localStorage.getItem("accessibilitySettings");if(e){const t=JSON.parse(e),n=document.body;t.classNames&&(n.className=t.classNames),t.fontSize&&(n.style.fontSize=t.fontSize),t.fontScale&&n.style.setProperty("--font-scale",t.fontScale),updateActiveButtons()}}function updateActiveButtons(){const e=document.body;Object.entries({"high-contrast":{action:"contrast",value:"high"},"inverted-colors":{action:"contrast",value:"inverted"},"light-theme":{action:"theme",value:"light"},"dark-theme":{action:"theme",value:"dark"},grayscale:{action:"saturation",value:"grayscale"},"dyslexic-font":{action:"fontFamily",value:"dyslexic"},"increased-letter-spacing":{action:"letterSpacing",value:"increased"},"no-animations":{action:"animations",value:"disabled"},"reduced-animations":{action:"animations",value:"reduced"},"high-focus":{action:"focus",value:"high"},"large-buttons":{action:"buttonSize",value:"large"},"large-cursor":{action:"cursorSize",value:"large"}}).forEach((([t,n])=>{const r=e.classList.contains(t),s=document.querySelector(`[data-action="${n.action}"][data-value="${n.value}"]`);s&&(r?s.classList.add("active"):s.classList.remove("active"))})),document.querySelector('[data-action="contrast"].active')||document.querySelector('[data-action="contrast"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="theme"].active')||document.querySelector('[data-action="theme"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="saturation"].active')||document.querySelector('[data-action="saturation"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="fontFamily"].active')||document.querySelector('[data-action="fontFamily"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="letterSpacing"].active')||document.querySelector('[data-action="letterSpacing"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="animations"].active')||document.querySelector('[data-action="animations"][data-value="enabled"]')?.classList.add("active"),document.querySelector('[data-action="focus"].active')||document.querySelector('[data-action="focus"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="buttonSize"].active')||document.querySelector('[data-action="buttonSize"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="cursorSize"].active')||document.querySelector('[data-action="cursorSize"][data-value="normal"]')?.classList.add("active")}function resetAllAccessibilitySettings(){const e=document.body;e.classList.remove("high-contrast","inverted-colors","light-theme","dark-theme","grayscale","dyslexic-font","increased-letter-spacing","no-animations","reduced-animations","high-focus","large-buttons","large-cursor"),e.style.fontSize="",e.style.removeProperty("--font-scale"),document.querySelectorAll(".accessibility-button.active").forEach((e=>{e.classList.remove("active")})),document.querySelector('[data-action="contrast"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="theme"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="saturation"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="fontFamily"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="letterSpacing"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="animations"][data-value="enabled"]')?.classList.add("active"),document.querySelector('[data-action="focus"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="buttonSize"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="cursorSize"][data-value="normal"]')?.classList.add("active"),localStorage.removeItem("accessibilitySettings")}async function trackWordEncounter(e,t){if(currentUser&&"premium"===currentUser.status)try{const{data:n,error:r}=await supabaseClient.from("word_practice_history").select("*").eq("user_id",currentUser.id).eq("word",e).single();if(r&&"PGRST116"!==r.code)return void console.error("Error fetching word history:",r);let s=!1,o=0;if(n){const r=n.practice_count+1;o=r<=5?3:1;const{error:s}=await supabaseClient.from("word_practice_history").update({practice_count:r,last_practiced_at:(new Date).toISOString(),game_mode:t,coins_earned:n.coins_earned+o}).eq("user_id",currentUser.id).eq("word",e);if(s)return void console.error("Error updating word history:",s)}else{s=!0,o=3;const{error:n}=await supabaseClient.from("word_practice_history").insert([{user_id:currentUser.id,word:e,practice_count:1,game_mode:t,coins_earned:o}]);if(n)return void console.error("Error inserting word history:",n);const{data:r,error:a}=await supabaseClient.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();if(!a){const e=(r?.unique_words_practiced||0)+1,{error:t}=await supabaseClient.from("player_stats").update({unique_words_practiced:e}).eq("user_id",currentUser.id);t?console.error("Error updating player stats:",t):document.querySelectorAll("#totalWords").forEach((t=>{animateNumber(t,parseInt(t.textContent)||0,e)}))}}return o>0&&await CoinsManager.updateCoins(o),{isNewWord:s,coinReward:o}}catch(e){console.error("Error in trackWordEncounter:",e)}}function createRainingParticles(){const e=document.getElementById("question-screen");if(!e)return;const t=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",..."××‘×’×“×”×•×–×—×˜×™×›×œ×ž× ×¡×¢×¤×¦×§×¨×©×ª"],n=e.clientWidth;window.rainingLettersInterval&&clearInterval(window.rainingLettersInterval),window.rainingLettersInterval=setInterval((()=>{const r=Math.floor(3*Math.random())+1;for(let s=0;s<r;s++){const r=document.createElement("div");r.className="raining-letter",r.textContent=t[Math.floor(Math.random()*t.length)];const s=Math.random()*n,o=5+5*Math.random();r.style.left=`${s}px`,r.style.animationDuration=`${o}s`,e.appendChild(r),setTimeout((()=>{r.parentNode===e&&e.removeChild(r)}),1e3*o)}}),300)}function updateBossHealthBar(){if(!currentGame.isBossLevel)return;console.log("Updating boss health bar");const e=document.querySelector(".progress-circle");if(!e)return void console.error("Progress circle not found");const t=e.querySelector(".progress");if(!t)return void console.error("Progress element not found");const n=currentGame.words.length,r=currentGame.currentIndex||0,s=Math.max(0,n-r),o=s/n;console.log(`Boss health: ${100*o.toFixed(2)}% (${s}/${n})`);const a=2*Math.PI*54;if(t.style.strokeDashoffset=a*(1-o),t.classList.contains("boss-health")||t.classList.add("boss-health"),o>.66)t.style.stroke="#4CAF50",t.classList.remove("warning");else if(o>.33){if(t.style.stroke="#FFA500",t.classList.remove("warning"),o<=.66&&!currentGame.bossFirstHealthRestored){currentGame.bossFirstHealthRestored=!0,console.log("First boss health restoration");const e=Math.floor(.25*n);currentGame.currentIndex=e;const t=document.querySelector(".boss-orb-inner");t&&(t.style.background="radial-gradient(circle at 30% 30%, #FFEB3B, #FFA500)",setTimeout((()=>{t.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3)),setTimeout((()=>updateBossHealthBar()),100)}}else if(t.style.stroke="#FF3333",t.classList.add("warning"),o<=.33&&!currentGame.bossSecondHealthRestored){currentGame.bossSecondHealthRestored=!0,console.log("Second boss health restoration");const e=Math.floor(.5*n);currentGame.currentIndex=e;const t=document.querySelector(".boss-orb-inner");t&&(t.style.background="radial-gradient(circle at 30% 30%, #4CAF50, #388E3C)",setTimeout((()=>{t.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3)),setTimeout((()=>updateBossHealthBar()),100)}}function healBoss(e,t){const n=document.querySelector(".progress-circle"),r=n?n.querySelector(".progress"):null,s=document.querySelector(".boss-orb-inner");if(!r||!s)return;const o=s.style.background;s.style.background=t,s.classList.add("boss-restore-health");const a=document.querySelector(".question-screen");a&&(a.style.animation="none",a.offsetHeight,a.style.animation="bossRestoreHealth 1s");const i=2*Math.PI*54*(1-e);setTimeout((()=>{r.style.transition="stroke-dashoffset 1s ease-out",r.style.strokeDashoffset=i,setTimeout((()=>{s.style.background=o,s.classList.remove("boss-restore-health")}),1e3)}),300)}function showBossHitEffect(e=!1){const t=document.querySelector(".boss-orb-inner");if(!t)return;const n=t.style.background;if(e){const e=["yellow","purple","turquoise","darkgreen","brown"],n=e[Math.floor(Math.random()*e.length)];t.style.background=`radial-gradient(circle at 30% 30%, ${n}, #990000)`}t.classList.add("boss-orb-hit"),setTimeout((()=>{t.classList.remove("boss-orb-hit"),e&&(t.style.background=n)}),300)}function applyBossLevelStyles(){console.log("Forcefully applying boss level styles");const e=document.getElementById("question-screen");if(e&&(e.style.setProperty("background","linear-gradient(135deg, #800000, #3a0000)","important"),e.style.setProperty("animation","pulseBg 4s infinite","important")),!document.getElementById("boss-animations")){const e=document.createElement("style");e.id="boss-animations",e.textContent="\n      @keyframes pulseBg {\n        0%, 100% { filter: brightness(1); }\n        50% { filter: brightness(1.2); }\n      }\n      \n      @keyframes pulseOrb {\n        0%, 100% { transform: scale(1); filter: brightness(1); }\n        50% { transform: scale(1.3); filter: brightness(1.4); }\n      }\n      \n      @keyframes pulseWord {\n        0%, 100% { transform: scale(1); }\n        50% { transform: scale(1.05); }\n      }\n    ",document.head.appendChild(e)}const t=document.getElementById("question-word");t&&(t.style.setProperty("color","#ff3333","important"),t.style.setProperty("text-shadow","0 0 10px rgba(255, 0, 0, 0.5)","important"),t.style.setProperty("animation","pulseWord 2s infinite","important"));const n=document.querySelector(".coins-container");n&&(window.originalCoinsHTML||(window.originalCoinsHTML=n.innerHTML),n.innerHTML='\n    <div class="boss-orb" style="\n      width: 85px;\n      height: 85px;\n      top: 50%;\n      left: 50%;\n      transform: translate(-75%, -75%);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 10;\n    ">\n      <div class="boss-orb-inner" style="\n        width: 50px;\n        height: 50px;\n        background: radial-gradient(circle at 30% 30%, #ff3333, #990000);\n        border-radius: 50%;\n        box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);\n        animation: pulseOrb 1s infinite;\n      "></div>\n    </div>\n  ')}function handleBossAnswer(e){if(e){const e=document.querySelector(".progress-circle"),t=e?.querySelector(".progress");if(t){const e=t.style.stroke,n=["#ffffff","#ffff00","#800080","#990000"],r=n[Math.floor(Math.random()*n.length)];t.style.transition="stroke 0.2s ease",t.style.stroke=r,setTimeout((()=>{t.style.stroke=e}),200)}}}function createBossTimer(){const e=document.createElement("div");e.id="boss-timer",e.style.cssText="\n        position: absolute;\n        top: 10px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        justify-content: center;\n        z-index: 10;\n    ";const t=document.createElement("div");return t.style.cssText="\n        background-color: rgba(255, 215, 0, 0.8);\n        color: #000;\n        font-family: 'Digital', monospace;\n        font-size: 2rem;\n        padding: 5px 10px;\n        border-radius: 5px;\n        letter-spacing: 3px;\n    ",e.appendChild(t),{container:e,display:t}}function updateBossTimer(e,t){if(e){const n=Math.floor(t/60),r=t%60;e.textContent=`${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}}function createLightningEffect(){const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(255, 255, 255, 0.8);\n        z-index: 1000;\n        pointer-events: none;\n        opacity: 0;\n        transition: opacity 0.1s ease;\n    ",document.body.appendChild(e);const t=Math.floor(3*Math.random())+1;let n=0;for(let r=0;r<t;r++)setTimeout((()=>{e.style.opacity="1",setTimeout((()=>{e.style.opacity="0"}),50)}),n),n+=200;setTimeout((()=>{document.body.removeChild(e)}),n+500)}function createBossRainingLetters(){const e=document.getElementById("question-screen");if(!e)return;window.rainingLettersInterval&&clearInterval(window.rainingLettersInterval);const t=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",..."××‘×’×“×”×•×–×—×˜×™×›×œ×ž× ×¡×¢×¤×¦×§×¨×©×ª"],n=e.clientWidth;window.rainingLettersInterval=setInterval((()=>{const r=Math.floor(3*Math.random())+1;for(let s=0;s<r;s++){const r=document.createElement("div");r.className="boss-raining-letter",r.textContent=t[Math.floor(Math.random()*t.length)],r.style.cssText=`\n                position: absolute;\n                top: -20px;\n                left: ${Math.random()*n}px;\n                color: rgba(255, 0, 0, 0.4);\n                font-size: 16px;\n                animation: boss-letter-rain 5s linear forwards;\n                z-index: 1;\n                text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);\n            `,e.appendChild(r),setTimeout((()=>{r.parentNode===e&&e.removeChild(r)}),5e3)}}),300)}function stopBossRainingLetters(){window.rainingLettersInterval&&(clearInterval(window.rainingLettersInterval),window.rainingLettersInterval=null)}function createBossStyleSheet(){const e=document.createElement("style");e.id="boss-level-styles",e.textContent="\n    @keyframes boss-letter-rain {\n      0% { \n        transform: translateY(-20px);\n        opacity: 0.6;\n      }\n      100% { \n        transform: translateY(100vh);\n        opacity: 0;\n      }\n    }\n\n    @keyframes boss-shrink {\n      0% { transform: scale(1); opacity: 1; }\n      50% { transform: scale(0.8); opacity: 0.8; }\n      100% { transform: scale(0); opacity: 0; }\n    }\n\n    @keyframes fade-to-blue {\n      0% { background: linear-gradient(135deg, #800000, #3a0000); }\n      20% { background: linear-gradient(135deg, #800000, #3a0000); }\n      60% { background: linear-gradient(135deg, #4a1582, #0d47a1); }\n      100% { background: radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%); }\n    }\n    \n    @keyframes incinerateEffect {\n      0% { transform: scale(0); opacity: 0; }\n      10% { transform: scale(0.5); opacity: 0.8; }\n      50% { transform: scale(1.5); opacity: 1; }\n      100% { transform: scale(3); opacity: 0; }\n    }\n    \n    .incineration-effect {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: radial-gradient(circle, #ff9900, #ff3300);\n      opacity: 0;\n      transform: scale(0);\n      animation: incinerateEffect 1.5s forwards;\n    }\n  ",document.head.appendChild(e)}function showModernBossVictoryScreen(){const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 2000;\n        opacity: 0;\n        transition: opacity 0.5s ease;\n    ";const t=document.createElement("div");t.style.cssText="\n        background: linear-gradient(135deg, #00c6ff, #0072ff);\n        padding: 2rem;\n        border-radius: 20px;\n        text-align: center;\n        max-width: 500px;\n        width: 90%;\n        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\n    ",t.innerHTML=`\n        <h2 style="color: white; font-size: 2.5rem; margin-bottom: 1rem;">ðŸ† Boss Defeated!</h2>\n        <div class="victory-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0; color: white;">\n            <div>\n                <div style="font-size: 1.2rem; opacity: 0.7;">Words Learned</div>\n                <div style="font-size: 2rem; font-weight: bold;">${currentGame.words.length}</div>\n            </div>\n            <div>\n                <div style="font-size: 1.2rem; opacity: 0.7;">Coins Earned</div>\n                <div style="font-size: 2rem; font-weight: bold;">100</div>\n            </div>\n        </div>\n        <div style="display: flex; justify-content: center; gap: 1rem;">\n            <button class="continue-btn" style="\n                background: #4CAF50; \n                color: white; \n                border: none; \n                padding: 1rem 2rem; \n                border-radius: 50px; \n                font-size: 1rem; \n                cursor: pointer;\n                transition: transform 0.3s ease;\n            ">Continue to Next Set</button>\n            <button class="home-btn" style="\n                background: rgba(255,255,255,0.2); \n                color: white; \n                border: 2px solid white; \n                padding: 1rem 2rem; \n                border-radius: 50px; \n                font-size: 1rem; \n                cursor: pointer;\n                transition: transform 0.3s ease;\n            ">Return Home</button>\n        </div>\n    `;const n=t.querySelector(".continue-btn"),r=t.querySelector(".home-btn");[n,r].forEach((e=>{e.addEventListener("mouseenter",(()=>{e.style.transform="scale(1.05)"})),e.addEventListener("mouseleave",(()=>{e.style.transform="scale(1)"}))})),n.addEventListener("click",(()=>{e.style.opacity="0",setTimeout((()=>{e.remove(),unlockNextSet();const t=gameState.currentSet+1;gameState.currentSet=t,gameState.currentLevel=1,startLevel(1)}),500)})),r.addEventListener("click",(()=>{e.style.opacity="0",setTimeout((()=>{e.remove(),unlockNextSet(),showScreen("welcome-screen")}),500)})),e.appendChild(t),document.body.appendChild(e),requestAnimationFrame((()=>{e.style.opacity="1"}))}function showBossDefeatEffect(){console.log("Starting boss defeat effect sequence"),setTimeout((()=>{const e=document.querySelector(".question-screen"),t=document.querySelector(".boss-orb-inner");if(t){console.log("Disintegrating boss orb");const e=document.createElement("div");e.className="incineration-effect",t.appendChild(e),t.style.animation="boss-shrink 1.5s forwards",setTimeout((()=>{console.log("Restoring coin counter");const e=document.querySelector(".coins-container");if(e&&window.originalCoinsHTML){e.innerHTML=window.originalCoinsHTML;const t=e.querySelector(".coin-icon"),n=e.querySelector(".coin-count");t&&(t.style.transform="scale(0)",setTimeout((()=>{t.style.transition="transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)",t.style.transform="scale(1)"}),100)),n&&(n.textContent=gameState.coins+100,n.style.transform="scale(0)",setTimeout((()=>{n.style.transition="transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)",n.style.transform="scale(1)"}),300))}}),1500)}if(e){console.log("Starting background transition");const t=document.createElement("div");t.className="background-transition-overlay",t.style.cssText="\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: linear-gradient(135deg, #800000, #3a0000);\n        z-index: -1;\n        transition: background 5s ease-in-out;\n        pointer-events: none;\n      ",e.insertBefore(t,e.firstChild),t.offsetWidth,setTimeout((()=>{console.log("Transitioning to purple"),t.style.background="linear-gradient(135deg, #4a1582, #0d47a1)",setTimeout((()=>{console.log("Transitioning to normal blue"),t.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)","function"==typeof stopBossRainingLetters&&stopBossRainingLetters(),initializeParticles(e),setTimeout((()=>{console.log("Showing victory notification"),showBossVictoryNotification()}),1e3)}),2500)}),500)}else setTimeout((()=>showBossVictoryNotification()),4e3)}),2e3)}function showBossVictoryNotification(){CoinsManager.updateCoins(100);const e=document.createElement("div");e.className="arcade-completion-modal",e.innerHTML='\n    <div class="completion-modal-content">\n      <h2 style="color: var(--gold)">Boss Defeated!</h2>\n      <p style="font-size: 1.2rem; margin: 1rem 0;">Congratulations! You\'ve conquered this challenge!</p>\n      \n      <div class="completion-stats">\n        <div class="stat-item">\n          <i class="fas fa-skull" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>\n          <span style="display: block; margin-bottom: 0.25rem;">Boss Defeated</span>\n          <strong style="font-size: 1.5rem;">âœ“</strong>\n        </div>\n        <div class="stat-item">\n          <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>\n          <span style="display: block; margin-bottom: 0.25rem;">Bonus Coins</span>\n          <strong style="font-size: 1.5rem;">100</strong>\n        </div>\n        <div class="stat-item">\n          <i class="fas fa-unlock" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>\n          <span style="display: block; margin-bottom: 0.25rem;">New Set</span>\n          <strong style="font-size: 1.5rem;">Unlocked</strong>\n        </div>\n      </div>\n      \n      <div style="display: flex; justify-content: space-around; margin-top: 2rem; gap: 1rem;">\n        <button onclick="handleBossVictoryContinue()" class="start-button" style="\n          background: var(--accent);\n          color: var(--text);\n          border: none;\n          padding: 1rem 2rem;\n          border-radius: 50px;\n          font-size: 1.1rem;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.3s ease;\n          box-shadow: 0 5px 15px rgba(30, 144, 255, 0.3);\n        ">\n          Next Set\n        </button>\n        <button onclick="handleBossVictoryHome()" class="start-button" style="\n          background: transparent;\n          color: var(--text);\n          border: 2px solid var(--accent);\n          padding: 1rem 2rem;\n          border-radius: 50px;\n          font-size: 1.1rem;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.3s ease;\n        ">\n          Return Home\n        </button>\n      </div>\n    </div>\n  ',document.body.appendChild(e),requestAnimationFrame((()=>e.classList.add("show")))}function handleBossVictoryContinue(){console.log("Boss victory continue button clicked");const e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove();const t=document.querySelector(".background-transition-overlay");t?(console.log("Using existing transition overlay for smooth transition"),t.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)",resetBossStyles(!0)):resetBossStyles(),unlockNextSet();const n=gameState.currentSet+1;gameState.currentSet=n,gameState.currentLevel=1,setTimeout((()=>{console.log("Starting next level"),t&&t.parentNode&&t.parentNode.removeChild(t),startLevel(1)}),500)}),300))}function resetBossStyles(e=!1){console.log("Resetting boss styles",e?"(preserving overlay)":"");const t=document.getElementById("question-screen");if(t){const n=t.querySelector(".background-transition-overlay");e&&n&&n.remove(),t.removeAttribute("style"),e&&n&&t.insertBefore(n,t.firstChild),e||(t.querySelectorAll(".background-transition-overlay").forEach((e=>e.remove())),setTimeout((()=>{t.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)"}),10))}const n=document.getElementById("question-word");n&&n.removeAttribute("style"),"function"==typeof stopBossRainingLetters&&stopBossRainingLetters();const r=e?".incineration-effect, .boss-orb":".incineration-effect, .boss-orb, .background-transition-overlay";document.querySelectorAll(r).forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)}))}function handleBossVictoryHome(){console.log("Boss victory home button clicked");const e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),resetBossStyles(),unlockNextSet();const t=gameState.currentSet+1;gameState.currentSet=t,gameState.currentLevel=1,saveProgress(),showScreen("welcome-screen")}),300))}function isAdminUser(){return currentUser&&"admin123@gmail.com"===currentUser.email}function addAdminSkipButton(){if(!isAdminUser())return;const e=document.getElementById("admin-skip-10-button");e&&e.remove();const t=document.createElement("button");t.id="admin-skip-10-button",t.innerHTML='<i class="fas fa-forward"></i> Skip 10',t.style.cssText="\n    position: fixed;\n    bottom: 80px;\n    right: 20px;\n    background: #9c27b0;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 2000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    font-weight: bold;\n  ",t.onclick=function(){console.log("Admin skip-10 button clicked"),handleAdminSkip10()};const n=document.getElementById("question-screen");n&&n.appendChild(t)}function handleAdminSkip10(){if(!isAdminUser())return;if(!currentGame||!currentGame.words||!currentGame.words.length)return void console.error("No active game found");const e=Math.min(10,currentGame.words.length-currentGame.currentIndex);if(console.log(`Skipping ${e} questions`),currentGame.isBossLevel)return currentGame.currentIndex=Math.max(0,currentGame.words.length-1),updateBossHealthBar(),loadNextBossQuestion(),void showNotification("Boss almost defeated! One more hit!","success");currentGame.currentIndex+=e,currentGame.currentIndex>=currentGame.words.length?handleLevelCompletion():(updateProgressCircle(),loadNextQuestion(),showNotification(`Skipped ${e} questions!`,"success"))}function addAdminTestButton(){console.log("Checking for admin user...");const e=document.getElementById("admin-test-button");if(e&&e.remove(),console.log("Current user:",currentUser?currentUser.email:"No user"),!currentUser||"admin123@gmail.com"!==currentUser.email&&!currentUser.email?.includes("admin123"))return void console.log("Not admin user, not adding button");console.log("Admin user detected, adding test buttons");const t=document.createElement("button");t.id="admin-test-button",t.textContent="Jump to Level 20",t.style.cssText="\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: #ff5722;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 2000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    font-weight: bold;\n  ",t.onclick=function(){console.log("Admin button clicked, jumping to level 20"),gameState.currentLevel=21,startLevel(21)},document.body.appendChild(t),console.log("Admin test button added to body"),addAdminSkipButton()}updateSidePanelLink(),document.addEventListener("DOMContentLoaded",(()=>{updateSidePanelLink()})),document.addEventListener("DOMContentLoaded",(()=>{ensureScreenExists("stage-cascade-screen"),updateSidePanelLinks(),initializeStageCascadeScreen()})),document.addEventListener("DOMContentLoaded",(function(){initAccessibilityMenu()})),createBossStyleSheet()</script></body></html>