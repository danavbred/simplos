<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate">
    <html lang="en" translate="no">
    <title>Simplos for Schools</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7"></script>
</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap');
    
    :root {
      --primary-dark: #1a1a2e;
      --primary: #16213e;
      --secondary: #0f3460;
      --accent: #e94561;
      --text: #ffffff;
      --gold: #ffd700;
      --silver: #c0c0c0;
      --bronze: #cd7f32;
      --success: #4CAF50;
      --error: #f44336;
      --gradient: linear-gradient(135deg, var(--secondary), var(--primary-dark));
      --glass: rgba(255, 255, 255, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--gradient);
      color: var(--text);
      overflow-x: hidden;
    }
    
    .screen {
      display: none;
      min-height: 100vh;
      padding: 2rem;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%);
    }
    
    .screen.visible {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    /* Teacher Dashboard Styles */
    .dashboard-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    .dashboard-title {
      font-size: 2.5rem;
      color: var(--gold);
      font-weight: 700;
    }
    
    .dashboard-nav {
      display: flex;
      gap: 1rem;
      background: var(--glass);
      padding: 0.5rem;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    
    .nav-button {
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      color: var(--text);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .nav-button.active {
      background: var(--accent);
    }
    
    /* Race Track Styles */
    .race-container {
      background: var(--glass);
      border-radius: 20px;
      padding: 2rem;
      margin-top: 2rem;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .track-level {
      height: 80px;
      margin: 20px 0;
      position: relative;
    }
    
    .track-path {
      height: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      position: relative;
    }
    
    .player-marker {
      position: absolute;
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 50%;
      transform: translateY(-50%);
      transition: all 0.5s ease;
    }
    
    /* Event Manager Styles */
    .event-card {
      background: var(--glass);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(10px);
    }
    
    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .event-title {
      font-size: 1.2rem;
      color: var(--gold);
    }
    
    .event-status {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
    }
    
    .status-active {
      background: var(--success);
    }
    
    .status-pending {
      background: var(--accent);
    }
    
    /* Common Button Styles */
    .action-button {
      padding: 0.75rem 1.5rem;
      border: none;
      background: var(--accent);
      color: var(--text);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: var(--primary-dark);
    border-radius: 20px;
    padding: 2rem;
    width: 90%;
    max-width: 500px;
    border: 1px solid var(--glass);
    backdrop-filter: blur(10px);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--glass);
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
}

.form-group select[multiple] {
    height: 100px;
}

.modal-content h2 {
    color: var(--gold);
    margin-bottom: 1.5rem;
}

.cancel {
    background: var(--glass) !important;
    margin-left: 1rem;
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 2rem;
    border-radius: 10px;
    color: var(--text);
    z-index: 1100;
    animation: slideIn 0.3s ease-out;
}

.notification.success {
    background: var(--success);
}

.notification.error {
    background: var(--error);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Race Track Enhancements */
.track-level {
    height: 100px;
    margin: 30px 0;
    position: relative;
    border-radius: 15px;
    background: var(--glass);
}

.word-count {
    position: absolute;
    left: -40px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    font-weight: bold;
}

.flag {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.5rem;
    filter: drop-shadow(0 0 5px rgba(255,215,0,0.5));
}

.player-marker {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 10;
}

.player-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    color: var(--text);
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.player-name {
    margin-top: 5px;
    font-size: 0.8rem;
    color: var(--text);
    white-space: nowrap;
}

.flag-celebration {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 2rem;
    animation: celebrationBounce 0.5s ease-out;
}

.celebration-particle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--gold);
    border-radius: 50%;
    animation: particleFly 2s ease-out forwards;
}

@keyframes celebrationBounce {
    0% { transform: translateX(-50%) scale(0); }
    50% { transform: translateX(-50%) scale(1.2); }
    100% { transform: translateX(-50%) scale(1); }
}

@keyframes particleFly {
    0% {
        transform: translate(0, 0);
        opacity: 1;
    }
    100% {
        transform: translate(
            calc(cos(var(--angle)) * var(--velocity) * 50px),
            calc(sin(var(--angle)) * var(--velocity) * 50px)
        );
        opacity: 0;
    }
}

/* Class Management Styles */
.class-card {
    background: var(--glass);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    backdrop-filter: blur(10px);
    transition: transform 0.3s ease;
}

.class-card:hover {
    transform: translateY(-2px);
}

.class-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.class-title {
    font-size: 1.2rem;
    color: var(--gold);
}

.grade-level {
    background: var(--accent);
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.9rem;
}

.class-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stat i {
    color: var(--gold);
}

.class-actions {
    display: flex;
    gap: 1rem;
}

/* Student List Styles */
.student-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 1rem 0;
}

.student-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    margin-bottom: 0.5rem;
}

.student-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.student-status {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
}

.student-status.free {
    background: var(--accent);
}

.student-status.premium {
    background: var(--success);
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin: 1.5rem 0;
}

.progress-stats .stat {
    flex-direction: column;
    text-align: center;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}

.progress-stats .stat h3 {
    color: var(--gold);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.progress-stats .stat span {
    font-size: 1.5rem;
    font-weight: bold;
}

.lists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.list-card {
    background: var(--glass);
    border-radius: 15px;
    padding: 1.5rem;
    backdrop-filter: blur(10px);
    transition: transform 0.3s ease;
}

.list-card:hover {
    transform: translateY(-2px);
}

.list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.word-count {
    background: var(--accent);
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
}

.list-preview {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.word-pair {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.word-pair:last-child {
    border-bottom: none;
}

.more-words {
    text-align: center;
    padding: 0.5rem;
    color: var(--accent);
    font-size: 0.9rem;
}

.word-pair-input {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.word-pair-input input {
    padding: 0.5rem;
    border-radius: 5px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: var(--text);
}

.word-pair-input button {
    background: none;
    border: none;
    color: var(--error);
    cursor: pointer;
    padding: 0 0.5rem;
}

.analytics-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--glass);
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    backdrop-filter: blur(10px);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--gold);
    margin-top: 0.5rem;
}

.ranking-list {
    background: var(--glass);
    border-radius: 15px;
    padding: 1.5rem;
    backdrop-filter: blur(10px);
}

.ranking-item {
    display: grid;
    grid-template-columns: auto 1fr auto 2fr;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.ranking-item:last-child {
    border-bottom: none;
}

.rank {
    font-weight: bold;
    color: var(--gold);
}

.progress-bar {
    height: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s ease;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.class-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--glass);
    border-radius: 15px;
    margin-bottom: 1.5rem;
}

.error-state {
    text-align: center;
    padding: 2rem;
    color: var(--error);
}

.error-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.class-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--glass);
    border-radius: 15px;
    margin-bottom: 1.5rem;
}

.class-card {
    position: relative;
    background: var(--glass);
    border-radius: 15px;
    padding: 1.5rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.class-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
}

.class-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.class-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
}

.class-stat-label {
    font-size: 0.8rem;
    opacity: 0.7;
}

.class-stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: var(--gold);
}

.class-view {
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.class-view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.class-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    text-align: center;
}

.stat-card i {
    font-size: 2rem;
    color: var(--gold);
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--text);
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.7;
}

.student-list {
    margin-top: 2rem;
}

.student-table {
    width: 100%;
    margin-top: 1rem;
}

.student-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 2fr;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    margin-bottom: 0.5rem;
    align-items: center;
}

.student-row.header {
    font-weight: bold;
    background: rgba(255, 255, 255, 0.1);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    text-transform: capitalize;
}

.status-badge.free {
    background: var(--accent);
}

.status-badge.premium {
    background: var(--success);
}

.action-button.small {
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
}

.action-button.danger {
    background: var(--error);
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.event-card {
    background: var(--glass);
    border-radius: 15px;
    padding: 1.5rem;
    backdrop-filter: blur(10px);
}

.event-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.event-details {
    margin: 1rem 0;
}

.event-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
}

.status-badge.pending {
    background: var(--accent);
}

.status-badge.active {
    background: var(--success);
}

.status-badge.completed {
    background: var(--gold);
}

.participants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.participant-card {
    background: rgba(255,255,255,0.05);
    padding: 1rem;
    border-radius: 10px;
}

.event-management {
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow-y: auto;
}

.event-manage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.event-control-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.control-section {
    background: var(--glass);
    padding: 1.5rem;
    border-radius: 15px;
}

.control-section h3 {
    margin-bottom: 1rem;
    color: var(--gold);
}

.access-code-display {
    font-size: 1.5rem;
    font-family: monospace;
    padding: 1rem;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    text-align: center;
    margin-top: 0.5rem;
}

.participant-section {
    background: var(--glass);
    padding: 1.5rem;
    border-radius: 15px;
    margin-bottom: 1.5rem;
}

.participant-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}

.participant-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}

.participant-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.participant-name {
    font-weight: bold;
}

.participant-status {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
}

.participant-stats {
    display: flex;
    gap: 1rem;
    color: rgba(255,255,255,0.7);
}

.participant-actions {
    display: flex;
    gap: 0.5rem;
}

.empty-participants {
    text-align: center;
    padding: 2rem;
    color: rgba(255,255,255,0.7);
}

.hint {
    font-size: 0.9rem;
    color: var(--accent);
    margin-top: 0.5rem;
}

.action-button.small {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
}

.action-button.danger {
    background: var(--error);
}

.status-badge.active {
    background: var(--success);
}

.status-badge.completed {
    background: var(--gold);
}

.status-badge.pending {
    background: var(--accent);
}

.join-container {
    text-align: center;
    padding: 2rem;
    max-width: 400px;
    margin: 0 auto;
}

.join-form {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.join-form input {
    flex: 1;
    padding: 0.75rem;
    border-radius: 10px;
    border: 1px solid var(--glass);
    background: rgba(255,255,255,0.1);
    color: var(--text);
    font-size: 1.2rem;
    text-align: center;
    letter-spacing: 2px;
}
.event-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

.event-stats .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}

.stat-label {
    font-size: 0.8rem;
    opacity: 0.7;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--gold);
    margin-top: 0.5rem;
}

.participant-stats {
    display: flex;
    gap: 1.5rem;
    align-items: center;
}

.participant-stats .stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.participant-stats .stat i {
    color: var(--gold);
}

.status-badge.waiting {
    background: var(--accent);
}

.status-badge.playing {
    background: var(--success);
}

.status-badge.finished {
    background: var(--gold);
}

.word-display {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    background: var(--glass);
    padding: 2rem;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    text-align: center;
    min-width: 300px;
}

.word {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    color: var(--gold);
}

.options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.options button {
    padding: 1rem;
    border: none;
    background: rgba(255,255,255,0.1);
    color: var(--text);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.options button:hover {
    background: var(--accent);
    transform: translateY(-2px);
}

.word-count-display {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: var(--glass);
    padding: 1rem 2rem;
    border-radius: 15px;
    backdrop-filter: blur(10px);
}

.player-stats {
    position: fixed;
    top: 1rem;
    left: 1rem;
    display: flex;
    gap: 1rem;
}

.stat-card {
    background: var(--glass);
    padding: 1rem;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    color: var(--gold);
    margin-top: 0.5rem;
}

.perk-animation {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    animation: perkBounce 0.5s ease-out;
    text-align: center;
}

.perk-icon {
    font-size: 2rem;
    margin-bottom: 0.25rem;
}

.perk-name {
    font-size: 0.8rem;
    color: var(--text);
    white-space: nowrap;
}

.perk-effect-freeze .word-display {
    filter: blur(3px);
    pointer-events: none;
    animation: shiver 0.1s ease-in-out infinite;
}

.perk-effect-scramble .word {
    font-family: monospace;
    letter-spacing: 2px;
    animation: scramble 0.2s linear infinite;
}

.perk-effect-speed .timer-progress {
    animation-duration: 0.5s !important;
}

@keyframes perkBounce {
    0% { transform: translateX(-50%) scale(0); }
    50% { transform: translateX(-50%) scale(1.2); }
    100% { transform: translateX(-50%) scale(1); }
}

@keyframes shiver {
    0% { transform: translateX(-1px); }
    100% { transform: translateX(1px); }
}

@keyframes scramble {
    to { transform: skewX(3deg); }
}

.milestone-celebration {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    text-align: center;
    animation: popIn 0.5s ease-out;
}

.milestone-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.milestone-text {
    font-size: 2rem;
    color: var(--gold);
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.confetti-container {
    position: absolute;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

.confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    background: var(--gold);
    clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    animation: confettiFall 3s ease-out forwards;
    animation-delay: var(--delay);
    transform: rotate(var(--rotation));
}

.leaderboard {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: var(--glass);
    border-radius: 15px;
    padding: 1rem;
    backdrop-filter: blur(10px);
    width: 300px;
}

.leaderboard-header {
    font-size: 1.2rem;
    color: var(--gold);
    margin-bottom: 1rem;
    text-align: center;
}

.leaderboard-entry {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    padding: 0.5rem;
    align-items: center;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.current-player {
    background: rgba(255,255,255,0.1);
}

.rank {
    font-weight: bold;
    color: var(--gold);
}

.progress-bar {
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 0.25rem;
}

.progress {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s ease;
}

@keyframes confettiFall {
    to {
        transform: translateY(100vh) rotate(var(--rotation));
        opacity: 0;
    }
}

@keyframes popIn {
    from { transform: translate(-50%, -50%) scale(0); }
    50% { transform: translate(-50%, -50%) scale(1.2); }
    to { transform: translate(-50%, -50%) scale(1); }
}

.game-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    z-index: 100;
}

.perks-container {
    display: flex;
    gap: 0.5rem;
}

.perk-button {
    background: var(--glass);
    border: none;
    border-radius: 10px;
    padding: 0.5rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.perk-button:hover {
    transform: translateY(-2px);
    background: rgba(255,255,255,0.2);
}

.perk-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.perk-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.perk-cost {
    font-size: 0.8rem;
    color: var(--gold);
}

.leaderboard {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: var(--glass);
    border-radius: 15px;
    padding: 1rem;
    width: 300px;
    backdrop-filter: blur(10px);
    z-index: 100;
}

.leaderboard-header {
    margin-bottom: 1rem;
    text-align: center;
}

.leaderboard-entry {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 1rem;
    padding: 0.5rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: background-color 0.3s ease;
}

.leaderboard-entry.current-player {
    background: rgba(255,255,255,0.1);
}

.rank {
    font-weight: bold;
    color: var(--gold);
}

.player-info {
    display: flex;
    flex-direction: column;
}

.player-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.9rem;
    opacity: 0.8;
}

.player-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

    </style>
    
    <body>
        <!-- Role Selection Screen -->
        <div id="role-screen" class="screen visible">
            <h1 class="dashboard-title">Welcome to Simplos for Schools</h1>
            <div class="dashboard-nav">
                <button class="nav-button" data-role="student">Student</button>
                <button class="nav-button" data-role="teacher">Teacher</button>
            </div>
            
            <!-- Add auth container here -->
            <div class="auth-container" id="authBox" style="display: none;">
                <div class="auth-login" id="loginForm">
                    <input type="text" class="auth-input" placeholder="Username" id="loginUsername">
                    <input type="password" class="auth-input" placeholder="Password" id="loginPassword">
                    <button class="auth-button" onclick="handleLogin()">Login</button>
                </div>
            </div>
        </div>
    
        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="screen">
            <div class="dashboard-container">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Teacher Dashboard</h1>
                    <div class="auth-controls">
                        <span class="user-email"></span>
                        <button class="logout-button" onclick="handleLogout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <div class="dashboard-nav">
                    <button class="nav-button active" onclick="switchTab('events')">Events</button>
                    <button class="nav-button" onclick="switchTab('classes')">Classes</button>
                    <button class="nav-button" onclick="switchTab('lists')">Word Lists</button>
                    <button class="nav-button" onclick="switchTab('statistics')">Statistics</button>
                </div>
        
                <div id="events-panel" class="dashboard-panel">
                    <!-- Event cards will be populated here -->
                </div>
        
                <div id="classes-panel" class="dashboard-panel" style="display: none;">
                    <!-- Class cards will be populated here -->
                </div>
        
                <div id="lists-panel" class="dashboard-panel" style="display: none;">
                    <!-- Word lists will be populated here -->
                </div>
        
                <div id="statistics-panel" class="dashboard-panel" style="display: none;">
                    <!-- Statistics will be populated here -->
                </div>
            </div>
        </div>

        <!-- Arcade Race Screen -->
        <div id="arcade-screen" class="screen">
            <div class="race-container">
                <!-- Track levels will be generated here -->
            </div>
        </div>
    
<!-- Event Creation Modal -->
<div id="event-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2>Create New Event</h2>
        <form id="event-form" onsubmit="handleEventSubmit(event)">
            <div class="form-group">
                <label>Event Name</label>
                <input type="text" id="event-name" required>
            </div>
            
            <div class="form-group">
                <label>Event Type</label>
                <select id="event-type" required>
                    <option value="arcade">Arcade Race</option>
                    <option value="standard">Standard Practice</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Grade Level</label>
                <select id="grade-level" multiple required>
                    <option value="1">Elementary (Stage 1-2)</option>
                    <option value="2">Junior High (Stage 1-3)</option>
                    <option value="3">High School (Stage 1-4)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Target Class</label>
                <select id="target-class">
                    <option value="all">All Classes</option>
                </select>
            </div>

            <div class="form-group">
                <button type="submit" class="action-button">Create Event</button>
                <button type="button" class="action-button cancel" onclick="closeEventModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="classes-panel" class="dashboard-panel" style="display: none;">
    <div class="panel-header">
        <h2>My Classes</h2>
        <button onclick="showCreateClassModal()" class="action-button">
            <i class="fas fa-plus"></i> Create Class
        </button>
    </div>
    <div class="class-list">
        <!-- Classes will be populated here -->
    </div>
</div>

<div id="create-class-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2>Create New Class</h2>
        <form id="class-form" onsubmit="handleClassSubmit(event)">
            <div class="form-group">
                <label>Class Name</label>
                <input type="text" id="class-name" required>
            </div>
            
            <div class="form-group">
                <label>Grade Level</label>
                <select id="class-grade" required>
                    <option value="">Select Grade</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
            </div>

            <div class="form-group">
                <label>Maximum Students</label>
                <input type="number" id="class-size" min="1" max="50" value="30">
            </div>

            <div class="form-group">
                <label>Class Description</label>
                <textarea id="class-description" rows="3"></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="action-button">Create Class</button>
                <button type="button" class="action-button cancel" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="student-join-screen" class="screen">
    <div class="join-container">
        <h2>Join Event</h2>
        <div class="join-form">
            <input type="text" id="access-code-input" placeholder="Enter Access Code" maxlength="6">
            <button onclick="joinArcadeEvent()" class="action-button">
                Join
            </button>
        </div>
    </div>
</div>


    <script>

// Global role selection handler
window.selectRole = function(role) {
    currentRole = role;
    document.querySelectorAll('.screen').forEach(screen => 
        screen.classList.remove('visible'));
    
    if (role === 'teacher') {
        showLoginPrompt('teacher');
    } else {
        document.getElementById('student-join-screen').classList.add('visible');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Remove existing role-based event listeners
    document.querySelectorAll('.nav-button[data-role]').forEach(button => {
        const clone = button.cloneNode(true);
        button.parentNode.replaceChild(clone, button);
        clone.addEventListener('click', () => {
            console.log('Role button clicked:', clone.dataset.role);
            selectRole(clone.dataset.role);
        });
    });
});

    document.addEventListener('DOMContentLoaded', () => {
    // Debug log to confirm our listener is attached
    console.log('Setting up role selection handlers');
    
    const roleButtons = document.querySelectorAll('.nav-button');
    console.log('Found role buttons:', roleButtons.length);
    
    roleButtons.forEach(button => {
        button.addEventListener('click', function() {
            console.log('Button clicked:', this.textContent);
            const role = this.textContent.toLowerCase();
            
            // Hide all screens first
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('visible');
            });
            
            currentRole = role;
            
            if (role === 'teacher') {
                const authBox = document.getElementById('authBox');
                if (authBox) {
                    authBox.style.display = 'block';
                }
                showLoginPrompt('teacher');
            } else {
                const studentScreen = document.getElementById('student-join-screen');
                if (studentScreen) {
                    studentScreen.classList.add('visible');
                }
            }
        });
    });
});


    
    const { createClient } = supabase;
    const supabaseClient = createClient(
        'https://mczfgzffyyyacisrccqb.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jemZnemZmeXl5YWNpc3JjY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzODYyMDQsImV4cCI6MjA1Mzk2MjIwNH0.rLga_B29Coz1LMeJzFTGLIhckdcojGXnD1ae1bw-QAI'
    );
    
    let currentUser = null;
    let currentRole = null;
    
    async function checkExistingSession() {
        try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                const { data: profile } = await supabaseClient
                    .from('user_profiles')
                    .select('status, role')
                    .eq('id', currentUser.id)
                    .single();
                    
                if (profile) {
                    currentUser.status = profile.status;
                    currentUser.role = profile.role;
                    if (profile.role === 'teacher') {
                        showTeacherDashboard();
                    }
                }
                updateAuthUI();
            }
        } catch (error) {
            console.error('Session check error:', error);
        }
    }
    
    function selectRole(role) {
    console.log('Selecting role:', role);
    currentRole = role;
    
    document.querySelectorAll('.screen').forEach(screen => 
        screen.classList.remove('visible'));
        
    if (role === 'teacher') {
        showLoginPrompt('teacher');
    } else {
        const studentScreen = document.getElementById('student-join-screen');
        if (studentScreen) {
            studentScreen.classList.add('visible');
        }
    }
}


function showLoginPrompt() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Teacher Login</h2>
            <form id="teacher-login-form">
                <div class="form-group">
                    <label for="teacher-email">Email</label>
                    <input type="email" id="teacher-email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="teacher-password">Password</label>
                    <input type="password" id="teacher-password" required autocomplete="current-password">
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-button">Login</button>
                    <button type="button" class="action-button cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);

    const form = modal.querySelector('#teacher-login-form');
    form.addEventListener('submit', handleTeacherLogin);
}
    
function showTeacherDashboard() {
    console.log('Showing teacher dashboard');
    
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('visible');
        console.log('Removed visible from:', screen.id);
    });
    
    const dashboard = document.getElementById('teacher-dashboard');
    if (!dashboard) {
        console.error('Teacher dashboard element not found');
        return;
    }
    
    dashboard.classList.add('visible');
    console.log('Dashboard visible added');

    const emailDisplay = document.querySelector('.user-email');
    if (emailDisplay && currentUser) {
        emailDisplay.textContent = currentUser.email;
    }

    switchTab('events');
    loadTeacherEvents();
}

function closeModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.remove();
    });
}
    
    function showStudentView() {
        document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('visible'));
        document.getElementById('arcade-screen').classList.add('visible');
        initializeRaceTrack();
    }
    
    function switchTab(tab) {
    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
        if(btn.textContent.toLowerCase().includes(tab)) {
            btn.classList.add('active');
        }
    });

    document.querySelectorAll('.dashboard-panel').forEach(panel => {
        panel.style.display = 'none';
    });

    const selectedPanel = document.getElementById(`${tab}-panel`);
    if(selectedPanel) {
        selectedPanel.style.display = 'block';
        
        // Update panel content
        if(tab === 'classes') {
            updateClassesPanel();
        } else if(tab === 'events') {
            loadTeacherEvents();
        }
    }
}

function updatePanel(tab) {
    switch(tab) {
        case 'classes':
            updateClassesPanel();
            break;
        case 'events':
            loadTeacherEvents();
            break;
    }
}

async function handleLogout() {
    try {
        const { error } = await supabaseClient.auth.signOut();
        
        if (error) {
            console.error('Logout error:', error.message);
            return;
        }

        currentUser = null;
        currentRole = null;
        
        // Clear any active managers
        if(window.classManager) {
            classManager.cleanup();
            window.classManager = null;
        }
        if(window.wordListManager) {
            wordListManager.cleanup();
            window.wordListManager = null;
        }
        if(window.analyticsManager) {
            analyticsManager.cleanup();
            window.analyticsManager = null;
        }
        
        // Hide all screens
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('visible');
        });
        
        // Show role selection screen
        const roleScreen = document.getElementById('role-screen');
        roleScreen.classList.add('visible');
        
        // Hide auth box
        const authBox = document.getElementById('authBox');
        if(authBox) {
            authBox.style.display = 'none';
        }
    } catch (error) {
        console.error('Unexpected error during logout:', error);
    }
}

async function showTeacherDashboard() {
    // Hide other screens
    document.querySelectorAll('.screen').forEach(screen => 
        screen.classList.remove('visible'));
    
    // Show teacher dashboard
    const dashboard = document.getElementById('teacher-dashboard');
    dashboard.classList.add('visible');

    // Set user email
    const emailDisplay = document.querySelector('.user-email');
    if(emailDisplay && currentUser) {
        emailDisplay.textContent = currentUser.email;
    }

    // Initialize with events tab
    switchTab('events');
}

function loadTeacherEvents() {
    const eventsPanel = document.getElementById('events-panel');
    if (!eventsPanel) return;

    supabaseClient
        .from('arcade_events')
        .select('*')
        .eq('teacher_id', currentUser.id)
        .then(({ data: events, error }) => {
            if (error) {
                console.error('Error loading events:', error);
                return;
            }

            eventsPanel.innerHTML = `
                <div class="panel-header">
                    <h2>Events</h2>
                    <button onclick="createNewEvent()" class="action-button">
                        <i class="fas fa-plus"></i> Create Event
                    </button>
                </div>
                ${events && events.length > 0 ? `
                    <div class="events-grid">
                        ${events.map(event => `
                            <div class="event-card">
                                <div class="event-header">
                                    <h3>${event.name}</h3>
                                    <span class="status-badge ${event.status}">${event.status}</span>
                                </div>
                                <div class="event-details">
                                    <p>Type: ${event.type}</p>
                                    ${event.status !== 'completed' ? 
                                        `<p>Access Code: ${event.access_code || 'Not set'}</p>` : ''}
                                </div>
                                <div class="event-actions">
                                    ${event.status === 'completed' ? `
                                        <button onclick="deleteEvent('${event.id}')" class="action-button danger">
                                            Delete
                                        </button>
                                    ` : `
                                        <button onclick="manageEvent('${event.id}')" class="action-button">
                                            Manage
                                        </button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state">
                        <i class="fas fa-calendar-plus"></i>
                        <h3>No Events Yet</h3>
                        <p>Create your first event to get started!</p>
                        <button onclick="createNewEvent()" class="action-button">
                            Create Event
                        </button>
                    </div>
                `}
            `;
        });
}
    
    function initializeRaceTrack() {
        const raceContainer = document.querySelector('.race-container');
        // Clear existing content
        raceContainer.innerHTML = '';
    
        // Create 4 levels
        for (let i = 0; i < 4; i++) {
            const trackLevel = document.createElement('div');
            trackLevel.className = 'track-level';
            
            const trackPath = document.createElement('div');
            trackPath.className = 'track-path';
            
            // Add direction indicator
            trackPath.style.transform = i % 2 === 0 ? 'none' : 'scaleX(-1)';
            
            trackLevel.appendChild(trackPath);
            raceContainer.appendChild(trackLevel);
        }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        checkExistingSession();
    });

    async function createNewEvent() {
    try {
        const accessCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const { data, error } = await supabaseClient
            .from('arcade_events')
            .insert({
                teacher_id: currentUser.id,
                name: 'New Event',
                access_code: accessCode,
                status: 'pending'
            })
            .select()
            .single();

        if (error) throw error;

        showNotification('Event created successfully!');
        loadTeacherEvents();
        return data;
    } catch (error) {
        console.error('Event creation error:', error);
        showNotification('Error creating event', 'error');
        return null;
    }
}

function loadTeacherClasses() {
    if (!currentUser) return;
    
    supabaseClient
        .from('school_classes')
        .select('*')
        .eq('teacher_id', currentUser.id)
        .then(({ data: classes, error }) => {
            if (error) {
                console.error('Error loading classes:', error);
                return;
            }

            const classSelect = document.getElementById('target-class');
            if (classSelect) {
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    classSelect.appendChild(option);
                });
            }
        });
}

function handleEventSubmit(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('event-name').value,
        type: document.getElementById('event-type').value,
        grade_levels: Array.from(document.getElementById('grade-level').selectedOptions).map(opt => parseInt(opt.value)),
        class_id: document.getElementById('target-class').value === 'all' ? null : document.getElementById('target-class').value
    };

    const accessCode = Math.random().toString(36).substring(2, 8).toUpperCase();
    
    const eventData = {
        ...formData,
        teacher_id: currentUser.id,
        status: 'pending',
        access_code: accessCode,
        created_at: new Date().toISOString()
    };

    console.log('Creating event:', eventData);

    supabaseClient
        .from('arcade_events')
        .insert(eventData)
        .select()
        .single()
        .then(({ data, error }) => {
            if (error) throw error;
            showNotification('Event created successfully!');
            closeModal();
            loadTeacherEvents();
        })
        .catch(error => {
            console.error('Event creation error:', error);
            showNotification(error.message, 'error');
        });
}

function generateOTP() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

function closeEventModal() {
    document.getElementById('event-modal').style.display = 'none';
    document.getElementById('event-form').reset();
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

class ArcadeEventManager {
    constructor() {
        this.events = new Map();
        this.currentEvent = null;
        this.subscription = null;
    }

    async createEvent(eventData) {
        try {
            const access_code = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { data, error } = await supabaseClient
                .from('arcade_events')
                .insert([{
                    ...eventData,
                    access_code,
                    status: 'pending',
                    teacher_id: currentUser.id,
                    created_at: new Date().toISOString()
                }])
                .select()
                .single();

            if (error) throw error;
            return data;
        } catch (error) {
            console.error('Error creating event:', error);
            throw error;
        }
    }

    async startEvent(eventId) {
        try {
            const { data: event, error } = await supabaseClient
                .from('arcade_events')
                .update({ 
                    status: 'active',
                    started_at: new Date().toISOString()
                })
                .eq('id', eventId)
                .select()
                .single();

            if (error) throw error;

            // Initialize game state
            this.currentEvent = event;
            this.initializeRealTimeSync(eventId);
            
            return event;
        } catch (error) {
            console.error('Error starting event:', error);
            throw error;
        }
    }

    async joinEvent(accessCode) {
        try {
            const { data: event, error } = await supabaseClient
                .from('arcade_events')
                .select('*')
                .eq('access_code', accessCode)
                .eq('status', 'active')
                .single();

            if (error) throw error;

            // Join as participant
            const { error: joinError } = await supabaseClient
                .from('arcade_participants')
                .insert([{
                    event_id: event.id,
                    player_id: currentUser.id
                }]);

            if (joinError) throw joinError;

            this.currentEvent = event;
            this.initializeRealTimeSync(event.id);
            
            return event;
        } catch (error) {
            console.error('Error joining event:', error);
            throw error;
        }
    }

    initializeRealTimeSync(eventId) {
        // Clean up existing subscription
        if (this.subscription) {
            this.subscription.unsubscribe();
        }

        // Subscribe to event changes
        this.subscription = supabaseClient
            .channel(`event:${eventId}`)
            .on('presence', { event: 'sync' }, () => {
                this.syncGameState();
            })
            .on('broadcast', { event: 'player_move' }, ({ payload }) => {
                this.handlePlayerMove(payload);
            })
            .on('broadcast', { event: 'perk_used' }, ({ payload }) => {
                this.handlePerkUsage(payload);
            })
            .subscribe();
    }

    async syncGameState() {
        if (!this.currentEvent) return;

        const { data: participants, error } = await supabaseClient
            .from('arcade_participants')
            .select('*')
            .eq('event_id', this.currentEvent.id);

        if (error) {
            console.error('Error syncing game state:', error);
            return;
        }

        participants.forEach(participant => {
            raceTrack.updatePlayerPosition(
                participant.player_id,
                participant.words_completed
            );
        });
    }

    handlePlayerMove(payload) {
        const { playerId, position, wordsCompleted } = payload;
        raceTrack.updatePlayerPosition(playerId, wordsCompleted);
    }

    handlePerkUsage(payload) {
        const { playerId, perkType, targetId } = payload;
        // Implement perk effects based on type
        switch(perkType) {
            case 'freeze':
                raceTrack.freezePlayer(targetId, 5000);
                break;
            case 'boost':
                raceTrack.boostPlayer(playerId);
                break;
            case 'shuffle':
                this.shuffleWords(playerId);
                break;
        }
    }

    cleanup() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
        this.currentEvent = null;
        this.events.clear();
    }
}

class ClassroomManager {
    constructor() {
        this.classes = new Map();
        this.activeClass = null;
    }

    async createClass(className, gradeLevel) {
        try {
            const { data: school } = await supabaseClient
                .from('schools')
                .select('id')
                .eq('teacher_id', currentUser.id)
                .single();

            const { data: newClass, error } = await supabaseClient
                .from('school_classes')
                .insert([{
                    school_id: school.id,
                    teacher_id: currentUser.id,
                    name: className,
                    grade_level: gradeLevel
                }])
                .select()
                .single();

            if (error) throw error;
            
            this.classes.set(newClass.id, newClass);
            this.updateClassList();
            return newClass;
        } catch (error) {
            console.error('Error creating class:', error);
            throw error;
        }
    }

    async loadTeacherClasses() {
        try {
            const { data: classes, error } = await supabaseClient
                .from('school_classes')
                .select(`
                    *,
                    class_enrollments (
                        student_id,
                        joined_at
                    )
                `)
                .eq('teacher_id', currentUser.id);

            if (error) throw error;

            this.classes.clear();
            classes.forEach(cls => this.classes.set(cls.id, cls));
            this.updateClassList();
            return classes;
        } catch (error) {
            console.error('Error loading classes:', error);
            throw error;
        }
    }

    updateClassList() {
        const classPanel = document.getElementById('classes-panel');
        if (!classPanel) return;

        classPanel.innerHTML = Array.from(this.classes.values()).map(cls => `
            <div class="class-card" data-class-id="${cls.id}">
                <div class="class-header">
                    <h3 class="class-title">${cls.name}</h3>
                    <span class="grade-level">Grade ${cls.grade_level}</span>
                </div>
                <div class="class-stats">
                    <div class="stat">
                        <i class="fas fa-users"></i>
                        <span>${cls.class_enrollments?.length || 0} Students</span>
                    </div>
                </div>
                <div class="class-actions">
                    <button onclick="classManager.viewClass('${cls.id}')" class="action-button">
                        View Class
                    </button>
                    <button onclick="classManager.generateInviteCode('${cls.id}')" class="action-button">
                        Invite Code
                    </button>
                </div>
            </div>
        `).join('');
    }

    async viewClass(classId) {
        try {
            const { data: students, error } = await supabaseClient
                .from('class_enrollments')
                .select(`
                    *,
                    user_profiles:student_id (
                        username,
                        status
                    )
                `)
                .eq('class_id', classId);

            if (error) throw error;

            const classModal = document.createElement('div');
            classModal.className = 'modal';
            classModal.innerHTML = `
                <div class="modal-content">
                    <h2>${this.classes.get(classId).name}</h2>
                    <div class="student-list">
                        ${students.map(student => `
                            <div class="student-card">
                                <div class="student-info">
                                    <span>${student.user_profiles.username}</span>
                                    <span class="student-status ${student.user_profiles.status}">
                                        ${student.user_profiles.status}
                                    </span>
                                </div>
                                <button onclick="classManager.viewStudentProgress('${student.student_id}')" 
                                        class="action-button">
                                    View Progress
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="closeModal()" class="action-button cancel">Close</button>
                </div>
            `;
            document.body.appendChild(classModal);
        } catch (error) {
            console.error('Error viewing class:', error);
            showNotification('Error loading class data', 'error');
        }
    }

    async generateInviteCode(classId) {
        try {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { error } = await supabaseClient
                .from('school_classes')
                .update({ invite_code: code })
                .eq('id', classId);

            if (error) throw error;

            showNotification(`Invite Code: ${code}`, 'success');
        } catch (error) {
            console.error('Error generating invite code:', error);
            showNotification('Error generating invite code', 'error');
        }
    }

    async viewStudentProgress(studentId) {
        try {
            const { data: progress, error } = await supabaseClient
                .from('player_stats')
                .select('*')
                .eq('user_id', studentId)
                .single();

            if (error) throw error;

            const progressModal = document.createElement('div');
            progressModal.className = 'modal';
            progressModal.innerHTML = `
                <div class="modal-content">
                    <h2>Student Progress</h2>
                    <div class="progress-stats">
                        <div class="stat">
                            <h3>Total Words</h3>
                            <span>${progress.total_words_learned}</span>
                        </div>
                        <div class="stat">
                            <h3>Completed Levels</h3>
                            <span>${progress.total_levels_completed}</span>
                        </div>
                        <div class="stat">
                            <h3>Average Score</h3>
                            <span>${progress.average_score || 0}</span>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="action-button cancel">Close</button>
                </div>
            `;
            document.body.appendChild(progressModal);
        } catch (error) {
            console.error('Error viewing student progress:', error);
            showNotification('Error loading student progress', 'error');
        }
    }
}

// Initialize class manager
const classManager = new ClassroomManager();

class WordListManager {
    constructor() {
        this.lists = new Map();
        this.activeList = null;
    }

    async createList(name, words, translations, gradeLevel) {
        try {
            const { data: list, error } = await supabaseClient
                .from('teacher_wordlists')
                .insert([{
                    teacher_id: currentUser.id,
                    name,
                    words,
                    translations,
                    grade_level: gradeLevel
                }])
                .select()
                .single();

            if (error) throw error;
            this.lists.set(list.id, list);
            this.updateListDisplay();
            return list;
        } catch (error) {
            console.error('Error creating word list:', error);
            throw error;
        }
    }

    async loadLists() {
        try {
            const { data: lists, error } = await supabaseClient
                .from('teacher_wordlists')
                .select('*')
                .eq('teacher_id', currentUser.id);

            if (error) throw error;

            this.lists.clear();
            lists.forEach(list => this.lists.set(list.id, list));
            this.updateListDisplay();
        } catch (error) {
            console.error('Error loading word lists:', error);
        }
    }

    updateListDisplay() {
        const listsPanel = document.getElementById('lists-panel');
        if (!listsPanel) return;

        listsPanel.innerHTML = `
            <div class="panel-header">
                <h2>Word Lists</h2>
                <button onclick="wordListManager.showCreateList()" class="action-button">
                    Create List
                </button>
            </div>
            <div class="lists-grid">
                ${Array.from(this.lists.values()).map(list => `
                    <div class="list-card" data-list-id="${list.id}">
                        <div class="list-header">
                            <h3>${list.name}</h3>
                            <span class="word-count">${list.words.length} words</span>
                        </div>
                        <div class="list-preview">
                            ${list.words.slice(0, 3).map((word, i) => `
                                <div class="word-pair">
                                    <span>${word}</span>
                                    <span>${list.translations[i]}</span>
                                </div>
                            `).join('')}
                            ${list.words.length > 3 ? `
                                <div class="more-words">+${list.words.length - 3} more</div>
                            ` : ''}
                        </div>
                        <div class="list-actions">
                            <button onclick="wordListManager.editList('${list.id}')" 
                                    class="action-button">
                                Edit
                            </button>
                            <button onclick="wordListManager.shareList('${list.id}')"
                                    class="action-button">
                                Share
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    showCreateList() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <h2>Create Word List</h2>
                <form id="word-list-form">
                    <div class="form-group">
                        <label>List Name</label>
                        <input type="text" id="list-name" required>
                    </div>
                    <div class="form-group">
                        <label>Grade Level</label>
                        <select id="list-grade" required>
                            ${Array.from({length: 12}, (_, i) => `
                                <option value="${i+1}">Grade ${i+1}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Words</label>
                        <div id="word-pairs">
                            <div class="word-pair-input">
                                <input type="text" placeholder="English word" required>
                                <input type="text" placeholder="Hebrew translation" required>
                                <button type="button" onclick="this.parentElement.remove()">❌</button>
                            </div>
                        </div>
                        <button type="button" onclick="wordListManager.addWordPair()" 
                                class="action-button">
                            Add Word
                        </button>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-button">Create List</button>
                        <button type="button" onclick="closeModal()" 
                                class="action-button cancel">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        `;
        document.body.appendChild(modal);

        modal.querySelector('form').onsubmit = (e) => this.handleListSubmit(e);
    }

    addWordPair() {
        const container = document.getElementById('word-pairs');
        const pair = document.createElement('div');
        pair.className = 'word-pair-input';
        pair.innerHTML = `
            <input type="text" placeholder="English word" required>
            <input type="text" placeholder="Hebrew translation" required>
            <button type="button" onclick="this.parentElement.remove()">❌</button>
        `;
        container.appendChild(pair);
    }

    async handleListSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const name = form.querySelector('#list-name').value;
        const grade = parseInt(form.querySelector('#list-grade').value);
        
        const pairs = Array.from(form.querySelectorAll('.word-pair-input')).map(pair => ({
            word: pair.querySelector('input:first-child').value,
            translation: pair.querySelector('input:last-of-type').value
        }));

        await this.createList(
            name,
            pairs.map(p => p.word),
            pairs.map(p => p.translation),
            grade
        );

        closeModal();
        showNotification('Word list created successfully!');
    }
}

const wordListManager = new WordListManager();


class AnalyticsManager {
    constructor() {
        this.data = null;
    }

    async loadClassStats(classId) {
        try {
            const { data: stats, error } = await supabaseClient
                .from('class_enrollments')
                .select(`
                    student_id,
                    user_profiles!student_id (
                        username
                    ),
                    player_stats!student_id (
                        total_words_learned,
                        total_levels_completed,
                        average_score
                    )
                `)
                .eq('class_id', classId);

            if (error) throw error;

            this.data = stats;
            this.updateAnalyticsDisplay();
        } catch (error) {
            console.error('Error loading class stats:', error);
        }
    }

    updateAnalyticsDisplay() {
        const analyticsPanel = document.getElementById('analytics-panel');
        if (!analyticsPanel || !this.data) return;

        const averageWords = this.data.reduce((acc, student) => 
            acc + (student.player_stats?.total_words_learned || 0), 0) / this.data.length;

        const averageScore = this.data.reduce((acc, student) => 
            acc + (student.player_stats?.average_score || 0), 0) / this.data.length;

        analyticsPanel.innerHTML = `
            <div class="analytics-overview">
                <div class="stat-card">
                    <h3>Class Average Words</h3>
                    <div class="stat-value">${Math.round(averageWords)}</div>
                </div>
                <div class="stat-card">
                    <h3>Class Average Score</h3>
                    <div class="stat-value">${averageScore.toFixed(1)}%</div>
                </div>
            </div>
            <div class="student-rankings">
                <h3>Student Rankings</h3>
                <div class="ranking-list">
                    ${this.data.sort((a, b) => 
                        (b.player_stats?.total_words_learned || 0) - 
                        (a.player_stats?.total_words_learned || 0)
                    ).map((student, index) => `
                        <div class="ranking-item">
                            <span class="rank">#${index + 1}</span>
                            <span class="student-name">
                                ${student.user_profiles.username}
                            </span>
                            <span class="words-learned">
                                ${student.player_stats?.total_words_learned || 0} words
                            </span>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${
                                    (student.player_stats?.total_words_learned || 0) / 
                                    Math.max(...this.data.map(s => 
                                        s.player_stats?.total_words_learned || 0
                                    )) * 100
                                }%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
}

const analyticsManager = new AnalyticsManager();

async function handleLogin() {
    console.log('Login attempt');
    const email = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    console.log('Credentials entered:', email ? 'Yes' : 'No');
    
    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
        });

        console.log('Login response:', data ? 'Success' : 'Failed');

        if (error) throw error;

        if (data.user) {
            currentUser = data.user;
            console.log('Current user set:', currentUser.id);
            
            showTeacherDashboard();
        }
    } catch (error) {
        console.error('Login error:', error);
        alert(error.message);
    }
}


function showCreateClassModal() {
    console.log('Opening class modal');
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.setAttribute('id', 'create-class-modal'); // Add ID for reference
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Create New Class</h2>
            <form id="create-class-form">
                <div class="form-group">
                    <label>Class Name</label>
                    <input type="text" class="form-input" name="className" id="class-name-input" required>
                </div>
                <div class="form-group">
                    <label>Grade Level</label>
                    <select class="form-input" name="gradeLevel" id="class-grade-input" required>
                        <option value="">Select Grade</option>
                        ${Array.from({length: 12}, (_, i) => 
                            `<option value="${i+1}">Grade ${i+1}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Maximum Students</label>
                    <input type="number" class="form-input" name="maxStudents" id="class-size-input" min="1" max="50" value="30">
                </div>
                <div class="form-actions">
                    <button type="submit" class="action-button">Create Class</button>
                    <button type="button" class="action-button cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    `;

    // Remove any existing modal first
    const existingModal = document.getElementById('create-class-modal');
    if (existingModal) {
        existingModal.remove();
    }

    document.body.appendChild(modal);

    // Add form submit handler
    const form = modal.querySelector('#create-class-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('class-name-input').value,
                grade: document.getElementById('class-grade-input').value,
                size: document.getElementById('class-size-input').value
            };
            console.log('Form submitted with data:', formData);
            handleClassSubmit(e, formData);
        });
    } else {
        console.error('Form not found in modal');
    }
}

function handleClassSubmit(event, formData) {
    event.preventDefault();
    
    const form = event.target;
    const className = form.querySelector('input[name="className"]').value;
    const gradeLevel = form.querySelector('select[name="gradeLevel"]').value;
    const maxStudents = form.querySelector('input[name="maxStudents"]').value;
    
    console.log('Form Data:', { className, gradeLevel, maxStudents });

    if (!className?.trim()) {
        showNotification('Please enter a class name', 'error');
        return;
    }

    const classData = {
        teacher_id: currentUser.id,
        name: className.trim(),
        grade_level: parseInt(gradeLevel),
        max_students: parseInt(maxStudents || '30'),
        created_at: new Date().toISOString(),
        status: 'active'
    };
    
    console.log('Submitting class data to Supabase:', classData);

    supabaseClient
        .from('school_classes')
        .insert([classData])
        .select()
        .single()
        .then(async ({ data: newClass, error }) => {
            if (error) throw error;

            const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { error: updateError } = await supabaseClient
                .from('school_classes')
                .update({ invite_code: inviteCode })
                .eq('id', newClass.id);

            if (updateError) throw updateError;

            closeModal();
            showNotification('Class created successfully!');
            updateClassesPanel();
            showInviteCode(inviteCode);
        })
        .catch(error => {
            console.error('Class creation error:', error);
            showNotification('Failed to create class: ' + error.message, 'error');
        });
}

async function updateClassesPanel() {
    const panel = document.getElementById('classes-panel');
    if (!panel) return;

    try {
        const { data: classes, error } = await supabaseClient
            .from('school_classes')
            .select('*')
            .eq('teacher_id', currentUser.id);

        if (error) throw error;

        panel.innerHTML = `
            <div class="panel-header">
                <h2>My Classes</h2>
                <button class="action-button" onclick="showCreateClassModal()">
                    <i class="fas fa-plus"></i> Create Class
                </button>
            </div>
            ${classes?.length ? `
                <div class="class-grid">
                    ${classes.map(cls => `
                        <div class="class-card">
                            <div class="class-header">
                                <h3>${cls.name}</h3>
                                <span class="grade-level">Grade ${cls.grade_level}</span>
                            </div>
                            <div class="class-actions">
                                <button onclick="viewClass('${cls.id}')" class="action-button">
                                    View Class
                                </button>
                                <button onclick="generateInviteCode('${cls.id}')" class="action-button">
                                    Invite Code
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <h3>No Classes Yet</h3>
                    <p>Create your first class to get started!</p>
                    <button onclick="showCreateClassModal()" class="action-button">
                        Create Class
                    </button>
                </div>
            `}
        `;
    } catch (error) {
        console.error('Error loading classes:', error);
        panel.innerHTML = `
            <div class="error-state">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Error Loading Classes</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

async function viewClass(classId) {
    try {
        const { data: classData, error: classError } = await supabaseClient
            .from('school_classes')
            .select(`
                *,
                class_enrollments (
                    student_id,
                    joined_at,
                    user_profiles:student_id (
                        username,
                        status
                    )
                )
            `)
            .eq('id', classId)
            .single();

        if (classError) throw classError;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content class-view">
                <div class="class-view-header">
                    <h2>${classData.name}</h2>
                    <span class="grade-level">Grade ${classData.grade_level}</span>
                </div>
                
                <div class="class-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <span class="stat-value">${classData.class_enrollments.length}</span>
                        <span class="stat-label">Students</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-star"></i>
                        <span class="stat-value">${classData.max_students - classData.class_enrollments.length}</span>
                        <span class="stat-label">Spots Left</span>
                    </div>
                </div>

                <div class="student-list">
                    <h3>Students</h3>
                    ${classData.class_enrollments.length > 0 ? `
                        <div class="student-table">
                            <div class="student-row header">
                                <div class="col">Student</div>
                                <div class="col">Status</div>
                                <div class="col">Joined</div>
                                <div class="col">Actions</div>
                            </div>
                            ${classData.class_enrollments.map(enrollment => `
                                <div class="student-row">
                                    <div class="col">${enrollment.user_profiles.username}</div>
                                    <div class="col">
                                        <span class="status-badge ${enrollment.user_profiles.status}">
                                            ${enrollment.user_profiles.status}
                                        </span>
                                    </div>
                                    <div class="col">${new Date(enrollment.joined_at).toLocaleDateString()}</div>
                                    <div class="col">
                                        <button onclick="viewStudentProgress('${enrollment.student_id}')" 
                                                class="action-button small">
                                            Progress
                                        </button>
                                        <button onclick="removeStudent('${enrollment.student_id}', '${classId}')" 
                                                class="action-button small danger">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="empty-state">
                            <p>No students enrolled yet</p>
                            <button onclick="generateInviteCode('${classId}')" class="action-button">
                                Invite Students
                            </button>
                        </div>
                    `}
                </div>

                <div class="modal-actions">
                    <button onclick="generateInviteCode('${classId}')" class="action-button">
                        <i class="fas fa-user-plus"></i> Invite Students
                    </button>
                    <button onclick="closeModal()" class="action-button cancel">
                        Close
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

    } catch (error) {
        console.error('Error viewing class:', error);
        showNotification('Error loading class details', 'error');
    }
}

async function generateInviteCode(classId) {
    try {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const { error } = await supabaseClient
            .from('school_classes')
            .update({ invite_code: code })
            .eq('id', classId);

        if (error) throw error;

        showClassInvite(code);
    } catch (error) {
        console.error('Error generating invite code:', error);
        showNotification('Error generating invite code', 'error');
    }
}

function showClassInvite(code) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Class Invite Code</h2>
            <div class="invite-code">
                <span>${code}</span>
                <button onclick="copyInviteCode('${code}')" class="action-button">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <p class="invite-info">Share this code with your students to join the class</p>
            <button onclick="closeModal()" class="action-button">Close</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function copyInviteCode(code) {
    navigator.clipboard.writeText(code)
        .then(() => showNotification('Code copied to clipboard!'))
        .catch(err => console.error('Error copying code:', err));
}

function updateAuthUI() {
    const authBox = document.getElementById('authBox');
    const userInfo = document.querySelector('.user-email');
    const logoutButton = document.querySelector('.logout-button');

    if (currentUser) {
        if (authBox) authBox.classList.add('hidden');
        if (userInfo) userInfo.textContent = currentUser.email;
        if (logoutButton) logoutButton.classList.remove('hidden');
    } else {
        if (authBox) authBox.classList.remove('hidden');
        if (userInfo) userInfo.textContent = '';
        if (logoutButton) logoutButton.classList.add('hidden');
    }
}


function handleClassSubmit(event) {
    event.preventDefault();
    console.log('Form submitted');
    
    const form = event.target;
    // Fix the selectors to match the actual form elements
    const className = document.getElementById('class-name-input').value;
    const gradeLevel = document.getElementById('class-grade-input').value;
    const maxStudents = document.getElementById('class-size-input').value;
    
    if (!className?.trim()) {
        showNotification('Please enter a class name', 'error');
        return;
    }

    const classData = {
        teacher_id: currentUser.id,
        name: className.trim(),
        grade_level: parseInt(gradeLevel),
        max_students: parseInt(maxStudents || '30'),
        created_at: new Date().toISOString(),
        status: 'active'
    };
    
    console.log('Submitting class data:', classData);

    supabaseClient
        .from('school_classes')
        .insert([classData])
        .select()
        .single()
        .then(async ({ data: newClass, error }) => {
            if (error) throw error;

            const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { error: updateError } = await supabaseClient
                .from('school_classes')
                .update({ invite_code: inviteCode })
                .eq('id', newClass.id);

            if (updateError) throw updateError;

            closeModal();
            showNotification('Class created successfully!');
            updateClassesPanel();
            showInviteCode(inviteCode);
        })
        .catch(error => {
            console.error('Class creation error:', error);
            showNotification('Failed to create class: ' + error.message, 'error');
        });
}

function showInviteCode(code) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Class Created!</h2>
            <p>Share this code with your students to join the class:</p>
            <div class="invite-code">
                <span>${code}</span>
                <button onclick="copyToClipboard('${code}')" class="action-button">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <p class="invite-info">This code can be accessed later from the class settings</p>
            <button onclick="closeModal()" class="action-button">Close</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
        .then(() => showNotification('Code copied to clipboard!'))
        .catch(err => console.error('Error copying code:', err));
}

async function startEvent(eventId) {
    try {
        const { error } = await supabaseClient
            .from('arcade_events')
            .update({ 
                status: 'active',
                started_at: new Date().toISOString()
            })
            .eq('id', eventId);

        if (error) throw error;

        showNotification('Event started successfully!');
        loadTeacherEvents();
    } catch (error) {
        console.error('Error starting event:', error);
        showNotification('Error starting event', 'error');
    }
}

async function endEvent(eventId) {
    try {
        const { error } = await supabaseClient
            .from('arcade_events')
            .update({ 
                status: 'completed',
                completed_at: new Date().toISOString()
            })
            .eq('id', eventId);

        if (error) throw error;

        showNotification('Event ended successfully!');
        loadTeacherEvents();
    } catch (error) {
        console.error('Error ending event:', error);
        showNotification('Error ending event', 'error');
    }
}

function showEventDetails(eventId) {
    supabaseClient
        .from('arcade_events')
        .select(`
            *,
            arcade_participants (
                player_id,
                words_completed,
                score,
                position,
                user_profiles:player_id (
                    username,
                    status
                )
            )
        `)
        .eq('id', eventId)
        .single()
        .then(({ data: event, error }) => {
            if (error) {
                console.error('Error loading event details:', error);
                showNotification('Error loading event details', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2>${event.name}</h2>
                    <div class="event-info">
                        <p>Status: <span class="status-badge ${event.status}">${event.status}</span></p>
                        <p>Type: ${event.type}</p>
                        <p>Access Code: ${event.access_code || 'Not set'}</p>
                        <p>Grade Levels: ${event.grade_levels.join(', ')}</p>
                        <p>Created: ${new Date(event.created_at).toLocaleString()}</p>
                        ${event.started_at ? `<p>Started: ${new Date(event.started_at).toLocaleString()}</p>` : ''}
                    </div>
                    <div class="participants-list">
                        <h3>Participants (${event.arcade_participants?.length || 0})</h3>
                        ${event.arcade_participants?.length > 0 ? `
                            <div class="participants-grid">
                                ${event.arcade_participants.map(participant => `
                                    <div class="participant-card">
                                        <h4>${participant.user_profiles.username}</h4>
                                        <p>Words: ${participant.words_completed}</p>
                                        <p>Score: ${participant.score}</p>
                                        <p>Position: ${participant.position}</p>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p>No participants yet</p>'}
                    </div>
                    <div class="modal-actions">
                        <button onclick="closeModal()" class="action-button">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        });
}

async function manageEvent(eventId) {
    try {
        console.log('Managing event:', eventId);
        
        const { data: event, error } = await supabaseClient
            .from('arcade_events')
            .select('*')
            .eq('id', eventId)
            .single();

        if (error) {
            console.error('Error fetching event:', error);
            throw error;
        }

        console.log('Event data:', event);

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content event-management">
                <div class="event-manage-header">
                    <h2>${event.name}</h2>
                    <span class="status-badge ${event.status}">${event.status}</span>
                </div>

                <div class="event-control-panel">
                    <div class="control-section">
                        <h3>Event Controls</h3>
                        ${event.status === 'pending' ? `
                            <button onclick="handleStartEvent('${event.id}')" class="action-button">
                                <i class="fas fa-play"></i> Start Event
                            </button>
                        ` : event.status === 'active' ? `
                            <button onclick="handleEndEvent('${event.id}')" class="action-button">
                                <i class="fas fa-stop"></i> End Event
                            </button>
                        ` : ''}
                    </div>

                    <div class="control-section">
                        <h3>Access Code</h3>
                        <div class="access-code-display">
                            ${event.access_code}
                            <button onclick="copyAccessCode('${event.access_code}')" class="action-button small">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button onclick="closeModal()" class="action-button cancel">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    } catch (error) {
        console.error('Error managing event:', error);
        showNotification('Error loading event details', 'error');
    }
}


function startEvent(eventId) {
    supabaseClient
        .from('arcade_events')
        .update({
            status: 'active',
            started_at: new Date().toISOString()
        })
        .eq('id', eventId)
        .then(({ error }) => {
            if (error) {
                showNotification('Error starting event', 'error');
                return;
            }
            showNotification('Event started successfully!');
            loadTeacherEvents();
            closeModal();
        });
}

function endEvent(eventId) {
    supabaseClient
        .from('arcade_events')
        .update({
            status: 'completed',
            completed_at: new Date().toISOString()
        })
        .eq('id', eventId)
        .then(({ error }) => {
            if (error) {
                showNotification('Error ending event', 'error');
                return;
            }
            showNotification('Event ended successfully!');
            loadTeacherEvents();
            closeModal();
        });
}

function removeParticipant(eventId, playerId) {
    if (!confirm('Remove this participant from the event?')) return;

    supabaseClient
        .from('arcade_participants')
        .delete()
        .match({ event_id: eventId, player_id: playerId })
        .then(({ error }) => {
            if (error) {
                showNotification('Error removing participant', 'error');
                return;
            }
            showNotification('Participant removed successfully');
            manageEvent(eventId); // Refresh the management view
        });
}

function copyAccessCode(code) {
    navigator.clipboard.writeText(code)
        .then(() => showNotification('Access code copied to clipboard!'))
        .catch(() => showNotification('Error copying access code', 'error'));
}

function displayEventManagement(event) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content event-management">
            <div class="event-manage-header">
                <h2>${event.name}</h2>
                <span class="status-badge ${event.status}">${event.status}</span>
            </div>

            <div class="event-control-panel">
                <div class="control-section">
                    <h3>Event Controls</h3>
                    ${event.status === 'pending' ? `
                        <button onclick="startEvent('${event.id}')" class="action-button">
                            <i class="fas fa-play"></i> Start Event
                        </button>
                    ` : event.status === 'active' ? `
                        <button onclick="endEvent('${event.id}')" class="action-button">
                            <i class="fas fa-stop"></i> End Event
                        </button>
                    ` : ''}
                </div>

                <div class="control-section">
                    <h3>Access Code</h3>
                    <div class="access-code-display">
                        ${event.access_code}
                        <button onclick="copyAccessCode('${event.access_code}')" class="action-button small">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button onclick="closeModal()" class="action-button cancel">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    setupEventRealtimeUpdates(event.id);
}

function joinEvent(accessCode) {
    supabaseClient
        .from('arcade_events')
        .select('*')
        .eq('access_code', accessCode)
        .eq('status', 'active')
        .single()
        .then(async ({ data: event, error }) => {
            if (error) {
                showNotification('Invalid or expired access code', 'error');
                return;
            }

            // Join as participant
            const participantData = {
                event_id: event.id,
                player_id: currentUser.id,
                status: 'waiting',
                words_completed: 0,
                current_floor: 0,
                score: 0
            };

            const { error: joinError } = await supabaseClient
                .from('arcade_participants')
                .insert([participantData]);

            if (joinError) {
                showNotification('Error joining event', 'error');
                return;
            }

            showNotification('Successfully joined event!');
            initializeArcadeMode(event.id);
        });
}

async function initializeArcadeMode(eventId) {
    const arcadeScreen = document.getElementById('arcade-screen');
    arcadeScreen.innerHTML = `
        <div class="player-stats">
            <div class="stat-card">
                <div>Words Completed</div>
                <div class="stat-value words-completed">0</div>
            </div>
            <div class="stat-card">
                <div>Score</div>
                <div class="stat-value current-score">0</div>
            </div>
        </div>
        <div class="race-container"></div>
    `;
    arcadeScreen.classList.add('visible');

    const arcadeManager = new ArcadeManager();
    try {
        await arcadeManager.initializeGame(eventId);
        window.currentGame = arcadeManager;
    } catch (error) {
        console.error('Error initializing arcade mode:', error);
        showNotification('Error joining game', 'error');
    }
}

function selectRole(role) {
    console.log('Selecting role:', role);
    currentRole = role;
    
    document.querySelectorAll('.screen').forEach(screen => 
        screen.classList.remove('visible'));
        
    if (role === 'teacher') {
        showLoginPrompt('teacher');
    } else {
        document.getElementById('student-join-screen').classList.add('visible');
    }
}

async function joinArcadeEvent() {
  const code = document.getElementById('access-code-input').value.trim().toUpperCase(); 
  
  try {
    const { data: event, error } = await supabaseClient
      .from('arcade_events')
      .select('*')
      .eq('access_code', code) 
      .eq('status', 'active')
      .single();

    if (error || !event) {
      showNotification('Invalid or expired access code', 'error');
      return;
    }

    console.log('Event data:', event);
      
    const { data: participant, error: joinError } = await supabaseClient
      .from('arcade_participants') 
      .insert({
        event_id: event.id,
        player_name: 'Guest_' + Math.random().toString(36).substring(2, 6),        
        status: 'waiting',
        words_completed: 0,
        score: 0
      })
      .select()
      .single();

    if (joinError) {
      console.error('Join error details:', joinError);
      throw joinError;
    }

    console.log('Participant data:', participant);

    showNotification('Successfully joined event!');
    initializeStudentGame(event.id);
  } catch (error) {
    console.error('Join error:', error);
    showNotification('Error joining event', 'error'); 
  }
}

async function handleGuestAuth() {
    const guestEmail = `guest_${Date.now()}@temp.com`;
    const guestPassword = 'Guest' + Math.random().toString(36).slice(2);
    
    console.log('Creating guest account');
    
    const { data, error } = await supabaseClient.auth.signUp({
        email: guestEmail,
        password: guestPassword,
        options: {
            data: {
                role: 'student'
            }
        }
    });

    if (data?.user) {
        currentUser = data.user;
        console.log('Guest auth successful:', currentUser.id);
    }

    return { error };
}

async function handleGuestJoin() {
    const code = document.getElementById('access-code-input').value;
    const guestEmail = `guest_${Date.now()}@temp.com`;
    const guestPassword = 'Guest' + Math.random().toString(36).slice(2);
    
    try {
        const { data, error } = await supabaseClient.auth.signUp({
            email: guestEmail,
            password: guestPassword
        });
        
        if (error) throw error;
        
        // Now we have a guest user, proceed with join
        return joinArcadeEvent(code);
    } catch (error) {
        console.error('Guest auth error:', error);
        showNotification('Error joining game', 'error');
    }
}

function loadTeacherEvents() {
    const eventsPanel = document.getElementById('events-panel');
    if (!eventsPanel) return;

    supabaseClient
        .from('arcade_events')
        .select('*')
        .eq('teacher_id', currentUser.id)
        .then(({ data: events, error }) => {
            if (error) {
                console.error('Error loading events:', error);
                return;
            }

            eventsPanel.innerHTML = `
                <div class="panel-header">
                    <h2>Events</h2>
                    <button onclick="createNewEvent()" class="action-button">
                        <i class="fas fa-plus"></i> Create Event
                    </button>
                </div>
                ${events && events.length > 0 ? `
                    <div class="events-grid">
                        ${events.map(event => `
                            <div class="event-card">
                                <div class="event-header">
                                    <h3>${event.name}</h3>
                                    <span class="status-badge ${event.status}">${event.status}</span>
                                </div>
                                <div class="event-details">
                                    ${event.status !== 'completed' ? 
                                        `<p>Access Code: ${event.access_code || 'Not set'}</p>` : ''}
                                </div>
                                <div class="event-actions">
                                    ${event.status === 'completed' ? `
                                        <button onclick="deleteEvent('${event.id}')" class="action-button danger">
                                            Delete
                                        </button>
                                    ` : `
                                        <button onclick="manageEvent('${event.id}')" class="action-button">
                                            Manage
                                        </button>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="empty-state">
                        <i class="fas fa-calendar-plus"></i>
                        <h3>No Events Yet</h3>
                        <p>Create your first event to get started!</p>
                        <button onclick="createNewEvent()" class="action-button">
                            Create Event
                        </button>
                    </div>
                `}
            `;
        });
}

function setupEventRealtimeUpdates(eventId) {
    const channel = supabaseClient
        .channel(`event:${eventId}`)
        .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'arcade_participants',
            filter: `event_id=eq.${eventId}`
        }, payload => {
            updateParticipantDisplay(payload.new);
        })
        .subscribe();

    // Store channel for cleanup
    window.currentEventChannel = channel;
}

function updateParticipantDisplay(participant) {
    const row = document.querySelector(`.participant-row[data-player-id="${participant.player_id}"]`);
    if (!row) return;

    // Update stats
    row.querySelector('.words-completed').textContent = participant.words_completed;
    row.querySelector('.score').textContent = participant.score;
    row.querySelector('.current-floor').textContent = participant.current_floor;
    row.querySelector('.status-badge').textContent = participant.status;
}

function calculateAverageScore(participants) {
    if (!participants?.length) return '0';
    const total = participants.reduce((sum, p) => sum + p.score, 0);
    return (total / participants.length).toFixed(1);
}

function closeModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => modal.remove());
}

function setupEventModal(modal) {
    const content = modal.querySelector('.modal-content');
    if (!content) return;

    const resizeObserver = new ResizeObserver(() => {
        content.style.maxHeight = `${window.innerHeight * 0.9}px`;
    });

    resizeObserver.observe(content);
}

async function handleTeacherLogin(e) {
    e.preventDefault();
    
    const form = e.target;
    const emailInput = form.querySelector('#teacher-email');
    const passwordInput = form.querySelector('#teacher-password');
    
    console.log('Form elements:', {
        formFound: !!form,
        emailInput: !!emailInput,
        passwordInput: !!passwordInput,
        emailValue: emailInput?.value,
        passwordLength: passwordInput?.value?.length
    });

    const email = emailInput?.value?.trim();
    const password = passwordInput?.value;

    if (!email || !password) {
        console.log('Missing credentials:', { email: !!email, password: !!password });
        showNotification('Please enter email and password', 'error');
        return;
    }

    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
        });

        console.log('Auth response:', { hasData: !!data, error });

        if (error) throw error;

        if (data.user) {
            currentUser = data.user;
            await validateTeacherRole(currentUser.id);
            closeModal();
            showTeacherDashboard();
        }
    } catch (error) {
        console.error('Login error:', error);
        showNotification(error.message, 'error');
    }
}

async function validateTeacherRole(userId) {
    const { data: profile, error } = await supabaseClient
        .from('user_profiles')
        .select('role')
        .eq('id', userId)
        .single();
        
    if (error || profile?.role !== 'teacher') {
        throw new Error('Access denied: Teacher role required');
    }
    return profile;
}


async function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event?')) return;

    try {
        const { error } = await supabaseClient
            .from('arcade_events')
            .delete()
            .eq('id', eventId);

        if (error) throw error;

        showNotification('Event deleted successfully');
        loadTeacherEvents();
    } catch (error) {
        console.error('Error deleting event:', error);
        showNotification('Error deleting event', 'error');
    }
}

class RaceTrack {
    constructor() {
        this.players = new Map();
        this.totalWords = 200;
        this.floors = 4;
        this.initialized = false;
    }

    initialize() {
        if (this.initialized) return;
        const raceContainer = document.querySelector('.race-container');
        if (!raceContainer) return;
        raceContainer.innerHTML = '';

        for (let i = 0; i < this.floors; i++) {
            const floor = document.createElement('div');
            floor.className = 'track-level';
            floor.setAttribute('data-floor', i);
            
            const wordCount = document.createElement('div');
            wordCount.className = 'word-count';
            wordCount.textContent = (this.floors - i - 1) * 50;
            
            const trackPath = document.createElement('div');
            trackPath.className = 'track-path';
            trackPath.style.transform = i % 2 === 0 ? 'none' : 'scaleX(-1)';
            
            const flag = document.createElement('div');
            flag.className = 'flag';
            flag.textContent = '🚩';
            flag.style.right = i % 2 === 0 ? '0' : 'auto';
            flag.style.left = i % 2 === 0 ? 'auto' : '0';
            
            floor.appendChild(wordCount);
            floor.appendChild(trackPath);
            floor.appendChild(flag);
            raceContainer.appendChild(floor);
        }
        this.initialized = true;
    }

    addPlayer(id, name, color) {
        const playerMarker = document.createElement('div');
        playerMarker.className = 'player-marker';
        playerMarker.innerHTML = `
            <div class="player-avatar" style="background-color: ${color}">
                ${name[0].toUpperCase()}
            </div>
            <div class="player-name">${name}</div>
        `;
        
        this.players.set(id, {
            element: playerMarker,
            position: 0,
            name: name,
            color: color,
            score: 0,
            wordsCompleted: 0,
            startTime: Date.now()
        });
        
        const startingFloor = document.querySelector('.track-level[data-floor="3"]');
        if (startingFloor) startingFloor.appendChild(playerMarker);
    }

    updatePlayerPosition(playerId, wordCount) {
        const player = this.players.get(playerId);
        if (!player) return;

        const floor = Math.floor(wordCount / 50);
        const progressOnFloor = (wordCount % 50) / 50;
        const floorElement = document.querySelector(`.track-level[data-floor="${3 - floor}"]`);
        
        if (!floorElement) return;

        const isRightToLeft = floor % 2 !== 0;
        const xPos = isRightToLeft ? 100 - (progressOnFloor * 100) : progressOnFloor * 100;

        player.element.style.transition = 'all 0.5s ease-out';
        player.element.style.left = `${xPos}%`;
        
        if (floorElement !== player.element.parentElement) {
            player.element.remove();
            floorElement.appendChild(player.element);
            this.celebrateFloorCompletion(player);
        }

        player.wordsCompleted = wordCount;
        player.position = xPos;
        this.updatePlayerStats(playerId);
    }

    celebrateFloorCompletion(player) {
        const celebration = document.createElement('div');
        celebration.className = 'flag-celebration';
        celebration.innerHTML = '🎉';
        player.element.appendChild(celebration);

        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'celebration-particle';
            particle.style.setProperty('--angle', `${(i / 10) * Math.PI}rad`);
            particle.style.setProperty('--velocity', `${2 + Math.random() * 2}`);
            celebration.appendChild(particle);
        }

        setTimeout(() => celebration.remove(), 2000);
    }

    updatePlayerStats(playerId) {
        const player = this.players.get(playerId);
        if (!player) return;

        const timeElapsed = (Date.now() - player.startTime) / 1000;
        const speedBonus = Math.max(0, 100 - timeElapsed);
        player.score = (player.wordsCompleted * 10) + speedBonus;

        supabaseClient
            .from('arcade_participants')
            .update({
                words_completed: player.wordsCompleted,
                score: player.score,
                current_floor: Math.floor(player.wordsCompleted / 50)
            })
            .eq('player_id', playerId)
            .then(({ error }) => {
                if (error) console.error('Error updating player stats:', error);
            });
    }

    cleanup() {
        this.players.clear();
        const raceContainer = document.querySelector('.race-container');
        if (raceContainer) raceContainer.innerHTML = '';
        this.initialized = false;
    }
}

class GameStateManager {
    constructor(eventId) {
        this.eventId = eventId;
        this.wordPool = new WordPoolManager();
        this.raceTrack = new RaceTrack();
        this.currentWord = null;
        this.subscription = null;
    }

    async initialize() {
        try {
            const { data: event } = await supabaseClient
                .from('arcade_events')
                .select('*')
                .eq('id', this.eventId)
                .single();

            await this.wordPool.loadWordPool(event.grade_levels);
            this.raceTrack.initialize();
            this.setupRealtimeSync();
            await this.loadExistingPlayers();
            this.presentNextWord();
        } catch (error) {
            console.error('Error initializing game:', error);
        }
    }

    async loadExistingPlayers() {
        const { data: participants } = await supabaseClient
            .from('arcade_participants')
            .select(`
                *,
                user_profiles:player_id (username)
            `)
            .eq('event_id', this.eventId);

        participants?.forEach(p => {
            const colors = ['#e94561', '#4CAF50', '#3498db', '#f1c40f'];
            this.raceTrack.addPlayer(
                p.player_id,
                p.user_profiles.username,
                colors[Math.floor(Math.random() * colors.length)]
            );

            if (p.words_completed > 0) {
                this.raceTrack.updatePlayerPosition(p.player_id, p.words_completed);
            }
        });
    }

    setupRealtimeSync() {
        this.subscription = supabaseClient
            .channel(`game:${this.eventId}`)
            .on('broadcast', { event: 'player_update' }, payload => {
                this.raceTrack.updatePlayerPosition(
                    payload.player_id,
                    payload.words_completed
                );
            })
            .subscribe();
    }

    presentNextWord() {
        this.currentWord = this.wordPool.getNextWord();
        const options = this.wordPool.getRandomOptions(3, this.currentWord.translation);
        options.push(this.currentWord.translation);
        
        // Shuffle options
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }

        const wordDisplay = document.createElement('div');
        wordDisplay.className = 'word-display';
        wordDisplay.innerHTML = `
            <div class="word">${this.currentWord.word}</div>
            <div class="options">
                ${options.map(opt => `
                    <button onclick="gameState.checkAnswer('${opt}')">${opt}</button>
                `).join('')}
            </div>
        `;

        document.querySelector('.arcade-screen').appendChild(wordDisplay);
    }

    async checkAnswer(answer) {
        const isCorrect = answer === this.currentWord.translation;
        if (isCorrect) {
            const player = Array.from(this.raceTrack.players.values())
                .find(p => p.id === currentUser.id);
            
            if (player) {
                player.wordsCompleted++;
                await supabaseClient
                    .from('arcade_participants')
                    .update({
                        words_completed: player.wordsCompleted,
                        current_floor: Math.floor(player.wordsCompleted / 50)
                    })
                    .eq('event_id', this.eventId)
                    .eq('player_id', currentUser.id);

                this.raceTrack.updatePlayerPosition(
                    currentUser.id,
                    player.wordsCompleted
                );
            }
        }

        document.querySelector('.word-display')?.remove();
        this.presentNextWord();
    }

    cleanup() {
        this.subscription?.unsubscribe();
        this.raceTrack.cleanup();
        document.querySelector('.word-display')?.remove();
    }
}

class ArcadeGameManager {
  constructor() {
    this.raceTrack = new RaceTrack();
    this.wordPool = new WordPoolManager();
    this.eventId = null;
    this.currentWord = null;
    this.subscription = null;
  }
  
  async initialize(eventId) {
    this.eventId = eventId;
    this.raceTrack.initialize();

    // Get event details 
    const { data: event } = await supabaseClient
      .from('arcade_events')
      .select('*')
      .eq('id', eventId)
      .single();

    // Initialize word pool  
    await this.wordPool.initialize(event.grade_levels);

    // Subscribe to real-time updates
    this.subscription = supabaseClient
      .channel(`game:${eventId}`)
      .on('broadcast', { event: 'player_move' }, payload => {
        this.handlePlayerMove(payload);  
      })
      .on('broadcast', { event: 'player_join' }, payload => {
        this.handlePlayerJoin(payload);
      })
      .subscribe();

    // Load existing players  
    await this.loadPlayers();
  }

  async loadPlayers() {
    const { data: participants } = await supabaseClient
      .from('arcade_participants')
      .select(`
        *,
        user_profiles:player_id (username)  
      `)
      .eq('event_id', this.eventId);

    const colors = [
      '#e94561', '#4CAF50', '#3498db', '#f1c40f', 
      '#9b59b6', '#e67e22', '#1abc9c', '#e74c3c'
    ];

    participants.forEach((participant, index) => {
      this.raceTrack.addPlayer(
        participant.player_id,
        participant.player_name,
        colors[index % colors.length]    
      );
      
      // Update position if they have progress
      if (participant.words_completed > 0) {
        this.raceTrack.updatePlayerPosition(
          participant.player_id,
          participant.words_completed  
        );
      }
    });
  }
  
  handlePlayerMove(payload) {
    const { playerId, wordCount } = payload;
    this.raceTrack.updatePlayerPosition(playerId, wordCount);
  }

  handlePlayerJoin(payload) {
    const { playerId, username } = payload;
    const colors = ['#e94561', '#4CAF50', '#3498db', '#f1c40f'];
    const colorIndex = this.raceTrack.players.size % colors.length;
    this.raceTrack.addPlayer(playerId, username, colors[colorIndex]);
  }

  cleanup() {
    if (this.subscription) {
      this.subscription.unsubscribe();
    }
    this.raceTrack.cleanup(); 
    this.wordPool.reset();
    this.eventId = null;
    this.currentWord = null;
  }
}

class ArcadeGame {
    constructor() {
        this.raceTrack = new RaceTrack();
        this.eventId = null;
        this.subscription = null;
        this.wordPool = [];
        this.currentWord = null;
        this.gameState = 'waiting'; // waiting, playing, finished
        this.startTime = null;
    }

    async initialize(eventId) {
        this.eventId = eventId;
        this.raceTrack.initialize();
        
        // Set up real-time subscriptions
        this.subscription = supabaseClient
            .channel(`game:${eventId}`)
            .on('broadcast', { event: 'player_move' }, payload => {
                this.handlePlayerMove(payload);
            })
            .on('broadcast', { event: 'player_join' }, payload => {
                this.handlePlayerJoin(payload);
            })
            .on('broadcast', { event: 'game_state' }, payload => {
                this.handleGameStateChange(payload);
            })
            .on('broadcast', { event: 'perk_used' }, payload => {
                this.handlePerkEffect(payload);
            })
            .subscribe();

        await this.loadWordPool();
        await this.loadPlayers();
        
        // Join as participant if not teacher
        if (!this.isTeacher()) {
            await this.joinGame();
        }
    }

    async loadWordPool() {
        try {
            const { data: event } = await supabaseClient
                .from('arcade_events')
                .select('grade_levels')
                .eq('id', this.eventId)
                .single();

            const { data: wordlists } = await supabaseClient
                .from('teacher_wordlists')
                .select('words, translations')
                .in('grade_level', event.grade_levels);

            this.wordPool = wordlists.reduce((pool, list) => {
                const words = list.words.map((word, i) => ({
                    word,
                    translation: list.translations[i]
                }));
                return [...pool, ...words];
            }, []);

            this.shuffleWordPool();
        } catch (error) {
            console.error('Error loading word pool:', error);
            throw error;
        }
    }

    shuffleWordPool() {
        for (let i = this.wordPool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.wordPool[i], this.wordPool[j]] = [this.wordPool[j], this.wordPool[i]];
        }
    }

    async loadPlayers() {
        const { data: participants } = await supabaseClient
            .from('arcade_participants')
            .select(`
                *,
                user_profiles:player_id (username)
            `)
            .eq('event_id', this.eventId);

        const colors = [
            '#e94561', '#4CAF50', '#3498db', '#f1c40f',
            '#9b59b6', '#e67e22', '#1abc9c', '#e74c3c'
        ];

        participants.forEach((participant, index) => {
            this.raceTrack.addPlayer(
                participant.player_id,
                participant.user_profiles.username,
                colors[index % colors.length]
            );

            if (participant.words_completed > 0) {
                this.raceTrack.updatePlayerPosition(
                    participant.player_id,
                    participant.words_completed
                );
            }
        });
    }

    async joinGame() {
        try {
            const { data: participant, error } = await supabaseClient
                .from('arcade_participants')
                .insert([{
                    event_id: this.eventId,
                    player_id: currentUser.id,
                    words_completed: 0,
                    score: 0,
                    status: 'waiting'
                }])
                .select()
                .single();

            if (error) throw error;

            this.playerId = participant.player_id;
            this.startTime = Date.now();

        } catch (error) {
            console.error('Error joining game:', error);
            throw error;
        }
    }

    getNextWord() {
        if (this.wordPool.length === 0) return null;
        this.currentWord = this.wordPool.shift();
        return this.currentWord;
    }

    handlePlayerMove(payload) {
        const { playerId, wordCount } = payload;
        this.raceTrack.updatePlayerPosition(playerId, wordCount);
    }

    handlePlayerJoin(payload) {
        const { playerId, username } = payload;
        const colorIndex = this.raceTrack.players.size % 8;
        const colors = [
            '#e94561', '#4CAF50', '#3498db', '#f1c40f',
            '#9b59b6', '#e67e22', '#1abc9c', '#e74c3c'
        ];
        this.raceTrack.addPlayer(playerId, username, colors[colorIndex]);
    }

    handleGameStateChange(payload) {
        this.gameState = payload.state;
        if (payload.state === 'playing' && !this.startTime) {
            this.startTime = Date.now();
        }
    }

    handlePerkEffect(payload) {
        const { type, targetId, duration } = payload;
        if (targetId === this.playerId) {
            this.applyPerkEffect(type, duration);
        }
    }

    applyPerkEffect(type, duration) {
        switch(type) {
            case 'freeze':
                this.freezePlayer(duration);
                break;
            case 'scramble':
                this.scrambleWords(duration);
                break;
            case 'speedup':
                this.speedUpTimer(duration);
                break;
        }
    }

    cleanup() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
        this.raceTrack.cleanup();
        this.wordPool = [];
        this.currentWord = null;
        this.gameState = 'waiting';
        this.startTime = null;
    }

    isTeacher() {
        return currentUser?.role === 'teacher';
    }
}

class PerkManager {
    constructor(game) {
        this.game = game;
        this.activePerks = new Map();
        this.availablePerks = [
            { type: 'freeze', cost: 50, duration: 5000 },
            { type: 'scramble', cost: 30, duration: 10000 },
            { type: 'speedup', cost: 40, duration: 8000 }
        ];
    }

    canUsePerk(type) {
        const perk = this.availablePerks.find(p => p.type === type);
        return perk && this.game.getPlayerCoins() >= perk.cost;
    }

    async usePerk(type) {
        if (!this.canUsePerk(type)) return false;

        const perk = this.availablePerks.find(p => p.type === type);
        
        try {
            // Get random target excluding self
            const { data: participants } = await supabaseClient
                .from('arcade_participants')
                .select('player_id')
                .eq('event_id', this.game.eventId)
                .neq('player_id', this.game.playerId);

            if (!participants || participants.length === 0) return false;

            const randomTarget = participants[Math.floor(Math.random() * participants.length)];

            // Broadcast perk effect
            await supabaseClient
                .channel(`game:${this.game.eventId}`)
                .send({
                    type: 'broadcast',
                    event: 'perk_used',
                    payload: {
                        type,
                        targetId: randomTarget.player_id,
                        duration: perk.duration
                    }
                });

            // Deduct coins
            await this.game.deductCoins(perk.cost);
            return true;

        } catch (error) {
            console.error('Error using perk:', error);
            return false;
        }
    }

    applyPerkEffect(type, duration) {
        const existingPerk = this.activePerks.get(type);
        if (existingPerk) {
            clearTimeout(existingPerk.timeout);
        }

        const timeout = setTimeout(() => {
            this.removePerkEffect(type);
        }, duration);

        this.activePerks.set(type, {
            timeout,
            startTime: Date.now()
        });

        this.showPerkAnimation(type);
    }

    removePerkEffect(type) {
        const perk = this.activePerks.get(type);
        if (perk) {
            clearTimeout(perk.timeout);
            this.activePerks.delete(type);
        }
    }

    showPerkAnimation(type) {
        const container = document.createElement('div');
        container.className = 'perk-effect';
        container.innerHTML = `
            <div class="perk-icon">${this.getPerkIcon(type)}</div>
            <div class="perk-name">${type}</div>
        `;
        document.body.appendChild(container);

        setTimeout(() => container.remove(), 2000);
    }

    getPerkIcon(type) {
        const icons = {
            freeze: '❄️',
            scramble: '🔄',
            speedup: '⚡'
        };
        return icons[type] || '🎮';
    }

    cleanup() {
        this.activePerks.forEach((perk, type) => {
            clearTimeout(perk.timeout);
        });
        this.activePerks.clear();
    }
}


class ArcadeManager {
    constructor() {
        this.gameState = null;
        this.wordPool = null;
        this.subscription = null;
        this.playerStats = {
            wordsCompleted: 0,
            currentFloor: 0,
            score: 0
        };
    }

    async joinEvent(accessCode) {
        try {
            const { data: event } = await supabaseClient
                .from('arcade_events')
                .select('*')
                .eq('access_code', accessCode)
                .eq('status', 'active')
                .single();

            if (!event) throw new Error('Invalid or expired access code');

            await supabaseClient
                .from('arcade_participants')
                .insert([{
                    event_id: event.id,
                    player_id: currentUser.id,
                    words_completed: 0,
                    current_floor: 0,
                    score: 0,
                    status: 'waiting'
                }]);

            this.initializeGame(event.id);
            return event;
        } catch (error) {
            console.error('Error joining event:', error);
            throw error;
        }
    }

    async initializeGame(eventId) {
        this.gameState = new GameStateManager(eventId);
        await this.gameState.initialize();
        this.setupRealtimeSync(eventId);
    }

    setupRealtimeSync(eventId) {
        this.subscription = supabaseClient
            .channel(`arcade:${eventId}`)
            .on('presence', { event: 'sync' }, () => {
                this.syncGameState();
            })
            .on('broadcast', { event: 'word_completed' }, payload => {
                this.handleWordCompletion(payload);
            })
            .on('broadcast', { event: 'perk_used' }, payload => {
                this.handlePerkEffect(payload);
            })
            .subscribe();
    }

    async syncGameState() {
        const { data: participants } = await supabaseClient
            .from('arcade_participants')
            .select('*')
            .eq('event_id', this.gameState.eventId);

        participants.forEach(p => {
            this.gameState.raceTrack.updatePlayerPosition(
                p.player_id,
                p.words_completed
            );
        });
    }

    handleWordCompletion(payload) {
        const { playerId, wordsCompleted, score } = payload;
        this.gameState.raceTrack.updatePlayerPosition(playerId, wordsCompleted);
        
        if (playerId === currentUser.id) {
            this.playerStats = {
                wordsCompleted,
                currentFloor: Math.floor(wordsCompleted / 50),
                score
            };
            this.updateStatsDisplay();
        }
    }

    updateStatsDisplay() {
        document.querySelector('.words-completed').textContent = 
            this.playerStats.wordsCompleted;
        document.querySelector('.current-score').textContent = 
            this.playerStats.score;
    }

    async handlePerkEffect(payload) {
        const { type, duration, targetId } = payload;
        if (targetId === currentUser.id) {
            switch (type) {
                case 'freeze':
                    await this.applyFreeze(duration);
                    break;
                case 'scramble':
                    this.applyScramble(duration);
                    break;
                case 'speed':
                    this.applySpeedUp(duration);
                    break;
            }
        }
    }

    cleanup() {
        this.subscription?.unsubscribe();
        this.gameState?.cleanup();
        this.wordPool = null;
        this.playerStats = {
            wordsCompleted: 0,
            currentFloor: 0,
            score: 0
        };
    }
}

class PerkSystem {
   constructor(gameManager) {
       this.gameManager = gameManager;
       this.perks = {
           freeze: {
               cost: 50,
               duration: 5000,
               icon: '❄️'
           },
           scramble: {
               cost: 30, 
               duration: 10000,
               icon: '🔄'
           },
           speed: {
               cost: 40,
               duration: 8000,
               icon: '⚡'
           }
       };
       this.activePerks = new Map();
   }

   canUsePerk(type) {
       const perk = this.perks[type];
       return perk && this.gameManager.playerStats.score >= perk.cost;
   }

   async usePerk(type) {
       if (!this.canUsePerk(type)) return;

       const perk = this.perks[type];
       try {
           // Get random target excluding self
           const { data: participants } = await supabaseClient
               .from('arcade_participants')
               .select('player_id')
               .eq('event_id', this.gameManager.gameState.eventId)
               .neq('player_id', currentUser.id);

           if (!participants?.length) return;

           const target = participants[Math.floor(Math.random() * participants.length)];
           
           await supabaseClient.channel(`arcade:${this.gameManager.gameState.eventId}`)
               .send({
                   type: 'broadcast',
                   event: 'perk_used',
                   payload: {
                       type,
                       targetId: target.player_id,
                       duration: perk.duration,
                       casterId: currentUser.id
                   }
               });

           // Deduct cost
           this.gameManager.playerStats.score -= perk.cost;
           this.gameManager.updateStatsDisplay();

           this.showPerkAnimation(type, target.player_id);
           
       } catch (error) {
           console.error('Error using perk:', error);
       }
   }

   showPerkAnimation(type, targetId) {
       const targetMarker = document.querySelector(`[data-player-id="${targetId}"]`);
       if (!targetMarker) return;

       const perk = this.perks[type];
       const animation = document.createElement('div');
       animation.className = 'perk-animation';
       animation.innerHTML = `
           <div class="perk-icon">${perk.icon}</div>
           <div class="perk-name">${type}</div>
       `;

       targetMarker.appendChild(animation);
       setTimeout(() => animation.remove(), 2000);
   }

   applyPerkEffect(type, duration) {
       const existingEffect = this.activePerks.get(type);
       if (existingEffect) {
           clearTimeout(existingEffect.timeout);
       }

       const effect = {
           type,
           startTime: Date.now(),
           timeout: setTimeout(() => this.removePerkEffect(type), duration)
       };

       this.activePerks.set(type, effect);
       document.body.classList.add(`perk-effect-${type}`);
   }

   removePerkEffect(type) {
       const effect = this.activePerks.get(type);
       if (effect) {
           clearTimeout(effect.timeout);
           this.activePerks.delete(type);
           document.body.classList.remove(`perk-effect-${type}`);
       }
   }
}

class WordPoolManager {
    constructor(gradeLevels) {
        this.gradeLevels = gradeLevels;
        this.pool = [];
        this.usedWords = new Set();
    }

    async initialize() {
        const { data: lists } = await supabaseClient
            .from('teacher_wordlists')
            .select('words, translations')
            .in('grade_level', this.gradeLevels);

        this.pool = lists.reduce((acc, list) => {
            const words = list.words.map((word, i) => ({
                word,
                translation: list.translations[i]
            }));
            return [...acc, ...words];
        }, []);

        this.shufflePool();
    }

    shufflePool() {
        for (let i = this.pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.pool[i], this.pool[j]] = [this.pool[j], this.pool[i]];
        }
    }

    getNextWord() {
        if (this.usedWords.size >= this.pool.length * 0.8) {
            this.usedWords.clear();
            this.shufflePool();
        }

        let word;
        do {
            word = this.pool[Math.floor(Math.random() * this.pool.length)];
        } while (this.usedWords.has(word.word));

        this.usedWords.add(word.word);
        return word;
    }

    getOptions(correct, count = 3) {
        const options = new Set([correct]);
        while (options.size < count + 1) {
            const word = this.pool[Math.floor(Math.random() * this.pool.length)];
            options.add(word.translation);
        }
        return Array.from(options);
    }
}

class WordPresenter {
   constructor(gameManager) {
       this.gameManager = gameManager;
       this.container = null;
       this.currentWord = null;
       this.answerTimeout = null;
       this.setupUI();
   }

   setupUI() {
       this.container = document.createElement('div');
       this.container.className = 'word-presenter';
       this.container.innerHTML = `
           <div class="word-container">
               <div class="word"></div>
               <div class="options"></div>
           </div>
           <div class="timer-bar">
               <div class="timer-progress"></div>
           </div>
       `;
       document.querySelector('.arcade-screen').appendChild(this.container);
   }

   presentWord(word, options) {
       this.currentWord = word;
       this.container.querySelector('.word').textContent = word.word;
       
       const optionsContainer = this.container.querySelector('.options');
       optionsContainer.innerHTML = options.map(option => `
           <button class="option-button" onclick="handleAnswer('${option}')">
               ${option}
           </button>
       `).join('');

       this.startTimer();
   }

   startTimer() {
       const progress = this.container.querySelector('.timer-progress');
       progress.style.width = '100%';
       
       requestAnimationFrame(() => {
           progress.style.width = '0%';
           progress.style.transition = 'width 7s linear';
       });

       this.answerTimeout = setTimeout(() => {
           this.handleAnswer(null);
       }, 7000);
   }

   handleAnswer(answer) {
       clearTimeout(this.answerTimeout);
       
       const isCorrect = answer === this.currentWord.translation;
       const timeLeft = parseFloat(
           getComputedStyle(this.container.querySelector('.timer-progress')).width
       ) / this.container.querySelector('.timer-bar').offsetWidth;

       const points = this.calculatePoints(isCorrect, timeLeft);
       this.showFeedback(isCorrect, points);
       
       setTimeout(() => {
           this.gameManager.handleWordComplete(isCorrect, points);
       }, 1000);
   }

   calculatePoints(isCorrect, timeLeft) {
       if (!isCorrect) return 0;
       const basePoints = 10;
       const timeBonus = Math.floor(timeLeft * 10);
       return basePoints + timeBonus;
   }

   showFeedback(isCorrect, points) {
       const feedback = document.createElement('div');
       feedback.className = `answer-feedback ${isCorrect ? 'correct' : 'incorrect'}`;
       feedback.innerHTML = `
           <div class="feedback-text">${isCorrect ? 'Correct!' : 'Try Again!'}</div>
           ${isCorrect ? `<div class="points-earned">+${points}</div>` : ''}
       `;
       
       this.container.appendChild(feedback);
       setTimeout(() => feedback.remove(), 1000);
   }

   cleanup() {
       clearTimeout(this.answerTimeout);
       this.container.remove();
   }
}

class GameSynchronizer {
    constructor(gameManager) {
        this.gameManager = gameManager;
        this.subscription = null;
        this.lastSync = Date.now();
        this.syncInterval = 1000;
    }

    initialize(eventId) {
        this.subscription = supabaseClient
            .channel(`game:${eventId}`)
            .on('presence', { event: 'sync' }, () => {
                this.syncGameState();
            })
            .on('broadcast', { event: 'state_update' }, payload => {
                this.handleStateUpdate(payload);
            })
            .subscribe();

        setInterval(() => this.checkSync(), this.syncInterval);
    }

    async syncGameState() {
        if (Date.now() - this.lastSync < this.syncInterval) return;

        const { data: participants } = await supabaseClient
            .from('arcade_participants')
            .select('*')
            .eq('event_id', this.gameManager.eventId);

        participants.forEach(p => {
            this.gameManager.updatePlayerState(p);
        });

        this.lastSync = Date.now();
    }

    handleStateUpdate(payload) {
        const { playerId, state } = payload;
        this.gameManager.updatePlayerState({
            player_id: playerId,
            ...state
        });
    }

    broadcastUpdate(state) {
        this.subscription.send({
            type: 'broadcast',
            event: 'state_update',
            payload: {
                playerId: currentUser.id,
                state
            }
        });
    }

    cleanup() {
        this.subscription?.unsubscribe();
        clearInterval(this.syncInterval);
    }
}

class AchievementSystem {
    constructor() {
        this.milestones = [50, 100, 150, 200];
        this.achievements = new Map();
    }

    checkProgress(wordCount) {
        const milestone = this.milestones.find(m => wordCount === m);
        if (milestone && !this.achievements.has(milestone)) {
            this.achievements.set(milestone, Date.now());
            this.celebrateMilestone(milestone);
        }
    }

    celebrateMilestone(count) {
        const celebration = document.createElement('div');
        celebration.className = 'milestone-celebration';
        celebration.innerHTML = `
            <div class="milestone-icon">🏆</div>
            <div class="milestone-text">${count} Words!</div>
            <div class="confetti-container"></div>
        `;

        document.body.appendChild(celebration);
        this.createConfetti(celebration.querySelector('.confetti-container'));
        setTimeout(() => celebration.remove(), 3000);
    }

    createConfetti(container) {
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.setProperty('--delay', `${Math.random() * 3}s`);
            confetti.style.setProperty('--rotation', `${Math.random() * 360}deg`);
            confetti.style.setProperty('--x', `${Math.random() * 100}%`);
            container.appendChild(confetti);
        }
    }
}

function logEventDetails(eventId) {
    supabaseClient
        .from('arcade_events')
        .select('*')
        .eq('id', eventId)
        .single()
        .then(({ data, error }) => {
            if (error) {
                console.error('Error fetching event details:', error);
                return;
            }
            console.log('Event details:', data);
        });
}

async function handleEndEvent(eventId) {
    try {
        console.log('Ending event:', eventId);
        
        const { data, error } = await supabaseClient
            .from('arcade_events')
            .update({ status: 'completed' })
            .match({ id: eventId })
            .select();

        if (error) {
            console.error('Error updating event:', error);
            throw error;
        }

        console.log('Event ended:', data);
        showNotification('Event ended successfully!');
        closeModal();
        loadTeacherEvents();
    } catch (error) {
        console.error('Error ending event:', error);
        showNotification('Error ending event', 'error');
    }
}


async function handleStartEvent(eventId) {
    try {
        console.log('Starting event:', eventId);
        
        const { data, error } = await supabaseClient
            .from('arcade_events')
            .update({ status: 'active' })
            .match({ id: eventId })
            .select();

        if (error) {
            console.error('Error updating event:', error);
            throw error;
        }

        console.log('Event started:', data);
        showNotification('Event started successfully!');
        closeModal();
        loadTeacherEvents();
    } catch (error) {
        console.error('Error starting event:', error);
        showNotification('Error starting event', 'error');
    }
}

async function handleStudentJoin() {
    const code = document.getElementById('access-code-input').value.trim().toUpperCase();
    
    try {
        const { data: event, error } = await supabaseClient
            .from('arcade_events')
            .select('*')
            .eq('access_code', code)
            .eq('status', 'active')
            .single();

        if (error || !event) {
            showNotification('Invalid or expired access code', 'error');
            return;
        }

        const { error: joinError } = await supabaseClient
            .from('arcade_participants')
            .insert([{
                event_id: event.id,
                player_id: currentUser.id,
                words_completed: 0,
                current_floor: 0,
                score: 0,
                status: 'waiting'
            }]);

        if (joinError) throw joinError;

        showNotification('Successfully joined event!');
        initializeStudentGame(event.id);
    } catch (error) {
        console.error('Join error:', error);
        showNotification('Error joining event', 'error');
    }
}

function initializeStudentGame(eventId) {
  const arcadeScreen = document.getElementById('arcade-screen');
  document.getElementById('student-join-screen').classList.remove('visible');
  arcadeScreen.classList.add('visible');

  arcadeScreen.innerHTML = `
    <div class="game-header">
      <div class="player-stats">
        <div class="stat-card">
          <div>Words Completed</div>
          <div class="stat-value words-completed">0</div>
        </div>
        <div class="stat-card">
          <div>Score</div>
          <div class="stat-value current-score">0</div>  
        </div>
      </div>  
    </div>
    <div class="race-container"></div>
    <div class="word-display"></div>
  `;

  const gameManager = new ArcadeGameManager();
  gameManager.initialize(eventId);
}

function setupPerks(container) {
    const perks = [
        { type: 'freeze', icon: '❄️', cost: 50 },
        { type: 'scramble', icon: '🔄', cost: 30 },
        { type: 'speed', icon: '⚡', cost: 40 }
    ];

    container.innerHTML = perks.map(perk => `
        <button class="perk-button" data-type="${perk.type}" 
                onclick="usePerk('${perk.type}')">
            <div class="perk-icon">${perk.icon}</div>
            <div class="perk-cost">${perk.cost}</div>
        </button>
    `).join('');
}

class EventStateManager {
    constructor(eventId) {
        this.eventId = eventId;
        this.participants = new Map();
        this.status = 'waiting';
        this.setupRealtimeSync();
    }

    setupRealtimeSync() {
        this.channel = supabaseClient
            .channel(`event:${this.eventId}`)
            .on('broadcast', { event: 'state_update' }, payload => {
                this.handleStateUpdate(payload);
            })
            .on('broadcast', { event: 'status_change' }, payload => {
                this.handleStatusChange(payload);
            })
            .subscribe();
    }

    async updateParticipantState(playerId, state) {
        await supabaseClient
            .from('arcade_participants')
            .update(state)
            .eq('event_id', this.eventId)
            .eq('player_id', playerId);

        this.channel.send({
            type: 'broadcast',
            event: 'state_update',
            payload: { playerId, state }
        });
    }

    handleStateUpdate(payload) {
        const { playerId, state } = payload;
        this.participants.set(playerId, state);
        window.gameManager?.raceTrack.updatePlayerPosition(playerId, state.words_completed);
    }

    handleStatusChange(payload) {
        this.status = payload.status;
        if (payload.status === 'active' && window.gameManager) {
            window.gameManager.startGame();
        }
    }

    cleanup() {
        this.channel?.unsubscribe();
    }
}

class StudentGameView {
    constructor(eventId) {
        this.eventId = eventId;
        this.subscription = null;
        this.wordDisplay = null;
        this.leaderboard = null;
        this.setupUI();
    }

    setupUI() {
        const arcadeScreen = document.getElementById('arcade-screen');
        arcadeScreen.innerHTML = `
            <div class="game-header">
                <div class="player-stats">
                    <div class="stat-card">
                        <div>Words Completed</div>
                        <div class="stat-value words-completed">0</div>
                    </div>
                    <div class="stat-card">
                        <div>Score</div>
                        <div class="stat-value score">0</div>
                    </div>
                </div>
            </div>
            <div class="race-container"></div>
            <div class="word-container"></div>
        `;

        this.setupRealTimeUpdates();
    }

    async setupRealTimeUpdates() {
        this.subscription = supabaseClient
            .channel(`game:${this.eventId}`)
            .on('broadcast', { event: 'state_update' }, payload => {
                this.handleGameUpdate(payload);
            })
            .subscribe();
    }

    handleGameUpdate(payload) {
        // Update player positions, scores, etc.
    }

    cleanup() {
        this.subscription?.unsubscribe();
    }
}

class WordDisplay {
    constructor(container) {
        this.container = container;
        this.currentWord = null;
        this.setupDisplay();
    }

    setupDisplay() {
        this.element = document.createElement('div');
        this.element.className = 'word-display';
        this.element.innerHTML = `
            <div class="word"></div>
            <div class="options"></div>
            <div class="timer">
                <div class="timer-bar"></div>
            </div>
        `;
        this.container.appendChild(this.element);
    }

    presentWord(word, options) {
        this.currentWord = word;
        this.element.querySelector('.word').textContent = word.word;
        
        const optionsContainer = this.element.querySelector('.options');
        optionsContainer.innerHTML = options.map((opt, i) => `
            <button class="option-button" onclick="handleAnswer(${i})">
                ${opt}
            </button>
        `).join('');
        
        this.startTimer();
    }

    startTimer() {
        const timerBar = this.element.querySelector('.timer-bar');
        timerBar.style.width = '100%';
        requestAnimationFrame(() => {
            timerBar.style.width = '0%';
            timerBar.style.transition = 'width 7s linear';
        });
    }
}

    </script>
    </body>
    </html>