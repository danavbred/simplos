if(!document.getElementById("crown-glow-animation")){let e=document.createElement("style");e.id="crown-glow-animation",e.textContent=`
        @keyframes crownGlow {
            0% {
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
                filter: brightness(1) drop-shadow(0 0 3px rgba(255, 215, 0, 0.7));
                transform: scale(1);
            }
            100% {
                text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
                filter: brightness(1.4) drop-shadow(0 0 5px rgba(255, 215, 0, 0.9));
                transform: scale(1.1);
            }
        }
        
        .premium-crown {
            animation: crownGlow 2s infinite alternate;
        }
    `,document.head.appendChild(e)}document.addEventListener("progressSaved",e=>{var t=document.getElementById("stage-cascade-screen");t&&t.classList.contains("visible")&&(console.log("Refreshing stage cascade screen after progress save"),renderStageCascadeScreen())}),document.addEventListener("DOMContentLoaded",()=>{var e=document.querySelector(".logout-button");e&&e.addEventListener("click",handleLogout)}),document.addEventListener("click",e=>{var t=document.querySelector(".side-panel"),r=document.querySelector(".hamburger-button");!t.classList.contains("open")||t.contains(e.target)||r.contains(e.target)||toggleSidePanel()}),document.addEventListener("DOMContentLoaded",()=>{new Set});let ParticleSystem={particlePool:[],maxParticles:20,init(){for(let e=0;e<this.maxParticles;e++){var t=document.createElement("div");t.className="particle mobile-particle",this.particlePool.push(t)}},createParticle(t,r){if(!(window.innerWidth<=768)){let e=this.particlePool.pop();e&&(e.style.left=t+"px",e.style.top=r+"px",setTimeout(()=>{this.particlePool.push(e)},500))}}},currentArcadeSessionStructure={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],startTime:null,endTime:null,podiumRanks:{},playerName:null,winnerScreenShown:!1};function updateUI(){requestAnimationFrame(()=>{var e=document.createDocumentFragment();document.body.appendChild(e)})}document.addEventListener("click",e=>{e=e.target;e.matches(".game-btn")?handleButtonClick(e):e.matches(".level")&&handleLevelClick(e)});let CoinsManager={displayElements:new Set,initialize(){this.displayElements.clear(),document.querySelectorAll(".coin-count").forEach(e=>{this.displayElements.add(e)})},async loadUserCoins(){if(!currentUser)return parseInt(localStorage.getItem("simploxCustomCoins")||"0");try{var{data:e,error:t}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();if(t)throw t;return e.coins||0}catch(e){return console.error("Error loading coins:",e),0}},async updateCoins(i){try{let o=gameState.coins,s=o+i;if(gameState.coins=s,this.displayElements.forEach(r=>{let a=o,n=performance.now();requestAnimationFrame(function e(t){t-=n,t=Math.min(t/1e3,1);a=o+(s-o)*t,r.textContent=Math.round(a),0<i?r.style.color="var(--success)":i<0&&(r.style.color="var(--error)"),t<1?requestAnimationFrame(e):(r.textContent=s,setTimeout(()=>{r.style.color="var(--text)"},300))})}),currentUser){var e=(await supabaseClient.from("game_progress").update({coins:s}).eq("user_id",currentUser.id)).error;if(e)throw e}else localStorage.setItem("simploxCustomCoins",s.toString());return updatePerkButtons(),!0}catch(e){return console.error("Failed to update coins:",e),this.displayElements.forEach(e=>{e.textContent=gameState.coins-i}),updatePerkButtons(),!1}},updateDisplays(){this.displayElements.forEach(e=>{e.textContent=gameState.coins}),updatePerkButtons()}},WordsManager={displayElements:new Set,initialize(){this.displayElements.clear(),document.querySelectorAll("#totalWords").forEach(e=>{this.displayElements.add(e)}),currentUser&&this.loadUserWords().then(e=>{this.updateDisplays(e)})},async loadUserWords(){if(!currentUser)return 0;try{var{data:e,error:t}=await supabaseClient.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();if(t)throw t;return e?.unique_words_practiced||0}catch(e){return console.error("Error loading words:",e),0}},async updateWords(e){try{let o=parseInt(document.getElementById("totalWords").textContent)||0,s=o+e;if(this.displayElements.forEach(r=>{o;let a,n=performance.now();requestAnimationFrame(function e(t){t-=n,t=Math.min(t/1e3,1);a=o+(s-o)*t,r.textContent=Math.round(a),t<1?requestAnimationFrame(e):r.textContent=s})}),currentUser){var t=(await supabaseClient.from("player_stats").update({unique_words_practiced:s}).eq("user_id",currentUser.id)).error;if(t)throw t}return!0}catch(e){return console.error("Failed to update words:",e),!1}},updateDisplays(t){this.displayElements.forEach(e=>{e.textContent=t})}},perkButtons={timeFreeze:document.getElementById("timeFreezePerk"),skip:document.getElementById("skipPerk"),clue:document.getElementById("cluePerk"),reveal:document.getElementById("revealPerk")},GameTimer=(Object.entries(perkButtons).forEach(([e,t])=>{t&&(t.onclick=()=>buyPerk(e))}),{lastTick:0,update(e){this.lastTick||(this.lastTick=e),1e3<=e-this.lastTick&&(this.updateTimer(),this.lastTick=e),requestAnimationFrame(this.update.bind(this))}});function cleanupLevel(){document.querySelectorAll(".buttons button").forEach(e=>{e.onclick=null}),ParticleSystem.clear(),clearTimeout(levelTimeout)}async function transitionScreen(e){var t=document.querySelector(".screen.visible");t&&(t.style.opacity=0,await new Promise(e=>setTimeout(e,300)),t.style.display="none");let r=document.getElementById(e+"-screen");r.style.display="flex",requestAnimationFrame(()=>{r.style.opacity=1})}let GameCache={words:new Map,async getWords(e){var t;return this.words.has(e)?this.words.get(e):(t=await loadWords(e),this.words.set(e,t),t)}},gameInit={async init(){console.log("Game initialization starting"),await checkExistingSession(),currentUser?(console.log("User is logged in, checking database schema"),await ensureCorrectSchema()?(console.log("Schema is OK, loading progress from database"),await loadUserGameProgress(currentUser.id)):(console.log("Schema issues detected, loading from localStorage and initializing defaults"),initializeGame())):(console.log("No user logged in, initializing local game state"),initializeGame()),updatePerkButtons(),initializeParticles(document.getElementById("welcome-screen")),await loadCustomLists(),setupAutoSave(),console.log("Game initialization complete. Game state:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel,unlockedSets:Object.keys(gameState.unlockedSets||{}),unlockedLevels:Object.keys(gameState.unlockedLevels||{})})}},createClient=(document.addEventListener("DOMContentLoaded",()=>{gameInit.init()}),supabase).createClient,supabaseClient=createClient("https://mczfgzffyyyacisrccqb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jemZnemZmeXl5YWNpc3JjY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzODYyMDQsImV4cCI6MjA1Mzk2MjIwNH0.rLga_B29Coz1LMeJzFTGLIhckdcojGXnD1ae1bw-QAI",{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0});function showJoinModal(t=""){console.log("Opening join modal with OTP:",t);var r=document.getElementById("arcade-modal"),a=document.getElementById("teacher-view"),n=document.getElementById("player-view"),o=document.getElementById("otpInput");if(r){r.style.display="block",a&&(a.style.display="none"),n&&(n.style.display="block"),o&&(o.value="");let e=document.getElementById("arcadeUsername");if(e&&(e.value="",e.readOnly=!1,e.style.display="block",(r=e.closest(".input-group")?.querySelector(".username-display"))&&r.remove(),o)&&t&&(o.value=t,setTimeout(()=>e.focus(),300)),"undefined"!=typeof currentUser&&currentUser)try{var s,i,l=currentUser.user_metadata?.username||currentUser.email.split("@")[0];e&&l&&(e.value=l,e.readOnly=!0,e.style.display="none",s=e.closest(".input-group"))&&!s.querySelector(".username-display")&&((i=document.createElement("div")).className="username-display",i.textContent="Joining as: "+l,s.insertBefore(i,e))}catch(e){console.error("Error setting username in arcade modal:",e)}}}async function handleSignup(){var e=document.getElementById("signupEmail").value,t=document.getElementById("signupUsername").value,r=document.getElementById("signupPassword").value;if(e&&t&&r)try{var{data:a,error:n}=await supabaseClient.auth.signUp({email:e,password:r,options:{data:{username:t,full_name:t}}});if(n)throw n;var o,s,i,l,c=(await supabaseClient.from("user_profiles").upsert({id:a.user.id,username:t,email:e,status:"free",role:"student"},{onConflict:"id"})).error,d=(c&&console.error("Profile upsert error:",c),await supabaseClient.from("game_progress").select("user_id").eq("user_id",a.user.id).single()).error,u=(d&&"PGRST116"===d.code&&(o={user_id:a.user.id,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]},s=(await supabaseClient.from("game_progress").insert([o])).error,s)&&"23505"!==s.code&&console.error("Game progress initialization error:",s),await supabaseClient.from("player_stats").select("user_id").eq("user_id",a.user.id).single()).error,{data:m,error:g}=(u&&"PGRST116"===u.code&&(i={user_id:a.user.id,total_levels_completed:0,unique_words_practiced:0},l=(await supabaseClient.from("player_stats").insert([i])).error,l)&&"23505"!==l.code&&console.error("Player stats initialization error:",l),await supabaseClient.auth.signInWithPassword({email:e,password:r}));if(g)throw g;hideAuthModal(),currentUser=m.user,gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.perks={},gameState.unlockedSets={1:new Set([1])},gameState.unlockedLevels={"1_1":new Set([1])},gameState.perfectLevels=new Set,gameState.completedLevels=new Set,updateAuthUI(),showScreen("welcome-screen")}catch(e){console.error("Detailed signup error:",e),e.message&&e.message.includes("duplicate key")?alert("This username or email is already taken. Please try another."):alert("Signup error: "+e.message)}else alert("All fields are required")}async function safeUpsertRecord(t,e,r="user_id"){try{var a=(await supabaseClient.from(t).select(r).eq(r,e[r]).single()).error;if(a&&"PGRST116"===a.code){var n=(await supabaseClient.from(t).insert([e])).error;if(n){if("23505"!==n.code)return console.error(`Error inserting into ${t}:`,n),!1;var o=(await supabaseClient.from(t).update(e).eq(r,e[r])).error;if(o)return console.error(`Error updating ${t}:`,o),!1}}else{if(a)return console.error(`Error checking ${t}:`,a),!1;var s=(await supabaseClient.from(t).update(e).eq(r,e[r])).error;if(s)return console.error(`Error updating ${t}:`,s),!1}return!0}catch(e){return console.error(`Unexpected error in safeUpsertRecord for ${t}:`,e),!1}}async function updateUserCoins(e){var t=gameState.coins;if(gameState.coins+=e,updateAllCoinDisplays(),updatePerkButtons(),currentUser)try{var r=(await supabaseClient.from("game_progress").update({coins:gameState.coins}).eq("user_id",currentUser.id)).error;if(r)return console.error("Failed to update coins in database:",r),gameState.coins=t,updateAllCoinDisplays(),updatePerkButtons(),!1}catch(e){return console.error("Error updating coins:",e),gameState.coins=t,updateAllCoinDisplays(),updatePerkButtons(),!1}e=JSON.parse(localStorage.getItem("simploxProgress")||"{}");return e.coins=gameState.coins,localStorage.setItem("simploxProgress",JSON.stringify(e)),!0}async function checkAndFixDatabaseSchema(){if(!currentUser)return!1;try{var{data:e,error:t}=await supabaseClient.from("game_progress").select("*").eq("user_id",currentUser.id).single();if(t)return console.error("Error checking database schema:",t),!1;var r=!("completed_levels"in e),a=!("perfect_levels"in e);if(r||a){console.log("Adding missing columns to database schema");var n={user_id:currentUser.id,stage:e.stage||1,set_number:e.set_number||1,level:e.level||1},o=("coins"in e&&(n.coins=e.coins||0),"unlocked_sets"in e&&(n.unlocked_sets=e.unlocked_sets||{}),"unlocked_levels"in e&&(n.unlocked_levels=e.unlocked_levels||{}),r&&(n.completed_levels=[]),a&&(n.perfect_levels=[]),await supabaseClient.from("game_progress").update(n).eq("user_id",currentUser.id)).error;if(o)return console.error("Failed to update database schema:",o),!1;console.log("Database schema successfully updated")}else console.log("Database schema is up to date");return!0}catch(e){return console.error("Error fixing database schema:",e),!1}}async function initializeGameProgressForUser(e){e=(await supabaseClient.from("game_progress").insert({user_id:e,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]})).error;e&&console.error("Error initializing game progress:",e)}async function handleLogin(){var t=document.getElementById("loginUsername").value,r=document.getElementById("loginPassword").value;if(t&&r)try{let e;if(t.includes("@"))e=supabaseClient.auth.signInWithPassword({email:t,password:r});else{var{data:a,error:n}=await supabaseClient.from("user_profiles").select("email").eq("username",t).single();if(n||!a)return void alert("Username not found");e=supabaseClient.auth.signInWithPassword({email:a.email,password:r})}var o,{data:s,error:i}=await e;i?(console.error("Login Error:",i),alert(i.message)):s.user&&(currentUser=s.user,hideAuthModal(),o=(await supabaseClient.from("user_profiles").select("status").eq("id",currentUser.id).single()).data,o&&(currentUser.status=o.status,updateUserStatusDisplay(o.status)),await Promise.all([loadCustomLists(),loadUserGameProgress(currentUser.id)]),updateAuthUI(),updateGuestPlayButton(),showScreen("welcome-screen"))}catch(e){console.error("Unexpected Login Error:",e),alert("An unexpected error occurred during login")}else alert("Please enter both username/email and password")}function initializeGame(){console.log("Initializing game state"),gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.perks={},gameState.unlockedSets={},gameState.unlockedLevels={},gameState.perfectLevels=new Set,gameState.completedLevels=new Set;var e=localStorage.getItem("simploxProgress");if(e)try{console.log("Found saved progress in localStorage");var t=JSON.parse(e);t.stage&&(gameState.currentStage=t.stage),t.set_number&&(gameState.currentSet=t.set_number),t.level&&(gameState.currentLevel=t.level),t.coins&&(gameState.coins=t.coins),t.perks&&(gameState.perks=t.perks),t.unlocked_sets&&Object.entries(t.unlocked_sets).forEach(([e,t])=>{gameState.unlockedSets[e]=new Set(Array.isArray(t)?t:[])}),t.unlocked_levels&&Object.entries(t.unlocked_levels).forEach(([e,t])=>{gameState.unlockedLevels[e]=new Set(Array.isArray(t)?t:[])}),t.perfect_levels&&(gameState.perfectLevels=new Set(t.perfect_levels)),t.completed_levels&&(gameState.completedLevels=new Set(t.completed_levels)),console.log("Loaded progress from localStorage:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel})}catch(e){console.error("Error parsing saved progress:",e)}e=localStorage.getItem("gameContext");if(e)try{var r=JSON.parse(e);Date.now()-(r.timestamp||0)<864e5&&(console.log("Found recent game context, updating current location:",r),r.stage&&(gameState.currentStage=r.stage),r.set&&(gameState.currentSet=r.set),r.level)&&(gameState.currentLevel=r.level)}catch(e){console.error("Error parsing saved context:",e)}setupDefaultUnlocks(),updateAllCoinDisplays(),updatePerkButtons(),console.log("Game initialized with state:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel})}function setupDefaultUnlocks(){gameState.unlockedSets[1]||(gameState.unlockedSets[1]=new Set);for(let e=1;e<=9;e++){gameState.unlockedSets[1].add(e);var t="1_"+e;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set([1]))}for(let e=2;e<=5;e++){gameState.unlockedSets[e]||(gameState.unlockedSets[e]=new Set([1]));var r=e+"_1";gameState.unlockedLevels[r]||(gameState.unlockedLevels[r]=new Set([1]))}}async function loadUserGameProgress(e){console.log("Loading game progress for user:",e);try{gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.perks={},gameState.unlockedSets={1:new Set([1])},gameState.unlockedLevels={"1_1":new Set([1])},gameState.perfectLevels=new Set,gameState.completedLevels=new Set;var t=localStorage.getItem("simploxProgress");if(t)try{var r=JSON.parse(t);console.log("Found progress in localStorage:",r),r.stage&&(gameState.currentStage=r.stage),r.set_number&&(gameState.currentSet=r.set_number),r.level&&(gameState.currentLevel=r.level),r.coins&&(gameState.coins=r.coins),r.perks&&(gameState.perks=r.perks),r.unlocked_sets&&(gameState.unlockedSets={},Object.entries(r.unlocked_sets).forEach(([e,t])=>{gameState.unlockedSets[e]=new Set(t)})),r.unlocked_levels&&(gameState.unlockedLevels={},Object.entries(r.unlocked_levels).forEach(([e,t])=>{gameState.unlockedLevels[e]=new Set(t)})),r.perfect_levels&&(gameState.perfectLevels=new Set(r.perfect_levels)),r.completed_levels&&(gameState.completedLevels=new Set(r.completed_levels))}catch(e){console.error("Error parsing localStorage progress:",e)}var a,n,{data:o,error:s}=await supabaseClient.from("game_progress").select("*").eq("user_id",e).single();if(s)"PGRST116"===s.code?(console.log("No progress record found, creating initial progress"),a={user_id:e,stage:gameState.currentStage,set_number:gameState.currentSet,level:gameState.currentLevel,coins:gameState.coins},n=(await supabaseClient.from("game_progress").insert([a])).error,n&&console.error("Error creating initial game progress:",n)):console.error("Error loading game progress:",s);else if(o){console.log("Game progress loaded from database:",o),gameState.currentStage=o.stage||gameState.currentStage,gameState.currentSet=o.set_number||gameState.currentSet,gameState.currentLevel=o.level||gameState.currentLevel,gameState.coins=o.coins||gameState.coins;try{o.perks&&0<Object.keys(o.perks).length&&(gameState.perks=o.perks),o.unlocked_sets&&0<Object.keys(o.unlocked_sets).length&&(gameState.unlockedSets={},Object.entries(o.unlocked_sets).forEach(([e,t])=>{gameState.unlockedSets[e]=new Set(t)})),o.unlocked_levels&&0<Object.keys(o.unlocked_levels).length&&(gameState.unlockedLevels={},Object.entries(o.unlocked_levels).forEach(([e,t])=>{gameState.unlockedLevels[e]=new Set(t)})),o.perfect_levels&&0<o.perfect_levels.length&&(gameState.perfectLevels=new Set(o.perfect_levels)),o.completed_levels&&0<o.completed_levels.length&&(gameState.completedLevels=new Set(o.completed_levels))}catch(e){console.error("Error loading extended fields from database:",e)}}return setupDefaultUnlocks(),console.log("Game state after loading progress:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel}),updateAllCoinDisplays(),!0}catch(e){return console.error("Unexpected error in loadUserGameProgress:",e),!1}}function debugUnlockState(){console.group("Current Game State"),console.log("Current Stage:",gameState.currentStage),console.log("Current Set:",gameState.currentSet),console.log("Current Level:",gameState.currentLevel),console.group("Unlocked Sets"),Object.entries(gameState.unlockedSets).forEach(([e,t])=>{console.log(`Stage ${e}:`,Array.from(t).sort((e,t)=>e-t))}),console.groupEnd(),console.group("Unlocked Levels"),Object.entries(gameState.unlockedLevels).forEach(([e,t])=>{console.log(`Set ${e}:`,Array.from(t).sort((e,t)=>e-t))}),console.groupEnd(),console.log("Completed Levels:",Array.from(gameState.completedLevels)),console.log("Perfect Levels:",Array.from(gameState.perfectLevels)),console.groupEnd()}async function handleLogout(){try{var e=(await supabaseClient.auth.signOut()).error;e&&console.error("Supabase logout error:",e.message),gameState.coins=0,gameState.unlockedSets={},gameState.unlockedLevels={},gameState.perfectLevels=new Set,gameState.completedLevels=new Set,clearCustomPracticeUI(),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),showScreen("welcome-screen")}catch(e){console.error("Unexpected error during logout:",e),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),showScreen("welcome-screen")}}function clearCustomPracticeUI(){var e=document.getElementById("custom-list-name"),e=(e&&(e.value=""),document.getElementById("custom-word-input")),e=(e&&(e.value=""),document.getElementById("translation-results")),e=(e&&(e.style.display="none"),document.getElementById("word-translation-list"));e&&(e.innerHTML=""),customPracticeLists.currentList=null,customPracticeLists.lists=[]}function saveProgress(){if(console.log("Saving game progress"),gameState.currentStage){var e={stage:gameState.currentStage||1,set_number:gameState.currentSet||1,level:gameState.currentLevel||1,coins:gameState.coins||0};let t={perks:gameState.perks||{},unlocked_sets:Object.fromEntries(Object.entries(gameState.unlockedSets||{}).map(([e,t])=>[e,Array.from(t||[])])),unlocked_levels:Object.fromEntries(Object.entries(gameState.unlockedLevels||{}).map(([e,t])=>[e,Array.from(t||[])])),perfect_levels:Array.from(gameState.perfectLevels||[]),completed_levels:Array.from(gameState.completedLevels||[])};localStorage.setItem("simploxProgress",JSON.stringify({...e,...t}));var r={stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(r)),currentUser&&(console.log("Saving progress to Supabase for user:",currentUser.id),supabaseClient.from("game_progress").upsert({user_id:currentUser.id,...e}).then(({error:e})=>{if(e)console.error("Error saving core progress:",e);else{console.log("Core progress saved successfully");Object.entries(t).forEach(([e,t])=>{((t,e)=>{e={[t]:e};supabaseClient.from("game_progress").update(e).eq("user_id",currentUser.id).then(({error:e})=>{e?console.warn(`Error saving ${t}:`,e):console.log(t+" saved successfully")})})(e,t)})}}))}else console.log("No game state to save")}async function ensureCorrectSchema(){if(!currentUser)return!1;console.log("Checking database schema for user:",currentUser.id);try{var t,r,{data:a,error:n}=await supabaseClient.from("game_progress").select("*").eq("user_id",currentUser.id).single();if(n)return"PGRST116"===n.code?(console.log("Creating game progress record for user"),t={user_id:currentUser.id,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]},r=(await supabaseClient.from("game_progress").insert([t])).error,!r||(console.error("Error creating game progress record:",r),!1)):(console.error("Error checking game progress record:",n),!1);let e=!1;var o,s={...a};for(o of[{name:"unlocked_sets",defaultValue:{1:[1]}},{name:"unlocked_levels",defaultValue:{"1_1":[1]}},{name:"perfect_levels",defaultValue:[]},{name:"completed_levels",defaultValue:[]}])o.name in a&&null!==a[o.name]||(s[o.name]=o.defaultValue,e=!0,console.log(`Field "${o.name}" missing, will add it`));if(e){console.log("Updating record with missing fields");var i=(await supabaseClient.from("game_progress").update(s).eq("user_id",currentUser.id)).error;if(i)return console.error("Error updating game progress record:",i),!1}return!0}catch(e){return console.error("Unexpected error in ensureCorrectSchema:",e),!1}}function switchAuthTab(e){var t=document.querySelector(".auth-tab[onclick=\"switchAuthTab('login')\"]"),r=document.querySelector(".auth-tab[onclick=\"switchAuthTab('signup')\"]"),a=document.getElementById("loginForm"),n=document.getElementById("signupForm");"login"===e?(t.classList.add("active"),r.classList.remove("active"),a.classList.remove("hidden"),n.classList.add("hidden")):(t.classList.remove("active"),r.classList.add("active"),a.classList.add("hidden"),n.classList.remove("hidden"))}function updateAuthUI(){var e=document.getElementById("authBox"),t=document.getElementById("userInfo");let r=document.getElementById("userEmail");var a=document.querySelector(".logout-button");currentUser?(e.classList.add("hidden"),t.classList.remove("hidden"),a.classList.remove("hidden"),r.textContent=currentUser.user_metadata?.username||currentUser.email,supabaseClient.from("user_profiles").select("status, username").eq("id",currentUser.id).single().then(({data:e})=>{e&&(e.username&&(r.textContent=e.username),updateUserStatusDisplay(e.status))}).catch(e=>console.error("Error fetching user status:",e))):(e.classList.remove("hidden"),t.classList.add("hidden"),a.classList.add("hidden"),r.textContent="")}document.addEventListener("DOMContentLoaded",async()=>{try{window.CustomListsManager||(window.CustomListsManager={lists:[],async initialize(){currentUser?await this.loadFromSupabase():this.loadFromLocalStorage()},async loadFromSupabase(){try{var{data:e,error:t}=await supabaseClient.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`);if(t)throw t;this.lists=e.map(e=>({id:e.id,name:e.name,words:e.words||[],translations:e.translations||[],isShared:e.is_shared,sharedBy:e.shared_by,userId:e.user_id,createdAt:e.created_at})),console.log("Loaded lists from Supabase:",this.lists.length)}catch(e){console.error("Error loading lists from Supabase:",e),this.lists=[]}},loadFromLocalStorage(){try{var e=localStorage.getItem("simploxCustomLists");this.lists=e?JSON.parse(e):[],console.log("Loaded lists from localStorage:",this.lists.length)}catch(e){console.error("Error loading lists from localStorage:",e),this.lists=[]}},async save(e){return e?currentUser?this.saveToSupabase(e):this.saveToLocalStorage(e):null},async saveToSupabase(t){try{var e={name:t.name,words:t.words||[],translations:t.translations||[],user_id:currentUser.id};if(t.id&&"string"==typeof t.id&&36===t.id.length){var{data:r,error:a}=await supabaseClient.from("custom_lists").update(e).eq("id",t.id).select().single();if(a)throw a;return r}var{data:n,error:o}=await supabaseClient.from("custom_lists").insert(e).select().single();if(o)throw o;var s=this.lists.findIndex(e=>e.id===t.id||e.tempId&&e.tempId===t.tempId);return-1!==s?this.lists[s]={...n,words:n.words||[],translations:n.translations||[]}:this.lists.push({...n,words:n.words||[],translations:n.translations||[]}),n}catch(e){return console.error("Error saving list to Supabase:",e),null}},saveToLocalStorage(t){try{var e={...t,id:t.id||Date.now(),tempId:t.tempId||Date.now()},r=this.lists.findIndex(e=>e.id===t.id||e.tempId&&e.tempId===t.tempId);return-1!==r?this.lists[r]=e:this.lists.push(e),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),e}catch(e){return console.error("Error saving list to localStorage:",e),null}},async delete(t){if(!currentUser)return this.lists=this.lists.filter(e=>e.id!==t),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),!0;try{if("string"==typeof t&&36===t.length){var e=(await supabaseClient.from("custom_lists").delete().eq("id",t)).error;if(e)throw e}return this.lists=this.lists.filter(e=>e.id!==t),!0}catch(e){return console.error("Error deleting list from Supabase:",e),!1}},async share(t,e){if(!currentUser)return!1;try{var r=this.lists.find(e=>e.id===t);return r?!(await supabaseClient.rpc("insert_shared_list",{p_user_id:e,p_name:`${r.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,p_words:r.words||[],p_translations:r.translations||[],p_is_shared:!0,p_local_id:Date.now(),p_shared_with:[e],p_shared_by:currentUser.id})).error:!1}catch(e){return console.error("Error sharing list:",e),!1}},getListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"};switch(currentUser.status||"free"){case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"∞"};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"∞"};case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1,playDisplay:"10"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"}}},canCreateMoreLists(){var e=this.getListLimits();return this.lists.length<e.maxLists}}),await checkExistingSession(),initializeGame(),updatePerkButtons(),updateGuestPlayButton(),CoinsManager.initialize(),WordsManager.initialize(),await CustomListsManager.initialize(),currentUser&&(gameState.coins=await CoinsManager.loadUserCoins(),CoinsManager.updateDisplays(),e=await WordsManager.loadUserWords(),WordsManager.updateDisplays(e)),window.addEventListener("hashchange",handleHashChange),window.addEventListener("load",handleHashChange),window.location.hash.startsWith("#join=")&&(console.log("Initial join hash detected"),t=window.location.hash.replace("#join=",""),history.pushState("",document.title,window.location.pathname),showJoinModal(t));var e,t,r=document.getElementById("welcome-screen"),a=(initializeParticles(r),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(document.addEventListener("touchstart",function e(){document.removeEventListener("touchstart",e)},{once:!0}),document.addEventListener("click",function(e){e.target.tagName}),screen.orientation)&&screen.orientation.lock("portrait").catch(e=>console.log("Failed to lock orientation:",e)),document.getElementById("otpInput"));a&&a.addEventListener("input",function(e){this.value=this.value.replace(/[^0-9]/g,""),4<this.value.length&&(this.value=this.value.slice(0,4))}),currentUser&&(setupUserStatusSubscription(),initializeStatusCheck())}catch(e){console.error("Initialization error:",e)}}),document.addEventListener("DOMContentLoaded",function(){currentUser=null,checkExistingSession().then(()=>{initializeGame(),updatePerkButtons(),updateNavigationContainer()})}),document.addEventListener("DOMContentLoaded",()=>{(async()=>{await checkExistingSession(),initializeGame(),updatePerkButtons(),updateGuestPlayButton(),CoinsManager.initialize(),WordsManager.initialize(),currentUser&&([e,t]=await Promise.all([CoinsManager.loadUserCoins(),WordsManager.loadUserWords()]),gameState.coins=e,CoinsManager.updateDisplays(),WordsManager.updateDisplays(t)),window.location.hash.startsWith("#join=")&&(console.log("Initial join hash detected"),e=window.location.hash.replace("#join=",""),history.pushState("",document.title,window.location.pathname),showJoinModal(e));var e,t=document.getElementById("welcome-screen");initializeParticles(t),await loadCustomLists(),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(document.addEventListener("touchstart",function e(){document.removeEventListener("touchstart",e)},{once:!0}),document.addEventListener("click",function(e){e.target.tagName}),screen.orientation)&&screen.orientation.lock("portrait").catch(e=>console.log("Failed to lock orientation:",e)),currentUser&&(setupUserStatusSubscription(),initializeStatusCheck())})().catch(e=>{console.error("Initialization error:",e)})});let gameStructure={stages:[{id:1,numSets:9,levelsPerSet:21,bossLevel:21},{id:2,numSets:10,levelsPerSet:21,bossLevel:21},{id:3,numSets:12,levelsPerSet:21,bossLevel:21},{id:4,numSets:30,levelsPerSet:21,bossLevel:21},{id:5,numSets:14,levelsPerSet:21,bossLevel:21}],levelTypes:{normal:"normal",boss:"boss"}},gameState={currentStage:null,currentSet:null,sessionStartTime:null,currentLevel:null,unlockedSets:{},unlockedLevels:{},levelScores:{},completedLevels:new Set,perfectLevels:new Set,coins:0},PERK_CONFIG={timeFreeze:{name:"Time Freeze",description:"Pause the timer for 5 seconds",cost:15,icon:"fa-clock",duration:5e3},skip:{name:"Skip Question",description:"Skip the current word without penalty",cost:1,icon:"fa-forward"},clue:{name:"Eliminate Wrong Answer",description:"Remove one incorrect answer",cost:35,icon:"fa-lightbulb"},reveal:{name:"Reveal Correct Answer",description:"Show the correct translation",cost:50,icon:"fa-eye"},rewind:{name:"Double Freeze",description:"Pause the timer for 10 seconds",cost:1,icon:"fa-snowflake",duration:2e3,requiresPremium:!0,requiresWordCount:10}};function buyPerk(e){var r=PERK_CONFIG[e];if(r)if(gameState.coins<r.cost)showNotification(`Need ${r.cost} coins!`,"error");else{switch(gameState.coins-=r.cost,updateAllCoinDisplays(),e){case"timeFreeze":isFrozen=!0,setTimeout(()=>{isFrozen=!1},r.duration);break;case"skip":handleAnswer(!0,!0);break;case"clue":var a=document.querySelectorAll(".buttons button");let t=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[currentGame.currentIndex];var a=Array.from(a).filter(e=>e.textContent!==t);0<a.length&&((a=a[Math.floor(Math.random()*a.length)]).disabled=!0,a.style.opacity="0.5");break;case"reveal":let e=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[currentGame.currentIndex];document.querySelectorAll(".buttons button").forEach(t=>{if(t.textContent===e){t.classList.add("correct");let e=t.style.background;t.style.background="var(--success)",setTimeout(()=>{t.classList.remove("correct"),t.style.background=e},5e3)}})}saveProgress()}}let crownStyleElement=document.createElement("style");function updatePerkButtons(){Object.entries(PERK_CONFIG).forEach(([r,t])=>{var a=document.getElementById(r+"Perk");if(a){if(t.requiresWordCount){if((parseInt(document.getElementById("totalWords").textContent)||0)<t.requiresWordCount)return void(a.style.display="none");if(a.style.display="flex",t.requiresPremium){var n=currentUser&&"premium"===currentUser.status;let t=a.querySelector(".premium-crown");if(!n){t||((t=document.createElement("i")).className="fas fa-crown premium-crown",t.style.cssText=`
        position: absolute;
        top: -10px;
        right: -10px;
        color: var(--gold);
        font-size: 1.2rem;
        filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
        animation: crownGlow 2s infinite alternate;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px;
        border-radius: 50%;
        z-index: 10;
        border: 1px solid rgba(255, 215, 0, 0.5);
    `,a.style.position="relative",a.appendChild(t),a.onclick,a.onclick=function(){showNotification("Premium feature only!","error")}),a.disabled=!0,a.classList.add("disabled");let e=a.querySelector(".perk-count");return void(e&&(e.textContent="0"))}t&&a.removeChild(t),a.onclick=function(){buyPerk(r)}}}n=Math.floor(gameState.coins/t.cost),t=0<n;a.disabled=!t,a.classList.toggle("disabled",!t);let e=a.querySelector(".perk-count");e&&(e.textContent=t?n.toString():"0")}})}crownStyleElement.textContent=`
    @keyframes crownGlow {
        0% {
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            filter: brightness(1) drop-shadow(0 0 3px rgba(255, 215, 0, 0.7));
        }
        100% {
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            filter: brightness(1.4) drop-shadow(0 0 5px rgba(255, 215, 0, 0.9));
        }
    }
    
    .premium-crown {
        animation: crownGlow 2s infinite alternate;
    }
`,document.head.appendChild(crownStyleElement),updatePerkButtons();let currentGame={words:[],translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,startTime:0,levelStartTime:0,timeBonus:0,streakBonus:!0,questionStartTime:0,wrongStreak:0,progressLost:0},timer=null,timeRemaining=0,isFrozen=!1,resetProgressTimeout=null,isFirstResetAttempt=!0;function saveProgress(){var e;currentUser?(e={stage:gameState.currentStage,set_number:gameState.currentSet,level:gameState.currentLevel,coins:gameState.coins,perks:gameState.perks,unlocked_sets:Object.fromEntries(Object.entries(gameState.unlockedSets).map(([e,t])=>[e,Array.from(t)])),unlocked_levels:Object.fromEntries(Object.entries(gameState.unlockedLevels).map(([e,t])=>[e,Array.from(t)])),perfect_levels:Array.from(gameState.perfectLevels),completed_levels:Array.from(gameState.completedLevels)},supabaseClient.from("game_progress").update(e).eq("user_id",currentUser.id).then(({error:e})=>{e&&console.error("Error saving game progress:",e)})):localStorage.setItem("simploxProgress",JSON.stringify({unlockedSets:Object.fromEntries(Object.entries(gameState.unlockedSets).map(([e,t])=>[e,Array.from(t)])),unlockedLevels:Object.fromEntries(Object.entries(gameState.unlockedLevels).map(([e,t])=>[e,Array.from(t)])),perfectLevels:Array.from(gameState.perfectLevels),completedLevels:Array.from(gameState.completedLevels),coins:gameState.coins,perks:gameState.perks}))}function loadProgress(){var e=localStorage.getItem("simploxProgress"),e=(e&&(e=JSON.parse(e),gameState.unlockedSets=Object.fromEntries(Object.entries(e.unlockedSets).map(([e,t])=>[e,new Set(t)])),gameState.unlockedLevels=Object.fromEntries(Object.entries(e.unlockedLevels).map(([e,t])=>[e,new Set(t)])),gameState.perfectLevels=new Set(e.perfectLevels),gameState.completedLevels=new Set(e.completedLevels||[]),gameState.coins=e.coins,gameState.perks=e.perks||{timeFreeze:0,skip:0,clue:0,reveal:0}),localStorage.getItem("simploxCustomCoins"));e&&(gameState.coins=parseInt(e))}async function handleLogout(){try{var e=(await supabaseClient.auth.signOut()).error;e&&console.error("Supabase logout error:",e.message),currentUser=null,updateAuthUI(),showScreen("welcome-screen"),initializeGame()}catch(e){console.error("Unexpected error during logout:",e)}}function startTimer(e){clearTimer(),currentGame.currentIndex>=currentGame.words.length||(currentGame.initialTimeRemaining?timeRemaining=currentGame.initialTimeRemaining:(currentGame.initialTimeRemaining=10*currentGame.words.length,timeRemaining=currentGame.initialTimeRemaining,currentGame.totalTime=timeRemaining),console.log("Starting timer with:",timeRemaining,"seconds"),currentGame.questionStartTime=Date.now(),updateTimerDisplay(),updateTimerCircle(timeRemaining,currentGame.totalTime),timer=setInterval(()=>{isFrozen||(timeRemaining=Math.max(0,timeRemaining-1),updateTimerDisplay(),updateTimerCircle(timeRemaining,currentGame.totalTime),(currentGame.initialTimeRemaining=timeRemaining)<=10&&document.querySelector(".timer-value").classList.add("warning"),timeRemaining<=0&&handleTimeUp())},1e3))}function updateTimerDisplay(){var e=Math.floor(timeRemaining/60),t=timeRemaining%60,r=document.querySelector(".timer-value");r.textContent=String(e).padStart(2,"0")+":"+String(t).padStart(2,"0"),timeRemaining<=10?r.classList.add("warning"):r.classList.remove("warning")}function clearTimer(){timer&&(clearInterval(timer),timer=null),timeRemaining=0,isFrozen=!1;var e=document.querySelector(".timer-progress");e&&e.classList.remove("warning"),updateTimerCircle(0,1)}function createParticles(t,r){var a=window.matchMedia("(max-width: 768px)").matches?{count:10,size:6,distance:50,opacity:.7,duration:1e3}:{count:40,size:10,distance:150,opacity:1,duration:1500},n=["#ffd700","#FFA500","#4CAF50","#FFD700"];let o=document.body;for(let e=0;e<a.count;e++){let e=document.createElement("div");e.className="particle",e.style.backgroundColor=n[Math.floor(Math.random()*n.length)],e.style.position="fixed",e.style.left=t+"px",e.style.top=r+"px";var s=Math.random()*Math.PI*2,i=a.distance+50*Math.random();e.style.width=a.size+"px",e.style.height=a.size+"px",e.style.opacity=""+a.opacity,e.style.setProperty("--x",Math.cos(s)*i+"px"),e.style.setProperty("--y",Math.sin(s)*i+"px"),e.style.animation=`particleBurst ${a.duration/1e3}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`,o.appendChild(e),setTimeout(()=>{o.removeChild(e)},a.duration)}}function animateCoinsChange(o,s,i){if(o)if((s=parseFloat(s)||0)===(i=parseFloat(i)||0))o.textContent=i;else{let e=1e3/(1e3/60),t=(i-s)/e,r=0,a=s,n=(o.classList.add("animating"),function(){r++,a+=t,r<=e&&(0<t&&a<i||t<0&&a>i)?(o.textContent=Math.round(a),0<t?o.style.color="var(--success)":t<0&&(o.style.color="var(--error)"),requestAnimationFrame(n)):(o.textContent=i,setTimeout(()=>{o.style.color="var(--text)",o.classList.remove("animating")},300))});requestAnimationFrame(n)}}let LEADERBOARD_UPDATE_INTERVAL=1e4;function updatePlayerProgress(t){let e=Date.now();if(e-lastLeaderboardUpdate<1e4){let e=currentArcadeSession.participants.findIndex(e=>e.username===t.username);void(-1!==e?currentArcadeSession.participants[e]={...currentArcadeSession.participants[e],...t}:currentArcadeSession.participants.push({username:t.username,wordsCompleted:t.wordsCompleted||0,coins:t.coins||0}))}else{lastLeaderboardUpdate=e;let n={},o={};document.querySelectorAll(".leaderboard-entry").forEach(e=>{var t,r=e.querySelector("[data-username]")?.dataset.username;r&&(n[r]=e.getBoundingClientRect(),t=e.querySelector("[data-words]"),e=e.querySelector("[data-coins]"),o[r]={words:t?parseInt(t.textContent):0,coins:e?parseInt(e.textContent):0})});var r=currentArcadeSession.participants.findIndex(e=>e.username===t.username),r=(-1!==r?currentArcadeSession.participants[r]={...currentArcadeSession.participants[r],...t}:currentArcadeSession.participants.push({username:t.username,wordsCompleted:t.wordsCompleted||0,coins:t.coins||0}),[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins).map((e,t)=>`
    <div class="leaderboard-entry ${t<3?"rank-"+(t+1):""}"
         data-rank="${t+1}">
      <div>${t+1}</div>
      <div data-username="${e.username}">${e.username}</div>
      <div data-words="${e.wordsCompleted||0}">${e.wordsCompleted||0}</div>
      <div data-coins="${e.coins||0}">${e.coins||0}</div>
    </div>
  `).join("")),a=document.getElementById("arcade-leaderboard");if(a){let e=a.querySelector(".leaderboard-header");a.innerHTML=e?e.outerHTML+r:r,a.querySelectorAll(".leaderboard-entry").forEach(r=>{var a=r.querySelector("[data-username]")?.dataset.username;if(a&&n[a]){var e=n[a],t=r.getBoundingClientRect(),e=e.top-t.top;if(0<e?r.classList.add("moving-up"):e<0&&r.classList.add("moving-down"),o[a]){let e=r.querySelector("[data-words]"),t=r.querySelector("[data-coins]");e&&o[a].words!==parseInt(e.textContent)&&animateCoinsChange(e,o[a].words,parseInt(e.textContent)),t&&o[a].coins!==parseInt(t.textContent)&&animateCoinsChange(t,o[a].coins,parseInt(t.textContent))}r.addEventListener("animationend",()=>{r.classList.remove("moving-up","moving-down")},{once:!0})}})}updateArcadeProgress(),updatePlayerRankDisplay()}}function animateCoinsChange(o,s,i){if(o)if((s=parseFloat(s)||0)===(i=parseFloat(i)||0))o.textContent=i;else{let e=1e3/(1e3/60),t=(i-s)/e,r=0,a=s,n=(o.classList.add("animating"),function(){r++,a+=t,r<=e&&(0<t&&a<i||t<0&&a>i)?(o.textContent=Math.round(a),0<t?o.style.color="var(--success)":t<0&&(o.style.color="var(--error)"),requestAnimationFrame(n)):(o.textContent=i,setTimeout(()=>{o.style.color="var(--text)",o.classList.remove("animating")},300))});requestAnimationFrame(n)}}function handleTimeUp(){currentGame.currentIndex>=currentGame.words.length||(clearTimer(),showReviveOverlay())}function showScreen(e,t=!1){"upgrade-screen"!==e||currentUser||(console.log("Unregistered user attempt to access upgrade screen, redirecting to auth modal"),e="welcome-screen",setTimeout(()=>{showAuthModal(),setTimeout(()=>{var e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))},100)},200)),"welcome-screen"===e&&(console.log("Returning to welcome screen, clearing game context"),localStorage.removeItem("gameContext")),console.log("showScreen called with:",{screenId:e,forceRefresh:t,currentUser:currentUser?currentUser.id:"No user"}),"leaderboard-screen"===document.querySelector(".screen.visible")?.id&&cleanupLeaderboard();var r=document.querySelector(".screen.visible");if(r&&"question-screen"===r.id&&(clearTimer(),isFrozen=!1),t&&"welcome-screen"===e)console.log("Initiating full page reload"),saveProgress(),window.location.reload(!0);else{["question-screen","custom-practice-screen","moderator-screen","leaderboard-screen"].includes(e)&&updateNavigationContainer(),document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("visible");e=e.querySelector(".particle-container");e&&e.remove()});r=document.getElementById(e);if(r){switch(r.classList.add("visible"),initializeParticles(r),updateAllCoinDisplays(),e){case"question-screen":updatePerkButtons(),console.log("Question screen shown, checking for admin button"),setTimeout(()=>{addAdminTestButton()},100);break;case"welcome-screen":restoreGameContext()&&startGame();break;case"stage-cascade-screen":return showStageCascadeScreen()}console.log("Switched to screen: "+e)}else console.error(`Screen with id ${e} not found`)}}function showLevelScreen(a){gameState.currentSet=a,debugUnlockState();var e=document.getElementById("level-container");if(e){e.innerHTML="";var n=gameStructure.stages[gameState.currentStage-1];if(n){var o=document.createElement("div"),s=(o.className="level-header",n.levelsPerSet);let t=0,r=0;for(let e=1;e<=s;e++){var i=gameState.currentStage+`_${a}_`+e;gameState.perfectLevels.has(i)?(r++,t++):gameState.completedLevels.has(i)&&t++}var l=Math.round(t/s*100),c=getSetIcon(gameState.currentStage,a),d=getSetDescription(gameState.currentStage,a),u=(o.innerHTML=`
        <div class="level-title-area">
            <div class="set-icon">
                <i class="${c}"></i>
            </div>
            <div class="set-details">
                <div class="set-name">Stage ${gameState.currentStage} - Set ${a}</div>
                <div class="set-desc">${d}</div>
            </div>
        </div>
        <div class="set-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${l}%"></div>
            </div>
            <div class="progress-text">${t}/${s} levels</div>
        </div>
    `,e.appendChild(o),document.createElement("div")),m=(u.className="level-grid",[3,6,9,10,13,16,19,20]),g=gameState.currentStage+"_"+a;gameState.unlockedLevels[g]||(gameState.unlockedLevels[g]=new Set([1])),console.log(`Rendering levels for ${g}. Unlocked levels:`,Array.from(gameState.unlockedLevels[g]||[]));for(let e=1;e<=n.levelsPerSet;e++){var p=document.createElement("div"),v=gameState.currentStage+`_${a}_`+e,h=gameState.unlockedLevels[g]?.has(e),f=(console.log(`Level ${e} unlocked:`,h),gameState.perfectLevels.has(v)),v=gameState.completedLevels.has(v),y=e===n.bossLevel,S=m.includes(e);p.className="level-item",h&&p.classList.add("unlocked"),f?p.classList.add("perfect"):v&&p.classList.add("completed"),y&&p.classList.add("boss"),S&&p.classList.add("test"),h||p.classList.add("locked"),p.textContent=e,h&&(p.onclick=()=>startLevel(e)),u.appendChild(p)}e.appendChild(u);c=document.createElement("div");c.className="level-type-legend",c.innerHTML=`
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, var(--accent), rgba(30, 144, 255, 0.7));"></div>
            <span>Normal</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, var(--success), #45b649);"></div>
            <span>Completed</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, var(--gold), #FFA500);"></div>
            <span>Perfect</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, var(--gold), var(--accent));"></div>
            <span>Boss</span>
        </div>
    `,e.appendChild(c),showScreen("level-screen")}}}function getSetIcon(e,t){var r=["fas fa-book-open","fas fa-book-reader","fas fa-bookmark","fas fa-pencil-alt","fas fa-pen"];return 1===t?{1:"fas fa-book",2:"fas fa-graduation-cap",3:"fas fa-school",4:"fas fa-university",5:"fas fa-brain"}[e]||"fas fa-star":r[(t-2)%r.length]||"fas fa-star"}function getSetDescription(e,t){return`${{1:"Beginner",2:"Elementary",3:"Intermediate",4:"Advanced",5:"Expert"}[e]||"Advanced"} vocabulary - Group `+t}function calculateWordsForLevel(e,t){var r,a=t.words.length,n=a-50;if(!t.randomIndices){t.randomIndices=Array.from({length:a},(e,t)=>t);for(let e=t.randomIndices.length-1;0<e;e--){var o=Math.floor(Math.random()*(e+1));[t.randomIndices[e],t.randomIndices[o]]=[t.randomIndices[o],t.randomIndices[e]]}console.log("Created randomized word indices:",t.randomIndices)}return 21===e?{startIndex:0,count:a,isBossLevel:!0,speedChallenge:!0,mixed:!0,isTestLevel:!0,isHebrewToEnglish:Math.random()<.5,testLevels:[],randomIndices:t.randomIndices}:1===e||2===e?{startIndex:a=3*(e-1),count:3,testLevels:[3,10,21],randomIndices:t.randomIndices.slice(a,3+a)}:3===e?{startIndex:0,count:6,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(0,6)}:4===e||5===e?{startIndex:a=6+3*(e-4),count:3,testLevels:[6,10,21],randomIndices:t.randomIndices.slice(a,3+a)}:6===e?{startIndex:6,count:6,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(6,12)}:7===e||8===e?{startIndex:a=12+4*(e-7),count:4,testLevels:[9,10,21],randomIndices:t.randomIndices.slice(a,4+a)}:9===e?{startIndex:12,count:8,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(12,20)}:10===e?{startIndex:0,count:20,isTestLevel:!0,speedChallenge:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(0,20)}:11===e||12===e?{startIndex:a=20+4*(e-11),count:4,testLevels:[13,20,21],randomIndices:t.randomIndices.slice(a,4+a)}:13===e?{startIndex:20,count:8,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(20,28)}:14===e||15===e?{startIndex:a=28+(14===e?0:5),count:r=14===e?5:6,testLevels:[16,20,21],randomIndices:t.randomIndices.slice(a,a+r)}:16===e?{startIndex:28,count:11,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(28,39)}:17===e||18===e?(a=17===e?5:6,{startIndex:r=39+(17===e?0:a),count:a=a+(0<n?n:0),testLevels:[19,20,21],randomIndices:t.randomIndices.slice(r,r+a)}):19===e?{startIndex:39,count:11,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(39,50)}:20===e?{startIndex:20,count:30,isTestLevel:!0,speedChallenge:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(20,50)}:void 0}function getUnusedWords(e){return gameState.usedWords||(gameState.usedWords=new Set),e.words.map((e,t)=>t).filter(e=>!gameState.usedWords.has(e))}function selectRandomWords(e,t){for(var r=new Set;r.size<t&&e.length>r.size;){var a=Math.floor(Math.random()*e.length);r.add(e[a]),gameState.usedWords.add(e[a])}return Array.from(r)}function generateAnswerChoices(e,t){for(var r=new Set([e]),a=t.translations;r.size<3;){var n=a[Math.floor(Math.random()*a.length)];r.add(n)}return Array.from(r).sort(()=>Math.random()-.5)}function startLevel(t){gameState.currentLevel=t;var e={stage:gameState.currentStage,set:gameState.currentSet,level:t,timestamp:Date.now()},e=(console.log("Setting game context at level start:",e),localStorage.setItem("gameContext",JSON.stringify(e)),currentGame.wrongStreak=0,currentGame.correctAnswers=0,currentGame.levelStartTime=Date.now(),currentGame.firstAttempt=!0,currentGame.streakBonus=!0,updatePerkButtons(),console.log("Current unlocked levels:",gameState.unlockedLevels),gameState.currentStage+"_"+gameState.currentSet),e=(console.log(`Current set key: ${e}, unlocked levels in set:`,gameState.unlockedLevels[e]?Array.from(gameState.unlockedLevels[e]):"none"),document.querySelector(".perks-container")),r=document.querySelector(".powerups-container"),e=(e&&(e.style.display="flex"),r&&(r.style.display="none"),document.querySelector(".coin-count")),r=(e&&(e.textContent=gameState.coins||0),document.querySelector(".coins-container")),e=(r&&(r.style.display="flex"),gameState.currentStage=gameState.currentStage||1,gameState.currentSet=gameState.currentSet||1,gameState.currentLevel=t,console.log(`Starting level: Stage ${gameState.currentStage}, Set ${gameState.currentSet}, Level `+t),addAdminTestButton(),currentUser?currentUser.status:"unregistered");if([2,7,11,15,20].includes(t)&&"premium"!==e){let e=t;if(!currentUser)return showUnregisteredWarning(()=>{proceedWithLevel(e)});if(!localStorage.getItem("upgradeRequested_"+currentUser.id))return showUpgradePrompt(()=>{proceedWithLevel(e)})}21===t?(currentGame.isBossLevel=!0,console.log("Boss level detected"),setTimeout(applyBossLevelStyles,100),setTimeout(applyBossLevelStyles,500)):currentGame.isBossLevel=!1,proceedWithLevel(t,21===t||1===t)}function addAdminTestButton(){console.log("Checking for admin user...");var e=document.getElementById("admin-test-button");e&&e.remove(),console.log("Current user:",currentUser?currentUser.email:"No user"),!currentUser||"admin123@gmail.com"!==currentUser.email&&!currentUser.email?.includes("admin123")?console.log("Not admin user, not adding button"):(console.log("Admin user detected, adding test button"),(e=document.createElement("button")).id="admin-test-button",e.textContent="Jump to Level 20",e.style.cssText=`
    position: fixed;
    top: 80px;
    right: 20px;
    background: #ff5722;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 2000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    font-weight: bold;
  `,e.onclick=function(){console.log("Admin button clicked, jumping to level 20"),startLevel(gameState.currentLevel=21)},document.body.appendChild(e),console.log("Admin test button added to body"))}function findFurthestProgression(){console.log("Finding furthest progression");var e=localStorage.getItem("gameContext");if(e)try{var t=JSON.parse(e);if(t.stage&&t.set&&t.level)return console.log("Found saved game context:",t),{stage:t.stage,set:t.set,level:t.level}}catch(e){console.error("Error parsing saved game context:",e)}return console.log("Current game state:",{currentStage:gameState.currentStage,currentSet:gameState.currentSet,currentLevel:gameState.currentLevel,unlockedSets:Object.fromEntries(Object.entries(gameState.unlockedSets||{}).map(([e,t])=>[e,Array.from(t||[])])),unlockedLevels:Object.fromEntries(Object.entries(gameState.unlockedLevels||{}).map(([e,t])=>[e,Array.from(t||[])])),perfectLevels:Array.from(gameState.perfectLevels||[]),completedLevels:Array.from(gameState.completedLevels||[])}),gameState.currentStage&&gameState.currentSet&&gameState.currentLevel?(console.log(`Using current game state: Stage ${gameState.currentStage}, Set ${gameState.currentSet}, Level `+gameState.currentLevel),{stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel}):(console.log("No progression found, defaulting to beginning"),{stage:1,set:1,level:1})}function proceedWithLevel(e,t=!1){currentGame.restartsRemaining=currentGame.restartsRemaining||2,gameState.currentLevel=e;var r=gameState.currentStage+"_"+gameState.currentSet;let a=vocabularySets[r];r=document.querySelector(".coin-count");r&&(r.textContent=gameState.coins||0,r.style.display="block"),currentGame.startingCoins=gameState.coins,currentGame.startingPerks={...gameState.perks},currentGame.timeBonus=0,currentGame.initialTimeRemaining=null,currentGame.streakBonus=!0,currentGame.levelStartTime=Date.now(),showLevelIntro(e,()=>{setupGameState(calculateWordsForLevel(e,a),a),showScreen("question-screen"),addAdminTestButton(),(21===e?(console.log("Initializing boss level in proceedWithLevel"),initializeBossLevel(),setTimeout(applyBossLevelStyles,200),loadNextBossQuestion):(updateProgressCircle(),loadNextQuestion))(),setTimeout(()=>{startTimer(currentGame.words.length)},200)},t)}function proceedWithLevel(e){currentGame.restartsRemaining||(currentGame.restartsRemaining=2),gameState.currentLevel=e;var t=gameState.currentStage+"_"+gameState.currentSet;let r=vocabularySets[t];t=document.querySelector(".coin-count");t&&(t.textContent=gameState.coins||0,t.style.display="block"),currentGame.startingCoins=gameState.coins,currentGame.startingPerks={...gameState.perks},currentGame.timeBonus=0,currentGame.initialTimeRemaining=null,currentGame.streakBonus=!0,currentGame.levelStartTime=Date.now(),showLevelIntro(e,()=>{setupGameState(calculateWordsForLevel(e,r),r),showScreen("question-screen"),updateProgressCircle(),loadNextQuestion(),setTimeout(()=>{startTimer(currentGame.words.length)},200)})}function setupGameState(e,t){var r,a,n,o,s,i;"object"==typeof e?e.randomIndices?(r=e.randomIndices.map(e=>t.words[e]),a=e.randomIndices.map(e=>t.translations[e]),Object.assign(currentGame,{words:r,translations:a,currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:e.isHebrewToEnglish||!1,mixed:e.mixed||!1,speedChallenge:e.speedChallenge||!1,isBossLevel:e.isBossLevel||!1})):({startIndex:r,count:a,isHebrewToEnglish:n,mixed:o,speedChallenge:s,isBossLevel:i}=e,Object.assign(currentGame,{words:t.words.slice(r,r+a),translations:t.translations.slice(r,r+a),currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:n||!1,mixed:o||!1,speedChallenge:s||!1,isBossLevel:i||!1})):Object.assign(currentGame,{words:t.words.slice(0,e),translations:t.translations.slice(0,e),currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,isBossLevel:!1})}function handleLevelProgression(){currentGame.isBossLevel&&!currentGame.bossRewardApplied&&(currentGame.bossRewardApplied=!0);var e=gameStructure.stages[gameState.currentStage-1],t=gameState.currentLevel===e.levelsPerSet,e=gameState.currentSet===e.numSets,r=currentUser?currentUser.status:"unregistered";t?2<=gameState.currentStage&&1===gameState.currentSet&&"premium"!==r?(localStorage.setItem("completedTrialStage",gameState.currentStage),showScreen("welcome-screen"),setTimeout(()=>{showUpgradePrompt()},500)):e?gameState.currentStage<5?(gameState.currentStage++,startLevel(gameState.currentSet=1)):showScreen("stage-screen"):(gameState.currentSet++,startLevel(1)):startLevel(gameState.currentLevel+1)}function updateNavigationIcons(e){if(["stage-screen","set-screen","level-screen","question-screen"].includes(e)){var t=document.createElement("div"),r=(t.className="screen-nav",document.createElement("button"));if(r.className="home-button",r.innerHTML='<i class="fas fa-home"></i>',r.onclick=()=>showScreen("welcome-screen"),t.appendChild(r),"stage-screen"!==e){var a=document.createElement("button");switch(a.className="back-button",a.innerHTML='<i class="fas fa-arrow-left"></i>',e){case"set-screen":a.onclick=()=>showScreen("stage-screen");break;case"level-screen":a.onclick=()=>showSetScreen(gameState.currentStage);break;case"question-screen":a.onclick=()=>stopLevelAndGoBack()}t.appendChild(a)}document.getElementById(e).appendChild(t)}}function updateProgressCircle(){var e=document.querySelector(".progress-circle .progress"),t=2*Math.PI*54,r=currentGame.currentIndex/currentGame.words.length;e.style.strokeDasharray=t+" "+t,e.style.strokeDashoffset=t*(1-r),r<=.25?(t=Math.floor(4*r*30),e.style.stroke=`hsl(${t}, 100%, 45%)`):r<=.5?(t=30+Math.floor(4*(r-.25)*40),e.style.stroke=`hsl(${t}, 100%, 45%)`):r<=.75?(t=70+Math.floor(4*(r-.5)*40),e.style.stroke=`hsl(${t}, 100%, 40%)`):(t=110+Math.floor(4*(r-.75)*30),e.style.stroke=`hsl(${t}, 100%, 40%)`)}function loadNextQuestion(){if(document.querySelectorAll(".buttons button").forEach(e=>{e.classList.remove("correct","wrong")}),!(currentGame.currentIndex>=currentGame.words.length)){let e=document.getElementById("question-word");var n=[3,6,9,10,13,16,19,20,21].includes(gameState.currentLevel)&&Math.random()<.5,o=currentGame.currentIndex;let t=(n?currentGame.translations:currentGame.words)[o],r=(n?currentGame.words:currentGame.translations)[o];for(var s=n?currentGame.words:currentGame.translations,i=new Set([r]);i.size<3;){var l=s[Math.floor(Math.random()*s.length)];l!==r&&i.add(l)}let a=document.getElementById("buttons");a.innerHTML="",Array.from(i).sort(()=>Math.random()-.5).forEach(e=>{var t=document.createElement("button");t.textContent=e,t.onclick=()=>handleAnswer(e===r),a.appendChild(t)}),0<currentGame.currentIndex?(e.classList.add("exiting"),setTimeout(()=>{e.textContent=t,e.classList.remove("exiting"),e.classList.add("entering"),setTimeout(()=>{e.classList.remove("entering")},500)},500)):(e.textContent=t,e.classList.add("entering"),setTimeout(()=>{e.classList.remove("entering")},500))}}function showBossVictoryScreen(){console.log("Boss victory screen function called - redirecting to new implementation"),showBossDefeatEffect()}function addAdminTestingButton(){var e,t;currentUser&&"admin123@gmail.com"===currentUser.email&&(e=document.getElementById("question-screen"),document.getElementById("admin-test-button")||((t=document.createElement("button")).id="admin-test-button",t.innerHTML="Jump to Level 20",t.style.cssText=`
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #ff5722;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  `,t.onclick=function(){startLevel(gameState.currentLevel=20)},e.appendChild(t)))}function awardTimeBonus(){var e=(Date.now()-currentGame.questionStartTime)/1e3;return e<10?(e=Math.floor(10-e),currentGame.timeBonus+=e,e):0}function pulseCoins(a=1){document.querySelectorAll(".coin-icon").forEach(e=>{let t=0,r=()=>{e.classList.add("coin-pulse"),setTimeout(()=>{e.classList.remove("coin-pulse"),++t<a&&setTimeout(r,100)},500)};r()})}function updateAllCoinDisplays(){document.querySelectorAll(".coin-count").forEach(e=>{var t=parseInt(e.textContent)||0;let r;r=window.location.pathname.includes("arcade")?currentGame.coins||0:gameState.coins||0,animateNumber(e,Number(t),Number(r))})}function eliminateWrongAnswer(){var e=document.querySelectorAll(".buttons button");let t=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[currentGame.currentIndex];var e=Array.from(e).filter(e=>e.textContent!==t);0<e.length&&((e=e[Math.floor(Math.random()*e.length)]).disabled=!0,e.style.opacity="0.5")}function revealCorrectAnswer(){let t=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[currentGame.currentIndex];document.querySelectorAll(".buttons button").forEach(e=>{e.textContent===t?(e.classList.add("correct"),setTimeout(()=>{(currentGame.isCustomPractice?handleCustomPracticeAnswer:handleAnswer)(!0)},1e3)):(e.disabled=!0,e.style.opacity="0.5")})}function buyPerk(e){var r=PERK_CONFIG[e];if(r)if(!r.requiresPremium||currentUser&&"premium"===currentUser.status){if(r.requiresWordCount)if((parseInt(document.getElementById("totalWords").textContent)||0)<r.requiresWordCount)return void showNotification(`Need ${r.requiresWordCount} words to unlock!`,"error");if(gameState.coins<r.cost)showNotification(`Need ${r.cost} coins!`,"error");else{switch(gameState.coins-=r.cost,updateAllCoinDisplays(),e){case"timeFreeze":isFrozen=!0,showNotification("Time frozen for 5 seconds!","success"),setTimeout(()=>{isFrozen=!1},r.duration);break;case"skip":(currentGame.isCustomPractice?handleCustomPracticeAnswer:handleAnswer)(!0,!0);break;case"clue":var a=document.querySelectorAll(".buttons button");let t=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[currentGame.currentIndex];var a=Array.from(a).filter(e=>e.textContent!==t);0<a.length&&((a=a[Math.floor(Math.random()*a.length)]).disabled=!0,a.style.opacity="0.5");break;case"reveal":revealCorrectAnswer();break;case"rewind":timeRemaining=Math.min(currentGame.totalTime,timeRemaining+5),updateTimerDisplay(),updateTimerCircle(timeRemaining,currentGame.totalTime),showNotification("Time rewind! +5 seconds","success")}saveProgress()}}else showNotification("Premium feature only!","error")}function animateNumberChange(n,e,o){if(n){let t=(o-e)/20,r=0,a=e;requestAnimationFrame(function e(){r++,a+=t,r<=20?(n.textContent=Math.round(a),requestAnimationFrame(e)):n.textContent=o})}}function handleLevelCompletion(){var e,t,r;clearTimer(),currentGame.isBossLevel?(currentGame.bossRewardApplied?(console.log("Boss already defeated and rewarded, just showing effects"),restoreFromBossLevel()):(console.log("First boss defeat, applying reward"),restoreFromBossLevel(),currentGame.bossRewardApplied=!0),showBossDefeatEffect()):(e=`${gameState.currentStage}_${gameState.currentSet}_`+gameState.currentLevel,console.log("Completing level: "+e),e=gameState.perfectLevels.has(e)||gameState.completedLevels.has(e),console.log("Level was previously completed: "+e),t=currentGame.streakBonus&&currentGame.correctAnswers===currentGame.words.length,!e&&t?CoinsManager.updateCoins(5).then(()=>{updateLevelProgress(gameState.currentStage,gameState.currentSet,gameState.currentLevel,!0,!0);var e=document.getElementById("question-screen").getBoundingClientRect();createParticles(e.left+e.width/2,e.top+e.height/2)}):e||updateLevelProgress(gameState.currentStage,gameState.currentSet,gameState.currentLevel,!0,!1),pulseCoins(5),updatePerkButtons(),t=gameStructure.stages[gameState.currentStage-1],e=gameState.currentLevel===t.levelsPerSet,t=gameState.currentSet===t.numSets,r=currentUser?currentUser.status:"unregistered",e?(checkSetCompletion(gameState.currentStage,gameState.currentSet),t?"premium"===r&&gameState.currentStage<5?setTimeout(()=>{gameState.currentStage++,gameState.currentSet=1,startLevel(gameState.currentLevel=1)},1500):setTimeout(()=>showScreen("stage-cascade-screen"),1500):setTimeout(()=>{gameState.currentSet++,startLevel(gameState.currentLevel=1)},1500)):setTimeout(()=>{gameState.currentLevel++,startLevel(gameState.currentLevel)},1500))}function checkSetCompletion(t,r){var a=gameStructure.stages[t-1].levelsPerSet;let n=0;for(let e=1;e<=a;e++){var o=t+`_${r}_`+e;(gameState.completedLevels.has(o)||gameState.perfectLevels.has(o))&&n++}console.log(`Set ${t}-${r} completion: ${n}/`+a),n===a&&(console.log(`Set ${t}-${r} is complete. Unlocking next set.`),unlockNextSet())}function handleProgression(e){var t=gameState.currentStage+"_"+gameState.currentSet,r=(gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set),gameState.unlockedLevels[t].add(gameState.currentLevel),gameStructure.stages[gameState.currentStage-1]);let a=gameState.currentLevel===r.levelsPerSet,n=gameState.currentSet===r.numSets;a?n?gameState.currentStage<5&&unlockNextStage():unlockNextSet():gameState.unlockedLevels[t].add(gameState.currentLevel+1),saveProgress(),updateAllCoinDisplays(),setTimeout(()=>{a?n?gameState.currentStage<5?(gameState.currentStage++,startLevel(gameState.currentSet=1)):showScreen("stage-screen"):(gameState.currentSet++,startLevel(1)):startLevel(gameState.currentLevel+1)},1500)}function createCompletionParticles(){var e=document.getElementById("question-screen").getBoundingClientRect();let t=e.left+e.width/2,r=e.top+e.height/2;for(let e=0;e<5;e++)setTimeout(()=>createParticles(t,r),300*e)}function activatePerk(t,e){var r=powerupCooldowns.get(t)||0;let a=Date.now();a-r<5e3?showNotification("Perk is on cooldown","warning"):CoinsManager.updateCoins(-e).then(e=>{e?(gameState.perks[t]++,saveProgress(),updatePerkButtons(),usePerk(t),powerupCooldowns.set(t,a),showNotification(t+" activated!","success")):showNotification("Not enough coins","error")}).catch(e=>{console.error("Perk activation failed:",e),showNotification("Failed to activate perk","error")})}function initializeParticles(c=document.body){let d=(c=c instanceof HTMLElement?c:document.body).querySelector(".particle-container"),u=(d||((d=document.createElement("div")).classList.add("particle-container"),c.appendChild(d)),[..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",..."ΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟΠΡΣΤΥΦΧΨΩαβγδεζηθικλμνξοπρστυφχψω",..."אבגדהוזחטיכלמנסעפצקרשת"]);function t(){let e=document.createElement("div");e.classList.add("letter-particle"),e.textContent=u[Math.floor(Math.random()*u.length)];var t=Math.random()*c.clientWidth,r=Math.random()*c.clientHeight,a=200*Math.random()-100,n=200*Math.random()-100,o=12+16*Math.random(),s=.2+.3*Math.random(),i=180*Math.random(),l=8+10*Math.random();e.style.cssText=`
            position: absolute;
            left: ${t}px;
            top: ${r}px;
            font-size: ${o}px;
            animation: letterFloat ${l}s ease-in-out forwards;
            --moveX: ${a}px;
            --moveY: ${n}px;
            --opacity: ${s};
            --rotate: ${i}deg;
            pointer-events: none;
        `,d.appendChild(e),setTimeout(()=>{d.removeChild(e)},1e3*l)}for(let e=0;e<50;e++)t();var e=setInterval(t,1e3);d.dataset.intervalId=e}function stopLevelAndGoBack(){clearTimer(),isFrozen=!1;let t=document.createElement("div");t.className="simple-level-transition",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";for(let e=0;e<3;e++){var r=document.createElement("div");r.className="light-streak",r.style.top=20+25*e+"%",r.style.animationDelay=.2*e+"s",t.appendChild(r)}var e=document.createElement("div");e.className="level-announcement simple",e.style.position="relative",e.innerHTML=`
    <div class="level-number">
      <i class="fas fa-check-circle" style="color: var(--gold); font-size: 2rem;"></i>
    </div>
    <div class="level-text">Session Complete</div>
  `,t.appendChild(e),document.body.appendChild(t),gameState.sessionStartTime=null,currentGame={words:[],translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,timeBonus:0,initialTimeRemaining:null,streakBonus:!0,restartsRemaining:null},setTimeout(()=>{t.classList.add("fade-out"),setTimeout(()=>{document.body.removeChild(t),showScreen("welcome-screen")},300)},1200)}function showGameOverOverlay(){clearTimer();let e=document.querySelector(".failure-overlay");e.querySelector(".failure-title").textContent="Game Over!",e.style.display="flex",setTimeout(()=>{e.classList.add("show")},100),document.querySelector(".restart-button").onclick=()=>{e.classList.remove("show"),setTimeout(()=>{e.style.display="none",currentGame.isCustomPractice?startCustomLevel(currentGame.practiceState.currentLevel,currentGame.practiceState):startLevel(gameState.currentLevel)},1e3)},document.querySelector(".home-button").onclick=()=>{e.classList.remove("show"),setTimeout(()=>{e.style.display="none",showScreen("welcome-screen")},1e3)}}function updateTimerCircle(e,t){var r,a=document.querySelector(".timer-progress");a&&(r=2*Math.PI*40,a.style.strokeDasharray=r+" "+r,a.style.strokeDashoffset=r*(1-e/t),e<=10?a.classList.add("warning"):a.classList.remove("warning"))}function handleResetProgress(){if(isFirstResetAttempt){let e=document.querySelector(".reset-button");e.classList.add("warning"),isFirstResetAttempt=!1,setTimeout(()=>{e.classList.remove("warning")},1e3),resetProgressTimeout&&clearTimeout(resetProgressTimeout),resetProgressTimeout=setTimeout(()=>{isFirstResetAttempt=!0},1e4)}else gameState.currentStage=1,gameState.currentSet=1,gameState.currentLevel=1,gameState.coins=0,gameState.unlockedSets={1:new Set([1])},gameState.unlockedLevels={"1_1":new Set([1])},gameState.perfectLevels=new Set,gameState.completedLevels=new Set,localStorage.removeItem("simploxProgress"),localStorage.removeItem("simploxCustomCoins"),updatePerkButtons(),updateAllCoinDisplays(),showScreen("welcome-screen"),isFirstResetAttempt=!0}function toggleFullScreen(){var e=document.documentElement;let t=document.querySelector(".vertical-nav-container .fullscreen-button i");document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().then(()=>{t&&(t.classList.remove("fa-compress"),t.classList.add("fa-expand"))}).catch(e=>{console.log("Error attempting to exit fullscreen: "+e.message)}):e.requestFullscreen&&e.requestFullscreen().then(()=>{t&&(t.classList.remove("fa-expand"),t.classList.add("fa-compress"))}).catch(e=>{console.log("Error attempting to enable fullscreen: "+e.message)})}async function handleLogout(){try{var e=(await supabaseClient.auth.signOut()).error;e&&console.error("Supabase logout error:",e.message),currentUser=null,updateAuthUI(),showScreen("welcome-screen"),initializeGame()}catch(e){console.error("Unexpected error during logout:",e)}}function handleRestartLevel(){var e;currentGame.restartsRemaining<=0||(e=document.querySelector(".navigation-button.restart-level"),currentGame.restartsRemaining--,1===currentGame.restartsRemaining?e.style.opacity="0.7":0===currentGame.restartsRemaining&&(e.classList.add("disabled"),e.onclick=null,e.disabled=!0),gameState.coins=currentGame.startingCoins,gameState.perks={...currentGame.startingPerks},updatePerkButtons(),updateAllCoinDisplays(),saveProgress(),startLevel(gameState.currentLevel))}function showStagesFromMenu(){showScreen("stage-screen")}function findFurthestProgression(){var e=localStorage.getItem("gameContext");if(e)try{var t=JSON.parse(e);if(t.stage&&t.set&&t.level)return console.log("Resuming from saved context:",t),{stage:t.stage,set:t.set,level:t.level}}catch(e){console.error("Error parsing saved context:",e)}var r=parseInt(localStorage.getItem("preferredStage"));console.log("Finding furthest progression"),console.log("Current unlocked sets:",gameState.unlockedSets),console.log("Current unlocked levels:",gameState.unlockedLevels),console.log("Completed levels:",Array.from(gameState.completedLevels)),console.log("Perfect levels:",Array.from(gameState.perfectLevels));let a=null,n=-1;var o,s=(e,t,r)=>{var a=e+`_${t}_`+r,e=e+"_"+t,t=gameState.unlockedLevels[e]?.has(r),e=!gameState.completedLevels.has(a)&&!gameState.perfectLevels.has(a);return t&&e};if(r&&1<=r&&r<=5){console.log("Checking preferred stage: "+r);for(let e=1;e<=gameStructure.stages[r-1].numSets;e++){var i=r+"_"+e;if(gameState.unlockedLevels[i]){var l,c,d=Array.from(gameState.unlockedLevels[i]).sort((e,t)=>t-e);console.log(`Checking set ${i}, unlocked levels:`,d);for(l of d)s(r,e,l)&&(c=calculateRank(r,e,l))>n&&(n=c,a={stage:r,set:e,level:l},console.log(`Found candidate in preferred stage: ${r}-${e}-`+l))}}}if(!a)for(let e=1;e<=5;e++)if(gameState.unlockedSets[e])for(o of Array.from(gameState.unlockedSets[e]).sort((e,t)=>t-e)){var u,m,g=e+"_"+o;if(gameState.unlockedLevels[g])for(u of Array.from(gameState.unlockedLevels[g]).sort((e,t)=>t-e))s(e,o,u)&&(m=calculateRank(e,o,u))>n&&(n=m,a={stage:e,set:o,level:u},console.log(`Found candidate: ${e}-${o}-`+u))}return a?(console.log("Found furthest progress:",a),a):r&&1<=r&&r<=5?{stage:r,set:1,level:1}:{stage:1,set:1,level:1}}function startGame(){if(console.log("Starting game"),hasExistingProgress()){var e=localStorage.getItem("gameContext");if(e)try{var t=JSON.parse(e);if(t.stage&&t.set&&t.level)return console.log("Found saved game context:",t),gameState.currentStage=t.stage,gameState.currentSet=t.set,gameState.currentLevel=t.level,void startLevel(gameState.currentLevel)}catch(e){console.error("Error parsing game context:",e)}console.log("Using current game state:",{stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel}),startLevel(gameState.currentLevel)}else console.log("No existing progress found, showing grade selector"),showGradeLevelSelector()}function updateLevelProgress(e,t,r,a,n){var o=e+`_${t}_`+r,n=(n?(gameState.perfectLevels.add(o),gameState.completedLevels.add(o)):a&&gameState.completedLevels.add(o),e+"_"+t),o=(gameState.unlockedLevels[n]||(gameState.unlockedLevels[n]=new Set),gameState.unlockedLevels[n].add(r),r+1),r=r===gameStructure.stages[e-1].levelsPerSet;r||(gameState.unlockedLevels[n].add(o),console.log(`Unlocked next level: ${o} in set `+n)),r&&a&&checkSetCompletion(e,t),saveProgress()}function checkSetCompletion(t,r){var a=gameStructure.stages[t-1].levelsPerSet;let n=0;for(let e=1;e<=a;e++){var o=t+`_${r}_`+e;(gameState.completedLevels.has(o)||gameState.perfectLevels.has(o))&&n++}console.log(`Set ${t}-${r} completion: ${n}/`+a),n===a&&(console.log(`Set ${t}-${r} is complete. Unlocking next set.`),unlockNextSet())}function unlockNextSet(){var e=gameState.currentStage,t=gameState.currentSet,r=gameStructure.stages[e-1];r?t<r.numSets?(r=t+1,gameState.unlockedSets[e]||(gameState.unlockedSets[e]=new Set),gameState.unlockedSets[e].add(r),t=e+"_"+r,gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set),gameState.unlockedLevels[t].add(1),console.log(`Unlocked set ${e}-${r} and its first level`),saveProgress()):e<5&&unlockNextStage():console.error("Invalid stage: "+e)}function unlockNextStage(){var e,t=gameState.currentStage;t<5&&(t=t+1,gameState.unlockedSets[t]||(gameState.unlockedSets[t]=new Set),gameState.unlockedSets[t].add(1),e=t+"_1",gameState.unlockedLevels[e]||(gameState.unlockedLevels[e]=new Set),gameState.unlockedLevels[e].add(1),console.log(`Unlocked stage ${t}, set 1, level 1`),saveProgress())}function showLevelIntro(a,n,o=!1){if(!gameState.sessionStartTime||18e5<Date.now()-gameState.sessionStartTime||o){var o=[3,6,9,10,13,16,19,20].includes(a),s=21===a;let e=s?"boss-level":o?"test-level":"normal-level",t=document.createElement("div"),r=(t.className="level-transition",currentGame&&currentGame.isCustomPractice?currentGame.mixed?t.innerHTML=`
        <div class="level-announcement ${e}">
          <h1>Test Challenge</h1>
          <h2>Combined Words Review</h2>
          <div class="test-badge">Review Challenge</div>
        </div>
      `:t.innerHTML=`
        <div class="level-announcement ${e}">
          <h1>Round ${a}</h1>
          <h2>Custom Practice</h2>
          ${o?'<div class="test-badge">Review Challenge</div>':""}
        </div>
      `:t.innerHTML=`
      <div class="level-announcement ${e}">
        <h1>${s?"BOSS FIGHT!":"Stage "+gameState.currentStage}</h1>
        <h2>${s?"FINAL CHALLENGE":`Level ${gameState.currentSet}-`+a}</h2>
        ${o?'<div class="test-badge">Review Challenge</div>':""}
        ${s?'<div class="boss-badge">DANGER ZONE</div>':""}
      </div>
    `,document.body.appendChild(t),t.querySelector(".level-announcement"));t.offsetHeight,t.classList.add("show"),r.classList.add("show"),s&&(o=t.querySelector(".level-announcement"))&&(o.style.background="linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)",o.style.boxShadow="0 0 30px rgba(255, 0, 0, 0.5)",s=o.querySelector("h1"))&&(s.style.color="#ffffff",s.style.textShadow="0 0 20px rgba(255, 0, 0, 0.8)"),setTimeout(()=>{n(),t.classList.remove("show"),r.classList.remove("show"),setTimeout(()=>{document.body.removeChild(t)},400)},1500)}else{let t=document.createElement("div");t.className="simple-level-transition",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";for(let e=0;e<3;e++){var r=document.createElement("div");r.className="light-streak",r.style.top=20+25*e+"%",r.style.animationDelay=.2*e+"s",t.appendChild(r)}o=document.createElement("div");o.className="level-announcement simple",o.style.position="relative";let e=document.createElement("div");e.className="transition-progress",currentGame&&currentGame.isCustomPractice?currentGame.mixed?o.innerHTML=`
          <div class="level-number">Test</div>
          <div class="level-text">Review Challenge</div>
        `:o.innerHTML=`
          <div class="level-number">Round ${a}</div>
          <div class="level-text">Custom Practice</div>
        `:o.innerHTML=`
        <div class="level-number">${a}</div>
        <div class="level-text">Stage ${gameState.currentStage} - Set ${gameState.currentSet}</div>
      `,o.appendChild(e),t.appendChild(o),document.body.appendChild(t),setTimeout(()=>{e.style.width="100%"},50),void setTimeout(()=>{t.classList.add("fade-out"),setTimeout(()=>{n(),document.body.removeChild(t)},300)},800)}}document.addEventListener("DOMContentLoaded",function(){document.getElementById("question-screen").classList.contains("visible")&&(console.log("Question screen is visible on load, adding admin button"),addAdminTestButton()),setTimeout(()=>{currentUser&&"admin123@gmail.com"===currentUser.email&&(console.log("Admin user detected on page load"),addAdminTestButton())},2e3)}),document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".home-button").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),showScreen("welcome-screen",!0)})})}),document.addEventListener("fullscreenchange",function(){document.fullscreenElement||console.log("Exited full-screen")}),document.querySelector(".perks-container").innerHTML=`
    ${Object.entries(PERK_CONFIG).map(([e,t])=>`
        <button class="perk-button" id="${e}Perk" onclick="buyPerk('${e}')">
            <i class="fas ${t.icon} perk-icon"></i>
            <span class="perk-count">0</span>
        </button>
    `).join("")}
`,window.onload=async()=>{await checkExistingSession(),initializeGame(),updatePerkButtons(),initializeParticles(document.getElementById("welcome-screen")),await loadCustomLists()};let customPracticeLists={lists:[],currentList:null,maxLists:5};function addCustomWordList(e=null){if(customPracticeLists.lists.length>=customPracticeLists.maxLists)return alert(`You can only create up to ${customPracticeLists.maxLists} custom lists.`),null;e=e||"List "+(customPracticeLists.lists.length+1);e={id:Date.now(),name:e,words:[],translations:[]};return customPracticeLists.lists.push(e),saveCustomLists(),e}function translateWord(t){var e=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(t)}&langpair=en|he`;return fetch(e).then(e=>e.json()).then(e=>e.responseData.translatedText||t).catch(()=>t)}function trackListPlay(e){var t="listPlays_"+e,r=parseInt(localStorage.getItem(t)||"0"),a=(r++,getUserListLimits());return localStorage.setItem(t,r),r>=a.maxPlays?(deleteCustomList(e),!1):a.maxPlays-r}function toggleAuthMode(){var e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function updateLocalSharedLists(e){currentUser&&(customPracticeLists.lists.push({id:e.local_id,supabaseId:e.id,name:e.name,words:e.words,translations:e.translations,is_shared:!0,shared_by:e.shared_by}),saveCustomLists())}async function debugShareList(t,e){try{var r,a,n,o;return console.log("Debug share function called with:",{listId:t,recipientId:e}),CustomListsManager.lists.find(e=>String(e.id)===String(t))?({data:r,error:a}=await supabaseClient.from("custom_lists").insert({user_id:e,name:"Shared list",words:["test"],translations:["test"],is_shared:!0}),a?(console.error("Debug share error:",a),{data:n,error:o}=await supabaseClient.from("information_schema.tables").select("table_name").eq("table_schema","public"),o?console.error("Error fetching tables:",o):console.log("Available tables:",n),!1):(console.log("Debug share success:",r),!0)):(console.error("List not found for debug sharing"),!1)}catch(e){return console.error("Debug share exception:",e),!1}}async function shareListWithUser(t,e){try{if(console.log("Sharing list:",t,"with user:",e),!currentUser)return console.error("No current user - cannot share list"),!1;var r=CustomListsManager.lists.find(e=>String(e.id)===String(t));if(!r)return console.error("List not found for sharing:",t),!1;console.log("Found list to share:",r.name);var a=(await supabaseClient.from("custom_lists").insert({user_id:e,name:`${r.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,words:r.words||[],translations:r.translations||[],is_shared:!0,shared_with:[e],shared_by:currentUser.id,created_at:(new Date).toISOString(),status:"active"})).error;return a?(console.error("Error sharing list:",a),!1):(console.log("List shared successfully"),showNotification("List shared successfully!","success"),closeShareModal(),!0)}catch(e){return console.error("Error in shareListWithUser:",e),showNotification("Error sharing list","error"),!1}}function showSuccessToast(e){let t=document.createElement("div");t.className="toast success",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("hide"),setTimeout(()=>document.body.removeChild(t),600)},3e3)}function showErrorToast(e){let t=document.createElement("div");t.className="toast error",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("hide"),setTimeout(()=>document.body.removeChild(t),600)},3e3)}function closeShareModal(){var e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}async function loadSharedLists(){var e,t;return currentUser?({data:e,error:t}=await supabaseClient.from("custom_lists").select("*").or(`shared_with.cs.{${currentUser.id}},is_shared.eq.true`),t?(console.error("Error loading shared lists:",t),[]):e.map(e=>({...e,isShared:!0}))):[]}function showShareModal(a){console.log("Opening share modal for list:",a);var e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop"),e=(e&&e.remove(),t&&t.remove(),document.createElement("div"));e.className="modal-backdrop",e.onclick=closeShareModal,document.body.appendChild(e);let r=document.createElement("div"),n=(r.className="share-modal",r.innerHTML=`
        <h3 class="share-modal-header">Share List</h3>
        <div class="users-list">Loading users...</div>
        <button class="start-button modal-close" onclick="closeShareModal()">Cancel</button>
    `,document.body.appendChild(r),r.querySelector(".users-list"));supabaseClient.from("user_profiles").select("id, username").neq("id",currentUser.id).then(({data:e,error:t})=>{t?(console.error("Error fetching users:",t),n.innerHTML='<div class="user-item"><span>Error loading users</span></div>'):e&&0!==e.length?(n.innerHTML=e.map(e=>`
                <div class="user-item">
                    <span>${e.username||"Unnamed User"}</span>
                    <button class="main-button small-button share-with-user-btn" data-user-id="${e.id}">
    <i class="fas fa-share-alt"></i> Share
</button>
                </div>
            `).join(""),r.querySelectorAll(".share-with-user-btn").forEach(r=>{r.onclick=async()=>{var e=r.getAttribute("data-user-id"),t=(r.disabled=!0,r.innerHTML),e=(r.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sharing...',await shareListWithUser(a,e));e||(r.disabled=!1,r.innerHTML=t)}})):n.innerHTML='<div class="user-item"><span>No other users available</span></div>'})}function closeShareModal(){var e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}function handleProgressionAfterCompletion(e){var t;!e&&currentGame.streakBonus?(gameState.coins+=5,pulseCoins(5),e=gameState.currentStage+"_"+gameState.currentSet,gameState.unlockedLevels[e]||(gameState.unlockedLevels[e]=new Set),gameState.unlockedLevels[e].add(gameState.currentLevel),e=gameStructure.stages[gameState.currentStage-1],t=gameState.currentLevel===e.levelsPerSet,e=gameState.currentSet===e.numSets,t?e?showScreen("stage-screen"):(gameState.currentSet++,startLevel(1)):startLevel(gameState.currentLevel+1),saveProgress()):startLevel(gameState.currentLevel)}function hideUpgradePrompt(){let e=document.querySelector(".upgrade-prompt");e&&(e.classList.remove("show"),setTimeout(()=>e.remove(),300))}function showUpgradePrompt(e){var t;currentUser?((t={screen:document.querySelector(".screen.visible")?.id,stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel}).screen&&localStorage.setItem("gameContext",JSON.stringify(t)),currentUser&&localStorage.removeItem("upgradeRequested_"+currentUser.id),showScreen("upgrade-screen")):(console.log("Unregistered user attempting to access premium content"),showAuthModal(),setTimeout(()=>{var e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))},100))}function hideUpgradePrompt(){let e=document.querySelector(".upgrade-prompt");var t=document.querySelector(".modal-backdrop");e&&(e.classList.remove("show"),setTimeout(()=>e.remove(),300)),t&&t.remove()}function hideUpgradePromptAndContinue(){isFrozen=!1,clearTimer(),document.querySelectorAll(".confirmation-popup").forEach(e=>{e&&e.remove()});var e=document.getElementById("upgrade-screen");e&&e.classList.contains("visible")&&e.classList.remove("visible"),showScreen("welcome-screen")}function handleUpgradeClick(){hideUpgradePrompt(),showPaymentScreen()}async function checkUserAccess(){var e,t;return currentUser?({data:e,error:t}=await supabaseClient.from("user_profiles").select("status, payment_pending").eq("id",currentUser.id).single(),t?null:e.payment_pending||"free"===e.status||"pending"===e.status?{fullAccess:!1,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}:"premium"===e.status?{fullAccess:!0,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}:void 0):{fullAccess:!1,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}}function toggleAuthMode(){var e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function showSetScreen(t){gameState.currentStage=t,showStageCascadeScreen(),setTimeout(()=>{var e=document.querySelector(`.stage-wrapper[data-stage="${t}"]`);e&&!e.classList.contains("open")&&e.classList.add("open")},100)}function showUnregisteredWarning(r){if(window.unregisteredWarningShown)r&&r();else{window.unregisteredWarningShown=!0;let e=document.createElement("div"),t=(e.className="fullscreen-signup-page",e.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: 2rem;
        animation: fadeIn 0.3s ease-in-out;
    `,e.innerHTML=`
        <div class="signup-header" style="width: 100%; display: flex; justify-content: flex-start; margin-bottom: 2rem;">
            <button class="skip-signup-button" style="
                background: rgba(255,255,255,0.15);
                border: none;
                color: var(--text);
                padding: 0.75rem 1.5rem;
                border-radius: 50px;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
            ">
                Skip
            </button>
        </div>
        
        <div class="signup-content" style="
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 600px;
            width: 100%;
        ">
            <h2 style="
                font-size: 2rem;
                color: var(--gold);
                margin-bottom: 1.5rem;
                animation: floatAnimation 3s ease-in-out infinite;
            ">Save Your Progress!</h2>
            
            <p style="
                font-size: 1.2rem;
                line-height: 1.6;
                margin-bottom: 2rem;
                color: var(--text);
            ">Create a free account to track your vocabulary progress, earn rewards, and unlock more advanced content</p>
            
            <div class="features-list" style="
                display: flex;
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 3rem;
                text-align: left;
            ">
                <div class="feature-item" style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                ">
                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>
                    <span>Track your learning progress</span>
                </div>
                <div class="feature-item" style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                ">
                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>
                    <span>Practice custom word lists</span>
                </div>
                <div class="feature-item" style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                ">
                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>
                    <span>Earn coins for premium content</span>
                </div>
            </div>
        </div>
        
        <div class="signup-footer" style="
            width: 100%;
            display: flex;
            justify-content: center;
            padding-bottom: 2rem;
        ">
            <button class="signup-now-button" style="
                background: var(--gold);
                color: var(--primary-dark);
                border: none;
                padding: 1.25rem 3rem;
                border-radius: 50px;
                font-size: 1.2rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
                animation: pulseAnimation 1.5s infinite ease-in-out;
            ">
                Sign Up Now
            </button>
        </div>
    `,document.body.appendChild(e),document.createElement("style"));t.textContent=`
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes floatAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes pulseAnimation {
            0%, 100% { transform: scale(1); box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4); }
        }
    `,document.head.appendChild(t);var a=e.querySelector(".skip-signup-button"),n=e.querySelector(".signup-now-button");a.addEventListener("click",function(){document.body.removeChild(e),t.parentNode&&t.parentNode.removeChild(t),r&&r()}),n.addEventListener("click",function(){document.body.removeChild(e),t.parentNode&&t.parentNode.removeChild(t),showScreen("welcome-screen"),setTimeout(function(){var e,t=document.getElementById("authModal");t&&(t.classList.add("show"),t=document.getElementById("signupForm"),e=document.getElementById("loginForm"),t)&&e&&(t.classList.remove("hidden"),e.classList.add("hidden"))},100)})}}function toggleParentPhone(){var e=document.getElementById("isAdult").checked,t=document.getElementById("parentPhoneGroup"),r=document.getElementById("parentPhone");t.style.display=e?"none":"block",r.required=!e}function showUpgradeScreen(){localStorage.getItem("upgradeRequested_"+currentUser.id)?hideUpgradePromptAndContinue():showScreen("upgrade-screen")}document.addEventListener("DOMContentLoaded",function(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.querySelectorAll(".fa-crown").forEach(e=>{e.addEventListener("click",function(e){e.stopPropagation(),showScreen("upgrade-screen")})})})})}).observe(document.body,{childList:!0,subtree:!0})});class RateLimiter{constructor(e=0,t){this.requests=new Map}checkLimit(e){let t=Date.now();var r=(this.requests.get(e)||[]).filter(e=>t-e<this.timeWindow);return!(r.length>=this.maxRequests||(r.push(t),this.requests.set(e,r),0))}}function sanitizeInput(e){return e.replace(/[<>]/g,"").trim().slice(0,500)}let SessionManager={maxInactiveTime:18e5,lastActivity:Date.now(),init(){document.addEventListener("click",()=>this.updateActivity()),document.addEventListener("keypress",()=>this.updateActivity()),setInterval(()=>this.checkSession(),6e4)},updateActivity(){this.lastActivity=Date.now()},async checkSession(){Date.now()-this.lastActivity>this.maxInactiveTime&&(await handleLogout(),modalSystem.show("timeout",{title:"Session Expired",message:"Please log in again"}))}},DataValidator={validateGameProgress(e){return{...e,coins:Math.min(e.coins,1e5),perks:Object.fromEntries(Object.entries(e.perks).map(([e,t])=>[e,Math.min(t,100)]))}},validateCustomList(e){return{...e,words:e.words.slice(0,1e3).map(sanitizeInput),translations:e.translations.slice(0,1e3).map(sanitizeInput)}}};function escapeHTML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function createListItem(e){return`
        <div class="list-item">
            <h3>${escapeHTML(e.name)}</h3>
            <p>${escapeHTML(e.description)}</p>
        </div>
    `}let ErrorHandler={async logError(e,t){currentUser&&await supabaseClient.from("error_logs").insert([{user_id:currentUser.id,error:e.message,stack:e.stack,context:t,timestamp:new Date}]),console.error(t+":",e)},handleError(e,t){this.logError(e,t),modalSystem.show("error",{title:"Oops!",message:"Something went wrong. Please try again."})}};function toggleParentFields(){var e=document.getElementById("isAdult").checked,t=document.getElementById("parentInfoSection"),r=document.getElementById("adultInfoSection"),a=t.querySelectorAll("input"),n=r.querySelectorAll("input");e?(t.style.display="none",r.style.display="block",a.forEach(e=>e.required=!1),n.forEach(e=>e.required=!0)):(t.style.display="block",r.style.display="none",a.forEach(e=>e.required=!0),n.forEach(e=>e.required=!1))}function continueAfterUpgrade(){console.log("continueAfterUpgrade called");let e=document.querySelector(".confirmation-popup");e&&(e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.7)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300));var t=document.getElementById("upgrade-screen"),t=(t&&t.classList.remove("visible"),document.getElementById("upgradeForm"));t&&t.reset(),localStorage.removeItem("gameContext"),hideUpgradePromptAndContinue(),showScreen("welcome-screen"),console.log("Upgrade process completed, redirected to welcome screen")}function checkPopupStatus(){var e=document.querySelectorAll(".confirmation-popup");0===e.length?console.log("No confirmation popups found in the DOM"):e.forEach((e,t)=>{console.log(`Popup ${t+1}:`,{visibility:window.getComputedStyle(e).visibility,opacity:window.getComputedStyle(e).opacity,display:window.getComputedStyle(e).display,zIndex:window.getComputedStyle(e).zIndex,transform:window.getComputedStyle(e).transform,position:window.getComputedStyle(e).position})})}function skipUpgrade(){hideUpgradePromptAndContinue()}function updateUserStatusDisplay(e){var t=document.querySelector(".user-profile-section"),r=document.getElementById("userTierText");if(t&&r)if(r.className="status-badge",currentUser){switch(t.style.display="block",e){case"free":default:r.classList.add("trial"),r.textContent="Trial Account";break;case"pending":r.classList.add("pending"),r.textContent="Premium Pending";break;case"premium":r.classList.add("premium"),r.textContent="Premium"}updateUserStats(),document.dispatchEvent(new CustomEvent("userStatusChanged",{detail:{status:e}}))}else r.classList.add("unregistered"),r.textContent="Unregistered",t.style.display="none",document.dispatchEvent(new CustomEvent("userStatusChanged",{detail:{status:"unregistered"}}));else console.warn("User profile elements not found")}async function updateUserStats(){try{var e,t;currentUser&&(e=(await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single()).data,t=(await supabaseClient.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single()).data,e&&(document.getElementById("totalCoins").textContent=e.coins||0),t&&(document.getElementById("totalWords").textContent=t.unique_words_practiced||0),updateAllCoinDisplays(),WordsManager.updateDisplays(t?.unique_words_practiced||0))}catch(e){console.error("Error updating user stats:",e)}}function setupUserStatusSubscription(){if(currentUser)return supabaseClient.channel("user-status-"+currentUser.id).on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_profiles",filter:"id=eq."+currentUser.id},e=>{console.log("Profile update received:",e.new),e.new&&e.new.status&&(updateUserStatusDisplay(e.new.status),"premium"===e.new.status)&&showPremiumCelebration()}).subscribe(e=>{console.log("Subscription status:",e)})}function restoreGameContext(){var e=localStorage.getItem("gameContext");return!!e&&(e=JSON.parse(e),gameState.currentStage=e.stage||1,gameState.currentSet=e.set||1,gameState.currentLevel=e.level,localStorage.removeItem("gameContext"),!0)}function checkUpgradeStatus(){var e,t,r;return!!currentUser&&(e=localStorage.getItem("upgradeRequested_"+currentUser.id),t="premium"===currentUser.status,r="pending"===currentUser.status,e||t||r)}function navigateHome(){console.log("Navigating home with full refresh"),saveProgress(),window.location.reload(!0)}function forceReload(){console.log("Force Reload Initiated"),window.location&&(window.location.href=window.location.href),window.location.reload&&window.location.reload(!0),window.location.replace(window.location.pathname)}async function showLeaderboard(){showScreen("leaderboard-screen");let r=document.getElementById("leaderboard-entries");try{async function e(){var{data:e,error:t}=await supabaseClient.from("player_leaderboard").select("*");if(t)console.error("Leaderboard fetch error:",t);else{t=r.children;let a={};Array.from(t).forEach(e=>{var t=e.querySelector("[data-username]").dataset.username;a[t]=e.getBoundingClientRect()}),r.innerHTML=e.map((e,t)=>`
                <div class="leaderboard-entry ${e.username===currentUser?.user_metadata?.username?"you":""} ${t<3?"rank-"+(t+1):""}"
                     data-rank="${t+1}">
                    <div>${e.player_rank}</div>
                    <div data-username="${e.username}">${e.username||"Anonymous"}</div>
                    <div>${e.total_levels_completed}</div>
                    <div>${e.total_words_learned}</div>
                </div>
            `).join("");t=r.children;Array.from(t).forEach(e=>{var t,r=e.querySelector("[data-username]").dataset.username;a[r]&&(r=a[r],t=e.getBoundingClientRect(),0<(r=r.top-t.top)?e.classList.add("moving-up"):r<0&&e.classList.add("moving-down"),e.addEventListener("animationend",()=>{e.classList.remove("moving-up","moving-down")},{once:!0}))})}}await e();var t=setInterval(e,1e4),a=document.getElementById("leaderboard-screen");a&&(a.dataset.pollInterval&&clearInterval(parseInt(a.dataset.pollInterval)),a.dataset.pollInterval=t)}catch(e){console.error("Detailed leaderboard error:",e),r.innerHTML=`<p>Error loading leaderboard: ${e.message}</p>`}}function cleanupLeaderboard(){var e=document.getElementById("leaderboard-screen");e&&(e.dataset.channel&&(supabaseClient.removeChannel(e.dataset.channel),delete e.dataset.channel),e.dataset.pollInterval)&&(clearInterval(parseInt(e.dataset.pollInterval)),delete e.dataset.pollInterval)}async function updatePlayerStats(e,t,r){if(currentUser&&"premium"===currentUser.status)try{var{data:a,error:n}=await supabaseClient.from("player_stats").select("*").eq("user_id",currentUser.id).single();if(n&&"PGRST116"!==n.code)throw n;var o=[...new Set(currentGame.words)].length,s={user_id:currentUser.id,total_levels_completed:(a?.total_levels_completed||0)+1,unique_words_practiced:(a?.unique_words_practiced||0)+o,last_updated:(new Date).toISOString()},i=(await supabaseClient.from("player_stats").upsert(s,{onConflict:"user_id",returning:"minimal"})).error;if(i)throw i;await WordsManager.updateWords(o)}catch(e){console.error("Error updating player stats:",e)}}async function checkExistingSession(){console.log("Checking for existing user session");try{var e,{session:t}=(await supabaseClient.auth.getSession()).data;return t?(console.log("Found existing session for user:",t.user.id),currentUser=t.user,e=(await supabaseClient.from("user_profiles").select("status").eq("id",currentUser.id).single()).data,e&&(currentUser.status=e.status,updateUserStatusDisplay(e.status)),initializeStatusCheck(),updateAuthUI(),updateGuestPlayButton(),!0):(console.log("No active session found"),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),!1)}catch(e){return console.error("Session check error:",e),currentUser=null,updateAuthUI(),updateUserStatusDisplay(null),updateGuestPlayButton(),!1}}function setupAutoSave(){var e=setInterval(()=>{gameState.currentStage&&gameState.currentSet&&gameState.currentLevel&&(console.log("Auto-saving game progress"),saveProgress())},3e4);return window.addEventListener("beforeunload",()=>{gameState.currentStage&&gameState.currentSet&&gameState.currentLevel&&(console.log("Saving progress before page unload"),saveProgress())}),e}function showPremiumCelebration(){let e=document.createElement("div");e.className="premium-celebration",e.innerHTML=`
        <div class="celebration-content">
            <h1 class="celebration-title">Congratulations!</h1>
            <p class="celebration-message">You've unlocked Premium Access!</p>
            <button class="celebration-button" onclick="handlePremiumCelebrationComplete()">
                Continue
            </button>
        </div>
    `,document.body.appendChild(e),setTimeout(()=>{e.classList.add("show")},100)}function handlePremiumCelebrationComplete(){let e=document.querySelector(".premium-celebration");var t;e&&(e.classList.remove("show"),(t=localStorage.getItem("unlockNextSetForStage"))&&(t=parseInt(t,10),!isNaN(t))&&2<=t&&t<=5&&(console.log("Unlocking set 2 for previously completed stage "+t),gameState.unlockedSets[t]||(gameState.unlockedSets[t]=new Set),gameState.unlockedSets[t].add(2),t=t+"_2",gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set),gameState.unlockedLevels[t].add(1),saveProgress(),localStorage.removeItem("unlockNextSetForStage")),setTimeout(()=>{e.remove(),showScreen("welcome-screen")},500))}function handlePremiumCelebrationComplete(){let e=document.querySelector(".premium-celebration");e&&(e.classList.remove("show"),setTimeout(()=>{e.remove(),showScreen("welcome-screen")},500))}function initializeStatusCheck(){var e;window.statusCheckInterval&&clearInterval(window.statusCheckInterval),currentUser&&(e=setInterval(async()=>{try{var e,t,r,a;currentUser&&currentUser.id?({data:e,error:t}=await supabaseClient.from("user_profiles").select("status").eq("id",currentUser.id).single(),t||!e?(clearInterval(window.statusCheckInterval),currentUser=null,updateAuthUI()):(r=currentUser.status,updateUserStatusDisplay(e.status),"premium"===e.status&&"premium"!==r&&(currentUser.status="premium",(a=localStorage.getItem("completedTrialStage"))&&(localStorage.setItem("unlockNextSetForStage",a),localStorage.removeItem("completedTrialStage")),showPremiumCelebration()))):clearInterval(window.statusCheckInterval)}catch(e){console.error("Status check error:",e),clearInterval(window.statusCheckInterval),currentUser=null,updateAuthUI()}},3e3),window.statusCheckInterval=e)}window.debugUpgrade=function(){checkPopupStatus(),console.log("Upgrade screen visible:",document.getElementById("upgrade-screen").classList.contains("visible")),console.log("Upgrade form:",document.getElementById("upgradeForm")),console.log("Current user:",currentUser)},document.querySelectorAll(".home-button").forEach(e=>{e.onclick=function(){console.log("Home button clicked"),forceReload()}}),document.addEventListener("DOMContentLoaded",function(){console.log("DOM fully loaded, initializing game"),gameInit.init().then(()=>{console.log("Game initialization completed");var e=localStorage.getItem("gameContext");if(e&&!window.location.hash)try{var t=JSON.parse(e);Date.now()-(t.timestamp||0)<864e5&&(console.log("Found recent game context, updating game state:",t),gameState.currentStage=t.stage||gameState.currentStage,gameState.currentSet=t.set||gameState.currentSet,gameState.currentLevel=t.level||gameState.currentLevel)}catch(e){console.error("Error parsing saved context:",e)}})}),document.addEventListener("DOMContentLoaded",function(){setupAutoSave()}),document.addEventListener("DOMContentLoaded",()=>{var e=document.getElementById("otpInput");e&&e.addEventListener("input",function(e){this.value=this.value.replace(/[^0-9]/g,""),4<this.value.length&&(this.value=this.value.slice(0,4))})});let currentArcadeSession={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],playerRank:null,winnerScreenShown:!1,startTime:null,endTime:null};async function showArcadeModal(){var e,t,r,a,n,o,s,i,l,c=document.getElementById("arcade-modal"),d=document.getElementById("teacher-view"),u=document.getElementById("player-view"),m=document.getElementById("arcadeUsername"),g=m?m.closest(".input-group"):null;try{currentUser?(e=(await supabaseClient.from("user_profiles").select("role").eq("id",currentUser.id).single()).data,"teacher"===e?.role?(t=Math.floor(1e3+9e3*Math.random()).toString(),currentArcadeSession.otp=t,currentArcadeSession.teacherId=currentUser.id,currentArcadeSession.participants=[],currentArcadeSession.isInitialized=!1,currentArcadeSession.state="pre-start",currentArcadeSession.celebrationTriggered=!1,window.arcadeChannel&&window.arcadeChannel.unsubscribe(),window.arcadeChannel=supabaseClient.channel("arcade:"+t,{config:{broadcast:{self:!0}}}),window.arcadeChannel.on("broadcast",{event:"player_join"},({payload:t})=>{var e;console.log("Player join event received:",t),currentArcadeSession.participants.find(e=>e.username===t.username)||(currentArcadeSession.participants.push({username:t.username,wordsCompleted:0,coins:0}),document.getElementById("player-count").textContent=currentArcadeSession.participants.length,(e=document.getElementById("arcade-leaderboard"))&&null!==e.offsetParent&&updateAllPlayersProgress())}).subscribe(),window.location.origin,window.location.pathname,generateQRCode(t),document.getElementById("otp").textContent=t,d.style.display="block",u.style.display="none",document.querySelectorAll('.stage-checkboxes input[type="checkbox"]').forEach(e=>{e.checked=!1}),r=document.getElementById("wordGoalInput"),a=document.getElementById("wordGoalSlider"),n=document.getElementById("wordGoalDisplay"),r&&(r.value="50"),a&&(a.value="50"),n&&(n.textContent="50"),initializeWordGoalSlider(),(o=document.querySelector(".end-arcade-button"))&&o.classList.remove("visible")):(d.style.display="none",u.style.display="block",m&&g&&(s=currentUser.user_metadata?.username||currentUser.email.split("@")[0],m.value=s,m.readOnly=!0,m.style.display="none",(i=document.createElement("div")).className="username-display",i.textContent="Joining as: "+s,g.insertBefore(i,m)))):(d.style.display="none",u.style.display="block",m&&(m.readOnly=!1,m.style.display="block",l=g?.querySelector(".username-display"))&&l.remove()),c.style.display="block"}catch(e){console.error("Arcade setup error:",e),alert("Failed to initialize arcade")}}function initializeWordGoalSlider(){let t=document.getElementById("wordGoalSlider"),r=document.getElementById("wordGoalDisplay"),a=document.getElementById("wordGoalInput");var e=document.querySelectorAll(".slider-stop");t&&r&&a&&(t.min=0,t.max=200,t.value=50,r.textContent=50,a.value=50,t.addEventListener("input",function(){var e=parseInt(this.value);r.textContent=e,a.value=e}),a.addEventListener("input",function(){var e=parseInt(this.value)||0,e=Math.max(0,Math.min(200,e));t.value=e,r.textContent=e,this.value=e}),e.forEach(e=>{e.addEventListener("click",function(){var e=parseInt(this.dataset.value);t.value=e,r.textContent=e,a.value=e})}))}function startPlayerCounting(t){async function e(){try{var e=(await supabaseClient.from("game_progress").select("arcade_session").eq("user_id",t).single()).data;e?.arcade_session?.participants&&(document.getElementById("player-count").textContent=e.arcade_session.participants.length)}catch(e){console.error("Count update error:",e)}}window.countInterval&&clearInterval(window.countInterval),e(),window.countInterval=setInterval(e,2e3)}async function joinArcade(){var e=document.getElementById("otpInput").value.trim().toUpperCase();try{window.arcadeChannel=supabaseClient.channel("arcade:"+e);var r=currentUser?currentUser.user_metadata?.username:getRandomSimploName();let t;currentArcadeSession.playerName=r,window.arcadeChannel.on("broadcast",{event:"game_end"},({payload:e})=>{handleGameEnd(e),currentArcadeSession.state=e.state,"active"===e.state&&(currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,startArcadeGame(),t)&&clearInterval(t)}).on("broadcast",{event:"game_playing"},({payload:e})=>{"active"===e.state&&(currentArcadeSession.state="active",currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,startArcadeGame(),t)&&clearInterval(t)}).subscribe(),await window.arcadeChannel.send({type:"broadcast",event:"player_join",payload:{username:r,joinedAt:(new Date).toISOString(),coins:0}}),currentArcadeSession.joinEventSent=!0,currentArcadeSession.otp=e,await window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:r,requestType:"lateJoin",timestamp:Date.now()}}),document.getElementById("arcade-modal").style.display="none",setTimeout(()=>{"active"!==currentArcadeSession.state&&showWaitingScreen()},500),t=setInterval(async()=>{await window.arcadeChannel.send({type:"broadcast",event:"check_game_status"})},2e3),setTimeout(()=>{t&&clearInterval(t)},3e5)}catch(e){console.error("Join error:",e),alert("Failed to join arcade")}}function showJoinButton(){var e=document.getElementById("joinGameButton");e&&(e.style.display="block",e.textContent="Join Active Game")}async function getCurrentCoins(){var e;return currentUser&&(e=(await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single()).data,e?.coins)||0}function getRandomSimploName(){var e=["Simplosaurus","Simplodian","Simpleton","Simplonius","Simplomancer","Simplonaut","Simplobot","Simplozilla","Simplopedia","Simplotron","Simplodex","Simplomatic","Simplomobile","Simplocopter","Simplonium","Simplotastic","Simplominator","Simploverse","Simplonado","Simplophant","Simplowizard","Simplodragon","Simplosapien","Simploninja","Simplowarrior"];return e[Math.floor(Math.random()*e.length)]}function showWaitingScreen(){if("active"===currentArcadeSession.state)startArcadeGame();else{document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("visible")});var t=document.getElementById("waiting-screen"),r=(t.classList.add("visible"),document.getElementById("joinGameButton"));r&&(r.style.display="active"===currentArcadeSession.state?"block":"none");try{initializeWaitingGame()}catch(e){console.error("Error initializing waiting game:",e)}let e=setInterval(()=>{if(window.arcadeChannel)try{window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:currentArcadeSession.playerName,requestType:"waitingCheck"}})}catch(e){console.error("Error checking game status:",e)}},2e3);r=document.getElementById("waiting-player-count");r&&(r.parentElement.style.display="none"),t.dataset.pollInterval=e,setTimeout(()=>{e&&clearInterval(e)},3e5)}}async function initializeArcade(){try{var e=document.querySelector(".initialize-button"),t=document.querySelector(".end-arcade-button");e&&(e.style.display="none"),t&&t.classList.add("visible"),currentArcadeSession.state="active",currentArcadeSession.isInitialized=!0,currentArcadeSession.participants=currentArcadeSession.participants.map(e=>({...e,wordsCompleted:0,coins:e.coins||0})),updateAllPlayersProgress(),initializeModeratorInactivityTimer(),await window.arcadeChannel.send({type:"broadcast",event:"game_playing",payload:{wordPool:currentArcadeSession.wordPool,wordGoal:currentArcadeSession.wordGoal,state:"active",timestamp:Date.now()}})}catch(e){console.error("Initialize error:",e),alert("Failed to start game")}}function showModeratorScreen(){document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("visible")}),document.getElementById("moderator-screen").classList.add("visible");var e=document.getElementById("moderatorOtp"),e=(e&&currentArcadeSession.otp&&(e.textContent=currentArcadeSession.otp,e=window.location.origin+window.location.pathname+"#join="+currentArcadeSession.otp,console.log("QR URL generated:",e),new QRious({element:document.getElementById("qrCode"),value:e,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"}),e={sessionDate:(e=new Date).toLocaleDateString(),sessionStartTime:e.toLocaleTimeString(),sessionWordGoal:currentArcadeSession.wordGoal,activeParticipantCount:currentArcadeSession.participants.length},Object.entries(e).forEach(([e,t])=>{e=document.getElementById(e);e&&(e.textContent=t)})),initializeLeaderboard(),document.querySelector(".initialize-button")),t=document.querySelector(".end-arcade-button");currentArcadeSession.isInitialized&&"active"===currentArcadeSession.state?(e&&(e.style.display="none"),t&&t.classList.add("visible")):(e&&(e.style.display="block"),t&&t.classList.remove("visible")),initializeModeratorInactivityTimer(),setTimeout(()=>{currentArcadeSession.participants&&0<currentArcadeSession.participants.length&&updateAllPlayersProgress()},500)}function initializeLeaderboard(){document.getElementById("arcade-leaderboard").innerHTML=`
        <div class="leaderboard-header">
            <div>Rank</div>
            <div>Player</div>
            <div>Words</div>
            <div>Coins</div>
        </div>
    `,0<currentArcadeSession.participants.length&&updateAllPlayersProgress()}let readyPhrases=["Born Ready!","Ready to Roll!","All Set!","Locked & Loaded!","Ready Player!","Game Face On!","In Position!","Ready to Rock!","Standing By!","Powered Up!","Challenge Ready!","Mission Ready!","Ready to Shine!","Bring it On!","Ready to Rumble!","Set for Success!","Level Ready!","Shields Up!","Word Warrior Ready!","Let's Do This!"],shineColors=["#1E90FF","#FF1493","#00CED1","#9370DB","#FFD700","#FF4500","#32CD32","#FF69B4","#4169E1","#8A2BE2"];function updateAllPlayersProgress(){let r={};document.querySelectorAll(".leaderboard-entry").forEach(e=>{var t=e.querySelector("[data-username]"),e=e.querySelector("[data-words]");t&&e&&(t=t.dataset.username,e=parseInt(e.textContent)||0,r[t]=e)}),currentArcadeSession.participants.forEach(e=>{var t=e.username;r[t]&&r[t]>e.wordsCompleted&&(e.wordsCompleted=r[t],console.log(`Restored higher progress for ${t}: `+r[t]))});var e=[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins),t=`
      <div class="leaderboard-header">
          <div>Rank</div>
          <div>Player</div>
          <div>Words</div>
          <div>Coins</div>
      </div>
      ${e.map((e,t)=>"active"===currentArcadeSession.state&&e.username?`<div class="leaderboard-entry ${t<3?"rank-"+(t+1):""}"
                 data-rank="${t+1}">
              <div class="rank">${t+1}</div>
              <div data-username="${e.username}" class="player-name">${e.username}</div>
              <div data-words="${e.wordsCompleted||0}" class="words">${e.wordsCompleted||0}</div>
              <div data-coins="${e.coins||0}" class="coins">${e.coins||0}</div>
          </div>`:`<div class="leaderboard-entry waiting ${t<3?"rank-"+(t+1):""}"
                 data-rank="${t+1}">
              <div class="rank">${t+1}</div>
              <div data-username="${e.username}" class="player-name">${e.username}</div>
              <div class="player-status-waiting">
                  <span class="status-text" style="color: ${shineColors[Math.floor(Math.random()*shineColors.length)]}">${readyPhrases[Math.floor(Math.random()*readyPhrases.length)]}</span>
              </div>
              <div class="waiting-indicator">
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
              </div>
          </div>`).join("")}
  `,a=document.getElementById("arcade-leaderboard"),a=(a&&(a.innerHTML=t),document.getElementById("activeParticipantCount")),t=(a&&(a.textContent=e.length),document.getElementById("sessionDate")),a=(t&&(t.textContent=(new Date).toLocaleDateString()),document.getElementById("sessionStartTime")),e=(a&&(a.textContent=(new Date).toLocaleTimeString()),document.getElementById("sessionWordGoal"));e&&(e.textContent=currentArcadeSession.wordGoal)}async function startArcade(){var e=Array.from(document.querySelectorAll(".stage-checkboxes input:checked")).map(e=>parseInt(e.value)),t=document.querySelector(".stage-warning");0===e.length?(t&&(t.style.display="block"),console.error("No stages selected")):(t&&(t.style.display="none"),currentArcadeSession.wordPool=generateWordPool(e),(t=document.getElementById("wordGoal")||document.getElementById("wordGoalSlider"))?(e=parseInt(t.value),currentArcadeSession.wordGoal=isNaN(e)?50:e,console.log("Selected word goal:",currentArcadeSession.wordGoal)):(console.error("Word goal slider element not found. Available elements:",document.querySelectorAll('select, input[type="range"]')),currentArcadeSession.wordGoal=50,console.warn("Defaulting to word goal of 50")),currentArcadeSession.state="started",currentArcadeSession.participants=[],currentArcadeSession.completedPlayers=[],currentArcadeSession.podiumRanks={},currentArcadeSession.isInitialized=!1,currentArcadeSession.startTime=null,currentArcadeSession.endTime=null,currentArcadeSession.winnerScreenShown=!1,window.arcadeChannel.on("broadcast",{event:"progress_update"},({payload:t})=>{var e,r,a;t&&t.username&&(-1!==(e=currentArcadeSession.participants.findIndex(e=>e.username===t.username))?(a=(r=currentArcadeSession.participants[e]).wordsCompleted||0,void 0!==t.wordsCompleted&&t.wordsCompleted<a&&(console.warn(`Prevented progress reset for ${t.username}: ${a} → `+t.wordsCompleted),t.wordsCompleted=a),currentArcadeSession.participants[e]={...r,...t}):currentArcadeSession.participants.push({username:t.username,wordsCompleted:t.wordsCompleted||0,coins:t.coins||0}),updatePlayerRankDisplay(),updatePlayerProgress(t),checkGameEnd())}).on("broadcast",{event:"check_game_status"},async({payload:t})=>{var e;console.log("Received game status check:",t),await window.arcadeChannel.send({type:"broadcast",event:"game_state_response",payload:{state:currentArcadeSession.state,wordPool:currentArcadeSession.wordPool,wordGoal:currentArcadeSession.wordGoal,requestType:t?.requestType||"standard"}}),"lateJoin"===t?.requestType&&"active"===currentArcadeSession.state&&t.username&&!currentArcadeSession.participants.find(e=>e.username===t.username)&&(currentArcadeSession.participants.push({username:t.username,wordsCompleted:0,coins:0,lateJoin:!0}),(e=document.getElementById("activeParticipantCount"))&&(e.textContent=currentArcadeSession.participants.length),updateAllPlayersProgress())}).on("broadcast",{event:"player_completed"},({payload:e})=>{console.log("Player completed event:",e),e.username&&!currentArcadeSession.completedPlayers.includes(e.username)&&(currentArcadeSession.completedPlayers.push(e.username),e.rank&&e.rank<=3&&(currentArcadeSession.podiumRanks[e.username]={rank:e.rank,completionTime:e.timestamp||Date.now()}),updatePlayerProgress(e),3<=currentArcadeSession.completedPlayers.length)&&endArcadeForAll()}),(t=document.getElementById("arcade-modal"))&&(t.style.display="none"),showModeratorScreen(),currentUser?.id===currentArcadeSession.teacherId&&(e=initializeModeratorIdleDetection(),currentArcadeSession.idleDetection=e))}function generateWordPool(e){let a=[];return e.forEach(t=>{Object.keys(vocabularySets).forEach(e=>{if(e.startsWith(t+"_")){let r=vocabularySets[e];r.words.forEach((e,t)=>{a.push({word:e,translation:r.translations[t]})})}})}),a.sort(()=>Math.random()-.5)}function cleanupModeratorScreen(){var e=document.getElementById("moderator-screen");e&&e.dataset.channelSubscription&&(supabaseClient.removeChannel(e.dataset.channelSubscription),delete e.dataset.channelSubscription)}function startArcadeGame(){var e=document.getElementById("waiting-screen"),e=(e&&e.dataset.pollInterval&&(clearInterval(parseInt(e.dataset.pollInterval)),delete e.dataset.pollInterval),document.getElementById("question-screen").classList.add("visible"),document.getElementById("waiting-screen").classList.remove("visible"),currentArcadeSession.playerName||currentUser?.user_metadata?.username||getRandomSimploName()),t=(updatePlayerRankDisplay(),document.querySelectorAll(".coin-count").forEach(e=>{e.textContent="0",e.style.display="flex"}),document.querySelectorAll(".coins-container").forEach(e=>{e.style.display="flex"}),document.querySelector(".perks-container")),r=document.querySelector(".powerups-container");t.style.display="none",r.style.display="flex";let a=0;if(currentUser&&"premium"===currentUser.status)try{var{data:n,error:o}=supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();!o&&n&&(a=n.coins,console.log("Loaded initial coins:",a))}catch(e){console.error("Failed to load coins:",e)}else a=parseInt(localStorage.getItem("simploxCustomCoins")||"0");currentGame.coins=a,currentArcadeSession.initialCoins=a,document.querySelectorAll(".coin-count").forEach(e=>{e.textContent=a.toString()});try{window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:e,wordsCompleted:0,coins:a,timestamp:Date.now()}})}catch(e){console.error("Failed to send initial progress update:",e)}if(window.arcadeChannel.send({type:"broadcast",event:"sync_request",payload:{username:e,timestamp:Date.now()}}),updatePlayerRankDisplay(),currentArcadeSession.startTime=Date.now(),!(currentGame={currentIndex:0,correctStreak:0,wrongStreak:0,words:currentArcadeSession.wordPool||[],wordsCompleted:0,coins:a,lastBroadcast:Date.now(),initialCoinsLoaded:!0,playerUsername:e}).words||0===currentGame.words.length){if(!(currentArcadeSession.wordPool&&0<currentArcadeSession.wordPool.length))return showErrorToast("Failed to join game: No words available"),void showScreen("welcome-screen");currentGame.words=currentArcadeSession.wordPool}initializePowerups();t=supabaseClient.channel("arcade_leaderboard").on("postgres_changes",{event:"*",schema:"public",table:"arcade_participants"},e=>{console.log("Direct DB Change:",e),updateAllPlayersProgress()}).subscribe();currentArcadeSession.leaderboardChannel=t,window.arcadeChannel.on("broadcast",{event:"player_initialized"},({payload:t})=>{console.log("Player Initialization Received:",t);var e=currentArcadeSession.participants.findIndex(e=>e.username===t.username),r={username:t.username,wordsCompleted:0,coins:t.initialCoins||0,lateJoin:t.lateJoin||!1};-1===e?currentArcadeSession.participants.push(r):currentArcadeSession.participants[e]=r,updateAllPlayersProgress(),updateArcadeProgress()}),window.arcadeChannel.on("broadcast",{event:"progress_update"},({payload:t})=>{var e,r,a,n;console.log("Progress update received:",t),t.username!==currentArcadeSession.playerName&&(-1!==(e=currentArcadeSession.participants.findIndex(e=>e.username===t.username))?(a=(r=currentArcadeSession.participants[e]).wordsCompleted||0,n=t.wordsCompleted||0,currentArcadeSession.participants[e]={...r,...t,wordsCompleted:Math.max(a,n)}):currentArcadeSession.participants.push({username:t.username,wordsCompleted:t.wordsCompleted||0,coins:t.coins||0,lateJoin:t.lateJoin||!1}),updatePlayerProgress({username:t.username,wordsCompleted:t.wordsCompleted,coins:t.coins})),updatePlayerRankDisplay()}),window.arcadeChannel.on("broadcast",{event:"sync_request"},({payload:e})=>{currentGame&&0<currentGame.wordsCompleted&&window.arcadeChannel.send({type:"broadcast",event:"sync_response",payload:{participants:currentArcadeSession.participants,respondingPlayer:currentArcadeSession.playerName,requestingPlayer:e.username,timestamp:Date.now()}})}),window.arcadeChannel.on("broadcast",{event:"sync_response"},({payload:e})=>{e.requestingPlayer===currentArcadeSession.playerName&&Array.isArray(e.participants)&&(e.participants.forEach(t=>{var e,r=currentArcadeSession.participants.findIndex(e=>e.username===t.username);-1===r?currentArcadeSession.participants.push(t):(e=currentArcadeSession.participants[r],currentArcadeSession.participants[r]={...e,wordsCompleted:Math.max(e.wordsCompleted||0,t.wordsCompleted||0),coins:Math.max(e.coins||0,t.coins||0)})}),updatePlayerRankDisplay())}),window.arcadeChannel.on("broadcast",{event:"player_completed"},({payload:e})=>{console.log("Player completed event:",e),currentArcadeSession.completedPlayers.includes(e.username)||currentArcadeSession.completedPlayers.push(e.username),updatePlayerProgress(e),3<=currentArcadeSession.completedPlayers.length&&endArcadeForAll()}),window.arcadeChannel.on("broadcast",{event:"powerup_effect"},({payload:e})=>{if(e.targetUser===currentArcadeSession.playerName){var a=e.powerup;switch(showNotification(`${e.fromUser} ${a.message} you!`,a.type),a.name){case"High Five":case"Fist Bump":let t=currentGame.coins;currentGame.coins+=a.effect,document.querySelectorAll(".coin-count").forEach(e=>{animateNumber(e,t,currentGame.coins)});break;case"Energy Boost":currentGame.coinMultiplier=2,currentGame.boostedAnswersLeft=3;break;case"Freeze":let e=document.querySelectorAll(".buttons button");e.forEach(e=>e.disabled=!0),setTimeout(()=>{e.forEach(e=>e.disabled=!1)},a.duration);break;case"Coin Storm":currentGame.coinBlockedAnswers=3;break;case"Screen Shake":let r=document.getElementById("question-screen");r.classList.add("screen-shake"),setTimeout(()=>{r.classList.remove("screen-shake")},a.duration)}updatePlayerProgress({username:currentArcadeSession.playerName,coins:currentGame.coins,wordsCompleted:currentGame.wordsCompleted})}}),window.arcadeChannel.on("broadcast",{event:"coin_effect"},({payload:e})=>{if(e.targetUser===currentArcadeSession.playerName){let t=currentGame.coins;currentGame.coins+=e.amount,document.querySelectorAll(".coin-count").forEach(e=>{animateNumber(e,t,currentGame.coins)});var r=currentArcadeSession.participants.findIndex(e=>e.username===currentArcadeSession.playerName);-1!==r&&(currentArcadeSession.participants[r].coins=currentGame.coins,updateModeratorLeaderboard()),"blessing"===e.type?showNotification(e.fromUser+" high-fived you!","blessing"):"curse"===e.type&&showNotification(e.fromUser+" poisoned you!","curse"),updatePlayerProgress({username:currentArcadeSession.playerName,coins:currentGame.coins,wordsCompleted:currentGame.wordsCompleted})}}),window.arcadeChannel.on("broadcast",{event:"game_end"},({payload:e})=>{handleGameEnd(e)}),updateAllCoinDisplays(),loadNextArcadeQuestion(),window.arcadeTimeouts=[],window.arcadeIntervals=[]}async function updateArcadeCoins(e){let t=currentGame.coins;if(currentGame.coins+=e,currentUser)try{var r=(await supabaseClient.from("game_progress").update({coins:currentGame.coins}).eq("user_id",currentUser.id)).error;if(r)throw r}catch(e){console.error("Failed to update coins in database:",e),currentGame.coins=t}e=currentArcadeSession.participants.some(e=>0<e.wordsCompleted&&e.username!==currentArcadeSession.playerName);if(!e)try{window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:currentArcadeSession.playerName,wordsCompleted:0,coins:currentGame.coins||0,timestamp:Date.now(),lateJoin:e}})}catch(e){console.error("Failed to send initial progress update:",e)}if(e)try{window.arcadeChannel.send({type:"broadcast",event:"sync_request",payload:{username:currentArcadeSession.playerName,requestType:"newPlayerJoin",timestamp:Date.now()}})}catch(e){console.error("Failed to send sync request:",e)}return document.querySelectorAll(".coin-count").forEach(e=>{animateCoinsChange(e,t,currentGame.coins)}),currentGame.coins}async function getCurrentCoinsForArcade(){if(!currentUser)return parseInt(localStorage.getItem("simploxCustomCoins")||"0");try{var{data:e,error:t}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();return t&&console.error("Coin retrieval error:",t),e?.coins||0}catch(e){return console.error("Unexpected coin retrieval error:",e),0}}function loadNextArcadeQuestion(){if(currentGame.words.length){var t=document.getElementById("question-word");let r=document.getElementById("buttons");var o=Math.floor(Math.random()*currentGame.words.length);let a=currentGame.words[o],n=Math.random()<.5,e=(t.textContent=n?a.translation:a.word,[n?a.word:a.translation]);for(;e.length<3;){var s=currentGame.words[Math.floor(Math.random()*currentGame.words.length)],s=n?s.word:s.translation;e.includes(s)||e.push(s)}e=e.sort(()=>Math.random()-.5),r.innerHTML="",e.forEach(e=>{var t=document.createElement("button");t.textContent=e,t.onclick=()=>handleArcadeAnswer(e===(n?a.word:a.translation)),r.appendChild(t)}),currentGame.words.splice(o,1)}}function updateArcadeProgress(){var e=document.querySelector(".progress-circle .progress"),t=2*Math.PI*54,r=currentGame.wordsCompleted?currentGame.wordsCompleted/currentArcadeSession.wordGoal:0;e.style.strokeDasharray=t+" "+t,e.style.strokeDashoffset=t*(1-r)}function showArcadeCompletionScreen(e){let t=document.createElement("div");t.className="arcade-completion-modal",t.innerHTML=`
        <div class="completion-modal-content">
            <h2>Arcade Complete!</h2>
            <div class="completion-stats">
                <div class="stat-item">
                    <i class="fas fa-book"></i>
                    <span>Words: ${e.wordsCompleted}</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-coins"></i>
                    <span>Coins: ${e.coins}</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-trophy"></i>
                    <span>Rank: ${e.rank}</span>
                </div>
            </div>
            <button onclick="exitArcade()" class="start-button">Exit</button>
        </div>
    `,document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("show"))}function exitArcadeCompletion(){let e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout(()=>{e.remove(),showScreen("welcome-screen")},300))}function exitArcade(){window.arcadeChannel&&window.arcadeChannel.unsubscribe(),currentArcadeSession={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50},showScreen("welcome-screen"),document.querySelector(".completion-overlay")?.remove()}function handleAnswer(r,a=!1){var n,o,s,e=Date.now();if(e-(currentGame.lastAnswerTime||0)<1e3)console.warn("Answer too quickly. Please wait a moment.");else if(!currentGame||!currentGame.words||0===currentGame.words.length||currentGame.currentIndex>=currentGame.words.length)console.error("Invalid game state or index");else{currentGame.lastAnswerTime=e,currentGame.perks=currentGame.perks||{clue:0,skip:0,timeFreeze:0,reveal:0};try{if(r){if(currentGame.currentIndex++,currentGame.isBossLevel){let t=document.querySelector(".boss-orb-inner");if(t){var i=["yellow","purple","turquoise","darkgreen","brown"],l=i[Math.floor(Math.random()*i.length)];let e=t.style.background;t.style.background=`radial-gradient(circle at 30% 30%, ${l}, #990000)`,t.style.transform="scale(1.3)",t.style.filter="brightness(1.5)",setTimeout(()=>{t.style.transform="",t.style.filter="",t.style.background=e},300)}if(currentGame.currentIndex>=currentGame.words.length)return console.log("Boss defeated - final hit!"),currentGame.bossDefeated=!0,clearTimer(),(n=document.querySelector(".progress-circle"))&&(o=n.querySelector(".progress"))&&(s=2*Math.PI*54,o.style.strokeDashoffset=s),showBossDefeatEffect(),void CoinsManager.updateCoins(100).then(()=>{updateAllCoinDisplays()});updateBossHealthBar()}else updateProgressCircle();if(!a){let e=0;var c,d=awardTimeBonus();0<d&&(e+=d,pulseCoins(d)),currentGame.firstAttempt?(e+=3,pulseCoins(3)):(e+=1,pulseCoins(1)),CoinsManager.updateCoins(e).then(()=>{updatePerkButtons(),updateAllCoinDisplays()}).catch(e=>{console.error("Error updating total coins:",e)}),currentGame.correctAnswers++,currentUser&&(c=currentGame.currentIndex-1,trackWordEncounter((currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[c],currentGame.isCustomPractice?"custom":currentGame.isArcadeMode?"arcade":"story"))}}else if(currentGame.firstAttempt=!1,currentGame.streakBonus=!1,currentGame.wrongStreak++,CoinsManager.updateCoins(-3).then(()=>{updatePerkButtons(),updateAllCoinDisplays()}).catch(e=>{console.error("Error updating coins:",e)}),0<currentGame.currentIndex&&(currentGame.progressLost++,currentGame.currentIndex=Math.max(0,currentGame.currentIndex-1),currentGame.isBossLevel)&&updateBossHealthBar(),3<=currentGame.wrongStreak)return void showGameOverOverlay();let e=document.querySelectorAll(".buttons button"),t=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[Math.max(0,currentGame.currentIndex-1)];e.forEach(e=>{e.textContent===t?e.classList.add("correct"):!r&&event&&event.target&&e.textContent===event.target.textContent&&e.classList.add("wrong")}),saveProgress();setTimeout(()=>{e.forEach(e=>{e.classList.remove("correct","wrong")}),!currentGame||currentGame.bossDefeated&&currentGame.isBossLevel||(currentGame.currentIndex<currentGame.words.length?(startTimer(currentGame.words.length-currentGame.currentIndex),(currentGame.isBossLevel?loadNextBossQuestion:loadNextQuestion)(),updatePerkButtons()):currentGame.isBossLevel||(currentGame.isCustomPractice?handleCustomLevelCompletion:handleLevelCompletion)())},500)}catch(e){console.error("Unexpected error in handleAnswer:",e),console.error("Error details:",e.stack);try{currentGame&&currentGame.currentIndex<currentGame.words.length&&!currentGame.bossDefeated?loadNextQuestion():showScreen("welcome-screen")}catch(e){console.error("Failed to recover from error:",e),showScreen("welcome-screen")}}}}function handleArcadeAnswer(e){var r=Date.now();if(!(r-(currentGame.lastAnswerTime||0)<1e3)){currentGame.lastAnswerTime=r;let t=currentArcadeSession.playerName||currentUser?.user_metadata?.username||getRandomSimploName();if(e){if(currentGame.wordsCompleted++,currentGame.correctStreak++,currentGame.wrongStreak=0,!currentUser){let e=5,t=(3<=currentGame.correctStreak&&(e+=5),currentGame.coins);currentGame.coins+=e,document.querySelectorAll(".coin-count").forEach(e=>{animateCoinsChange(e,t,currentGame.coins)}),updateArcadePowerups()}r=currentArcadeSession.participants.findIndex(e=>e.username===t);-1!==r?(currentArcadeSession.participants[r].wordsCompleted=currentGame.wordsCompleted,currentArcadeSession.participants[r].coins=currentGame.coins):currentArcadeSession.participants.push({username:t,wordsCompleted:currentGame.wordsCompleted,coins:currentGame.coins}),updatePlayerRankDisplay();try{window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:t,wordsCompleted:currentGame.wordsCompleted,coins:currentGame.coins,timestamp:Date.now()}})}catch(e){console.error("Error sending progress update:",e)}updateArcadeProgress(),currentGame.wordsCompleted>=currentArcadeSession.wordGoal&&handlePlayerCompletedGoal(t)}else currentGame.correctStreak=0,currentGame.wrongStreak++;updatePlayerRankDisplay(),loadNextArcadeQuestion()}}function checkGameEnd(){3<=currentArcadeSession.participants.filter(e=>e.wordsCompleted>=currentArcadeSession.wordGoal).length&&window.arcadeChannel.send({type:"broadcast",event:"game_end"})}function handleGameEnd(e){console.log("Game End Payload:",e),e&&(e.forcedEnd?(exitArcade(),showScreen("welcome-screen")):(currentUser?.id!==e.teacherId?showFinalResultsForPlayer:showModeratorVictoryScreen)(e.podiumPlayers||[]))}function showPodiumPlayerResults(e){var t=currentArcadeSession.playerName,t=currentArcadeSession.podiumRanks[t].rank,r=currentArcadeSession.initialCoins||0,r=(gameState.coins||currentGame.coins||0)-r,a=currentGame.wordsCompleted||0;let n=document.createElement("div");n.className="arcade-completion-modal",n.innerHTML=`
        <div class="completion-modal-content">
            <h2>Congratulations!</h2>
            <p class="personal-result">You finished in ${getOrdinal(t)} place!</p>
            
            <div class="your-stats">
                <h3>Your Results</h3>
                <div class="completion-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0;">
                    <div class="stat-item" style="text-align: center;">
                        <i class="fas fa-language" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>
                        <span style="display: block; margin-bottom: 0.25rem;">Words Learned</span>
                        <strong style="font-size: 1.5rem;">${a}</strong>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>
                        <span style="display: block; margin-bottom: 0.25rem;">Coins Earned</span>
                        <strong style="font-size: 1.5rem;">${r}</strong>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>
                        <span style="display: block; margin-bottom: 0.25rem;">Your Rank</span>
                        <strong style="font-size: 1.5rem;">${t}</strong>
                    </div>
                </div>
            </div>
            
            <button onclick="exitArcadeCompletion()" class="start-button">
                Return to Welcome
            </button>
        </div>
    `,document.body.appendChild(n),requestAnimationFrame(()=>n.classList.add("show"))}function showConsolationScreen(){let e=document.createElement("div");e.className="arcade-completion-modal";var t=["🌟","🎮","🚀","💪","🏆","🔥","👏","✨"],t=t[Math.floor(Math.random()*t.length)];e.innerHTML=`
        <div class="completion-modal-content">
            <h2 style="font-size: 3rem; margin-bottom: 1rem;">${t}</h2>
            <h2>Game Complete!</h2>
            <p style="font-size: 1.2rem; margin: 1.5rem 0; line-height: 1.5;">
                Great effort! You did your best and gained valuable practice.
                <br><br>
                Keep playing to improve your skills and speed!
            </p>
            <button onclick="exitArcadeCompletion()" class="start-button" style="margin-top: 1.5rem;">
                Return to Welcome
            </button>
        </div>
    `,document.body.appendChild(e),requestAnimationFrame(()=>e.classList.add("show"))}function showFinalResultsForPlayer(t){let r=currentArcadeSession.playerName;t=t.find(e=>e.username===r);if(!(currentArcadeSession.winnerScreenShown&&t&&t.rank<=3)){let e;(e=t?t.rank:[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted-e.wordsCompleted).findIndex(e=>e.username===r)+1)<=3?showPersonalVictoryScreen(e):showConsolationScreen()}}function showPersonalVictoryScreen(e){var r,a,n;currentArcadeSession.winnerScreenShown||(currentArcadeSession.winnerScreenShown=!0,console.log("Showing personal victory screen with rank: "+e),(r=document.createElement("div")).className="arcade-completion-modal",a={1:{title:"🏆 FIRST PLACE! 🏆",message:"Incredible! You've claimed the top spot!",color:"var(--gold)"},2:{title:"🥈 SECOND PLACE! 🥈",message:"Amazing job! You've secured second place!",color:"var(--silver)"},3:{title:"🥉 THIRD PLACE! 🥉",message:"Well done! You've earned third place!",color:"var(--bronze)"}}[e]||{title:"Game Complete!",message:"You've reached the word goal!",color:"var(--accent)"},n=currentArcadeSession.initialCoins||0,n=(gameState.coins||currentGame.coins||0)-n,r.innerHTML=`
        <div class="completion-modal-content">
            <h2 style="color: ${a.color}">${a.title}</h2>
            <p>${a.message}</p>
            <div class="completion-stats">
                <div class="stat-item">
                    <i class="fas fa-language"></i>
                    <span>Words Learned</span>
                    <strong>${currentGame.wordsCompleted}</strong>
                </div>
                <div class="stat-item">
                    <i class="fas fa-coins"></i>
                    <span>Coins Earned</span>
                    <strong>${n}</strong>
                </div>
                <div class="stat-item">
                    <i class="fas fa-trophy"></i>
                    <span>Your Rank</span>
                    <strong>${e}</strong>
                </div>
            </div>
            <button class="victory-button" style="margin-top: 2rem;" onclick="closePersonalVictory()">
            Continue
        </button>
        </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",startPlayerConfetti()},100))}function showModeratorVictoryScreen(e){moderatorActivityTimer&&clearTimeout(moderatorActivityTimer),countdownTimer&&clearInterval(countdownTimer);var t=document.querySelector(".inactivity-overlay");t&&t.remove(),startLeaderboardCelebration(e)}function showPlayerFinalResults(t){let r=currentArcadeSession.playerName;var a=t.find(e=>e.username===r),n=a?.rank||t.findIndex(e=>e.username===r)+1;if(!(currentArcadeSession.winnerScreenShown&&n<=3)){let e=document.createElement("div");e.className="arcade-completion-modal";var t=t.filter(e=>e.rank<=3).sort((e,t)=>e.rank-t.rank),o=currentArcadeSession.initialCoins||0,o=(gameState.coins||currentGame.coins||0)-o;e.innerHTML=`
        <div class="completion-modal-content">
            <h2>Arcade Game Complete!</h2>
            ${n<=3?`<p class="personal-result">Congratulations! You finished in ${getOrdinal(n)} place!</p>`:`<p class="personal-result">You earned ${getOrdinal(n)} place. Better luck next time!</p>`}
            <div class="leaderboard-preview">
                <h3>Top Players</h3>
                ${t.map(e=>`
                    <div class="podium-player rank-${e.rank} ${e.username===r?"current-player":""}"
                         style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.5rem 0; 
                                background: ${((e,t)=>{var r={1:"linear-gradient(135deg, #FFD700 0%, #FFC800 100%)",2:"linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%)",3:"linear-gradient(135deg, #CD7F32 0%, #B87333 100%)"};return t?(r[e]||"rgba(255,255,255,0.1)")+"; border: 2px solid white; box-shadow: 0 0 15px rgba(255,255,255,0.5)":r[e]||"rgba(255,255,255,0.1)"})(e.rank,e.username===r)};
                                border-radius: 10px; color: ${1===e.rank?"#000":"#fff"};">
                        <div class="player-rank">${e.rank}</div>
                        <div class="player-name">${e.username}</div>
                        <div class="player-stats">
                            <span class="player-words">${e.wordsCompleted||0} words</span>
                            <span class="player-coins">${e.coins||0} coins</span>
                        </div>
                    </div>
                `).join("")}
                
                ${3<n?`
                    <div class="divider" style="border-top: 1px dashed rgba(255,255,255,0.2); margin: 1rem 0;"></div>
                    <div class="current-player-row podium-player"
                         style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.5rem 0; 
                                background: rgba(255,255,255,0.1); border: 1px solid var(--accent);
                                border-radius: 10px; color: var(--text);">
                        <div class="player-rank">${n}</div>
                        <div class="player-name">${r}</div>
                        <div class="player-stats">
                            <span class="player-words">${a?.wordsCompleted||0} words</span>
                            <span class="player-coins">${a?.coins||0} coins</span>
                        </div>
                    </div>
                `:""}
            </div>
            <div class="your-stats">
                <h3>Your Results</h3>
                <div class="completion-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0;">
                    <div class="stat-item" style="text-align: center;">
                        <i class="fas fa-language" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>
                        <span style="display: block; margin-bottom: 0.25rem;">Words Learned</span>
                        <strong style="font-size: 1.5rem;">${a?.wordsCompleted||0}</strong>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>
                        <span style="display: block; margin-bottom: 0.25rem;">Coins Earned</span>
                        <strong style="font-size: 1.5rem;">${o}</strong>
                    </div>
                    <div class="stat-item" style="text-align: center;">
                        <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>
                        <span style="display: block; margin-bottom: 0.25rem;">Your Rank</span>
                        <strong style="font-size: 1.5rem;">${n}</strong>
                    </div>
                </div>
            </div>
            <button onclick="exitArcadeCompletion()" class="start-button">
                Return to Welcome
            </button>
        </div>
    `,document.body.appendChild(e),requestAnimationFrame(()=>e.classList.add("show"))}}function removePlayer(t){currentArcadeSession.participants=currentArcadeSession.participants.filter(e=>e.username!==t),window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"player_removed",payload:{username:t}}),updateAllPlayersProgress()}function toggleSidePanel(){var e=document.querySelector(".side-panel"),t=document.querySelector(".hamburger-button"),r=document.querySelector(".vertical-nav-container"),a=document.querySelector(".modal-overlay");e.classList.contains("open")?(e.classList.remove("open"),t.classList.remove("open"),r.classList.remove("panel-open"),a&&a.classList.remove("open")):(e.classList.add("open"),t.classList.add("open"),r.classList.add("panel-open"),a&&a.classList.add("open"))}function initVerticalNavigation(){var e={hamburger:document.querySelector(".hamburger-button:not(.vertical-nav-container .hamburger-button)"),home:document.querySelector(".home-button:not(.vertical-nav-container .home-button)"),fullscreen:document.querySelector(".fullscreen-button:not(.vertical-nav-container .fullscreen-button)"),reset:document.querySelector(".reset-button:not(.vertical-nav-container .reset-button)"),settings:document.querySelector(".settings-button:not(.vertical-nav-container .settings-button)"),accessibility:document.querySelector(".accessibility-toggle")};let t=document.querySelector(".vertical-nav-container");t||((t=document.createElement("div")).className="vertical-nav-container",document.body.appendChild(t)),t.innerHTML="";var r=document.createElement("button"),r=(r.className="hamburger-button",r.id="nav-hamburger-btn",r.innerHTML='<i class="fas fa-bars"></i>',r.onclick=toggleSidePanel,t.appendChild(r),document.createElement("button")),r=(r.className="nav-button home-button",r.id="nav-home-btn",r.innerHTML='<i class="fas fa-home"></i>',r.onclick=navigateHome||function(){showScreen("welcome-screen")},t.appendChild(r),document.createElement("button")),r=(r.className="nav-button fullscreen-button",r.id="nav-fullscreen-btn",r.innerHTML='<i class="fas fa-expand"></i>',r.onclick=toggleFullScreen,t.appendChild(r),document.createElement("button")),r=(r.className="nav-button reset-button",r.id="nav-reset-btn",r.innerHTML='<i class="fas fa-trash-alt"></i>',r.onclick=handleResetProgress,t.appendChild(r),document.createElement("button")),r=(r.className="nav-button settings-button",r.id="nav-settings-btn",r.innerHTML='<i class="fas fa-cog"></i>',r.onclick=function(){var e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(r),document.createElement("button"));r.className="nav-button accessibility-button",r.id="nav-accessibility-btn",r.innerHTML='<i class="fas fa-universal-access"></i>',r.onclick=function(){var e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(r),Object.values(e).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}function showAuthModal(){var e=document.getElementById("authModal");e&&e.classList.add("open")}function hideAuthModal(){var e=document.getElementById("authModal");e&&e.classList.remove("open")}function updateAuthUI(){document.querySelector(".side-panel");var e=document.querySelector(".user-profile-section"),t=document.getElementById("userEmail"),r=document.querySelector(".logout-button"),a=document.querySelector(".main-button");currentUser?(e&&(e.style.display="block"),r&&(r.style.display="block"),t&&(t.textContent=currentUser.user_metadata?.username||currentUser.email),a&&(a.style.display="none"),updateUserStats()):(e&&(e.style.display="none"),r&&(r.style.display="none"),a&&(a.style.display="block"))}function showAuthModal(){var e=document.getElementById("authModal");e&&e.classList.add("show")}function hideAuthModal(){var e=document.getElementById("authModal");e&&e.classList.remove("show")}function toggleAuthMode(){var e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function updateGuestPlayButton(){var e=document.querySelector(".guest-play-button");currentUser&&(currentUser,"unregistered"!==currentUser.status)?e.textContent="Start Game":e.textContent="Play as Guest"}function showPricesScreen(){alert("Prices screen coming soon!")}function showRightsAndPolicies(){alert("Rights & Policies page coming soon!")}function showAboutPage(){alert("About page coming soon!")}function showContactUs(){alert("Contact Us page coming soon!")}function animateNumber(n,e,o,t=0){if((e=Number(e))===(o=Number(o)))n.textContent=o;else{let t=(o-e)/30,r=e,a=0;requestAnimationFrame(function e(){r+=t,30<=++a||0<t&&r>=o||t<0&&r<=o?n.textContent=Math.round(o):(n.textContent=Math.round(r),requestAnimationFrame(e))})}}function showNotification(e,t){let r=document.createElement("div");r.className="game-notification "+t,r.textContent=e,document.body.appendChild(r),setTimeout(()=>r.classList.add("show"),10),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>r.remove(),300)},2e3)}function createParticles(t,r,a){var n="blessing"===a?["#3498db","#2980b9","#1abc9c"]:["#e74c3c","#c0392b","#d35400"];for(let e=0;e<15;e++){let e=document.createElement("div");e.className="particle "+a;var o=8*Math.random()+4,s=Math.random()*Math.PI*2,i=100*Math.random()+50,o=(e.style.width=o+"px",e.style.height=o+"px",e.style.borderRadius="50%",e.style.backgroundColor=n[Math.floor(Math.random()*n.length)],e.style.position="fixed",e.style.left=t+"px",e.style.top=r+"px",document.body.appendChild(e),t+Math.cos(s)*i),s=r+Math.sin(s)*i;e.animate([{transform:"translate(0, 0) scale(1)",opacity:1},{transform:`translate(${o-t}px, ${s-r}px) scale(0)`,opacity:0}],{duration:1e3,easing:"cubic-bezier(0.4, 0, 0.2, 1)"}).onfinish=()=>e.remove()}}async function joinArcadeWithUsername(){var t=document.getElementById("arcadeUsername"),e=document.getElementById("otpInput");let r;if(currentUser)r=currentUser.user_metadata?.username||currentUser.email.split("@")[0];else{if(!(r=t.value.trim())||r.length<2||15<r.length)return showErrorToast("Username must be between 2 and 15 characters"),void t.focus();if(!/^[a-zA-Z0-9\u0590-\u05FF\s._-]+$/.test(r))return showErrorToast("Username can contain letters, numbers, spaces, periods, underscores, and hyphens"),void t.focus()}t=e.value.trim();if(t&&4===t.length&&/^\d+$/.test(t))try{let e=0;if(currentUser)try{var{data:a,error:n}=await supabaseClient.from("game_progress").select("coins").eq("user_id",currentUser.id).single();!n&&a&&(e=a.coins,console.log("Retrieved initial coins:",e))}catch(e){console.error("Failed to load initial coins:",e)}window.arcadeChannel=supabaseClient.channel("arcade:"+t),currentArcadeSession.playerName=r,currentArcadeSession.initialCoins=e,currentArcadeSession.otp=t,await window.arcadeChannel.subscribe(),setupCelebrationHandler(),window.arcadeChannel.on("broadcast",{event:"game_end"},({payload:e})=>{handleGameEnd(e),currentArcadeSession.state="ended"}).on("broadcast",{event:"game_playing"},({payload:e})=>{"active"===e.state&&(currentArcadeSession.state="active",currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,startArcadeGame())}).on("broadcast",{event:"player_join"},({payload:t})=>{var e;console.log("Player join event received:",t),currentArcadeSession.participants.find(e=>e.username===t.username)||(currentArcadeSession.participants.push({username:t.username,wordsCompleted:0,coins:0}),(e=document.getElementById("player-count"))&&(e.textContent=currentArcadeSession.participants.length),(e=document.getElementById("arcade-leaderboard"))&&null!==e.offsetParent&&updateAllPlayersProgress())}),window.arcadeChannel.on("broadcast",{event:"game_state_response"},({payload:e})=>{console.log("Received game state response:",e),e&&"active"===e.state&&(currentArcadeSession.state="active",currentArcadeSession.wordPool=e.wordPool,currentArcadeSession.wordGoal=e.wordGoal,currentArcadeSession.joinEventSent)&&(document.getElementById("arcade-modal").style.display="none",startArcadeGame())}),await window.arcadeChannel.send({type:"broadcast",event:"player_join",payload:{username:r,type:"initialJoin",coins:e,joinedAt:(new Date).toISOString()}}),currentArcadeSession.joinEventSent=!0,await window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:r,requestType:"lateJoin",timestamp:Date.now()}}),document.getElementById("arcade-modal").style.display="none",setTimeout(()=>{"active"!==currentArcadeSession.state&&showWaitingScreen()},500)}catch(e){console.error("Join arcade error:",e),showErrorToast("Failed to join arcade. Please try again.")}else showErrorToast("Please enter a valid 4-digit game code"),e.focus()}document.addEventListener("DOMContentLoaded",initVerticalNavigation),document.addEventListener("click",e=>{var t=document.getElementById("authModal"),r=t?.querySelector(".auth-modal-content"),a=document.getElementById("arcade-modal"),n=a?.querySelector(".modal-content");!t?.classList.contains("show")||r.contains(e.target)||e.target.matches(".main-button")||hideAuthModal(),"block"!==a?.style.display||n.contains(e.target)||e.target.matches(".arcade-button")||(a.style.display="none")});let powerupPool={highFive:{id:"highFiveCard",cost:30,effect:50,type:"goodie",icon:"fa-hand-paper",name:"High Five",message:"high-fived"},fistBump:{id:"fistBumpCard",cost:40,effect:75,type:"goodie",icon:"fa-fist-raised",name:"Fist Bump",message:"fist-bumped"},energyBoost:{id:"energyBoostCard",cost:45,type:"goodie",icon:"fa-bolt",name:"Energy Boost",message:"boosted"},freeze:{id:"freezeCard",cost:150,duration:1e4,type:"baddie",icon:"fa-snowflake",name:"Freeze",message:"froze"},coinStorm:{id:"coinStormCard",cost:160,duration:3,type:"baddie",icon:"fa-cloud-showers-heavy",name:"Coin Storm",message:"cast a coin storm on"},screenShake:{id:"screenShakeCard",cost:130,duration:5e3,type:"baddie",icon:"fa-shake",name:"Screen Shake",message:"shook"}};function initializePowerups(){let n={highFive:{id:"highFiveCard",cost:30,effect:50,type:"goodie",icon:"fa-hand-paper",name:"High Five",message:"high-fived"},fistBump:{id:"fistBumpCard",cost:40,effect:75,type:"goodie",icon:"fa-fist-raised",name:"Fist Bump",message:"fist-bumped"},energyBoost:{id:"energyBoostCard",cost:45,type:"goodie",icon:"fa-bolt",name:"Energy Boost",message:"boosted"},freeze:{id:"freezeCard",cost:150,duration:1e4,type:"baddie",icon:"fa-snowflake",name:"Freeze",message:"froze"},coinStorm:{id:"coinStormCard",cost:160,type:"baddie",icon:"fa-cloud-showers-heavy",name:"Coin Storm",message:"cast a coin storm on"},screenShake:{id:"screenShakeCard",cost:130,duration:5e3,type:"baddie",icon:"fa-shake",name:"Screen Shake",message:"shook"}};function e(){document.querySelectorAll(".powerup-card").forEach(e=>{var t=e.querySelector(".powerup-cost");t&&(t=parseInt(t.textContent),t=currentGame.coins>=t,e.classList.toggle("disabled",!t),e.style.cursor=t?"pointer":"not-allowed",e.style.opacity=t?"1":"0.5")})}let t=document.querySelector(".powerups-container");var r;if(t)return t.innerHTML="",(e=>{for(var t=Object.keys(n),r=[];r.length<e&&0<t.length;){var a=Math.floor(Math.random()*t.length);r.push(t.splice(a,1)[0])}return r})(3).forEach(r=>{let a=n[r];var e=document.createElement("div");e.className="powerup-card "+a.type,e.id=a.id,e.innerHTML=`
            <i class="fas ${a.icon} powerup-icon"></i>
            <div class="powerup-name">${a.name}</div>
            <div class="powerup-cost">${a.cost}</div>
        `,e.onclick=async()=>{if(console.log("Powerup clicked:",a.name),currentGame.coins<a.cost)showNotification("Not enough coins!","error");else{var e=currentArcadeSession.participants.filter(e=>e.username!==currentArcadeSession.playerName&&null!=e.username);if(0===e.length)showNotification("Waiting for other players to join...","info");else{e=e[Math.floor(Math.random()*e.length)];let t=currentGame.coins;currentGame.coins-=a.cost,document.querySelectorAll(".coin-count").forEach(e=>{e.textContent=currentGame.coins});try{await window.arcadeChannel.send({type:"broadcast",event:"powerup_effect",payload:{powerupKey:r,targetUser:e.username,fromUser:currentArcadeSession.playerName,powerup:a}}),showNotification(`Used ${a.name} on ${e.username}!`,a.type),await window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:currentArcadeSession.playerName,wordsCompleted:currentGame.wordsCompleted,coins:currentGame.coins,timestamp:Date.now()}}),initializePowerups()}catch(e){console.error("Powerup use error:",e),currentGame.coins=t,document.querySelectorAll(".coin-count").forEach(e=>{e.textContent=t}),showNotification("Failed to use powerup!","error")}updatePlayerRankDisplay()}}},t.appendChild(e)}),e(),(r=document.querySelector(".coin-count"))&&new MutationObserver(()=>{e()}).observe(r,{childList:!0,characterData:!0,subtree:!0}),e}function updatePowerupAvailability(){document.querySelectorAll(".powerup-card").forEach(e=>{var t=e.querySelector(".powerup-cost");t&&(t=parseInt(t.textContent),t=currentGame.coins>=t,e.classList.toggle("disabled",!t),e.style.cursor=t?"pointer":"not-allowed",e.style.opacity=t?"1":"0.5")})}function updateArcadePowerups(){var e=document.querySelectorAll(".powerup-card");let r=currentGame.coins||0;e.forEach(e=>{var t=e.querySelector(".powerup-cost");t&&(t=parseInt(t.textContent),t=r>=t,e.classList.toggle("disabled",!t),e.style.opacity=t?"1":"0.5",e.style.cursor=t?"pointer":"not-allowed")})}function updateArcadeCoinDisplay(){let r=currentGame.coins||0;document.querySelectorAll(".coin-count").forEach(e=>{var t=parseInt(e.textContent)||0;t!==r&&animateCoinsChange(e,t,r)}),updatePowerupAvailability()}function generateQRCode(e){e=window.location.origin+window.location.pathname+"#join="+e;console.log("Generating QR code with URL:",e),new QRious({element:document.getElementById("qrCode"),value:e,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"})}function handleHashChange(){var e,t,r;console.log("Hash change detected:",window.location.hash),window.location.hash.startsWith("#join=")&&(e=window.location.hash.replace("#join=",""),console.log("Join OTP detected:",e),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)?(r=(t=document.getElementById("qr-landing")).querySelector(".game-code-display"),document.querySelectorAll(".screen").forEach(e=>{e.style.display="none"}),t.style.display="flex",r.textContent=e,t.dataset.otp=e):(history.pushState("",document.title,window.location.pathname),showJoinModal(e)))}function proceedToGame(){var e=document.getElementById("qr-landing"),t=e.dataset.otp;e.style.display="none",showJoinModal(t)}function showNotification(e,t="info"){let r=document.createElement("div");r.className="game-notification "+t,r.textContent=e,document.body.appendChild(r),requestAnimationFrame(()=>r.classList.add("show")),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>r.remove(),300)},3e3)}function switchAuthForm(e){var t=document.getElementById("loginForm"),r=document.getElementById("signupForm");"signup"===e?(t.classList.add("hidden"),r.classList.remove("hidden")):(t.classList.remove("hidden"),r.classList.add("hidden"))}async function combineCustomLists(e){if("teacher"!==!currentUser?.role){var r={id:Date.now(),name:"Combined List",words:[],translations:[],isTeacherList:!0};for(let t of e){var a=customPracticeLists.lists.find(e=>e.id===t);a&&(r.words.push(...a.words),r.translations.push(...a.translations))}return r}}async function convertListToArcade(t){if("teacher"!==!currentUser?.role){let r=customPracticeLists.lists.find(e=>e.id===t);if(r)return{wordPool:r.words.map((e,t)=>({word:e,translation:r.translations[t]})),isCustomArcade:!0,teacherId:currentUser.id,listId:t}}}function initializeBossLevel(){console.log("Initializing boss level");var e=createBossTimer().container,e=(document.getElementById("question-screen").appendChild(e),currentGame.bossFirstHealthRestored=!1,currentGame.bossSecondHealthRestored=!1,applyBossLevelStyles(),document.querySelectorAll(".perk-button").forEach(e=>{var t;e&&(e.disabled=!0,e.style.opacity="0.3",(t=document.createElement("div")).className="perk-disabled",t.innerHTML="❌",t.style.cssText=`
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 1.5em;
                color: red;
                pointer-events: none;
            `,e.style.position="relative",e.appendChild(t))}),document.querySelector(".progress-circle"));e&&(e=e.querySelector(".progress"))&&(e.style.stroke="#4CAF50"),currentGame.updateBossTimer=e=>{updateBossTimer(document.querySelector("#boss-timer div"),e)},setTimeout(applyBossLevelStyles,100),setTimeout(applyBossLevelStyles,500),console.log("Boss level initialization complete")}function replaceCoinWithBossOrb(){var e,t,r=document.querySelector(".coins-container");r?((e=document.createElement("div")).className="boss-orb",e.innerHTML='<div class="boss-orb-inner"></div>',e.style.cssText=`
    position: absolute;
    width: 60px;
    height: 60px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  `,e.querySelector(".boss-orb-inner").style.cssText=`
    width: 50px;
    height: 50px;
    background: radial-gradient(circle at 30% 30%, #ff3333, #990000);
    border-radius: 50%;
    box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);
    animation: pulseOrb 2s infinite;
  `,(t=document.createElement("style")).innerHTML=`
    @keyframes pulseOrb {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.1); filter: brightness(1.2); }
    }
  `,document.head.appendChild(t),r.innerHTML="",r.appendChild(e)):console.error("Coins container not found")}function initializeBossHealthBar(){var e=document.querySelector(".progress-circle");e&&(e=e.querySelector(".progress"))&&(e.style.stroke="#4CAF50",(e=document.createElement("style")).innerHTML=`
    .progress.warning {
      animation: healthWarning 0.8s infinite alternate;
    }
    @keyframes healthWarning {
      from { stroke: #ff3333; }
      to { stroke: #ffffff; }
    }
  `,document.head.appendChild(e))}function addBossLevelStyles(){var e=document.getElementById("boss-level-style"),e=(e&&e.remove(),document.createElement("style"));e.id="boss-level-style",e.innerHTML=`
    .boss-mode {
      background: linear-gradient(135deg, #800000, #3a0000) !important;
    }
    
    @keyframes pulseBg {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }
    
    .boss-orb {
      position: relative;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .boss-orb-inner {
      width: 50px;
      height: 50px;
      background: radial-gradient(circle at 30% 30%, #ff3333, #990000);
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);
      animation: pulseOrb 2s infinite;
    }
    
    .boss-orb-glow {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 70%);
      animation: rotateGlow 3s linear infinite;
    }
    
    @keyframes pulseOrb {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.1); filter: brightness(1.2); }
    }
    
    @keyframes rotateGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .boss-health {
      transition: stroke 0.3s ease, stroke-dashoffset 0.5s ease;
    }
    
    .boss-health.warning {
      animation: healthWarning 0.8s infinite alternate;
    }
    
    @keyframes healthWarning {
      from { stroke: #ff3333; }
      to { stroke: #ffffff; }
    }
    
    .boss-word {
      color: #ff3333;
      text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      animation: pulseWord 2s infinite;
    }
    
    @keyframes pulseWord {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .boss-hit {
      animation: bossHitEffect 0.3s;
    }
    
    @keyframes bossHitEffect {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); filter: brightness(1.3); }
      100% { transform: scale(1); }
    }
    
    .boss-orb-hit {
      animation: bossOrbHit 0.3s;
    }
    
    @keyframes bossOrbHit {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); filter: brightness(1.5); }
      100% { transform: scale(1); }
    }
    
    .boss-restore-health {
      animation: bossRestoreHealth 1s;
    }
    
    @keyframes bossRestoreHealth {
      0% { filter: brightness(1); }
      50% { filter: brightness(2); }
      100% { filter: brightness(1); }
    }
    
    .boss-defeated {
      animation: bossDefeated 2s forwards;
    }
    
    @keyframes bossDefeated {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.7; filter: brightness(2); }
      100% { transform: scale(0); opacity: 0; }
    }
    
    .raining-letter {
      position: absolute;
      color: rgba(255, 0, 0, 0.3);
      font-size: 16px;
      animation: letterRain linear forwards;
      z-index: 1;
    }
    
    @keyframes letterRain {
      0% { transform: translateY(-20px); opacity: 0; }
      10% { opacity: 0.7; }
      90% { opacity: 0.7; }
      100% { transform: translateY(100vh); opacity: 0; }
    }
    
    .boss-victory {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0, 198, 255, 0.5);
      z-index: 1000;
      max-width: 500px;
      width: 90%;
    }
    
    .boss-victory h2 {
      font-size: 2rem;
      color: white;
      margin-bottom: 1rem;
    }
    
    .boss-victory p {
      font-size: 1.2rem;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 2rem;
    }
    
    .victory-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    
.victory-button {
    background: var(--accent);
    color: var(--text);
    border: none;
    padding: 1rem 2.5rem;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(30, 144, 255, 0.3);
    margin-top: 1.5rem;
    min-width: 200px;
}

.victory-button:hover {
    transform: translateY(-3px);
    background: color-mix(in srgb, var(--accent) 80%, white);
    box-shadow: 0 8px 20px rgba(30, 144, 255, 0.5);
}

.victory-button:active {
    transform: translateY(1px);
    box-shadow: 0 3px 10px rgba(30, 144, 255, 0.3);
}
    
    .victory-button.continue {
      background: #4CAF50;
      color: white;
    }
    
    .victory-button.home {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
    }
    
   
    
    .incineration-effect {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle, #ff9900, #ff3300);
      opacity: 0;
      transform: scale(0);
      animation: incinerateEffect 2s forwards;
    }
    
    @keyframes incinerateEffect {
      0% { transform: scale(0); opacity: 0; }
      10% { transform: scale(0.5); opacity: 0.8; }
      50% { transform: scale(1.5); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
  `,document.head.appendChild(e)}function updateBossHealthBar(){if(!currentGame.isBossLevel)return!1;console.log("Updating boss health bar");var e=document.querySelector(".progress-circle");if(!e)return console.error("Progress circle not found"),!1;e=e.querySelector(".progress");if(!e)return console.error("Progress element not found"),!1;var t=currentGame.words.length,r=currentGame.currentIndex||0,r=Math.max(0,t-r),a=r/t,r=(console.log(`Boss health: ${(100*a).toFixed(2)}% (${r}/${t})`),2*Math.PI*54);e.style.strokeDashoffset=r*(1-a);let n=document.querySelector(".boss-orb-inner");return n&&(r=Math.max(5,50*a),n.style.width=r+"px",n.style.height=r+"px",n.style.left=50-r/2+"%",n.style.top=50-r/2+"%"),.66<a?(e.style.stroke="#4CAF50",e.classList.remove("warning")):.33<a?(e.style.stroke="#FFA500",e.classList.remove("warning"),a<=.66&&!currentGame.bossFirstHealthRestored&&(currentGame.bossFirstHealthRestored=!0,console.log("First boss health restoration"),n&&(n.style.background="radial-gradient(circle at 30% 30%, white, #FFEB3B)",n.style.transform="scale(1.3)",n.style.filter="brightness(1.8)",setTimeout(()=>{n.style.transform="",n.style.filter="",n.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"},1e3)),r=Math.floor(.25*t),currentGame.currentIndex=r,setTimeout(()=>updateBossHealthBar(),100))):(e.style.stroke="#FF3333",e.classList.add("warning"),a<=.33&&!currentGame.bossSecondHealthRestored&&(currentGame.bossSecondHealthRestored=!0,console.log("Second boss health restoration"),n&&(n.style.background="radial-gradient(circle at 30% 30%, white, #4CAF50)",n.style.transform="scale(1.3)",n.style.filter="brightness(1.8)",setTimeout(()=>{n.style.transform="",n.style.filter="",n.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"},1e3)),r=Math.floor(.5*t),currentGame.currentIndex=r,setTimeout(()=>updateBossHealthBar(),100))),a<=0&&!currentGame.bossDefeated&&(console.log("Boss defeated via health bar check!"),currentGame.bossDefeated=!0)}function startBossLevel(){showLevelIntro(21,()=>{initializeBossLevel(),startTimer(8*currentGame.words.length),loadNextBossQuestion()})}function loadNextBossQuestion(){console.log("Loading next boss question"),setTimeout(applyBossLevelStyles,100),createLightningEffect(),createBossRainingLetters();let e=document.getElementById("question-word");e&&(e.style.setProperty("color","#ff3333","important"),e.style.setProperty("text-shadow","0 0 10px rgba(255, 0, 0, 0.5)","important"),e.style.setProperty("animation","pulseWord 2s infinite","important"));try{0<currentGame.currentIndex&&e?(e.classList.add("exiting"),setTimeout(()=>{loadNextQuestion(),e.classList.remove("exiting"),e.classList.add("entering"),setTimeout(()=>{e.classList.remove("entering")},500)},500)):loadNextQuestion(),setTimeout(()=>{updateBossHealthBar()},50);let t=document.getElementById("buttons");t&&Math.random()<.3&&Array.from(t.children).sort(()=>Math.random()-.5).forEach(e=>{t.appendChild(e)})}catch(e){console.error("Error loading boss question:",e)}}function restoreFromBossLevel(){var e=document.getElementById("question-screen"),e=(e&&(e.removeAttribute("style"),e.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)"),document.getElementById("question-word"));e&&e.removeAttribute("style"),window.originalCoinsHTML&&(e=document.querySelector(".coins-container"))&&(e.innerHTML=window.originalCoinsHTML),"function"==typeof stopBossRainingLetters&&stopBossRainingLetters()}function initializeArcadeParticipation(){let t=Date.now();setInterval(()=>{6e4<Date.now()-t&&removeInactivePlayer()},1e4),["mousemove","keypress","click"].forEach(e=>{document.addEventListener(e,()=>{t=Date.now()})}),window.addEventListener("beforeunload",()=>{window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"player_left",payload:{username:currentArcadeSession.playerName}})})}function removeInactivePlayer(){window.arcadeChannel.send({type:"broadcast",event:"player_inactive",payload:{username:currentArcadeSession.playerName}})}function handleArcadeCompletion(t){var e=currentArcadeSession.participants.sort((e,t)=>t.wordsCompleted-e.wordsCompleted).findIndex(e=>e.username===t.username)+1;e<=3&&(showPersonalizedCompletion(e),3===e)&&window.arcadeChannel.send({type:"broadcast",event:"game_complete",payload:{topThree:currentArcadeSession.participants.sort((e,t)=>t.wordsCompleted-e.wordsCompleted).slice(0,3)}})}async function handlePlayerCompletedGoal(t){if(!currentArcadeSession.completedPlayers.includes(t)){var r=Date.now();currentArcadeSession.completedPlayers.push(t);let e=0;var a=currentArcadeSession.completedPlayers.indexOf(t),a=(a<3&&(e=a+1,currentArcadeSession.podiumRanks||(currentArcadeSession.podiumRanks={}),currentArcadeSession.podiumRanks[t]={rank:e,completionTime:r},console.log(`Player ${t} earned podium rank ${e} (first to finish)`)),currentArcadeSession.participants.find(e=>e.username===t));a&&(0<e&&(a.rank=e,a.completionTime=r),a.wordsCompleted=currentGame.wordsCompleted,a.coins=gameState.coins||currentGame.coins||0,a.completed=!0),await window.arcadeChannel.send({type:"broadcast",event:"player_completed",payload:{username:t,rank:e,wordsCompleted:currentGame.wordsCompleted,coins:gameState.coins||currentGame.coins||0,timestamp:r,completed:!0}}),t===currentArcadeSession.playerName&&0<e&&showPersonalVictoryScreen(e),3<=currentArcadeSession.completedPlayers.length&&await endArcadeForAll()}}function endArcade(){var e;moderatorInactivity.isGameActive=!1,currentArcadeSession.celebrationTriggered=!0,currentArcadeSession.state="ended",currentArcadeSession.endTime=Date.now(),3<=currentArcadeSession.participants.length?(e=[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins).slice(0,3).map((e,t)=>({...e,rank:t+1,completionTime:Date.now()-1e3*t})),window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",podiumPlayers:e,teacherId:currentArcadeSession.teacherId,forcedEnd:!1,duration:currentArcadeSession.endTime-(currentArcadeSession.startTime||currentArcadeSession.endTime)}}),startLeaderboardCelebration(e)):(window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",forcedEnd:!0,teacherId:currentArcadeSession.teacherId}}),showScreen("welcome-screen")),resetArcadeSession(),window.arcadeChannel&&(window.arcadeChannel.unsubscribe(),window.arcadeChannel=null)}function resetArcadeSession(){var e=Math.floor(1e3+9e3*Math.random()).toString(),t=(window.arcadeTimeouts&&window.arcadeTimeouts.forEach(e=>clearTimeout(e)),window.arcadeIntervals&&window.arcadeIntervals.forEach(e=>clearInterval(e)),window.celebrationConfettiInterval&&clearInterval(window.celebrationConfettiInterval),window.playerConfettiInterval&&clearInterval(window.playerConfettiInterval),currentArcadeSession={eventId:null,otp:e,wordPool:[],participants:[],teacherId:currentUser?.id||null,wordGoal:50,state:"pre-start",completedPlayers:[],playerRank:null,winnerScreenShown:!1,startTime:null,endTime:null,podiumRanks:{},isInitialized:!1,initialCoins:0,playerName:null,joinEventSent:!1,celebrationTriggered:!1},lastLeaderboardUpdate=Date.now(),window.arcadeChannel&&(window.arcadeChannel.unsubscribe(),window.arcadeChannel=null),document.getElementById("arcade-leaderboard")),t=(t&&(r=t.querySelector(".leaderboard-header"),t.innerHTML=r?r.outerHTML:""),document.getElementById("moderatorOtp")),r=(t&&(t.textContent=e),document.getElementById("qrCode")),r=(r&&(t=window.location.origin+window.location.pathname+"#join="+e,new QRious({element:r,value:t,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"})),currentArcadeSession.eventId&&(supabaseClient.from("arcade_events").update({status:"waiting",game_state:{},otp:e}).eq("id",currentArcadeSession.eventId).then(({error:e})=>{e&&console.error("Failed to reset arcade event:",e)}),supabaseClient.from("arcade_participants").delete().eq("event_id",currentArcadeSession.eventId).then(({error:e})=>{e&&console.error("Failed to clear participants:",e)})),document.querySelector(".end-arcade-button")),t=(r&&r.classList.remove("visible"),document.querySelectorAll(".celebration-overlay, .home-button-container").forEach(e=>e.remove()),currentGame={currentIndex:0,correctStreak:0,wrongStreak:0,words:[],wordsCompleted:0,coins:0,lastBroadcast:Date.now()},document.querySelectorAll('.stage-checkboxes input[type="checkbox"]').forEach(e=>{e.checked=!1}),document.getElementById("wordGoalInput")),r=document.getElementById("wordGoalSlider"),a=document.getElementById("wordGoalDisplay");t&&(t.value="50"),r&&(r.value="50"),a&&(a.textContent="50"),console.log("Arcade session completely reset with new OTP:",e)}function finishCelebrationAndGoHome(){document.querySelector(".celebration-overlay")?.remove(),document.querySelector(".home-button-container")?.remove(),window.celebrationConfettiInterval&&clearInterval(window.celebrationConfettiInterval),document.querySelectorAll(".confetti, .celebration-emoji, .winner-entry.celebrating").forEach(e=>e.remove()),cleanupModeratorInactivityMonitoring(),resetArcadeSession(),showScreen("welcome-screen")}function handleGameEnd(e){console.log("Game End Payload:",e),e&&(e.forcedEnd?showScreen("welcome-screen"):(currentUser?.id===e.teacherId?showModeratorVictoryScreen:showFinalResultsForPlayer)(e.podiumPlayers||[]))}function hidePersonalVictoryScreen(){let e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout(()=>{document.body.removeChild(e)},300))}async function endArcadeForAll(){currentArcadeSession.state="ended",currentArcadeSession.endTime=Date.now();let a=[];for(currentArcadeSession.podiumRanks&&(Object.entries(currentArcadeSession.podiumRanks).forEach(([t,e])=>{var r=currentArcadeSession.participants.find(e=>e.username===t);r&&a.push({username:r.username,wordsCompleted:r.wordsCompleted||0,coins:r.coins||0,rank:e.rank,completionTime:e.completionTime})}),a.sort((e,t)=>e.rank-t.rank));a.length<3;){var e=a.length+1;a.push({username:"---",wordsCompleted:0,coins:0,rank:e})}console.log("Final podium players:",a.map(e=>({username:e.username,rank:e.rank,wordsCompleted:e.wordsCompleted}))),await window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",podiumPlayers:a,teacherId:currentArcadeSession.teacherId,duration:currentArcadeSession.endTime-(currentArcadeSession.startTime||currentArcadeSession.endTime)}}),(currentUser?.id===currentArcadeSession.teacherId?showModeratorVictoryScreen:showFinalResultsForPlayer)(a)}function showFinalResults(e){(currentUser?.id===currentArcadeSession.teacherId?showModeratorVictoryScreen:showPlayerFinalResults)(e)}function getOrdinal(e){var t=["th","st","nd","rd"],r=e%100;return e+(t[(r-20)%10]||t[r]||t[0])}function initializeModeratorIdleDetection(){let e=Date.now(),o=!1,s=null,i=null;function t(){e=Date.now(),o&&l()}let r=setInterval(()=>{if("active"!==currentArcadeSession.state||currentUser?.id!==currentArcadeSession.teacherId)clearInterval(r);else if(5e3<Date.now()-e&&!o){o=!0;let t=5,e=((i=document.createElement("div")).className="idle-timer-overlay",i.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            pointer-events: none;
        `,document.createElement("div")),r=(e.style.cssText=`
            background: var(--primary-dark);
            padding: 2rem;
            border-radius: 20px;
            border: 2px solid var(--gold);
            text-align: center;
        `,document.createElement("h2")),a=(r.textContent="Game Inactive",r.style.color="var(--gold)",document.createElement("div")),n=(a.className="countdown-timer",a.textContent=t,a.style.cssText=`
            font-size: 5rem;
            color: var(--gold);
            margin: 1rem 0;
            font-weight: bold;
        `,document.createElement("p"));n.textContent="No activity detected. Returning to welcome screen...",e.appendChild(r),e.appendChild(a),e.appendChild(n),i.appendChild(e),document.body.appendChild(i),s=setInterval(()=>{var e;t--,(a.textContent=t)<=0&&(l(),3<=(e=currentArcadeSession.participants.filter(e=>e.wordsCompleted>=currentArcadeSession.wordGoal)).length?(e=[...e].sort((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins).slice(0,3).map((e,t)=>({...e,rank:t+1})),currentArcadeSession.state="ended",showModeratorVictoryScreen(e)):showScreen("welcome-screen"))},1e3)}},1e3);function l(){o=!1,s&&(clearInterval(s),s=null),i&&(document.body.removeChild(i),i=null)}var a,n;return a=new MutationObserver(()=>{t()}),(n=document.getElementById("arcade-leaderboard"))&&a.observe(n,{childList:!0,subtree:!0,attributes:!0,characterData:!0}),window.arcadeChannel.on("broadcast",{event:"progress_update"},()=>{t()}),{clearIdleTimer:l,idleCheckInterval:r}}let moderatorActivityTimer=null,countdownTimer=null,lastLeaderboardUpdate=Date.now(),isCountingDown=!1;function initializeModeratorInactivityTimer(){moderatorActivityTimer&&clearTimeout(moderatorActivityTimer),countdownTimer&&clearInterval(countdownTimer),lastLeaderboardUpdate=Date.now(),isCountingDown=!1,createInactivityOverlay(),startInactivityMonitoring(),trackLeaderboardUpdates();var e=document.querySelector(".initialize-button"),t=document.querySelector(".end-arcade-button");currentArcadeSession.isInitialized&&"active"===currentArcadeSession.state?(e&&(e.style.display="none"),t&&t.classList.add("visible")):(e&&(e.style.display="block"),t&&t.classList.remove("visible"))}function createInactivityOverlay(){var e=document.querySelector(".inactivity-overlay"),e=(e&&e.remove(),document.createElement("div"));e.className="inactivity-overlay",e.innerHTML=`
        <div class="countdown-timer">5</div>
        <div class="inactivity-message">No activity detected. Redirecting...</div>
        <div class="countdown-progress">
            <div class="countdown-bar"></div>
        </div>
        <button class="countdown-cancel">Cancel</button>
    `,e.querySelector(".countdown-cancel").addEventListener("click",cancelCountdown),document.body.appendChild(e)}function startInactivityMonitoring(){let t=document.getElementById("moderator-screen");["mousemove","mousedown","keypress","scroll","touchstart"].forEach(e=>{t.addEventListener(e,resetInactivityTimer)}),resetInactivityTimer()}function resetInactivityTimer(){isCountingDown||(moderatorActivityTimer&&clearTimeout(moderatorActivityTimer),moderatorActivityTimer=setTimeout(()=>{5e3<Date.now()-lastLeaderboardUpdate&&startCountdown()},3e3))}function trackLeaderboardUpdates(){var e=document.getElementById("arcade-leaderboard");e&&new MutationObserver(()=>{lastLeaderboardUpdate=Date.now(),isCountingDown&&cancelCountdown()}).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}function startCountdown(){isCountingDown=!0;var e=document.querySelector(".inactivity-overlay");e&&e.classList.add("visible");let t=5,r=e.querySelector(".countdown-timer"),a=e.querySelector(".countdown-bar");r.textContent=t,a.style.transform="scaleX(1)",countdownTimer=setInterval(()=>{t--,r.textContent=t,a.style.transform=`scaleX(${t/5})`,t<=0&&(clearInterval(countdownTimer),handleCountdownComplete())},1e3)}function cancelCountdown(){var e=document.querySelector(".inactivity-overlay");e&&e.classList.remove("visible"),isCountingDown=!1,countdownTimer&&clearInterval(countdownTimer),resetInactivityTimer()}function handleCountdownComplete(){if(currentArcadeSession.completedPlayers&&3<=currentArcadeSession.completedPlayers.length){let a=[];currentArcadeSession.podiumRanks?(Object.entries(currentArcadeSession.podiumRanks).forEach(([t,e])=>{var r=currentArcadeSession.participants.find(e=>e.username===t);r&&a.push({username:r.username,wordsCompleted:r.wordsCompleted||0,coins:r.coins||0,rank:e.rank})}),a.sort((e,t)=>e.rank-t.rank)):[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted-e.wordsCompleted).slice(0,3).forEach((e,t)=>{a.push({...e,rank:t+1})}),showModeratorVictoryScreen(a)}else showScreen("welcome-screen")}let moderatorInactivity={activityTimer:null,countdownTimer:null,lastLeaderboardUpdate:Date.now(),isCountingDown:!1,isInitialized:!1,isGameActive:!1};function initializeModeratorInactivityTimer(){isModeratorScreenActive()&&currentArcadeSession.isInitialized&&(moderatorInactivity.isGameActive=!0,clearModeratorTimers(),moderatorInactivity.lastLeaderboardUpdate=Date.now(),moderatorInactivity.isCountingDown=!1,moderatorInactivity.isInitialized=!0,createModeratorInactivityOverlay(),startModeratorInactivityMonitoring(),trackModeratorLeaderboardUpdates(),console.log("Moderator inactivity timer initialized"))}function isModeratorScreenActive(){var e=document.getElementById("moderator-screen");return e&&e.classList.contains("visible")}function clearModeratorTimers(){moderatorInactivity.activityTimer&&(clearTimeout(moderatorInactivity.activityTimer),moderatorInactivity.activityTimer=null),moderatorInactivity.countdownTimer&&(clearInterval(moderatorInactivity.countdownTimer),moderatorInactivity.countdownTimer=null)}function createModeratorInactivityOverlay(){var e=document.querySelector(".moderator-inactivity-overlay"),e=(e&&e.remove(),document.createElement("div")),t=(e.className="moderator-inactivity-overlay",e.innerHTML=`
        <div class="moderator-countdown-timer">5</div>
        <div class="moderator-inactivity-message">No leaderboard activity detected. Redirecting...</div>
        <div class="moderator-countdown-progress">
            <div class="moderator-countdown-bar"></div>
        </div>
        <button class="moderator-countdown-cancel">Cancel</button>
    `,e.querySelector(".moderator-countdown-cancel").addEventListener("click",cancelModeratorCountdown),document.getElementById("moderator-screen"));t&&t.appendChild(e)}function startModeratorInactivityMonitoring(){let t=document.getElementById("moderator-screen");t&&(["mousemove","mousedown","keypress","scroll","touchstart"].forEach(e=>{t.addEventListener(e,resetModeratorInactivityTimer)}),document.addEventListener("visibilitychange",()=>{document.hidden||!isModeratorScreenActive()?clearModeratorTimers():moderatorInactivity.isGameActive&&isModeratorScreenActive()&&resetModeratorInactivityTimer()}),resetModeratorInactivityTimer())}function resetModeratorInactivityTimer(){isModeratorScreenActive()&&moderatorInactivity.isGameActive&&!moderatorInactivity.isCountingDown&&(moderatorInactivity.activityTimer&&clearTimeout(moderatorInactivity.activityTimer),moderatorInactivity.activityTimer=setTimeout(()=>{5e3<Date.now()-moderatorInactivity.lastLeaderboardUpdate&&isModeratorScreenActive()&&startModeratorCountdown()},3e3))}function trackModeratorLeaderboardUpdates(){var e=document.getElementById("arcade-leaderboard");e&&new MutationObserver(()=>{isModeratorScreenActive()&&moderatorInactivity.isGameActive&&(moderatorInactivity.lastLeaderboardUpdate=Date.now(),moderatorInactivity.isCountingDown)&&cancelModeratorCountdown()}).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}function startModeratorCountdown(){if(isModeratorScreenActive()&&moderatorInactivity.isGameActive){moderatorInactivity.isCountingDown=!0;var a=document.querySelector(".moderator-inactivity-overlay");a&&a.classList.add("visible");let e=5,t=a.querySelector(".moderator-countdown-timer"),r=a.querySelector(".moderator-countdown-bar");t.textContent=e,r.style.transform="scaleX(1)",moderatorInactivity.countdownTimer=setInterval(()=>{isModeratorScreenActive()?(e--,t.textContent=e,r.style.transform=`scaleX(${e/5})`,e<=0&&(clearInterval(moderatorInactivity.countdownTimer),handleModeratorCountdownComplete())):cancelModeratorCountdown()},1e3)}}function cancelModeratorCountdown(){var e=document.querySelector(".moderator-inactivity-overlay");e&&e.classList.remove("visible"),moderatorInactivity.isCountingDown=!1,moderatorInactivity.countdownTimer&&(clearInterval(moderatorInactivity.countdownTimer),moderatorInactivity.countdownTimer=null),isModeratorScreenActive()&&moderatorInactivity.isGameActive&&resetModeratorInactivityTimer()}function handleModeratorCountdownComplete(){if(!currentArcadeSession.celebrationTriggered){var e=currentArcadeSession.participants.filter(e=>e.wordsCompleted>=currentArcadeSession.wordGoal),e=e&&3<=e.length;if(currentArcadeSession.celebrationTriggered=!0,e){let a=[];currentArcadeSession.podiumRanks?(Object.entries(currentArcadeSession.podiumRanks).forEach(([t,e])=>{var r=currentArcadeSession.participants.find(e=>e.username===t);r&&a.push({username:r.username,wordsCompleted:r.wordsCompleted||0,coins:r.coins||0,rank:e.rank})}),a.sort((e,t)=>e.rank-t.rank)):[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted-e.wordsCompleted).slice(0,3).forEach((e,t)=>{a.push({...e,rank:t+1})}),startLeaderboardCelebration(a)}else showScreen("welcome-screen")}}function cleanupModeratorInactivityMonitoring(){clearModeratorTimers(),moderatorInactivity.isGameActive=!1,moderatorInactivity.isInitialized=!1,moderatorInactivity.isCountingDown=!1;var e=document.querySelector(".moderator-inactivity-overlay");e&&e.remove()}function startLeaderboardCelebration(e){var t=document.querySelector(".moderator-inactivity-overlay");t&&t.classList.remove("visible");let r=document.createElement("div"),a=(r.className="celebration-overlay",document.body.appendChild(r),setTimeout(()=>r.classList.add("visible"),10),document.getElementById("arcade-leaderboard").querySelectorAll(".leaderboard-entry")),o=new Map,n=(e.forEach(n=>{a.forEach(t=>{var r=t.querySelector("[data-username]");if(r){r=r.dataset.username;if(r===n.username){var a=t.getBoundingClientRect();o.set(r,{left:a.left,top:a.top,width:a.width,height:a.height});let e=t.cloneNode(!0);e.classList.add("winner-entry","celebrating"),1===n.rank?(e.classList.add("first-place"),(r=document.createElement("div")).className="winner-label",r.textContent="CHAMPION",e.appendChild(r),addWinnerEmojis(e,["👑","🏆","🌟"],n.rank)):2===n.rank?(e.classList.add("second-place"),(t=document.createElement("div")).className="winner-label",t.textContent="RUNNER-UP",e.appendChild(t),addWinnerEmojis(e,["🥈","✨"],n.rank)):3===n.rank&&(e.classList.add("third-place"),(r=document.createElement("div")).className="winner-label",r.textContent="BRONZE MEDAL",e.appendChild(r),addWinnerEmojis(e,["🥉","🎉"],n.rank)),e.style.position="fixed",e.style.left=a.left+"px",e.style.top=a.top+"px",e.style.width=a.width+"px",e.style.height=a.height+"px",e.style.zIndex=103-n.rank,document.body.appendChild(e),setTimeout(()=>{e.classList.add("centered")},50)}}})}),setTimeout(()=>{startConfettiShower(),window.arcadeChannel.send({type:"broadcast",event:"celebration",payload:{winners:e.map(e=>({username:e.username,rank:e.rank,wordsCompleted:e.wordsCompleted,coins:e.coins}))}})},1500),document.createElement("div"));n.className="home-button-container",n.innerHTML=`
       <button class="start-button" onclick="finishCelebrationAndGoHome()">
           Return to Home
       </button>
   `,document.body.appendChild(n),setTimeout(()=>n.classList.add("visible"),2500)}function safeUpdateWordsCompleted(e,t){var r,a;return!!t&&-1!==(r=currentArcadeSession.participants.findIndex(e=>e.username===t))&&(e<(a=(r=currentArcadeSession.participants[r]).wordsCompleted||0)?(console.warn(`Prevented progress reset for ${t}: ${a} → `+e),!1):(r.wordsCompleted=e,!0))}function addWinnerEmojis(e,t,s){setTimeout(()=>{t.forEach((e,t)=>{var r=document.createElement("div");r.className="celebration-emoji",r.textContent=e;let a,n,o;n=1===s?(o=3,a=t%2==0?5+3*t+"%":95-3*t+"%",5+2*t+"%"):2===s?(o=2.5,a=t%2==0?"5%":"95%",40+5*t+"%"):(o=2,a=t%2==0?15+5*t+"%":85-5*t+"%","90%"),r.style.fontSize=o+"rem",r.style.left=a,r.style.top=n,r.style.zIndex=300,r.style.animationDelay=1.8+.3*t+"s",document.body.appendChild(r)})},1800)}function startConfettiShower(){let i=["#FFD700","#FF1493","#00BFFF","#7CFC00","#FF4500","#9400D3","#FF8C00","#1E90FF","#32CD32","#FF69B4"];t();var e=setInterval(t,800);function t(){for(let e=0;e<60;e++){let e=document.createElement("div");e.className="confetti";var t=5+15*Math.random(),r=i[Math.floor(Math.random()*i.length)],a=100*Math.random(),n=3*Math.random(),o=3+4*Math.random(),s=.5<Math.random();e.style.width=t+"px",e.style.height=t+"px",e.style.backgroundColor=r,e.style.left=a+"vw",e.style.animationDuration=o+"s",e.style.animationDelay=n+"s",e.style.borderRadius=s?"0":"50%",document.body.appendChild(e),setTimeout(()=>{e.remove()},1e3*(o+n))}}window.celebrationConfettiInterval=e}function setupCelebrationHandler(){window.arcadeChannel&&window.arcadeChannel.on("broadcast",{event:"celebration"},({payload:e})=>{e.winners&&currentArcadeSession.playerName&&(e=e.winners.find(e=>e.username===currentArcadeSession.playerName))&&showPersonalVictoryCelebration(e.rank)})}function showPersonalVictoryCelebration(t){if(!currentArcadeSession.winnerScreenShown){currentArcadeSession.winnerScreenShown=!0;let e=document.createElement("div");e.className="personal-victory-overlay",e.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.5s ease;
    `;var r={1:{title:"🏆 CHAMPION! 🏆",message:"Incredible! You've claimed the top spot!",emoji:"👑",color:"var(--gold)"},2:{title:"🥈 RUNNER UP! 🥈",message:"Amazing job! You've secured second place!",emoji:"⭐",color:"var(--silver)"},3:{title:"🥉 BRONZE MEDALIST! 🥉",message:"Well done! You've earned third place!",emoji:"🌟",color:"var(--bronze)"}}[t]||{title:"GREAT PERFORMANCE!",message:"You've completed the challenge!",emoji:"🎉",color:"var(--accent)"};e.innerHTML=`
        <div style="font-size: 8rem; margin-bottom: 1rem;">${r.emoji}</div>
        <h1 style="color: ${r.color}; font-size: 3rem; margin-bottom: 1rem;">${r.title}</h1>
        <p style="font-size: 1.5rem; margin-bottom: 2rem; text-align: center; max-width: 80%;">
            ${r.message}
        </p>
        <div style="margin: 2rem 0; display: flex; gap: 2rem;">
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">YOUR RANK</div>
                <div style="font-size: 3rem; color: ${r.color};">${t}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">WORDS COMPLETED</div>
                <div style="font-size: 3rem; color: var(--text);">${currentGame.wordsCompleted||0}</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">COINS EARNED</div>
                <div style="font-size: 3rem; color: var(--gold);">${currentGame.coins||0}</div>
            </div>
        </div>
        <button class="start-button" style="margin-top: 2rem; padding: 1rem 2rem;" onclick="closePersonalVictory()">
            Continue
        </button>
    `,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1",startPlayerConfetti()},100)}}function startPlayerConfetti(){let t=["#FFD700","#FF1493","#00BFFF","#7CFC00","#FF4500","#9400D3","#FF8C00","#1E90FF","#32CD32","#FF69B4"];function e(){for(let e=0;e<40;e++){let e=document.createElement("div");e.className="player-confetti",e.style.cssText=`
                position: fixed;
                width: ${5+10*Math.random()}px;
                height: ${5+10*Math.random()}px;
                background-color: ${t[Math.floor(Math.random()*t.length)]};
                top: -20px;
                left: ${100*Math.random()}vw;
                opacity: 1;
                z-index: 2001;
                border-radius: ${.5<Math.random()?"0":"50%"};
                animation: confettiFall ${3+3*Math.random()}s linear ${2*Math.random()}s forwards;
            `,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}}e();let r=setInterval(e,1e3);window.playerConfettiInterval=r,setTimeout(()=>{clearInterval(r)},1e4)}function closePersonalVictory(){window.playerConfettiInterval&&clearInterval(window.playerConfettiInterval),document.querySelectorAll(".player-confetti").forEach(e=>e.remove());let e=document.querySelector(".personal-victory-overlay");e&&(e.style.opacity="0",setTimeout(()=>{e.remove(),exitArcade()},500))}function handleCustomLevelCompletion(){if(clearTimer(),console.log("Custom level completion: Level "+customGameState.currentLevel),console.log("Words count in list: "+customGameState.words.length),currentGame.streakBonus&&currentGame.correctAnswers===currentGame.words.length){let e=currentGame.firstAttempt?5:3;CoinsManager.updateCoins(e).then(()=>{pulseCoins(e),customGameState.wordsCompleted+=currentGame.words.length,customGameState.completedLevels.add(customGameState.currentLevel);var t=customGameState.words.length,r=12<=t?9:9<=t?6:3;if(console.log("Max level for this list: "+r),console.log("Current level: "+customGameState.currentLevel),3===customGameState.currentLevel&&t<=6)console.log("Level 3 completed with 6 or fewer words - showing completion"),setTimeout(()=>showCustomCompletionScreen(),1500);else if(6===customGameState.currentLevel&&t<=9)console.log("Level 6 completed with 7-9 words - showing completion"),setTimeout(()=>showCustomCompletionScreen(),1500);else if(9===customGameState.currentLevel&&10<=t)console.log("Level 9 completed with 10+ words - showing completion"),setTimeout(()=>showCustomCompletionScreen(),1500);else if(customGameState.currentLevel>=r)console.log("Max level reached - showing completion"),setTimeout(()=>showCustomCompletionScreen(),1500);else{let e=customGameState.currentLevel+1;t=customGameState.getWordsForLevel(e),r=document.getElementById("question-screen").getBoundingClientRect();createParticles(r.left+r.width/2,r.top+r.height/2),t&&0!==t.words.length?(console.log("Moving to next level: "+e),customGameState.currentLevel=e,setTimeout(()=>startCustomLevel(e),1500)):(console.log("No valid data for next level - showing completion"),setTimeout(()=>showCustomCompletionScreen(),1500))}})}else console.log("Level not completed perfectly - restarting level "+customGameState.currentLevel),setTimeout(()=>startCustomLevel(customGameState.currentLevel),1500);saveProgress()}function showCustomCompletionScreen(){var e=document.createElement("div"),t=(e.className="completion-overlay",gameState.coins-customGameState.startCoins);e.innerHTML=`
        <div class="completion-content">
            <h2>Practice Complete!</h2>
            <div class="completion-stats">
                <div class="stat-item">
                    <i class="fas fa-book"></i>
                    <span>Words Practiced: ${customGameState.wordsCompleted}</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-coins"></i>
                    <span>Coins Earned: ${t}</span>
                </div>
            </div>
            <button onclick="exitCustomPractice()" class="victory-button">
                Continue
            </button>
        </div>
    `,document.body.appendChild(e)}async function handleCustomPracticeAnswer(t,r=!1){if(t){if(currentGame.currentIndex++,!r){let e=0;var r=awardTimeBonus();0<r&&(e+=r,pulseCoins(r)),currentGame.firstAttempt?(e+=3,pulseCoins(3)):(e+=1,pulseCoins(1));try{await CoinsManager.updateCoins(e),updatePerkButtons()}catch(t){console.error("Error updating total coins:",t)}currentGame.correctAnswers++,currentUser&&"premium"===currentUser.status&&(r=currentGame.currentIndex-1,await trackWordEncounter((currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[r],"custom"))}}else{currentGame.firstAttempt=!1,currentGame.streakBonus=!1,currentGame.wrongStreak++;try{await CoinsManager.updateCoins(-3),updatePerkButtons()}catch(t){console.error("Error updating coins:",t)}if(0<currentGame.currentIndex&&(currentGame.progressLost++,currentGame.currentIndex=Math.max(0,currentGame.currentIndex-1)),3<=currentGame.wrongStreak)return showGameOverOverlay(),void(document.querySelector(".restart-button").onclick=()=>{document.querySelector(".failure-overlay").style.display="none",startCustomLevel(currentGame.customLevel)})}let a=(currentGame.isHebrewToEnglish?currentGame.words:currentGame.translations)[Math.max(0,currentGame.currentIndex-1)],e=document.querySelectorAll(".buttons button");e.forEach(e=>{e.textContent===a?e.classList.add("correct"):!t&&event&&event.target&&e.textContent===event.target.textContent&&e.classList.add("wrong")}),updateProgressCircle(),saveProgress(),setTimeout(()=>{e.forEach(e=>{e.classList.remove("correct","wrong")}),(currentGame.currentIndex<currentGame.words.length?(loadNextQuestion(),updatePerkButtons):handleCustomLevelCompletion)()},333)}function showReviveOverlay(){let e=document.createElement("div"),t=(e.className="revive-overlay",e.innerHTML=`
        <div class="revive-content">
            <div class="ankh-symbol">☥</div>
            <h2 class="revive-title">Revive?</h2>
            <div class="revive-timer">5</div>
            <button class="revive-button">Revive</button>
        </div>
    `,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("show")}),5),r=e.querySelector(".revive-timer"),a=setInterval(()=>{t--,(r.textContent=t)<=0&&(clearInterval(a),handleReviveTimeout())},1e3);e.querySelector(".revive-button").onclick=()=>{clearInterval(a),handleRevive()},e.dataset.intervalId=a}function handleReviveTimeout(){let e=document.querySelector(".revive-overlay");e&&(e.classList.remove("show"),setTimeout(()=>{e.remove(),showScreen("welcome-screen")},500))}function handleRevive(){let t=document.querySelector(".revive-overlay");if(t){t.querySelector(".revive-content").innerHTML=`
            <div class="resurrection-animation">
                <div class="progress-circle resurrection-circle">
                    <svg width="100%" height="100%" viewBox="0 0 120 120">
                        <circle class="bg" cx="60" cy="60" r="54" stroke-width="8"/>
                        <circle class="resurrection-progress" cx="60" cy="60" r="54" stroke-width="8"/>
                    </svg>
                    <div class="ankh-symbol resurrection-ankh">☥</div>
                </div>
            </div>
        `;let e=t.querySelector(".resurrection-progress");var r=2*Math.PI*54;e.style.strokeDasharray=r+" "+r,e.style.strokeDashoffset=r,createResurrectionParticles(),setTimeout(()=>{e.style.transition="stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1)",e.style.strokeDashoffset="0"},100),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.remove(),currentGame.wrongStreak=0,timeRemaining=currentGame.initialTimeRemaining,currentGame.isCustomPractice?startCustomLevel(currentGame.customLevel):startLevel(gameState.currentLevel)},500)},2500)}}function createResurrectionParticles(){var e=document.querySelector(".resurrection-animation");if(e){var e=e.getBoundingClientRect(),t=e.left+e.width/2,r=e.top+e.height/2;for(let e=0;e<40;e++){let e=document.createElement("div");e.className="resurrection-particle";var a=Math.random()*Math.PI*2,n=100+150*Math.random(),o=1+1.5*Math.random(),s=.5*Math.random(),i=3+7*Math.random(),l=Math.cos(a)*n,a=Math.sin(a)*n;e.style.cssText=`
            position: fixed;
            left: ${t}px;
            top: ${r}px;
            width: ${i}px;
            height: ${i}px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0;
            z-index: 1001;
            box-shadow: 0 0 ${i}px #FFD700;
            transform: translate(-50%, -50%);
            animation: particleFlow ${o}s ease-out ${s}s forwards;
        `,e.style.setProperty("--end-x",l+"px"),e.style.setProperty("--end-y",a+"px"),document.body.appendChild(e),setTimeout(()=>{e.remove()},1e3*(o+s))}}}function updateSidePanelLink(){var e=document.querySelector('.nav-link[onclick*="stage-screen"]');e&&e.setAttribute("onclick","showScreen('stage-cascade-screen'); return false;")}function renderStageCascadeScreen(){let i=document.querySelector(".stages-container");var e;i&&(i.innerHTML="",console.log("Current unlocked sets:",gameState.unlockedSets),gameStructure.stages.forEach(t=>{var e=document.createElement("div"),r=(e.className="stage-wrapper",e.dataset.stage=t.id,t.numSets),a=gameState.unlockedSets[t.id]||new Set,n=a.size;let o=0;0<n&&a.forEach(e=>{isSetCompleted(t.id,e)&&o++});var n=getStageIcon(t.id),a=getStageHebrewName(t.id),s=getStageDescription(t.id),r=getStageStatus(t.id,o,r);e.innerHTML=`
      <div class="stage-button">
        <div class="stage-info">
          <div class="stage-icon">
            <i class="${n}"></i>
          </div>
          <div class="stage-text">
            <div class="stage-name">${a} - Stage ${t.id}</div>
            <div class="stage-desc">${s}</div>
          </div>
        </div>
        <div class="stage-status">${r}</div>
        <div class="stage-toggle">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
      
      <div class="sets-container">
        <div class="sets-grid" id="sets-grid-${t.id}"></div>
      </div>
    `,i.appendChild(e),populateSetsGrid(t.id)}),addStageToggleListeners(),gameState.currentStage&&(e=document.querySelector(`.stage-wrapper[data-stage="${gameState.currentStage}"]`))&&e.classList.add("open"),e=document.getElementById("stage-cascade-screen"))&&(document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("visible")}),e.classList.add("visible"))}function showStageCascadeScreen(){if(currentUser){var e=localStorage.getItem("simploxProgress");if(e)try{updateGameStateFromProgress(JSON.parse(e))}catch(e){console.error("Error parsing local progress:",e)}}console.log("Showing stage cascade screen, current game state:",{currentStage:gameState.currentStage,unlockedSets:gameState.unlockedSets,completedLevels:gameState.completedLevels?Array.from(gameState.completedLevels).length:0});let i=document.querySelector(".stages-container");i&&(i.innerHTML="",gameStructure.stages.forEach(o=>{var e=document.createElement("div"),t=(e.className="stage-wrapper",e.dataset.stage=o.id,o.numSets),r=gameState.unlockedSets[o.id]||new Set;console.log(`Stage ${o.id} unlocked sets:`,Array.from(r)),r.size;let s=0;0<r.size&&r.forEach(t=>{o.id;var r=gameStructure.stages[o.id-1].levelsPerSet,a=new Set;for(let e=1;e<=r;e++){var n=o.id+`_${t}_`+e;(gameState.completedLevels.has(n)||gameState.perfectLevels.has(n))&&a.add(e)}a.size===r&&(s++,console.log(`Set ${o.id}-${t} is fully completed`))});var r=getStageIcon(o.id),a=getStageHebrewName(o.id),n=getStageDescription(o.id),t=getStageStatus(o.id,s,t);e.innerHTML=`
            <div class="stage-button">
                <div class="stage-info">
                    <div class="stage-icon">
                        <i class="${r}"></i>
                    </div>
                    <div class="stage-text">
                        <div class="stage-name">${a} - Stage ${o.id}</div>
                        <div class="stage-desc">${n}</div>
                    </div>
                </div>
                <div class="stage-status">${t}</div>
                <div class="stage-toggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            
            <div class="sets-container">
                <div class="sets-grid" id="sets-grid-${o.id}"></div>
            </div>
        `,i.appendChild(e),populateSetsGrid(o.id)}),addStageToggleListeners(),gameState.currentStage&&(e=document.querySelector(`.stage-wrapper[data-stage="${gameState.currentStage}"]`))&&e.classList.add("open"),e=document.getElementById("stage-cascade-screen"))&&(document.querySelectorAll(".screen").forEach(e=>{e.classList.remove("visible")}),e.classList.add("visible"))}function updateGameStateFromProgress(e){console.log("Updating game state from saved progress"),e.unlocked_sets&&(console.log("Updating unlocked sets from:",e.unlocked_sets),gameState.unlockedSets={},Object.entries(e.unlocked_sets).forEach(([e,t])=>{gameState.unlockedSets[e]=new Set(Array.isArray(t)?t:[])})),e.unlocked_levels&&(console.log("Updating unlocked levels from saved data"),gameState.unlockedLevels={},Object.entries(e.unlocked_levels).forEach(([e,t])=>{gameState.unlockedLevels[e]=new Set(Array.isArray(t)?t:[])})),e.completed_levels&&(console.log("Updating completed levels from saved data"),gameState.completedLevels=new Set(e.completed_levels)),e.perfect_levels&&(console.log("Updating perfect levels from saved data"),gameState.perfectLevels=new Set(e.perfect_levels))}function getStageIcon(e){return{1:"fas fa-book",2:"fas fa-graduation-cap",3:"fas fa-school",4:"fas fa-university",5:"fas fa-brain"}[e]||"fas fa-star"}function getStageHebrewName(e){return{1:"מתחילים",2:"יסודי",3:"חטיבת ביניים",4:"תיכון",5:"אוניברסיטה"}[e]||"Stage "+e}function getStageDescription(e){return{1:"Beginner level words and simple phrases",2:"Elementary level vocabulary and structures",3:"Middle school level vocabulary",4:"High school level vocabulary",5:"University level vocabulary"}[e]||"Advanced vocabulary"}function getStageStatus(e,t,r){return 2<e&&(!currentUser||"premium"!==currentUser.status)?"Premium Feature":t+`/${r} Sets Completed`}function populateSetsGrid(s){var i=document.getElementById("sets-grid-"+s);if(i){console.log("Populating sets grid for stage "+s),console.log("Unlocked sets:",gameState.unlockedSets);let e=gameStructure.stages[s-1],n=gameState.unlockedSets[s]||new Set,o=currentUser?currentUser.status:"unregistered";console.log(`Stage ${s} unlocked sets:`,Array.from(n)),i.innerHTML="";for(let a=1;a<=e.numSets;a++){let t=document.createElement("div"),e=n.has(a),r=!1;2<=s&&1<a&&"premium"!==o&&(r=!0),t.className="set-button",e&&!r?t.classList.add("active"):t.classList.add("locked");var l=isSetCompleted(s,a);t.innerHTML=`
      <span>Set ${a}</span>
      ${l?'\n      <div class="completed-indicator">\n        <i class="fas fa-check-circle"></i>\n      </div>':""}
      ${!e||r?`
      <div class="lock-icon">
        <i class="fas ${r?"fa-crown crown-premium":"fa-lock"}"></i>
      </div>`:""}
    `,e&&!r?t.onclick=()=>{gameState.currentStage=s,showLevelScreen(gameState.currentSet=a)}:r&&(t.onclick=()=>showUpgradePrompt(),setTimeout(()=>{var e=t.querySelector(".fa-crown");e&&e.addEventListener("click",e=>{e.stopPropagation(),showUpgradePrompt()})},0)),i.appendChild(t)}}}function isSetCompleted(t,r){var e=gameStructure.stages;if(!e||!e[t-1])return console.warn(`Invalid stage ${t} in isSetCompleted`),!1;var a=e[t-1].levelsPerSet;let n=0;console.log(`Checking if set ${t}-${r} is completed. Total levels: `+a);for(let e=1;e<=a;e++){var o=t+`_${r}_`+e;(gameState.completedLevels.has(o)||gameState.perfectLevels.has(o))&&(n++,console.log(`Level ${o} is completed`))}e=n===a;return console.log(`Set ${t}-${r} completion check: ${n}/${a} = `+e),e}function handleCrownClick(e){e.stopPropagation(),currentUser?(localStorage.removeItem("upgradeRequested_"+currentUser.id),showUpgradePrompt()):(showAuthModal(),setTimeout(()=>{var e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))},100))}function forceShowUpgradeForm(){currentUser?localStorage.removeItem("upgradeRequested_"+currentUser.id):localStorage.removeItem("upgradeRequested_guest"),showScreen("upgrade-screen")}function addStageToggleListeners(){document.querySelectorAll(".stage-wrapper .stage-button").forEach(t=>{t.addEventListener("click",e=>{t.closest(".stage-wrapper").classList.toggle("open"),e.stopPropagation()})})}function ensureScreenExists(e){var t;document.getElementById(e)||(console.warn(`Screen ${e} doesn't exist. Creating it.`),(t=document.createElement("div")).id=e,t.className="screen",document.body.appendChild(t))}function safeShowScreen(e,t=!1){ensureScreenExists(e),showScreen(e,t)}function updateSidePanelLinks(){var e=document.querySelector('.nav-link[onclick*="stage-screen"]');e&&e.setAttribute("onclick","safeShowScreen('stage-cascade-screen'); return false;"),document.querySelectorAll('button[onclick*="stage-screen"]').forEach(e=>{var t=e.getAttribute("onclick");t&&t.includes("stage-screen")&&e.setAttribute("onclick",t.replace("stage-screen","stage-cascade-screen"))})}function initializeStageCascadeScreen(){var e,t=document.getElementById("stage-cascade-screen");t.querySelector(".stages-container")||((e=document.createElement("div")).className="stages-container",t.appendChild(e))}function toggleSidePanel(){var e=document.querySelector(".side-panel"),t=document.querySelector(".hamburger-button"),r=document.querySelector(".modal-overlay");e.classList.contains("open")?(e.classList.remove("open"),t.classList.remove("open"),r&&r.classList.remove("open")):(e.classList.add("open"),t.classList.add("open"),r&&r.classList.add("open"))}function hasExistingProgress(){if(0<gameState.completedLevels.size||0<gameState.perfectLevels.size)return!0;for(let e=1;e<=5;e++){var t=gameState.unlockedSets[e];if((1!==e||!t||9!==t.size)&&(t&&1<t.size))return!0}var e=localStorage.getItem("simploxProgress");if(e){e=JSON.parse(e);if(e.completedLevels&&0<e.completedLevels.length)return!0;if(e.perfectLevels&&0<e.perfectLevels.length)return!0}return!1}function findFurthestLevelInStage(e){if(!gameState.unlockedSets[e])return null;var t,r=Array.from(gameState.unlockedSets[e]).sort((e,t)=>t-e);for(t of r){var a,n=e+"_"+t;if(gameState.unlockedLevels[n])for(a of Array.from(gameState.unlockedLevels[n]).sort((e,t)=>t-e)){var o=`${e}_${t}_`+a;if(!gameState.perfectLevels.has(o)&&!gameState.completedLevels.has(o))return{stage:e,set:t,level:a}}}var s=gameStructure.stages[e-1],i=r[0];return i<s.numSets?{stage:e,set:i+1,level:1}:e<5?{stage:e+1,set:1,level:1}:{stage:e,set:r[0],level:1}}function showGradeLevelSelector(){let r=document.createElement("div");r.className="modal-backdrop",r.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    `;var e=document.createElement("div");e.className="grade-level-modal",e.style.cssText=`
        background: var(--glass);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
    `,e.innerHTML=`
        <h2 style="color: var(--gold); margin-bottom: 1.5rem;">What grade level are you?</h2>
        <p style="margin-bottom: 2rem; opacity: 0.9;">Choose your education level for the best learning experience:</p>
        <div class="grade-options" style="display: flex; flex-direction: column; gap: 1rem;">
            <button class="grade-option" data-stage="2" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-school" style="margin-right: 0.5rem;"></i> Elementary School
            </button>
            <button class="grade-option" data-stage="3" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-graduation-cap" style="margin-right: 0.5rem;"></i> Junior High School
            </button>
            <button class="grade-option" data-stage="4" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-user-graduate" style="margin-right: 0.5rem;"></i> High School
            </button>
            <button class="grade-option" data-stage="5" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-university" style="margin-right: 0.5rem;"></i> University
            </button>
        </div>
    `,document.body.appendChild(r),r.appendChild(e),e.querySelectorAll(".grade-option").forEach(t=>{t.addEventListener("mouseover",()=>{t.style.background="rgba(255,255,255,0.2)",t.style.transform="translateY(-2px)"}),t.addEventListener("mouseout",()=>{t.style.background="rgba(255,255,255,0.1)",t.style.transform="translateY(0)"}),t.addEventListener("click",()=>{var e=parseInt(t.dataset.stage);localStorage.setItem("preferredStage",e),r.remove(),gameState.currentStage=e,startLevel(gameState.currentSet=1)})})}function setupDefaultUnlocks(){console.log("Setting up default unlocks..."),console.log("Before setup:",gameState.unlockedSets,gameState.unlockedLevels),gameState.unlockedSets[1]||(gameState.unlockedSets[1]=new Set);for(let e=1;e<=9;e++){gameState.unlockedSets[1].add(e);var t="1_"+e;gameState.unlockedLevels[t]||(gameState.unlockedLevels[t]=new Set([1]))}for(let e=2;e<=5;e++){gameState.unlockedSets[e]||(gameState.unlockedSets[e]=new Set([1]));var r=e+"_1";gameState.unlockedLevels[r]||(gameState.unlockedLevels[r]=new Set([1]))}Object.entries(gameState.unlockedLevels).forEach(([,t])=>{var r=Math.max(...Array.from(t));for(let e=1;e<r;e++)t.add(e)}),console.log("After setup:",gameState.unlockedSets,gameState.unlockedLevels)}function saveProgress(){console.log("Saving game progress");let r={stage:gameState.currentStage||1,set_number:gameState.currentSet||1,level:gameState.currentLevel||1,coins:gameState.coins||0,perks:gameState.perks||{}};gameState.unlockedSets&&(r.unlocked_sets={},Object.entries(gameState.unlockedSets).forEach(([e,t])=>{r.unlocked_sets[e]=Array.from(t||[])})),gameState.unlockedLevels&&(r.unlocked_levels={},Object.entries(gameState.unlockedLevels).forEach(([e,t])=>{r.unlocked_levels[e]=Array.from(t||[])})),gameState.completedLevels&&0<gameState.completedLevels.size&&(r.completed_levels=Array.from(gameState.completedLevels)),gameState.perfectLevels&&0<gameState.perfectLevels.size&&(r.perfect_levels=Array.from(gameState.perfectLevels)),console.log("Progress data to save:",r),currentUser?(console.log("Saving progress to Supabase for user:",currentUser.id),supabaseClient.from("game_progress").select("*").eq("user_id",currentUser.id).single().then(({data:e,error:t})=>{t?(console.error("Error checking progress schema:",t),saveProgressToLocalStorage(r)):(t="perfect_levels"in e,"completed_levels"in e||(delete r.completed_levels,console.warn("Database schema missing completed_levels column, removing from save data")),t||(delete r.perfect_levels,console.warn("Database schema missing perfect_levels column, removing from save data")),supabaseClient.from("game_progress").update(r).eq("user_id",currentUser.id).then(({error:e})=>{e?(console.error("Failed to save to database, using localStorage:",e),saveProgressToLocalStorage(r)):(console.log("Progress successfully saved to database"),saveProgressToLocalStorage(r),document.dispatchEvent(new CustomEvent("progressSaved",{detail:{gameState:gameState}})))}))})):(console.log("Saving progress to localStorage (guest user)"),saveProgressToLocalStorage(r));var e={stage:gameState.currentStage,set:gameState.currentSet,level:gameState.currentLevel,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(e)),console.log("Game context saved:",e)}function saveProgressToLocalStorage(e){localStorage.setItem("simploxProgress",JSON.stringify(e))}function debugGameProgress(){console.group("Game Progress Debug"),console.log("Current Stage:",gameState.currentStage),console.log("Current Set:",gameState.currentSet),console.log("Current Level:",gameState.currentLevel),console.log("Unlocked Sets:"),Object.entries(gameState.unlockedSets).forEach(([e,t])=>{console.log(`Stage ${e}:`,Array.from(t).sort((e,t)=>e-t))}),console.log("Unlocked Levels:"),Object.entries(gameState.unlockedLevels).forEach(([e,t])=>{console.log(`Set ${e}:`,Array.from(t).sort((e,t)=>e-t))}),console.log("Completed Levels:",Array.from(gameState.completedLevels).sort()),console.log("Perfect Levels:",Array.from(gameState.perfectLevels).sort()),console.groupEnd()}function optimizeMobileRendering(){ParticleSystem.maxParticles=20;debounce(showScreen,200);/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),document.head.insertAdjacentHTML("beforeend",`
            <style>
                @media (max-width: 768px) {
                    .confetti, .particle {
                        display: none;
                    }
                }
            </style>
        `))}function debounce(t,r){let a;return function(...e){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),t(...e)},r)}}function optimizeMobileEvents(){document.addEventListener("touchstart",()=>{},{passive:!0}),document.addEventListener("touchmove",()=>{},{passive:!0})}function initAccessibilityMenu(){var e=document.querySelector(".accessibility-toggle");let t=document.querySelector(".accessibility-modal");var r=document.querySelector(".close-accessibility");loadAccessibilitySettings(),e&&t&&e.addEventListener("click",function(){t.classList.add("show")}),r&&t&&(r.addEventListener("click",function(){t.classList.remove("show")}),t.addEventListener("click",function(e){e.target===t&&t.classList.remove("show")})),document.querySelectorAll(".accessibility-button").forEach(e=>{e.addEventListener("click",function(){var e=this.getAttribute("data-action");applyAccessibilitySetting(e,this.getAttribute("data-value")),"fontSize"!==e&&"reset"!==e&&(document.querySelectorAll(`[data-action="${e}"]`).forEach(e=>e.classList.remove("active")),this.classList.add("active"))})})}function applyAccessibilitySetting(e,t){var r=document.body;switch(e){case"contrast":r.classList.remove("high-contrast","inverted-colors"),"high"===t&&r.classList.add("high-contrast"),"inverted"===t&&r.classList.add("inverted-colors");break;case"theme":r.classList.remove("light-theme","dark-theme"),"light"===t&&r.classList.add("light-theme"),"dark"===t&&r.classList.add("dark-theme");break;case"saturation":r.classList.remove("grayscale"),"grayscale"===t&&r.classList.add("grayscale");break;case"fontSize":let e=parseFloat(getComputedStyle(r).getPropertyValue("--font-scale")||1);"increase"===t?(e=Math.min(e+.1,1.8),r.style.setProperty("--font-scale",e),r.style.fontSize=`calc(1rem * ${e})`):"decrease"===t?(e=Math.max(e-.1,.8),r.style.setProperty("--font-scale",e),r.style.fontSize=`calc(1rem * ${e})`):"reset"===t&&(r.style.removeProperty("--font-scale"),r.style.fontSize="");break;case"fontFamily":r.classList.remove("dyslexic-font"),"dyslexic"===t&&r.classList.add("dyslexic-font");break;case"letterSpacing":r.classList.remove("increased-letter-spacing"),"increased"===t&&r.classList.add("increased-letter-spacing");break;case"animations":r.classList.remove("no-animations","reduced-animations"),"disabled"===t&&r.classList.add("no-animations"),"reduced"===t&&r.classList.add("reduced-animations");break;case"focus":r.classList.remove("high-focus"),"high"===t&&r.classList.add("high-focus");break;case"buttonSize":r.classList.remove("large-buttons"),"large"===t&&r.classList.add("large-buttons");break;case"cursorSize":r.classList.remove("large-cursor"),"large"===t&&r.classList.add("large-cursor");break;case"reset":"all"===t&&resetAllAccessibilitySettings()}saveAccessibilitySettings()}function saveAccessibilitySettings(){var e=document.body,e={classNames:e.className,fontSize:e.style.fontSize,fontScale:e.style.getPropertyValue("--font-scale")};localStorage.setItem("accessibilitySettings",JSON.stringify(e))}function loadAccessibilitySettings(){var e,t=localStorage.getItem("accessibilitySettings");t&&(t=JSON.parse(t),e=document.body,t.classNames&&(e.className=t.classNames),t.fontSize&&(e.style.fontSize=t.fontSize),t.fontScale&&e.style.setProperty("--font-scale",t.fontScale),updateActiveButtons())}function updateActiveButtons(){let r=document.body;Object.entries({"high-contrast":{action:"contrast",value:"high"},"inverted-colors":{action:"contrast",value:"inverted"},"light-theme":{action:"theme",value:"light"},"dark-theme":{action:"theme",value:"dark"},grayscale:{action:"saturation",value:"grayscale"},"dyslexic-font":{action:"fontFamily",value:"dyslexic"},"increased-letter-spacing":{action:"letterSpacing",value:"increased"},"no-animations":{action:"animations",value:"disabled"},"reduced-animations":{action:"animations",value:"reduced"},"high-focus":{action:"focus",value:"high"},"large-buttons":{action:"buttonSize",value:"large"},"large-cursor":{action:"cursorSize",value:"large"}}).forEach(([e,t])=>{e=r.classList.contains(e),t=document.querySelector(`[data-action="${t.action}"][data-value="${t.value}"]`);t&&(e?t.classList.add("active"):t.classList.remove("active"))}),document.querySelector('[data-action="contrast"].active')||document.querySelector('[data-action="contrast"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="theme"].active')||document.querySelector('[data-action="theme"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="saturation"].active')||document.querySelector('[data-action="saturation"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="fontFamily"].active')||document.querySelector('[data-action="fontFamily"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="letterSpacing"].active')||document.querySelector('[data-action="letterSpacing"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="animations"].active')||document.querySelector('[data-action="animations"][data-value="enabled"]')?.classList.add("active"),document.querySelector('[data-action="focus"].active')||document.querySelector('[data-action="focus"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="buttonSize"].active')||document.querySelector('[data-action="buttonSize"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="cursorSize"].active')||document.querySelector('[data-action="cursorSize"][data-value="normal"]')?.classList.add("active")}function resetAllAccessibilitySettings(){var e=document.body;e.classList.remove("high-contrast","inverted-colors","light-theme","dark-theme","grayscale","dyslexic-font","increased-letter-spacing","no-animations","reduced-animations","high-focus","large-buttons","large-cursor"),e.style.fontSize="",e.style.removeProperty("--font-scale"),document.querySelectorAll(".accessibility-button.active").forEach(e=>{e.classList.remove("active")}),document.querySelector('[data-action="contrast"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="theme"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="saturation"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="fontFamily"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="letterSpacing"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="animations"][data-value="enabled"]')?.classList.add("active"),document.querySelector('[data-action="focus"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="buttonSize"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="cursorSize"][data-value="normal"]')?.classList.add("active"),localStorage.removeItem("accessibilitySettings")}async function trackWordEncounter(r,a){if(currentUser)try{var n=String(r).trim(),{data:o,error:s}=(await ensureUserInitialization(currentUser.id),await supabaseClient.from("word_practice_history").select("*").eq("user_id",currentUser.id).eq("word",n).single());if(s&&"PGRST116"!==s.code){console.error("Error fetching word history:",s);try{var i=await supabaseClient.rpc("get_word_history",{p_user_id:currentUser.id,p_word:n});!i.error&&i.data&&(o=i.data,0)}catch(e){console.error("Alternative fetch also failed:",e)}}let e=!1,t=0;if(o){var l=o.practice_count+1,c=(t=l<=5?3:1,await supabaseClient.from("word_practice_history").update({practice_count:l,last_practiced_at:(new Date).toISOString(),game_mode:a,coins_earned:o.coins_earned+t}).eq("user_id",currentUser.id).eq("word",n));c.error&&console.error("Error updating word history:",c.error)}else{e=!0,t=3;var d=await supabaseClient.from("word_practice_history").insert([{user_id:currentUser.id,word:n,practice_count:1,game_mode:a,coins_earned:t}]);if(d.error)console.error("Error inserting word history:",d.error);else{var{data:u,error:m}=await supabaseClient.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();if(!m){let t=(u?.unique_words_practiced||0)+1,e=await supabaseClient.from("player_stats").update({unique_words_practiced:t}).eq("user_id",currentUser.id);e.error?console.error("Error updating player stats:",e.error):document.querySelectorAll("#totalWords").forEach(e=>{animateNumber(e,parseInt(e.textContent)||0,t)})}}}return 0<t&&await CoinsManager.updateCoins(t),{isNewWord:e,coinReward:t}}catch(e){return console.error("Error in trackWordEncounter:",e),null}}async function ensureUserInitialization(e){try{console.log("Ensuring proper user initialization for:",e);var t,r,a=(await supabaseClient.from("player_stats").select("user_id").eq("user_id",e).single()).error,n=(a&&"PGRST116"===a.code&&(console.log("Creating player_stats record for user"),t=(await supabaseClient.from("player_stats").insert([{user_id:e,total_levels_completed:0,unique_words_practiced:0}])).error,t)&&"23505"!==t.code&&console.error("Error creating player_stats:",t),await supabaseClient.from("game_progress").select("user_id").eq("user_id",e).single()).error;return n&&"PGRST116"===n.code&&(console.log("Creating game_progress record for user"),r=(await supabaseClient.from("game_progress").insert([{user_id:e,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]}])).error,r)&&"23505"!==r.code&&console.error("Error creating game_progress:",r),!0}catch(e){return console.error("Error in ensureUserInitialization:",e),!1}}function createRainingParticles(){let s=document.getElementById("question-screen");if(s){let n=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",..."אבגדהוזחטיכלמנסעפצקרשת"],o=s.clientWidth;window.rainingLettersInterval&&clearInterval(window.rainingLettersInterval),window.rainingLettersInterval=setInterval(()=>{var t=Math.floor(3*Math.random())+1;for(let e=0;e<t;e++){let e=document.createElement("div");e.className="raining-letter",e.textContent=n[Math.floor(Math.random()*n.length)];var r=Math.random()*o,a=5+5*Math.random();e.style.left=r+"px",e.style.animationDuration=a+"s",s.appendChild(e),setTimeout(()=>{e.parentNode===s&&s.removeChild(e)},1e3*a)}},300)}}function updateBossHealthBar(){if(currentGame.isBossLevel){console.log("Updating boss health bar");var e=document.querySelector(".progress-circle");if(e){e=e.querySelector(".progress");if(e){var t=currentGame.words.length,r=currentGame.currentIndex||0,r=Math.max(0,t-r),a=r/t,r=(console.log(`Boss health: ${100*a.toFixed(2)}% (${r}/${t})`),2*Math.PI*54);if(e.style.strokeDashoffset=r*(1-a),e.classList.contains("boss-health")||e.classList.add("boss-health"),.66<a)e.style.stroke="#4CAF50",e.classList.remove("warning");else if(.33<a){if(e.style.stroke="#FFA500",e.classList.remove("warning"),a<=.66&&!currentGame.bossFirstHealthRestored){currentGame.bossFirstHealthRestored=!0,console.log("First boss health restoration");r=Math.floor(.25*t);currentGame.currentIndex=r;let e=document.querySelector(".boss-orb-inner");e&&(e.style.background="radial-gradient(circle at 30% 30%, #FFEB3B, #FFA500)",setTimeout(()=>{e.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"},1e3)),setTimeout(()=>updateBossHealthBar(),100)}}else if(e.style.stroke="#FF3333",e.classList.add("warning"),a<=.33&&!currentGame.bossSecondHealthRestored){currentGame.bossSecondHealthRestored=!0,console.log("Second boss health restoration");r=Math.floor(.5*t);currentGame.currentIndex=r;let e=document.querySelector(".boss-orb-inner");e&&(e.style.background="radial-gradient(circle at 30% 30%, #4CAF50, #388E3C)",setTimeout(()=>{e.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"},1e3)),setTimeout(()=>updateBossHealthBar(),100)}}else console.error("Progress element not found")}else console.error("Progress circle not found")}}function healBoss(r,a){var n=document.querySelector(".progress-circle");let o=n?n.querySelector(".progress"):null,s=document.querySelector(".boss-orb-inner");if(o&&s){let e=s.style.background;s.style.background=a,s.classList.add("boss-restore-health");n=document.querySelector(".question-screen"),a=(n&&(n.style.animation="none",n.offsetHeight,n.style.animation="bossRestoreHealth 1s"),2*Math.PI*54);let t=a*(1-r);setTimeout(()=>{o.style.transition="stroke-dashoffset 1s ease-out",o.style.strokeDashoffset=t,setTimeout(()=>{s.style.background=e,s.classList.remove("boss-restore-health")},1e3)},300)}}function showBossHitEffect(t=!1){let r=document.querySelector(".boss-orb-inner");if(r){let e=r.style.background;var a;t&&(a=(a=["yellow","purple","turquoise","darkgreen","brown"])[Math.floor(Math.random()*a.length)],r.style.background=`radial-gradient(circle at 30% 30%, ${a}, #990000)`),r.classList.add("boss-orb-hit"),setTimeout(()=>{r.classList.remove("boss-orb-hit"),t&&(r.style.background=e)},300)}}function applyBossLevelStyles(){console.log("Forcefully applying boss level styles");var e=document.getElementById("question-screen"),e=(e&&(e.style.setProperty("background","linear-gradient(135deg, #800000, #3a0000)","important"),e.style.setProperty("animation","pulseBg 4s infinite","important")),document.getElementById("boss-animations")||((e=document.createElement("style")).id="boss-animations",e.textContent=`
      @keyframes pulseBg {
        0%, 100% { filter: brightness(1); }
        50% { filter: brightness(1.2); }
      }
      
      @keyframes pulseOrb {
        0%, 100% { transform: scale(1); filter: brightness(1); }
        50% { transform: scale(1.3); filter: brightness(1.4); }
      }
      
      @keyframes pulseWord {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }
    `,document.head.appendChild(e)),document.getElementById("question-word")),e=(e&&(e.style.setProperty("color","#ff3333","important"),e.style.setProperty("text-shadow","0 0 10px rgba(255, 0, 0, 0.5)","important"),e.style.setProperty("animation","pulseWord 2s infinite","important")),document.querySelector(".coins-container"));e&&(window.originalCoinsHTML||(window.originalCoinsHTML=e.innerHTML),e.innerHTML=`
    <div class="boss-orb" style="
      width: 85px;
      height: 85px;
      top: 50%;
      left: 50%;
      transform: translate(-75%, -75%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    ">
      <div class="boss-orb-inner" style="
        width: 50px;
        height: 50px;
        background: radial-gradient(circle at 30% 30%, #ff3333, #990000);
        border-radius: 50%;
        box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);
        animation: pulseOrb 1s infinite;
      "></div>
    </div>
  `)}function handleBossAnswer(r){if(r){let t=document.querySelector(".progress-circle")?.querySelector(".progress");if(t){let e=t.style.stroke;r=["#ffffff","#ffff00","#800080","#990000"],r=r[Math.floor(Math.random()*r.length)];t.style.transition="stroke 0.2s ease",t.style.stroke=r,setTimeout(()=>{t.style.stroke=e},200)}}}function createBossTimer(){var e=document.createElement("div"),t=(e.id="boss-timer",e.style.cssText=`
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        justify-content: center;
        z-index: 10;
    `,document.createElement("div"));return t.style.cssText=`
        background-color: rgba(255, 215, 0, 0.8);
        color: #000;
        font-family: 'Digital', monospace;
        font-size: 2rem;
        padding: 5px 10px;
        border-radius: 5px;
        letter-spacing: 3px;
    `,e.appendChild(t),{container:e,display:t}}function updateBossTimer(e,t){var r;e&&(r=Math.floor(t/60),t=t%60,e.textContent=r.toString().padStart(2,"0")+":"+t.toString().padStart(2,"0"))}function createLightningEffect(){let t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.1s ease;
    `,document.body.appendChild(t);var r=Math.floor(3*Math.random())+1;let a=0;for(let e=0;e<r;e++)setTimeout(()=>{t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},50)},a),a+=200;setTimeout(()=>{document.body.removeChild(t)},a+500)}function createBossRainingLetters(){let n=document.getElementById("question-screen");if(n){window.rainingLettersInterval&&clearInterval(window.rainingLettersInterval);let r=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",..."אבגדהוזחטיכלמנסעפצקרשת"],a=n.clientWidth;window.rainingLettersInterval=setInterval(()=>{var t=Math.floor(3*Math.random())+1;for(let e=0;e<t;e++){let e=document.createElement("div");e.className="boss-raining-letter",e.textContent=r[Math.floor(Math.random()*r.length)],e.style.cssText=`
                position: absolute;
                top: -20px;
                left: ${Math.random()*a}px;
                color: rgba(255, 0, 0, 0.4);
                font-size: 16px;
                animation: boss-letter-rain 5s linear forwards;
                z-index: 1;
                text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
            `,n.appendChild(e),setTimeout(()=>{e.parentNode===n&&n.removeChild(e)},5e3)}},300)}}function stopBossRainingLetters(){window.rainingLettersInterval&&(clearInterval(window.rainingLettersInterval),window.rainingLettersInterval=null)}function createBossStyleSheet(){var e=document.createElement("style");e.id="boss-level-styles",e.textContent=`
    @keyframes boss-letter-rain {
      0% { 
        transform: translateY(-20px);
        opacity: 0.6;
      }
      100% { 
        transform: translateY(100vh);
        opacity: 0;
      }
    }

    @keyframes boss-shrink {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(0.8); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }

    @keyframes fade-to-blue {
      0% { background: linear-gradient(135deg, #800000, #3a0000); }
      20% { background: linear-gradient(135deg, #800000, #3a0000); }
      60% { background: linear-gradient(135deg, #4a1582, #0d47a1); }
      100% { background: radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%); }
    }
    
    @keyframes incinerateEffect {
      0% { transform: scale(0); opacity: 0; }
      10% { transform: scale(0.5); opacity: 0.8; }
      50% { transform: scale(1.5); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
    
    .incineration-effect {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle, #ff9900, #ff3300);
      opacity: 0;
      transform: scale(0);
      animation: incinerateEffect 1.5s forwards;
    }
  `,document.head.appendChild(e)}function showModernBossVictoryScreen(){let t=document.createElement("div");t.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.5s ease;
    `;var e=document.createElement("div"),r=(e.style.cssText=`
        background: linear-gradient(135deg, #00c6ff, #0072ff);
        padding: 2rem;
        border-radius: 20px;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    `,e.innerHTML=`
        <h2 style="color: white; font-size: 2.5rem; margin-bottom: 1rem;">🏆 Boss Defeated!</h2>
        <div class="victory-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0; color: white;">
            <div>
                <div style="font-size: 1.2rem; opacity: 0.7;">Words Learned</div>
                <div style="font-size: 2rem; font-weight: bold;">${currentGame.words.length}</div>
            </div>
            <div>
                <div style="font-size: 1.2rem; opacity: 0.7;">Coins Earned</div>
                <div style="font-size: 2rem; font-weight: bold;">100</div>
            </div>
        </div>
        <div style="display: flex; justify-content: center; gap: 1rem;">
            <button class="continue-btn" style="
                background: #4CAF50; 
                color: white; 
                border: none; 
                padding: 1rem 2rem; 
                border-radius: 50px; 
                font-size: 1rem; 
                cursor: pointer;
                transition: transform 0.3s ease;
            ">Continue to Next Set</button>
            <button class="home-btn" style="
                background: rgba(255,255,255,0.2); 
                color: white; 
                border: 2px solid white; 
                padding: 1rem 2rem; 
                border-radius: 50px; 
                font-size: 1rem; 
                cursor: pointer;
                transition: transform 0.3s ease;
            ">Return Home</button>
        </div>
    `,e.querySelector(".continue-btn")),a=e.querySelector(".home-btn");[r,a].forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.05)"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1)"})}),r.addEventListener("click",()=>{t.style.opacity="0",setTimeout(()=>{t.remove(),unlockNextSet();var e=gameState.currentSet+1;gameState.currentSet=e,startLevel(gameState.currentLevel=1)},500)}),a.addEventListener("click",()=>{t.style.opacity="0",setTimeout(()=>{t.remove(),unlockNextSet(),showScreen("welcome-screen")},500)}),t.appendChild(e),document.body.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1"})}function showBossDefeatEffect(){if(console.log("Starting boss defeat effect sequence"),currentGame.bossDefeatedEffectShown)console.log("Boss defeat effect already shown, skipping");else{currentGame.bossDefeatedEffectShown=!0;var e=!currentGame.bossRewardApplied;currentGame.bossRewardApplied=!0;let i=gameState.coins,l=i;e?(l=i,console.log(`Adding 100 coins: ${i} -> `+l),gameState.coins=l,saveProgress()):console.log("Coin reward already applied, skipping");var t,e=document.querySelector(".question-screen");e&&(console.log("Creating background transition overlay"),(t=document.createElement("div")).className="background-transition-overlay",t.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #800000, #3a0000); 
            z-index: -1;
            animation: fade-to-blue 5s ease-in-out forwards;
            pointer-events: none;
        `,e.insertBefore(t,e.firstChild)),setTimeout(()=>{var e,t=document.querySelector(".boss-orb-inner");t?(console.log("Disintegrating boss orb"),(e=document.createElement("div")).className="incineration-effect",t.appendChild(e),t.style.animation="boss-shrink 2.5s forwards",setTimeout(()=>{console.log("Applying coin reward animation");let s=document.querySelector(".coins-container");if(s&&window.originalCoinsHTML){s.innerHTML=window.originalCoinsHTML;let e=s.querySelector(".coin-icon"),o=s.querySelector(".coin-count");o&&(s.style.transform="scale(1.2)",s.style.transition="transform 0.3s ease",o.textContent=i,o.style.color="white",setTimeout(()=>{let t=60,r=2e3/t,a=0,n=()=>{var e;a<=t?(e=a/t,e=Math.round(i+(l-i)*e),o.textContent=e,o.style.color="var(--gold)",o.style.textShadow="0 0 10px var(--gold)",a++,setTimeout(n,r)):(o.textContent=l,setTimeout(()=>{o.style.color="white",o.style.textShadow="none",s.style.transform="scale(1)"},1e3))};n(),e&&(e.classList.add("coin-pulse"),e.style.animation="coinPulse 0.5s ease-in-out 6")},100))}},500),setTimeout(()=>{console.log("Showing victory notification"),showBossVictoryNotification()},5e3)):setTimeout(()=>{showBossVictoryNotification()},3e3)},1e3),document.getElementById("boss-transition-style")||((t=document.createElement("style")).id="boss-transition-style",t.textContent=`
            @keyframes fade-to-blue {
                0% { background: linear-gradient(135deg, #800000, #3a0000); }
                20% { background: linear-gradient(135deg, #800000, #3a0000); }
                60% { background: linear-gradient(135deg, #4a1582, #0d47a1); }
                100% { background: radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%); }
            }
            
            @keyframes boss-shrink {
                0% { transform: scale(1); opacity: 1; }
                30% { transform: scale(0.8); opacity: 0.8; }
                100% { transform: scale(0); opacity: 0; }
            }
        `,document.head.appendChild(t))}}function updateCoinsAfterBossVictory(){let t=gameState.coins,r=t;gameState.coins=r,document.querySelectorAll(".coin-count").forEach(e=>{animateCoinsChange(e,t,r)}),document.querySelectorAll(".coin-icon").forEach(e=>{e.classList.add("coin-pulse"),setTimeout(()=>{e.classList.remove("coin-pulse")},1500)}),saveProgress()}function showBossVictoryNotification(){updateAllCoinDisplays();let e=document.createElement("div");e.className="arcade-completion-modal",e.innerHTML=`
    <div class="completion-modal-content">
      <h2 style="color: var(--gold)">Boss Defeated!</h2>
      <p style="font-size: 1.2rem; margin: 1rem 0;">Congratulations! You've conquered this challenge!</p>
      
      <div class="completion-stats">
        <div class="stat-item">
          <i class="fas fa-skull" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
          <span style="display: block; margin-bottom: 0.25rem;">Boss Defeated</span>
          <strong style="font-size: 1.5rem;">✓</strong>
        </div>
        <div class="stat-item">
          <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
          <span style="display: block; margin-bottom: 0.25rem;">Bonus Coins</span>
          <strong style="font-size: 1.5rem;">100</strong>
        </div>
        <div class="stat-item">
          <i class="fas fa-unlock" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>
          <span style="display: block; margin-bottom: 0.25rem;">New Set</span>
          <strong style="font-size: 1.5rem;">Unlocked</strong>
        </div>
      </div>
      
      <div style="display: flex; justify-content: space-around; margin-top: 2rem; gap: 1rem;">
        <button onclick="handleBossVictoryContinue()" class="start-button" style="
          background: var(--accent);
          color: var(--text);
          border: none;
          padding: 1rem 2rem;
          border-radius: 50px;
          font-size: 1.1rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 5px 15px rgba(30, 144, 255, 0.3);
        ">
          Next Set
        </button>
        <button onclick="handleBossVictoryHome()" class="start-button" style="
          background: transparent;
          color: var(--text);
          border: 2px solid var(--accent);
          padding: 1rem 2rem;
          border-radius: 50px;
          font-size: 1.1rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
        ">
          Return Home
        </button>
      </div>
    </div>
  `,document.body.appendChild(e),requestAnimationFrame(()=>e.classList.add("show"))}function handleBossVictoryContinue(){console.log("Boss victory continue button clicked");let a=document.querySelector(".arcade-completion-modal");updateAllCoinDisplays(),a&&(a.classList.remove("show"),setTimeout(()=>{a.remove();let e=document.querySelector(".background-transition-overlay");e?(console.log("Using existing transition overlay for smooth transition"),e.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)",resetBossStyles(!0)):resetBossStyles(),unlockNextSet();var t=gameState.currentSet+1,r=currentUser?currentUser.status:"unregistered";2<=gameState.currentStage&&1<t&&"premium"!==r?(console.log("Non-premium user attempted to access premium set, showing upgrade prompt"),showScreen("welcome-screen"),setTimeout(()=>{showUpgradePrompt()},500)):(gameState.currentSet=t,gameState.currentLevel=1,updateAllCoinDisplays(),setTimeout(()=>{console.log("Starting next level"),e&&e.parentNode&&e.parentNode.removeChild(e),startLevel(1)},500))},300))}function resetBossStyles(t=!1){console.log("Resetting boss styles",t?"(preserving overlay)":"");var e=document.querySelector(".progress-circle");e&&(e=e.querySelector(".progress"))&&(e.classList.remove("warning","boss-health"),e.style.stroke="",e.style.animation="none",e.offsetWidth,e.style.animation="");let r=document.getElementById("question-screen");if(r){let e=r.querySelector(".background-transition-overlay");t&&e&&e.remove(),r.removeAttribute("style"),t&&e&&r.insertBefore(e,r.firstChild),t||(r.querySelectorAll(".background-transition-overlay").forEach(e=>e.remove()),setTimeout(()=>{r.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)"},10))}let a=document.getElementById("question-word");a&&a.removeAttribute("style"),"function"==typeof stopBossRainingLetters&&stopBossRainingLetters(),document.querySelectorAll(t?".incineration-effect, .boss-orb":".incineration-effect, .boss-orb, .background-transition-overlay").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)})}function handleBossVictoryHome(){console.log("Boss victory home button clicked");let r=document.querySelector(".arcade-completion-modal");updateAllCoinDisplays(),r&&(r.classList.remove("show"),setTimeout(()=>{r.remove(),resetBossStyles(),unlockNextSet();var e=gameState.currentSet+1,t=currentUser?currentUser.status:"unregistered";2<=gameState.currentStage&&1<e&&"premium"!==t?showUpgradePrompt():(gameState.currentSet=e,gameState.currentLevel=1),saveProgress(),showScreen("welcome-screen")},300))}function isAdminUser(){return currentUser&&"admin123@gmail.com"===currentUser.email}function addAdminSkipButton(){var e,t;isAdminUser()&&((e=document.getElementById("admin-skip-10-button"))&&e.remove(),(e=document.createElement("button")).id="admin-skip-10-button",e.innerHTML='<i class="fas fa-forward"></i> Skip 10',e.style.cssText=`
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: #9c27b0;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 2000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    font-weight: bold;
  `,e.onclick=function(){console.log("Admin skip-10 button clicked"),handleAdminSkip10()},t=document.getElementById("question-screen"))&&t.appendChild(e)}function handleAdminSkip10(){var e;isAdminUser()&&(currentGame&&currentGame.words&&currentGame.words.length?(e=Math.min(10,currentGame.words.length-currentGame.currentIndex),console.log(`Skipping ${e} questions`),currentGame.isBossLevel?(currentGame.currentIndex=Math.max(0,currentGame.words.length-1),updateBossHealthBar(),loadNextBossQuestion(),showNotification("Boss almost defeated! One more hit!","success")):(currentGame.currentIndex+=e,currentGame.currentIndex>=currentGame.words.length?handleLevelCompletion():(updateProgressCircle(),loadNextQuestion(),showNotification(`Skipped ${e} questions!`,"success")))):console.error("No active game found"))}function addAdminTestButton(){console.log("Checking for admin user...");var e=document.getElementById("admin-test-button");e&&e.remove(),console.log("Current user:",currentUser?currentUser.email:"No user"),!currentUser||"admin123@gmail.com"!==currentUser.email&&!currentUser.email?.includes("admin123")?console.log("Not admin user, not adding button"):(console.log("Admin user detected, adding test buttons"),(e=document.createElement("button")).id="admin-test-button",e.textContent="Jump to Level 20",e.style.cssText=`
    position: fixed;
    top: 80px;
    right: 20px;
    background: #ff5722;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    z-index: 2000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    font-weight: bold;
  `,e.onclick=function(){console.log("Admin button clicked, jumping to level 20"),startLevel(gameState.currentLevel=21)},document.body.appendChild(e),console.log("Admin test button added to body"),addAdminSkipButton())}updateSidePanelLink(),document.addEventListener("DOMContentLoaded",()=>{updateSidePanelLink()}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".fa-crown").forEach(e=>{e.addEventListener("click",handleCrownClick)}),new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.length&&e.addedNodes.forEach(e=>{1===e.nodeType&&e.querySelectorAll(".fa-crown").forEach(e=>{e.addEventListener("click",handleCrownClick)})})})}).observe(document.body,{childList:!0,subtree:!0})}),document.addEventListener("DOMContentLoaded",()=>{ensureScreenExists("stage-cascade-screen"),updateSidePanelLinks(),initializeStageCascadeScreen()}),document.addEventListener("DOMContentLoaded",function(){initAccessibilityMenu()}),createBossStyleSheet();let CustomListsManager={lists:[],currentList:null,async initialize(){try{currentUser?await this.loadFromSupabase():this.loadFromLocalStorage(),this.lists&&0!==this.lists.length||(console.log("No lists found, initializing empty array"),this.lists=[])}catch(e){console.error("Custom Lists Initialization Error:",e),this.lists=[]}},async loadFromSupabase(){try{var{data:e,error:t}=await supabaseClient.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`);if(t)throw t;this.lists=e.map(e=>({id:e.id,name:e.name,words:e.words||[],translations:e.translations||[],isShared:e.is_shared,sharedBy:e.shared_by,userId:e.user_id,createdAt:e.created_at}))}catch(e){console.error("Error loading lists from Supabase:",e),this.lists=[]}},loadFromLocalStorage(){try{var e=localStorage.getItem("simploxCustomLists");this.lists=e?JSON.parse(e):[],console.log("Loaded lists from localStorage:",this.lists.length)}catch(e){console.error("Error loading lists from localStorage:",e),this.lists=[]}},async save(e){return e?currentUser?await this.saveToSupabase(e):this.saveToLocalStorage(e):null},async saveToSupabase(t){try{var e={name:t.name,words:t.words||[],translations:t.translations||[],user_id:currentUser.id};if(t.id&&"string"==typeof t.id&&36===t.id.length){var{data:r,error:a}=await supabaseClient.from("custom_lists").update(e).eq("id",t.id).select().single();if(a)throw a;return r}var{data:n,error:o}=await supabaseClient.from("custom_lists").insert(e).select().single();if(o)throw o;var s=this.lists.findIndex(e=>e.id===t.id||e.tempId&&e.tempId===t.tempId);return-1!==s?this.lists[s]={...n,words:n.words||[],translations:n.translations||[]}:this.lists.push({...n,words:n.words||[],translations:n.translations||[]}),n}catch(e){return console.error("Error saving list to Supabase:",e),null}},saveToLocalStorage(t){try{var e={...t,id:t.id||Date.now(),tempId:t.tempId||Date.now()},r=this.lists.findIndex(e=>e.id===t.id||e.tempId&&e.tempId===t.tempId);return-1!==r?this.lists[r]=e:this.lists.push(e),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),e}catch(e){return console.error("Error saving list to localStorage:",e),null}},async delete(t){if(!currentUser)return this.lists=this.lists.filter(e=>e.id!==t),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),!0;try{if("string"==typeof t&&36===t.length){var e=(await supabaseClient.from("custom_lists").delete().eq("id",t)).error;if(e)throw e}return this.lists=this.lists.filter(e=>e.id!==t),!0}catch(e){return console.error("Error deleting list from Supabase:",e),!1}},async share(e,r){if(!currentUser)return!1;try{let t=String(e);var a=this.lists.find(e=>String(e.id)===t);if(!a)return console.error("List not found for sharing:",t),!1;console.log("Sharing list:",a.name);var{data:n,error:o}=await supabaseClient.rpc("insert_shared_list",{p_user_id:r,p_name:`${a.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,p_words:a.words||[],p_translations:a.translations||[],p_is_shared:!0,p_local_id:Date.now(),p_shared_with:[r],p_shared_by:currentUser.id});return o?(console.error("Error sharing list via RPC:",o),!1):(console.log("List shared successfully:",n),!0)}catch(e){return console.error("Error in share method:",e),!1}},getListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"};switch(currentUser.status||"free"){case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"∞"};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"∞"};case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1,playDisplay:"10"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"}}},canCreateMoreLists(){var e=this.getListLimits();return this.lists.length<e.maxLists},validateListForPractice:e=>e&&e.words&&e.translations?e.words.length<6?{valid:!1,message:"Lists need at least 6 words to practice"}:{valid:!0}:{valid:!1,message:"Invalid list format"}},customGameState={isCustomPractice:!1,currentList:null,currentLevel:1,levelData:null,words:[],translations:[],wordsCompleted:0,correctStreak:0,wrongStreak:0,startCoins:0,completedLevels:new Set,reset(){this.isCustomPractice=!1,this.currentList=null,this.currentLevel=1,this.levelData=null,this.words=[],this.translations=[],this.wordsCompleted=0,this.correctStreak=0,this.wrongStreak=0,this.startCoins=0,this.completedLevels=new Set},initializeFromList(e){return e&&e.words&&e.translations?(this.reset(),this.isCustomPractice=!0,this.currentList=e,this.words=[...e.words],this.translations=[...e.translations],this.startCoins=gameState.coins,this.currentLevel=1,!0):(console.error("Invalid list provided to custom game:",e),!1)},getWordsForLevel(e){var t,r;return!this.words.length||(t=12<=this.words.length?9:9<=this.words.length?6:3)<e?null:(r=(r={1:{start:0,count:Math.min(3,this.words.length),isTest:!1},2:{start:3,count:Math.min(3,Math.max(0,this.words.length-3)),isTest:!1},3:{start:0,count:Math.min(6,this.words.length),isTest:!0},4:{start:6,count:Math.min(3,Math.max(0,this.words.length-6)),isTest:!1},5:{start:9,count:Math.min(3,Math.max(0,this.words.length-9)),isTest:!1},6:{start:6,count:Math.min(6,Math.max(0,this.words.length-6)),isTest:!0},7:{start:12,count:Math.min(4,Math.max(0,this.words.length-12)),isTest:!1},8:{start:16,count:Math.min(4,Math.max(0,this.words.length-16)),isTest:!1},9:{start:12,count:Math.min(8,Math.max(0,this.words.length-12)),isTest:!0}})[e]||r[1]).count<=0?this.getWordsForLevel(e+1):(this.levelData={words:this.words.slice(r.start,r.start+r.count),translations:this.translations.slice(r.start,r.start+r.count),isTest:r.isTest,isFinal:e===t},this.levelData)}};function processCustomWords(){var t=document.getElementById("custom-word-input"),r=document.getElementById("translation-results");let a=document.getElementById("word-translation-list");var n=CustomListsManager.getListLimits(),t=t.value.trim();if(t){let e=t.includes(",")?t.split(",").map(e=>e.trim()):t.split(/\s+/).filter(e=>0<e.length);e=e.map(e=>e.includes(" ")?[e]:e.split(/\s+/)).flat();t=currentUser?n.maxWords:10;e.length>t&&(showNotification(`Maximum ${t} words allowed.`,"error"),e=e.slice(0,t)),a.innerHTML="",r.style.display="block",e.forEach(e=>{e=createWordItem(e,findTranslation(e));a.appendChild(e),initializeDragAndDrop(e)}),makeWordListDraggable()}else showNotification("Please enter at least one word.","error")}function findTranslation(e){for(var t in vocabularySets){var r=vocabularySets[t].words.indexOf(e.toLowerCase());if(-1!==r)return vocabularySets[t].translations[r]}return""}function createWordItem(e,t){var r=document.createElement("div"),e=(r.className="word-translation-item",r.draggable=!0,r.innerHTML=`
    <div class="drag-handle">
      <i class="fas fa-grip-vertical"></i>
    </div>
    <span class="source-word" contenteditable="true">${e}</span>
    <input type="text" class="target-word" value="${t}" placeholder="Hebrew translation">
    <button class="delete-word-btn" onclick="deleteWord(this)">
      <i class="fas fa-times" style="font-size: 12px;"></i>
    </button>
  `,r.querySelector(".delete-word-btn"));return e&&(e.style.position="absolute",e.style.right="10px",e.style.top="50%",e.style.transform="translateY(-50%)"),r}function addNewWord(){var e,t=document.getElementById("word-translation-list");t&&((e=document.createElement("div")).className="word-translation-item",e.draggable=!0,e.innerHTML=`
    <div class="drag-handle">
      <i class="fas fa-grip-vertical"></i>
    </div>
    <span class="source-word" contenteditable="true"></span>
    <input type="text" class="target-word" placeholder="Hebrew translation">
    <button class="delete-word-btn" onclick="deleteWord(this)">❌</button>
  `,initializeDragAndDrop(e=t.appendChild(e)),1===t.children.length&&makeWordListDraggable(),e.querySelector(".source-word").focus())}function deleteWord(e){e&&(e=e.closest(".word-translation-item"))&&e.remove()}function initializeDragAndDrop(t){if(t){var r=t.cloneNode(!0);t.parentNode&&t.parentNode.replaceChild(r,t),(t=r).setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{e.stopPropagation(),t.classList.add("dragging"),e.dataTransfer.setData("text/plain","")}),t.addEventListener("dragend",e=>{e.stopPropagation(),t.classList.remove("dragging")});let e=t.querySelector(".delete-word-btn");return e&&(e.onclick=()=>deleteWord(e)),t}}function makeWordListDraggable(){let r=document.getElementById("word-translation-list");r&&(r.addEventListener("dragover",e=>{e.preventDefault();var t=r.querySelector(".dragging");t&&((e=getDragAfterElement(r,e.clientY))?r.insertBefore(t,e):r.appendChild(t))}),r.querySelectorAll(".word-translation-item").forEach(e=>initializeDragAndDrop(e)))}function getDragAfterElement(e,a){return e&&(e=[...e.querySelectorAll(".word-translation-item:not(.dragging)")]).length?e.reduce((e,t)=>{var r=t.getBoundingClientRect(),r=a-r.top-r.height/2;return r<0&&r>e.offset?{offset:r,element:t}:e},{offset:Number.NEGATIVE_INFINITY}).element:null}function setupWordListKeyNavigation(){var e=document.getElementById("word-translation-list");e&&e.addEventListener("keydown",t=>{var r=document.activeElement.closest(".word-translation-item");if(r){let e;switch(t.key){case"ArrowUp":t.preventDefault(),e=r.previousElementSibling?.querySelector(".source-word");break;case"ArrowDown":t.preventDefault(),e=r.nextElementSibling?.querySelector(".source-word");break;case"ArrowRight":t.preventDefault(),e=r.querySelector(".target-word");break;case"ArrowLeft":t.preventDefault(),e=r.querySelector(".source-word")}e&&e.focus()}})}async function saveCurrentList(){var t=document.getElementById("custom-list-name"),r=document.getElementById("word-translation-list"),a=t.value.trim()||(CustomListsManager.currentList?CustomListsManager.currentList.name:"List "+(CustomListsManager.lists.length+1));let n=[],o=[];r.querySelectorAll(".word-translation-item").forEach(e=>{var t=e.querySelector(".source-word").textContent.trim(),e=e.querySelector(".target-word").value.trim();t&&e&&(n.push(t),o.push(e))});var s=CustomListsManager.getListLimits();if(n.length>s.maxWords)showNotification(`You can only create lists with up to ${s.maxWords} words`,"error");else{let e;s=null!==CustomListsManager.currentList;s||CustomListsManager.canCreateMoreLists()?(e=s?{...CustomListsManager.currentList,name:a,words:n,translations:o}:{tempId:Date.now(),name:a,words:n,translations:o},await CustomListsManager.save(e)?(t.value="",r.innerHTML="",document.getElementById("translation-results").style.display="none",CustomListsManager.currentList=null,currentUser?await CustomListsManager.loadFromSupabase():CustomListsManager.loadFromLocalStorage(),showNotification("List saved successfully","success"),showScreen("custom-practice-screen"),updateListsDisplay()):showNotification("Failed to save list","error")):showNotification("Maximum lists limit reached","error")}}function editCustomList(t){let a=CustomListsManager.lists.find(e=>e.id===t);if(!a)return showNotification("List not found","error");showScreen("custom-practice-screen");var e=document.getElementById("custom-list-name"),e=(e&&(e.value=a.name||""),document.getElementById("translation-results"));let n=document.getElementById("word-translation-list");n&&(n.innerHTML="",Array.isArray(a.words)&&a.words.forEach((e,t)=>{var t=a.translations&&t<a.translations.length?a.translations[t]:"",r=document.createElement("div");r.className="word-translation-item",r.draggable=!0,r.innerHTML=`
                    <div class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <span class="source-word" contenteditable="true">${e}</span>
                    <input type="text" class="target-word" value="${t}" placeholder="Hebrew translation">
                    <button class="delete-word-btn" onclick="deleteWord(this)">
                        <i class="fas fa-times" style="font-size: 12px;"></i>
                    </button>
                `,n.appendChild(r),initializeDragAndDrop(r)}),makeWordListDraggable(),e)&&(e.style.display="block"),CustomListsManager.currentList=a}async function deleteCustomList(e){await CustomListsManager.delete(e)?(showNotification("List deleted successfully","success"),updateListsDisplay()):showNotification("Failed to delete list","error")}function showShareModal(a){console.log("Opening share modal for list:",a);var e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop"),e=(e&&e.remove(),t&&t.remove(),document.createElement("div"));e.className="modal-backdrop",e.onclick=o,document.body.appendChild(e);let r=document.createElement("div"),n=(r.className="share-modal",r.innerHTML=`
    <h3 class="share-modal-header">Share List</h3>
    <div class="users-list">Loading users...</div>
    <button class="start-button modal-close" onclick="closeShareModal()">Cancel</button>
  `,document.body.appendChild(r),r.querySelector(".users-list"));function o(){var e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}supabaseClient.from("user_profiles").select("id, username").neq("id",currentUser.id).then(({data:e,error:t})=>{t?(console.error("Error fetching users:",t),n.innerHTML='<div class="user-item"><span>Error loading users</span></div>'):e&&0<e.length?(n.innerHTML=e.map(e=>`
        <div class="user-item">
          <span>${e.username||"Unnamed User"}</span>
          <button class="main-button small-button share-with-user-btn" data-user-id="${e.id}">
            <i class="fas fa-share-alt"></i> Share
          </button>
        </div>
      `).join(""),r.querySelectorAll(".share-with-user-btn").forEach(r=>{r.onclick=async()=>{var e=r.getAttribute("data-user-id"),t=(r.disabled=!0,r.innerHTML),e=(r.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sharing...',await CustomListsManager.share(a,e));e?(showNotification("List shared successfully!","success"),o()):(r.disabled=!1,r.innerHTML=t)}})):n.innerHTML='<div class="user-item"><span>No users found to share with</span></div>'})}function showCustomListsManager(){showScreen("custom-practice-screen"),Promise.resolve(CustomListsManager.initialize()).then(()=>{updateListsDisplay()}).catch(e=>{console.error("Error initializing custom lists:",e),showNotification("Failed to load custom lists","error")})}function updateListsDisplay(){let i=document.getElementById("custom-lists-container");if(i){let o=CustomListsManager.getListLimits(),s=currentUser?.status||"unregistered";i.innerHTML="",CustomListsManager.lists&&Array.isArray(CustomListsManager.lists)&&0!==CustomListsManager.lists.length?CustomListsManager.lists.forEach(e=>{var t,r,a,n;e&&e.id&&(r=6<=(a=e.words?.length||0),n="premium"===s?"":`<span style="margin-left: 1rem;">${o.playDisplay} plays available</span>`,(t=document.createElement("div")).className="custom-list-item collapsed "+(e.isShared?"shared-list":""),t.dataset.listId=e.id,t.innerHTML=`
                <div class="list-actions">
                    <button class="main-button practice-button" ${r?"":"disabled"}>
                        ${r?"Practice":`Need ${6-a} more`}
                    </button>
                    <button class="main-button edit-button">Edit</button>
                    <button class="main-button delete-button">Delete</button>
                    ${"premium"===s?`
                        <button class="main-button share-button">
                            <i class="fas fa-share-alt"></i> Share
                        </button>
                    `:""}
                </div>
                <div class="list-header">
                    <h3>${e.name||"Unnamed List"}</h3>
                    <div class="list-summary">
                        <span class="word-count ${r?"":"insufficient"}">${a} words</span>
                        ${r?"":'<span class="warning-text">(Minimum 6 needed)</span>'}
                        ${n}
                        <p class="word-preview">${Array.isArray(e.words)?e.words.slice(0,5).join(", "):""}${e.words&&5<e.words.length?"...":""}</p>
                    </div>
                </div>
            `,i.appendChild(t),(a=t.querySelector(".practice-button"))&&(r?a.onclick=function(){startCustomListPractice(e.id)}:(a.style.opacity="0.6",a.style.cursor="not-allowed")),(n=t.querySelector(".edit-button"))&&(n.onclick=function(){editCustomList(e.id)}),(r=t.querySelector(".delete-button"))&&(r.onclick=function(){deleteCustomList(e.id)}),(a=t.querySelector(".share-button"))&&(a.onclick=function(){showShareModal(e.id)}),n=t.querySelector(".list-header"))&&(n.onclick=function(){toggleListCollapse(e.id)})}):i.innerHTML='<p style="color: white; text-align: center;">No custom lists created yet. Create your first list!</p>'}else console.error("Custom lists container not found")}function toggleListCollapse(e){e=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);e&&e.classList.toggle("collapsed")}function startCustomListPractice(t){var e=CustomListsManager.lists.find(e=>e.id===t);if(e){var r=CustomListsManager.validateListForPractice(e);if(r.valid){var a=CustomListsManager.getListLimits();if(a.maxPlays!==1/0){var n="listPlays_"+t,o=parseInt(localStorage.getItem(n)||"0");if(++o>a.maxPlays)return void showNotification("You've reached the maximum plays for this list","error");localStorage.setItem(n,o)}customGameState.initializeFromList(e)?startCustomLevel(1):showNotification("Failed to initialize practice","error")}else showNotification(r.message,"error")}else showNotification("List not found","error")}function startCustomLevel(e){var t=document.querySelector(".powerups-container"),t=(t&&(t.style.display="none"),"function"==typeof addAdminSkipButton&&addAdminSkipButton(),customGameState.getWordsForLevel(e));t&&t.words.length?(customGameState.currentLevel=e,currentGame={words:t.words,translations:t.translations,currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!!t.isTest&&Math.random()<.5,mixed:t.isTest,speedChallenge:!1,isCustomPractice:!0,customGameState:!0,startingCoins:gameState.coins,startingPerks:{...gameState.perks},timeBonus:0,initialTimeRemaining:null,streakBonus:!0,levelStartTime:Date.now(),questionStartTime:0,wrongStreak:0,progressLost:0,customList:customGameState.currentList,customLevel:e,isFinalLevel:t.isFinal},showLevelIntro(e,()=>{showScreen("question-screen"),updateProgressCircle(),loadNextQuestion(),startTimer(10*currentGame.words.length)})):(showNotification("Practice completed!","success"),showScreen("custom-practice-screen"))}async function loadCustomLists(){try{console.log("Loading custom lists..."),await CustomListsManager.initialize();var e=document.getElementById("custom-practice-screen");return!e||"block"!==e.style.display&&"custom-practice-screen"!==document.querySelector(".screen.active")?.id||updateListsDisplay(),console.log("Custom lists loaded successfully"),CustomListsManager.lists}catch(e){return console.error("Error loading custom lists:",e),showNotification("Failed to load custom lists","error",3e3),[]}}async function shareCustomList(t,r){if(console.log(`Starting share process for list ${t} with user `+r),!currentUser?.id)return showNotification("You must be logged in to share lists","error"),!1;try{let e=CustomListsManager.lists.find(e=>String(e.id)===String(t));if(!e){var{data:a,error:n}=await supabaseClient.from("custom_lists").select("*").eq("id",t).single();if(n||!a)return console.error("Error fetching list:",n),!1;e=a}console.log("Found list to share:",e.name);var o=currentUser.user_metadata?.name||currentUser.user_metadata?.username||currentUser.email||"User",s=e.name+` (Shared by ${o})`,i=Array.isArray(e.words)?e.words:[],l=Array.isArray(e.translations)?e.translations:[],c=(await supabaseClient.from("custom_lists").insert({name:s,words:i,translations:l,user_id:r,is_shared:!0,shared_by:currentUser.id})).error;return c?(console.error("Error sharing list:",c),!1):(console.log("List shared successfully"),showNotification("List shared successfully!","success"),!0)}catch(e){return console.error("Unexpected error in shareCustomList:",e),showNotification("Failed to share list","error"),!1}}function showShareModal(a){console.log("Opening share modal for list:",a);var e=document.querySelector(".share-modal-container");e&&e.remove();let t=document.createElement("div");t.className="share-modal-container",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.backgroundColor="rgba(0,0,0,0.7)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.zIndex="1000";e=document.createElement("div");e.className="share-modal",e.style.backgroundColor="#1e1e2e",e.style.borderRadius="10px",e.style.padding="20px",e.style.maxWidth="400px",e.style.width="90%",e.style.maxHeight="80vh",e.style.overflowY="auto",e.innerHTML=`
    <h3 style="text-align: center; margin-bottom: 20px; color: white;">Share List</h3>
    <div id="share-users-list" style="margin-bottom: 15px;">Loading users...</div>
    <button id="close-share-modal" style="width: 100%; padding: 10px; background-color: #7e3ab3; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Close</button>
  `,t.appendChild(e),document.body.appendChild(t),document.getElementById("close-share-modal").onclick=function(){t.remove()},t.addEventListener("click",function(e){e.target===t&&t.remove()});let n=document.getElementById("share-users-list");currentUser?supabaseClient.from("user_profiles").select("id, username, email").neq("id",currentUser.id).then(({data:e,error:t})=>{if(t)console.error("Error fetching users:",t),n.innerHTML='<div style="padding: 10px; color: white;">Error loading users</div>';else if(e&&0!==e.length){let r="";e.forEach(e=>{var t=e.username||e.email||e.id.substring(0,8);r+=`
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: white;">
            <span>${t}</span>
            <button 
              class="share-with-user-btn" 
              data-user-id="${e.id}" 
              style="padding: 5px 10px; background-color: #7e3ab3; color: white; border: none; border-radius: 5px; cursor: pointer;">
              Share
            </button>
          </div>
        `}),n.innerHTML=r,document.querySelectorAll(".share-with-user-btn").forEach(e=>{e.onclick=async function(){var e=this.getAttribute("data-user-id"),t=this.innerText,e=(this.innerText="Sharing...",this.disabled=!0,await shareCustomList(a,e));e?(this.innerText="Shared ✓",this.style.backgroundColor="#28a745"):(this.innerText=t,this.disabled=!1)}})}else n.innerHTML='<div style="padding: 10px; color: white;">No other users found</div>'}):n.innerHTML='<div style="padding: 10px; color: white;">You must be logged in to share lists</div>'}function exitCustomPractice(){console.log("Exiting custom practice mode");var e=document.querySelector(".completion-overlay");e&&e.remove(),customGameState&&customGameState.reset(),currentGame=null,showScreen("custom-practice-screen"),"function"==typeof refreshCustomLists&&refreshCustomLists()}function generateAnswerOptions(t){let a=document.querySelector(".buttons");if(a){a.innerHTML="";let e=[t],r=isHebrewWord(t);t=getRandomAnswerOptions(t,r,3);e=e.concat(t),(e=shuffleArray(e)).forEach(e=>{var t=document.createElement("button");t.textContent=e,t.className=r?"hebrew-text":"",t.onclick=function(e){handleAnswer(e)},a.appendChild(t)})}}async function ensureUserInitialization(e){try{console.log("Ensuring proper user initialization for:",e);var t,r,a=(await supabaseClient.from("player_stats").select("user_id").eq("user_id",e).single()).error,n=(a&&"PGRST116"===a.code&&(console.log("Creating player_stats record for user"),t=(await supabaseClient.from("player_stats").insert([{user_id:e,total_levels_completed:0,unique_words_practiced:0}])).error,t)&&console.error("Error creating player_stats:",t),await supabaseClient.from("game_progress").select("user_id").eq("user_id",e).single()).error;return n&&"PGRST116"===n.code&&(console.log("Creating game_progress record for user"),r=(await supabaseClient.from("game_progress").insert([{user_id:e,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]}])).error,r)&&console.error("Error creating game_progress:",r),!0}catch(e){return console.error("Error in ensureUserInitialization:",e),!1}}function initializeWaitingGame(){"function"!=typeof shuffleArray&&(window.shuffleArray=function(e){var t=[...e];for(let e=t.length-1;0<e;e--){var r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}return t});let o=document.getElementById("waiting-game-container"),s=document.getElementById("waiting-game-player"),i=document.getElementById("waiting-game-score");var e=document.getElementById("waiting-game-lives");if(!o)return void console.error("Game container not found!");if(!s)return void console.error("Player element not found!");if(!i)return void console.error("Score element not found!");e||((e=document.createElement("div")).id="waiting-game-lives",e.style.cssText="position: absolute; top: 40px; right: 10px; color: var(--gold); font-size: 1.2rem; z-index: 10;",e.textContent="❤️❤️❤️",o.appendChild(e)),o.style.display="block";let n=[];try{for(var t in vocabularySets)if(t.startsWith("1_")){var r=vocabularySets[t].words,a=vocabularySets[t].translations;for(let e=0;e<r.length&&e<a.length;e++)n.push({hebrew:r[e],english:a[e]})}}catch(e){console.error("Error loading vocabulary for waiting game:",e),n=[{hebrew:"כלב",english:"dog"},{hebrew:"חתול",english:"cat"},{hebrew:"בית",english:"house"},{hebrew:"אוכל",english:"food"},{hebrew:"מים",english:"water"},{hebrew:"ספר",english:"book"},{hebrew:"יד",english:"hand"},{hebrew:"עיר",english:"city"},{hebrew:"ילד",english:"child"},{hebrew:"אישה",english:"woman"}]}n=window.shuffleArray([...n]);let l=!0,c=0,d=1,u=[],m="",g=o.offsetWidth/2,p=null,v=null,h=3,f=0,y=3;function S(){var e=n[Math.floor(Math.random()*n.length)];m=e.hebrew,s.textContent=m}function w(){var e,t,r,a;l&&(e=n.find(e=>e.hebrew===m)?.english,t=n.filter(e=>e.hebrew!==m).map(e=>e.english),a=Math.random()<.4,(r=document.createElement("div")).className="falling-word",a&&e?(r.textContent=e,r.dataset.matching="true"):(a=t[Math.floor(Math.random()*t.length)],r.textContent=a||"word",r.dataset.matching="false"),r.style.cssText=`
      position: absolute;
      top: -30px;
      left: ${Math.random()*(o.offsetWidth-80)+40}px;
      padding: 5px 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      color: white;
      transition: top 0.1s linear;
    `,o.appendChild(r),u.push({element:r,y:-30,x:parseFloat(r.style.left),width:0,isMatching:"true"===r.dataset.matching}))}function b(){if(l){var t=o.offsetHeight,r=t-60;for(let e=u.length-1;0<=e;e--){var a=u[e];if(0===a.width&&(a.width=a.element.offsetWidth),a.y+=d,a.element.style.top=a.y+"px",t<a.y){if(a.isMatching){f++;let e=document.createElement("div");e.textContent=`Missed match! (${f}/${y})`,e.style.cssText=`
            position: absolute;
            left: ${a.x}px;
            bottom: 10px;
            color: var(--error);
            font-weight: bold;
            animation: float-up 1s forwards;
            z-index: 5;
          `,o.appendChild(e),setTimeout(()=>{o.removeChild(e)},1e3);var n=document.getElementById("waiting-game-lives");n&&(n.textContent="❤️".repeat(Math.max(0,3-f))),f>=y&&C()}o.removeChild(a.element),u.splice(e,1)}else{s.getBoundingClientRect(),a.element.getBoundingClientRect();if(a.y+a.element.offsetHeight>=r&&a.x+a.width>=g-s.offsetWidth/2&&a.x<=g+s.offsetWidth/2){if(a.isMatching){c+=10,i.textContent="Score: "+c;let e=document.createElement("div");e.textContent="+10",e.style.cssText=`
            position: absolute;
            left: ${a.x}px;
            top: ${a.y}px;
            color: var(--gold);
            font-weight: bold;
            animation: float-up 1s forwards;
            z-index: 5;
          `,o.appendChild(e),setTimeout(()=>{o.removeChild(e)},1e3),d+=.05,S()}else{c=Math.max(0,c-5),i.textContent="Score: "+c,h--;n=document.getElementById("waiting-game-lives");n&&(n.textContent="❤️".repeat(h));let e=document.createElement("div");e.textContent="-5",e.style.cssText=`
            position: absolute;
            left: ${a.x}px;
            top: ${a.y}px;
            color: var(--error);
            font-weight: bold;
            animation: float-up 1s forwards;
            z-index: 5;
          `,o.appendChild(e),setTimeout(()=>{o.removeChild(e)},1e3),h<=0&&C()}o.removeChild(a.element),u.splice(e,1)}}}p=requestAnimationFrame(b)}}function C(){l=!1,clearInterval(v);let e=document.createElement("div");e.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 1rem 2rem;
      border-radius: 10px;
      text-align: center;
      z-index: 20;
    `,e.innerHTML=`
      <h3 style="color: var(--error); margin-bottom: 0.5rem;">Game Over!</h3>
      <p style="margin-bottom: 1rem;">Score: ${c}</p>
      <button id="game-restart-btn" class="start-button" style="font-size: 0.9rem; padding: 0.5rem 1rem;">Play Again</button>
    `,o.appendChild(e),document.getElementById("game-restart-btn").addEventListener("click",()=>{o.removeChild(e),T()})}let L=!1;function k(e){L=!0;var t=(e.type.includes("touch")?e.touches[0]:e).pageX,r=o.getBoundingClientRect();g=t-r.left,I(),e.type.includes("touch")&&e.preventDefault()}function x(e){var t,r;L&&(t=(e.type.includes("touch")?e.touches[0]:e).pageX,r=o.getBoundingClientRect(),g=t-r.left,I(),e.type.includes("touch"))&&e.preventDefault()}function E(){L=!1}function I(){g=Math.max(s.offsetWidth/2,Math.min(o.offsetWidth-s.offsetWidth/2,g)),s.style.left=g+"px"}var A,e="waiting-game-styles";function T(){l=!0,c=0,d=1,h=3,f=0;var e=document.getElementById("waiting-game-lives");e&&(e.textContent="❤️❤️❤️"),u.forEach(e=>{e.element.parentNode&&o.removeChild(e.element)}),u=[],i.textContent="Score: "+c,S(),p=requestAnimationFrame(b),v=setInterval(w,2e3)}document.getElementById(e)||((A=document.createElement("style")).id=e,A.textContent=`
      @keyframes float-up {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-30px); opacity: 0; }
      }
      
      .falling-word {
        animation: gentle-wobble 2s infinite alternate;
      }
      
      @keyframes gentle-wobble {
        0% { transform: translateX(0px); }
        100% { transform: translateX(5px); }
      }
    `,document.head.appendChild(A)),s.addEventListener("mousedown",k),document.addEventListener("mousemove",x),document.addEventListener("mouseup",E),s.addEventListener("touchstart",k,{passive:!1}),document.addEventListener("touchmove",x,{passive:!1}),document.addEventListener("touchend",E);let P=setInterval(function(){currentArcadeSession&&"active"===currentArcadeSession.state&&(clearInterval(v),cancelAnimationFrame(p),o.style.display="none",s.removeEventListener("mousedown",k),document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",E),s.removeEventListener("touchstart",k),document.removeEventListener("touchmove",x),document.removeEventListener("touchend",E),clearInterval(P))},1e3);return T(),{stop:function(){l=!1,clearInterval(v),cancelAnimationFrame(p),clearInterval(P)}}}function updatePlayerRankDisplay(){if(currentArcadeSession&&currentArcadeSession.playerName){let t=!1,r=-1;for(let e=0;e<currentArcadeSession.participants.length;e++)if(currentArcadeSession.participants[e].username===currentArcadeSession.playerName){t=!0,r=e;break}!t&&currentGame?currentArcadeSession.participants.push({username:currentArcadeSession.playerName,wordsCompleted:currentGame.wordsCompleted||0,coins:currentGame.coins||0}):t&&currentGame&&(currentArcadeSession.participants[r].wordsCompleted=currentGame.wordsCompleted||0,currentArcadeSession.participants[r].coins=currentGame.coins||0);var c=[...currentArcadeSession.participants].sort((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins);let a=0,n=-1,o=-1,s=0;for(let e=0;e<c.length;e++){var d=c[e];if(d.wordsCompleted===n&&d.coins===o||(s=e+1,n=d.wordsCompleted,o=d.coins),d.username===currentArcadeSession.playerName){a=s;break}}var e;let i=(e=>{if(11<=e&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}})(a=0===a?1:a),l=document.querySelector(".player-rank-display");l?(e=l.querySelector(".rank-number"),parseInt(l.dataset.currentRank||"1")!==a&&(l.dataset.animating="true",e.classList.add("exiting"),setTimeout(()=>{var e;l&&((e=document.createElement("div")).className="rank-number entering",e.innerHTML=`${a}<span class="rank-suffix">${i}</span>`,l.innerHTML="",l.appendChild(e),l.dataset.currentRank=a,setTimeout(()=>{var e;l&&(l.dataset.animating="false",e=l.querySelector(".rank-number"))&&e.classList.remove("entering")},300))},300))):((l=document.createElement("div")).className="player-rank-display",l.dataset.currentRank=a,l.innerHTML=`
      <div class="rank-number entering">${a}<span class="rank-suffix">${i}</span></div>
    `,(e=document.getElementById("question-screen"))&&e.appendChild(l)),l.classList.remove("rank-1","rank-2","rank-3"),1<=a&&a<=3&&l.classList.add("rank-"+a)}}function toggleInlineEdit(e){var t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);t&&(t.classList.contains("editing")?saveInlineEdit(e):enterInlineEditMode(e,t))}function enterInlineEditMode(t,r){if(CustomListsManager.lists.find(e=>e.id===t)){r.classList.add("editing");var a=r.querySelector(".edit-button"),a=(a&&(a.textContent="Save"),r.querySelector(".list-header h3")),n=a.textContent;a.innerHTML=`<input type="text" class="list-name-edit" value="${n}" placeholder="List Name">`;let e=r.querySelector(".inline-edit-container");e||((e=document.createElement("div")).className="inline-edit-container",(a=document.createElement("div")).className="inline-word-translation-list",e.appendChild(a),(n=document.createElement("button")).className="main-button add-word-button",n.innerHTML='<i class="fas fa-plus"></i> Add Word',n.onclick=function(){addInlineWord(t)},e.appendChild(n),r.appendChild(e)),populateInlineWordList(t,e.querySelector(".inline-word-translation-list")),r.classList.contains("collapsed")&&r.classList.remove("collapsed")}}function populateInlineWordList(t,a){let n=CustomListsManager.lists.find(e=>e.id===t);n&&a&&(a.innerHTML="",Array.isArray(n.words)&&n.words.forEach((e,t)=>{var t=n.translations&&t<n.translations.length?n.translations[t]:"",r=document.createElement("div");r.className="inline-word-translation-item",r.draggable=!0,r.innerHTML=`
        <div class="drag-handle">
          <i class="fas fa-grip-vertical"></i>
        </div>
        <span class="source-word" contenteditable="true">${e}</span>
        <input type="text" class="target-word" value="${t}" placeholder="Hebrew translation">
        <button class="delete-word-btn" onclick="deleteInlineWord(this)">
          <i class="fas fa-times" style="font-size: 12px;"></i>
        </button>
      `,a.appendChild(r),initializeInlineDragAndDrop(r)}),makeInlineWordListDraggable(a))}function initializeInlineDragAndDrop(t){if(t){var r=t.cloneNode(!0);t.parentNode&&t.parentNode.replaceChild(r,t),(t=r).setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{e.stopPropagation(),t.classList.add("dragging"),e.dataTransfer.setData("text/plain","")}),t.addEventListener("dragend",e=>{e.stopPropagation(),t.classList.remove("dragging")});let e=t.querySelector(".delete-word-btn");return e&&(e.onclick=()=>deleteInlineWord(e)),t}}function makeInlineWordListDraggable(r){r&&(r.addEventListener("dragover",e=>{e.preventDefault();var t=r.querySelector(".dragging");t&&((e=getInlineDragAfterElement(r,e.clientY))?r.insertBefore(t,e):r.appendChild(t))}),r.querySelectorAll(".inline-word-translation-item").forEach(e=>{initializeInlineDragAndDrop(e)}))}function getInlineDragAfterElement(e,a){return e&&(e=[...e.querySelectorAll(".inline-word-translation-item:not(.dragging)")]).length?e.reduce((e,t)=>{var r=t.getBoundingClientRect(),r=a-r.top-r.height/2;return r<0&&r>e.offset?{offset:r,element:t}:e},{offset:Number.NEGATIVE_INFINITY}).element:null}function addInlineWord(e){var t,e=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);e&&(e=e.querySelector(".inline-word-translation-list"))&&((t=document.createElement("div")).className="inline-word-translation-item",t.draggable=!0,t.innerHTML=`
    <div class="drag-handle">
      <i class="fas fa-grip-vertical"></i>
    </div>
    <span class="source-word" contenteditable="true"></span>
    <input type="text" class="target-word" placeholder="Hebrew translation">
    <button class="delete-word-btn" onclick="deleteInlineWord(this)">
      <i class="fas fa-times" style="font-size: 12px;"></i>
    </button>
  `,initializeInlineDragAndDrop(t=e.appendChild(t)),1===e.children.length&&makeInlineWordListDraggable(e),t.querySelector(".source-word").focus())}function deleteInlineWord(e){e&&(e=e.closest(".inline-word-translation-item"))&&e.remove()}function saveInlineEdit(o){let s=document.querySelector(`.custom-list-item[data-list-id="${o}"]`);if(s){var e=CustomListsManager.lists.find(e=>e.id===o);if(e){var t=s.querySelector(".list-name-edit");let r=t?t.value.trim():e.name,a=[],n=[];s.querySelectorAll(".inline-word-translation-item").forEach(e=>{var t=e.querySelector(".source-word").textContent.trim(),e=e.querySelector(".target-word").value.trim();t&&e&&(a.push(t),n.push(e))});t={...e,name:r,words:a,translations:n};CustomListsManager.save(t).then(e=>{var t;e?(s.classList.remove("editing"),(e=s.querySelector(".edit-button"))&&(e.textContent="Edit"),(e=s.querySelector(".list-header h3"))&&(e.textContent=r),(e=s.querySelector(".word-preview"))&&(e.textContent=a.slice(0,5).join(", ")+(5<a.length?"...":"")),(e=s.querySelector(".word-count"))&&(e.textContent=a.length+" words",e.classList.toggle("insufficient",a.length<6)),(e=s.querySelector(".warning-text"))&&(e.style.display=a.length<6?"":"none"),(e=s.querySelector(".practice-button"))&&(t=6<=a.length,e.disabled=!t,e.textContent=t?"Practice":`Need ${6-a.length} more`,e.style.opacity=t?"1":"0.6",e.style.cursor=t?"pointer":"not-allowed",e.onclick=t?function(){startCustomListPractice(o)}:null),showNotification("List saved successfully","success")):showNotification("Failed to save list","error")})}}}function handleUpgradeButtonClick(e){console.log("Upgrade button clicked directly"),e&&e.preventDefault(),handleUpgradeSubmit(e)}async function handleUpgradeSubmit(e){console.log("handleUpgradeSubmit called"),e&&e.preventDefault();e=document.getElementById("isAdult").checked;try{if(e){var t=document.getElementById("fullName"),r=document.getElementById("phone");if(!t.value.trim())return t.style.border="2px solid #ff4444",alert("Please enter your full name"),!1;if(!r.value.trim())return r.style.border="2px solid #ff4444",alert("Please enter your phone number"),!1}else{var a=document.getElementById("parentName"),n=document.getElementById("parentPhone");if(!a.value.trim())return a.style.border="2px solid #ff4444",alert("Please enter your parent's full name"),!1;if(!n.value.trim())return n.style.border="2px solid #ff4444",alert("Please enter your parent's phone number"),!1}var o={user_id:currentUser.id,is_adult:e,full_name:(e?document.getElementById("fullName"):document.getElementById("parentName")).value,phone:(e?document.getElementById("phone"):document.getElementById("parentPhone")).value,parent_name:e?null:document.getElementById("parentName").value,parent_phone:e?null:document.getElementById("parentPhone").value,referral_source:document.getElementById("referralSource").value};try{var s=(await supabaseClient.from("upgrade_requests").insert([o]).select()).error;s&&console.warn("Could not save to upgrade_requests table:",s.message)}catch(e){console.warn("Error with upgrade_requests table, continuing:",e.message)}var i=(await supabaseClient.from("user_profiles").update({status:"pending"}).eq("id",currentUser.id)).error;if(i)throw i;return localStorage.setItem("upgradeRequested_"+currentUser.id,"true"),updateUserStatusDisplay("pending"),showUpgradeConfirmation(),!0}catch(e){return console.error("Upgrade Request Error:",e),alert("Error processing request. Please try again."),!1}}function validateForm(e){try{return e?document.getElementById("fullName").value.trim()&&document.getElementById("phone").value.trim():document.getElementById("parentName").value.trim()&&document.getElementById("parentPhone").value.trim()}catch(e){return console.error("Error in validateForm:",e),!1}}function showUpgradeConfirmation(){document.querySelectorAll(".upgrade-confirmation-popup, .confirmation-popup").forEach(e=>e.remove());let t=document.createElement("div");t.className="upgrade-confirmation-overlay",t.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2002;
  `;var e=document.createElement("div");e.className="upgrade-confirmation-content",e.style.cssText=`
    background: var(--primary-dark);
    border: 3px solid var(--gold);
    border-radius: 20px;
    padding: 2.5rem 2rem;
    text-align: center;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
    position: relative;
  `,e.innerHTML=`
    <h2 style="color: var(--gold); margin-bottom: 1.5rem; font-size: 2rem;">Thank You!</h2>
    <p style="margin-bottom: 2.5rem; color: var(--text); font-size: 1.1rem; line-height: 1.6;">
      We've received your upgrade request. We'll contact you soon with payment details.
    </p>
    <button id="upgrade-continue-button" style="
      background: var(--gold);
      color: var(--primary-dark);
      border: none;
      padding: 1rem 2rem;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
      width: 80%;
      max-width: 300px;
    ">Continue Playing</button>
  `,t.appendChild(e),document.body.appendChild(t),setTimeout(()=>{var e=document.getElementById("upgrade-continue-button");e?(console.log("Adding event listener to continue button"),e.onclick=function(e){return e.preventDefault(),e.stopPropagation(),console.log("Continue button clicked!"),handleUpgradeContinue(),!1},e.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),console.log("Continue button clicked (addEventListener)!"),handleUpgradeContinue()},!0),e.addEventListener("mouseover",function(){this.style.background="linear-gradient(to bottom, var(--gold), #ffa500)",this.style.transform="translateY(-2px)",this.style.boxShadow="0 7px 20px rgba(255, 215, 0, 0.4)"}),e.addEventListener("mouseout",function(){this.style.background="var(--gold)",this.style.transform="translateY(0)",this.style.boxShadow="0 5px 15px rgba(255, 215, 0, 0.3)"})):console.error("Continue button not found in the DOM"),t.addEventListener("click",function(e){e.target===this&&handleUpgradeContinue()})},100),console.log("Upgrade confirmation popup added to DOM")}function handleUpgradeContinue(){console.log("handleUpgradeContinue called");let e=document.querySelector(".upgrade-confirmation-overlay");e&&(e.style.opacity="0",e.style.transition="opacity 0.3s ease",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)),document.querySelectorAll(".confirmation-popup").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)});var t=document.getElementById("upgrade-screen"),t=(t&&t.classList.remove("visible"),document.getElementById("upgradeForm"));t&&t.reset(),localStorage.removeItem("gameContext"),hideUpgradePromptAndContinue(),showScreen("welcome-screen"),console.log("Upgrade process completed, redirected to welcome screen")}function continueAfterUpgrade(){console.log("continueAfterUpgrade called");let e=document.querySelector(".confirmation-popup");e&&(e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.7)",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300));var t=document.getElementById("upgrade-screen"),t=(t&&t.classList.remove("visible"),document.getElementById("upgradeForm")),t=(t&&t.reset(),gameState.currentLevel);hideUpgradePromptAndContinue(),t&&(console.log("Resuming gameplay at level "+t),setTimeout(()=>{var e=localStorage.getItem("gameContext");if(e)try{var t=JSON.parse(e);t.level&&(gameState.currentLevel=t.level,startLevel(t.level))}catch(e){console.error("Error parsing game context:",e)}},500)),console.log("Upgrade process completed")}function toggleFullScreen(){var e=document.documentElement;let t=document.querySelector("#nav-fullscreen-btn i");document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().then(()=>{t&&(t.className="fas fa-expand")}).catch(e=>{console.log("Error attempting to exit fullscreen: "+e.message)}):e.requestFullscreen&&e.requestFullscreen().then(()=>{t&&(t.className="fas fa-compress")}).catch(e=>{console.log("Error attempting to enable fullscreen: "+e.message)})}function updateNavigationContainer(){var e,t=document.querySelector(".navigation-menu"),t=(t&&t.remove(),document.querySelector(".vertical-nav-container")),t=(t||((t=document.createElement("div")).className="vertical-nav-container",document.body.appendChild(t),(e=document.createElement("button")).className="hamburger-button",e.id="nav-hamburger-btn",e.innerHTML='<i class="fas fa-bars"></i>',e.onclick=toggleSidePanel,t.appendChild(e),(e=document.createElement("button")).className="nav-button home-button",e.id="nav-home-btn",e.innerHTML='<i class="fas fa-home"></i>',e.onclick=navigateHome||function(){showScreen("welcome-screen")},t.appendChild(e),(e=document.createElement("button")).className="nav-button fullscreen-button",e.id="nav-fullscreen-btn",e.innerHTML='<i class="fas fa-expand"></i>',e.onclick=toggleFullScreen,t.appendChild(e),(e=document.createElement("button")).className="nav-button reset-button",e.id="nav-reset-btn",e.innerHTML='<i class="fas fa-trash-alt"></i>',e.onclick=handleResetProgress,t.appendChild(e),(e=document.createElement("button")).className="nav-button settings-button",e.id="nav-settings-btn",e.innerHTML='<i class="fas fa-cog"></i>',e.onclick=function(){var e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(e),(e=document.createElement("button")).className="nav-button accessibility-button",e.id="nav-accessibility-btn",e.innerHTML='<i class="fas fa-universal-access"></i>',e.onclick=function(){var e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(e)),{hamburger:document.querySelector(".hamburger-button:not(.vertical-nav-container .hamburger-button)"),home:document.querySelector(".home-button:not(.vertical-nav-container .home-button)"),fullscreen:document.querySelector(".fullscreen-button:not(.vertical-nav-container .fullscreen-button)"),reset:document.querySelector(".reset-button:not(.vertical-nav-container .reset-button)"),settings:document.querySelector(".settings-button:not(.vertical-nav-container .settings-button)"),accessibility:document.querySelector(".accessibility-toggle")});Object.values(t).forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}function optimizeQuestionScreenForMobile(){var e=document.getElementById("question-screen");e&&/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&e.classList.add("mobile-optimized")}document.addEventListener("DOMContentLoaded",function(){["fullName","phone","parentName","parentPhone"].forEach(e=>{e=document.getElementById(e);e&&e.addEventListener("input",function(){this.style.border="1px solid rgba(255, 255, 255, 0.2)"})});var e=document.getElementById("upgradeForm");e&&e.addEventListener("submit",function(e){console.log("Form submit event triggered"),handleUpgradeSubmit(e)})}),window.debugUpgrade=function(){checkPopupStatus(),console.log("Upgrade screen visible:",document.getElementById("upgrade-screen").classList.contains("visible")),console.log("Upgrade form:",document.getElementById("upgradeForm")),console.log("Current user:",currentUser)},window.debugUpgrade=function(){var e=document.querySelectorAll(".confirmation-popup");0===e.length?console.log("No confirmation popups found in the DOM"):e.forEach((e,t)=>{console.log(`Popup ${t+1}:`,{visibility:window.getComputedStyle(e).visibility,opacity:window.getComputedStyle(e).opacity,display:window.getComputedStyle(e).display,zIndex:window.getComputedStyle(e).zIndex,transform:window.getComputedStyle(e).transform,position:window.getComputedStyle(e).position})}),console.log("Upgrade screen visible:",document.getElementById("upgrade-screen").classList.contains("visible")),console.log("Upgrade form:",document.getElementById("upgradeForm"))},document.addEventListener("fullscreenchange",function(){var e=document.querySelector("#nav-fullscreen-btn i");e&&(document.fullscreenElement?e.className="fas fa-compress":e.className="fas fa-expand")}),document.addEventListener("DOMContentLoaded",function(){let r=window.showScreen;"function"==typeof r&&(window.showScreen=function(e,t){r(e,t),"question-screen"===e&&optimizeQuestionScreenForMobile()}),document.getElementById("question-screen")?.classList.contains("visible")&&optimizeQuestionScreenForMobile()});