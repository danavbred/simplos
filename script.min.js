document.addEventListener("progressSaved",(e=>{const t=document.getElementById("stage-cascade-screen");t&&t.classList.contains("visible")&&Js()})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector(".logout-button");e&&e.addEventListener("click",C)})),document.addEventListener("click",(e=>{const t=document.querySelector(".side-panel"),n=document.querySelector(".hamburger-button");!t.classList.contains("open")||t.contains(e.target)||n.contains(e.target)||wn()})),document.addEventListener("DOMContentLoaded",(()=>{new Set}));const e={particlePool:[],maxParticles:20,init(){for(let e=0;e<this.maxParticles;e++){const e=document.createElement("div");e.className="particle mobile-particle",this.particlePool.push(e)}},createParticle(e,t){if(window.innerWidth<=768)return;const n=this.particlePool.pop();n&&(n.style.left=`${e}px`,n.style.top=`${t}px`,setTimeout((()=>{this.particlePool.push(n)}),500))}},n={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],startTime:null,endTime:null,podiumRanks:{},playerName:null,winnerScreenShown:!1};function s(){requestAnimationFrame((()=>{const e=document.createDocumentFragment();document.body.appendChild(e)}))}document.addEventListener("click",(e=>{const t=e.target;t.matches(".game-btn")?handleButtonClick(t):t.matches(".level")&&handleLevelClick(t)}));const r={displayElements:new Set,initialize(){this.displayElements.clear(),document.querySelectorAll(".coin-count").forEach((e=>{this.displayElements.add(e)}))},async loadUserCoins(){if(!currentUser)return parseInt(localStorage.getItem("simploxCustomCoins")||"0");try{const{data:e,error:t}=await p.from("game_progress").select("coins").eq("user_id",currentUser.id).single();if(t)throw t;return e.coins||0}catch(e){return 0}},async updateCoins(e){try{const t=$.coins,n=t+e;if($.coins=n,this.displayElements.forEach((s=>{let r=t;const o=performance.now();requestAnimationFrame((function a(i){const c=i-o,l=Math.min(c/1e3,1);r=t+(n-t)*l,s.textContent=Math.round(r),e>0?s.style.color="var(--success)":e<0&&(s.style.color="var(--error)"),l<1?requestAnimationFrame(a):(s.textContent=n,setTimeout((()=>{s.style.color="var(--text)"}),300))}))})),currentUser){const{error:e}=await p.from("game_progress").update({coins:n}).eq("user_id",currentUser.id);if(e)throw e}else localStorage.setItem("simploxCustomCoins",n.toString());return Go(),B(),!0}catch(t){return this.displayElements.forEach((t=>{t.textContent=$.coins-e})),B(),!1}},updateDisplays(){this.displayElements.forEach((e=>{e.textContent=$.coins})),B()}},o={displayElements:new Set,initialize(){this.displayElements.clear(),document.querySelectorAll("#totalWords").forEach((e=>{this.displayElements.add(e)})),currentUser&&this.loadUserWords().then((e=>{this.updateDisplays(e)}))},async loadUserWords(){if(!currentUser)return 0;try{const{data:e,error:t}=await p.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();if(t)throw t;return e?.unique_words_practiced||0}catch(e){return 0}},async updateWords(e){try{const t=parseInt(document.getElementById("totalWords").textContent)||0,n=t+e;if(this.displayElements.forEach((e=>{let s=t;const r=performance.now();requestAnimationFrame((function o(a){const i=a-r,c=Math.min(i/1e3,1);s=t+(n-t)*c,e.textContent=Math.round(s),c<1?requestAnimationFrame(o):e.textContent=n}))})),currentUser){const{error:e}=await p.from("player_stats").update({unique_words_practiced:n}).eq("user_id",currentUser.id);if(e)throw e}return!0}catch(e){return!1}},updateDisplays(e){this.displayElements.forEach((t=>{t.textContent=e}))}},a={timeFreeze:document.getElementById("timeFreezePerk"),skip:document.getElementById("skipPerk"),clue:document.getElementById("cluePerk"),reveal:document.getElementById("revealPerk")};Object.entries(a).forEach((([e,t])=>{t&&(t.onclick=()=>P(e))}));const i={lastTick:0,update(e){this.lastTick||(this.lastTick=e);e-this.lastTick>=1e3&&(this.updateTimer(),this.lastTick=e),requestAnimationFrame(this.update.bind(this))}};function c(){document.querySelectorAll(".buttons button").forEach((e=>{e.onclick=null})),e.clear(),clearTimeout(levelTimeout)}async function l(e){const t=document.querySelector(".screen.visible");t&&(t.style.opacity=0,await new Promise((e=>setTimeout(e,300))),t.style.display="none");const n=document.getElementById(`${e}-screen`);n.style.display="flex",requestAnimationFrame((()=>{n.style.opacity=1}))}const d={words:new Map,async getWords(e){if(this.words.has(e))return this.words.get(e);const t=await loadWords(e);return this.words.set(e,t),t}},u={async init(){if(await _t(),currentUser){await q()?await x(currentUser.id):S()}else S();B(),Ie(document.getElementById("welcome-screen")),await po(),Mt()}};document.addEventListener("DOMContentLoaded",(()=>{u.init()}));const{createClient:m}=supabase,p=m("https://mczfgzffyyyacisrccqb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jemZnemZmeXl5YWNpc3JjY3FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzODYyMDQsImV4cCI6MjA1Mzk2MjIwNH0.rLga_B29Coz1LMeJzFTGLIhckdcojGXnD1ae1bw-QAI",{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0});function f(e=""){const t=document.getElementById("arcade-modal"),n=document.getElementById("teacher-view"),s=document.getElementById("player-view"),r=document.getElementById("otpInput");if(t){t.style.display="block",n&&(n.style.display="none"),s&&(s.style.display="block"),r&&(r.value="");const o=document.getElementById("arcadeUsername");if(o){o.value="",o.readOnly=!1,o.style.display="block";const t=o.closest(".input-group")?.querySelector(".username-display");t&&t.remove(),r&&e&&(r.value=e,setTimeout((()=>o.focus()),300))}if("undefined"!=typeof currentUser&&currentUser)try{const e=currentUser.user_metadata?.username||currentUser.email.split("@")[0];if(o&&e){o.value=e,o.readOnly=!0,o.style.display="none";const t=o.closest(".input-group");if(t&&!t.querySelector(".username-display")){const n=document.createElement("div");n.className="username-display",n.textContent=`Joining as: ${e}`,t.insertBefore(n,o)}}}catch(e){}}}async function g(){const e=document.getElementById("signupEmail").value,t=document.getElementById("signupUsername").value,n=document.getElementById("signupPassword").value;if(e&&t&&n)try{const{data:s,error:r}=await p.auth.signUp({email:e,password:n,options:{data:{username:t,full_name:t}}});if(r)throw r;const{error:o}=await p.from("user_profiles").upsert({id:s.user.id,username:t,email:e,status:"free",role:"student"},{onConflict:"id"}),{data:a,error:i}=await p.from("game_progress").select("user_id").eq("user_id",s.user.id).single();if(i&&"PGRST116"===i.code){const e={user_id:s.user.id,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]},{error:t}=await p.from("game_progress").insert([e]);t&&t.code}const{data:c,error:l}=await p.from("player_stats").select("user_id").eq("user_id",s.user.id).single();if(l&&"PGRST116"===l.code){const e={user_id:s.user.id,total_levels_completed:0,unique_words_practiced:0},{error:t}=await p.from("player_stats").insert([e]);t&&t.code}const{data:d,error:u}=await p.auth.signInWithPassword({email:e,password:n});if(u)throw u;kn(),currentUser=d.user,$.currentStage=1,$.currentSet=1,$.currentLevel=1,$.coins=0,$.perks={},$.unlockedSets={1:new Set([1])},$.unlockedLevels={"1_1":new Set([1])},$.perfectLevels=new Set,$.completedLevels=new Set,_(),Z("welcome-screen")}catch(e){e.message&&e.message.includes("duplicate key")?alert("This username or email is already taken. Please try another."):alert("Signup error: "+e.message)}else alert("All fields are required")}async function y(e,t,n="user_id"){try{const{data:s,error:r}=await p.from(e).select(n).eq(n,t[n]).single();if(r&&"PGRST116"===r.code){const{error:s}=await p.from(e).insert([t]);if(s){if("23505"!==s.code)return!1;{const{error:s}=await p.from(e).update(t).eq(n,t[n]);if(s)return!1}}}else{if(r)return!1;{const{error:s}=await p.from(e).update(t).eq(n,t[n]);if(s)return!1}}return!0}catch(e){return!1}}async function h(e){const t=$.coins;if($.coins+=e,ve(),B(),currentUser)try{const{error:e}=await p.from("game_progress").update({coins:$.coins}).eq("user_id",currentUser.id);if(e)return $.coins=t,ve(),B(),!1}catch(e){return $.coins=t,ve(),B(),!1}const n=JSON.parse(localStorage.getItem("simploxProgress")||"{}");return n.coins=$.coins,localStorage.setItem("simploxProgress",JSON.stringify(n)),!0}async function v(){if(!currentUser)return!1;try{const{data:e,error:t}=await p.from("game_progress").select("*").eq("user_id",currentUser.id).single();if(t)return!1;const n=!("completed_levels"in e),s=!("perfect_levels"in e);if(!n&&!s)return!0;const r={user_id:currentUser.id,stage:e.stage||1,set_number:e.set_number||1,level:e.level||1};"coins"in e&&(r.coins=e.coins||0),"unlocked_sets"in e&&(r.unlocked_sets=e.unlocked_sets||{}),"unlocked_levels"in e&&(r.unlocked_levels=e.unlocked_levels||{}),n&&(r.completed_levels=[]),s&&(r.perfect_levels=[]);const{error:o}=await p.from("game_progress").update(r).eq("user_id",currentUser.id);return!o}catch(e){return!1}}async function w(e){const{error:t}=await p.from("game_progress").insert({user_id:e,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]})}async function b(){const e=document.getElementById("loginUsername").value,t=document.getElementById("loginPassword").value;if(e&&t)try{let n;if(e.includes("@"))n=p.auth.signInWithPassword({email:e,password:t});else{const{data:s,error:r}=await p.from("user_profiles").select("email").eq("username",e).single();if(r||!s)return void alert("Username not found");n=p.auth.signInWithPassword({email:s.email,password:t})}const{data:s,error:r}=await n;if(r)return void alert(r.message);if(s.user){currentUser=s.user,kn();const{data:e}=await p.from("user_profiles").select("status").eq("id",currentUser.id).single();e&&(currentUser.status=e.status,bt(e.status)),await Promise.all([po(),x(currentUser.id)]),_(),xn(),Z("welcome-screen")}}catch(e){alert("An unexpected error occurred during login")}else alert("Please enter both username/email and password")}function S(){const e=$.extendedPerks;$.currentStage=1,$.currentSet=1,$.currentLevel=1,$.coins=0,$.perks={},$.unlockedSets={},$.unlockedLevels={},$.perfectLevels=new Set,$.completedLevels=new Set;const t=localStorage.getItem("simploxProgress");if(t)try{const e=JSON.parse(t);e.stage&&($.currentStage=e.stage),e.set_number&&($.currentSet=e.set_number),e.level&&($.currentLevel=e.level),e.coins&&($.coins=e.coins),e.perks&&($.perks=e.perks),e.extended_perks&&($.extendedPerks=e.extended_perks),e.unlocked_sets&&Object.entries(e.unlocked_sets).forEach((([e,t])=>{$.unlockedSets[e]=new Set(Array.isArray(t)?t:[])})),e.unlocked_levels&&Object.entries(e.unlocked_levels).forEach((([e,t])=>{$.unlockedLevels[e]=new Set(Array.isArray(t)?t:[])})),e.perfect_levels&&($.perfectLevels=new Set(e.perfect_levels)),e.completed_levels&&($.completedLevels=new Set(e.completed_levels))}catch(e){}const n=localStorage.getItem("gameContext");if(n)try{const e=JSON.parse(n);Date.now()-(e.timestamp||0)<864e5&&(e.stage&&($.currentStage=e.stage),e.set&&($.currentSet=e.set),e.level&&($.currentLevel=e.level))}catch(e){}!$.extendedPerks&&e&&($.extendedPerks=e),$.extendedPerks||No(),k(),ve(),B()}function k(){$.unlockedSets[1]||($.unlockedSets[1]=new Set);for(let e=1;e<=9;e++){$.unlockedSets[1].add(e);const t=`1_${e}`;$.unlockedLevels[t]||($.unlockedLevels[t]=new Set([1]))}for(let e=2;e<=5;e++){$.unlockedSets[e]||($.unlockedSets[e]=new Set([1]));const t=`${e}_1`;$.unlockedLevels[t]||($.unlockedLevels[t]=new Set([1]))}}async function x(e){try{$.currentStage=1,$.currentSet=1,$.currentLevel=1,$.coins=0,$.perks={},$.unlockedSets={1:new Set([1])},$.unlockedLevels={"1_1":new Set([1])},$.perfectLevels=new Set,$.completedLevels=new Set;const t=localStorage.getItem("simploxProgress");if(t)try{const e=JSON.parse(t);e.stage&&($.currentStage=e.stage),e.set_number&&($.currentSet=e.set_number),e.level&&($.currentLevel=e.level),e.coins&&($.coins=e.coins),e.perks&&($.perks=e.perks),e.extended_perks&&($.extendedPerks=e.extended_perks),e.unlocked_sets&&($.unlockedSets={},Object.entries(e.unlocked_sets).forEach((([e,t])=>{$.unlockedSets[e]=new Set(t)}))),e.unlocked_levels&&($.unlockedLevels={},Object.entries(e.unlocked_levels).forEach((([e,t])=>{$.unlockedLevels[e]=new Set(t)}))),e.perfect_levels&&($.perfectLevels=new Set(e.perfect_levels)),e.completed_levels&&($.completedLevels=new Set(e.completed_levels))}catch(e){}const{data:n,error:s}=await p.from("game_progress").select("*").eq("user_id",e).single();if(s){if("PGRST116"===s.code){const t={user_id:e,stage:$.currentStage,set_number:$.currentSet,level:$.currentLevel,coins:$.coins},{error:n}=await p.from("game_progress").insert([t])}}else if(n){$.currentStage=n.stage||$.currentStage,$.currentSet=n.set_number||$.currentSet,$.currentLevel=n.level||$.currentLevel,$.coins=n.coins||$.coins;try{n.perks&&Object.keys(n.perks).length>0&&($.perks=n.perks),n.extended_perks&&($.extendedPerks=n.extended_perks),n.unlocked_sets&&Object.keys(n.unlocked_sets).length>0&&($.unlockedSets={},Object.entries(n.unlocked_sets).forEach((([e,t])=>{$.unlockedSets[e]=new Set(t)}))),n.unlocked_levels&&Object.keys(n.unlocked_levels).length>0&&($.unlockedLevels={},Object.entries(n.unlocked_levels).forEach((([e,t])=>{$.unlockedLevels[e]=new Set(t)}))),n.perfect_levels&&n.perfect_levels.length>0&&($.perfectLevels=new Set(n.perfect_levels)),n.completed_levels&&n.completed_levels.length>0&&($.completedLevels=new Set(n.completed_levels))}catch(e){}}return $.extendedPerks||No(),k(),ve(),!0}catch(e){return!1}}function L(){Object.entries($.unlockedSets).forEach((([e,t])=>{})),Object.entries($.unlockedLevels).forEach((([e,t])=>{}))}async function C(){try{const{error:e}=await p.auth.signOut();$.coins=0,$.unlockedSets={},$.unlockedLevels={},$.perfectLevels=new Set,$.completedLevels=new Set,E(),currentUser=null,_(),bt(null),xn(),Z("welcome-screen")}catch(e){currentUser=null,_(),bt(null),xn(),Z("welcome-screen")}}function E(){const e=document.getElementById("custom-list-name");e&&(e.value="");const t=document.getElementById("custom-word-input");t&&(t.value="");const n=document.getElementById("translation-results");n&&(n.style.display="none");const s=document.getElementById("word-translation-list");s&&(s.innerHTML=""),ze.currentList=null,ze.lists=[]}function I(){if(!$.currentStage)return;const e={stage:$.currentStage||1,set_number:$.currentSet||1,level:$.currentLevel||1,coins:$.coins||0},t={perks:$.perks||{},unlocked_sets:Object.fromEntries(Object.entries($.unlockedSets||{}).map((([e,t])=>[e,Array.from(t||[])]))),unlocked_levels:Object.fromEntries(Object.entries($.unlockedLevels||{}).map((([e,t])=>[e,Array.from(t||[])]))),perfect_levels:Array.from($.perfectLevels||[]),completed_levels:Array.from($.completedLevels||[]),extended_perks:$.extendedPerks||null};localStorage.setItem("simploxProgress",JSON.stringify({...e,...t}));const n={stage:$.currentStage,set:$.currentSet,level:$.currentLevel,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(n)),currentUser&&p.from("game_progress").upsert({user_id:currentUser.id,...e}).then((({error:e})=>{if(e);else{const e=(e,t)=>{const n={[e]:t};p.from("game_progress").update(n).eq("user_id",currentUser.id).then((({error:e})=>{}))};Object.entries(t).forEach((([t,n])=>{e(t,n)}))}}))}async function q(){if(!currentUser)return!1;try{const{data:e,error:t}=await p.from("game_progress").select("*").eq("user_id",currentUser.id).single();if(t){if("PGRST116"===t.code){const e={user_id:currentUser.id,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]},{error:t}=await p.from("game_progress").insert([e]);return!t}return!1}let n=!1;const s={...e},r=[{name:"unlocked_sets",defaultValue:{1:[1]}},{name:"unlocked_levels",defaultValue:{"1_1":[1]}},{name:"perfect_levels",defaultValue:[]},{name:"completed_levels",defaultValue:[]}];for(const t of r)t.name in e&&null!==e[t.name]||(s[t.name]=t.defaultValue,n=!0);if(n){const{error:e}=await p.from("game_progress").update(s).eq("user_id",currentUser.id);if(e)return!1}return!0}catch(e){return!1}}function T(e){const t=document.querySelector(".auth-tab[onclick=\"switchAuthTab('login')\"]"),n=document.querySelector(".auth-tab[onclick=\"switchAuthTab('signup')\"]"),s=document.getElementById("loginForm"),r=document.getElementById("signupForm");"login"===e?(t.classList.add("active"),n.classList.remove("active"),s.classList.remove("hidden"),r.classList.add("hidden")):(t.classList.remove("active"),n.classList.add("active"),s.classList.add("hidden"),r.classList.remove("hidden"))}function _(){const e=document.getElementById("authBox"),t=document.getElementById("userInfo"),n=document.getElementById("userEmail"),s=document.querySelector(".logout-button");currentUser?(e.classList.add("hidden"),t.classList.remove("hidden"),s.classList.remove("hidden"),n.textContent=currentUser.user_metadata?.username||currentUser.email,p.from("user_profiles").select("status, username").eq("id",currentUser.id).single().then((({data:e})=>{e&&(e.username&&(n.textContent=e.username),bt(e.status))})).catch((e=>{}))):(e.classList.remove("hidden"),t.classList.add("hidden"),s.classList.add("hidden"),n.textContent="")}document.addEventListener("DOMContentLoaded",(async()=>{try{if(window.CustomListsManager||(window.CustomListsManager={lists:[],async initialize(){currentUser?await this.loadFromSupabase():this.loadFromLocalStorage()},async loadFromSupabase(){try{const{data:e,error:t}=await p.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`);if(t)throw t;this.lists=e.map((e=>({id:e.id,name:e.name,words:e.words||[],translations:e.translations||[],isShared:e.is_shared,sharedBy:e.shared_by,userId:e.user_id,createdAt:e.created_at})))}catch(e){this.lists=[]}},loadFromLocalStorage(){try{const e=localStorage.getItem("simploxCustomLists");this.lists=e?JSON.parse(e):[]}catch(e){this.lists=[]}},async save(e){return e?currentUser?await this.saveToSupabase(e):this.saveToLocalStorage(e):null},async saveToSupabase(e){try{const t={name:e.name,words:e.words||[],translations:e.translations||[],user_id:currentUser.id};if(e.id&&"string"==typeof e.id&&36===e.id.length){const{data:n,error:s}=await p.from("custom_lists").update(t).eq("id",e.id).select().single();if(s)throw s;return n}{const{data:n,error:s}=await p.from("custom_lists").insert(t).select().single();if(s)throw s;const r=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==r?this.lists[r]={...n,words:n.words||[],translations:n.translations||[]}:this.lists.push({...n,words:n.words||[],translations:n.translations||[]}),n}}catch(e){return null}},saveToLocalStorage(e){try{const t={...e,id:e.id||Date.now(),tempId:e.tempId||Date.now()},n=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==n?this.lists[n]=t:this.lists.push(t),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),t}catch(e){return null}},async delete(e){if(!currentUser)return this.lists=this.lists.filter((t=>t.id!==e)),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),!0;try{if("string"==typeof e&&36===e.length){const{error:t}=await p.from("custom_lists").delete().eq("id",e);if(t)throw t}return this.lists=this.lists.filter((t=>t.id!==e)),!0}catch(e){return!1}},async share(e,t){if(!currentUser)return!1;try{const n=this.lists.find((t=>t.id===e));if(!n)return!1;return!(await p.rpc("insert_shared_list",{p_user_id:t,p_name:`${n.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,p_words:n.words||[],p_translations:n.translations||[],p_is_shared:!0,p_local_id:Date.now(),p_shared_with:[t],p_shared_by:currentUser.id})).error}catch(e){return!1}},getListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"};switch(currentUser.status||"free"){case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"∞"};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"∞"};case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1,playDisplay:"10"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"}}},canCreateMoreLists(){const e=this.getListLimits();return this.lists.length<e.maxLists}}),await _t(),S(),B(),xn(),r.initialize(),o.initialize(),await Jr.initialize(),currentUser){$.coins=await r.loadUserCoins(),r.updateDisplays();const e=await o.loadUserWords();o.updateDisplays(e)}if(window.addEventListener("hashchange",Nn),window.addEventListener("load",Nn),window.location.hash.startsWith("#join=")){const e=window.location.hash.replace("#join=","");history.pushState("",document.title,window.location.pathname),f(e)}Ie(document.getElementById("welcome-screen")),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(document.addEventListener("touchstart",(function e(){document.removeEventListener("touchstart",e)}),{once:!0}),document.addEventListener("click",(function(e){e.target.tagName})),screen.orientation&&screen.orientation.lock("portrait").catch((e=>{})));const e=document.getElementById("otpInput");e&&e.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),this.value.length>4&&(this.value=this.value.slice(0,4))})),currentUser&&(kt(),Pt())}catch(e){}})),document.addEventListener("DOMContentLoaded",(function(){currentUser=null,_t().then((()=>{S(),B(),Po()}))})),document.addEventListener("DOMContentLoaded",(()=>{(async()=>{if(await _t(),S(),B(),xn(),r.initialize(),o.initialize(),currentUser){const[e,t]=await Promise.all([r.loadUserCoins(),o.loadUserWords()]);$.coins=e,r.updateDisplays(),o.updateDisplays(t)}if(window.location.hash.startsWith("#join=")){const e=window.location.hash.replace("#join=","");history.pushState("",document.title,window.location.pathname),f(e)}Ie(document.getElementById("welcome-screen")),await po(),/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&(document.addEventListener("touchstart",(function e(){document.removeEventListener("touchstart",e)}),{once:!0}),document.addEventListener("click",(function(e){e.target.tagName})),screen.orientation&&screen.orientation.lock("portrait").catch((e=>{}))),currentUser&&(kt(),Pt())})().catch((e=>{}))}));const M={stages:[{id:1,numSets:9,levelsPerSet:21,bossLevel:21},{id:2,numSets:10,levelsPerSet:21,bossLevel:21},{id:3,numSets:12,levelsPerSet:21,bossLevel:21},{id:4,numSets:30,levelsPerSet:21,bossLevel:21},{id:5,numSets:14,levelsPerSet:21,bossLevel:21}],levelTypes:{normal:"normal",boss:"boss"}},$={currentStage:null,currentSet:null,sessionStartTime:null,currentLevel:null,unlockedSets:{},unlockedLevels:{},levelScores:{},completedLevels:new Set,perfectLevels:new Set,coins:0},A={timeFreeze:{name:"Time Freeze",description:"Pause the timer for 5 seconds",cost:15,icon:"fa-clock",duration:5e3},skip:{name:"Skip Question",description:"Skip the current word without penalty",cost:1,icon:"fa-forward"},clue:{name:"Eliminate Wrong Answer",description:"Remove one incorrect answer",cost:35,icon:"fa-lightbulb"},reveal:{name:"Reveal Correct Answer",description:"Show the correct translation",cost:50,icon:"fa-eye"}};function P(e){const t=A[e];if(t)if($.coins<t.cost)Tn(`Need ${t.cost} coins!`,"error");else{switch($.coins-=t.cost,ve(),e){case"timeFreeze":D=!0,setTimeout((()=>{D=!1}),t.duration);break;case"skip":cn(!0,!0);break;case"clue":const e=document.querySelectorAll(".buttons button"),n=U.isHebrewToEnglish?U.words[U.currentIndex]:U.translations[U.currentIndex],s=Array.from(e).filter((e=>e.textContent!==n));if(s.length>0){const e=s[Math.floor(Math.random()*s.length)];e.disabled=!0,e.style.opacity="0.5"}break;case"reveal":const r=U.isHebrewToEnglish?U.words[U.currentIndex]:U.translations[U.currentIndex];document.querySelectorAll(".buttons button").forEach((e=>{if(e.textContent===r){e.classList.add("correct");const t=e.style.background;e.style.background="var(--success)",setTimeout((()=>{e.classList.remove("correct"),e.style.background=t}),5e3)}}))}I()}}function B(){Object.entries(A).forEach((([e,t])=>{const n=document.getElementById(`${e}Perk`);if(n){const e=Math.floor($.coins/t.cost),s=e>0;n.disabled=!s,n.classList.toggle("disabled",!s);const r=n.querySelector(".perk-count");r&&(r.textContent=s?e.toString():"0")}}))}B();let U={words:[],translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,startTime:0,levelStartTime:0,timeBonus:0,streakBonus:!0,questionStartTime:0,wrongStreak:0,progressLost:0},N=null,F=0,D=!1,z=null,H=!0;function I(){if(currentUser){const e={stage:$.currentStage,set_number:$.currentSet,level:$.currentLevel,coins:$.coins,perks:$.perks,unlocked_sets:Object.fromEntries(Object.entries($.unlockedSets).map((([e,t])=>[e,Array.from(t)]))),unlocked_levels:Object.fromEntries(Object.entries($.unlockedLevels).map((([e,t])=>[e,Array.from(t)]))),perfect_levels:Array.from($.perfectLevels),completed_levels:Array.from($.completedLevels)};p.from("game_progress").update(e).eq("user_id",currentUser.id).then((({error:e})=>{}))}else localStorage.setItem("simploxProgress",JSON.stringify({unlockedSets:Object.fromEntries(Object.entries($.unlockedSets).map((([e,t])=>[e,Array.from(t)]))),unlockedLevels:Object.fromEntries(Object.entries($.unlockedLevels).map((([e,t])=>[e,Array.from(t)]))),perfectLevels:Array.from($.perfectLevels),completedLevels:Array.from($.completedLevels),coins:$.coins,perks:$.perks}))}function R(){const e=localStorage.getItem("simploxProgress");if(e){const t=JSON.parse(e);$.unlockedSets=Object.fromEntries(Object.entries(t.unlockedSets).map((([e,t])=>[e,new Set(t)]))),$.unlockedLevels=Object.fromEntries(Object.entries(t.unlockedLevels).map((([e,t])=>[e,new Set(t)]))),$.perfectLevels=new Set(t.perfectLevels),$.completedLevels=new Set(t.completedLevels||[]),$.coins=t.coins,$.perks=t.perks||{timeFreeze:0,skip:0,clue:0,reveal:0}}const t=localStorage.getItem("simploxCustomCoins");t&&($.coins=parseInt(t))}async function C(){try{const{error:e}=await p.auth.signOut();currentUser=null,_(),Z("welcome-screen"),S()}catch(e){}}function O(e){W(),U.currentIndex>=U.words.length||(U.initialTimeRemaining?F=U.initialTimeRemaining:(U.initialTimeRemaining=10*U.words.length,F=U.initialTimeRemaining,U.totalTime=F),U.questionStartTime=Date.now(),j(),_e(F,U.totalTime),N=setInterval((()=>{D||(F=Math.max(0,F-1),j(),_e(F,U.totalTime),U.initialTimeRemaining=F,F<=10&&document.querySelector(".timer-value").classList.add("warning"),F<=0&&V())}),1e3))}function j(){const e=Math.floor(F/60),t=F%60,n=document.querySelector(".timer-value");n.textContent=`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`,F<=10?n.classList.add("warning"):n.classList.remove("warning")}function W(){N&&(clearInterval(N),N=null),F=0,D=!1;const e=document.querySelector(".timer-progress");e&&e.classList.remove("warning"),_e(0,1)}function G(e,t){const n=window.matchMedia("(max-width: 768px)").matches?{count:10,size:6,distance:50,opacity:.7,duration:1e3}:{count:40,size:10,distance:150,opacity:1,duration:1500},s=["#ffd700","#FFA500","#4CAF50","#FFD700"],r=document.body;for(let o=0;o<n.count;o++){const o=document.createElement("div");o.className="particle",o.style.backgroundColor=s[Math.floor(Math.random()*s.length)],o.style.position="fixed",o.style.left=`${e}px`,o.style.top=`${t}px`;const a=Math.random()*Math.PI*2,i=n.distance+50*Math.random();o.style.width=`${n.size}px`,o.style.height=`${n.size}px`,o.style.opacity=`${n.opacity}`,o.style.setProperty("--x",Math.cos(a)*i+"px"),o.style.setProperty("--y",Math.sin(a)*i+"px"),o.style.animation=`particleBurst ${n.duration/1e3}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`,r.appendChild(o),setTimeout((()=>{r.removeChild(o)}),n.duration)}}function J(e,t,n){if(!e)return;if((t=parseFloat(t)||0)===(n=parseFloat(n)||0))return void(e.textContent=n);const s=1e3/(1e3/60),r=(n-t)/s;let o=0,a=t;e.classList.add("animating");const i=function(){o++,a+=r,o<=s&&(r>0&&a<n||r<0&&a>n)?(e.textContent=Math.round(a),r>0?e.style.color="var(--success)":r<0&&(e.style.color="var(--error)"),requestAnimationFrame(i)):(e.textContent=n,setTimeout((()=>{e.style.color="var(--text)",e.classList.remove("animating")}),300))};requestAnimationFrame(i)}const Y=1e4;function X(e){const t=Date.now();if(t-ds<1e4){const t=Bt.participants.findIndex((t=>t.username===e.username));return void(-1!==t?Bt.participants[t]={...Bt.participants[t],...e}:Bt.participants.push({username:e.username,wordsCompleted:e.wordsCompleted||0,coins:e.coins||0}))}ds=t;const n={},s={};document.querySelectorAll(".leaderboard-entry").forEach((e=>{const t=e.querySelector("[data-username]")?.dataset.username;if(t){n[t]=e.getBoundingClientRect();const r=e.querySelector("[data-words]"),o=e.querySelector("[data-coins]");s[t]={words:r?parseInt(r.textContent):0,coins:o?parseInt(o.textContent):0}}}));const r=Bt.participants.findIndex((t=>t.username===e.username));-1!==r?Bt.participants[r]={...Bt.participants[r],...e}:Bt.participants.push({username:e.username,wordsCompleted:e.wordsCompleted||0,coins:e.coins||0});const o=[...Bt.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)).map(((e,t)=>`\n    <div class="leaderboard-entry ${t<3?`rank-${t+1}`:""}"\n         data-rank="${t+1}">\n      <div>${t+1}</div>\n      <div data-username="${e.username}">${e.username}</div>\n      <div data-words="${e.wordsCompleted||0}">${e.wordsCompleted||0}</div>\n      <div data-coins="${e.coins||0}">${e.coins||0}</div>\n    </div>\n  `)).join(""),a=document.getElementById("arcade-leaderboard");if(a){const e=a.querySelector(".leaderboard-header");a.innerHTML=e?e.outerHTML+o:o,a.querySelectorAll(".leaderboard-entry").forEach((e=>{const t=e.querySelector("[data-username]")?.dataset.username;if(t&&n[t]){const r=n[t],o=e.getBoundingClientRect(),a=r.top-o.top;if(a>0?e.classList.add("moving-up"):a<0&&e.classList.add("moving-down"),s[t]){const n=e.querySelector("[data-words]"),r=e.querySelector("[data-coins]");n&&s[t].words!==parseInt(n.textContent)&&J(n,s[t].words,parseInt(n.textContent)),r&&s[t].coins!==parseInt(r.textContent)&&J(r,s[t].coins,parseInt(r.textContent))}e.addEventListener("animationend",(()=>{e.classList.remove("moving-up","moving-down")}),{once:!0})}}))}sn(),wo()}function J(e,t,n){if(!e)return;if((t=parseFloat(t)||0)===(n=parseFloat(n)||0))return void(e.textContent=n);const s=1e3/(1e3/60),r=(n-t)/s;let o=0,a=t;e.classList.add("animating");const i=function(){o++,a+=r,o<=s&&(r>0&&a<n||r<0&&a>n)?(e.textContent=Math.round(a),r>0?e.style.color="var(--success)":r<0&&(e.style.color="var(--error)"),requestAnimationFrame(i)):(e.textContent=n,setTimeout((()=>{e.style.color="var(--text)",e.classList.remove("animating")}),300))};requestAnimationFrame(i)}function V(){U.currentIndex>=U.words.length||(W(),Rs())}function Z(e,t=!1){"upgrade-screen"!==e||currentUser||(e="welcome-screen",setTimeout((()=>{Sn(),setTimeout((()=>{const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))}),100)}),200)),"welcome-screen"===e&&localStorage.removeItem("gameContext"),"leaderboard-screen"===document.querySelector(".screen.visible")?.id&&qt();const n=document.querySelector(".screen.visible");if(n&&"question-screen"===n.id&&(W(),D=!1),t&&"welcome-screen"===e)return I(),void window.location.reload(!0);["question-screen","custom-practice-screen","moderator-screen","leaderboard-screen"].includes(e)&&Po(),document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible");const t=e.querySelector(".particle-container");t&&t.remove()}));const s=document.getElementById(e);if(s)switch(s.classList.add("visible"),Ie(s),ve(),e){case"question-screen":B(),setTimeout((()=>{ae()}),100),$.extendedPerks&&!U.isArcadeMode&&(Ko(),setTimeout(ea,100));break;case"welcome-screen":xt()&&Be();break;case"stage-cascade-screen":return Ys()}}function Q(e){$.currentSet=e,L();const t=document.getElementById("level-container");if(!t)return;t.innerHTML="";const n=M.stages[$.currentStage-1];if(!n)return;const s=document.createElement("div");s.className="level-header";const r=n.levelsPerSet;let o=0;for(let t=1;t<=r;t++){const n=`${$.currentStage}_${e}_${t}`;$.perfectLevels.has(n)?o++:$.completedLevels.has(n)&&o++}const a=Math.round(o/r*100),i=K($.currentStage,e),c=ee($.currentStage,e);s.innerHTML=`\n        <div class="level-title-area">\n            <div class="set-icon">\n                <i class="${i}"></i>\n            </div>\n            <div class="set-details">\n                <div class="set-name">Stage ${$.currentStage} - Set ${e}</div>\n                <div class="set-desc">${c}</div>\n            </div>\n        </div>\n        <div class="set-progress">\n            <div class="progress-bar">\n                <div class="progress-fill" style="width: ${a}%"></div>\n            </div>\n            <div class="progress-text">${o}/${r} levels</div>\n        </div>\n    `,t.appendChild(s);const l=document.createElement("div");l.className="level-grid";const d=[3,6,9,10,13,16,19,20],u=`${$.currentStage}_${e}`;$.unlockedLevels[u]||($.unlockedLevels[u]=new Set([1]));for(let t=1;t<=n.levelsPerSet;t++){const s=document.createElement("div"),r=`${$.currentStage}_${e}_${t}`,o=$.unlockedLevels[u]?.has(t),a=$.perfectLevels.has(r),i=$.completedLevels.has(r),c=t===n.bossLevel,m=d.includes(t);s.className="level-item",o&&s.classList.add("unlocked"),a?s.classList.add("perfect"):i&&s.classList.add("completed"),c&&s.classList.add("boss"),m&&s.classList.add("test"),o||s.classList.add("locked"),s.textContent=t,o&&(s.onclick=()=>oe(t)),l.appendChild(s)}t.appendChild(l);const m=document.createElement("div");m.className="level-type-legend",m.innerHTML='\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--accent), rgba(30, 144, 255, 0.7));"></div>\n            <span>Normal</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--success), #45b649);"></div>\n            <span>Completed</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--gold), #FFA500);"></div>\n            <span>Perfect</span>\n        </div>\n        <div class="legend-item">\n            <div class="legend-color" style="background: linear-gradient(135deg, var(--gold), var(--accent));"></div>\n            <span>Boss</span>\n        </div>\n    ',t.appendChild(m),Z("level-screen")}function K(e,t){const n=["fas fa-book-open","fas fa-book-reader","fas fa-bookmark","fas fa-pencil-alt","fas fa-pen"];return 1===t?{1:"fas fa-book",2:"fas fa-graduation-cap",3:"fas fa-school",4:"fas fa-university",5:"fas fa-brain"}[e]||"fas fa-star":n[(t-2)%n.length]||"fas fa-star"}function ee(e,t){return`${{1:"Beginner",2:"Elementary",3:"Intermediate",4:"Advanced",5:"Expert"}[e]||"Advanced"} vocabulary - Group ${t}`}function te(e,t){const n=t.words.length,s=n-50;if(!t.randomIndices){t.randomIndices=Array.from({length:n},((e,t)=>t));for(let e=t.randomIndices.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t.randomIndices[e],t.randomIndices[n]]=[t.randomIndices[n],t.randomIndices[e]]}}if(21===e)return{startIndex:0,count:n,isBossLevel:!0,speedChallenge:!0,mixed:!0,isTestLevel:!0,isHebrewToEnglish:Math.random()<.5,testLevels:[],randomIndices:t.randomIndices};if(1===e||2===e){const n=3*(e-1);return{startIndex:n,count:3,testLevels:[3,10,21],randomIndices:t.randomIndices.slice(n,n+3)}}if(3===e)return{startIndex:0,count:6,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(0,6)};if(4===e||5===e){const n=6+3*(e-4);return{startIndex:n,count:3,testLevels:[6,10,21],randomIndices:t.randomIndices.slice(n,n+3)}}if(6===e)return{startIndex:6,count:6,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(6,12)};if(7===e||8===e){const n=12+4*(e-7);return{startIndex:n,count:4,testLevels:[9,10,21],randomIndices:t.randomIndices.slice(n,n+4)}}if(9===e)return{startIndex:12,count:8,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(12,20)};if(10===e)return{startIndex:0,count:20,isTestLevel:!0,speedChallenge:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(0,20)};if(11===e||12===e){const n=20+4*(e-11);return{startIndex:n,count:4,testLevels:[13,20,21],randomIndices:t.randomIndices.slice(n,n+4)}}if(13===e)return{startIndex:20,count:8,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(20,28)};if(14===e||15===e){const n=14===e?5:6,s=28+(14===e?0:5);return{startIndex:s,count:n,testLevels:[16,20,21],randomIndices:t.randomIndices.slice(s,s+n)}}if(16===e)return{startIndex:28,count:11,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(28,39)};if(17===e||18===e){const n=17===e?5:6,r=n+(s>0?s:0),o=39+(17===e?0:n);return{startIndex:o,count:r,testLevels:[19,20,21],randomIndices:t.randomIndices.slice(o,o+r)}}return 19===e?{startIndex:39,count:11,isTestLevel:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(39,50)}:20===e?{startIndex:20,count:30,isTestLevel:!0,speedChallenge:!0,mixed:!0,isHebrewToEnglish:Math.random()<.5,randomIndices:t.randomIndices.slice(20,50)}:void 0}function ne(e){return $.usedWords||($.usedWords=new Set),e.words.map(((e,t)=>t)).filter((e=>!$.usedWords.has(e)))}function se(e,t){const n=new Set;for(;n.size<t&&e.length>n.size;){const t=Math.floor(Math.random()*e.length);n.add(e[t]),$.usedWords.add(e[t])}return Array.from(n)}function re(e,t){const n=new Set([e]),s=t.translations;for(;n.size<3;){const e=s[Math.floor(Math.random()*s.length)];n.add(e)}return Array.from(n).sort((()=>Math.random()-.5))}function oe(e){$.currentLevel=e;const t={stage:$.currentStage,set:$.currentSet,level:e,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(t)),U.wrongStreak=0,U.correctAnswers=0,U.levelStartTime=Date.now(),U.firstAttempt=!0,U.streakBonus=!0,$.extendedPerks||No(),B(),Ko();$.currentStage,$.currentSet;const n=document.querySelector(".perks-container"),s=document.querySelector(".powerups-container");n&&(n.style.display="flex"),s&&(s.style.display="none");const r=document.querySelector(".coin-count");r&&(r.textContent=$.coins||0,r.style.display="block");const o=document.querySelector(".coins-container");o&&(o.style.display="flex"),$.currentStage=$.currentStage||1,$.currentSet=$.currentSet||1,$.currentLevel=e,ae();const a=currentUser?currentUser.status:"unregistered";if([2,7,11,15,20].includes(e)&&"premium"!==a){const t=e;if(!currentUser)return at((()=>{ce(t)}));if(!localStorage.getItem(`upgradeRequested_${currentUser.id}`))return tt((()=>{ce(t)}))}21===e?(U.isBossLevel=!0,setTimeout(Ir,100),setTimeout(Ir,500)):U.isBossLevel=!1;ce(e,21===e||1===e),setTimeout(ea,300)}function ae(){const e=document.getElementById("admin-test-button");if(e&&e.remove(),!currentUser||"admin123@gmail.com"!==currentUser.email&&!currentUser.email?.includes("admin123"))return;const t=document.createElement("button");t.id="admin-test-button",t.textContent="Jump to Level 20",t.style.cssText="\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: #ff5722;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 2000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    font-weight: bold;\n  ",t.onclick=function(){$.currentLevel=21,oe(21)},document.body.appendChild(t)}function ie(){const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);if(t.stage&&t.set&&t.level)return{stage:t.stage,set:t.set,level:t.level}}catch(e){}return $.currentStage&&$.currentSet&&$.currentLevel?{stage:$.currentStage,set:$.currentSet,level:$.currentLevel}:{stage:1,set:1,level:1}}function ce(e,t=!1){U.restartsRemaining=U.restartsRemaining||2,$.currentLevel=e;const n=`${$.currentStage}_${$.currentSet}`,s=vocabularySets[n],r=document.querySelector(".coin-count");r&&(r.textContent=$.coins||0,r.style.display="block"),U.startingCoins=$.coins,U.startingPerks={...$.perks},U.timeBonus=0,U.initialTimeRemaining=null,U.streakBonus=!0,U.levelStartTime=Date.now(),De(e,(()=>{le(te(e,s),s),Z("question-screen"),ae(),21===e?(Rn(),setTimeout(Ir,200),Yn()):(me(),pe()),setTimeout((()=>{O(U.words.length)}),200)}),t)}function ce(e){U.restartsRemaining||(U.restartsRemaining=2),$.currentLevel=e;const t=`${$.currentStage}_${$.currentSet}`,n=vocabularySets[t],s=document.querySelector(".coin-count");s&&(s.textContent=$.coins||0,s.style.display="block"),U.startingCoins=$.coins,U.startingPerks={...$.perks},U.timeBonus=0,U.initialTimeRemaining=null,U.streakBonus=!0,U.levelStartTime=Date.now(),De(e,(()=>{le(te(e,n),n),Z("question-screen"),me(),pe(),setTimeout((()=>{O(U.words.length)}),200)}))}function le(e,t){if("object"==typeof e)if(e.randomIndices){const n=e.randomIndices.map((e=>t.words[e])),s=e.randomIndices.map((e=>t.translations[e]));Object.assign(U,{words:n,translations:s,currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:e.isHebrewToEnglish||!1,mixed:e.mixed||!1,speedChallenge:e.speedChallenge||!1,isBossLevel:e.isBossLevel||!1})}else{const{startIndex:n,count:s,isHebrewToEnglish:r,mixed:o,speedChallenge:a,isBossLevel:i}=e;Object.assign(U,{words:t.words.slice(n,n+s),translations:t.translations.slice(n,n+s),currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:r||!1,mixed:o||!1,speedChallenge:a||!1,isBossLevel:i||!1})}else Object.assign(U,{words:t.words.slice(0,e),translations:t.translations.slice(0,e),currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,isBossLevel:!1})}function de(){U.isBossLevel&&!U.bossRewardApplied&&(U.bossRewardApplied=!0);const e=M.stages[$.currentStage-1],t=$.currentLevel===e.levelsPerSet,n=$.currentSet===e.numSets,s=currentUser?currentUser.status:"unregistered";if(t){if($.currentStage>=2&&1===$.currentSet&&"premium"!==s)return localStorage.setItem("completedTrialStage",$.currentStage),Z("welcome-screen"),void setTimeout((()=>{tt()}),500);n?$.currentStage<5?($.currentStage++,$.currentSet=1,oe(1)):Z("stage-screen"):($.currentSet++,oe(1))}else oe($.currentLevel+1)}function ue(e){if(["stage-screen","set-screen","level-screen","question-screen"].includes(e)){const t=document.createElement("div");t.className="screen-nav";const n=document.createElement("button");if(n.className="home-button",n.innerHTML='<i class="fas fa-home"></i>',n.onclick=()=>Z("welcome-screen"),t.appendChild(n),"stage-screen"!==e){const n=document.createElement("button");switch(n.className="back-button",n.innerHTML='<i class="fas fa-arrow-left"></i>',e){case"set-screen":n.onclick=()=>Z("stage-screen");break;case"level-screen":n.onclick=()=>ot($.currentStage);break;case"question-screen":n.onclick=()=>qe()}t.appendChild(n)}document.getElementById(e).appendChild(t)}}function me(){const e=document.querySelector(".progress-circle .progress"),t=2*Math.PI*54,n=U.currentIndex/U.words.length;if(e.style.strokeDasharray=`${t} ${t}`,e.style.strokeDashoffset=t*(1-n),n<=.25){const t=Math.floor(4*n*30);e.style.stroke=`hsl(${t}, 100%, 45%)`}else if(n<=.5){const t=30+Math.floor(4*(n-.25)*40);e.style.stroke=`hsl(${t}, 100%, 45%)`}else if(n<=.75){const t=70+Math.floor(4*(n-.5)*40);e.style.stroke=`hsl(${t}, 100%, 40%)`}else{const t=110+Math.floor(4*(n-.75)*30);e.style.stroke=`hsl(${t}, 100%, 40%)`}}function pe(){if(document.querySelectorAll(".buttons button").forEach((e=>{e.classList.remove("correct","wrong")})),U.currentIndex>=U.words.length)return;const e=document.getElementById("question-word"),t=[3,6,9,10,13,16,19,20,21].includes($.currentLevel)&&Math.random()<.5,n=U.currentIndex,s=t?U.translations[n]:U.words[n],r=t?U.words[n]:U.translations[n],o=t?U.words:U.translations,a=new Set([r]);for(;a.size<3;){const e=o[Math.floor(Math.random()*o.length)];e!==r&&a.add(e)}const i=document.getElementById("buttons");i.innerHTML="";Array.from(a).sort((()=>Math.random()-.5)).forEach((e=>{const t=document.createElement("button");t.textContent=e,t.onclick=()=>cn(e===r),i.appendChild(t)})),U.currentIndex>0?(e.classList.add("exiting"),setTimeout((()=>{e.textContent=s,e.classList.remove("exiting"),e.classList.add("entering"),setTimeout((()=>{e.classList.remove("entering")}),500)}),500)):(e.textContent=s,e.classList.add("entering"),setTimeout((()=>{e.classList.remove("entering")}),500))}function fe(){Fr()}function ge(){if(!currentUser||"admin123@gmail.com"!==currentUser.email)return;const e=document.getElementById("question-screen");if(document.getElementById("admin-test-button"))return;const t=document.createElement("button");t.id="admin-test-button",t.innerHTML="Jump to Level 20",t.style.cssText="\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: #ff5722;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 1000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n  ",t.onclick=function(){$.currentLevel=20,oe(20)},e.appendChild(t)}function ye(){const e=(Date.now()-U.questionStartTime)/1e3;if(e<10){const t=Math.floor(10-e);return U.timeBonus+=t,t}return 0}function he(e=1){document.querySelectorAll(".coin-icon").forEach((t=>{let n=0;const s=()=>{t.classList.add("coin-pulse"),setTimeout((()=>{t.classList.remove("coin-pulse"),n++,n<e&&setTimeout(s,100)}),500)};s()}))}function ve(){document.querySelectorAll(".coin-count").forEach((e=>{const t=parseInt(e.textContent)||0;let n;n=window.location.pathname.includes("arcade")?U.coins||0:$.coins||0;qn(e,Number(t),Number(n))})),Go()}function we(){const e=document.querySelectorAll(".buttons button"),t=U.isHebrewToEnglish?U.words[U.currentIndex]:U.translations[U.currentIndex],n=Array.from(e).filter((e=>e.textContent!==t));if(n.length>0){const e=n[Math.floor(Math.random()*n.length)];e.disabled=!0,e.style.opacity="0.5"}}function be(){const e=U.isHebrewToEnglish?U.words[U.currentIndex]:U.translations[U.currentIndex];document.querySelectorAll(".buttons button").forEach((t=>{t.textContent===e?(t.classList.add("correct"),setTimeout((()=>{U.isCustomPractice?Hs(!0):cn(!0)}),1e3)):(t.disabled=!0,t.style.opacity="0.5")}))}function P(e){const t=A[e];if(t)if($.coins<t.cost)Tn(`Need ${t.cost} coins!`,"error");else{switch($.coins-=t.cost,ve(),e){case"timeFreeze":D=!0,setTimeout((()=>{D=!1}),t.duration);break;case"skip":U.isCustomPractice?Hs(!0,!0):cn(!0,!0);break;case"clue":const e=document.querySelectorAll(".buttons button"),n=U.isHebrewToEnglish?U.words[U.currentIndex]:U.translations[U.currentIndex],s=Array.from(e).filter((e=>e.textContent!==n));if(s.length>0){const e=s[Math.floor(Math.random()*s.length)];e.disabled=!0,e.style.opacity="0.5"}break;case"reveal":be()}I()}}function Se(e,t,n){if(!e)return;const s=(n-t)/20;let r=0,o=t;requestAnimationFrame((function t(){r++,o+=s,r<=20?(e.textContent=Math.round(o),requestAnimationFrame(t)):e.textContent=n}))}function ke(){if(W(),U.isBossLevel)return void(U.bossRewardApplied?(Xn(),Fr()):(Xn(),U.bossRewardApplied=!0,Fr()));const e=`${$.currentStage}_${$.currentSet}_${$.currentLevel}`,t=$.perfectLevels.has(e)||$.completedLevels.has(e),n=U.streakBonus&&U.correctAnswers===U.words.length;if(!t&&n){const e=5;r.updateCoins(e).then((()=>{Ue($.currentStage,$.currentSet,$.currentLevel,!0,!0);const e=document.getElementById("question-screen").getBoundingClientRect();G(e.left+e.width/2,e.top+e.height/2)}))}else t||Ue($.currentStage,$.currentSet,$.currentLevel,!0,!1);he(5),B();const s=M.stages[$.currentStage-1],o=$.currentLevel===s.levelsPerSet,a=$.currentSet===s.numSets,i=currentUser?currentUser.status:"unregistered";o?(xe($.currentStage,$.currentSet),a?"premium"===i&&$.currentStage<5?setTimeout((()=>{$.currentStage++,$.currentSet=1,$.currentLevel=1,oe(1)}),1500):setTimeout((()=>Z("stage-cascade-screen")),1500):setTimeout((()=>{$.currentSet++,$.currentLevel=1,oe(1)}),1500)):setTimeout((()=>{$.currentLevel++,oe($.currentLevel)}),1500)}function xe(e,t){const n=M.stages[e-1].levelsPerSet;let s=0;for(let r=1;r<=n;r++){const n=`${e}_${t}_${r}`;($.completedLevels.has(n)||$.perfectLevels.has(n))&&s++}s===n&&Ne()}function Le(e){const t=`${$.currentStage}_${$.currentSet}`;$.unlockedLevels[t]||($.unlockedLevels[t]=new Set),$.unlockedLevels[t].add($.currentLevel);const n=M.stages[$.currentStage-1],s=$.currentLevel===n.levelsPerSet,r=$.currentSet===n.numSets;s?r?$.currentStage<5&&Fe():Ne():$.unlockedLevels[t].add($.currentLevel+1),I(),ve(),setTimeout((()=>{s?r?$.currentStage<5?($.currentStage++,$.currentSet=1,oe(1)):Z("stage-screen"):($.currentSet++,oe(1)):oe($.currentLevel+1)}),1500)}function Ce(){const e=document.getElementById("question-screen").getBoundingClientRect(),t=e.left+e.width/2,n=e.top+e.height/2;for(let e=0;e<5;e++)setTimeout((()=>G(t,n)),300*e)}function Ee(e,t){const n=powerupCooldowns.get(e)||0,s=Date.now();s-n<5e3?Tn("Perk is on cooldown","warning"):r.updateCoins(-t).then((t=>{t?($.perks[e]++,I(),B(),usePerk(e),powerupCooldowns.set(e,s),Tn(`${e} activated!`,"success")):Tn("Not enough coins","error")})).catch((e=>{Tn("Failed to activate perk","error")}))}function Ie(e=document.body){e instanceof HTMLElement||(e=document.body);let t=e.querySelector(".particle-container");t||(t=document.createElement("div"),t.classList.add("particle-container"),e.appendChild(t));const n=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",..."ΑΒΓΔΕΖΗΘΙΚΛΜΝΞΟΠΡΣΤΥΦΧΨΩαβγδεζηθικλμνξοπρστυφχψω",..."אבגדהוזחטיכלמנסעפצקרשת"];function s(){const s=document.createElement("div");s.classList.add("letter-particle"),s.textContent=n[Math.floor(Math.random()*n.length)];const r=Math.random()*e.clientWidth,o=Math.random()*e.clientHeight,a=200*Math.random()-100,i=200*Math.random()-100,c=12+16*Math.random(),l=.2+.3*Math.random(),d=180*Math.random(),u=8+10*Math.random();s.style.cssText=`\n            position: absolute;\n            left: ${r}px;\n            top: ${o}px;\n            font-size: ${c}px;\n            animation: letterFloat ${u}s ease-in-out forwards;\n            --moveX: ${a}px;\n            --moveY: ${i}px;\n            --opacity: ${l};\n            --rotate: ${d}deg;\n            pointer-events: none;\n        `,t.appendChild(s),setTimeout((()=>{t.removeChild(s)}),1e3*u)}for(let e=0;e<50;e++)s();const r=setInterval(s,1e3);t.dataset.intervalId=r}function qe(){W(),D=!1;const e=document.createElement("div");e.className="simple-level-transition",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center";for(let t=0;t<3;t++){const n=document.createElement("div");n.className="light-streak",n.style.top=20+25*t+"%",n.style.animationDelay=.2*t+"s",e.appendChild(n)}const t=document.createElement("div");t.className="level-announcement simple",t.style.position="relative",t.innerHTML='\n    <div class="level-number">\n      <i class="fas fa-check-circle" style="color: var(--gold); font-size: 2rem;"></i>\n    </div>\n    <div class="level-text">Session Complete</div>\n  ',e.appendChild(t),document.body.appendChild(e),$.sessionStartTime=null,U={words:[],translations:[],currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!1,mixed:!1,speedChallenge:!1,timeBonus:0,initialTimeRemaining:null,streakBonus:!0,restartsRemaining:null},setTimeout((()=>{e.classList.add("fade-out"),setTimeout((()=>{document.body.removeChild(e),Z("welcome-screen")}),300)}),1200)}function Te(){W();const e=document.querySelector(".failure-overlay");e.querySelector(".failure-title").textContent="Game Over!",e.style.display="flex",setTimeout((()=>{e.classList.add("show")}),100),document.querySelector(".restart-button").onclick=()=>{e.classList.remove("show"),setTimeout((()=>{e.style.display="none",U.isCustomPractice?mo(U.practiceState.currentLevel,U.practiceState):oe($.currentLevel)}),1e3)},document.querySelector(".home-button").onclick=()=>{e.classList.remove("show"),setTimeout((()=>{e.style.display="none",Z("welcome-screen")}),1e3)}}function _e(e,t){const n=document.querySelector(".timer-progress");if(!n)return;const s=2*Math.PI*40;n.style.strokeDasharray=`${s} ${s}`;const r=s*(1-e/t);n.style.strokeDashoffset=r,e<=10?n.classList.add("warning"):n.classList.remove("warning")}function Me(){if(!H)return $.currentStage=1,$.currentSet=1,$.currentLevel=1,$.coins=0,$.unlockedSets={1:new Set([1])},$.unlockedLevels={"1_1":new Set([1])},$.perfectLevels=new Set,$.completedLevels=new Set,localStorage.removeItem("simploxProgress"),localStorage.removeItem("simploxCustomCoins"),B(),ve(),Z("welcome-screen"),void(H=!0);const e=document.querySelector(".reset-button");e.classList.add("warning"),H=!1,setTimeout((()=>{e.classList.remove("warning")}),1e3),z&&clearTimeout(z),z=setTimeout((()=>{H=!0}),1e4)}function $e(){const e=document.documentElement,t=document.querySelector(".vertical-nav-container .fullscreen-button i");document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().then((()=>{t&&(t.classList.remove("fa-compress"),t.classList.add("fa-expand"))})).catch((e=>{})):e.requestFullscreen&&e.requestFullscreen().then((()=>{t&&(t.classList.remove("fa-expand"),t.classList.add("fa-compress"))})).catch((e=>{}))}async function C(){try{const{error:e}=await p.auth.signOut();currentUser=null,_(),Z("welcome-screen"),S()}catch(e){}}function Ae(){if(U.restartsRemaining<=0)return;const e=document.querySelector(".navigation-button.restart-level");U.restartsRemaining--,1===U.restartsRemaining?e.style.opacity="0.7":0===U.restartsRemaining&&(e.classList.add("disabled"),e.onclick=null,e.disabled=!0),$.coins=U.startingCoins,$.perks={...U.startingPerks},B(),ve(),I(),oe($.currentLevel)}function Pe(){Z("stage-screen")}function ie(){const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);if(t.stage&&t.set&&t.level)return{stage:t.stage,set:t.set,level:t.level}}catch(e){}const t=parseInt(localStorage.getItem("preferredStage"));let n=null,s=-1;const r=(e,t,n)=>{const s=`${e}_${t}_${n}`,r=`${e}_${t}`,o=$.unlockedLevels[r]?.has(n),a=!$.completedLevels.has(s)&&!$.perfectLevels.has(s);return o&&a};if(t&&t>=1&&t<=5)for(let e=1;e<=M.stages[t-1].numSets;e++){const o=`${t}_${e}`;if(!$.unlockedLevels[o])continue;const a=Array.from($.unlockedLevels[o]).sort(((e,t)=>t-e));for(let o of a)if(r(t,e,o)){const r=calculateRank(t,e,o);r>s&&(s=r,n={stage:t,set:e,level:o})}}if(!n)for(let e=1;e<=5;e++){if(!$.unlockedSets[e])continue;const t=Array.from($.unlockedSets[e]).sort(((e,t)=>t-e));for(let o of t){const t=`${e}_${o}`;if(!$.unlockedLevels[t])continue;const a=Array.from($.unlockedLevels[t]).sort(((e,t)=>t-e));for(let t of a)if(r(e,o,t)){const r=calculateRank(e,o,t);r>s&&(s=r,n={stage:e,set:o,level:t})}}}return n||(t&&t>=1&&t<=5?{stage:t,set:1,level:1}:{stage:1,set:1,level:1})}function Be(){if(!lr())return void ur();const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);if(t.stage&&t.set&&t.level)return $.currentStage=t.stage,$.currentSet=t.set,$.currentLevel=t.level,void oe($.currentLevel)}catch(e){}$.extendedPerks||No(),oe($.currentLevel)}function Ue(e,t,n,s,r){const o=`${e}_${t}_${n}`;r?($.perfectLevels.add(o),$.completedLevels.add(o)):s&&$.completedLevels.add(o);const a=`${e}_${t}`;$.unlockedLevels[a]||($.unlockedLevels[a]=new Set),$.unlockedLevels[a].add(n);const i=n+1,c=n===M.stages[e-1].levelsPerSet;c||$.unlockedLevels[a].add(i),c&&s&&xe(e,t),I()}function xe(e,t){const n=M.stages[e-1].levelsPerSet;let s=0;for(let r=1;r<=n;r++){const n=`${e}_${t}_${r}`;($.completedLevels.has(n)||$.perfectLevels.has(n))&&s++}s===n&&Ne()}function Ne(){const e=$.currentStage,t=$.currentSet,n=M.stages[e-1];if(n)if(t<n.numSets){const n=t+1;$.unlockedSets[e]||($.unlockedSets[e]=new Set),$.unlockedSets[e].add(n);const s=`${e}_${n}`;$.unlockedLevels[s]||($.unlockedLevels[s]=new Set),$.unlockedLevels[s].add(1),I()}else e<5&&Fe()}function Fe(){const e=$.currentStage;if(e<5){const t=e+1;$.unlockedSets[t]||($.unlockedSets[t]=new Set),$.unlockedSets[t].add(1);const n=`${t}_1`;$.unlockedLevels[n]||($.unlockedLevels[n]=new Set),$.unlockedLevels[n].add(1),I()}}function De(e,t,n=!1){if(!(!$.sessionStartTime||Date.now()-$.sessionStartTime>18e5||n)){const n=document.createElement("div");n.className="simple-level-transition",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center";for(let e=0;e<3;e++){const t=document.createElement("div");t.className="light-streak",t.style.top=20+25*e+"%",t.style.animationDelay=.2*e+"s",n.appendChild(t)}const s=document.createElement("div");s.className="level-announcement simple",s.style.position="relative";const r=document.createElement("div");return r.className="transition-progress",U&&U.isCustomPractice?U.mixed?s.innerHTML='\n          <div class="level-number">Test</div>\n          <div class="level-text">Review Challenge</div>\n        ':s.innerHTML=`\n          <div class="level-number">Round ${e}</div>\n          <div class="level-text">Custom Practice</div>\n        `:s.innerHTML=`\n        <div class="level-number">${e}</div>\n        <div class="level-text">Stage ${$.currentStage} - Set ${$.currentSet}</div>\n      `,s.appendChild(r),n.appendChild(s),document.body.appendChild(n),setTimeout((()=>{r.style.width="100%"}),50),void setTimeout((()=>{n.classList.add("fade-out"),setTimeout((()=>{t(),document.body.removeChild(n)}),300)}),800)}const s=[3,6,9,10,13,16,19,20].includes(e),r=21===e;let o="normal-level";s&&(o="test-level"),r&&(o="boss-level");const a=document.createElement("div");a.className="level-transition",U&&U.isCustomPractice?U.mixed?a.innerHTML=`\n        <div class="level-announcement ${o}">\n          <h1>Test Challenge</h1>\n          <h2>Combined Words Review</h2>\n          <div class="test-badge">Review Challenge</div>\n        </div>\n      `:a.innerHTML=`\n        <div class="level-announcement ${o}">\n          <h1>Round ${e}</h1>\n          <h2>Custom Practice</h2>\n          ${s?'<div class="test-badge">Review Challenge</div>':""}\n        </div>\n      `:a.innerHTML=`\n      <div class="level-announcement ${o}">\n        <h1>${r?"BOSS FIGHT!":`Stage ${$.currentStage}`}</h1>\n        <h2>${r?"FINAL CHALLENGE":`Level ${$.currentSet}-${e}`}</h2>\n        ${s?'<div class="test-badge">Review Challenge</div>':""}\n        ${r?'<div class="boss-badge">DANGER ZONE</div>':""}\n      </div>\n    `,document.body.appendChild(a);const i=a.querySelector(".level-announcement");if(a.offsetHeight,a.classList.add("show"),i.classList.add("show"),r){const e=a.querySelector(".level-announcement");if(e){e.style.background="linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)",e.style.boxShadow="0 0 30px rgba(255, 0, 0, 0.5)";const t=e.querySelector("h1");t&&(t.style.color="#ffffff",t.style.textShadow="0 0 20px rgba(255, 0, 0, 0.8)")}}setTimeout((()=>{t(),a.classList.remove("show"),i.classList.remove("show"),setTimeout((()=>{document.body.removeChild(a)}),400)}),1500)}document.addEventListener("DOMContentLoaded",(function(){document.getElementById("question-screen").classList.contains("visible")&&ae(),setTimeout((()=>{currentUser&&"admin123@gmail.com"===currentUser.email&&ae()}),2e3)})),document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".home-button").forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault(),Z("welcome-screen",!0)}))}))})),document.addEventListener("fullscreenchange",(function(){document.fullscreenElement})),document.querySelector(".perks-container").innerHTML=`\n    ${Object.entries(A).map((([e,t])=>`\n        <button class="perk-button" id="${e}Perk" onclick="buyPerk('${e}')">\n            <i class="fas ${t.icon} perk-icon"></i>\n            <span class="perk-count">0</span>\n        </button>\n    `)).join("")}\n`,window.onload=async()=>{await _t(),S(),B();Ie(document.getElementById("welcome-screen")),await po()};const ze={lists:[],currentList:null,maxLists:5};function He(e=null){if(ze.lists.length>=ze.maxLists)return alert(`You can only create up to ${ze.maxLists} custom lists.`),null;e||(e=`List ${ze.lists.length+1}`);const t={id:Date.now(),name:e,words:[],translations:[]};return ze.lists.push(t),saveCustomLists(),t}function Re(e){const t=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(e)}&langpair=en|he`;return fetch(t).then((e=>e.json())).then((t=>t.responseData.translatedText||e)).catch((()=>e))}function Oe(e){const t=`listPlays_${e}`;let n=parseInt(localStorage.getItem(t)||"0");n++;const s=getUserListLimits();return localStorage.setItem(t,n),n>=s.maxPlays?(ao(e),!1):s.maxPlays-n}function je(){const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function We(e){currentUser&&(ze.lists.push({id:e.local_id,supabaseId:e.id,name:e.name,words:e.words,translations:e.translations,is_shared:!0,shared_by:e.shared_by}),saveCustomLists())}async function Ge(e,t){try{if(!Jr.lists.find((t=>String(t.id)===String(e))))return!1;const{data:n,error:s}=await p.from("custom_lists").insert({user_id:t,name:"Shared list",words:["test"],translations:["test"],is_shared:!0});if(s){const{data:e,error:t}=await p.from("information_schema.tables").select("table_name").eq("table_schema","public");return!1}return!0}catch(e){return!1}}async function Je(e,t){try{if(!currentUser)return!1;const n=Jr.lists.find((t=>String(t.id)===String(e)));if(!n)return!1;const{data:s,error:r}=await p.from("custom_lists").insert({user_id:t,name:`${n.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,words:n.words||[],translations:n.translations||[],is_shared:!0,shared_with:[t],shared_by:currentUser.id,created_at:(new Date).toISOString(),status:"active"});return!r&&(Tn("List shared successfully!","success"),Ve(),!0)}catch(e){return Tn("Error sharing list","error"),!1}}function Ye(e){const t=document.createElement("div");t.className="toast success",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("hide"),setTimeout((()=>document.body.removeChild(t)),600)}),3e3)}function Xe(e){const t=document.createElement("div");t.className="toast error",t.textContent=e,document.body.appendChild(t),setTimeout((()=>{t.classList.add("hide"),setTimeout((()=>document.body.removeChild(t)),600)}),3e3)}function Ve(){const e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}async function Ze(){if(!currentUser)return[];const{data:e,error:t}=await p.from("custom_lists").select("*").or(`shared_with.cs.{${currentUser.id}},is_shared.eq.true`);return t?[]:e.map((e=>({...e,isShared:!0})))}function Qe(e){const t=document.querySelector(".share-modal"),n=document.querySelector(".modal-backdrop");t&&t.remove(),n&&n.remove();const s=document.createElement("div");s.className="modal-backdrop",s.onclick=Ve,document.body.appendChild(s);const r=document.createElement("div");r.className="share-modal",r.innerHTML='\n        <h3 class="share-modal-header">Share List</h3>\n        <div class="users-list">Loading users...</div>\n        <button class="start-button modal-close" onclick="closeShareModal()">Cancel</button>\n    ',document.body.appendChild(r);const o=r.querySelector(".users-list");p.from("user_profiles").select("id, username").neq("id",currentUser.id).then((({data:t,error:n})=>{n?o.innerHTML='<div class="user-item"><span>Error loading users</span></div>':t&&0!==t.length?(o.innerHTML=t.map((e=>`\n                <div class="user-item">\n                    <span>${e.username||"Unnamed User"}</span>\n                    <button class="main-button small-button share-with-user-btn" data-user-id="${e.id}">\n    <i class="fas fa-share-alt"></i> Share\n</button>\n                </div>\n            `)).join(""),r.querySelectorAll(".share-with-user-btn").forEach((t=>{t.onclick=async()=>{const n=t.getAttribute("data-user-id");t.disabled=!0;const s=t.innerHTML;t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sharing...';await Je(e,n)||(t.disabled=!1,t.innerHTML=s)}}))):o.innerHTML='<div class="user-item"><span>No other users available</span></div>'}))}function Ve(){const e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}function Ke(e){if(!e&&U.streakBonus){$.coins+=5,he(5);const e=`${$.currentStage}_${$.currentSet}`;$.unlockedLevels[e]||($.unlockedLevels[e]=new Set),$.unlockedLevels[e].add($.currentLevel);const t=M.stages[$.currentStage-1],n=$.currentLevel===t.levelsPerSet,s=$.currentSet===t.numSets;n?s?Z("stage-screen"):($.currentSet++,oe(1)):oe($.currentLevel+1),I()}else oe($.currentLevel)}function et(){const e=document.querySelector(".upgrade-prompt");e&&(e.classList.remove("show"),setTimeout((()=>e.remove()),300))}function tt(e){if(!currentUser)return Sn(),void setTimeout((()=>{const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))}),100);const t={screen:document.querySelector(".screen.visible")?.id,stage:$.currentStage,set:$.currentSet,level:$.currentLevel};t.screen&&localStorage.setItem("gameContext",JSON.stringify(t)),currentUser&&localStorage.removeItem(`upgradeRequested_${currentUser.id}`),Z("upgrade-screen")}function et(){const e=document.querySelector(".upgrade-prompt"),t=document.querySelector(".modal-backdrop");e&&(e.classList.remove("show"),setTimeout((()=>e.remove()),300)),t&&t.remove()}function nt(){D=!1,W(),document.querySelectorAll(".confirmation-popup").forEach((e=>{e&&e.remove()}));const e=document.getElementById("upgrade-screen");e&&e.classList.contains("visible")&&e.classList.remove("visible"),Z("welcome-screen")}function st(){et(),showPaymentScreen()}async function rt(){if(!currentUser)return{fullAccess:!1,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}};const{data:e,error:t}=await p.from("user_profiles").select("status, payment_pending").eq("id",currentUser.id).single();return t?null:e.payment_pending||"free"===e.status||"pending"===e.status?{fullAccess:!1,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}:"premium"===e.status?{fullAccess:!0,unlockedStages:{1:[1],2:[1],3:[1],4:[1],5:[1]},defaultUnlockedLevels:{1:!0}}:void 0}function je(){const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function ot(e){$.currentStage=e,Ys(),setTimeout((()=>{const t=document.querySelector(`.stage-wrapper[data-stage="${e}"]`);t&&!t.classList.contains("open")&&t.classList.add("open")}),100)}function at(e){if(window.unregisteredWarningShown)return void(e&&e());window.unregisteredWarningShown=!0;const t=document.createElement("div");t.className="fullscreen-signup-page",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: var(--gradient);\n        z-index: 2000;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: space-between;\n        padding: 2rem;\n        animation: fadeIn 0.3s ease-in-out;\n    ",t.innerHTML='\n        <div class="signup-header" style="width: 100%; display: flex; justify-content: flex-start; margin-bottom: 2rem;">\n            <button class="skip-signup-button" style="\n                background: rgba(255,255,255,0.15);\n                border: none;\n                color: var(--text);\n                padding: 0.75rem 1.5rem;\n                border-radius: 50px;\n                font-size: 0.9rem;\n                cursor: pointer;\n                transition: all 0.3s ease;\n            ">\n                Skip\n            </button>\n        </div>\n        \n        <div class="signup-content" style="\n            text-align: center;\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            max-width: 600px;\n            width: 100%;\n        ">\n            <h2 style="\n                font-size: 2rem;\n                color: var(--gold);\n                margin-bottom: 1.5rem;\n                animation: floatAnimation 3s ease-in-out infinite;\n            ">Save Your Progress!</h2>\n            \n            <p style="\n                font-size: 1.2rem;\n                line-height: 1.6;\n                margin-bottom: 2rem;\n                color: var(--text);\n            ">Create a free account to track your vocabulary progress, earn rewards, and unlock more advanced content</p>\n            \n            <div class="features-list" style="\n                display: flex;\n                flex-direction: column;\n                gap: 1rem;\n                margin-bottom: 3rem;\n                text-align: left;\n            ">\n                <div class="feature-item" style="\n                    display: flex;\n                    align-items: center;\n                    gap: 1rem;\n                ">\n                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>\n                    <span>Track your learning progress</span>\n                </div>\n                <div class="feature-item" style="\n                    display: flex;\n                    align-items: center;\n                    gap: 1rem;\n                ">\n                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>\n                    <span>Practice custom word lists</span>\n                </div>\n                <div class="feature-item" style="\n                    display: flex;\n                    align-items: center;\n                    gap: 1rem;\n                ">\n                    <i class="fas fa-check-circle" style="color: var(--gold); font-size: 1.5rem;"></i>\n                    <span>Earn coins for premium content</span>\n                </div>\n            </div>\n        </div>\n        \n        <div class="signup-footer" style="\n            width: 100%;\n            display: flex;\n            justify-content: center;\n            padding-bottom: 2rem;\n        ">\n            <button class="signup-now-button" style="\n                background: var(--gold);\n                color: var(--primary-dark);\n                border: none;\n                padding: 1.25rem 3rem;\n                border-radius: 50px;\n                font-size: 1.2rem;\n                font-weight: bold;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);\n                animation: pulseAnimation 1.5s infinite ease-in-out;\n            ">\n                Sign Up Now\n            </button>\n        </div>\n    ',document.body.appendChild(t);const n=document.createElement("style");n.textContent="\n        @keyframes fadeIn {\n            from { opacity: 0; }\n            to { opacity: 1; }\n        }\n        \n        @keyframes floatAnimation {\n            0%, 100% { transform: translateY(0); }\n            50% { transform: translateY(-10px); }\n        }\n        \n        @keyframes pulseAnimation {\n            0%, 100% { transform: scale(1); box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2); }\n            50% { transform: scale(1.05); box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4); }\n        }\n    ",document.head.appendChild(n);const s=t.querySelector(".skip-signup-button"),r=t.querySelector(".signup-now-button");s.addEventListener("click",(function(){document.body.removeChild(t),n.parentNode&&n.parentNode.removeChild(n),e&&e()})),r.addEventListener("click",(function(){document.body.removeChild(t),n.parentNode&&n.parentNode.removeChild(n),Z("welcome-screen"),setTimeout((function(){const e=document.getElementById("authModal");if(e){e.classList.add("show");const t=document.getElementById("signupForm"),n=document.getElementById("loginForm");t&&n&&(t.classList.remove("hidden"),n.classList.add("hidden"))}}),100)}))}function it(){const e=document.getElementById("isAdult").checked,t=document.getElementById("parentPhoneGroup"),n=document.getElementById("parentPhone");t.style.display=e?"none":"block",n.required=!e}function ct(){localStorage.getItem(`upgradeRequested_${currentUser.id}`)?nt():Z("upgrade-screen")}document.addEventListener("DOMContentLoaded",(function(){new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{if(1===e.nodeType){e.querySelectorAll(".fa-crown").forEach((e=>{e.addEventListener("click",(function(e){e.stopPropagation(),Z("upgrade-screen")}))}))}}))}))})).observe(document.body,{childList:!0,subtree:!0})}));class lt{constructor(e=100,t=6e4){this.requests=new Map}checkLimit(e){const t=Date.now(),n=(this.requests.get(e)||[]).filter((e=>t-e<this.timeWindow));return!(n.length>=this.maxRequests)&&(n.push(t),this.requests.set(e,n),!0)}}function dt(e){return e.replace(/[<>]/g,"").trim().slice(0,500)}const ut={maxInactiveTime:18e5,lastActivity:Date.now(),init(){document.addEventListener("click",(()=>this.updateActivity())),document.addEventListener("keypress",(()=>this.updateActivity())),setInterval((()=>this.checkSession()),6e4)},updateActivity(){this.lastActivity=Date.now()},async checkSession(){Date.now()-this.lastActivity>this.maxInactiveTime&&(await C(),modalSystem.show("timeout",{title:"Session Expired",message:"Please log in again"}))}},mt={validateGameProgress:e=>({...e,coins:Math.min(e.coins,1e5),perks:Object.fromEntries(Object.entries(e.perks).map((([e,t])=>[e,Math.min(t,100)])))}),validateCustomList:e=>({...e,words:e.words.slice(0,1e3).map(dt),translations:e.translations.slice(0,1e3).map(dt)})};function pt(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function ft(e){return`\n        <div class="list-item">\n            <h3>${pt(e.name)}</h3>\n            <p>${pt(e.description)}</p>\n        </div>\n    `}const gt={async logError(e,t){currentUser&&await p.from("error_logs").insert([{user_id:currentUser.id,error:e.message,stack:e.stack,context:t,timestamp:new Date}])},handleError(e,t){this.logError(e,t),modalSystem.show("error",{title:"Oops!",message:"Something went wrong. Please try again."})}};function yt(){const e=document.getElementById("isAdult").checked,t=document.getElementById("parentInfoSection"),n=document.getElementById("adultInfoSection"),s=t.querySelectorAll("input"),r=n.querySelectorAll("input");e?(t.style.display="none",n.style.display="block",s.forEach((e=>e.required=!1)),r.forEach((e=>e.required=!0))):(t.style.display="block",n.style.display="none",s.forEach((e=>e.required=!0)),r.forEach((e=>e.required=!1)))}function ht(){const e=document.querySelector(".confirmation-popup");e&&(e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.7)",setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),300));const t=document.getElementById("upgrade-screen");t&&t.classList.remove("visible");const n=document.getElementById("upgradeForm");n&&n.reset(),localStorage.removeItem("gameContext"),nt(),Z("welcome-screen")}function vt(){const e=document.querySelectorAll(".confirmation-popup");0!==e.length&&e.forEach(((e,t)=>{}))}function wt(){nt()}function bt(e){const t=document.querySelector(".user-profile-section"),n=document.getElementById("userTierText");if(t&&n){if(n.className="status-badge",currentUser)switch(t.style.display="block",e){case"free":default:n.classList.add("trial"),n.textContent="Trial Account";break;case"pending":n.classList.add("pending"),n.textContent="Premium Pending";break;case"premium":n.classList.add("premium"),n.textContent="Premium"}else n.classList.add("unregistered"),n.textContent="Unregistered",t.style.display="none";currentUser&&St()}}async function St(){try{if(!currentUser)return;const{data:e}=await p.from("game_progress").select("coins").eq("user_id",currentUser.id).single(),{data:t}=await p.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();e&&(document.getElementById("totalCoins").textContent=e.coins||0),t&&(document.getElementById("totalWords").textContent=t.unique_words_practiced||0),ve(),o.updateDisplays(t?.unique_words_practiced||0)}catch(e){}}function kt(){if(!currentUser)return;return p.channel("user-status-"+currentUser.id).on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_profiles",filter:`id=eq.${currentUser.id}`},(e=>{e.new&&e.new.status&&(bt(e.new.status),"premium"===e.new.status&&$t())})).subscribe((e=>{}))}function xt(){const e=localStorage.getItem("gameContext");if(e){const t=JSON.parse(e);return $.currentStage=t.stage||1,$.currentSet=t.set||1,$.currentLevel=t.level,localStorage.removeItem("gameContext"),!0}return!1}function Lt(){if(!currentUser)return!1;const e=localStorage.getItem(`upgradeRequested_${currentUser.id}`),t="premium"===currentUser.status,n="pending"===currentUser.status;return e||t||n}function Ct(){I(),window.location.reload(!0)}function Et(){window.location&&(window.location.href=window.location.href),window.location.reload&&window.location.reload(!0),window.location.replace(window.location.pathname)}async function It(){Z("leaderboard-screen");const e=document.getElementById("leaderboard-entries");try{async function t(){const{data:t,error:n}=await p.from("player_leaderboard").select("*");if(n)return;const s=e.children,r={};Array.from(s).forEach((e=>{const t=e.querySelector("[data-username]").dataset.username;r[t]=e.getBoundingClientRect()})),e.innerHTML=t.map(((e,t)=>`\n                <div class="leaderboard-entry ${e.username===currentUser?.user_metadata?.username?"you":""} ${t<3?`rank-${t+1}`:""}"\n                     data-rank="${t+1}">\n                    <div>${e.player_rank}</div>\n                    <div data-username="${e.username}">${e.username||"Anonymous"}</div>\n                    <div>${e.total_levels_completed}</div>\n                    <div>${e.total_words_learned}</div>\n                </div>\n            `)).join("");const o=e.children;Array.from(o).forEach((e=>{const t=e.querySelector("[data-username]").dataset.username;if(r[t]){const n=r[t],s=e.getBoundingClientRect(),o=n.top-s.top;o>0?e.classList.add("moving-up"):o<0&&e.classList.add("moving-down"),e.addEventListener("animationend",(()=>{e.classList.remove("moving-up","moving-down")}),{once:!0})}}))}await t();const n=setInterval(t,1e4),s=document.getElementById("leaderboard-screen");s&&(s.dataset.pollInterval&&clearInterval(parseInt(s.dataset.pollInterval)),s.dataset.pollInterval=n)}catch(r){e.innerHTML=`<p>Error loading leaderboard: ${r.message}</p>`}}function qt(){const e=document.getElementById("leaderboard-screen");e&&(e.dataset.channel&&(p.removeChannel(e.dataset.channel),delete e.dataset.channel),e.dataset.pollInterval&&(clearInterval(parseInt(e.dataset.pollInterval)),delete e.dataset.pollInterval))}async function Tt(e,t,n){if(currentUser&&"premium"===currentUser.status)try{const{data:e,error:t}=await p.from("player_stats").select("*").eq("user_id",currentUser.id).single();if(t&&"PGRST116"!==t.code)throw t;const n=[...new Set(U.words)].length,s={user_id:currentUser.id,total_levels_completed:(e?.total_levels_completed||0)+1,unique_words_practiced:(e?.unique_words_practiced||0)+n,last_updated:(new Date).toISOString()},{error:r}=await p.from("player_stats").upsert(s,{onConflict:"user_id",returning:"minimal"});if(r)throw r;await o.updateWords(n)}catch(e){}}async function _t(){try{const{data:{session:e}}=await p.auth.getSession();if(e){currentUser=e.user;const{data:t}=await p.from("user_profiles").select("status").eq("id",currentUser.id).single();return t&&(currentUser.status=t.status,bt(t.status)),Pt(),_(),xn(),!0}return currentUser=null,_(),bt(null),xn(),!1}catch(e){return currentUser=null,_(),bt(null),xn(),!1}}function Mt(){const e=setInterval((()=>{$.currentStage&&$.currentSet&&$.currentLevel&&I()}),3e4);return window.addEventListener("beforeunload",(()=>{$.currentStage&&$.currentSet&&$.currentLevel&&I()})),e}function $t(){const e=document.createElement("div");e.className="premium-celebration",e.innerHTML='\n        <div class="celebration-content">\n            <h1 class="celebration-title">Congratulations!</h1>\n            <p class="celebration-message">You\'ve unlocked Premium Access!</p>\n            <button class="celebration-button" onclick="handlePremiumCelebrationComplete()">\n                Continue\n            </button>\n        </div>\n    ',document.body.appendChild(e),setTimeout((()=>{e.classList.add("show")}),100)}function At(){const e=document.querySelector(".premium-celebration");if(e){e.classList.remove("show");const t=localStorage.getItem("unlockNextSetForStage");if(t){const e=parseInt(t,10);if(!isNaN(e)&&e>=2&&e<=5){$.unlockedSets[e]||($.unlockedSets[e]=new Set),$.unlockedSets[e].add(2);const t=`${e}_2`;$.unlockedLevels[t]||($.unlockedLevels[t]=new Set),$.unlockedLevels[t].add(1),I(),localStorage.removeItem("unlockNextSetForStage")}}setTimeout((()=>{e.remove(),Z("welcome-screen")}),500)}}function At(){const e=document.querySelector(".premium-celebration");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),Z("welcome-screen")}),500))}function Pt(){if(window.statusCheckInterval&&clearInterval(window.statusCheckInterval),currentUser){const e=setInterval((async()=>{try{if(!currentUser||!currentUser.id)return void clearInterval(window.statusCheckInterval);const{data:e,error:t}=await p.from("user_profiles").select("status").eq("id",currentUser.id).single();if(t||!e)return clearInterval(window.statusCheckInterval),currentUser=null,void _();const n=currentUser.status;if(bt(e.status),"premium"===e.status&&"premium"!==n){currentUser.status="premium";const e=localStorage.getItem("completedTrialStage");e&&(localStorage.setItem("unlockNextSetForStage",e),localStorage.removeItem("completedTrialStage")),$t()}}catch(e){clearInterval(window.statusCheckInterval),currentUser=null,_()}}),3e3);window.statusCheckInterval=e}}window.debugUpgrade=function(){vt()},document.querySelectorAll(".home-button").forEach((e=>{e.onclick=function(){Et()}})),document.addEventListener("DOMContentLoaded",(function(){u.init().then((()=>{const e=localStorage.getItem("gameContext");if(e&&!window.location.hash)try{const t=JSON.parse(e);Date.now()-(t.timestamp||0)<864e5&&($.currentStage=t.stage||$.currentStage,$.currentSet=t.set||$.currentSet,$.currentLevel=t.level||$.currentLevel)}catch(e){}}))})),document.addEventListener("DOMContentLoaded",(function(){Mt()})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("otpInput");e&&e.addEventListener("input",(function(e){this.value=this.value.replace(/[^0-9]/g,""),this.value.length>4&&(this.value=this.value.slice(0,4))}))}));let Bt={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50,state:"pre-start",completedPlayers:[],playerRank:null,winnerScreenShown:!1,startTime:null,endTime:null};async function Ut(){const e=document.getElementById("arcade-modal"),t=document.getElementById("teacher-view"),n=document.getElementById("player-view"),s=document.getElementById("arcadeUsername"),r=s?s.closest(".input-group"):null;try{if(currentUser){const{data:e}=await p.from("user_profiles").select("role").eq("id",currentUser.id).single();if("teacher"===e?.role){const e=Math.floor(1e3+9e3*Math.random()).toString();Bt.otp=e,Bt.teacherId=currentUser.id,Bt.participants=[],Bt.isInitialized=!1,Bt.state="pre-start",Bt.celebrationTriggered=!1,window.arcadeChannel&&window.arcadeChannel.unsubscribe(),window.arcadeChannel=p.channel(`arcade:${e}`,{config:{broadcast:{self:!0}}}),window.arcadeChannel.on("broadcast",{event:"player_join"},(({payload:e})=>{if(!Bt.participants.find((t=>t.username===e.username))){Bt.participants.push({username:e.username,wordsCompleted:0,coins:0}),document.getElementById("player-count").textContent=Bt.participants.length;const t=document.getElementById("arcade-leaderboard");t&&null!==t.offsetParent&&Xt()}})).subscribe();window.location.origin,window.location.pathname;Un(e),document.getElementById("otp").textContent=e,t.style.display="block",n.style.display="none",document.querySelectorAll('.stage-checkboxes input[type="checkbox"]').forEach((e=>{e.checked=!1}));const s=document.getElementById("wordGoalInput"),r=document.getElementById("wordGoalSlider"),o=document.getElementById("wordGoalDisplay");s&&(s.value="50"),r&&(r.value="50"),o&&(o.textContent="50"),Nt();const a=document.querySelector(".end-arcade-button");a&&a.classList.remove("visible")}else if(t.style.display="none",n.style.display="block",s&&r){const e=currentUser.user_metadata?.username||currentUser.email.split("@")[0];s.value=e,s.readOnly=!0,s.style.display="none";const t=document.createElement("div");t.className="username-display",t.textContent=`Joining as: ${e}`,r.insertBefore(t,s)}}else if(t.style.display="none",n.style.display="block",s){s.readOnly=!1,s.style.display="block";const e=r?.querySelector(".username-display");e&&e.remove()}e.style.display="block"}catch(e){alert("Failed to initialize arcade")}}function Nt(){const e=document.getElementById("wordGoalSlider"),t=document.getElementById("wordGoalDisplay"),n=document.getElementById("wordGoalInput"),s=document.querySelectorAll(".slider-stop");e&&t&&n&&(e.min=0,e.max=200,e.value=50,t.textContent=50,n.value=50,e.addEventListener("input",(function(){const e=parseInt(this.value);t.textContent=e,n.value=e})),n.addEventListener("input",(function(){let n=parseInt(this.value)||0;n=Math.max(0,Math.min(200,n)),e.value=n,t.textContent=n,this.value=n})),s.forEach((s=>{s.addEventListener("click",(function(){const s=parseInt(this.dataset.value);e.value=s,t.textContent=s,n.value=s}))})))}function Ft(e){async function t(){try{const{data:t}=await p.from("game_progress").select("arcade_session").eq("user_id",e).single();t?.arcade_session?.participants&&(document.getElementById("player-count").textContent=t.arcade_session.participants.length)}catch(e){}}window.countInterval&&clearInterval(window.countInterval),t(),window.countInterval=setInterval(t,2e3)}async function Dt(){const e=document.getElementById("otpInput").value.trim().toUpperCase();try{window.arcadeChannel=p.channel(`arcade:${e}`);const t=currentUser?currentUser.user_metadata?.username:Rt();let n;Bt.playerName=t,window.arcadeChannel.on("broadcast",{event:"game_end"},(({payload:e})=>{un(e),Bt.state=e.state,"active"===e.state&&(Bt.wordPool=e.wordPool,Bt.wordGoal=e.wordGoal,Kt(),n&&clearInterval(n))})).on("broadcast",{event:"game_playing"},(({payload:e})=>{"active"===e.state&&(Bt.state="active",Bt.wordPool=e.wordPool,Bt.wordGoal=e.wordGoal,Kt(),n&&clearInterval(n))})).subscribe(),await window.arcadeChannel.send({type:"broadcast",event:"player_join",payload:{username:t,joinedAt:(new Date).toISOString(),coins:0}}),Bt.joinEventSent=!0,Bt.otp=e,await window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:t,requestType:"lateJoin",timestamp:Date.now()}}),document.getElementById("arcade-modal").style.display="none",setTimeout((()=>{"active"!==Bt.state&&Ot()}),500),n=setInterval((async()=>{await window.arcadeChannel.send({type:"broadcast",event:"check_game_status"})}),2e3),setTimeout((()=>{n&&clearInterval(n)}),3e5)}catch(e){alert("Failed to join arcade")}}function zt(){const e=document.getElementById("joinGameButton");e&&(e.style.display="block",e.textContent="Join Active Game")}async function Ht(){if(!currentUser)return 0;const{data:e}=await p.from("game_progress").select("coins").eq("user_id",currentUser.id).single();return e?.coins||0}function Rt(){const e=["Simplosaurus","Simplodian","Simpleton","Simplonius","Simplomancer","Simplonaut","Simplobot","Simplozilla","Simplopedia","Simplotron","Simplodex","Simplomatic","Simplomobile","Simplocopter","Simplonium","Simplotastic","Simplominator","Simploverse","Simplonado","Simplophant","Simplowizard","Simplodragon","Simplosapien","Simploninja","Simplowarrior"];return e[Math.floor(Math.random()*e.length)]}function Ot(){if("active"===Bt.state)return void Kt();document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")}));const e=document.getElementById("waiting-screen");e.classList.add("visible");const t=document.getElementById("joinGameButton");t&&(t.style.display="active"===Bt.state?"block":"none");try{vo()}catch(e){}const n=setInterval((()=>{if(window.arcadeChannel)try{window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:Bt.playerName,requestType:"waitingCheck"}})}catch(e){}}),2e3),s=document.getElementById("waiting-player-count");s&&(s.parentElement.style.display="none"),e.dataset.pollInterval=n,setTimeout((()=>{n&&clearInterval(n)}),3e5)}async function jt(){try{const e=document.querySelector(".initialize-button"),t=document.querySelector(".end-arcade-button");e&&(e.style.display="none"),t&&t.classList.add("visible"),Bt.state="active",Bt.isInitialized=!0,Bt.participants=Bt.participants.map((e=>({...e,wordsCompleted:0,coins:e.coins||0}))),Xt(),ms(),await window.arcadeChannel.send({type:"broadcast",event:"game_playing",payload:{wordPool:Bt.wordPool,wordGoal:Bt.wordGoal,state:"active",timestamp:Date.now()}})}catch(e){alert("Failed to start game")}}function Wt(){document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")})),document.getElementById("moderator-screen").classList.add("visible");const e=document.getElementById("moderatorOtp");if(e&&Bt.otp){e.textContent=Bt.otp;const t=`${window.location.origin+window.location.pathname}#join=${Bt.otp}`;new QRious({element:document.getElementById("qrCode"),value:t,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"});const n=new Date,s={sessionDate:n.toLocaleDateString(),sessionStartTime:n.toLocaleTimeString(),sessionWordGoal:Bt.wordGoal,activeParticipantCount:Bt.participants.length};Object.entries(s).forEach((([e,t])=>{const n=document.getElementById(e);n&&(n.textContent=t)}))}Gt();const t=document.querySelector(".initialize-button"),n=document.querySelector(".end-arcade-button");Bt.isInitialized&&"active"===Bt.state?(t&&(t.style.display="none"),n&&n.classList.add("visible")):(t&&(t.style.display="block"),n&&n.classList.remove("visible")),ms(),setTimeout((()=>{Bt.participants&&Bt.participants.length>0&&Xt()}),500)}function Gt(){document.getElementById("arcade-leaderboard").innerHTML='\n        <div class="leaderboard-header">\n            <div>Rank</div>\n            <div>Player</div>\n            <div>Words</div>\n            <div>Coins</div>\n        </div>\n    ',Bt.participants.length>0&&Xt()}const Jt=["Born Ready!","Ready to Roll!","All Set!","Locked & Loaded!","Ready Player!","Game Face On!","In Position!","Ready to Rock!","Standing By!","Powered Up!","Challenge Ready!","Mission Ready!","Ready to Shine!","Bring it On!","Ready to Rumble!","Set for Success!","Level Ready!","Shields Up!","Word Warrior Ready!","Let's Do This!"],Yt=["#1E90FF","#FF1493","#00CED1","#9370DB","#FFD700","#FF4500","#32CD32","#FF69B4","#4169E1","#8A2BE2"];function Xt(){const e={};document.querySelectorAll(".leaderboard-entry").forEach((t=>{const n=t.querySelector("[data-username]"),s=t.querySelector("[data-words]");if(n&&s){const t=n.dataset.username,r=parseInt(s.textContent)||0;e[t]=r}})),Bt.participants.forEach((t=>{const n=t.username;e[n]&&e[n]>t.wordsCompleted&&(t.wordsCompleted=e[n])}));const t=[...Bt.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)),n=`\n      <div class="leaderboard-header">\n          <div>Rank</div>\n          <div>Player</div>\n          <div>Words</div>\n          <div>Coins</div>\n      </div>\n      ${t.map(((e,t)=>"active"===Bt.state&&e.username?`<div class="leaderboard-entry ${t<3?`rank-${t+1}`:""}"\n                 data-rank="${t+1}">\n              <div class="rank">${t+1}</div>\n              <div data-username="${e.username}" class="player-name">${e.username}</div>\n              <div data-words="${e.wordsCompleted||0}" class="words">${e.wordsCompleted||0}</div>\n              <div data-coins="${e.coins||0}" class="coins">${e.coins||0}</div>\n          </div>`:`<div class="leaderboard-entry waiting ${t<3?`rank-${t+1}`:""}"\n                 data-rank="${t+1}">\n              <div class="rank">${t+1}</div>\n              <div data-username="${e.username}" class="player-name">${e.username}</div>\n              <div class="player-status-waiting">\n                  <span class="status-text" style="color: ${Yt[Math.floor(Math.random()*Yt.length)]}">${Jt[Math.floor(Math.random()*Jt.length)]}</span>\n              </div>\n              <div class="waiting-indicator">\n                  <span class="dot"></span>\n                  <span class="dot"></span>\n                  <span class="dot"></span>\n              </div>\n          </div>`)).join("")}\n  `,s=document.getElementById("arcade-leaderboard");s&&(s.innerHTML=n);const r=document.getElementById("activeParticipantCount");r&&(r.textContent=t.length);const o=document.getElementById("sessionDate");o&&(o.textContent=(new Date).toLocaleDateString());const a=document.getElementById("sessionStartTime");a&&(a.textContent=(new Date).toLocaleTimeString());const i=document.getElementById("sessionWordGoal");i&&(i.textContent=Bt.wordGoal)}async function Vt(){const e=Array.from(document.querySelectorAll(".stage-checkboxes input:checked")).map((e=>parseInt(e.value))),t=document.querySelector(".stage-warning");if(0===e.length)return void(t&&(t.style.display="block"));t&&(t.style.display="none"),Bt.wordPool=Zt(e);const n=document.getElementById("wordGoal")||document.getElementById("wordGoalSlider");if(n){const e=parseInt(n.value);Bt.wordGoal=isNaN(e)?50:e}else Bt.wordGoal=50;Bt.state="started",Bt.participants=[],Bt.completedPlayers=[],Bt.podiumRanks={},Bt.isInitialized=!1,Bt.startTime=null,Bt.endTime=null,Bt.winnerScreenShown=!1,window.arcadeChannel.on("broadcast",{event:"progress_update"},(({payload:e})=>{if(e&&e.username){const t=Bt.participants.findIndex((t=>t.username===e.username));if(-1!==t){const n=Bt.participants[t],s=n.wordsCompleted||0;void 0!==e.wordsCompleted&&e.wordsCompleted<s&&(e.wordsCompleted=s),Bt.participants[t]={...n,...e}}else Bt.participants.push({username:e.username,wordsCompleted:e.wordsCompleted||0,coins:e.coins||0});wo(),X(e),dn()}})).on("broadcast",{event:"check_game_status"},(async({payload:e})=>{if(await window.arcadeChannel.send({type:"broadcast",event:"game_state_response",payload:{state:Bt.state,wordPool:Bt.wordPool,wordGoal:Bt.wordGoal,requestType:e?.requestType||"standard"}}),"lateJoin"===e?.requestType&&"active"===Bt.state&&e.username&&!Bt.participants.find((t=>t.username===e.username))){Bt.participants.push({username:e.username,wordsCompleted:0,coins:0,lateJoin:!0});const t=document.getElementById("activeParticipantCount");t&&(t.textContent=Bt.participants.length),Xt()}})).on("broadcast",{event:"player_completed"},(({payload:e})=>{e.username&&!Bt.completedPlayers.includes(e.username)&&(Bt.completedPlayers.push(e.username),e.rank&&e.rank<=3&&(Bt.podiumRanks[e.username]={rank:e.rank,completionTime:e.timestamp||Date.now()}),X(e),Bt.completedPlayers.length>=3&&rs())}));const s=document.getElementById("arcade-modal");if(s&&(s.style.display="none"),Wt(),currentUser?.id===Bt.teacherId){const e=is();Bt.idleDetection=e}}function Zt(e){let t=[];return e.forEach((e=>{Object.keys(vocabularySets).forEach((n=>{if(n.startsWith(`${e}_`)){const e=vocabularySets[n];e.words.forEach(((n,s)=>{t.push({word:n,translation:e.translations[s]})}))}}))})),t.sort((()=>Math.random()-.5))}function Qt(){const e=document.getElementById("moderator-screen");e&&e.dataset.channelSubscription&&(p.removeChannel(e.dataset.channelSubscription),delete e.dataset.channelSubscription)}function Kt(){const e=document.getElementById("waiting-screen");e&&e.dataset.pollInterval&&(clearInterval(parseInt(e.dataset.pollInterval)),delete e.dataset.pollInterval),document.getElementById("question-screen").classList.add("visible"),document.getElementById("waiting-screen").classList.remove("visible");const t=Bt.playerName||currentUser?.user_metadata?.username||Rt();wo(),document.querySelectorAll(".coin-count").forEach((e=>{e.textContent="0",e.style.display="flex"})),document.querySelectorAll(".coins-container").forEach((e=>{e.style.display="flex"}));const n=document.querySelector(".perks-container"),s=document.querySelector(".powerups-container");n.style.display="none",s.style.display="flex";let r=0;if(currentUser&&"premium"===currentUser.status)try{const{data:e,error:t}=p.from("game_progress").select("coins").eq("user_id",currentUser.id).single();!t&&e&&(r=e.coins)}catch(e){}else r=parseInt(localStorage.getItem("simploxCustomCoins")||"0");U.coins=r,Bt.initialCoins=r,document.querySelectorAll(".coin-count").forEach((e=>{e.textContent=r.toString()}));try{window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:t,wordsCompleted:0,coins:r,timestamp:Date.now()}})}catch(e){}if(window.arcadeChannel.send({type:"broadcast",event:"sync_request",payload:{username:t,timestamp:Date.now()}}),wo(),Bt.startTime=Date.now(),U={currentIndex:0,correctStreak:0,wrongStreak:0,words:Bt.wordPool||[],wordsCompleted:0,coins:r,lastBroadcast:Date.now(),initialCoinsLoaded:!0,playerUsername:t},!U.words||0===U.words.length){if(!(Bt.wordPool&&Bt.wordPool.length>0))return Xe("Failed to join game: No words available"),void Z("welcome-screen");U.words=Bt.wordPool}$n();const o=p.channel("arcade_leaderboard").on("postgres_changes",{event:"*",schema:"public",table:"arcade_participants"},(e=>{Xt()})).subscribe();Bt.leaderboardChannel=o,window.arcadeChannel.on("broadcast",{event:"player_initialized"},(({payload:e})=>{const t=Bt.participants.findIndex((t=>t.username===e.username)),n={username:e.username,wordsCompleted:0,coins:e.initialCoins||0,lateJoin:e.lateJoin||!1};-1===t?Bt.participants.push(n):Bt.participants[t]=n,Xt(),sn()})),window.arcadeChannel.on("broadcast",{event:"progress_update"},(({payload:e})=>{if(e.username!==Bt.playerName){const t=Bt.participants.findIndex((t=>t.username===e.username));if(-1!==t){const n=Bt.participants[t],s=n.wordsCompleted||0,r=e.wordsCompleted||0;Bt.participants[t]={...n,...e,wordsCompleted:Math.max(s,r)}}else Bt.participants.push({username:e.username,wordsCompleted:e.wordsCompleted||0,coins:e.coins||0,lateJoin:e.lateJoin||!1});X({username:e.username,wordsCompleted:e.wordsCompleted,coins:e.coins})}wo()})),window.arcadeChannel.on("broadcast",{event:"sync_request"},(({payload:e})=>{U&&U.wordsCompleted>0&&window.arcadeChannel.send({type:"broadcast",event:"sync_response",payload:{participants:Bt.participants,respondingPlayer:Bt.playerName,requestingPlayer:e.username,timestamp:Date.now()}})})),window.arcadeChannel.on("broadcast",{event:"sync_response"},(({payload:e})=>{e.requestingPlayer===Bt.playerName&&Array.isArray(e.participants)&&(e.participants.forEach((e=>{const t=Bt.participants.findIndex((t=>t.username===e.username));if(-1===t)Bt.participants.push(e);else{const n=Bt.participants[t];Bt.participants[t]={...n,wordsCompleted:Math.max(n.wordsCompleted||0,e.wordsCompleted||0),coins:Math.max(n.coins||0,e.coins||0)}}})),wo())})),window.arcadeChannel.on("broadcast",{event:"player_completed"},(({payload:e})=>{Bt.completedPlayers.includes(e.username)||Bt.completedPlayers.push(e.username),X(e),Bt.completedPlayers.length>=3&&rs()})),window.arcadeChannel.on("broadcast",{event:"powerup_effect"},(({payload:e})=>{if(e.targetUser===Bt.playerName){const t=e.powerup;switch(Tn(`${e.fromUser} ${t.message} you!`,t.type),t.name){case"High Five":case"Fist Bump":const e=U.coins;U.coins+=t.effect,document.querySelectorAll(".coin-count").forEach((t=>{qn(t,e,U.coins)}));break;case"Energy Boost":U.coinMultiplier=2,U.boostedAnswersLeft=3;break;case"Freeze":const n=document.querySelectorAll(".buttons button");n.forEach((e=>e.disabled=!0)),setTimeout((()=>{n.forEach((e=>e.disabled=!1))}),t.duration);break;case"Coin Storm":U.coinBlockedAnswers=3;break;case"Screen Shake":const s=document.getElementById("question-screen");s.classList.add("screen-shake"),setTimeout((()=>{s.classList.remove("screen-shake")}),t.duration)}X({username:Bt.playerName,coins:U.coins,wordsCompleted:U.wordsCompleted})}})),window.arcadeChannel.on("broadcast",{event:"coin_effect"},(({payload:e})=>{if(e.targetUser===Bt.playerName){const t=U.coins;U.coins+=e.amount,document.querySelectorAll(".coin-count").forEach((e=>{qn(e,t,U.coins)}));const n=Bt.participants.findIndex((e=>e.username===Bt.playerName));-1!==n&&(Bt.participants[n].coins=U.coins,updateModeratorLeaderboard()),"blessing"===e.type?Tn(`${e.fromUser} high-fived you!`,"blessing"):"curse"===e.type&&Tn(`${e.fromUser} poisoned you!`,"curse"),X({username:Bt.playerName,coins:U.coins,wordsCompleted:U.wordsCompleted})}})),window.arcadeChannel.on("broadcast",{event:"game_end"},(({payload:e})=>{un(e)})),ve(),nn(),window.arcadeTimeouts=[],window.arcadeIntervals=[]}async function en(e){const t=U.coins;if(U.coins+=e,currentUser)try{const{error:e}=await p.from("game_progress").update({coins:U.coins}).eq("user_id",currentUser.id);if(e)throw e}catch(e){U.coins=t}const n=Bt.participants.some((e=>e.wordsCompleted>0&&e.username!==Bt.playerName));if(!n)try{window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:Bt.playerName,wordsCompleted:0,coins:U.coins||0,timestamp:Date.now(),lateJoin:n}})}catch(e){}if(n)try{window.arcadeChannel.send({type:"broadcast",event:"sync_request",payload:{username:Bt.playerName,requestType:"newPlayerJoin",timestamp:Date.now()}})}catch(e){}return document.querySelectorAll(".coin-count").forEach((e=>{J(e,t,U.coins)})),U.coins}async function tn(){if(!currentUser)return parseInt(localStorage.getItem("simploxCustomCoins")||"0");try{const{data:e,error:t}=await p.from("game_progress").select("coins").eq("user_id",currentUser.id).single();return e?.coins||0}catch(e){return 0}}function nn(){if(!U.words.length)return;const e=document.getElementById("question-word"),t=document.getElementById("buttons"),n=Math.floor(Math.random()*U.words.length),s=U.words[n],r=Math.random()<.5;e.textContent=r?s.translation:s.word;let o=[r?s.word:s.translation];for(;o.length<3;){const e=U.words[Math.floor(Math.random()*U.words.length)],t=r?e.word:e.translation;o.includes(t)||o.push(t)}o=o.sort((()=>Math.random()-.5)),t.innerHTML="",o.forEach((e=>{const n=document.createElement("button");n.textContent=e,n.onclick=()=>ln(e===(r?s.word:s.translation)),t.appendChild(n)})),U.words.splice(n,1)}function sn(){const e=document.querySelector(".progress-circle .progress"),t=2*Math.PI*54,n=U.wordsCompleted?U.wordsCompleted/Bt.wordGoal:0;e.style.strokeDasharray=`${t} ${t}`,e.style.strokeDashoffset=t*(1-n)}function rn(e){const t=document.createElement("div");t.className="arcade-completion-modal",t.innerHTML=`\n        <div class="completion-modal-content">\n            <h2>Arcade Complete!</h2>\n            <div class="completion-stats">\n                <div class="stat-item">\n                    <i class="fas fa-book"></i>\n                    <span>Words: ${e.wordsCompleted}</span>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-coins"></i>\n                    <span>Coins: ${e.coins}</span>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-trophy"></i>\n                    <span>Rank: ${e.rank}</span>\n                </div>\n            </div>\n            <button onclick="exitArcade()" class="start-button">Exit</button>\n        </div>\n    `,document.body.appendChild(t),requestAnimationFrame((()=>t.classList.add("show")))}function on(){const e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),Z("welcome-screen")}),300))}function an(){window.arcadeChannel&&window.arcadeChannel.unsubscribe(),Bt={eventId:null,otp:null,wordPool:[],participants:[],teacherId:null,wordGoal:50},Z("welcome-screen"),document.querySelector(".completion-overlay")?.remove()}function cn(e,t=!1){const n=Date.now();if(!(n-(U.lastAnswerTime||0)<1e3)&&U&&U.words&&0!==U.words.length&&!(U.currentIndex>=U.words.length)){U.lastAnswerTime=n,U.perks=U.perks||{clue:0,skip:0,timeFreeze:0,reveal:0};try{if(e){if(U.currentIndex++,U.isBossLevel){const e=document.querySelector(".boss-orb-inner");if(e){const t=["yellow","purple","turquoise","darkgreen","brown"],n=t[Math.floor(Math.random()*t.length)],s=e.style.background;e.style.background=`radial-gradient(circle at 30% 30%, ${n}, #990000)`,e.style.transform="scale(1.3)",e.style.filter="brightness(1.5)",setTimeout((()=>{e.style.transform="",e.style.filter="",e.style.background=s}),300)}if(U.currentIndex>=U.words.length){U.bossDefeated=!0,W();const e=document.querySelector(".progress-circle");if(e){const t=e.querySelector(".progress");if(t){const e=2*Math.PI*54;t.style.strokeDashoffset=e}}return Fr(),void r.updateCoins(100).then((()=>{ve()}))}Gn()}else me();if(!t){let e=0;const t=ye();if(t>0&&(e+=t,he(t)),U.firstAttempt?(e+=3,he(3)):(e+=1,he(1)),r.updateCoins(e).then((()=>{B(),ve()})).catch((e=>{})),U.correctAnswers++,currentUser){const e=U.currentIndex-1,t=U.isHebrewToEnglish?U.words[e]:U.translations[e];xr(t,U.isCustomPractice?"custom":U.isArcadeMode?"arcade":"story")}}}else if(U.firstAttempt=!1,U.streakBonus=!1,U.wrongStreak++,r.updateCoins(-3).then((()=>{B(),ve()})).catch((e=>{})),U.currentIndex>0&&(U.progressLost++,U.currentIndex=Math.max(0,U.currentIndex-1),U.isBossLevel&&Gn()),U.wrongStreak>=3)return void Te();const n=document.querySelectorAll(".buttons button"),s=U.isHebrewToEnglish?U.words[Math.max(0,U.currentIndex-1)]:U.translations[Math.max(0,U.currentIndex-1)];n.forEach((t=>{t.textContent===s?t.classList.add("correct"):!e&&event&&event.target&&t.textContent===event.target.textContent&&t.classList.add("wrong")})),I();setTimeout((()=>{n.forEach((e=>{e.classList.remove("correct","wrong")})),!U||U.bossDefeated&&U.isBossLevel||(U.currentIndex<U.words.length?(O(U.words.length-U.currentIndex),U.isBossLevel?Yn():pe(),B()):U.isBossLevel||(U.isCustomPractice?Ds():ke()))}),500)}catch(e){try{U&&U.currentIndex<U.words.length&&!U.bossDefeated?pe():Z("welcome-screen")}catch(e){Z("welcome-screen")}}}}function ln(e){const t=Date.now();if(t-(U.lastAnswerTime||0)<1e3)return;U.lastAnswerTime=t;const n=Bt.playerName||currentUser?.user_metadata?.username||Rt();if(e){if(U.wordsCompleted++,U.correctStreak++,U.wrongStreak=0,currentUser);else{let e=5;U.correctStreak>=3&&(e+=5);const t=U.coins;U.coins+=e,document.querySelectorAll(".coin-count").forEach((e=>{J(e,t,U.coins)})),Pn()}const e=Bt.participants.findIndex((e=>e.username===n));-1!==e?(Bt.participants[e].wordsCompleted=U.wordsCompleted,Bt.participants[e].coins=U.coins):Bt.participants.push({username:n,wordsCompleted:U.wordsCompleted,coins:U.coins}),wo();try{window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:n,wordsCompleted:U.wordsCompleted,coins:U.coins,timestamp:Date.now()}})}catch(e){}sn(),U.wordsCompleted>=Bt.wordGoal&&Kn(n)}else U.correctStreak=0,U.wrongStreak++;wo(),nn()}function dn(){Bt.participants.filter((e=>e.wordsCompleted>=Bt.wordGoal)).length>=3&&window.arcadeChannel.send({type:"broadcast",event:"game_end"})}function un(e){e&&(e.forcedEnd?(an(),Z("welcome-screen")):currentUser?.id!==e.teacherId?fn(e.podiumPlayers||[]):yn(e.podiumPlayers||[]))}function mn(e){const t=Bt.playerName,n=Bt.podiumRanks[t].rank,s=Bt.initialCoins||0,r=($.coins||U.coins||0)-s,o=U.wordsCompleted||0,a=document.createElement("div");a.className="arcade-completion-modal",a.innerHTML=`\n        <div class="completion-modal-content">\n            <h2>Congratulations!</h2>\n            <p class="personal-result">You finished in ${as(n)} place!</p>\n            \n            <div class="your-stats">\n                <h3>Your Results</h3>\n                <div class="completion-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0;">\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-language" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Words Learned</span>\n                        <strong style="font-size: 1.5rem;">${o}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Coins Earned</span>\n                        <strong style="font-size: 1.5rem;">${r}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Your Rank</span>\n                        <strong style="font-size: 1.5rem;">${n}</strong>\n                    </div>\n                </div>\n            </div>\n            \n            <button onclick="exitArcadeCompletion()" class="start-button">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(a),requestAnimationFrame((()=>a.classList.add("show")))}function pn(){const e=document.createElement("div");e.className="arcade-completion-modal";const t=["🌟","🎮","🚀","💪","🏆","🔥","👏","✨"],n=t[Math.floor(Math.random()*t.length)];e.innerHTML=`\n        <div class="completion-modal-content">\n            <h2 style="font-size: 3rem; margin-bottom: 1rem;">${n}</h2>\n            <h2>Game Complete!</h2>\n            <p style="font-size: 1.2rem; margin: 1.5rem 0; line-height: 1.5;">\n                Great effort! You did your best and gained valuable practice.\n                <br><br>\n                Keep playing to improve your skills and speed!\n            </p>\n            <button onclick="exitArcadeCompletion()" class="start-button" style="margin-top: 1.5rem;">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(e),requestAnimationFrame((()=>e.classList.add("show")))}function fn(e){const t=Bt.playerName,n=e.find((e=>e.username===t));if(Bt.winnerScreenShown&&n&&n.rank<=3)return;let s;if(n)s=n.rank;else{s=[...Bt.participants].sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).findIndex((e=>e.username===t))+1}s<=3?gn(s):pn()}function gn(e){if(Bt.winnerScreenShown)return;Bt.winnerScreenShown=!0;const n=document.createElement("div");n.className="arcade-completion-modal";const s={1:{title:"🏆 FIRST PLACE! 🏆",message:"Incredible! You've claimed the top spot!",color:"var(--gold)"},2:{title:"🥈 SECOND PLACE! 🥈",message:"Amazing job! You've secured second place!",color:"var(--silver)"},3:{title:"🥉 THIRD PLACE! 🥉",message:"Well done! You've earned third place!",color:"var(--bronze)"}}[e]||{title:"Game Complete!",message:"You've reached the word goal!",color:"var(--accent)"},r=Bt.initialCoins||0,o=($.coins||U.coins||0)-r;n.innerHTML=`\n        <div class="completion-modal-content">\n            <h2 style="color: ${s.color}">${s.title}</h2>\n            <p>${s.message}</p>\n            <div class="completion-stats">\n                <div class="stat-item">\n                    <i class="fas fa-language"></i>\n                    <span>Words Learned</span>\n                    <strong>${U.wordsCompleted}</strong>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-coins"></i>\n                    <span>Coins Earned</span>\n                    <strong>${o}</strong>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-trophy"></i>\n                    <span>Your Rank</span>\n                    <strong>${e}</strong>\n                </div>\n            </div>\n            <button class="victory-button" style="margin-top: 2rem;" onclick="closePersonalVictory()">\n            Continue\n        </button>\n        </div>\n    `,document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",Ns()}),100)}function yn(e){cs&&clearTimeout(cs),ls&&clearInterval(ls);const t=document.querySelector(".inactivity-overlay");t&&t.remove(),Ms(e)}function hn(e){const t=Bt.playerName,n=e.find((e=>e.username===t)),s=n?.rank||e.findIndex((e=>e.username===t))+1;if(Bt.winnerScreenShown&&s<=3)return;const r=document.createElement("div");r.className="arcade-completion-modal";const o=e.filter((e=>e.rank<=3)).sort(((e,t)=>e.rank-t.rank)),a=Bt.initialCoins||0,i=($.coins||U.coins||0)-a;r.innerHTML=`\n        <div class="completion-modal-content">\n            <h2>Arcade Game Complete!</h2>\n            ${s<=3?`<p class="personal-result">Congratulations! You finished in ${as(s)} place!</p>`:`<p class="personal-result">You earned ${as(s)} place. Better luck next time!</p>`}\n            <div class="leaderboard-preview">\n                <h3>Top Players</h3>\n                ${o.map((e=>`\n                    <div class="podium-player rank-${e.rank} ${e.username===t?"current-player":""}"\n                         style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.5rem 0; \n                                background: ${function(e,t){const n={1:"linear-gradient(135deg, #FFD700 0%, #FFC800 100%)",2:"linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%)",3:"linear-gradient(135deg, #CD7F32 0%, #B87333 100%)"};if(t)return(n[e]||"rgba(255,255,255,0.1)")+"; border: 2px solid white; box-shadow: 0 0 15px rgba(255,255,255,0.5)";return n[e]||"rgba(255,255,255,0.1)"}(e.rank,e.username===t)};\n                                border-radius: 10px; color: ${1===e.rank?"#000":"#fff"};">\n                        <div class="player-rank">${e.rank}</div>\n                        <div class="player-name">${e.username}</div>\n                        <div class="player-stats">\n                            <span class="player-words">${e.wordsCompleted||0} words</span>\n                            <span class="player-coins">${e.coins||0} coins</span>\n                        </div>\n                    </div>\n                `)).join("")}\n                \n                ${s>3?`\n                    <div class="divider" style="border-top: 1px dashed rgba(255,255,255,0.2); margin: 1rem 0;"></div>\n                    <div class="current-player-row podium-player"\n                         style="display: flex; justify-content: space-between; padding: 0.75rem 1rem; margin: 0.5rem 0; \n                                background: rgba(255,255,255,0.1); border: 1px solid var(--accent);\n                                border-radius: 10px; color: var(--text);">\n                        <div class="player-rank">${s}</div>\n                        <div class="player-name">${t}</div>\n                        <div class="player-stats">\n                            <span class="player-words">${n?.wordsCompleted||0} words</span>\n                            <span class="player-coins">${n?.coins||0} coins</span>\n                        </div>\n                    </div>\n                `:""}\n            </div>\n            <div class="your-stats">\n                <h3>Your Results</h3>\n                <div class="completion-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0;">\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-language" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Words Learned</span>\n                        <strong style="font-size: 1.5rem;">${n?.wordsCompleted||0}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Coins Earned</span>\n                        <strong style="font-size: 1.5rem;">${i}</strong>\n                    </div>\n                    <div class="stat-item" style="text-align: center;">\n                        <i class="fas fa-trophy" style="font-size: 2rem; color: var(--gold); display: block; margin-bottom: 0.5rem;"></i>\n                        <span style="display: block; margin-bottom: 0.25rem;">Your Rank</span>\n                        <strong style="font-size: 1.5rem;">${s}</strong>\n                    </div>\n                </div>\n            </div>\n            <button onclick="exitArcadeCompletion()" class="start-button">\n                Return to Welcome\n            </button>\n        </div>\n    `,document.body.appendChild(r),requestAnimationFrame((()=>r.classList.add("show")))}function vn(e){Bt.participants=Bt.participants.filter((t=>t.username!==e)),window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"player_removed",payload:{username:e}}),Xt()}function wn(){const e=document.querySelector(".side-panel"),t=document.querySelector(".hamburger-button"),n=document.querySelector(".vertical-nav-container"),s=document.querySelector(".modal-overlay");e.classList.contains("open")?(e.classList.remove("open"),t.classList.remove("open"),n.classList.remove("panel-open"),s&&s.classList.remove("open")):(e.classList.add("open"),t.classList.add("open"),n.classList.add("panel-open"),s&&s.classList.add("open"))}function bn(){const e={hamburger:document.querySelector(".hamburger-button:not(.vertical-nav-container .hamburger-button)"),home:document.querySelector(".home-button:not(.vertical-nav-container .home-button)"),fullscreen:document.querySelector(".fullscreen-button:not(.vertical-nav-container .fullscreen-button)"),reset:document.querySelector(".reset-button:not(.vertical-nav-container .reset-button)"),settings:document.querySelector(".settings-button:not(.vertical-nav-container .settings-button)"),accessibility:document.querySelector(".accessibility-toggle")};let t=document.querySelector(".vertical-nav-container");t||(t=document.createElement("div"),t.className="vertical-nav-container",document.body.appendChild(t)),t.innerHTML="";const n=document.createElement("button");n.className="hamburger-button",n.id="nav-hamburger-btn",n.innerHTML='<i class="fas fa-bars"></i>',n.onclick=wn,t.appendChild(n);const s=document.createElement("button");s.className="nav-button home-button",s.id="nav-home-btn",s.innerHTML='<i class="fas fa-home"></i>',s.onclick=Ct||function(){Z("welcome-screen")},t.appendChild(s);const r=document.createElement("button");r.className="nav-button fullscreen-button",r.id="nav-fullscreen-btn",r.innerHTML='<i class="fas fa-expand"></i>',r.onclick=$e,t.appendChild(r);const o=document.createElement("button");o.className="nav-button reset-button",o.id="nav-reset-btn",o.innerHTML='<i class="fas fa-trash-alt"></i>',o.onclick=Me,t.appendChild(o);const a=document.createElement("button");a.className="nav-button settings-button",a.id="nav-settings-btn",a.innerHTML='<i class="fas fa-cog"></i>',a.onclick=function(){const e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(a);const i=document.createElement("button");i.className="nav-button accessibility-button",i.id="nav-accessibility-btn",i.innerHTML='<i class="fas fa-universal-access"></i>',i.onclick=function(){const e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(i),Object.values(e).forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}))}function Sn(){const e=document.getElementById("authModal");e&&e.classList.add("open")}function kn(){const e=document.getElementById("authModal");e&&e.classList.remove("open")}function _(){document.querySelector(".side-panel");const e=document.querySelector(".user-profile-section"),t=document.getElementById("userEmail"),n=document.querySelector(".logout-button"),s=document.querySelector(".main-button");currentUser?(e&&(e.style.display="block"),n&&(n.style.display="block"),t&&(t.textContent=currentUser.user_metadata?.username||currentUser.email),s&&(s.style.display="none"),St()):(e&&(e.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="block"))}function Sn(){const e=document.getElementById("authModal");e&&e.classList.add("show")}function kn(){const e=document.getElementById("authModal");e&&e.classList.remove("show")}function je(){const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e.classList.toggle("hidden"),t.classList.toggle("hidden")}function xn(){const e=document.querySelector(".guest-play-button");!currentUser||currentUser&&"unregistered"===currentUser.status?e.textContent="Play as Guest":e.textContent="Start Game"}function Ln(){alert("Prices screen coming soon!")}function Cn(){alert("Rights & Policies page coming soon!")}function En(){alert("About page coming soon!")}function In(){alert("Contact Us page coming soon!")}function qn(e,t,n,s=500){if((t=Number(t))===(n=Number(n)))return void(e.textContent=n);const r=(n-t)/30;let o=t,a=0;requestAnimationFrame((function t(){o+=r,a++,a>=30||r>0&&o>=n||r<0&&o<=n?e.textContent=Math.round(n):(e.textContent=Math.round(o),requestAnimationFrame(t))}))}function Tn(e,t){const n=document.createElement("div");n.className=`game-notification ${t}`,n.textContent=e,document.body.appendChild(n),setTimeout((()=>n.classList.add("show")),10),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>n.remove()),300)}),2e3)}function G(e,t,n){const s="blessing"===n?["#3498db","#2980b9","#1abc9c"]:["#e74c3c","#c0392b","#d35400"];for(let r=0;r<15;r++){const r=document.createElement("div");r.className=`particle ${n}`;const o=8*Math.random()+4,a=Math.random()*Math.PI*2,i=100*Math.random()+50;r.style.width=`${o}px`,r.style.height=`${o}px`,r.style.borderRadius="50%",r.style.backgroundColor=s[Math.floor(Math.random()*s.length)],r.style.position="fixed",r.style.left=`${e}px`,r.style.top=`${t}px`,document.body.appendChild(r);const c=e+Math.cos(a)*i,l=t+Math.sin(a)*i;r.animate([{transform:"translate(0, 0) scale(1)",opacity:1},{transform:`translate(${c-e}px, ${l-t}px) scale(0)`,opacity:0}],{duration:1e3,easing:"cubic-bezier(0.4, 0, 0.2, 1)"}).onfinish=()=>r.remove()}}async function _n(){const e=document.getElementById("arcadeUsername"),t=document.getElementById("otpInput");let n;if(currentUser)n=currentUser.user_metadata?.username||currentUser.email.split("@")[0];else{if(n=e.value.trim(),!n||n.length<2||n.length>15)return Xe("Username must be between 2 and 15 characters"),void e.focus();if(!/^[a-zA-Z0-9\u0590-\u05FF\s._-]+$/.test(n))return Xe("Username can contain letters, numbers, spaces, periods, underscores, and hyphens"),void e.focus()}const s=t.value.trim();if(!s||4!==s.length||!/^\d+$/.test(s))return Xe("Please enter a valid 4-digit game code"),void t.focus();try{let e=0;if(currentUser)try{const{data:t,error:n}=await p.from("game_progress").select("coins").eq("user_id",currentUser.id).single();!n&&t&&(e=t.coins)}catch(e){}window.arcadeChannel=p.channel(`arcade:${s}`),Bt.playerName=n,Bt.initialCoins=e,Bt.otp=s,await window.arcadeChannel.subscribe(),Bs(),window.arcadeChannel.on("broadcast",{event:"game_end"},(({payload:e})=>{un(e),Bt.state="ended"})).on("broadcast",{event:"game_playing"},(({payload:e})=>{"active"===e.state&&(Bt.state="active",Bt.wordPool=e.wordPool,Bt.wordGoal=e.wordGoal,Kt())})).on("broadcast",{event:"player_join"},(({payload:e})=>{if(!Bt.participants.find((t=>t.username===e.username))){Bt.participants.push({username:e.username,wordsCompleted:0,coins:0});const t=document.getElementById("player-count");t&&(t.textContent=Bt.participants.length);const n=document.getElementById("arcade-leaderboard");n&&null!==n.offsetParent&&Xt()}})),window.arcadeChannel.on("broadcast",{event:"game_state_response"},(({payload:e})=>{e&&"active"===e.state&&(Bt.state="active",Bt.wordPool=e.wordPool,Bt.wordGoal=e.wordGoal,Bt.joinEventSent&&(document.getElementById("arcade-modal").style.display="none",Kt()))})),await window.arcadeChannel.send({type:"broadcast",event:"player_join",payload:{username:n,type:"initialJoin",coins:e,joinedAt:(new Date).toISOString()}}),Bt.joinEventSent=!0,await window.arcadeChannel.send({type:"broadcast",event:"check_game_status",payload:{username:n,requestType:"lateJoin",timestamp:Date.now()}}),document.getElementById("arcade-modal").style.display="none",setTimeout((()=>{"active"!==Bt.state&&Ot()}),500)}catch(e){Xe("Failed to join arcade. Please try again.")}}document.addEventListener("DOMContentLoaded",bn),document.addEventListener("click",(e=>{const t=document.getElementById("authModal"),n=t?.querySelector(".auth-modal-content"),s=document.getElementById("arcade-modal"),r=s?.querySelector(".modal-content");!t?.classList.contains("show")||n.contains(e.target)||e.target.matches(".main-button")||kn(),"block"!==s?.style.display||r.contains(e.target)||e.target.matches(".arcade-button")||(s.style.display="none")}));const Mn={highFive:{id:"highFiveCard",cost:30,effect:50,type:"goodie",icon:"fa-hand-paper",name:"High Five",message:"high-fived"},fistBump:{id:"fistBumpCard",cost:40,effect:75,type:"goodie",icon:"fa-fist-raised",name:"Fist Bump",message:"fist-bumped"},energyBoost:{id:"energyBoostCard",cost:45,type:"goodie",icon:"fa-bolt",name:"Energy Boost",message:"boosted"},freeze:{id:"freezeCard",cost:150,duration:1e4,type:"baddie",icon:"fa-snowflake",name:"Freeze",message:"froze"},coinStorm:{id:"coinStormCard",cost:160,duration:3,type:"baddie",icon:"fa-cloud-showers-heavy",name:"Coin Storm",message:"cast a coin storm on"},screenShake:{id:"screenShakeCard",cost:130,duration:5e3,type:"baddie",icon:"fa-shake",name:"Screen Shake",message:"shook"}};function $n(){const e={highFive:{id:"highFiveCard",cost:30,effect:50,type:"goodie",icon:"fa-hand-paper",name:"High Five",message:"high-fived"},fistBump:{id:"fistBumpCard",cost:40,effect:75,type:"goodie",icon:"fa-fist-raised",name:"Fist Bump",message:"fist-bumped"},energyBoost:{id:"energyBoostCard",cost:45,type:"goodie",icon:"fa-bolt",name:"Energy Boost",message:"boosted"},freeze:{id:"freezeCard",cost:150,duration:1e4,type:"baddie",icon:"fa-snowflake",name:"Freeze",message:"froze"},coinStorm:{id:"coinStormCard",cost:160,type:"baddie",icon:"fa-cloud-showers-heavy",name:"Coin Storm",message:"cast a coin storm on"},screenShake:{id:"screenShakeCard",cost:130,duration:5e3,type:"baddie",icon:"fa-shake",name:"Screen Shake",message:"shook"}};function t(){document.querySelectorAll(".powerup-card").forEach((e=>{const t=e.querySelector(".powerup-cost");if(!t)return;const n=parseInt(t.textContent),s=U.coins>=n;e.classList.toggle("disabled",!s),e.style.cursor=s?"pointer":"not-allowed",e.style.opacity=s?"1":"0.5"}))}const n=document.querySelector(".powerups-container");if(!n)return;n.innerHTML="",function(t=3){const n=Object.keys(e),s=[];for(;s.length<t&&n.length>0;){const e=Math.floor(Math.random()*n.length);s.push(n.splice(e,1)[0])}return s}(3).forEach((t=>{const s=e[t],r=document.createElement("div");r.className=`powerup-card ${s.type}`,r.id=s.id,r.innerHTML=`\n            <i class="fas ${s.icon} powerup-icon"></i>\n            <div class="powerup-name">${s.name}</div>\n            <div class="powerup-cost">${s.cost}</div>\n        `,r.onclick=async()=>{if(U.coins<s.cost)return void Tn("Not enough coins!","error");const e=Bt.participants.filter((e=>e.username!==Bt.playerName&&void 0!==e.username&&null!==e.username));if(0===e.length)return void Tn("Waiting for other players to join...","info");const n=e[Math.floor(Math.random()*e.length)],r=U.coins;U.coins-=s.cost,document.querySelectorAll(".coin-count").forEach((e=>{e.textContent=U.coins}));try{await window.arcadeChannel.send({type:"broadcast",event:"powerup_effect",payload:{powerupKey:t,targetUser:n.username,fromUser:Bt.playerName,powerup:s}}),Tn(`Used ${s.name} on ${n.username}!`,s.type),await window.arcadeChannel.send({type:"broadcast",event:"progress_update",payload:{username:Bt.playerName,wordsCompleted:U.wordsCompleted,coins:U.coins,timestamp:Date.now()}}),$n()}catch(e){U.coins=r,document.querySelectorAll(".coin-count").forEach((e=>{e.textContent=r})),Tn("Failed to use powerup!","error")}wo()},n.appendChild(r)})),t();const s=document.querySelector(".coin-count");if(s){new MutationObserver((()=>{t()})).observe(s,{childList:!0,characterData:!0,subtree:!0})}return t}function An(){document.querySelectorAll(".powerup-card").forEach((e=>{const t=e.querySelector(".powerup-cost");if(!t)return;const n=parseInt(t.textContent),s=U.coins>=n;e.classList.toggle("disabled",!s),e.style.cursor=s?"pointer":"not-allowed",e.style.opacity=s?"1":"0.5"}))}function Pn(){const e=document.querySelectorAll(".powerup-card"),t=U.coins||0;e.forEach((e=>{const n=e.querySelector(".powerup-cost");if(!n)return;const s=parseInt(n.textContent),r=t>=s;e.classList.toggle("disabled",!r),e.style.opacity=r?"1":"0.5",e.style.cursor=r?"pointer":"not-allowed"}))}function Bn(){const e=U.coins||0;document.querySelectorAll(".coin-count").forEach((t=>{const n=parseInt(t.textContent)||0;n!==e&&J(t,n,e)})),An()}function Un(e){const t=`${window.location.origin+window.location.pathname}#join=${e}`;new QRious({element:document.getElementById("qrCode"),value:t,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"})}function Nn(){if(window.location.hash.startsWith("#join=")){const e=window.location.hash.replace("#join=","");if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const t=document.getElementById("qr-landing"),n=t.querySelector(".game-code-display");document.querySelectorAll(".screen").forEach((e=>{e.style.display="none"})),t.style.display="flex",n.textContent=e,t.dataset.otp=e}else history.pushState("",document.title,window.location.pathname),f(e)}}function Fn(){const e=document.getElementById("qr-landing"),t=e.dataset.otp;e.style.display="none",f(t)}function Tn(e,t="info"){const n=document.createElement("div");n.className=`game-notification ${t}`,n.textContent=e,document.body.appendChild(n),requestAnimationFrame((()=>n.classList.add("show"))),setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>n.remove()),300)}),3e3)}function Dn(e){const t=document.getElementById("loginForm"),n=document.getElementById("signupForm");"signup"===e?(t.classList.add("hidden"),n.classList.remove("hidden")):(t.classList.remove("hidden"),n.classList.add("hidden"))}async function zn(e){if("teacher"===!currentUser?.role)return;const t={id:Date.now(),name:"Combined List",words:[],translations:[],isTeacherList:!0};for(const n of e){const e=ze.lists.find((e=>e.id===n));e&&(t.words.push(...e.words),t.translations.push(...e.translations))}return t}async function Hn(e){if("teacher"===!currentUser?.role)return;const t=ze.lists.find((t=>t.id===e));if(!t)return;return{wordPool:t.words.map(((e,n)=>({word:e,translation:t.translations[n]}))),isCustomArcade:!0,teacherId:currentUser.id,listId:e}}function Rn(){const{container:e,display:t}=Tr();document.getElementById("question-screen").appendChild(e),U.bossFirstHealthRestored=!1,U.bossSecondHealthRestored=!1,Ir(),document.querySelectorAll(".perk-button").forEach((e=>{if(e){e.disabled=!0,e.style.opacity="0.3";const t=document.createElement("div");t.className="perk-disabled",t.innerHTML="❌",t.style.cssText="\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 1.5em;\n                color: red;\n                pointer-events: none;\n            ",e.style.position="relative",e.appendChild(t)}}));const n=document.querySelector(".progress-circle");if(n){const e=n.querySelector(".progress");e&&(e.style.stroke="#4CAF50")}U.updateBossTimer=e=>{_r(document.querySelector("#boss-timer div"),e)},setTimeout(Ir,100),setTimeout(Ir,500)}function On(){const e=document.querySelector(".coins-container");if(!e)return;const t=document.createElement("div");t.className="boss-orb",t.innerHTML='<div class="boss-orb-inner"></div>',t.style.cssText="\n    position: absolute;\n    width: 60px;\n    height: 60px;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 10;\n  ",t.querySelector(".boss-orb-inner").style.cssText="\n    width: 50px;\n    height: 50px;\n    background: radial-gradient(circle at 30% 30%, #ff3333, #990000);\n    border-radius: 50%;\n    box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);\n    animation: pulseOrb 2s infinite;\n  ";const n=document.createElement("style");n.innerHTML="\n    @keyframes pulseOrb {\n      0%, 100% { transform: scale(1); filter: brightness(1); }\n      50% { transform: scale(1.1); filter: brightness(1.2); }\n    }\n  ",document.head.appendChild(n),e.innerHTML="",e.appendChild(t)}function jn(){const e=document.querySelector(".progress-circle");if(!e)return;const t=e.querySelector(".progress");if(!t)return;t.style.stroke="#4CAF50";const n=document.createElement("style");n.innerHTML="\n    .progress.warning {\n      animation: healthWarning 0.8s infinite alternate;\n    }\n    @keyframes healthWarning {\n      from { stroke: #ff3333; }\n      to { stroke: #ffffff; }\n    }\n  ",document.head.appendChild(n)}function Wn(){const e=document.getElementById("boss-level-style");e&&e.remove();const t=document.createElement("style");t.id="boss-level-style",t.innerHTML="\n    .boss-mode {\n      background: linear-gradient(135deg, #800000, #3a0000) !important;\n    }\n    \n    @keyframes pulseBg {\n      0%, 100% { filter: brightness(1); }\n      50% { filter: brightness(1.2); }\n    }\n    \n    .boss-orb {\n      position: relative;\n      width: 60px;\n      height: 60px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    \n    .boss-orb-inner {\n      width: 50px;\n      height: 50px;\n      background: radial-gradient(circle at 30% 30%, #ff3333, #990000);\n      border-radius: 50%;\n      position: relative;\n      box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);\n      animation: pulseOrb 2s infinite;\n    }\n    \n    .boss-orb-glow {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 70%);\n      animation: rotateGlow 3s linear infinite;\n    }\n    \n    @keyframes pulseOrb {\n      0%, 100% { transform: scale(1); filter: brightness(1); }\n      50% { transform: scale(1.1); filter: brightness(1.2); }\n    }\n    \n    @keyframes rotateGlow {\n      0% { transform: rotate(0deg); }\n      100% { transform: rotate(360deg); }\n    }\n    \n    .boss-health {\n      transition: stroke 0.3s ease, stroke-dashoffset 0.5s ease;\n    }\n    \n    .boss-health.warning {\n      animation: healthWarning 0.8s infinite alternate;\n    }\n    \n    @keyframes healthWarning {\n      from { stroke: #ff3333; }\n      to { stroke: #ffffff; }\n    }\n    \n    .boss-word {\n      color: #ff3333;\n      text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);\n      animation: pulseWord 2s infinite;\n    }\n    \n    @keyframes pulseWord {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.05); }\n    }\n    \n    .boss-hit {\n      animation: bossHitEffect 0.3s;\n    }\n    \n    @keyframes bossHitEffect {\n      0% { transform: scale(1); }\n      50% { transform: scale(1.02); filter: brightness(1.3); }\n      100% { transform: scale(1); }\n    }\n    \n    .boss-orb-hit {\n      animation: bossOrbHit 0.3s;\n    }\n    \n    @keyframes bossOrbHit {\n      0% { transform: scale(1); }\n      50% { transform: scale(1.3); filter: brightness(1.5); }\n      100% { transform: scale(1); }\n    }\n    \n    .boss-restore-health {\n      animation: bossRestoreHealth 1s;\n    }\n    \n    @keyframes bossRestoreHealth {\n      0% { filter: brightness(1); }\n      50% { filter: brightness(2); }\n      100% { filter: brightness(1); }\n    }\n    \n    .boss-defeated {\n      animation: bossDefeated 2s forwards;\n    }\n    \n    @keyframes bossDefeated {\n      0% { transform: scale(1); opacity: 1; }\n      50% { transform: scale(1.5); opacity: 0.7; filter: brightness(2); }\n      100% { transform: scale(0); opacity: 0; }\n    }\n    \n    .raining-letter {\n      position: absolute;\n      color: rgba(255, 0, 0, 0.3);\n      font-size: 16px;\n      animation: letterRain linear forwards;\n      z-index: 1;\n    }\n    \n    @keyframes letterRain {\n      0% { transform: translateY(-20px); opacity: 0; }\n      10% { opacity: 0.7; }\n      90% { opacity: 0.7; }\n      100% { transform: translateY(100vh); opacity: 0; }\n    }\n    \n    .boss-victory {\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: linear-gradient(135deg, #00c6ff, #0072ff);\n      padding: 2rem;\n      border-radius: 20px;\n      text-align: center;\n      box-shadow: 0 0 30px rgba(0, 198, 255, 0.5);\n      z-index: 1000;\n      max-width: 500px;\n      width: 90%;\n    }\n    \n    .boss-victory h2 {\n      font-size: 2rem;\n      color: white;\n      margin-bottom: 1rem;\n    }\n    \n    .boss-victory p {\n      font-size: 1.2rem;\n      color: rgba(255, 255, 255, 0.9);\n      margin-bottom: 2rem;\n    }\n    \n    .victory-buttons {\n      display: flex;\n      justify-content: center;\n      gap: 1rem;\n    }\n    \n.victory-button {\n    background: var(--accent);\n    color: var(--text);\n    border: none;\n    padding: 1rem 2.5rem;\n    border-radius: 50px;\n    font-size: 1.2rem;\n    font-weight: 600;\n    cursor: pointer;\n    transition: all 0.3s ease;\n    box-shadow: 0 5px 15px rgba(30, 144, 255, 0.3);\n    margin-top: 1.5rem;\n    min-width: 200px;\n}\n\n.victory-button:hover {\n    transform: translateY(-3px);\n    background: color-mix(in srgb, var(--accent) 80%, white);\n    box-shadow: 0 8px 20px rgba(30, 144, 255, 0.5);\n}\n\n.victory-button:active {\n    transform: translateY(1px);\n    box-shadow: 0 3px 10px rgba(30, 144, 255, 0.3);\n}\n    \n    .victory-button.continue {\n      background: #4CAF50;\n      color: white;\n    }\n    \n    .victory-button.home {\n      background: rgba(255, 255, 255, 0.2);\n      color: white;\n      border: 2px solid white;\n    }\n    \n   \n    \n    .incineration-effect {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: radial-gradient(circle, #ff9900, #ff3300);\n      opacity: 0;\n      transform: scale(0);\n      animation: incinerateEffect 2s forwards;\n    }\n    \n    @keyframes incinerateEffect {\n      0% { transform: scale(0); opacity: 0; }\n      10% { transform: scale(0.5); opacity: 0.8; }\n      50% { transform: scale(1.5); opacity: 1; }\n      100% { transform: scale(3); opacity: 0; }\n    }\n  ",document.head.appendChild(t)}function Gn(){if(!U.isBossLevel)return!1;const e=document.querySelector(".progress-circle");if(!e)return!1;const t=e.querySelector(".progress");if(!t)return!1;const n=U.words.length,s=U.currentIndex||0,r=Math.max(0,n-s)/n,o=2*Math.PI*54;t.style.strokeDashoffset=o*(1-r);const a=document.querySelector(".boss-orb-inner");if(a){const e=5,t=50,n=Math.max(e,t*r);a.style.width=`${n}px`,a.style.height=`${n}px`,a.style.left=50-n/2+"%",a.style.top=50-n/2+"%"}if(r>.66)t.style.stroke="#4CAF50",t.classList.remove("warning");else if(r>.33){if(t.style.stroke="#FFA500",t.classList.remove("warning"),r<=.66&&!U.bossFirstHealthRestored){U.bossFirstHealthRestored=!0,a&&(a.style.background="radial-gradient(circle at 30% 30%, white, #FFEB3B)",a.style.transform="scale(1.3)",a.style.filter="brightness(1.8)",setTimeout((()=>{a.style.transform="",a.style.filter="",a.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3));const e=Math.floor(.25*n);U.currentIndex=e,setTimeout((()=>Gn()),100)}}else if(t.style.stroke="#FF3333",t.classList.add("warning"),r<=.33&&!U.bossSecondHealthRestored){U.bossSecondHealthRestored=!0,a&&(a.style.background="radial-gradient(circle at 30% 30%, white, #4CAF50)",a.style.transform="scale(1.3)",a.style.filter="brightness(1.8)",setTimeout((()=>{a.style.transform="",a.style.filter="",a.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3));const e=Math.floor(.5*n);U.currentIndex=e,setTimeout((()=>Gn()),100)}return r<=0&&!U.bossDefeated&&(U.bossDefeated=!0,!0)}function Jn(){De(21,(()=>{Rn(),O(8*U.words.length),Yn()}))}function Yn(){setTimeout(Ir,100),Mr(),$r();const e=document.getElementById("question-word");e&&(e.style.setProperty("color","#ff3333","important"),e.style.setProperty("text-shadow","0 0 10px rgba(255, 0, 0, 0.5)","important"),e.style.setProperty("animation","pulseWord 2s infinite","important"));try{U.currentIndex>0&&e?(e.classList.add("exiting"),setTimeout((()=>{pe(),e.classList.remove("exiting"),e.classList.add("entering"),setTimeout((()=>{e.classList.remove("entering")}),500)}),500)):pe(),setTimeout((()=>{Gn()}),50);const t=document.getElementById("buttons");if(t&&Math.random()<.3){Array.from(t.children).sort((()=>Math.random()-.5)).forEach((e=>{t.appendChild(e)}))}}catch(e){}}function Xn(){const e=document.getElementById("question-screen");e&&(e.removeAttribute("style"),e.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)");const t=document.getElementById("question-word");if(t&&t.removeAttribute("style"),window.originalCoinsHTML){const e=document.querySelector(".coins-container");e&&(e.innerHTML=window.originalCoinsHTML)}"function"==typeof Ar&&Ar()}function Vn(){let e=Date.now();setInterval((()=>{Date.now()-e>6e4&&Zn()}),1e4),["mousemove","keypress","click"].forEach((t=>{document.addEventListener(t,(()=>{e=Date.now()}))})),window.addEventListener("beforeunload",(()=>{window.arcadeChannel&&window.arcadeChannel.send({type:"broadcast",event:"player_left",payload:{username:Bt.playerName}})}))}function Zn(){window.arcadeChannel.send({type:"broadcast",event:"player_inactive",payload:{username:Bt.playerName}})}function Qn(e){const t=Bt.participants.sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).findIndex((t=>t.username===e.username))+1;t<=3&&(showPersonalizedCompletion(t),3===t&&window.arcadeChannel.send({type:"broadcast",event:"game_complete",payload:{topThree:Bt.participants.sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).slice(0,3)}}))}async function Kn(e){if(Bt.completedPlayers.includes(e))return;const t=Date.now();Bt.completedPlayers.push(e);let n=0;const s=Bt.completedPlayers.indexOf(e);s<3&&(n=s+1,Bt.podiumRanks||(Bt.podiumRanks={}),Bt.podiumRanks[e]={rank:n,completionTime:t});const r=Bt.participants.find((t=>t.username===e));r&&(n>0&&(r.rank=n,r.completionTime=t),r.wordsCompleted=U.wordsCompleted,r.coins=$.coins||U.coins||0,r.completed=!0),await window.arcadeChannel.send({type:"broadcast",event:"player_completed",payload:{username:e,rank:n,wordsCompleted:U.wordsCompleted,coins:$.coins||U.coins||0,timestamp:t,completed:!0}}),e===Bt.playerName&&n>0&&gn(n),Bt.completedPlayers.length>=3&&await rs()}function es(){if(bs.isGameActive=!1,Bt.celebrationTriggered=!0,Bt.state="ended",Bt.endTime=Date.now(),Bt.participants.length>=3){const e=[...Bt.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)).slice(0,3).map(((e,t)=>({...e,rank:t+1,completionTime:Date.now()-1e3*t})));window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",podiumPlayers:e,teacherId:Bt.teacherId,forcedEnd:!1,duration:Bt.endTime-(Bt.startTime||Bt.endTime)}}),Ms(e)}else window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",forcedEnd:!0,teacherId:Bt.teacherId}}),Z("welcome-screen");ts(),window.arcadeChannel&&(window.arcadeChannel.unsubscribe(),window.arcadeChannel=null)}function ts(){const e=Math.floor(1e3+9e3*Math.random()).toString();window.arcadeTimeouts&&window.arcadeTimeouts.forEach((e=>clearTimeout(e))),window.arcadeIntervals&&window.arcadeIntervals.forEach((e=>clearInterval(e))),window.celebrationConfettiInterval&&clearInterval(window.celebrationConfettiInterval),window.playerConfettiInterval&&clearInterval(window.playerConfettiInterval),Bt={eventId:null,otp:e,wordPool:[],participants:[],teacherId:currentUser?.id||null,wordGoal:50,state:"pre-start",completedPlayers:[],playerRank:null,winnerScreenShown:!1,startTime:null,endTime:null,podiumRanks:{},isInitialized:!1,initialCoins:0,playerName:null,joinEventSent:!1,celebrationTriggered:!1},ds=Date.now(),window.arcadeChannel&&(window.arcadeChannel.unsubscribe(),window.arcadeChannel=null);const t=document.getElementById("arcade-leaderboard");if(t){const e=t.querySelector(".leaderboard-header");t.innerHTML=e?e.outerHTML:""}const n=document.getElementById("moderatorOtp");n&&(n.textContent=e);const s=document.getElementById("qrCode");if(s){const t=`${window.location.origin+window.location.pathname}#join=${e}`;new QRious({element:s,value:t,size:200,backgroundAlpha:1,foreground:"#16213e",background:"#ffffff",level:"H"})}Bt.eventId&&(p.from("arcade_events").update({status:"waiting",game_state:{},otp:e}).eq("id",Bt.eventId).then((({error:e})=>{})),p.from("arcade_participants").delete().eq("event_id",Bt.eventId).then((({error:e})=>{})));const r=document.querySelector(".end-arcade-button");r&&r.classList.remove("visible"),document.querySelectorAll(".celebration-overlay, .home-button-container").forEach((e=>e.remove())),U={currentIndex:0,correctStreak:0,wrongStreak:0,words:[],wordsCompleted:0,coins:0,lastBroadcast:Date.now()},document.querySelectorAll('.stage-checkboxes input[type="checkbox"]').forEach((e=>{e.checked=!1}));const o=document.getElementById("wordGoalInput"),a=document.getElementById("wordGoalSlider"),i=document.getElementById("wordGoalDisplay");o&&(o.value="50"),a&&(a.value="50"),i&&(i.textContent="50")}function ns(){document.querySelector(".celebration-overlay")?.remove(),document.querySelector(".home-button-container")?.remove(),window.celebrationConfettiInterval&&clearInterval(window.celebrationConfettiInterval),document.querySelectorAll(".confetti, .celebration-emoji, .winner-entry.celebrating").forEach((e=>e.remove())),_s(),ts(),Z("welcome-screen")}function un(e){if(e)if(e.forcedEnd)Z("welcome-screen");else if(currentUser?.id!==e.teacherId)fn(e.podiumPlayers||[]);else{yn(e.podiumPlayers||[])}}function ss(){const e=document.querySelector(".arcade-completion-modal");e&&(e.classList.remove("show"),setTimeout((()=>{document.body.removeChild(e)}),300))}async function rs(){Bt.state="ended",Bt.endTime=Date.now();const e=[];for(Bt.podiumRanks&&(Object.entries(Bt.podiumRanks).forEach((([t,n])=>{const s=Bt.participants.find((e=>e.username===t));s&&e.push({username:s.username,wordsCompleted:s.wordsCompleted||0,coins:s.coins||0,rank:n.rank,completionTime:n.completionTime})})),e.sort(((e,t)=>e.rank-t.rank)));e.length<3;){const t=e.length+1;e.push({username:"---",wordsCompleted:0,coins:0,rank:t})}await window.arcadeChannel.send({type:"broadcast",event:"game_end",payload:{state:"ended",podiumPlayers:e,teacherId:Bt.teacherId,duration:Bt.endTime-(Bt.startTime||Bt.endTime)}}),currentUser?.id===Bt.teacherId?yn(e):fn(e)}function os(e){currentUser?.id===Bt.teacherId?yn(e):hn(e)}function as(e){const t=["th","st","nd","rd"],n=e%100;return e+(t[(n-20)%10]||t[n]||t[0])}function is(){let e=Date.now(),t=!1,n=null,s=null;function r(){e=Date.now(),t&&a()}const o=setInterval((()=>{if("active"!==Bt.state||currentUser?.id!==Bt.teacherId)return void clearInterval(o);Date.now()-e>5e3&&!t&&function(){t=!0;let e=5;s=document.createElement("div"),s.className="idle-timer-overlay",s.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.7);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 2000;\n            pointer-events: none;\n        ";const r=document.createElement("div");r.style.cssText="\n            background: var(--primary-dark);\n            padding: 2rem;\n            border-radius: 20px;\n            border: 2px solid var(--gold);\n            text-align: center;\n        ";const o=document.createElement("h2");o.textContent="Game Inactive",o.style.color="var(--gold)";const i=document.createElement("div");i.className="countdown-timer",i.textContent=e,i.style.cssText="\n            font-size: 5rem;\n            color: var(--gold);\n            margin: 1rem 0;\n            font-weight: bold;\n        ";const c=document.createElement("p");c.textContent="No activity detected. Returning to welcome screen...",r.appendChild(o),r.appendChild(i),r.appendChild(c),s.appendChild(r),document.body.appendChild(s),n=setInterval((()=>{e--,i.textContent=e,e<=0&&function(){a();const e=Bt.participants.filter((e=>e.wordsCompleted>=Bt.wordGoal));if(e.length>=3){const t=[...e].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins)).slice(0,3).map(((e,t)=>({...e,rank:t+1})));Bt.state="ended",yn(t)}else Z("welcome-screen")}()}),1e3)}()}),1e3);function a(){t=!1,n&&(clearInterval(n),n=null),s&&(document.body.removeChild(s),s=null)}return function(){const e=new MutationObserver((()=>{r()})),t=document.getElementById("arcade-leaderboard");t&&e.observe(t,{childList:!0,subtree:!0,attributes:!0,characterData:!0}),window.arcadeChannel.on("broadcast",{event:"progress_update"},(()=>{r()}))}(),{clearIdleTimer:a,idleCheckInterval:o}}let cs=null,ls=null,ds=Date.now(),us=!1;function ms(){cs&&clearTimeout(cs),ls&&clearInterval(ls),ds=Date.now(),us=!1,ps(),fs(),ys();const e=document.querySelector(".initialize-button"),t=document.querySelector(".end-arcade-button");Bt.isInitialized&&"active"===Bt.state?(e&&(e.style.display="none"),t&&t.classList.add("visible")):(e&&(e.style.display="block"),t&&t.classList.remove("visible"))}function ps(){const e=document.querySelector(".inactivity-overlay");e&&e.remove();const t=document.createElement("div");t.className="inactivity-overlay",t.innerHTML='\n        <div class="countdown-timer">5</div>\n        <div class="inactivity-message">No activity detected. Redirecting...</div>\n        <div class="countdown-progress">\n            <div class="countdown-bar"></div>\n        </div>\n        <button class="countdown-cancel">Cancel</button>\n    ',t.querySelector(".countdown-cancel").addEventListener("click",vs),document.body.appendChild(t)}function fs(){const e=document.getElementById("moderator-screen");["mousemove","mousedown","keypress","scroll","touchstart"].forEach((t=>{e.addEventListener(t,gs)})),gs()}function gs(){us||(cs&&clearTimeout(cs),cs=setTimeout((()=>{Date.now()-ds>5e3&&hs()}),3e3))}function ys(){const e=document.getElementById("arcade-leaderboard");if(!e)return;new MutationObserver((()=>{ds=Date.now(),us&&vs()})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}function hs(){us=!0;const e=document.querySelector(".inactivity-overlay");e&&e.classList.add("visible");let t=5;const n=e.querySelector(".countdown-timer"),s=e.querySelector(".countdown-bar");n.textContent=t,s.style.transform="scaleX(1)",ls=setInterval((()=>{t--,n.textContent=t,s.style.transform=`scaleX(${t/5})`,t<=0&&(clearInterval(ls),ws())}),1e3)}function vs(){const e=document.querySelector(".inactivity-overlay");e&&e.classList.remove("visible"),us=!1,ls&&clearInterval(ls),gs()}function ws(){if(Bt.completedPlayers&&Bt.completedPlayers.length>=3){const e=[];if(Bt.podiumRanks)Object.entries(Bt.podiumRanks).forEach((([t,n])=>{const s=Bt.participants.find((e=>e.username===t));s&&e.push({username:s.username,wordsCompleted:s.wordsCompleted||0,coins:s.coins||0,rank:n.rank})})),e.sort(((e,t)=>e.rank-t.rank));else{[...Bt.participants].sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).slice(0,3).forEach(((t,n)=>{e.push({...t,rank:n+1})}))}yn(e)}else Z("welcome-screen")}const bs={activityTimer:null,countdownTimer:null,lastLeaderboardUpdate:Date.now(),isCountingDown:!1,isInitialized:!1,isGameActive:!1};function ms(){Ss()&&Bt.isInitialized&&(bs.isGameActive=!0,ks(),bs.lastLeaderboardUpdate=Date.now(),bs.isCountingDown=!1,bs.isInitialized=!0,xs(),Ls(),Es())}function Ss(){const e=document.getElementById("moderator-screen");return e&&e.classList.contains("visible")}function ks(){bs.activityTimer&&(clearTimeout(bs.activityTimer),bs.activityTimer=null),bs.countdownTimer&&(clearInterval(bs.countdownTimer),bs.countdownTimer=null)}function xs(){const e=document.querySelector(".moderator-inactivity-overlay");e&&e.remove();const t=document.createElement("div");t.className="moderator-inactivity-overlay",t.innerHTML='\n        <div class="moderator-countdown-timer">5</div>\n        <div class="moderator-inactivity-message">No leaderboard activity detected. Redirecting...</div>\n        <div class="moderator-countdown-progress">\n            <div class="moderator-countdown-bar"></div>\n        </div>\n        <button class="moderator-countdown-cancel">Cancel</button>\n    ',t.querySelector(".moderator-countdown-cancel").addEventListener("click",qs);const n=document.getElementById("moderator-screen");n&&n.appendChild(t)}function Ls(){const e=document.getElementById("moderator-screen");if(!e)return;["mousemove","mousedown","keypress","scroll","touchstart"].forEach((t=>{e.addEventListener(t,Cs)})),document.addEventListener("visibilitychange",(()=>{document.hidden||!Ss()?ks():bs.isGameActive&&Ss()&&Cs()})),Cs()}function Cs(){Ss()&&bs.isGameActive&&!bs.isCountingDown&&(bs.activityTimer&&clearTimeout(bs.activityTimer),bs.activityTimer=setTimeout((()=>{Date.now()-bs.lastLeaderboardUpdate>5e3&&Ss()&&Is()}),3e3))}function Es(){const e=document.getElementById("arcade-leaderboard");if(!e)return;new MutationObserver((()=>{Ss()&&bs.isGameActive&&(bs.lastLeaderboardUpdate=Date.now(),bs.isCountingDown&&qs())})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!0})}function Is(){if(!Ss()||!bs.isGameActive)return;bs.isCountingDown=!0;const e=document.querySelector(".moderator-inactivity-overlay");e&&e.classList.add("visible");let t=5;const n=e.querySelector(".moderator-countdown-timer"),s=e.querySelector(".moderator-countdown-bar");n.textContent=t,s.style.transform="scaleX(1)",bs.countdownTimer=setInterval((()=>{Ss()?(t--,n.textContent=t,s.style.transform=`scaleX(${t/5})`,t<=0&&(clearInterval(bs.countdownTimer),Ts())):qs()}),1e3)}function qs(){const e=document.querySelector(".moderator-inactivity-overlay");e&&e.classList.remove("visible"),bs.isCountingDown=!1,bs.countdownTimer&&(clearInterval(bs.countdownTimer),bs.countdownTimer=null),Ss()&&bs.isGameActive&&Cs()}function Ts(){if(Bt.celebrationTriggered)return;const e=Bt.participants.filter((e=>e.wordsCompleted>=Bt.wordGoal)),t=e&&e.length>=3;if(Bt.celebrationTriggered=!0,t){const e=[];if(Bt.podiumRanks)Object.entries(Bt.podiumRanks).forEach((([t,n])=>{const s=Bt.participants.find((e=>e.username===t));s&&e.push({username:s.username,wordsCompleted:s.wordsCompleted||0,coins:s.coins||0,rank:n.rank})})),e.sort(((e,t)=>e.rank-t.rank));else{[...Bt.participants].sort(((e,t)=>t.wordsCompleted-e.wordsCompleted)).slice(0,3).forEach(((t,n)=>{e.push({...t,rank:n+1})}))}Ms(e)}else Z("welcome-screen")}function _s(){ks(),bs.isGameActive=!1,bs.isInitialized=!1,bs.isCountingDown=!1;const e=document.querySelector(".moderator-inactivity-overlay");e&&e.remove()}function Ms(e){const t=document.querySelector(".moderator-inactivity-overlay");t&&t.classList.remove("visible");const n=document.createElement("div");n.className="celebration-overlay",document.body.appendChild(n),setTimeout((()=>n.classList.add("visible")),10);const s=document.getElementById("arcade-leaderboard").querySelectorAll(".leaderboard-entry"),r=new Map;e.forEach((e=>{s.forEach((t=>{const n=t.querySelector("[data-username]");if(!n)return;const s=n.dataset.username;if(s===e.username){const n=t.getBoundingClientRect();r.set(s,{left:n.left,top:n.top,width:n.width,height:n.height});const o=t.cloneNode(!0);if(o.classList.add("winner-entry","celebrating"),1===e.rank){o.classList.add("first-place");const t=document.createElement("div");t.className="winner-label",t.textContent="CHAMPION",o.appendChild(t),As(o,["👑","🏆","🌟"],e.rank)}else if(2===e.rank){o.classList.add("second-place");const t=document.createElement("div");t.className="winner-label",t.textContent="RUNNER-UP",o.appendChild(t),As(o,["🥈","✨"],e.rank)}else if(3===e.rank){o.classList.add("third-place");const t=document.createElement("div");t.className="winner-label",t.textContent="BRONZE MEDAL",o.appendChild(t),As(o,["🥉","🎉"],e.rank)}o.style.position="fixed",o.style.left=`${n.left}px`,o.style.top=`${n.top}px`,o.style.width=`${n.width}px`,o.style.height=`${n.height}px`,o.style.zIndex=103-e.rank,document.body.appendChild(o),setTimeout((()=>{o.classList.add("centered")}),50)}}))})),setTimeout((()=>{Ps(),window.arcadeChannel.send({type:"broadcast",event:"celebration",payload:{winners:e.map((e=>({username:e.username,rank:e.rank,wordsCompleted:e.wordsCompleted,coins:e.coins})))}})}),1500);const o=document.createElement("div");o.className="home-button-container",o.innerHTML='\n       <button class="start-button" onclick="finishCelebrationAndGoHome()">\n           Return to Home\n       </button>\n   ',document.body.appendChild(o),setTimeout((()=>o.classList.add("visible")),2500)}function $s(e,t){if(!t)return!1;const n=Bt.participants.findIndex((e=>e.username===t));if(-1===n)return!1;const s=Bt.participants[n];return!(e<(s.wordsCompleted||0))&&(s.wordsCompleted=e,!0)}function As(e,t,n){setTimeout((()=>{t.forEach(((e,t)=>{const s=document.createElement("div");let r,o,a;s.className="celebration-emoji",s.textContent=e;1===n?(a=3,t%2==0?(r=5+3*t+"%",o=5+2*t+"%"):(r=95-3*t+"%",o=5+2*t+"%")):2===n?(a=2.5,t%2==0?(r="5%",o=40+5*t+"%"):(r="95%",o=40+5*t+"%")):(a=2,t%2==0?(r=15+5*t+"%",o="90%"):(r=85-5*t+"%",o="90%")),s.style.fontSize=`${a}rem`,s.style.left=r,s.style.top=o,s.style.zIndex=300,s.style.animationDelay=1.8+.3*t+"s",document.body.appendChild(s)}))}),1800)}function Ps(){const e=["#FFD700","#FF1493","#00BFFF","#7CFC00","#FF4500","#9400D3","#FF8C00","#1E90FF","#32CD32","#FF69B4"];n();const t=setInterval(n,800);function n(){for(let t=0;t<60;t++){const t=document.createElement("div");t.className="confetti";const n=5+15*Math.random(),s=e[Math.floor(Math.random()*e.length)],r=100*Math.random(),o=3*Math.random(),a=3+4*Math.random(),i=Math.random()>.5;t.style.width=`${n}px`,t.style.height=`${n}px`,t.style.backgroundColor=s,t.style.left=`${r}vw`,t.style.animationDuration=`${a}s`,t.style.animationDelay=`${o}s`,t.style.borderRadius=i?"0":"50%",document.body.appendChild(t),setTimeout((()=>{t.remove()}),1e3*(a+o))}}window.celebrationConfettiInterval=t}function Bs(){window.arcadeChannel&&window.arcadeChannel.on("broadcast",{event:"celebration"},(({payload:e})=>{if(e.winners&&Bt.playerName){const t=e.winners.find((e=>e.username===Bt.playerName));t&&Us(t.rank)}}))}function Us(e){if(Bt.winnerScreenShown)return;Bt.winnerScreenShown=!0;const t=document.createElement("div");t.className="personal-victory-overlay",t.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0,0,0,0.8);\n        z-index: 2000;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        opacity: 0;\n        transition: opacity 0.5s ease;\n    ";const n={1:{title:"🏆 CHAMPION! 🏆",message:"Incredible! You've claimed the top spot!",emoji:"👑",color:"var(--gold)"},2:{title:"🥈 RUNNER UP! 🥈",message:"Amazing job! You've secured second place!",emoji:"⭐",color:"var(--silver)"},3:{title:"🥉 BRONZE MEDALIST! 🥉",message:"Well done! You've earned third place!",emoji:"🌟",color:"var(--bronze)"}}[e]||{title:"GREAT PERFORMANCE!",message:"You've completed the challenge!",emoji:"🎉",color:"var(--accent)"};t.innerHTML=`\n        <div style="font-size: 8rem; margin-bottom: 1rem;">${n.emoji}</div>\n        <h1 style="color: ${n.color}; font-size: 3rem; margin-bottom: 1rem;">${n.title}</h1>\n        <p style="font-size: 1.5rem; margin-bottom: 2rem; text-align: center; max-width: 80%;">\n            ${n.message}\n        </p>\n        <div style="margin: 2rem 0; display: flex; gap: 2rem;">\n            <div style="text-align: center;">\n                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">YOUR RANK</div>\n                <div style="font-size: 3rem; color: ${n.color};">${e}</div>\n            </div>\n            <div style="text-align: center;">\n                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">WORDS COMPLETED</div>\n                <div style="font-size: 3rem; color: var(--text);">${U.wordsCompleted||0}</div>\n            </div>\n            <div style="text-align: center;">\n                <div style="font-size: 1.2rem; color: var(--text); opacity: 0.8;">COINS EARNED</div>\n                <div style="font-size: 3rem; color: var(--gold);">${U.coins||0}</div>\n            </div>\n        </div>\n        <button class="start-button" style="margin-top: 2rem; padding: 1rem 2rem;" onclick="closePersonalVictory()">\n            Continue\n        </button>\n    `,document.body.appendChild(t),setTimeout((()=>{t.style.opacity="1",Ns()}),100)}function Ns(){const e=["#FFD700","#FF1493","#00BFFF","#7CFC00","#FF4500","#9400D3","#FF8C00","#1E90FF","#32CD32","#FF69B4"];function t(){for(let t=0;t<40;t++){const t=document.createElement("div");t.className="player-confetti",t.style.cssText=`\n                position: fixed;\n                width: ${5+10*Math.random()}px;\n                height: ${5+10*Math.random()}px;\n                background-color: ${e[Math.floor(Math.random()*e.length)]};\n                top: -20px;\n                left: ${100*Math.random()}vw;\n                opacity: 1;\n                z-index: 2001;\n                border-radius: ${Math.random()>.5?"0":"50%"};\n                animation: confettiFall ${3+3*Math.random()}s linear ${2*Math.random()}s forwards;\n            `,document.body.appendChild(t),setTimeout((()=>{t.remove()}),5e3)}}t();const n=setInterval(t,1e3);window.playerConfettiInterval=n,setTimeout((()=>{clearInterval(n)}),1e4)}function Fs(){window.playerConfettiInterval&&clearInterval(window.playerConfettiInterval),document.querySelectorAll(".player-confetti").forEach((e=>e.remove()));const e=document.querySelector(".personal-victory-overlay");e&&(e.style.opacity="0",setTimeout((()=>{e.remove(),an()}),500))}function Ds(){W();if(U.streakBonus&&U.correctAnswers===U.words.length){const e=U.firstAttempt?5:3;r.updateCoins(e).then((()=>{he(e),Yr.wordsCompleted+=U.words.length,Yr.completedLevels.add(Yr.currentLevel);const t=Yr.words.length,n=t>=12?9:t>=9?6:3;if(3===Yr.currentLevel&&t<=6)return void setTimeout((()=>zs()),1500);if(6===Yr.currentLevel&&t<=9)return void setTimeout((()=>zs()),1500);if(9===Yr.currentLevel&&t>=10)return void setTimeout((()=>zs()),1500);if(Yr.currentLevel>=n)return void setTimeout((()=>zs()),1500);const s=Yr.currentLevel+1,r=Yr.getWordsForLevel(s),o=document.getElementById("question-screen").getBoundingClientRect();G(o.left+o.width/2,o.top+o.height/2),r&&0!==r.words.length?(Yr.currentLevel=s,setTimeout((()=>mo(s)),1500)):setTimeout((()=>zs()),1500)}))}else setTimeout((()=>mo(Yr.currentLevel)),1500);I()}function zs(){const e=document.createElement("div");e.className="completion-overlay";const t=$.coins-Yr.startCoins;e.innerHTML=`\n        <div class="completion-content">\n            <h2>Practice Complete!</h2>\n            <div class="completion-stats">\n                <div class="stat-item">\n                    <i class="fas fa-book"></i>\n                    <span>Words Practiced: ${Yr.wordsCompleted}</span>\n                </div>\n                <div class="stat-item">\n                    <i class="fas fa-coins"></i>\n                    <span>Coins Earned: ${t}</span>\n                </div>\n            </div>\n            <button onclick="exitCustomPractice()" class="victory-button">\n                Continue\n            </button>\n        </div>\n    `,document.body.appendChild(e)}async function Hs(e,t=!1){if(e){if(U.currentIndex++,!t){let t=0;const n=ye();n>0&&(t+=n,he(n)),U.firstAttempt?(t+=3,he(3)):(t+=1,he(1));try{await r.updateCoins(t),B()}catch(e){}if(U.correctAnswers++,currentUser&&"premium"===currentUser.status){const e=U.currentIndex-1,t=U.isHebrewToEnglish?U.words[e]:U.translations[e];await xr(t,"custom")}}}else{U.firstAttempt=!1,U.streakBonus=!1,U.wrongStreak++;try{await r.updateCoins(-3),B()}catch(e){}if(U.currentIndex>0&&(U.progressLost++,U.currentIndex=Math.max(0,U.currentIndex-1)),U.wrongStreak>=3)return Te(),void(document.querySelector(".restart-button").onclick=()=>{document.querySelector(".failure-overlay").style.display="none",mo(U.customLevel)})}const n=U.isHebrewToEnglish?U.words[Math.max(0,U.currentIndex-1)]:U.translations[Math.max(0,U.currentIndex-1)],s=document.querySelectorAll(".buttons button");s.forEach((t=>{t.textContent===n?t.classList.add("correct"):!e&&event&&event.target&&t.textContent===event.target.textContent&&t.classList.add("wrong")})),me(),I(),setTimeout((()=>{s.forEach((e=>{e.classList.remove("correct","wrong")})),U.currentIndex<U.words.length?(pe(),B()):Ds()}),333)}function Rs(){const e=document.createElement("div");e.className="revive-overlay",e.innerHTML='\n        <div class="revive-content">\n            <div class="ankh-symbol">☥</div>\n            <h2 class="revive-title">Revive?</h2>\n            <div class="revive-timer">5</div>\n            <button class="revive-button">Revive</button>\n        </div>\n    ',document.body.appendChild(e),requestAnimationFrame((()=>{e.classList.add("show")}));let t=5;const n=e.querySelector(".revive-timer"),s=setInterval((()=>{t--,n.textContent=t,t<=0&&(clearInterval(s),Os())}),1e3);e.querySelector(".revive-button").onclick=()=>{clearInterval(s),js()},e.dataset.intervalId=s}function Os(){const e=document.querySelector(".revive-overlay");e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),Z("welcome-screen")}),500))}function js(){const e=document.querySelector(".revive-overlay");if(e){e.querySelector(".revive-content").innerHTML='\n            <div class="resurrection-animation">\n                <div class="progress-circle resurrection-circle">\n                    <svg width="100%" height="100%" viewBox="0 0 120 120">\n                        <circle class="bg" cx="60" cy="60" r="54" stroke-width="8"/>\n                        <circle class="resurrection-progress" cx="60" cy="60" r="54" stroke-width="8"/>\n                    </svg>\n                    <div class="ankh-symbol resurrection-ankh">☥</div>\n                </div>\n            </div>\n        ';const t=e.querySelector(".resurrection-progress"),n=2*Math.PI*54;t.style.strokeDasharray=`${n} ${n}`,t.style.strokeDashoffset=n,Ws(),setTimeout((()=>{t.style.transition="stroke-dashoffset 2s cubic-bezier(0.4, 0, 0.2, 1)",t.style.strokeDashoffset="0"}),100),setTimeout((()=>{e.classList.remove("show"),setTimeout((()=>{e.remove(),U.wrongStreak=0,F=U.initialTimeRemaining,U.isCustomPractice?mo(U.customLevel):oe($.currentLevel)}),500)}),2500)}}function Ws(){const e=document.querySelector(".resurrection-animation");if(!e)return;const t=e.getBoundingClientRect(),n=t.left+t.width/2,s=t.top+t.height/2;for(let e=0;e<40;e++){const e=document.createElement("div");e.className="resurrection-particle";const t=Math.random()*Math.PI*2,r=100+150*Math.random(),o=1+1.5*Math.random(),a=.5*Math.random(),i=3+7*Math.random(),c=Math.cos(t)*r,l=Math.sin(t)*r;e.style.cssText=`\n            position: fixed;\n            left: ${n}px;\n            top: ${s}px;\n            width: ${i}px;\n            height: ${i}px;\n            background: #FFD700;\n            border-radius: 50%;\n            opacity: 0;\n            z-index: 1001;\n            box-shadow: 0 0 ${i}px #FFD700;\n            transform: translate(-50%, -50%);\n            animation: particleFlow ${o}s ease-out ${a}s forwards;\n        `,e.style.setProperty("--end-x",`${c}px`),e.style.setProperty("--end-y",`${l}px`),document.body.appendChild(e),setTimeout((()=>{e.remove()}),1e3*(o+a))}}function Gs(){const e=document.querySelector('.nav-link[onclick*="stage-screen"]');e&&e.setAttribute("onclick","showScreen('stage-cascade-screen'); return false;")}function Js(){const e=document.querySelector(".stages-container");if(!e)return;if(e.innerHTML="",M.stages.forEach((t=>{const n=document.createElement("div");n.className="stage-wrapper",n.dataset.stage=t.id;const s=t.numSets,r=$.unlockedSets[t.id]||new Set,o=r.size;let a=0;o>0&&r.forEach((e=>{tr(t.id,e)&&a++}));const i=Vs(t.id),c=Zs(t.id),l=Qs(t.id),d=Ks(t.id,a,s);n.innerHTML=`\n      <div class="stage-button">\n        <div class="stage-info">\n          <div class="stage-icon">\n            <i class="${i}"></i>\n          </div>\n          <div class="stage-text">\n            <div class="stage-name">${c} - Stage ${t.id}</div>\n            <div class="stage-desc">${l}</div>\n          </div>\n        </div>\n        <div class="stage-status">${d}</div>\n        <div class="stage-toggle">\n          <i class="fas fa-chevron-down"></i>\n        </div>\n      </div>\n      \n      <div class="sets-container">\n        <div class="sets-grid" id="sets-grid-${t.id}"></div>\n      </div>\n    `,e.appendChild(n),er(t.id)})),rr(),$.currentStage){const e=document.querySelector(`.stage-wrapper[data-stage="${$.currentStage}"]`);e&&e.classList.add("open")}const t=document.getElementById("stage-cascade-screen");t&&(document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")})),t.classList.add("visible"))}function Ys(){if(currentUser){const e=localStorage.getItem("simploxProgress");if(e)try{Xs(JSON.parse(e))}catch(e){}}const e=document.querySelector(".stages-container");if(!e)return;if(e.innerHTML="",M.stages.forEach((t=>{const n=document.createElement("div");n.className="stage-wrapper",n.dataset.stage=t.id;const s=t.numSets,r=$.unlockedSets[t.id]||new Set;r.size;let o=0;r.size>0&&r.forEach((e=>{t.id;const n=M.stages[t.id-1].levelsPerSet,s=new Set;for(let r=1;r<=n;r++){const n=`${t.id}_${e}_${r}`;($.completedLevels.has(n)||$.perfectLevels.has(n))&&s.add(r)}s.size===n&&o++}));const a=Vs(t.id),i=Zs(t.id),c=Qs(t.id),l=Ks(t.id,o,s);n.innerHTML=`\n            <div class="stage-button">\n                <div class="stage-info">\n                    <div class="stage-icon">\n                        <i class="${a}"></i>\n                    </div>\n                    <div class="stage-text">\n                        <div class="stage-name">${i} - Stage ${t.id}</div>\n                        <div class="stage-desc">${c}</div>\n                    </div>\n                </div>\n                <div class="stage-status">${l}</div>\n                <div class="stage-toggle">\n                    <i class="fas fa-chevron-down"></i>\n                </div>\n            </div>\n            \n            <div class="sets-container">\n                <div class="sets-grid" id="sets-grid-${t.id}"></div>\n            </div>\n        `,e.appendChild(n),er(t.id)})),rr(),$.currentStage){const e=document.querySelector(`.stage-wrapper[data-stage="${$.currentStage}"]`);e&&e.classList.add("open")}const t=document.getElementById("stage-cascade-screen");t&&(document.querySelectorAll(".screen").forEach((e=>{e.classList.remove("visible")})),t.classList.add("visible"))}function Xs(e){e.unlocked_sets&&($.unlockedSets={},Object.entries(e.unlocked_sets).forEach((([e,t])=>{$.unlockedSets[e]=new Set(Array.isArray(t)?t:[])}))),e.unlocked_levels&&($.unlockedLevels={},Object.entries(e.unlocked_levels).forEach((([e,t])=>{$.unlockedLevels[e]=new Set(Array.isArray(t)?t:[])}))),e.completed_levels&&($.completedLevels=new Set(e.completed_levels)),e.perfect_levels&&($.perfectLevels=new Set(e.perfect_levels))}function Vs(e){return{1:"fas fa-book",2:"fas fa-graduation-cap",3:"fas fa-school",4:"fas fa-university",5:"fas fa-brain"}[e]||"fas fa-star"}function Zs(e){return{1:"מתחילים",2:"יסודי",3:"חטיבת ביניים",4:"תיכון",5:"אוניברסיטה"}[e]||`Stage ${e}`}function Qs(e){return{1:"Beginner level words and simple phrases",2:"Elementary level vocabulary and structures",3:"Middle school level vocabulary",4:"High school level vocabulary",5:"University level vocabulary"}[e]||"Advanced vocabulary"}function Ks(e,t,n){return e>2&&(!currentUser||"premium"!==currentUser.status)?"Premium Feature":`${t}/${n} Sets Completed`}function er(e){const t=document.getElementById(`sets-grid-${e}`);if(!t)return;const n=M.stages[e-1],s=$.unlockedSets[e]||new Set,r=currentUser?currentUser.status:"unregistered";t.innerHTML="";for(let o=1;o<=n.numSets;o++){const n=document.createElement("div"),a=s.has(o);let i=!1;e>=2&&o>1&&"premium"!==r&&(i=!0),n.className="set-button",a&&!i?n.classList.add("active"):n.classList.add("locked");const c=tr(e,o);n.innerHTML=`\n      <span>Set ${o}</span>\n      ${c?'\n      <div class="completed-indicator">\n        <i class="fas fa-check-circle"></i>\n      </div>':""}\n      ${!a||i?`\n      <div class="lock-icon">\n        <i class="fas ${i?"fa-crown crown-premium":"fa-lock"}"></i>\n      </div>`:""}\n    `,a&&!i?n.onclick=()=>{$.currentStage=e,$.currentSet=o,Q(o)}:i&&(n.onclick=()=>tt(),setTimeout((()=>{const e=n.querySelector(".fa-crown");e&&e.addEventListener("click",(e=>{e.stopPropagation(),tt()}))}),0)),t.appendChild(n)}}function tr(e,t){const n=M.stages;if(!n||!n[e-1])return!1;const s=n[e-1].levelsPerSet;let r=0;for(let n=1;n<=s;n++){const s=`${e}_${t}_${n}`;($.completedLevels.has(s)||$.perfectLevels.has(s))&&r++}return r===s}function nr(e){e.stopPropagation(),currentUser?(localStorage.removeItem(`upgradeRequested_${currentUser.id}`),tt()):(Sn(),setTimeout((()=>{const e=document.getElementById("loginForm"),t=document.getElementById("signupForm");e&&t&&(e.classList.add("hidden"),t.classList.remove("hidden"))}),100))}function sr(){currentUser?localStorage.removeItem(`upgradeRequested_${currentUser.id}`):localStorage.removeItem("upgradeRequested_guest"),Z("upgrade-screen")}function rr(){document.querySelectorAll(".stage-wrapper .stage-button").forEach((e=>{e.addEventListener("click",(t=>{e.closest(".stage-wrapper").classList.toggle("open"),t.stopPropagation()}))}))}function or(e){if(!document.getElementById(e)){const t=document.createElement("div");t.id=e,t.className="screen",document.body.appendChild(t)}}function ar(e,t=!1){or(e),Z(e,t)}function ir(){const e=document.querySelector('.nav-link[onclick*="stage-screen"]');e&&e.setAttribute("onclick","safeShowScreen('stage-cascade-screen'); return false;"),document.querySelectorAll('button[onclick*="stage-screen"]').forEach((e=>{const t=e.getAttribute("onclick");t&&t.includes("stage-screen")&&e.setAttribute("onclick",t.replace("stage-screen","stage-cascade-screen"))}))}function cr(){const e=document.getElementById("stage-cascade-screen");if(!e.querySelector(".stages-container")){const t=document.createElement("div");t.className="stages-container",e.appendChild(t)}}function wn(){const e=document.querySelector(".side-panel"),t=document.querySelector(".hamburger-button"),n=document.querySelector(".modal-overlay");e.classList.contains("open")?(e.classList.remove("open"),t.classList.remove("open"),n&&n.classList.remove("open")):(e.classList.add("open"),t.classList.add("open"),n&&n.classList.add("open"))}function lr(){if($.completedLevels.size>0||$.perfectLevels.size>0)return!0;for(let e=1;e<=5;e++){const t=$.unlockedSets[e];if((1!==e||!t||9!==t.size)&&(t&&t.size>1))return!0}const e=localStorage.getItem("simploxProgress");if(e){const t=JSON.parse(e);if(t.completedLevels&&t.completedLevels.length>0)return!0;if(t.perfectLevels&&t.perfectLevels.length>0)return!0}return!1}function dr(e){if(!$.unlockedSets[e])return null;const t=Array.from($.unlockedSets[e]).sort(((e,t)=>t-e));for(const n of t){const t=`${e}_${n}`;if(!$.unlockedLevels[t])continue;const s=Array.from($.unlockedLevels[t]).sort(((e,t)=>t-e));for(const t of s){const s=`${e}_${n}_${t}`;if(!$.perfectLevels.has(s)&&!$.completedLevels.has(s))return{stage:e,set:n,level:t}}}const n=M.stages[e-1],s=t[0];return s<n.numSets?{stage:e,set:s+1,level:1}:e<5?{stage:e+1,set:1,level:1}:{stage:e,set:t[0],level:1}}function ur(){const e=document.createElement("div");e.className="modal-backdrop",e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.7);\n        backdrop-filter: blur(5px);\n        z-index: 1000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    ";const t=document.createElement("div");t.className="grade-level-modal",t.style.cssText="\n        background: var(--glass);\n        backdrop-filter: blur(10px);\n        border-radius: 20px;\n        padding: 2rem;\n        max-width: 500px;\n        width: 90%;\n        text-align: center;\n        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);\n        border: 1px solid rgba(255, 255, 255, 0.1);\n    ",t.innerHTML='\n        <h2 style="color: var(--gold); margin-bottom: 1.5rem;">What grade level are you?</h2>\n        <p style="margin-bottom: 2rem; opacity: 0.9;">Choose your education level for the best learning experience:</p>\n        <div class="grade-options" style="display: flex; flex-direction: column; gap: 1rem;">\n            <button class="grade-option" data-stage="2" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-school" style="margin-right: 0.5rem;"></i> Elementary School\n            </button>\n            <button class="grade-option" data-stage="3" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-graduation-cap" style="margin-right: 0.5rem;"></i> Junior High School\n            </button>\n            <button class="grade-option" data-stage="4" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-user-graduate" style="margin-right: 0.5rem;"></i> High School\n            </button>\n            <button class="grade-option" data-stage="5" style="padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.1); border: none; color: var(--text); cursor: pointer; transition: all 0.3s ease;">\n                <i class="fas fa-university" style="margin-right: 0.5rem;"></i> University\n            </button>\n        </div>\n    ',document.body.appendChild(e),e.appendChild(t);t.querySelectorAll(".grade-option").forEach((t=>{t.addEventListener("mouseover",(()=>{t.style.background="rgba(255,255,255,0.2)",t.style.transform="translateY(-2px)"})),t.addEventListener("mouseout",(()=>{t.style.background="rgba(255,255,255,0.1)",t.style.transform="translateY(0)"})),t.addEventListener("click",(()=>{const n=parseInt(t.dataset.stage);localStorage.setItem("preferredStage",n),e.remove(),$.currentStage=n,$.currentSet=1,oe(1)}))}))}function k(){$.unlockedSets[1]||($.unlockedSets[1]=new Set);for(let e=1;e<=9;e++){$.unlockedSets[1].add(e);const t=`1_${e}`;$.unlockedLevels[t]||($.unlockedLevels[t]=new Set([1]))}for(let e=2;e<=5;e++){$.unlockedSets[e]||($.unlockedSets[e]=new Set([1]));const t=`${e}_1`;$.unlockedLevels[t]||($.unlockedLevels[t]=new Set([1]))}Object.entries($.unlockedLevels).forEach((([e,t])=>{const n=Math.max(...Array.from(t));for(let e=1;e<n;e++)t.add(e)}))}function I(){const e={stage:$.currentStage||1,set_number:$.currentSet||1,level:$.currentLevel||1,coins:$.coins||0,perks:$.perks||{}};$.unlockedSets&&(e.unlocked_sets={},Object.entries($.unlockedSets).forEach((([t,n])=>{e.unlocked_sets[t]=Array.from(n||[])}))),$.unlockedLevels&&(e.unlocked_levels={},Object.entries($.unlockedLevels).forEach((([t,n])=>{e.unlocked_levels[t]=Array.from(n||[])}))),$.completedLevels&&$.completedLevels.size>0&&(e.completed_levels=Array.from($.completedLevels)),$.perfectLevels&&$.perfectLevels.size>0&&(e.perfect_levels=Array.from($.perfectLevels)),currentUser?p.from("game_progress").select("*").eq("user_id",currentUser.id).single().then((({data:t,error:n})=>{if(n)return void mr(e);const s="perfect_levels"in t;"completed_levels"in t||delete e.completed_levels,s||delete e.perfect_levels,p.from("game_progress").update(e).eq("user_id",currentUser.id).then((({data:t,error:n})=>{n?mr(e):(mr(e),document.dispatchEvent(new CustomEvent("progressSaved",{detail:{gameState:$}})))}))})):mr(e);const t={stage:$.currentStage,set:$.currentSet,level:$.currentLevel,timestamp:Date.now()};localStorage.setItem("gameContext",JSON.stringify(t))}function mr(e){localStorage.setItem("simploxProgress",JSON.stringify(e))}function pr(){Object.entries($.unlockedSets).forEach((([e,t])=>{})),Object.entries($.unlockedLevels).forEach((([e,t])=>{}))}function fr(){e.maxParticles=20;gr(Z,200);/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),document.head.insertAdjacentHTML("beforeend","\n            <style>\n                @media (max-width: 768px) {\n                    .confetti, .particle {\n                        display: none;\n                    }\n                }\n            </style>\n        "))}function gr(e,t){let n;return function(...s){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...s)}),t)}}function yr(){document.addEventListener("touchstart",(()=>{}),{passive:!0}),document.addEventListener("touchmove",(()=>{}),{passive:!0})}function hr(){const e=document.querySelector(".accessibility-toggle"),t=document.querySelector(".accessibility-modal"),n=document.querySelector(".close-accessibility");br(),e&&t&&e.addEventListener("click",(function(){t.classList.add("show")})),n&&t&&(n.addEventListener("click",(function(){t.classList.remove("show")})),t.addEventListener("click",(function(e){e.target===t&&t.classList.remove("show")})));document.querySelectorAll(".accessibility-button").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-action");if(vr(e,this.getAttribute("data-value")),"fontSize"!==e&&"reset"!==e){document.querySelectorAll(`[data-action="${e}"]`).forEach((e=>e.classList.remove("active"))),this.classList.add("active")}}))}))}function vr(e,t){const n=document.body;switch(e){case"contrast":n.classList.remove("high-contrast","inverted-colors"),"high"===t&&n.classList.add("high-contrast"),"inverted"===t&&n.classList.add("inverted-colors");break;case"theme":n.classList.remove("light-theme","dark-theme"),"light"===t&&n.classList.add("light-theme"),"dark"===t&&n.classList.add("dark-theme");break;case"saturation":n.classList.remove("grayscale"),"grayscale"===t&&n.classList.add("grayscale");break;case"fontSize":let e=parseFloat(getComputedStyle(n).getPropertyValue("--font-scale")||1);"increase"===t?(e=Math.min(e+.1,1.8),n.style.setProperty("--font-scale",e),n.style.fontSize=`calc(1rem * ${e})`):"decrease"===t?(e=Math.max(e-.1,.8),n.style.setProperty("--font-scale",e),n.style.fontSize=`calc(1rem * ${e})`):"reset"===t&&(n.style.removeProperty("--font-scale"),n.style.fontSize="");break;case"fontFamily":n.classList.remove("dyslexic-font"),"dyslexic"===t&&n.classList.add("dyslexic-font");break;case"letterSpacing":n.classList.remove("increased-letter-spacing"),"increased"===t&&n.classList.add("increased-letter-spacing");break;case"animations":n.classList.remove("no-animations","reduced-animations"),"disabled"===t&&n.classList.add("no-animations"),"reduced"===t&&n.classList.add("reduced-animations");break;case"focus":n.classList.remove("high-focus"),"high"===t&&n.classList.add("high-focus");break;case"buttonSize":n.classList.remove("large-buttons"),"large"===t&&n.classList.add("large-buttons");break;case"cursorSize":n.classList.remove("large-cursor"),"large"===t&&n.classList.add("large-cursor");break;case"reset":"all"===t&&kr()}wr()}function wr(){const e=document.body,t={classNames:e.className,fontSize:e.style.fontSize,fontScale:e.style.getPropertyValue("--font-scale")};localStorage.setItem("accessibilitySettings",JSON.stringify(t))}function br(){const e=localStorage.getItem("accessibilitySettings");if(e){const t=JSON.parse(e),n=document.body;t.classNames&&(n.className=t.classNames),t.fontSize&&(n.style.fontSize=t.fontSize),t.fontScale&&n.style.setProperty("--font-scale",t.fontScale),Sr()}}function Sr(){const e=document.body;Object.entries({"high-contrast":{action:"contrast",value:"high"},"inverted-colors":{action:"contrast",value:"inverted"},"light-theme":{action:"theme",value:"light"},"dark-theme":{action:"theme",value:"dark"},grayscale:{action:"saturation",value:"grayscale"},"dyslexic-font":{action:"fontFamily",value:"dyslexic"},"increased-letter-spacing":{action:"letterSpacing",value:"increased"},"no-animations":{action:"animations",value:"disabled"},"reduced-animations":{action:"animations",value:"reduced"},"high-focus":{action:"focus",value:"high"},"large-buttons":{action:"buttonSize",value:"large"},"large-cursor":{action:"cursorSize",value:"large"}}).forEach((([t,n])=>{const s=e.classList.contains(t),r=document.querySelector(`[data-action="${n.action}"][data-value="${n.value}"]`);r&&(s?r.classList.add("active"):r.classList.remove("active"))})),document.querySelector('[data-action="contrast"].active')||document.querySelector('[data-action="contrast"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="theme"].active')||document.querySelector('[data-action="theme"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="saturation"].active')||document.querySelector('[data-action="saturation"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="fontFamily"].active')||document.querySelector('[data-action="fontFamily"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="letterSpacing"].active')||document.querySelector('[data-action="letterSpacing"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="animations"].active')||document.querySelector('[data-action="animations"][data-value="enabled"]')?.classList.add("active"),document.querySelector('[data-action="focus"].active')||document.querySelector('[data-action="focus"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="buttonSize"].active')||document.querySelector('[data-action="buttonSize"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="cursorSize"].active')||document.querySelector('[data-action="cursorSize"][data-value="normal"]')?.classList.add("active")}function kr(){const e=document.body;e.classList.remove("high-contrast","inverted-colors","light-theme","dark-theme","grayscale","dyslexic-font","increased-letter-spacing","no-animations","reduced-animations","high-focus","large-buttons","large-cursor"),e.style.fontSize="",e.style.removeProperty("--font-scale"),document.querySelectorAll(".accessibility-button.active").forEach((e=>{e.classList.remove("active")})),document.querySelector('[data-action="contrast"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="theme"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="saturation"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="fontFamily"][data-value="default"]')?.classList.add("active"),document.querySelector('[data-action="letterSpacing"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="animations"][data-value="enabled"]')?.classList.add("active"),document.querySelector('[data-action="focus"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="buttonSize"][data-value="normal"]')?.classList.add("active"),document.querySelector('[data-action="cursorSize"][data-value="normal"]')?.classList.add("active"),localStorage.removeItem("accessibilitySettings")}async function xr(e,t){if(currentUser)try{encodeURIComponent(e.replace(/\s+/g,"_"));const{data:n,error:s}=await p.from("word_practice_history").select("*").eq("user_id",currentUser.id).filter("word","eq",e).maybeSingle();let o=!1,a=0;if(n){const e=n.practice_count+1;a=e<=5?3:1;const{error:s}=await p.from("word_practice_history").update({practice_count:e,last_practiced_at:(new Date).toISOString(),game_mode:t,coins_earned:n.coins_earned+a}).eq("id",n.id);if(s)return}else{o=!0,a=3;const{error:n}=await p.from("word_practice_history").insert([{user_id:currentUser.id,word:e,practice_count:1,game_mode:t,coins_earned:a}]);if(n)return;const{data:s,error:r}=await p.from("player_stats").select("unique_words_practiced").eq("user_id",currentUser.id).single();if(!r){const e=(s?.unique_words_practiced||0)+1,{error:t}=await p.from("player_stats").update({unique_words_practiced:e}).eq("user_id",currentUser.id);t||document.querySelectorAll("#totalWords").forEach((t=>{qn(t,parseInt(t.textContent)||0,e)}))}}return a>0&&await r.updateCoins(a),{isNewWord:o,coinReward:a}}catch(e){}}function Lr(){const e=document.getElementById("question-screen");if(!e)return;const t=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",..."אבגדהוזחטיכלמנסעפצקרשת"],n=e.clientWidth;window.rainingLettersInterval&&clearInterval(window.rainingLettersInterval),window.rainingLettersInterval=setInterval((()=>{const s=Math.floor(3*Math.random())+1;for(let r=0;r<s;r++){const s=document.createElement("div");s.className="raining-letter",s.textContent=t[Math.floor(Math.random()*t.length)];const r=Math.random()*n,o=5+5*Math.random();s.style.left=`${r}px`,s.style.animationDuration=`${o}s`,e.appendChild(s),setTimeout((()=>{s.parentNode===e&&e.removeChild(s)}),1e3*o)}}),300)}function Gn(){if(!U.isBossLevel)return;const e=document.querySelector(".progress-circle");if(!e)return;const t=e.querySelector(".progress");if(!t)return;const n=U.words.length,s=U.currentIndex||0,r=Math.max(0,n-s)/n,o=2*Math.PI*54;if(t.style.strokeDashoffset=o*(1-r),t.classList.contains("boss-health")||t.classList.add("boss-health"),r>.66)t.style.stroke="#4CAF50",t.classList.remove("warning");else if(r>.33){if(t.style.stroke="#FFA500",t.classList.remove("warning"),r<=.66&&!U.bossFirstHealthRestored){U.bossFirstHealthRestored=!0;const e=Math.floor(.25*n);U.currentIndex=e;const t=document.querySelector(".boss-orb-inner");t&&(t.style.background="radial-gradient(circle at 30% 30%, #FFEB3B, #FFA500)",setTimeout((()=>{t.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3)),setTimeout((()=>Gn()),100)}}else if(t.style.stroke="#FF3333",t.classList.add("warning"),r<=.33&&!U.bossSecondHealthRestored){U.bossSecondHealthRestored=!0;const e=Math.floor(.5*n);U.currentIndex=e;const t=document.querySelector(".boss-orb-inner");t&&(t.style.background="radial-gradient(circle at 30% 30%, #4CAF50, #388E3C)",setTimeout((()=>{t.style.background="radial-gradient(circle at 30% 30%, #ff3333, #990000)"}),1e3)),setTimeout((()=>Gn()),100)}}function Cr(e,t){const n=document.querySelector(".progress-circle"),s=n?n.querySelector(".progress"):null,r=document.querySelector(".boss-orb-inner");if(!s||!r)return;const o=r.style.background;r.style.background=t,r.classList.add("boss-restore-health");const a=document.querySelector(".question-screen");a&&(a.style.animation="none",a.offsetHeight,a.style.animation="bossRestoreHealth 1s");const i=2*Math.PI*54*(1-e);setTimeout((()=>{s.style.transition="stroke-dashoffset 1s ease-out",s.style.strokeDashoffset=i,setTimeout((()=>{r.style.background=o,r.classList.remove("boss-restore-health")}),1e3)}),300)}function Er(e=!1){const t=document.querySelector(".boss-orb-inner");if(!t)return;const n=t.style.background;if(e){const e=["yellow","purple","turquoise","darkgreen","brown"],n=e[Math.floor(Math.random()*e.length)];t.style.background=`radial-gradient(circle at 30% 30%, ${n}, #990000)`}t.classList.add("boss-orb-hit"),setTimeout((()=>{t.classList.remove("boss-orb-hit"),e&&(t.style.background=n)}),300)}function Ir(){const e=document.getElementById("question-screen");if(e&&(e.style.setProperty("background","linear-gradient(135deg, #800000, #3a0000)","important"),e.style.setProperty("animation","pulseBg 4s infinite","important")),!document.getElementById("boss-animations")){const e=document.createElement("style");e.id="boss-animations",e.textContent="\n      @keyframes pulseBg {\n        0%, 100% { filter: brightness(1); }\n        50% { filter: brightness(1.2); }\n      }\n      \n      @keyframes pulseOrb {\n        0%, 100% { transform: scale(1); filter: brightness(1); }\n        50% { transform: scale(1.3); filter: brightness(1.4); }\n      }\n      \n      @keyframes pulseWord {\n        0%, 100% { transform: scale(1); }\n        50% { transform: scale(1.05); }\n      }\n    ",document.head.appendChild(e)}const t=document.getElementById("question-word");t&&(t.style.setProperty("color","#ff3333","important"),t.style.setProperty("text-shadow","0 0 10px rgba(255, 0, 0, 0.5)","important"),t.style.setProperty("animation","pulseWord 2s infinite","important"));const n=document.querySelector(".coins-container");n&&(window.originalCoinsHTML||(window.originalCoinsHTML=n.innerHTML),n.innerHTML='\n    <div class="boss-orb" style="\n      width: 85px;\n      height: 85px;\n      top: 50%;\n      left: 50%;\n      transform: translate(-75%, -75%);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      z-index: 10;\n    ">\n      <div class="boss-orb-inner" style="\n        width: 50px;\n        height: 50px;\n        background: radial-gradient(circle at 30% 30%, #ff3333, #990000);\n        border-radius: 50%;\n        box-shadow: 0 0 20px #ff3333, inset 0 0 10px rgba(255,255,255,0.3);\n        animation: pulseOrb 1s infinite;\n      "></div>\n    </div>\n  ')}function qr(e){if(e){const e=document.querySelector(".progress-circle"),t=e?.querySelector(".progress");if(t){const e=t.style.stroke,n=["#ffffff","#ffff00","#800080","#990000"],s=n[Math.floor(Math.random()*n.length)];t.style.transition="stroke 0.2s ease",t.style.stroke=s,setTimeout((()=>{t.style.stroke=e}),200)}}}function Tr(){const e=document.createElement("div");e.id="boss-timer",e.style.cssText="\n        position: absolute;\n        top: 10px;\n        left: 50%;\n        transform: translateX(-50%);\n        display: flex;\n        justify-content: center;\n        z-index: 10;\n    ";const t=document.createElement("div");return t.style.cssText="\n        background-color: rgba(255, 215, 0, 0.8);\n        color: #000;\n        font-family: 'Digital', monospace;\n        font-size: 2rem;\n        padding: 5px 10px;\n        border-radius: 5px;\n        letter-spacing: 3px;\n    ",e.appendChild(t),{container:e,display:t}}function _r(e,t){if(e){const n=Math.floor(t/60),s=t%60;e.textContent=`${n.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}}function Mr(){const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(255, 255, 255, 0.8);\n        z-index: 1000;\n        pointer-events: none;\n        opacity: 0;\n        transition: opacity 0.1s ease;\n    ",document.body.appendChild(e);const t=Math.floor(3*Math.random())+1;let n=0;for(let s=0;s<t;s++)setTimeout((()=>{e.style.opacity="1",setTimeout((()=>{e.style.opacity="0"}),50)}),n),n+=200;setTimeout((()=>{document.body.removeChild(e)}),n+500)}function $r(){const e=document.getElementById("question-screen");if(!e)return;window.rainingLettersInterval&&clearInterval(window.rainingLettersInterval);const t=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ",..."אבגדהוזחטיכלמנסעפצקרשת"],n=e.clientWidth;window.rainingLettersInterval=setInterval((()=>{const s=Math.floor(3*Math.random())+1;for(let r=0;r<s;r++){const s=document.createElement("div");s.className="boss-raining-letter",s.textContent=t[Math.floor(Math.random()*t.length)],s.style.cssText=`\n                position: absolute;\n                top: -20px;\n                left: ${Math.random()*n}px;\n                color: rgba(255, 0, 0, 0.4);\n                font-size: 16px;\n                animation: boss-letter-rain 5s linear forwards;\n                z-index: 1;\n                text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);\n            `,e.appendChild(s),setTimeout((()=>{s.parentNode===e&&e.removeChild(s)}),5e3)}}),300)}function Ar(){window.rainingLettersInterval&&(clearInterval(window.rainingLettersInterval),window.rainingLettersInterval=null)}function Pr(){const e=document.createElement("style");e.id="boss-level-styles",e.textContent="\n    @keyframes boss-letter-rain {\n      0% { \n        transform: translateY(-20px);\n        opacity: 0.6;\n      }\n      100% { \n        transform: translateY(100vh);\n        opacity: 0;\n      }\n    }\n\n    @keyframes boss-shrink {\n      0% { transform: scale(1); opacity: 1; }\n      50% { transform: scale(0.8); opacity: 0.8; }\n      100% { transform: scale(0); opacity: 0; }\n    }\n\n    @keyframes fade-to-blue {\n      0% { background: linear-gradient(135deg, #800000, #3a0000); }\n      20% { background: linear-gradient(135deg, #800000, #3a0000); }\n      60% { background: linear-gradient(135deg, #4a1582, #0d47a1); }\n      100% { background: radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%); }\n    }\n    \n    @keyframes incinerateEffect {\n      0% { transform: scale(0); opacity: 0; }\n      10% { transform: scale(0.5); opacity: 0.8; }\n      50% { transform: scale(1.5); opacity: 1; }\n      100% { transform: scale(3); opacity: 0; }\n    }\n    \n    .incineration-effect {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      border-radius: 50%;\n      background: radial-gradient(circle, #ff9900, #ff3300);\n      opacity: 0;\n      transform: scale(0);\n      animation: incinerateEffect 1.5s forwards;\n    }\n  ",document.head.appendChild(e)}function Br(){const e=document.createElement("div");e.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        z-index: 2000;\n        opacity: 0;\n        transition: opacity 0.5s ease;\n    ";const t=document.createElement("div");t.style.cssText="\n        background: linear-gradient(135deg, #00c6ff, #0072ff);\n        padding: 2rem;\n        border-radius: 20px;\n        text-align: center;\n        max-width: 500px;\n        width: 90%;\n        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\n    ",t.innerHTML=`\n        <h2 style="color: white; font-size: 2.5rem; margin-bottom: 1rem;">🏆 Boss Defeated!</h2>\n        <div class="victory-stats" style="display: flex; justify-content: space-around; margin: 1.5rem 0; color: white;">\n            <div>\n                <div style="font-size: 1.2rem; opacity: 0.7;">Words Learned</div>\n                <div style="font-size: 2rem; font-weight: bold;">${U.words.length}</div>\n            </div>\n            <div>\n                <div style="font-size: 1.2rem; opacity: 0.7;">Coins Earned</div>\n                <div style="font-size: 2rem; font-weight: bold;">100</div>\n            </div>\n        </div>\n        <div style="display: flex; justify-content: center; gap: 1rem;">\n            <button class="continue-btn" style="\n                background: #4CAF50; \n                color: white; \n                border: none; \n                padding: 1rem 2rem; \n                border-radius: 50px; \n                font-size: 1rem; \n                cursor: pointer;\n                transition: transform 0.3s ease;\n            ">Continue to Next Set</button>\n            <button class="home-btn" style="\n                background: rgba(255,255,255,0.2); \n                color: white; \n                border: 2px solid white; \n                padding: 1rem 2rem; \n                border-radius: 50px; \n                font-size: 1rem; \n                cursor: pointer;\n                transition: transform 0.3s ease;\n            ">Return Home</button>\n        </div>\n    `;const n=t.querySelector(".continue-btn"),s=t.querySelector(".home-btn");[n,s].forEach((e=>{e.addEventListener("mouseenter",(()=>{e.style.transform="scale(1.05)"})),e.addEventListener("mouseleave",(()=>{e.style.transform="scale(1)"}))})),n.addEventListener("click",(()=>{e.style.opacity="0",setTimeout((()=>{e.remove(),Ne();const t=$.currentSet+1;$.currentSet=t,$.currentLevel=1,oe(1)}),500)})),s.addEventListener("click",(()=>{e.style.opacity="0",setTimeout((()=>{e.remove(),Ne(),Z("welcome-screen")}),500)})),e.appendChild(t),document.body.appendChild(e),requestAnimationFrame((()=>{e.style.opacity="1"}))}function Ur(){if(!jr())return;const e=document.getElementById("perk-test-button");e&&e.remove();const t=document.createElement("button");t.id="perk-test-button",t.textContent="Unlock All Perks",t.style.cssText="\n      position: fixed;\n      top: 130px;\n      right: 20px;\n      background: #9c27b0;\n      color: white;\n      border: none;\n      padding: 10px 15px;\n      border-radius: 5px;\n      cursor: pointer;\n      z-index: 2000;\n      box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n      font-weight: bold;\n    ",t.onclick=function(){$.extendedPerks||No(),Object.keys(Uo).forEach((e=>{$.extendedPerks.perkStates[e].unlocked=!0,$.extendedPerks.unlockedPerks.includes(e)||$.extendedPerks.unlockedPerks.push(e)})),$.coins+=5e3,ve(),I(),Tn("All perks unlocked and 5000 coins added!","success")},document.body.appendChild(t)}Gs(),document.addEventListener("DOMContentLoaded",(()=>{Gs()})),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".fa-crown").forEach((e=>{e.addEventListener("click",nr)}));new MutationObserver((e=>{e.forEach((e=>{e.addedNodes.length&&e.addedNodes.forEach((e=>{if(1===e.nodeType){e.querySelectorAll(".fa-crown").forEach((e=>{e.addEventListener("click",nr)}))}}))}))})).observe(document.body,{childList:!0,subtree:!0})})),document.addEventListener("DOMContentLoaded",(()=>{or("stage-cascade-screen"),ir(),cr()})),document.addEventListener("DOMContentLoaded",(function(){hr()}));const Nr=ae;function Fr(){if(U.bossDefeatedEffectShown)return;U.bossDefeatedEffectShown=!0;let e=!U.bossRewardApplied;U.bossRewardApplied=!0;const t=$.coins;let n=t;e&&(n=t,$.coins=n,I());const s=document.querySelector(".question-screen");if(s){const e=document.createElement("div");e.className="background-transition-overlay",e.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, #800000, #3a0000); \n            z-index: -1;\n            animation: fade-to-blue 5s ease-in-out forwards;\n            pointer-events: none;\n        ",s.insertBefore(e,s.firstChild)}if(setTimeout((()=>{const e=document.querySelector(".boss-orb-inner");if(e){const s=document.createElement("div");s.className="incineration-effect",e.appendChild(s),e.style.animation="boss-shrink 2.5s forwards",setTimeout((()=>{const e=document.querySelector(".coins-container");if(e&&window.originalCoinsHTML){e.innerHTML=window.originalCoinsHTML;const s=e.querySelector(".coin-icon"),r=e.querySelector(".coin-count");r&&(e.style.transform="scale(1.2)",e.style.transition="transform 0.3s ease",r.textContent=t,r.style.color="white",setTimeout((()=>{const o=2e3/60;let a=0;const i=()=>{if(a<=60){const e=a/60,s=Math.round(t+(n-t)*e);r.textContent=s,r.style.color="var(--gold)",r.style.textShadow="0 0 10px var(--gold)",a++,setTimeout(i,o)}else r.textContent=n,setTimeout((()=>{r.style.color="white",r.style.textShadow="none",e.style.transform="scale(1)"}),1e3)};i(),s&&(s.classList.add("coin-pulse"),s.style.animation="coinPulse 0.5s ease-in-out 6")}),100))}}),500),setTimeout((()=>{zr()}),5e3)}else setTimeout((()=>{zr()}),3e3)}),1e3),!document.getElementById("boss-transition-style")){const e=document.createElement("style");e.id="boss-transition-style",e.textContent="\n            @keyframes fade-to-blue {\n                0% { background: linear-gradient(135deg, #800000, #3a0000); }\n                20% { background: linear-gradient(135deg, #800000, #3a0000); }\n                60% { background: linear-gradient(135deg, #4a1582, #0d47a1); }\n                100% { background: radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%); }\n            }\n            \n            @keyframes boss-shrink {\n                0% { transform: scale(1); opacity: 1; }\n                30% { transform: scale(0.8); opacity: 0.8; }\n                100% { transform: scale(0); opacity: 0; }\n            }\n        ",document.head.appendChild(e)}}function Dr(){const e=$.coins,t=e;$.coins=t,document.querySelectorAll(".coin-count").forEach((n=>{J(n,e,t)})),document.querySelectorAll(".coin-icon").forEach((e=>{e.classList.add("coin-pulse"),setTimeout((()=>{e.classList.remove("coin-pulse")}),1500)})),I()}function zr(){ve();const e=document.createElement("div");e.className="arcade-completion-modal",e.innerHTML='\n    <div class="completion-modal-content">\n      <h2 style="color: var(--gold)">Boss Defeated!</h2>\n      <p style="font-size: 1.2rem; margin: 1rem 0;">Congratulations! You\'ve conquered this challenge!</p>\n      \n      <div class="completion-stats">\n        <div class="stat-item">\n          <i class="fas fa-skull" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>\n          <span style="display: block; margin-bottom: 0.25rem;">Boss Defeated</span>\n          <strong style="font-size: 1.5rem;">✓</strong>\n        </div>\n        <div class="stat-item">\n          <i class="fas fa-coins" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>\n          <span style="display: block; margin-bottom: 0.25rem;">Bonus Coins</span>\n          <strong style="font-size: 1.5rem;">100</strong>\n        </div>\n        <div class="stat-item">\n          <i class="fas fa-unlock" style="font-size: 2rem; color: var(--gold); margin-bottom: 0.5rem;"></i>\n          <span style="display: block; margin-bottom: 0.25rem;">New Set</span>\n          <strong style="font-size: 1.5rem;">Unlocked</strong>\n        </div>\n      </div>\n      \n      <div style="display: flex; justify-content: space-around; margin-top: 2rem; gap: 1rem;">\n        <button onclick="handleBossVictoryContinue()" class="start-button" style="\n          background: var(--accent);\n          color: var(--text);\n          border: none;\n          padding: 1rem 2rem;\n          border-radius: 50px;\n          font-size: 1.1rem;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.3s ease;\n          box-shadow: 0 5px 15px rgba(30, 144, 255, 0.3);\n        ">\n          Next Set\n        </button>\n        <button onclick="handleBossVictoryHome()" class="start-button" style="\n          background: transparent;\n          color: var(--text);\n          border: 2px solid var(--accent);\n          padding: 1rem 2rem;\n          border-radius: 50px;\n          font-size: 1.1rem;\n          font-weight: 600;\n          cursor: pointer;\n          transition: all 0.3s ease;\n        ">\n          Return Home\n        </button>\n      </div>\n    </div>\n  ',document.body.appendChild(e),requestAnimationFrame((()=>e.classList.add("show")))}function Hr(){const e=document.querySelector(".arcade-completion-modal");ve(),e&&(e.classList.remove("show"),setTimeout((()=>{e.remove();const t=document.querySelector(".background-transition-overlay");t?(t.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)",Rr(!0)):Rr(),Ne();const n=$.currentSet+1,s=currentUser?currentUser.status:"unregistered";if($.currentStage>=2&&n>1&&"premium"!==s)return Z("welcome-screen"),void setTimeout((()=>{tt()}),500);$.currentSet=n,$.currentLevel=1,ve(),setTimeout((()=>{t&&t.parentNode&&t.parentNode.removeChild(t),oe(1)}),500)}),300))}function Rr(e=!1){const t=document.querySelector(".progress-circle");if(t){const e=t.querySelector(".progress");e&&(e.classList.remove("warning","boss-health"),e.style.stroke="",e.style.animation="none",e.offsetWidth,e.style.animation="")}const n=document.getElementById("question-screen");if(n){const t=n.querySelector(".background-transition-overlay");e&&t&&t.remove(),n.removeAttribute("style"),e&&t&&n.insertBefore(t,n.firstChild),e||(n.querySelectorAll(".background-transition-overlay").forEach((e=>e.remove())),setTimeout((()=>{n.style.background="radial-gradient(circle at center, var(--secondary) 0%, var(--primary-dark) 100%)"}),10))}const s=document.getElementById("question-word");s&&s.removeAttribute("style"),"function"==typeof Ar&&Ar();const r=e?".incineration-effect, .boss-orb":".incineration-effect, .boss-orb, .background-transition-overlay";document.querySelectorAll(r).forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)}))}function Or(){const e=document.querySelector(".arcade-completion-modal");ve(),e&&(e.classList.remove("show"),setTimeout((()=>{e.remove(),Rr(),Ne();const t=$.currentSet+1,n=currentUser?currentUser.status:"unregistered";$.currentStage>=2&&t>1&&"premium"!==n?tt():($.currentSet=t,$.currentLevel=1),I(),Z("welcome-screen")}),300))}function jr(){return currentUser&&"admin123@gmail.com"===currentUser.email}function Wr(){if(!jr())return;const e=document.getElementById("admin-skip-10-button");e&&e.remove();const t=document.createElement("button");t.id="admin-skip-10-button",t.innerHTML='<i class="fas fa-forward"></i> Skip 10',t.style.cssText="\n    position: fixed;\n    bottom: 80px;\n    right: 20px;\n    background: #9c27b0;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 2000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    font-weight: bold;\n  ",t.onclick=function(){Gr()};const n=document.getElementById("question-screen");n&&n.appendChild(t)}function Gr(){if(!jr())return;if(!U||!U.words||!U.words.length)return;const e=Math.min(10,U.words.length-U.currentIndex);if(U.isBossLevel)return U.currentIndex=Math.max(0,U.words.length-1),Gn(),Yn(),void Tn("Boss almost defeated! One more hit!","success");U.currentIndex+=e,U.currentIndex>=U.words.length?ke():(me(),pe(),Tn(`Skipped ${e} questions!`,"success"))}function ae(){const e=document.getElementById("admin-test-button");if(e&&e.remove(),!currentUser||"admin123@gmail.com"!==currentUser.email&&!currentUser.email?.includes("admin123"))return;const t=document.createElement("button");t.id="admin-test-button",t.textContent="Jump to Level 20",t.style.cssText="\n    position: fixed;\n    top: 80px;\n    right: 20px;\n    background: #ff5722;\n    color: white;\n    border: none;\n    padding: 10px 15px;\n    border-radius: 5px;\n    cursor: pointer;\n    z-index: 2000;\n    box-shadow: 0 2px 5px rgba(0,0,0,0.3);\n    font-weight: bold;\n  ",t.onclick=function(){$.currentLevel=21,oe(21)},document.body.appendChild(t),Wr()}ae=function(){Nr(),Ur()},Pr();const Jr={lists:[],currentList:null,async initialize(){try{currentUser?await this.loadFromSupabase():this.loadFromLocalStorage(),this.lists&&0!==this.lists.length||(this.lists=[])}catch(e){this.lists=[]}},async loadFromSupabase(){try{const{data:e,error:t}=await p.from("custom_lists").select("*").or(`user_id.eq.${currentUser.id},shared_with.cs.{${currentUser.id}}`);if(t)throw t;this.lists=e.map((e=>({id:e.id,name:e.name,words:e.words||[],translations:e.translations||[],isShared:e.is_shared,sharedBy:e.shared_by,userId:e.user_id,createdAt:e.created_at})))}catch(e){this.lists=[]}},loadFromLocalStorage(){try{const e=localStorage.getItem("simploxCustomLists");this.lists=e?JSON.parse(e):[]}catch(e){this.lists=[]}},async save(e){return e?currentUser?await this.saveToSupabase(e):this.saveToLocalStorage(e):null},async saveToSupabase(e){try{const t={name:e.name,words:e.words||[],translations:e.translations||[],user_id:currentUser.id};if(e.id&&"string"==typeof e.id&&36===e.id.length){const{data:n,error:s}=await p.from("custom_lists").update(t).eq("id",e.id).select().single();if(s)throw s;return n}{const{data:n,error:s}=await p.from("custom_lists").insert(t).select().single();if(s)throw s;const r=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==r?this.lists[r]={...n,words:n.words||[],translations:n.translations||[]}:this.lists.push({...n,words:n.words||[],translations:n.translations||[]}),n}}catch(e){return null}},saveToLocalStorage(e){try{const t={...e,id:e.id||Date.now(),tempId:e.tempId||Date.now()},n=this.lists.findIndex((t=>t.id===e.id||t.tempId&&t.tempId===e.tempId));return-1!==n?this.lists[n]=t:this.lists.push(t),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),t}catch(e){return null}},async delete(e){if(!currentUser)return this.lists=this.lists.filter((t=>t.id!==e)),localStorage.setItem("simploxCustomLists",JSON.stringify(this.lists)),!0;try{if("string"==typeof e&&36===e.length){const{error:t}=await p.from("custom_lists").delete().eq("id",e);if(t)throw t}return this.lists=this.lists.filter((t=>t.id!==e)),!0}catch(e){return!1}},async share(e,t){if(!currentUser)return!1;try{const n=String(e),s=this.lists.find((e=>String(e.id)===n));if(!s)return!1;const{data:r,error:o}=await p.rpc("insert_shared_list",{p_user_id:t,p_name:`${s.name} (Shared by ${currentUser.user_metadata?.username||"User"})`,p_words:s.words||[],p_translations:s.translations||[],p_is_shared:!0,p_local_id:Date.now(),p_shared_with:[t],p_shared_by:currentUser.id});return!o}catch(e){return!1}},getListLimits(){if(!currentUser)return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"};switch(currentUser.status||"free"){case"premium":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!0,playDisplay:"∞"};case"pending":return{maxLists:30,maxWords:50,maxPlays:1/0,canShare:!1,playDisplay:"∞"};case"free":return{maxLists:5,maxWords:20,maxPlays:10,canShare:!1,playDisplay:"10"};default:return{maxLists:3,maxWords:10,maxPlays:5,canShare:!1,playDisplay:"5"}}},canCreateMoreLists(){const e=this.getListLimits();return this.lists.length<e.maxLists},validateListForPractice:e=>e&&e.words&&e.translations?e.words.length<6?{valid:!1,message:"Lists need at least 6 words to practice"}:{valid:!0}:{valid:!1,message:"Invalid list format"}},Yr={isCustomPractice:!1,currentList:null,currentLevel:1,levelData:null,words:[],translations:[],wordsCompleted:0,correctStreak:0,wrongStreak:0,startCoins:0,completedLevels:new Set,reset(){this.isCustomPractice=!1,this.currentList=null,this.currentLevel=1,this.levelData=null,this.words=[],this.translations=[],this.wordsCompleted=0,this.correctStreak=0,this.wrongStreak=0,this.startCoins=0,this.completedLevels=new Set},initializeFromList(e){return!!(e&&e.words&&e.translations)&&(this.reset(),this.isCustomPractice=!0,this.currentList=e,this.words=[...e.words],this.translations=[...e.translations],this.startCoins=$.coins,this.currentLevel=1,!0)},getWordsForLevel(e){if(!this.words.length)return null;const t=this.words.length>=12?9:this.words.length>=9?6:3;if(e>t)return null;const n={1:{start:0,count:Math.min(3,this.words.length),isTest:!1},2:{start:3,count:Math.min(3,Math.max(0,this.words.length-3)),isTest:!1},3:{start:0,count:Math.min(6,this.words.length),isTest:!0},4:{start:6,count:Math.min(3,Math.max(0,this.words.length-6)),isTest:!1},5:{start:9,count:Math.min(3,Math.max(0,this.words.length-9)),isTest:!1},6:{start:6,count:Math.min(6,Math.max(0,this.words.length-6)),isTest:!0},7:{start:12,count:Math.min(4,Math.max(0,this.words.length-12)),isTest:!1},8:{start:16,count:Math.min(4,Math.max(0,this.words.length-16)),isTest:!1},9:{start:12,count:Math.min(8,Math.max(0,this.words.length-12)),isTest:!0}},s=n[e]||n[1];return s.count<=0?this.getWordsForLevel(e+1):(this.levelData={words:this.words.slice(s.start,s.start+s.count),translations:this.translations.slice(s.start,s.start+s.count),isTest:s.isTest,isFinal:e===t},this.levelData)}};function Xr(){const e=document.getElementById("custom-word-input"),t=document.getElementById("translation-results"),n=document.getElementById("word-translation-list"),s=Jr.getListLimits(),r=e.value.trim();if(!r)return void Tn("Please enter at least one word.","error");let o=r.includes(",")?r.split(",").map((e=>e.trim())):r.split(/\s+/).filter((e=>e.length>0));o=o.map((e=>e.includes(" ")?[e]:e.split(/\s+/))).flat();const a=currentUser?s.maxWords:10;o.length>a&&(Tn(`Maximum ${a} words allowed.`,"error"),o=o.slice(0,a)),n.innerHTML="",t.style.display="block",o.forEach((e=>{const t=Zr(e,Vr(e));n.appendChild(t),eo(t)})),to()}function Vr(e){for(const t in vocabularySets){const n=vocabularySets[t].words.indexOf(e.toLowerCase());if(-1!==n)return vocabularySets[t].translations[n]}return""}function Zr(e,t){const n=document.createElement("div");n.className="word-translation-item",n.draggable=!0,n.innerHTML=`\n    <div class="drag-handle">\n      <i class="fas fa-grip-vertical"></i>\n    </div>\n    <span class="source-word" contenteditable="true">${e}</span>\n    <input type="text" class="target-word" value="${t}" placeholder="Hebrew translation">\n    <button class="delete-word-btn" onclick="deleteWord(this)">\n      <i class="fas fa-times" style="font-size: 12px;"></i>\n    </button>\n  `;const s=n.querySelector(".delete-word-btn");return s&&(s.style.position="absolute",s.style.right="10px",s.style.top="50%",s.style.transform="translateY(-50%)"),n}function Qr(){const e=document.getElementById("word-translation-list");if(!e)return;const t=document.createElement("div");t.className="word-translation-item",t.draggable=!0,t.innerHTML='\n    <div class="drag-handle">\n      <i class="fas fa-grip-vertical"></i>\n    </div>\n    <span class="source-word" contenteditable="true"></span>\n    <input type="text" class="target-word" placeholder="Hebrew translation">\n    <button class="delete-word-btn" onclick="deleteWord(this)">❌</button>\n  ';const n=e.appendChild(t);eo(n),1===e.children.length&&to(),n.querySelector(".source-word").focus()}function Kr(e){if(!e)return;const t=e.closest(".word-translation-item");t&&t.remove()}function eo(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),(e=t).setAttribute("draggable","true"),e.addEventListener("dragstart",(t=>{t.stopPropagation(),e.classList.add("dragging"),t.dataTransfer.setData("text/plain","")})),e.addEventListener("dragend",(t=>{t.stopPropagation(),e.classList.remove("dragging")}));const n=e.querySelector(".delete-word-btn");return n&&(n.onclick=()=>Kr(n)),e}function to(){const e=document.getElementById("word-translation-list");e&&(e.addEventListener("dragover",(t=>{t.preventDefault();const n=e.querySelector(".dragging");if(!n)return;const s=no(e,t.clientY);s?e.insertBefore(n,s):e.appendChild(n)})),e.querySelectorAll(".word-translation-item").forEach((e=>eo(e))))}function no(e,t){if(!e)return null;const n=[...e.querySelectorAll(".word-translation-item:not(.dragging)")];return n.length?n.reduce(((e,n)=>{const s=n.getBoundingClientRect(),r=t-s.top-s.height/2;return r<0&&r>e.offset?{offset:r,element:n}:e}),{offset:Number.NEGATIVE_INFINITY}).element:null}function so(){const e=document.getElementById("word-translation-list");e&&e.addEventListener("keydown",(e=>{const t=document.activeElement.closest(".word-translation-item");if(!t)return;let n;switch(e.key){case"ArrowUp":e.preventDefault(),n=t.previousElementSibling?.querySelector(".source-word");break;case"ArrowDown":e.preventDefault(),n=t.nextElementSibling?.querySelector(".source-word");break;case"ArrowRight":e.preventDefault(),n=t.querySelector(".target-word");break;case"ArrowLeft":e.preventDefault(),n=t.querySelector(".source-word")}n&&n.focus()}))}async function ro(){const e=document.getElementById("custom-list-name"),t=document.getElementById("word-translation-list"),n=e.value.trim()||(Jr.currentList?Jr.currentList.name:`List ${Jr.lists.length+1}`),s=[],r=[];t.querySelectorAll(".word-translation-item").forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),n=e.querySelector(".target-word").value.trim();t&&n&&(s.push(t),r.push(n))}));const o=Jr.getListLimits();if(s.length>o.maxWords)return void Tn(`You can only create lists with up to ${o.maxWords} words`,"error");let a;const i=null!==Jr.currentList;if(!i&&!Jr.canCreateMoreLists())return void Tn("Maximum lists limit reached","error");a=i?{...Jr.currentList,name:n,words:s,translations:r}:{tempId:Date.now(),name:n,words:s,translations:r};await Jr.save(a)?(e.value="",t.innerHTML="",document.getElementById("translation-results").style.display="none",Jr.currentList=null,currentUser?await Jr.loadFromSupabase():Jr.loadFromLocalStorage(),Tn("List saved successfully","success"),Z("custom-practice-screen"),co()):Tn("Failed to save list","error")}function oo(e){const t=Jr.lists.find((t=>t.id===e));if(!t)return Tn("List not found","error");Z("custom-practice-screen");const n=document.getElementById("custom-list-name");n&&(n.value=t.name||"");const s=document.getElementById("translation-results"),r=document.getElementById("word-translation-list");r&&(r.innerHTML="",Array.isArray(t.words)&&t.words.forEach(((e,n)=>{const s=t.translations&&n<t.translations.length?t.translations[n]:"",o=document.createElement("div");o.className="word-translation-item",o.draggable=!0,o.innerHTML=`\n                    <div class="drag-handle">\n                        <i class="fas fa-grip-vertical"></i>\n                    </div>\n                    <span class="source-word" contenteditable="true">${e}</span>\n                    <input type="text" class="target-word" value="${s}" placeholder="Hebrew translation">\n                    <button class="delete-word-btn" onclick="deleteWord(this)">\n                        <i class="fas fa-times" style="font-size: 12px;"></i>\n                    </button>\n                `,r.appendChild(o),eo(o)})),to(),s&&(s.style.display="block")),Jr.currentList=t}async function ao(e){await Jr.delete(e)?(Tn("List deleted successfully","success"),co()):Tn("Failed to delete list","error")}function Qe(e){const t=document.querySelector(".share-modal"),n=document.querySelector(".modal-backdrop");t&&t.remove(),n&&n.remove();const s=document.createElement("div");s.className="modal-backdrop",s.onclick=a,document.body.appendChild(s);const r=document.createElement("div");r.className="share-modal",r.innerHTML='\n    <h3 class="share-modal-header">Share List</h3>\n    <div class="users-list">Loading users...</div>\n    <button class="start-button modal-close" onclick="closeShareModal()">Cancel</button>\n  ',document.body.appendChild(r);const o=r.querySelector(".users-list");function a(){const e=document.querySelector(".share-modal"),t=document.querySelector(".modal-backdrop");e&&e.remove(),t&&t.remove()}p.from("user_profiles").select("id, username").neq("id",currentUser.id).then((({data:t,error:n})=>{n?o.innerHTML='<div class="user-item"><span>Error loading users</span></div>':t&&t.length>0?(o.innerHTML=t.map((e=>`\n        <div class="user-item">\n          <span>${e.username||"Unnamed User"}</span>\n          <button class="main-button small-button share-with-user-btn" data-user-id="${e.id}">\n            <i class="fas fa-share-alt"></i> Share\n          </button>\n        </div>\n      `)).join(""),r.querySelectorAll(".share-with-user-btn").forEach((t=>{t.onclick=async()=>{const n=t.getAttribute("data-user-id");t.disabled=!0;const s=t.innerHTML;t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sharing...';await Jr.share(e,n)?(Tn("List shared successfully!","success"),a()):(t.disabled=!1,t.innerHTML=s)}}))):o.innerHTML='<div class="user-item"><span>No users found to share with</span></div>'}))}function io(){Z("custom-practice-screen"),Promise.resolve(Jr.initialize()).then((()=>{co()})).catch((e=>{Tn("Failed to load custom lists","error")}))}function co(){const e=document.getElementById("custom-lists-container");if(!e)return;const t=Jr.getListLimits(),n=currentUser?.status||"unregistered";e.innerHTML="",Jr.lists&&Array.isArray(Jr.lists)&&0!==Jr.lists.length?Jr.lists.forEach((s=>{if(!s||!s.id)return;const r=s.words?.length||0,o=r>=6,a="premium"===n?"":`<span style="margin-left: 1rem;">${t.playDisplay} plays available</span>`,i=document.createElement("div");i.className="custom-list-item collapsed "+(s.isShared?"shared-list":""),i.dataset.listId=s.id,i.innerHTML=`\n                <div class="list-actions">\n                    <button class="main-button practice-button" ${o?"":"disabled"}>\n                        ${o?"Practice":`Need ${6-r} more`}\n                    </button>\n                    <button class="main-button edit-button">Edit</button>\n                    <button class="main-button delete-button">Delete</button>\n                    ${"premium"===n?'\n                        <button class="main-button share-button">\n                            <i class="fas fa-share-alt"></i> Share\n                        </button>\n                    ':""}\n                </div>\n                <div class="list-header">\n                    <h3>${s.name||"Unnamed List"}</h3>\n                    <div class="list-summary">\n                        <span class="word-count ${o?"":"insufficient"}">${r} words</span>\n                        ${o?"":'<span class="warning-text">(Minimum 6 needed)</span>'}\n                        ${a}\n                        <p class="word-preview">${Array.isArray(s.words)?s.words.slice(0,5).join(", "):""}${s.words&&s.words.length>5?"...":""}</p>\n                    </div>\n                </div>\n            `,e.appendChild(i);const c=i.querySelector(".practice-button");c&&(o?c.onclick=function(){uo(s.id)}:(c.style.opacity="0.6",c.style.cursor="not-allowed"));const l=i.querySelector(".edit-button");l&&(l.onclick=function(){oo(s.id)});const d=i.querySelector(".delete-button");d&&(d.onclick=function(){ao(s.id)});const u=i.querySelector(".share-button");u&&(u.onclick=function(){Qe(s.id)});const m=i.querySelector(".list-header");m&&(m.onclick=function(){lo(s.id)})})):e.innerHTML='<p style="color: white; text-align: center;">No custom lists created yet. Create your first list!</p>'}function lo(e){const t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);t&&t.classList.toggle("collapsed")}function uo(e){const t=Jr.lists.find((t=>t.id===e));if(!t)return void Tn("List not found","error");const n=Jr.validateListForPractice(t);if(!n.valid)return void Tn(n.message,"error");const s=Jr.getListLimits();if(s.maxPlays!==1/0){const t=`listPlays_${e}`;let n=parseInt(localStorage.getItem(t)||"0");if(n++,n>s.maxPlays)return void Tn("You've reached the maximum plays for this list","error");localStorage.setItem(t,n)}Yr.initializeFromList(t)?mo(1):Tn("Failed to initialize practice","error")}function mo(e){const t=document.querySelector(".powerups-container");t&&(t.style.display="none"),"function"==typeof Wr&&Wr();const n=Yr.getWordsForLevel(e);if(!n||!n.words.length)return Tn("Practice completed!","success"),void Z("custom-practice-screen");Yr.currentLevel=e,U={words:n.words,translations:n.translations,currentIndex:0,correctAnswers:0,firstAttempt:!0,isHebrewToEnglish:!!n.isTest&&Math.random()<.5,mixed:n.isTest,speedChallenge:!1,isCustomPractice:!0,customGameState:!0,startingCoins:$.coins,startingPerks:{...$.perks},timeBonus:0,initialTimeRemaining:null,streakBonus:!0,levelStartTime:Date.now(),questionStartTime:0,wrongStreak:0,progressLost:0,customList:Yr.currentList,customLevel:e,isFinalLevel:n.isFinal},De(e,(()=>{Z("question-screen"),me(),pe(),O(10*U.words.length)}))}async function po(){try{await Jr.initialize();const e=document.getElementById("custom-practice-screen");return!e||"block"!==e.style.display&&"custom-practice-screen"!==document.querySelector(".screen.active")?.id||co(),Jr.lists}catch(e){return Tn("Failed to load custom lists","error",3e3),[]}}async function fo(e,t){if(!currentUser?.id)return Tn("You must be logged in to share lists","error"),!1;try{let n=Jr.lists.find((t=>String(t.id)===String(e)));if(!n){const{data:t,error:s}=await p.from("custom_lists").select("*").eq("id",e).single();if(s||!t)return!1;n=t}const s=currentUser.user_metadata?.name||currentUser.user_metadata?.username||currentUser.email||"User",r=`${n.name} (Shared by ${s})`,o=Array.isArray(n.words)?n.words:[],a=Array.isArray(n.translations)?n.translations:[],{error:i}=await p.from("custom_lists").insert({name:r,words:o,translations:a,user_id:t,is_shared:!0,shared_by:currentUser.id});return!i&&(Tn("List shared successfully!","success"),!0)}catch(e){return Tn("Failed to share list","error"),!1}}function Qe(e){const t=document.querySelector(".share-modal-container");t&&t.remove();const n=document.createElement("div");n.className="share-modal-container",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0,0,0,0.7)",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="1000";const s=document.createElement("div");s.className="share-modal",s.style.backgroundColor="#1e1e2e",s.style.borderRadius="10px",s.style.padding="20px",s.style.maxWidth="400px",s.style.width="90%",s.style.maxHeight="80vh",s.style.overflowY="auto",s.innerHTML='\n    <h3 style="text-align: center; margin-bottom: 20px; color: white;">Share List</h3>\n    <div id="share-users-list" style="margin-bottom: 15px;">Loading users...</div>\n    <button id="close-share-modal" style="width: 100%; padding: 10px; background-color: #7e3ab3; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Close</button>\n  ',n.appendChild(s),document.body.appendChild(n),document.getElementById("close-share-modal").onclick=function(){n.remove()},n.addEventListener("click",(function(e){e.target===n&&n.remove()}));const r=document.getElementById("share-users-list");currentUser?p.from("user_profiles").select("id, username, email").neq("id",currentUser.id).then((({data:t,error:n})=>{if(n)return void(r.innerHTML='<div style="padding: 10px; color: white;">Error loading users</div>');if(!t||0===t.length)return void(r.innerHTML='<div style="padding: 10px; color: white;">No other users found</div>');let s="";t.forEach((e=>{const t=e.username||e.email||e.id.substring(0,8);s+=`\n          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); color: white;">\n            <span>${t}</span>\n            <button \n              class="share-with-user-btn" \n              data-user-id="${e.id}" \n              style="padding: 5px 10px; background-color: #7e3ab3; color: white; border: none; border-radius: 5px; cursor: pointer;">\n              Share\n            </button>\n          </div>\n        `})),r.innerHTML=s,document.querySelectorAll(".share-with-user-btn").forEach((t=>{t.onclick=async function(){const t=this.getAttribute("data-user-id"),n=this.innerText;this.innerText="Sharing...",this.disabled=!0;await fo(e,t)?(this.innerText="Shared ✓",this.style.backgroundColor="#28a745"):(this.innerText=n,this.disabled=!1)}}))})):r.innerHTML='<div style="padding: 10px; color: white;">You must be logged in to share lists</div>'}function go(){const e=document.querySelector(".completion-overlay");e&&e.remove(),Yr&&Yr.reset(),U=null,Z("custom-practice-screen"),"function"==typeof refreshCustomLists&&refreshCustomLists()}function yo(e){const t=document.querySelector(".buttons");if(!t)return;t.innerHTML="";let n=[e];const s=isHebrewWord(e),r=getRandomAnswerOptions(e,s,3);n=n.concat(r),n=shuffleArray(n),n.forEach((e=>{const n=document.createElement("button");n.textContent=e,n.className=s?"hebrew-text":"",n.onclick=function(e){cn(e)},t.appendChild(n)}))}async function ho(e){try{const{data:t,error:n}=await p.from("player_stats").select("user_id").eq("user_id",e).single();if(n&&"PGRST116"===n.code){const{error:t}=await p.from("player_stats").insert([{user_id:e,total_levels_completed:0,unique_words_practiced:0}])}const{data:s,error:r}=await p.from("game_progress").select("user_id").eq("user_id",e).single();if(r&&"PGRST116"===r.code){const{error:t}=await p.from("game_progress").insert([{user_id:e,stage:1,set_number:1,level:1,coins:0,perks:{},unlocked_sets:{1:[1]},unlocked_levels:{"1_1":[1]},perfect_levels:[],completed_levels:[]}])}return!0}catch(e){return!1}}function vo(){"function"!=typeof shuffleArray&&(window.shuffleArray=function(e){const t=[...e];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t});const e=document.getElementById("waiting-game-container"),t=document.getElementById("waiting-game-player"),n=document.getElementById("waiting-game-score"),s=document.getElementById("waiting-game-lives");if(!e)return;if(!t)return;if(!n)return;if(!s){const t=document.createElement("div");t.id="waiting-game-lives",t.style.cssText="position: absolute; top: 40px; right: 10px; color: var(--gold); font-size: 1.2rem; z-index: 10;",t.textContent="❤️❤️❤️",e.appendChild(t)}e.style.display="block";let r=[];try{for(const e in vocabularySets)if(e.startsWith("1_")){const t=vocabularySets[e].words,n=vocabularySets[e].translations;for(let e=0;e<t.length&&e<n.length;e++)r.push({hebrew:t[e],english:n[e]})}}catch(e){r=[{hebrew:"כלב",english:"dog"},{hebrew:"חתול",english:"cat"},{hebrew:"בית",english:"house"},{hebrew:"אוכל",english:"food"},{hebrew:"מים",english:"water"},{hebrew:"ספר",english:"book"},{hebrew:"יד",english:"hand"},{hebrew:"עיר",english:"city"},{hebrew:"ילד",english:"child"},{hebrew:"אישה",english:"woman"}]}r=window.shuffleArray([...r]);let o=!0,a=0,i=1,c=[],l="",d=e.offsetWidth/2,u=null,m=null,p=3,f=0;function g(){const e=r[Math.floor(Math.random()*r.length)];l=e.hebrew,t.textContent=l}function y(){if(!o)return;const t=r.find((e=>e.hebrew===l))?.english,n=r.filter((e=>e.hebrew!==l)).map((e=>e.english)),s=Math.random()<.4,a=document.createElement("div");if(a.className="falling-word",s&&t)a.textContent=t,a.dataset.matching="true";else{const e=n[Math.floor(Math.random()*n.length)];a.textContent=e||"word",a.dataset.matching="false"}a.style.cssText=`\n      position: absolute;\n      top: -30px;\n      left: ${Math.random()*(e.offsetWidth-80)+40}px;\n      padding: 5px 10px;\n      background: rgba(255, 255, 255, 0.1);\n      border-radius: 15px;\n      color: white;\n      transition: top 0.1s linear;\n    `,e.appendChild(a),c.push({element:a,y:-30,x:parseFloat(a.style.left),width:0,isMatching:"true"===a.dataset.matching})}function h(){if(!o)return;const s=e.offsetHeight,r=s-60;for(let o=c.length-1;o>=0;o--){const l=c[o];if(0===l.width&&(l.width=l.element.offsetWidth),l.y+=i,l.element.style.top=`${l.y}px`,l.y>s){if(l.isMatching){f++;const t=document.createElement("div");t.textContent=`Missed match! (${f}/3)`,t.style.cssText=`\n            position: absolute;\n            left: ${l.x}px;\n            bottom: 10px;\n            color: var(--error);\n            font-weight: bold;\n            animation: float-up 1s forwards;\n            z-index: 5;\n          `,e.appendChild(t),setTimeout((()=>{e.removeChild(t)}),1e3);const n=document.getElementById("waiting-game-lives");n&&(n.textContent="❤️".repeat(Math.max(0,3-f))),f>=3&&v()}e.removeChild(l.element),c.splice(o,1);continue}t.getBoundingClientRect(),l.element.getBoundingClientRect();if(l.y+l.element.offsetHeight>=r&&l.x+l.width>=d-t.offsetWidth/2&&l.x<=d+t.offsetWidth/2){if(l.isMatching){a+=10,n.textContent=`Score: ${a}`;const t=document.createElement("div");t.textContent="+10",t.style.cssText=`\n            position: absolute;\n            left: ${l.x}px;\n            top: ${l.y}px;\n            color: var(--gold);\n            font-weight: bold;\n            animation: float-up 1s forwards;\n            z-index: 5;\n          `,e.appendChild(t),setTimeout((()=>{e.removeChild(t)}),1e3),i+=.05,g()}else{a=Math.max(0,a-5),n.textContent=`Score: ${a}`,p--;const t=document.getElementById("waiting-game-lives");t&&(t.textContent="❤️".repeat(p));const s=document.createElement("div");s.textContent="-5",s.style.cssText=`\n            position: absolute;\n            left: ${l.x}px;\n            top: ${l.y}px;\n            color: var(--error);\n            font-weight: bold;\n            animation: float-up 1s forwards;\n            z-index: 5;\n          `,e.appendChild(s),setTimeout((()=>{e.removeChild(s)}),1e3),p<=0&&v()}e.removeChild(l.element),c.splice(o,1)}}u=requestAnimationFrame(h)}function v(){o=!1,clearInterval(m);const t=document.createElement("div");t.style.cssText="\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.8);\n      padding: 1rem 2rem;\n      border-radius: 10px;\n      text-align: center;\n      z-index: 20;\n    ",t.innerHTML=`\n      <h3 style="color: var(--error); margin-bottom: 0.5rem;">Game Over!</h3>\n      <p style="margin-bottom: 1rem;">Score: ${a}</p>\n      <button id="game-restart-btn" class="start-button" style="font-size: 0.9rem; padding: 0.5rem 1rem;">Play Again</button>\n    `,e.appendChild(t),document.getElementById("game-restart-btn").addEventListener("click",(()=>{e.removeChild(t),C()}))}let w=!1;function b(t){w=!0;const n=t.type.includes("touch")?t.touches[0].pageX:t.pageX,s=e.getBoundingClientRect();d=n-s.left,x(),t.type.includes("touch")&&t.preventDefault()}function S(t){if(!w)return;const n=t.type.includes("touch")?t.touches[0].pageX:t.pageX,s=e.getBoundingClientRect();d=n-s.left,x(),t.type.includes("touch")&&t.preventDefault()}function k(){w=!1}function x(){d=Math.max(t.offsetWidth/2,Math.min(e.offsetWidth-t.offsetWidth/2,d)),t.style.left=`${d}px`}const L="waiting-game-styles";if(!document.getElementById(L)){const e=document.createElement("style");e.id=L,e.textContent="\n      @keyframes float-up {\n        0% { transform: translateY(0); opacity: 1; }\n        100% { transform: translateY(-30px); opacity: 0; }\n      }\n      \n      .falling-word {\n        animation: gentle-wobble 2s infinite alternate;\n      }\n      \n      @keyframes gentle-wobble {\n        0% { transform: translateX(0px); }\n        100% { transform: translateX(5px); }\n      }\n    ",document.head.appendChild(e)}function C(){o=!0,a=0,i=1,p=3,f=0;const t=document.getElementById("waiting-game-lives");t&&(t.textContent="❤️❤️❤️"),c.forEach((t=>{t.element.parentNode&&e.removeChild(t.element)})),c=[],n.textContent=`Score: ${a}`,g(),u=requestAnimationFrame(h),m=setInterval(y,2e3)}t.addEventListener("mousedown",b),document.addEventListener("mousemove",S),document.addEventListener("mouseup",k),t.addEventListener("touchstart",b,{passive:!1}),document.addEventListener("touchmove",S,{passive:!1}),document.addEventListener("touchend",k);const E=setInterval((function(){Bt&&"active"===Bt.state&&(clearInterval(m),cancelAnimationFrame(u),e.style.display="none",t.removeEventListener("mousedown",b),document.removeEventListener("mousemove",S),document.removeEventListener("mouseup",k),t.removeEventListener("touchstart",b),document.removeEventListener("touchmove",S),document.removeEventListener("touchend",k),clearInterval(E))}),1e3);return C(),{stop:function(){o=!1,clearInterval(m),cancelAnimationFrame(u),clearInterval(E)}}}function wo(){if(!Bt||!Bt.playerName)return;let e=!1,t=-1;for(let n=0;n<Bt.participants.length;n++)if(Bt.participants[n].username===Bt.playerName){e=!0,t=n;break}!e&&U?Bt.participants.push({username:Bt.playerName,wordsCompleted:U.wordsCompleted||0,coins:U.coins||0}):e&&U&&(Bt.participants[t].wordsCompleted=U.wordsCompleted||0,Bt.participants[t].coins=U.coins||0);const n=[...Bt.participants].sort(((e,t)=>t.wordsCompleted!==e.wordsCompleted?t.wordsCompleted-e.wordsCompleted:t.coins-e.coins));let s=0,r=-1,o=-1,a=0;for(let e=0;e<n.length;e++){const t=n[e];if(t.wordsCompleted===r&&t.coins===o||(a=e+1,r=t.wordsCompleted,o=t.coins),t.username===Bt.playerName){s=a;break}}0===s&&(s=1);const i=(e=>{if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}})(s);let c=document.querySelector(".player-rank-display");if(c){const e=c.querySelector(".rank-number");parseInt(c.dataset.currentRank||"1")!==s&&(c.dataset.animating="true",e.classList.add("exiting"),setTimeout((()=>{if(c){const e=document.createElement("div");e.className="rank-number entering",e.innerHTML=`${s}<span class="rank-suffix">${i}</span>`,c.innerHTML="",c.appendChild(e),c.dataset.currentRank=s,setTimeout((()=>{if(c){c.dataset.animating="false";const e=c.querySelector(".rank-number");e&&e.classList.remove("entering")}}),300)}}),300))}else{c=document.createElement("div"),c.className="player-rank-display",c.dataset.currentRank=s,c.innerHTML=`\n      <div class="rank-number entering">${s}<span class="rank-suffix">${i}</span></div>\n    `;const e=document.getElementById("question-screen");e&&e.appendChild(c)}c.classList.remove("rank-1","rank-2","rank-3"),s>=1&&s<=3&&c.classList.add(`rank-${s}`)}function bo(e){const t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);if(!t)return;t.classList.contains("editing")?qo(e):So(e,t)}function So(e,t){if(!Jr.lists.find((t=>t.id===e)))return;t.classList.add("editing");const n=t.querySelector(".edit-button");n&&(n.textContent="Save");const s=t.querySelector(".list-header h3"),r=s.textContent;s.innerHTML=`<input type="text" class="list-name-edit" value="${r}" placeholder="List Name">`;let o=t.querySelector(".inline-edit-container");if(!o){o=document.createElement("div"),o.className="inline-edit-container";const n=document.createElement("div");n.className="inline-word-translation-list",o.appendChild(n);const s=document.createElement("button");s.className="main-button add-word-button",s.innerHTML='<i class="fas fa-plus"></i> Add Word',s.onclick=function(){Eo(e)},o.appendChild(s),t.appendChild(o)}ko(e,o.querySelector(".inline-word-translation-list")),t.classList.contains("collapsed")&&t.classList.remove("collapsed")}function ko(e,t){const n=Jr.lists.find((t=>t.id===e));n&&t&&(t.innerHTML="",Array.isArray(n.words)&&n.words.forEach(((e,s)=>{const r=n.translations&&s<n.translations.length?n.translations[s]:"",o=document.createElement("div");o.className="inline-word-translation-item",o.draggable=!0,o.innerHTML=`\n        <div class="drag-handle">\n          <i class="fas fa-grip-vertical"></i>\n        </div>\n        <span class="source-word" contenteditable="true">${e}</span>\n        <input type="text" class="target-word" value="${r}" placeholder="Hebrew translation">\n        <button class="delete-word-btn" onclick="deleteInlineWord(this)">\n          <i class="fas fa-times" style="font-size: 12px;"></i>\n        </button>\n      `,t.appendChild(o),xo(o)})),Lo(t))}function xo(e){if(!e)return;const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),(e=t).setAttribute("draggable","true"),e.addEventListener("dragstart",(t=>{t.stopPropagation(),e.classList.add("dragging"),t.dataTransfer.setData("text/plain","")})),e.addEventListener("dragend",(t=>{t.stopPropagation(),e.classList.remove("dragging")}));const n=e.querySelector(".delete-word-btn");return n&&(n.onclick=()=>Io(n)),e}function Lo(e){e&&(e.addEventListener("dragover",(t=>{t.preventDefault();const n=e.querySelector(".dragging");if(!n)return;const s=Co(e,t.clientY);s?e.insertBefore(n,s):e.appendChild(n)})),e.querySelectorAll(".inline-word-translation-item").forEach((e=>{xo(e)})))}function Co(e,t){if(!e)return null;const n=[...e.querySelectorAll(".inline-word-translation-item:not(.dragging)")];return n.length?n.reduce(((e,n)=>{const s=n.getBoundingClientRect(),r=t-s.top-s.height/2;return r<0&&r>e.offset?{offset:r,element:n}:e}),{offset:Number.NEGATIVE_INFINITY}).element:null}function Eo(e){const t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);if(!t)return;const n=t.querySelector(".inline-word-translation-list");if(!n)return;const s=document.createElement("div");s.className="inline-word-translation-item",s.draggable=!0,s.innerHTML='\n    <div class="drag-handle">\n      <i class="fas fa-grip-vertical"></i>\n    </div>\n    <span class="source-word" contenteditable="true"></span>\n    <input type="text" class="target-word" placeholder="Hebrew translation">\n    <button class="delete-word-btn" onclick="deleteInlineWord(this)">\n      <i class="fas fa-times" style="font-size: 12px;"></i>\n    </button>\n  ';const r=n.appendChild(s);xo(r),1===n.children.length&&Lo(n),r.querySelector(".source-word").focus()}function Io(e){if(!e)return;const t=e.closest(".inline-word-translation-item");t&&t.remove()}function qo(e){const t=document.querySelector(`.custom-list-item[data-list-id="${e}"]`);if(!t)return;const n=Jr.lists.find((t=>t.id===e));if(!n)return;const s=t.querySelector(".list-name-edit"),r=s?s.value.trim():n.name,o=[],a=[];t.querySelectorAll(".inline-word-translation-item").forEach((e=>{const t=e.querySelector(".source-word").textContent.trim(),n=e.querySelector(".target-word").value.trim();t&&n&&(o.push(t),a.push(n))}));const i={...n,name:r,words:o,translations:a};Jr.save(i).then((n=>{if(n){t.classList.remove("editing");const n=t.querySelector(".edit-button");n&&(n.textContent="Edit");const s=t.querySelector(".list-header h3");s&&(s.textContent=r);const a=t.querySelector(".word-preview");a&&(a.textContent=o.slice(0,5).join(", ")+(o.length>5?"...":""));const i=t.querySelector(".word-count");i&&(i.textContent=o.length+" words",i.classList.toggle("insufficient",o.length<6));const c=t.querySelector(".warning-text");c&&(c.style.display=o.length<6?"":"none");const l=t.querySelector(".practice-button");if(l){const t=o.length>=6;l.disabled=!t,l.textContent=t?"Practice":`Need ${6-o.length} more`,l.style.opacity=t?"1":"0.6",l.style.cursor=t?"pointer":"not-allowed",l.onclick=t?function(){uo(e)}:null}Tn("List saved successfully","success")}else Tn("Failed to save list","error")}))}function To(e){e&&e.preventDefault(),_o(e)}async function _o(e){e&&e.preventDefault();const t=document.getElementById("isAdult").checked;try{if(t){const e=document.getElementById("fullName"),t=document.getElementById("phone");if(!e.value.trim())return e.style.border="2px solid #ff4444",alert("Please enter your full name"),!1;if(!t.value.trim())return t.style.border="2px solid #ff4444",alert("Please enter your phone number"),!1}else{const e=document.getElementById("parentName"),t=document.getElementById("parentPhone");if(!e.value.trim())return e.style.border="2px solid #ff4444",alert("Please enter your parent's full name"),!1;if(!t.value.trim())return t.style.border="2px solid #ff4444",alert("Please enter your parent's phone number"),!1}let e={user_id:currentUser.id,is_adult:t,full_name:t?document.getElementById("fullName").value:document.getElementById("parentName").value,phone:t?document.getElementById("phone").value:document.getElementById("parentPhone").value,parent_name:t?null:document.getElementById("parentName").value,parent_phone:t?null:document.getElementById("parentPhone").value,referral_source:document.getElementById("referralSource").value};try{const{data:t,error:n}=await p.from("upgrade_requests").insert([e]).select()}catch(e){}const{error:n}=await p.from("user_profiles").update({status:"pending"}).eq("id",currentUser.id);if(n)throw n;return localStorage.setItem(`upgradeRequested_${currentUser.id}`,"true"),bt("pending"),$o(),!0}catch(e){return alert("Error processing request. Please try again."),!1}}function Mo(e){try{return e?document.getElementById("fullName").value.trim()&&document.getElementById("phone").value.trim():document.getElementById("parentName").value.trim()&&document.getElementById("parentPhone").value.trim()}catch(e){return!1}}function $o(){document.querySelectorAll(".upgrade-confirmation-popup, .confirmation-popup").forEach((e=>e.remove()));const e=document.createElement("div");e.className="upgrade-confirmation-overlay",e.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.7);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 2002;\n  ";const t=document.createElement("div");t.className="upgrade-confirmation-content",t.style.cssText="\n    background: var(--primary-dark);\n    border: 3px solid var(--gold);\n    border-radius: 20px;\n    padding: 2.5rem 2rem;\n    text-align: center;\n    width: 90%;\n    max-width: 450px;\n    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);\n    position: relative;\n  ",t.innerHTML='\n    <h2 style="color: var(--gold); margin-bottom: 1.5rem; font-size: 2rem;">Thank You!</h2>\n    <p style="margin-bottom: 2.5rem; color: var(--text); font-size: 1.1rem; line-height: 1.6;">\n      We\'ve received your upgrade request. We\'ll contact you soon with payment details.\n    </p>\n    <button id="upgrade-continue-button" style="\n      background: var(--gold);\n      color: var(--primary-dark);\n      border: none;\n      padding: 1rem 2rem;\n      border-radius: 50px;\n      font-size: 1.2rem;\n      font-weight: bold;\n      cursor: pointer;\n      transition: all 0.3s ease;\n      box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);\n      width: 80%;\n      max-width: 300px;\n    ">Continue Playing</button>\n  ',e.appendChild(t),document.body.appendChild(e),setTimeout((()=>{const t=document.getElementById("upgrade-continue-button");t&&(t.onclick=function(e){return e.preventDefault(),e.stopPropagation(),Ao(),!1},t.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),Ao()}),!0),t.addEventListener("mouseover",(function(){this.style.background="linear-gradient(to bottom, var(--gold), #ffa500)",this.style.transform="translateY(-2px)",this.style.boxShadow="0 7px 20px rgba(255, 215, 0, 0.4)"})),t.addEventListener("mouseout",(function(){this.style.background="var(--gold)",this.style.transform="translateY(0)",this.style.boxShadow="0 5px 15px rgba(255, 215, 0, 0.3)"}))),e.addEventListener("click",(function(e){e.target===this&&Ao()}))}),100)}function Ao(){const e=document.querySelector(".upgrade-confirmation-overlay");e&&(e.style.opacity="0",e.style.transition="opacity 0.3s ease",setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),300)),document.querySelectorAll(".confirmation-popup").forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)}));const t=document.getElementById("upgrade-screen");t&&t.classList.remove("visible");const n=document.getElementById("upgradeForm");n&&n.reset(),localStorage.removeItem("gameContext"),nt(),Z("welcome-screen")}function ht(){const e=document.querySelector(".confirmation-popup");e&&(e.style.opacity="0",e.style.transform="translate(-50%, -50%) scale(0.7)",setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),300));const t=document.getElementById("upgrade-screen");t&&t.classList.remove("visible");const n=document.getElementById("upgradeForm");n&&n.reset();const s=$.currentLevel;nt(),s&&setTimeout((()=>{const e=localStorage.getItem("gameContext");if(e)try{const t=JSON.parse(e);t.level&&($.currentLevel=t.level,oe(t.level))}catch(e){}}),500)}function $e(){const e=document.documentElement,t=document.querySelector("#nav-fullscreen-btn i");document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen().then((()=>{t&&(t.className="fas fa-expand")})).catch((e=>{})):e.requestFullscreen&&e.requestFullscreen().then((()=>{t&&(t.className="fas fa-compress")})).catch((e=>{}))}function Po(){const e=document.querySelector(".navigation-menu");e&&e.remove();let t=document.querySelector(".vertical-nav-container");if(!t){t=document.createElement("div"),t.className="vertical-nav-container",document.body.appendChild(t);const e=document.createElement("button");e.className="hamburger-button",e.id="nav-hamburger-btn",e.innerHTML='<i class="fas fa-bars"></i>',e.onclick=wn,t.appendChild(e);const n=document.createElement("button");n.className="nav-button home-button",n.id="nav-home-btn",n.innerHTML='<i class="fas fa-home"></i>',n.onclick=Ct||function(){Z("welcome-screen")},t.appendChild(n);const s=document.createElement("button");s.className="nav-button fullscreen-button",s.id="nav-fullscreen-btn",s.innerHTML='<i class="fas fa-expand"></i>',s.onclick=$e,t.appendChild(s);const r=document.createElement("button");r.className="nav-button reset-button",r.id="nav-reset-btn",r.innerHTML='<i class="fas fa-trash-alt"></i>',r.onclick=Me,t.appendChild(r);const o=document.createElement("button");o.className="nav-button settings-button",o.id="nav-settings-btn",o.innerHTML='<i class="fas fa-cog"></i>',o.onclick=function(){const e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(o);const a=document.createElement("button");a.className="nav-button accessibility-button",a.id="nav-accessibility-btn",a.innerHTML='<i class="fas fa-universal-access"></i>',a.onclick=function(){const e=document.querySelector(".accessibility-modal");e&&e.classList.add("show")},t.appendChild(a)}const n={hamburger:document.querySelector(".hamburger-button:not(.vertical-nav-container .hamburger-button)"),home:document.querySelector(".home-button:not(.vertical-nav-container .home-button)"),fullscreen:document.querySelector(".fullscreen-button:not(.vertical-nav-container .fullscreen-button)"),reset:document.querySelector(".reset-button:not(.vertical-nav-container .reset-button)"),settings:document.querySelector(".settings-button:not(.vertical-nav-container .settings-button)"),accessibility:document.querySelector(".accessibility-toggle")};Object.values(n).forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}))}function Bo(){const e=document.getElementById("question-screen");e&&/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&e.classList.add("mobile-optimized")}document.addEventListener("DOMContentLoaded",(function(){["fullName","phone","parentName","parentPhone"].forEach((e=>{const t=document.getElementById(e);t&&t.addEventListener("input",(function(){this.style.border="1px solid rgba(255, 255, 255, 0.2)"}))}));const e=document.getElementById("upgradeForm");e&&e.addEventListener("submit",(function(e){_o(e)}))})),window.debugUpgrade=function(){vt()},window.debugUpgrade=function(){const e=document.querySelectorAll(".confirmation-popup");0===e.length||e.forEach(((e,t)=>{}))},document.addEventListener("fullscreenchange",(function(){const e=document.querySelector("#nav-fullscreen-btn i");e&&(document.fullscreenElement?e.className="fas fa-compress":e.className="fas fa-expand")})),document.addEventListener("DOMContentLoaded",(function(){const e=window.showScreen;"function"==typeof e&&(window.showScreen=function(t,n){e(t,n),"question-screen"===t&&Bo()}),document.getElementById("question-screen")?.classList.contains("visible")&&Bo()}));const Uo={timeFreeze:{name:"Time Freeze",description:"Pause the timer for 5 seconds",cost:15,buyCost:100,icon:"fa-clock",duration:5e3,category:"basic",unlocked:!0},skip:{name:"Skip Question",description:"Skip the current word without penalty",cost:1,buyCost:50,icon:"fa-forward",category:"basic",unlocked:!0},clue:{name:"Eliminate Wrong Answer",description:"Remove one incorrect answer",cost:35,buyCost:150,icon:"fa-lightbulb",category:"basic",unlocked:!0},reveal:{name:"Reveal Correct Answer",description:"Show the correct translation",cost:50,buyCost:200,icon:"fa-eye",category:"basic",unlocked:!0},doublePoints:{name:"Double Points",description:"Next correct answer gives double coins",cost:30,buyCost:120,icon:"fa-coins",category:"basic",unlocked:!1},secondChance:{name:"Second Chance",description:"Allows one mistake without losing streak bonus",cost:40,buyCost:180,icon:"fa-heart",category:"basic",unlocked:!1},timeExtension:{name:"Time Extension",description:"Add 10 seconds to the timer",cost:45,buyCost:200,icon:"fa-hourglass-half",category:"basic",unlocked:!1},comboBooster:{name:"Combo Booster",description:"Each correct answer in sequence gives +1 extra coin",cost:100,buyCost:400,icon:"fa-bolt",category:"advanced",unlocked:!1},shield:{name:"Shield",description:"Prevents losing progress on the next wrong answer",cost:150,buyCost:500,icon:"fa-shield-alt",category:"advanced",unlocked:!1},timeSlow:{name:"Time Slow",description:"Timer moves at half speed for 15 seconds",cost:180,buyCost:600,icon:"fa-stopwatch",category:"advanced",unlocked:!1},progressLock:{name:"Progress Lock",description:"Prevents losing progress for the next 3 questions",cost:200,buyCost:650,icon:"fa-lock",category:"advanced",unlocked:!1},goldenEgg:{name:"Golden Egg",description:"Gives a random premium perk when used",cost:500,buyCost:1500,icon:"fa-egg",category:"premium",unlocked:!1},timeMachine:{name:"Time Machine",description:"Return to a previous question you got wrong",cost:350,buyCost:1e3,icon:"fa-history",category:"premium",unlocked:!1},coinDoubler:{name:"Coin Doubler",description:"Doubles all coins earned in a level",cost:400,buyCost:1200,icon:"fa-money-bill-wave",category:"premium",unlocked:!1},rewind:{name:"Rewind",description:"Go back to the previous question",cost:300,buyCost:900,icon:"fa-undo",category:"premium",unlocked:!1},phoenixRevival:{name:"Phoenix Revival",description:"After time runs out, gives 30 more seconds once per level",cost:0,buyCost:2e3,icon:"fa-phoenix-framework",category:"special",unlocked:!1},momentum:{name:"Momentum",description:"Each correct answer speeds up timer, wrong answers slow it down",cost:0,buyCost:1800,icon:"fa-tachometer-alt",category:"special",unlocked:!1},masterFocus:{name:"Master's Focus",description:"Perfect accuracy for 10 seconds (all answers shown are correct)",cost:0,buyCost:2500,icon:"fa-bullseye",category:"special",unlocked:!1}};function No(){$.extendedPerks?(Object.keys(Uo).forEach((e=>{$.extendedPerks.perkStates[e]?$.extendedPerks.perkStates[e].unlocked=!0:$.extendedPerks.perkStates[e]={unlocked:!0,uses:0,lastUsed:0},$.extendedPerks.unlockedPerks.includes(e)||$.extendedPerks.unlockedPerks.push(e)})),$.extendedPerks.selectedPerks&&Array.isArray($.extendedPerks.selectedPerks)&&0!==$.extendedPerks.selectedPerks.length||($.extendedPerks.selectedPerks=["timeFreeze","skip","clue","reveal"])):($.extendedPerks={unlockedPerks:Object.keys(Uo),selectedPerks:["timeFreeze","skip","clue","reveal"],perkStates:{}},Object.keys(Uo).forEach((e=>{$.extendedPerks.perkStates[e]={unlocked:!0,uses:0,lastUsed:0}})),I())}function Fo(){$.extendedPerks?.perkStates&&Object.entries($.extendedPerks.perkStates).forEach((([e,t])=>{}));try{JSON.parse(localStorage.getItem("simploxProgress")||"{}")}catch(e){}return"Extended perks debug information logged to console"}function Do(){No(),Go();const e=document.querySelectorAll(".category-button");e.forEach((t=>{t.addEventListener("click",(()=>{e.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),zo(t.dataset.category)}))}));const t=document.querySelector(".back-to-menu");t&&t.addEventListener("click",(()=>{Z("welcome-screen")})),Oo(),zo("basic"),Z("shop-screen")}function zo(e){const t=document.querySelector(".shop-items");if(!t)return;t.innerHTML="";Object.entries(Uo).filter((([t,n])=>n.category===e)).map((([e,t])=>({id:e,...t}))).forEach((e=>{const n=$.extendedPerks.selectedPerks.includes(e.id),s=document.createElement("div");s.className="shop-item "+(n?"selected":""),s.dataset.perkId=e.id,s.innerHTML=`\n        <div class="perk-category-badge ${e.category}">${e.category}</div>\n        <div class="shop-item-content">\n          <div class="shop-item-icon">\n            <i class="fas ${e.icon}"></i>\n          </div>\n          <div class="shop-item-title">${e.name}</div>\n          <div class="shop-item-description">${e.description}</div>\n          <div class="shop-item-cost">\n            <i class="fas fa-coins"></i> ${e.cost} per use\n          </div>\n          <div class="shop-item-actions">\n            <button class="shop-item-button ${n?"selected":"select"}">\n              ${n?"Selected":"Select"}\n            </button>\n          </div>\n        </div>\n      `,t.appendChild(s);const r=s.querySelector(".shop-item-button");r&&r.addEventListener("click",(()=>{Ho(e.id)}))}))}function Ho(e){const t=$.extendedPerks.selectedPerks,n=t.indexOf(e);if(-1===n){if(t.length>=5)return void Tn("Loadout is full. Remove a perk first.","error");t.push(e)}else t.splice(n,1);Oo();const s=document.querySelector(".category-button.active");s&&zo(s.dataset.category),I()}function Ro(e){const t=Uo[e];if(t)if($.coins>=t.buyCost){$.coins-=t.buyCost,$.extendedPerks.perkStates[e].unlocked=!0,$.extendedPerks.unlockedPerks.includes(e)||$.extendedPerks.unlockedPerks.push(e);const n=document.querySelector("#shop-screen .coin-count");n&&(n.textContent=$.coins),Tn(`${t.name} unlocked!`,"success"),zo(document.querySelector(".category-button.active").dataset.category),I(),J(n,$.coins+t.buyCost,$.coins)}else Tn(`Need ${t.buyCost-$.coins} more coins!`,"error")}function Oo(){const e=document.querySelector(".loadout-perks");if(!e)return;e.querySelectorAll(".perk-slot").forEach(((e,t)=>{if(e.innerHTML='<i class="fas fa-plus"></i>',e.classList.add("empty"),t<$.extendedPerks.selectedPerks.length){const n=$.extendedPerks.selectedPerks[t],s=Uo[n];if(s){e.innerHTML=`\n          <i class="fas ${s.icon} perk-icon"></i>\n          <div class="remove-perk"><i class="fas fa-times"></i></div>\n        `,e.classList.remove("empty"),e.dataset.perkId=n;const t=e.querySelector(".remove-perk");t&&t.addEventListener("click",(e=>{e.stopPropagation(),Ho(n)}))}}e.classList.contains("empty")&&e.addEventListener("click",(()=>{jo()}))}))}function jo(){const e={basic:0,advanced:0,premium:0,special:0};Object.entries(Uo).forEach((([t,n])=>{$.extendedPerks.perkStates[t]?.unlocked&&!$.extendedPerks.selectedPerks.includes(t)&&e[n.category]++}));let t="basic",n=-1;Object.entries(e).forEach((([e,s])=>{s>n&&(n=s,t=e)}));document.querySelectorAll(".category-button").forEach((e=>{e.dataset.category===t&&e.click()}))}function Wo(e){const t=Uo[e];if(!t)return!1;if(!$.extendedPerks.perkStates[e]?.unlocked||!$.extendedPerks.selectedPerks.includes(e))return Tn(`${t.name} is not unlocked or selected`,"error"),!1;if($.coins<t.cost)return Tn(`Need ${t.cost} coins!`,"error"),!1;if($.coins-=t.cost,$.extendedPerks.perkStates[e].uses++,$.extendedPerks.perkStates[e].lastUsed=Date.now(),ve(),B(),"timeFreeze"===e)D=!0,setTimeout((()=>{D=!1}),t.duration);I();const n=document.getElementById(`${e}Perk`);if(n){const e=n.querySelector(".perk-count");if(e){const s=Math.floor($.coins/t.cost);e.textContent=s,s<=0&&(n.disabled=!0,n.style.opacity="0.5")}}return!0}function Go(){const e=document.querySelector("#shop-screen .coin-count");e&&(e.textContent=$.coins||0)}function Jo(){const e=Object.entries(Uo).filter((([e,t])=>"premium"===t.category&&"goldenEgg"!==e&&$.extendedPerks.perkStates[e]?.unlocked)).map((([e])=>e));if(0===e.length){const e=200;return $.coins+=e,ve(),void Tn(`Golden Egg gave you ${e} coins!`,"success")}const t=e[Math.floor(Math.random()*e.length)];Tn(`Golden Egg activated: ${Uo[t].name}!`,"success");const n=Uo[t].cost;Uo[t].cost=0,Wo(t),Uo[t].cost=n}function Yo(){const e=i.update;i.update=function(t){U.timeSlowActive&&Date.now()<U.timeSlowEnd?(this.slowCounter||(this.slowCounter=0),this.slowCounter++,this.slowCounter%2==0&&e.call(this,t)):(U.timeSlowActive&&Date.now()>=U.timeSlowEnd&&(U.timeSlowActive=!1,Tn("Time slow effect ended","info")),e.call(this,t))}}function Xo(){const e=cn;window.handleAnswer=function(t,n=!1,s=!1){const o=U.currentIndex;if(!n)if(t)U.doublePointsActive&&(U.doublePointsActive=!1,U.doublePointsBonus=!0),U.comboBoosterActive&&(U.comboCount=(U.comboCount||0)+1,Tn(`Combo x${U.comboCount}`,"success")),U.momentumActive&&(F=Math.max(1,F-1),j());else{if(U.wrongAnswerHistory||(U.wrongAnswerHistory=[]),U.wrongAnswerHistory.push(o),U.secondChanceActive&&!U.secondChanceUsed&&(U.secondChanceUsed=!0,U.secondChanceActive=!1,U.firstAttempt=!0,U.streakBonus=!0,Tn("Second chance used - streak preserved!","success")),U.shieldActive)return U.shieldActive=!1,s||e(t,n),void Tn("Shield prevented progress loss!","success");if(U.progressLockActive)return U.progressLockCount--,U.progressLockCount<=0?(U.progressLockActive=!1,Tn("Progress lock depleted","info")):Tn(`Progress lock: ${U.progressLockCount} questions left`,"info"),void(s||e(!0,n));U.momentumActive&&(F+=2,j())}if(U.masterFocusActive&&Date.now()<U.masterFocusEnd)s||e(!0,n);else if(s||e(t,n),t&&U.doublePointsBonus&&(r.updateCoins(3),U.doublePointsBonus=!1),t&&U.coinDoublerActive&&!n){const e=U.firstAttempt?3:1;r.updateCoins(e)}}}function Vo(){const e=ke;window.handleLevelCompletion=function(){U.doublePointsActive=!1,U.secondChanceActive=!1,U.secondChanceUsed=!1,U.comboBoosterActive=!1,U.shieldActive=!1,U.timeSlowActive=!1,U.progressLockActive=!1,U.coinDoublerActive=!1,U.masterFocusActive=!1,U.phoenixUsed=!1,U.momentumActive=!1,e()}}function Zo(){No(),Yo(),Xo(),Vo(),Qo()}function Qo(){const e=document.querySelector(".main-buttons");if(!e)return;if(document.querySelector(".main-button.shop-button"))return;const t=document.createElement("button");t.className="main-button shop-button",t.innerHTML="Perk Shop",t.onclick=function(){Do()};const n=e.querySelectorAll(".main-button");n.length>0?e.insertBefore(t,n[n.length-1]):e.appendChild(t)}function Ko(){const e=document.querySelector(".perks-container");e&&(e.innerHTML="",$.extendedPerks.selectedPerks.forEach((t=>{const n=Uo[t];if(!n)return;const s=document.createElement("button");s.className="perk-button",s.id=`${t}Perk`;const r=Math.floor($.coins/n.cost),o=r>0;s.innerHTML=`\n        <i class="fas ${n.icon} perk-icon"></i>\n        <span class="perk-count">${r}</span>\n      `,s.disabled=!o,s.style.opacity=o?"1":"0.5",s.onclick=function(){Wo(t)},e.appendChild(s)})),B())}function ea(){document.querySelector(".perks-container")&&(Ko(),B())}function ta(){const e=S;window.initializeGame=function(){e(),Zo()}}document.addEventListener("DOMContentLoaded",(function(){ta()})),window.buyPerk=Wo;const na=window.showScreen;window.showScreen=function(e,t=!1){na(e,t),"question-screen"!==e||U.isArcadeMode||$.extendedPerks&&Ko()};
//# sourceMappingURL=script.min.js.map
